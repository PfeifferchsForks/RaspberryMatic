var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var e=a.length,c=0;c<e;c++){var g=a[c];if(b.call(d,g,c,a))return{i:c,v:g}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var d=$jscomp.propertyToPolyfillSymbol[b];if(null==d)return a[b];d=a[d];return void 0!==d?d:a[b]};
$jscomp.polyfill=function(a,b,d,e){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,d,e):$jscomp.polyfillUnisolated(a,b,d,e))};$jscomp.polyfillUnisolated=function(a,b,d,e){d=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var c=a[e];if(!(c in d))return;d=d[c]}a=a[a.length-1];e=d[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,d,e){var c=a.split(".");a=1===c.length;e=c[0];e=!a&&e in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<c.length-1;g++){var f=c[g];if(!(f in e))return;e=e[f]}c=c[c.length-1];d=$jscomp.IS_SYMBOL_NATIVE&&"es6"===d?e[c]:null;b=b(d);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,c,{configurable:!0,writable:!0,value:b}):b!==d&&(void 0===$jscomp.propertyToPolyfillSymbol[c]&&(d=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[c]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(c):$jscomp.POLYFILL_PREFIX+d+"$"+c),$jscomp.defineProperty(e,$jscomp.propertyToPolyfillSymbol[c],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,d){return $jscomp.findInternal(this,b,d).v}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.skinmanager=m.aio.skinmanager||{};m.aio.skinmanager.Resource=function(){this.mtime=this.size=this.sha1=this.file=this.name=this.widget=null};
m.aio.skinmanager.Resource.load=function(a,b,d,e){var c=require("unorm"),g=new m.aio.skinmanager.Resource;g.widget=d;g.name=c.nfc(b);g.file=a;e&&e(null,g)};m.aio.skinmanager.Resource.loadSync=function(a,b,d){var e=require("unorm"),c=new m.aio.skinmanager.Resource;c.widget=d;c.name=e.nfc(b);c.file=a;return c};
m.aio.skinmanager.Resource.prototype={copy:function(a,b,d){this._copy(this.file,a,b,d)},copySync:function(a,b){this._copySync(this.file,a,b)},_copy:function(a,b,d,e){var c=require("fs-extra"),g=require("path");b?d?this.widget&&this.widget.type&&this.widget.name?this.file?(b=b+g.sep+d+g.sep+this.widget.type+g.sep+this.widget.name+g.sep+this.name,b==this.file?e&&e():c.copy(a,b,{clobber:!0},function(f){e&&e(f)})):e&&e(Error("resource file invalid")):e&&e(Error("resource widget invalid")):e&&e(Error("skinId invalid")):
e&&e(Error("skinFolder invalid"))},_copySync:function(a,b,d){var e=require("fs-extra"),c=require("path");if(!b)throw Error("skinFolder invalid");if(!d)throw Error("skinId invalid");if(!this.widget||!this.widget.type||!this.widget.name)throw Error("resource widget invalid");if(!this.file)throw Error("resource file invalid");b=b+c.sep+d+c.sep+this.widget.type+c.sep+this.widget.name+c.sep+this.name;b!=this.file&&e.copySync(a,b,{clobber:!0})},del:function(a){this.file?require("fs").unlink(this.file,function(b){a&&
a(b)}.bind(this)):a&&a(Error("resource file invalid"))},getRef:function(){if(!this.widget||!this.widget.skin)return null;var a="";if(this.widget.skin instanceof m.aio.skinmanager.DummySkin||this.widget.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin)a=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/";return a+this.widget.type+"/"+this.widget.name+"/"+this.name},getURL:function(){if(!this.widget||!this.widget.skin)return null;var a=this.widget.skin.getURL();a.widgetType=
this.widget.type;a.widgetName=this.widget.name;a.resourcePath=this.name;return a.toString()},toJSON:function(){return{name:this.name,ref:this.getRef(),url:this.getURL()}}};m.aio.skinmanager.Widget=function(){this.name=this.type=this.skin=null;this.resources=[]};m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE="misc";m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME="default";
m.aio.skinmanager.Widget.loadType=function(a,b,d,e){var c=require("fs"),g=require("async"),f=require("path");c.readdir(a,function(q,p){if(q)e&&e(q);else{var r=[];g.eachLimit(p,100,function(l,t){m.aio.skinmanager.Widget.load(a+f.sep+l,b,l,d,function(x,y){!x&&y&&r.push(y);t()})},function(l){e&&e(l,r)})}})};
m.aio.skinmanager.Widget.load=function(a,b,d,e,c){var g=require("fs"),f=require("path");require("async");g.readdir(a,function(q,p){if(q)c&&c(q);else{q=require("unorm");var r=new m.aio.skinmanager.Widget;r.skin=e;r.type=q.nfc(b);r.name=q.nfc(d);var l=[];p.forEach(function(t){".DS_Store"!==t&&(t=new m.aio.skinmanager.Resource.loadSync(a+f.sep+t,t,r),l.push(t))});l&&0!=l.length?(r.resources=l,c&&c(null,r)):c&&c(Error("widget has no resources"))}})};
m.aio.skinmanager.Widget.prototype={getLocation:function(){var a=null;this.skin&&(a=this.skin instanceof m.aio.skinmanager.DummySkin?"in_remote_custom":this.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin?"local_custom":this.skin instanceof m.aio.skinmanager.RemoteSkin?"in_remote_skin":this.skin instanceof m.aio.skinmanager.CustomSkin?"local_custom_skin":"local_skin");return a},copy:function(a,b,d){this._copy(this.skin.path,a,b,d)},copySync:function(a,b){this._copySync(this.skin.path,
a,b)},_copy:function(a,b,d,e){var c=require("fs-extra"),g=require("path");a?b?d?this.type&&this.name?c.copy(a+g.sep+this.type+g.sep+this.name,b+g.sep+d+g.sep+this.type+g.sep+this.name,{clobber:!0},function(f){e&&e(f)}):e&&e(Error("widget type or name invalid")):e&&e(Error("skinId invalid")):e&&e(Error("dstSkinFolder invalid")):e&&e(Error("srcSkinFolder invalid"))},_copySync:function(a,b,d){var e=require("fs-extra"),c=require("path");if(!a)throw Error("srcSkinFolder invalid");if(!b)throw Error("dstSkinFolder invalid");
if(!d)throw Error("skinId invalid");if(!this.type||!this.name)throw Error("widget type or name invalid");e.copySync(a+c.sep+this.type+c.sep+this.name,b+c.sep+d+c.sep+this.type+c.sep+this.name,{clobber:!0})},del:function(a){if(this.skin)if(this.type)if(this.name){var b=this.skin.path;if(b){var d=require("path");require("fs-extra").remove(b+d.sep+this.type+d.sep+this.name,function(e){a&&a(e)})}else a&&a(Error("skin path is null"))}else a&&a(Error("widgetName is null"));else a&&a(Error("widgetType is null"));
else a&&a(Error("skin is null"))},hasSameRef:function(a){return this.type==a.type&&this.name==a.name},merge:function(a){if(a.resources&&0!=a.resources.length)if(this.resources&&0!=this.resources.length){for(var b=[],d=0;d<a.resources.length;d++){for(var e=!1,c=0;c<this.resources.length;c++)if(this.resources[c].name==a.resources[d].name){e=!0;this.resources[c]=a.resources[d];break}e||b.push(a.resources[d])}this.resources=this.resources.concat(b)}else this.resources=a.resources},toJSON:function(){var a=
{type:this.type,name:this.name,resources:[]};a._loc=this.getLocation();this.resources.forEach(function(b){a.resources.push(b.toJSON())});return a}};m.aio.skinmanager.Skin=function(a){this.type=a;this.path=this.info=this.schema=this.base=this.system=this.version=this.name=this.id=null};m.aio.skinmanager.Skin.SETTINGS_FILE="settings";m.aio.skinmanager.Skin.TYPE={SYSTEM:1,CUSTOM:2,REMOTE:3,DUMMY:4};
m.aio.skinmanager.Skin.load=function(a,b,d,e){if(a){var c=require("fs"),g=require("path"),f=a+g.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;c.readFile(f,{encoding:"utf8"},function(q,p){if(q){if(d.skinType!==m.aio.skinmanager.Skin.TYPE.REMOTE){e&&e(q);return}p=JSON.stringify({id:b,name:"in-remote",system:1})}if(p&&0!=p.length){q=null;try{q=JSON.parse(p)}catch(r){e&&e(Error("settings file of "+f+" is not in json"));return}if(q.name){switch(d.skinType){case m.aio.skinmanager.Skin.TYPE.SYSTEM:p=new m.aio.skinmanager.SystemSkin;
break;case m.aio.skinmanager.Skin.TYPE.CUSTOM:p=new m.aio.skinmanager.CustomSkin;break;case m.aio.skinmanager.Skin.TYPE.REMOTE:if(!d.tenantId||!d.remoteId){e&&e(Error("skinType info invalid"));return}p=new m.aio.skinmanager.RemoteSkin(d.tenantId,d.remoteId);break;case m.aio.skinmanager.Skin.TYPE.DUMMY:if(!d.tenantId||!d.remoteId){e&&e(Error("skinType info invalid"));return}p=new m.aio.skinmanager.DummySkin(d.tenantId,d.remoteId);break;default:e&&e(Error("skin type invalid"));return}p.id=b;p.name=
q.name;p.version=q.version?q.version:0;p.system=q.system?q.system:1;p.base=q.base;p.schema=q.schema?q.schema:0;p.info=q.info||null;p.path=a;e&&e(null,p)}else e&&e(Error("skin has no name"))}else e&&e(Error("settings file of "+f+" is empty"))})}else e&&e(Error("invalid skin path"))};
m.aio.skinmanager.Skin.prototype={updateVersion:function(a,b){var d=this,e=require("fs"),c=require("path"),g=this.path+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;e.readFile(g,{encoding:"utf8"},function(f,q){if(f)b&&b(f);else if(q&&0!=q.length){f=null;try{f=JSON.parse(q)}catch(p){b&&b(Error("settings file of "+g+" is not in json"));return}parseInt(f.version)==parseInt(a)?b&&b(null):(f.version=parseInt(a),e.writeFile(g,JSON.stringify(f),{encoding:"utf8"},function(p){p||(d.version=parseInt(a));b&&b(p)}))}else b&&
b(Error("settings file of "+g+" is empty"))})},loadWidgets:function(a){var b=require("fs"),d=require("path"),e=require("async");b.readdir(this.path,function(c,g){if(c)a&&a(c);else{var f=[];e.eachLimit(g,100,function(q,p){m.aio.skinmanager.Widget.loadType(this.path+d.sep+q,q,this,function(r,l){!r&&l&&(f=f.concat(l));p()})}.bind(this),function(q){a&&a(q,f)}.bind(this))}}.bind(this))},toJSON:function(){return{type:this.type,id:this.id,name:this.name,version:this.version,system:this.system,base:this.base,
schema:this.schema,folder:this.path,info:this.info}}};m.aio.skinmanager.SystemSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.SYSTEM)};m.aio.skinmanager.SystemSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.SystemSkin.prototype.constructor=m.aio.skinmanager.SystemSkin;m.aio.skinmanager.SystemSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.CustomSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.CUSTOM)};m.aio.skinmanager.CustomSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.CustomSkin.prototype.constructor=m.aio.skinmanager.CustomSkin;m.aio.skinmanager.CustomSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.RemoteSkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.REMOTE);this.tenantId=a;this.remoteId=b};m.aio.skinmanager.RemoteSkin.URL_PREFIX="REMOTE";m.aio.skinmanager.RemoteSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.RemoteSkin.prototype.constructor=m.aio.skinmanager.RemoteSkin;
m.aio.skinmanager.RemoteSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;a.skinId=this.id;return a};m.aio.skinmanager.DummySkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY);this.id=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;this.tenantId=a;this.remoteId=b};m.aio.skinmanager.DummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.DummySkin.prototype.constructor=m.aio.skinmanager.DummySkin;m.aio.skinmanager.DummySkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteCustomWidgetUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;return a};m.aio.skinmanager.LocalCustomWidgetDummySkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY)};m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetDummySkin;m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.getURL=function(){return new m.aio.skinmanager.LocalCustomWidgetUrl};m.aio.skinmanager.Url=function(a){this.prefix=a};m.aio.skinmanager.Url.PREFIX={LOCAL:"LOCAL",INREMOTE:"INREMOTE"};
m.aio.skinmanager.Url.resolve=function(a){a=a.split("/");switch(a[0]){case m.aio.skinmanager.Url.PREFIX.LOCAL:if(2>a.length)return null;switch(a[1]){case "skins":if(6>a.length)return null;var b=new m.aio.skinmanager.LocalUrl;b.skinId=a[2];b.widgetType=a[3];b.widgetName=a[4];var d=a.slice(5);b.resourcePath=d.join("/");break;case "custom":if(5>a.length)return null;b=new m.aio.skinmanager.LocalCustomWidgetUrl;b.widgetType=a[2];b.widgetName=a[3];d=a.slice(4);b.resourcePath=d.join("/");break;default:return null}break;
case m.aio.skinmanager.Url.PREFIX.INREMOTE:if(6>a.length||"tenant"!=a[1]||"remote"!=a[3])return null;switch(a[5]){case m.aio.skinmanager.SkinManager.SKIN_FLODER:b=new m.aio.skinmanager.InRemoteUrl;if(10>a.length)return null;b.skinId=a[6];b.widgetType=a[7];b.widgetName=a[8];d=a.slice(9);b.resourcePath=d.join("/");break;case m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER:b=new m.aio.skinmanager.InRemoteCustomWidgetUrl;if(9>a.length)return null;b.widgetType=a[6];b.widgetName=a[7];d=a.slice(8);
b.resourcePath=d.join("/");break;default:return null}b.tenantId=a[2];b.remoteId=a[4];break;default:return null}return b};m.aio.skinmanager.LocalUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=this.skinId=null};m.aio.skinmanager.LocalUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.LocalUrl.prototype.constructor=m.aio.skinmanager.LocalUrl;
m.aio.skinmanager.LocalUrl.prototype.toString=function(){return this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};m.aio.skinmanager.LocalCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=null};m.aio.skinmanager.LocalCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;
m.aio.skinmanager.LocalCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetUrl;m.aio.skinmanager.LocalCustomWidgetUrl.prototype.toString=function(){return this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.skinId=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteUrl.prototype.constructor=m.aio.skinmanager.InRemoteUrl;
m.aio.skinmanager.InRemoteUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.InRemoteCustomWidgetUrl;
m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.SkinManager={SKIN_FLODER:"skins",CUSTOM_IN_REMOTE_WIDGET_FOLDER:"custom",RESOURCE_FOLDER:"resources",sysSkinsPath:null,customSkinsPath:null,customWidgetPath:null,_configmanager:null,skins:[],_logger:null,init:function(a,b,d){var e=function(f){var q=require("async"),p=require("fs");q.parallel([function(r){p.mkdir(this.sysSkinsPath,function(){r()})}.bind(this),function(r){p.mkdir(this.customSkinsPath,function(){r()})}.bind(this),function(r){p.mkdir(this.customWidgetPath,function(){r()})}.bind(this)],
function(){f&&f()})}.bind(this);this._logger=require("x.logger.js").getLogger("m.aio.skinmanager.SkinManager");var c=require("path"),g=a.getAppResourcePath();g?(a=a.getUserResourcePath())?(this.sysSkinsPath=g+c.sep+this.SKIN_FLODER,this.customSkinsPath=a+c.sep+this.SKIN_FLODER,this.customWidgetPath=a+c.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this._configmanager=b,require("async").series([function(f){e(f)}.bind(this),function(f){this._loadAllSkins(function(q,p){!q&&p&&(this.skins=p);f()}.bind(this))}.bind(this)],
function(){d&&d()}.bind(this))):d&&d(Error("user resource path invalid")):d&&d(Error("app resource path invalid"))},_loadAllSkins:function(a){var b=[];require("async").parallel([function(d){this._loadSkins(this.sysSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.SYSTEM},function(e,c){!e&&c&&(b=b.concat(c));d()})}.bind(this),function(d){this._loadSkins(this.customSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.CUSTOM},function(e,c){!e&&c&&(b=b.concat(c));d()})}.bind(this)],function(d){a&&a(d,b)})},
_loadSkins:function(a,b,d){var e=require("fs"),c=require("path"),g=require("async"),f=[];e.readdir(a,function(q,p){!q&&p?g.each(p,function(r,l){m.aio.skinmanager.Skin.load(a+c.sep+r,r,b,function(t,x){!t&&x&&f.push(x);l()})}.bind(this),function(r){d(r,f)}):d(null,f)}.bind(this))},_getPermittedSkins:function(a,b,d){this._configmanager.trace("config/tenants/"+a,function(e,c){if(e)d&&d(e);else{e=c.license;c=[];for(var g=require("m.aio.infomanager"),f=0;f<b.length;f++)b[f]&&b[f].id&&(2==b[f].type?c.push(b[f]):
g.permitSkin(b[f].id,e)&&c.push(b[f]));d&&d(null,c)}}.bind(this))},_isSkinPermitted:function(a,b,d){for(var e=0;e<this.skins.length;e++)if(this.skins[e]&&this.skins[e].id&&this.skins[e]&&this.skins[e].id==b&&2==this.skins[e].type){d&&d(null,!0);return}e=this._configmanager;var c=require("m.aio.infomanager");e.trace("config/tenants/"+a,function(g,f){g?d&&d(g):d&&d(null,c.permitSkin(b,f.license))}.bind(this))},getResourceByURL:function(a,b){var d=function(p,r,l){var t=this._getSkin(p,r.skinId);t?e(t,
r,function(x,y){!x&&y?l&&l(null,y):t.base?(t=this._getSkin(p,t.base))?e(t,r,function(F,B){F?l&&l(F):l&&l(null,B)}):l&&l(Error("invalid resource path")):l&&l(Error("invalid resource path"))}.bind(this)):l&&l(Error("no such skin"))},e=function(p,r,l){var t=require("path"),x=require("fs"),y=t.join(p.path,r.widgetType,r.widgetName,r.resourcePath);x.exists(y,function(F){F?l&&l(null,y):l&&l(Error("no such resource"))})},c=require("path"),g=require("fs"),f=m.aio.skinmanager.Url.resolve(a);if(f instanceof
m.aio.skinmanager.LocalUrl)d.call(this,this.skins,f,b);else if(f instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var q=this.customWidgetPath+c.sep+f.widgetType+c.sep+f.widgetName+c.sep+f.resourcePath;g.exists(q,function(p){p?b&&b(null,q):b&&b(Error("no such resource"))})}else f instanceof m.aio.skinmanager.InRemoteUrl?this._getInRemoteSkins(f.tenantId,f.remoteId,function(p,r){p?b&&b(p):d.call(this,r,f,b)}.bind(this)):f instanceof m.aio.skinmanager.InRemoteCustomWidgetUrl?this._getRemoteFolder(f.tenantId,
f.remoteId,function(p,r){if(p)b&&b(p);else{var l=c.join(r+c.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER+c.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,f.widgetType,f.widgetName,f.resourcePath);g.exists(l,function(t){t?b&&b(null,l):b&&b(Error("no such resource"))})}}.bind(this)):b&&b(Error("no such resource"))},deleteResourceByURL:function(a,b){var d=require("path"),e=require("fs");a=m.aio.skinmanager.Url.resolve(a);if(a instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var c=
this.customWidgetPath+d.sep+a.widgetType+d.sep+a.widgetName+d.sep+a.resourcePath;e.exists(c,function(g){g?e.unlink(c,function(f){b&&b(f)}):b&&b()})}else b&&b(Error("can not delete this type of resource"))},getSkinList:function(a,b,d){var e=[];a&&b?this._getInRemoteSkins(a,b,function(c,g){!c&&g&&(e=e.concat(g));this._getPermittedSkins(a,this.skins,function(f,q){!f&&q&&(e=e.concat(q));d&&d(null,e)})}.bind(this)):this._getPermittedSkins(a,this.skins,function(c,g){!c&&g&&(e=e.concat(g));d&&d(null,e)})},
uploadResource:function(a,b,d,e,c,g){if(a&&b){d||(d=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE);e||(e=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME);c||(c=a);a=require("path");var f=require("async"),q=require("fs-extra"),p=require("fs-extra"),r=this.customWidgetPath+a.sep+d+a.sep+e,l=r+a.sep+c;f.series([function(t){q.ensureDir(r,t)},function(t){q.exists(l,function(x){x?p.move(l,l+"_del",function(y){y?t(y):q.unlink(l+"_del",function(F){t(F)})}):t()})},function(t){p.move(b,l,function(x){t(x)})}],
function(t){t?g&&g(t):(t=new m.aio.skinmanager.LocalCustomWidgetUrl,t.widgetType=d,t.widgetName=e,t.resourcePath=c,g&&g(null,t.toString()))})}else g&&g(Error("invalid paramters"))},_uploadResource:function(a,b,d,e,c){if(a&&b&&d&&e){var g=require("path");this._getRemoteFolder(a,b,function(f,q){if(f)c&&c(f);else{f=require("async");var p=require("fs"),r=q+g.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER;f.series([function(l){p.mkdir(r,function(){l()})},function(l){r=r+g.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;
p.mkdir(r,function(){l()})},function(l){r=r+g.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE;p.mkdir(r,function(){l()})},function(l){r=r+g.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME;p.mkdir(r,function(){l()})}],function(l){l?c&&c(l):p.rename(e,r+g.sep+d,function(t){t?c&&c(t):(t=new m.aio.skinmanager.InRemoteCustomWidgetUrl,t.tenantId=a,t.remoteId=b,t.widgetType=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,t.widgetName=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,
t.resourcePath=d,c&&c(null,t.toString()))})})}})}else c&&c(Error("invalid paramters"))},getRemoteWidgets:function(a,b,d,e,c){if(a)if(b){"string"==typeof e&&(e="true"==e);var g=[];require("async").parallel([function(f){this._getInRemoteCustomWidgets(a,b,function(q,p){!q&&p&&(g=g.concat(p));f()})}.bind(this),function(f){this._getLocalCustomWidgets(function(q,p){!q&&p&&(g=g.concat(p));f()}.bind(this))}.bind(this),function(f){d?e?this._getInRemoteSkinWidgets(a,b,d,function(q,p){!q&&p&&(g=g.concat(p));
f()}):this._isSkinPermitted(a,d,function(q,p){q||!p?f():this._getLocalSkinWidgets(d,function(r,l){!r&&l&&(g=g.concat(l));f()})}.bind(this)):f()}.bind(this)],function(f){c&&c(f,g)})}else c&&c(Error("remote id invalid"));else c&&c(Error("tenant id invalid"))},_getLocalSkinWidgets:function(a,b){a?this._getSkinWidgets(this.skins,a,function(d,e){b&&b(d,e)}):b&&b(Error("skin id invalid"))},_getLocalCustomWidgets:function(a){var b=new m.aio.skinmanager.LocalCustomWidgetDummySkin;b.path=this.customWidgetPath;
b.loadWidgets(function(d,e){a&&a(d,e)})},_getInRemoteSkinWidgets:function(a,b,d,e){this._getInRemoteSkins(a,b,function(c,g){c?e&&e(c):this._getSkinWidgets(g,d,function(f,q){e&&e(f,q)})}.bind(this))},_getInRemoteSkins:function(a,b,d){var e=require("path");this._getRemoteFolder(a,b,function(c,g){c?d&&d(c):this._loadSkins(g+e.sep+this.RESOURCE_FOLDER+e.sep+this.SKIN_FLODER,{skinType:m.aio.skinmanager.Skin.TYPE.REMOTE,tenantId:a,remoteId:b},function(f,q){d&&d(f,q)}.bind(this))}.bind(this))},_getInRemoteCustomWidgets:function(a,
b,d){var e=require("path");this._getRemoteFolder(a,b,function(c,g){c?d&&d(c):(c=g+e.sep+this.RESOURCE_FOLDER+e.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,g=new m.aio.skinmanager.DummySkin(a,b),g.path=c,g.loadWidgets(function(f,q){d&&d(f,q)}))}.bind(this))},_getRemoteFolder:function(a,b,d){require("fs");require("path");this._configmanager.trace("config/tenants/"+a+"/remotes/"+b,function(e,c){e?d&&d(e):(e=c.getFolderPath())?d&&d(null,e):d&&d(Error("remote folder path invalid"))}.bind(this))},_getSkin:function(a,
b){for(var d=0;d<a.length;d++)if(a[d].id==b)return a[d];return null},_getSkinWidgets:function(a,b,d){var e=this._getSkin(a,b);if(e){b=e;if(e.base)for(var c=0;c<a.length;c++)if(a[c].id==e.base){b=a[c];break}b.loadWidgets(function(g,f){g?d&&d(g):e.base?e.loadWidgets(function(q,p){if(q)d&&d(q);else{q=[];for(var r=0;r<p.length;r++){for(var l=!1,t=0;t<f.length;t++)if(p[r].hasSameRef(f[t])){l=!0;f[t].merge(p[r]);break}l||q.push(p[r])}f=f.concat(q);d&&d(null,f)}}):d&&d(null,f)})}else d&&d(Error("no skin has id "+
b))},_getInRemoteResourceFolder:function(a){return require("path").join(a,this.RESOURCE_FOLDER)},_getInRemoteSkinsFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.SKIN_FLODER)},_getInRemoteCustomWidgetFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.CUSTOM_IN_REMOTE_WIDGET_FOLDER)},_getLocalSkinResourcePath:function(a,b){var d=require("path"),e=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;d=d.join(a.path,
b);return e.existsSync(d)?d:a.base?this._getLocalSkinResourcePath(a.base,b):null},_getLocalSkinWidgetPath:function(a,b,d){var e=require("path"),c=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;e=e.join(a.path,b,d);return c.existsSync(e)?e:a.base?this._getLocalSkinResourcePath(a.base,b,d):null},saveRemote2:function(a,b,d){var e=require("fs-extra"),c=require("path"),g=require("async"),f=a.getFolderPath();if(f){var q=a.index,p=a.parent.parent.index,r=b&&b.skin&&b.skin.id?b.skin.id:
null,l=!(!a||!a.skin||!a.skin.id),t=b&&b.skin&&b.skin.inRemote,x=(new Date).getTime(),y=this._getInRemoteSkinsFolder(f),F=this._getInRemoteCustomWidgetFolder(f),B=f+c.sep+this.RESOURCE_FOLDER,D=f+c.sep+this.RESOURCE_FOLDER+"_"+x,G=f+c.sep+this.RESOURCE_FOLDER+"_"+x+c.sep+this.SKIN_FLODER,E=y+c.sep+b.skin.id,K=function(k){k=k.split("/");if("custom"!=k[0])return!1;if(2<k.length&&"custom"==k[0]){if(k[1].match(/^.+__\d+$/))return!1;k=k[k.length-1].split(".");if(3<=k.length&&k[k.length-2].match(/^\d+$/))return!1}return!0},
J=function(k,u){k=k.toString();u=u.split(".");2==u.length?u.splice(1,0,k):3<=u.length&&(u[u.length-2].match(/^\d+$/)?parseInt(u[u.length-2])<parseInt(k)&&(u[u.length-2]=k):u.splice([u.length-2],0,k));return u.join(".")},M=function(k,u,C){var w=require("fs-extra"),z=require("path"),L=require("crypto"),n=function(A){A=w.readFileSync(A);var H=L.createHash("md5");H.update(A);return H.digest("hex")},h=0;u=J(h,u);for(var v=k+z.sep+u;w.existsSync(v);){if(w.statSync(v).size==w.statSync(C).size&&n(v)==n(v))return u;
h++;u=J(h,u);v=k+z.sep+u}w.copySync(C,v,{clobber:!0});return u},O=function(k,u){var C,w=u.length;a:{var z=k.split("/");if(2<z.length&&"custom"==z[0]){if(z[1].match(/^.+__\d+$/)){var L=!0;break a}z=z[z.length-1].split(".");if(3<=z.length&&z[z.length-2].match(/^\d+$/)){L=!0;break a}}L=!1}for(var n=K(k);w--;){var h=u[w].getLocation();switch(h){case "local_custom":if(n)for(z=u[w].resources.length;z--;)if(u[w].resources[z].getRef()==k)return h=B+c.sep+"custom"+c.sep+u[w].type+c.sep+u[w].name,(C=M(h,u[w].resources[z].name,
u[w].resources[z].file))?"custom/"+u[w].type+"/"+u[w].name+"/"+C:null;break;case "in_remote_custom":if(n)for(z=u[w].resources.length;z--;){if(u[w].resources[z].getRef()==k){var v=u[w];C=u[w].resources[z];break}}else if(L)for(z=u[w].resources.length;z--;)if(u[w].resources[z].getRef()==k)return k=u[w].skin.path,"\\"==c.sep&&(k=k.replace(/\\/g,"/")),k=k.split("/"),2<k.length&&(k[k.length-2]=k[k.length-2]+"_"+x),k=k.join(c.sep),k=k+c.sep+u[w].type+c.sep+u[w].name+c.sep+u[w].resources[z].name,v=u[w].type,
C=v.indexOf("__"),0<C&&(v=v.substr(0,C)),h=F+c.sep+v+c.sep+u[w].name,(C=M(h,u[w].resources[z].name,k))?"custom/"+v+"/"+u[w].name+"/"+C:null;break;default:if(0==k.indexOf(u[w].type+"/"+u[w].name))for(z=u[w].resources.length;z--;)if(u[w].resources[z].getRef()==k){"in_remote_skin"==h?(k=G,k=k+c.sep+u[w].type+c.sep+u[w].name+c.sep+u[w].resources[z].name,h=y+c.sep+r+c.sep+u[w].type+c.sep+u[w].name+c.sep+u[w].resources[z].name,e.copySync(k,h,{clobber:!0})):u[w].resources[z].copySync(y,r);return}}}if(v&&
C)return k=v.skin.path,"\\"==c.sep&&(k=k.replace(/\\/g,"/")),k=k.split("/"),2<k.length&&(k[k.length-2]=k[k.length-2]+"_"+x),k=k.join(c.sep),k=k+c.sep+v.type+c.sep+v.name+c.sep+C.name,h=F+c.sep+v.type+c.sep+v.name,(C=M(h,C.name,k))?"custom/"+v.type+"/"+v.name+"/"+C:null};g.waterfall([function(k){t?k():e.remove(y,function(u){k(u)})},function(k){this.getRemoteWidgets(p,q,l?r:null,t,function(u,C){u?k(u):e.exists(B,function(w){w?e.move(B,D,function(z){k(z,C)}):k(null,C)})}.bind(this))}.bind(this),function(k,
u){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(C){for(var w=0;w<this.resourceBuf.length;w++)if(this.resourceBuf[w]&&this.resourceBuf[w].ref==C)return this.resourceBuf[w].newRef;try{var z=O(C,k);this.resourceBuf.push({ref:C,newRef:z});return z}catch(L){return null}},processWidgetSync:function(C){for(var w=0;w<this.widgetBuf.length;w++){var z=this.widgetBuf[w];if(z&&z.widgetType==C.widgetType&&z.widgetName==C.widgetName)return}try{for(w=0;w<k.length;w++)if(C.widgetType==
k[w].type&&C.widgetName==k[w].name){var L=k[w];break}if(L)switch(L.getLocation()){case "in_remote_skin":case "in_remote_custom":var n=L.skin.path;"\\"==c.sep&&(n=n.replace(/\\/g,"/"));var h=n.split("/");3<h.length&&(h[h.length-3]=h[h.length-3]+"_"+x);n=h.join(c.sep);L._copySync(n,y,r);break;default:L.copySync(y,r,d)}this.widgetBuf.push(C)}catch(v){}}},function(C){u(C)})},function(k){e.remove(D,k)},function(k){e.ensureDir(E,function(u){u?k(u):e.writeFile(E+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,
JSON.stringify({name:"in-remote"}),function(C){C||(b.skin.inRemote=!0);k(C)})})}],function(k){d&&d(k,b)})}else d&&d(Error("remote folder path invalid"))},saveRemote:function(a,b,d){var e=require("fs-extra"),c=require("path"),g=require("async"),f=require("m.aio.skinmanager.js"),q=a.getFolderPath();if(q){var p=b&&b.skin&&b.skin.id?b.skin.id:null,r=b&&b.skin&&b.skin.inRemote,l=this._getInRemoteResourceFolder(q),t=this._getInRemoteSkinsFolder(q),x=this.customWidgetPath.replace(this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,
""),y=t+c.sep+b.skin.id,F=function(n){return"custom"==n.split("/")[0]},B=function(n){if(!F(n))return!1;n=n.split("/");if(2<n.length){if(n[1].match(/^.+__\d+$/))return!0;n=n[n.length-1].split(".");if(3<=n.length&&n[n.length-2].match(/^\d+$/))return!0}return!1},D=function(n){return F(n)?!B(n):!1},G=function(n){return F(n)?!1:!(F(n)?0:r)},E=function(n,h){if(B(n)||D(n))return c.join(l,n);G(n);return c.join(t,h||p,n)},K=function(n,h){h=h.split("/");var v=h[h.length-1].split(".");v.splice(v.length-1,0,
""+n);h[h.length-1]=v.join(".");return h.join("/")},J=function(n,h){var v=require("fs-extra"),A=require("crypto"),H=function(I){I=v.readFileSync(I);var N=A.createHash("md5");N.update(I);return N.digest("hex")};if(v.existsSync(h))return v.statSync(h).size==v.statSync(n).size&&H(h)==H(n)?h:null;v.copySync(n,h,{clobber:!0});return h},M=[],O=[],k={},u={},C=function(n,h,v){var A=h+":"+(v||n);if(k[A])return k[A];var H=B(n)?c.join(l,n):D(n)?c.join(x,n):G(n)?f._getLocalSkinResourcePath(h||p,n):c.join(t,n);
h=E(v||n,h);if(B(n)||(F(n)?0:r))return k[A]=v||n,M.push(h),n;if(D(n)){var I=K(0,v||n);h=E(I);for(var N=0;!J(H,h);)I=K(++N,v||n),h=E(I);k[A]=I;M.push(h);return I}e.copySync(H,h,{clobber:!0});k[A]=v||n;M.push(h)},w=function(n){for(var h=e.readdirSync(n),v=0,A,H=0;H<h.length;H++)A=c.join(n,h[H]),(A=e.statSync(A).isDirectory()?w(A):z(A))&&v++;return v==h.length?(e.removeSync(n),!0):!1},z=function(n){if(-1!=M.indexOf(n))return!1;var h=require("unorm").nfc(n);if(-1!=M.indexOf(h))return!1;for(h=0;h<O.length;h++){var v=
O[h];if(n.substr(0,v.length)==v)return!1}e.removeSync(n);return!0},L={};g.waterfall([function(n){r?n():e.remove(t,function(h){n(h)})},function(n){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(h,v){v&&(L[v]=1);try{var A=C(h,v);this.resourceBuf.push({ref:h,newRef:A});return A}catch(H){return null}},processWidgetSync:function(h){try{h&&"object"===typeof h&&"string"===typeof h.widgetSkin&&(L[h.widgetSkin]=1);var v=h.widgetType+"/"+h.widgetName;h.widgetSkin&&(v=h.widgetSkin+
"/"+v);if(!u[v]){var A=r?c.join(t,h.widgetSkin||p,h.widgetType,h.widgetName):f._getLocalSkinWidgetPath(h.widgetSkin||p,h.widgetType,h.widgetName);var H=c.join(t,h.widgetSkin||p,h.widgetType,h.widgetName);r||e.copySync(A,H,{clobber:!0});u[v]=!0;O.push(H)}this.widgetBuf.push(h)}catch(I){}},processDefaultImageSync:function(h){try{var v=h._default,A=v.split("/");A.splice(A.length-1,1,"default.png");var H=A.join("/");H=C(v,h.img_skin,H);this.resourceBuf.push({ref:v,newRef:H});return H}catch(I){return console.error(I),
null}}},function(h){n(h)})},function(n){try{for(var h=require("unorm"),v=0;v<M.length;v++)M[v]=h.nfc(M[v]);e.existsSync(l)&&w(l);n(null)}catch(A){n(A)}},function(n){var h=[],v;for(v in L)if(v!==b.skin.id){var A=m.aio.skinmanager.SkinManager.skins.find(function(I){return 1===I.type||2===I.type?I.id===v:!1});A&&h.push(A)}var H=function(I){if(I>=h.length)n();else{var N=h[I];e.ensureDir(t+c.sep+N.id+c.sep,function(P){P?H(I+1):e.writeFile(t+c.sep+N.id+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify({name:"in-remote",
original:N.id,system:N.system||1,version:N.version}),function(Q){H(I+1)})})}};H(0)},function(n){e.ensureDir(y,function(h){if(h)n(h);else{h={name:"in-remote",original:b.skin.id};var v=m.aio.skinmanager.SkinManager.skins.find(function(A){return 1===A.type||2===A.type?A.id===b.skin.id:!1});v&&(h.system=v.system||1,h.version=v.version);e.writeFile(y+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify(h),function(A){A||(b.skin.inRemote=!0);n(A)})}})}],function(n){n&&(console.error(n),this._logger.log("error",
n));d&&d(n,b)}.bind(this))}else d&&d(Error("remote folder path invalid"))},downloadSystemSkin:function(a,b,d,e,c){var g="webservice.mediola.com",f=443,q="";switch(process.env.CLOUD){case "local":g=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost";f=8080;q="/webservice";break;case "dev":g=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com";f=80;break;default:g=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",f=443}d=Number(d);isNaN(d)&&(d=
0);var p=function(x,y,F){var B=F;F=443===f?require("https"):require("http");x={host:g,port:f,path:q+"/creatorneo/skin/getSkinUrl?license="+x+"&skinName="+encodeURIComponent(y)+"&level_support="+d,method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",Connection:"close"}};var D="";x=F.request(x,function(G){G.setEncoding("utf8");G.on("data",function(E){D+=E});G.on("end",function(){if(B)if(200==G.statusCode){try{var E=JSON.parse(D)}catch(K){B(Error("request response invalid:"+D))}E&&E.url?B(null,E.url,
E.version):B(Error("request response invalid:"+D))}else B(Error("request failed:"+D));B=null})});if(x.on&&"function"==typeof x.on)x.on("error",function(G){B&&B(G);B=null});x.setTimeout&&x.setTimeout(2E4);x.end()},r=this,l=this._logger,t=this._configmanager;a="config/tenants/"+a;l.log("debug","start to download system skin "+b);e&&e(0,"start");t.trace(a,function(x,y){if(x)c&&c(x);else{var F=y.license;e&&e(1,"get skin info from server");l.log("debug","try to get skin "+b+" info from server");p(F.licenseTxt,
b,function(B,D,G){B?c&&c(B):r._checkSystemSkinExists(b,G,function(E,K){E?c&&c(E):K?(l.log("debug","find system skin "+b),r._updateInfomanager(F,b,function(){c&&c()})):r._downloadAndSaveSkin(F,D,b,G,e,function(J){J?c&&c(J):r._updateInfomanager(F,b,function(){c&&c()})})})})}})},_checkSystemSkinExists:function(a,b,d){for(var e=!1,c=0;c<this.skins.length;c++)if(this.skins[c]&&1==this.skins[c].type&&this.skins[c].id==a){var g=this.skins[c].version?parseInt(this.skins[c].version):0,f=b?parseInt(b):0;if(g>=
f){e=!0;break}}d&&d(null,e)},_downloadAndSaveSkin:function(a,b,d,e,c,g){var f=this,q=this._logger,p=function(l,t,x){var y=require("m.aio.filemanager.js").getTmpDir(),F=require("path"),B=require("fs-extra"),D=F.join(y,t);try{B.existsSync(D)&&B.removeSync(D),B.ensureDirSync(D)}catch(E){x&&x(E);return}var G=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(G,function(E){f._logger.log("debug","Checked CPU for features: "+G.join(", ")+". Result: "+E);if(E){E=new (require("adm-zip"))(l);try{E.extractAllTo(D,
!0),x&&x(null,D)}catch(K){x&&x(K)}}else XC.unzip(l,D,f._logger,x)})},r=function(l,t,x,y){var F=require("path"),B=require("fs-extra"),D=F.join(l,x);B.existsSync(D)&&B.removeSync(D);B.move(t,D,{limit:100},function(G){B.chmod(D,511,function(E){y&&y(E,D)})})};c&&c(1,"get skin info from server");q.log("debug","start download skin "+d+" zip from server");c&&c(2,"download skin");(function(l,t,x){var y=x;l=require("url").parse(l);x=require("http");-1!=l.protocol.indexOf("https")&&(x=require("https"));l.method=
"GET";l.timeout=2E4;var F=require("m.aio.filemanager.js").getTmpDir(),B=require("path"),D=require("fs"),G=0,E=B.join(F,(new Date).getTime()+".zip"),K=D.createWriteStream(E);K.on("error",function(J){y&&y(J);y=null});l=x.request(l,function(J){var M=J.headers["content-length"];q.log("trace","http skin zip length:"+M);var O=!1,k=!1;J.pipe(K);K.on("finish",function(){K.close(function(){k=!0;O&&k&&y&&(200!=J.statusCode?y(Error("http response code:"+J.statusCode)):y(null,E),y=null)})});J.on("data",function(u){G+=
u.length;q.log("trace","receive chunk:"+u.length+" total:"+G+"/"+M);t&&t(parseFloat("2."+G),"download chunk "+G,{count:G,total:parseInt(M)})});J.on("end",function(){(O=!0,k)&&y&&(200!=J.statusCode?y(Error("http response code:"+J.statusCode)):y(null,E),y=null)})});if(l.on&&"function"==typeof l.on)l.on("error",function(J){y&&y(J);y=null});l.setTimeout&&l.setTimeout(2E4);l.end()})(b,c,function(l,t){l?g&&g(l):(c&&c(3,"unpack skin"),q.log("debug","start unpack skin from file:"+t),p(t,d,function(x,y){x?
g&&g(x):(q.log("debug","move skin from:"+y+" to:"+f.sysSkinsPath),r(f.sysSkinsPath,y,d,function(F,B){F?g&&g(F):(c&&c(4,"load skin"),q.log("debug","load skin "+d+" from:"+B),m.aio.skinmanager.Skin.load(B,d,{skinType:1},function(D,G){if(D)g&&g(D);else{D=-1;for(var E=0;E<f.skins.length;E++)if(f.skins[E]&&f.skins[E].type==G.type&&f.skins[E].id==G.id){D=E;break}-1!=D&&f.skins.splice(D,1);f.skins.push(G);G.updateVersion(e,function(K){g&&g(K)})}}))}))}))})},_updateInfomanager:function(a,b,d){require("m.aio.infomanager").updateDownloadSkin(a,
b,function(){d&&d()})}};"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.skinmanager.SkinManager);
