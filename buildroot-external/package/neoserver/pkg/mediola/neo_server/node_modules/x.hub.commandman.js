var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(k){return k.raw=k};$jscomp.createTemplateTagFirstArgWithRaw=function(k,f){k.raw=f;return k};$jscomp.arrayIteratorImpl=function(k){var f=0;return function(){return f<k.length?{done:!1,value:k[f++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.makeIterator=function(k){var f="undefined"!=typeof Symbol&&Symbol.iterator&&k[Symbol.iterator];return f?f.call(k):$jscomp.arrayIterator(k)};
$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,f,e){if(k==Array.prototype||k==Object.prototype)return k;k[f]=e.value;return k};
$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var f=0;f<k.length;++f){var e=k[f];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,f){var e=$jscomp.propertyToPolyfillSymbol[f];if(null==e)return k[f];e=k[e];return void 0!==e?e:k[f]};$jscomp.polyfill=function(k,f,e,b){f&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,f,e,b):$jscomp.polyfillUnisolated(k,f,e,b))};
$jscomp.polyfillUnisolated=function(k,f,e,b){e=$jscomp.global;k=k.split(".");for(b=0;b<k.length-1;b++){var a=k[b];if(!(a in e))return;e=e[a]}k=k[k.length-1];b=e[k];f=f(b);f!=b&&null!=f&&$jscomp.defineProperty(e,k,{configurable:!0,writable:!0,value:f})};
$jscomp.polyfillIsolated=function(k,f,e,b){var a=k.split(".");k=1===a.length;b=a[0];b=!k&&b in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<a.length-1;c++){var d=a[c];if(!(d in b))return;b=b[d]}a=a[a.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?b[a]:null;f=f(e);null!=f&&(k?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:f}):f!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[a]&&(e=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(a):$jscomp.POLYFILL_PREFIX+e+"$"+a),$jscomp.defineProperty(b,$jscomp.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:f})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(k){if(k)return k;var f=function(c,d){this.$jscomp$symbol$id_=c;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:d})};f.prototype.toString=function(){return this.$jscomp$symbol$id_};var e="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",b=0,a=function(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new f(e+(c||"")+"_"+b++,c)};return a},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(k){if(k)return k;k=Symbol("Symbol.iterator");for(var f="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<f.length;e++){var b=$jscomp.global[f[e]];"function"===typeof b&&"function"!=typeof b.prototype[k]&&$jscomp.defineProperty(b.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return k},"es6",
"es3");$jscomp.iteratorPrototype=function(k){k={next:k};k[Symbol.iterator]=function(){return this};return k};$jscomp.iteratorFromArray=function(k,f){k instanceof String&&(k+="");var e=0,b=!1,a={next:function(){if(!b&&e<k.length){var c=e++;return{value:f(c,k[c]),done:!1}}b=!0;return{done:!0,value:void 0}}};a[Symbol.iterator]=function(){return a};return a};$jscomp.polyfill("Array.prototype.keys",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(f){return f})}},"es6","es3");
$jscomp.polyfill("Object.is",function(k){return k?k:function(f,e){return f===e?0!==f||1/f===1/e:f!==f&&e!==e}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(k){return k?k:function(f,e){var b=this;b instanceof String&&(b=String(b));var a=b.length;e=e||0;for(0>e&&(e=Math.max(e+a,0));e<a;e++){var c=b[e];if(c===f||Object.is(c,f))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(k,f,e){if(null==k)throw new TypeError("The 'this' value for String.prototype."+e+" must not be null or undefined");if(f instanceof RegExp)throw new TypeError("First argument to String.prototype."+e+" must not be a regular expression");return k+""};$jscomp.polyfill("String.prototype.includes",function(k){return k?k:function(f,e){return-1!==$jscomp.checkStringArgs(this,f,"includes").indexOf(f,e||0)}},"es6","es3");var x=x||{};x.hub=x.hub||{};
x.hub.commandman=x.hub.commandman||{};
x.hub.commandman.MacroExecutor=function(){var k=function(f,e,b){this._id=-1;this._commandHandler=f;this._callback=b;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(e&&e.commands){"undefined"!=typeof e.pause&&null!==e.pause&&!isNaN(e.pause)&&0<=e.pause&&(this._pause=Math.max(Math.round(e.pause),1));this._commands=e.commands;f=[];for(e=this._commands.length-1;0<=e;e--)this._commands[e].removed||f.push(this._commands[e]);this._commands=f;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};k.prototype.cancel=function(f){this._canceling=!0;this._cancelCB=f};k.prototype._executeNextCommand=function(f){if(this._canceling){this._canceling=!1;var e=this._cancelCB;this._cancelCB=null;f=this._callback;this._callback=null;e&&e();f&&f(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){e=this._commands.pop();var b=this;if("command"==e.classid){var a=
{cmd:e.action.ref,device:e.action.device};a.cmd||(a.cmd={value:e.action.value});a.cmd&&null!==e.action.ext&&"undefined"!=typeof e.action.ext&&(a.cmd.ext=e.action.ext);e.action.path&&(a.cmd.path=e.action.path);"http_request"==e.action.type?this._commandHandler._doHTTPRequest({url:e.action.value,method:e.action.method,headers:e.action.headers,body:e.action.body},function(){b._executeNextCommand()}):f?this._commandHandler._executeCommand(a,function(){b._executeNextCommand()}):setTimeout(function(){b._commandHandler._executeCommand(a,
function(){b._executeNextCommand()})},b._pause)}else"navigate"==e.classid?(f={type:null},1===e.history?f.type="page_next":-1===e.history?f.type="page_prev":e.page?(f.type="navigate",f.data=e.page):f.type="refresh",b._commandHandler._doAction(f),setTimeout(function(){b._executeNextCommand(!0)},b._pause)):"sleep"==e.classid&&setTimeout(function(){b._executeNextCommand(!0)},e.time)}else this._callback&&this._callback()};return k}();
x.hub.commandman.CommandHandler=function(){var k=function(f,e){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=e;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=f;this._deviceManager||(this._deviceManager=require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};k.prototype.init=function(f,e){this._logger.log("info","init command manager");e&&e()};k.prototype.executeCommandWithRef=function(f,e,b,a,c){var d,
g=this._deviceManager;if(f&&e){var h=g.findDevice(f,e);if(!h){c&&c({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(b){if(d=g.findGateway(b),!d){c&&c({error:Error("gateway not found")});return}}else{c&&c({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var l=JSON.parse(JSON.stringify(h.info));l.deviceName=e}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));m.gatewayName=b;m.__neoInfo={db:this._id,index:d.index}}this.executeCommand(l,
m,a,c)};k.prototype.getStateWithRef=function(f,e,b,a,c){var d,g=this._deviceManager;if(f&&e){var h=g.findDevice(f,e);if(!h){c&&c({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(b){if(d=g.findGateway(b),!d){c&&c({error:Error("gateway not found")});return}}else{c&&c({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var l=JSON.parse(JSON.stringify(h.info));l.deviceName=e}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));
m.gatewayName=b;m.__neoInfo={db:this._id,index:d.index}}this.getState(l,m,a,c)};k.prototype.executeCommandWithIdx=function(f,e,b,a){var c,d=this._deviceManager;if(f){var g=d.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});return}g.info&&g.info.gateway&&(c=d.findGatewayWithIndex(g.info.gateway))}else if(e){if(c=d.findGatewayWithIndex(e),!c){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=
JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(c&&c.info){var l=JSON.parse(JSON.stringify(c.info));l.gatewayName=c.name;l.__neoInfo={db:this._id,index:c.index}}this.executeCommand(h,l,b,a)};k.prototype.getStateWithIdx=function(f,e,b,a,c){if(b&&Array.isArray(b))this.getStatesWithIdx(f,e,b,a,c);else{var d;c=this._deviceManager;if(f){var g=c.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});return}g.info&&g.info.gateway&&(d=c.findGatewayWithIndex(g.info.gateway))}else if(e){if(d=
c.findGatewayWithIndex(e),!d){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(d&&d.info){var l=JSON.parse(JSON.stringify(d.info));l.gatewayName=d.name;l.__neoInfo={db:this._id,index:d.index}}this.getState(h,l,b,a)}};k.prototype.getStatesWithIdx=function(f,e,b,a,c){var d;c=this._deviceManager;if(f){var g=c.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});
return}g.info&&g.info.gateway&&(d=c.findGatewayWithIndex(g.info.gateway))}else if(e){if(d=c.findGatewayWithIndex(e),!d){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(d&&d.info){var l=JSON.parse(JSON.stringify(d.info));l.gatewayName=d.name;l.__neoInfo={db:this._id,index:d.index}}f=[];for(e=0;e<b.length;e++)c=b[e],c.id&&c.value&&f.push({id:c.id,device:h,
status:c});this.getMultiStatesLegacy(h,l,f,function(m){if(m.error)a&&a(m);else{var n={data:{}};m.data&&m.data.forEach(function(p){p&&p.id&&(n.data[p.id]=p.status)});a&&a(n)}})};k.prototype.executeCommand=function(f,e,b,a){if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c){if(("aio"==c||"neoserver"==c)&&b&&"cfOn"==b.value||"cfOff"==b.value){if(!e||!e.__neoInfo||!e.__neoInfo.index){a&&a({});return}if(this._deviceManager.getOwnIdx()==e.__neoInfo.index){a&&a({});return}}if((c=
require("x.hub.moduleman.js").modulemanager.getModule(c))&&c.executeCommand){var d={};f&&(d=JSON.parse(JSON.stringify(f)));e&&(d.gateway=JSON.parse(JSON.stringify(e)));e=this._logger;var g=e.log,h=JSON,l=h.stringify;try{var m=JSON.parse(JSON.stringify(f));"undefined"!=typeof m.username&&null!=m.username&&(m.username="xxxxxx");"undefined"!=typeof m.password&&null!=m.password&&(m.password="xxxxxx");var n=m}catch(p){n=f}g.call(e,"trace","do command:"+l.call(h,n));this._logger.log("trace","command:"+
JSON.stringify(b));c.executeCommand(d,b,a)}else this.executeCommandLegacy(f,e,b,a)}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.getState=function(f,e,b,a){if(!b||Array.isArray(b))this.getStates(f,e,b,a);else if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c)if((c=require("x.hub.moduleman.js").modulemanager.getModule(c))&&c.getState){var d={};f&&(d=JSON.parse(JSON.stringify(f)));
e&&(d.gateway=JSON.parse(JSON.stringify(e)));c.getState(d,b.value,function(g){a&&a(g)})}else this.getStateLegacy(f,e,b,a);else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.executeCommandLegacy=function(f,e,b,a){if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c){var d=require("m.aio.modulemanager.js").getModule(c);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;
h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.executeCommand(c,g,f,b,function(l,m){if(f&&"cam"==f.sys&&b&&"snapshot"==b.value&&!l&&m)try{require("x.hub.camman.js").saveSnapshot(f,m,function(){})}catch(n){}a&&a({error:l,data:m})}):a&&a(Error("can not generate host"))}else a&&a({error:Error("no module can handle sys:"+c)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.getStateLegacy=
function(f,e,b,a){if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c){var d=require("m.aio.modulemanager.js").getModule(c);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(c,g,[{id:"alias",device:f,status:b}],function(l,m){l?a&&a(l):(l=null,m[0]&&(l=m[0].status),a&&a({data:{value:l}}))}):a&&a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+
c)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no status")});else a&&a({error:Error("no device or gateway")})};k.prototype.getStates=function(f,e,b,a){if(f||e){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c)if((c=require("x.hub.moduleman.js").modulemanager.getModule(c))&&c.updateStates){var d={};f&&(d=JSON.parse(JSON.stringify(f)));e&&(d.gateway=JSON.parse(JSON.stringify(e)));c.updateStates(d,function(g){a&&a(g)},b)}else this.getStatesLegacy(f,e,b,a);else a&&
a({error:Error("no sys parameter")})}else a&&a({error:Error("no device or gateway")})};k.prototype.getStatesLegacy=function(f,e,b,a){if(f||e){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c){var d=require("m.aio.modulemanager.js").getModule(c);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStatesForSingleDevice(c,g,f,b,function(l,m){l?a&&a(l):a&&a({data:m})}):a&&a({error:Error("can not generate host")})}else a&&
a({error:Error("no module can handle sys:"+c)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device or gateway")})};k.prototype.getMultiStatesLegacy=function(f,e,b,a){if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);if(c){var d=require("m.aio.modulemanager.js").getModule(c);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(c,g,b,function(l,
m){l?a&&a(l):a&&a({data:m})}):a&&a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+c)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device list")});else a&&a({error:Error("no device or gateway")})};k.prototype.execute=function(f,e,b,a,c){this._handler.execute(f,e,b,a,c)};k.prototype._executeCommand=function(f,e){f&&f.device&&f.cmd?f.device.name&&f.device.room?this.executeCommandWithRef(f.device.room,f.device.name,null,f.cmd,e):
f.device.name?this.executeCommandWithRef(null,null,f.device.name,f.cmd,e):e&&e({error:Error("cmd object has no valid device")}):e&&e({error:Error("cmd object format invalid")})};k.prototype._doAction=function(f,e){e&&e({})};k.prototype._doHTTPRequest=function(f,e){var b=null,a="GET",c=null,d=null;"string"===typeof f?b=f:(d=f.body||d,c=f.headers||c,a=f.method||a,b=f.url);f=String(b).toLowerCase();0===f.indexOf("http:")||0===f.indexOf("https:")?(b=require("url").parse(b),f="https:"==b.protocol?require("https"):
require("http"),a={host:b.hostname,method:a,path:b.path,port:b.port,protocol:b.protocol},c&&"object"===typeof c&&(a.headers=c),b.auth&&(a.auth=b.auth),c=f.request(a,function(g){e&&e()}),c.on("error",function(g){XC.debugf(g);e&&e()}),"string"===typeof d&&c.write(d),c.end()):(0<b.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:b}),e&&e())};k.prototype.executeMacro=function(f,e,b){var a=this,c=new x.hub.commandman.MacroExecutor(this,f,function(d){for(var g=
-1,h=0;h<a._macroExecutors.length;h++)if(a._macroExecutors[h]==c){g=1;break}-1!=g&&a._macroExecutors.slice(g,1);e&&e({error:d})});c._id=this._macroExecutors.length+1;this._macroExecutors.push(c);b&&b({id:c._id})};k.prototype.cancelMacro=function(f,e){for(var b=null,a=-1,c=0;c<this._macroExecutors.length;c++){var d=this._macroExecutors[c];if(d&&d._id==f){a=c;b=d;break}}b?(-1!=a&&this._macroExecutors.slice(a,1),b.cancel(function(){e&&e({})})):e&&e()};k.prototype.updateGeneralDeviceStates=function(f,
e){var b=this;f||(f=1E4);this._deviceManager.getAllGeneralDevice(function(a,c){if(a)e&&e(a);else if(c&&0!=c.length){var d={};a=[];for(var g=0;g<c.length;g++){var h=c[g];if(h._origin&&h._origin.info&&h.details&&h.details.states){var l=h._origin;l.states=h.details.states;h._origin.info.gateway?(h=h._origin.info.gateway,d[h]||(d[h]=[]),d[h].push(l)):a.push(l)}}var m=e,n={};c=Object.keys(d);var p=0,q=c.length+a.length;setTimeout(function(){m&&(m(null,n),m=null)},f);c.forEach(function(r){b._updateGeneralGatewayDeviceStates(r,
d[r],function(t,u){if(!t&&u)for(var v in u)n[v]=u[v];p++;p==q&&m&&(m(null,n),m=null)})});a.forEach(function(r){b._updateGeneralIPDeviceStats(r,function(t,u,v){!t&&v&&(n[u]=v);p++;p==q&&m&&(m(null,n),m=null)})})}else e&&e(null,{})})};k.prototype._updateGeneralGatewayDeviceStates=function(f,e,b){var a=this._deviceManager.findGatewayWithIndex(f);if(a)if(a.info){a=JSON.parse(JSON.stringify(a.info));a.__neoInfo={db:this._id,index:f};f=[];for(var c=0;c<e.length;c++){var d=e[c];if(d&&d.info&&d.states)for(var g in d.states)f.push({id:d.index+
":"+g,device:d.info,status:d.states[g]})}this._updateGeneralStates(null,a,f,function(h,l){if(h)b&&b(h);else{h={};if(l)for(var m=0;m<l.length;m++){var n=l[m];if(n.id){var p=n.id.indexOf(":");if(-1!=p){var q=parseInt(n.id.substr(0,p));if(p=n.id.substr(p+1))h[q]||(h[q]={}),h[q][p]=n.status}}}b&&b(null,h)}})}else b&&b(Error("invalid gateway json"));else b&&b(Error("no such gateway"))};k.prototype._updateGeneralStates=function(f,e,b,a){if(f||e)if(b){var c=null;e&&e.sys&&(c=e.sys);!c&&f&&f.sys&&(c=f.sys);
if(c){var d=require("x.hub.moduleman.js").modulemanager.getModule(c);if(d&&d.updateGeneralStates)c={},f&&(c=JSON.parse(JSON.stringify(f))),e&&(c.gateway=JSON.parse(JSON.stringify(e))),d.updateGeneralStates(deviceJSON,gatewayJSON,b,function(l){a&&a(l)});else if(d=require("m.aio.modulemanager.js").getModule(c)){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(c,g,b,function(l,m){a&&a(l,m)}):a&&
a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+c)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device list")});else a&&a({error:Error("no device or gateway")})};return k}();
x.hub.commandman.CommandHandlerV6=function(){var k=require("xnm.aio.gateway.js").GatewayV6,f=function(){var b=function(a){k.call(this);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.gateway.GatewayLocal");this._options=a};b.prototype=new k;b.prototype.constructor=b;b.prototype._executeRequest=function(a,c,d,g){this._executeRequestLocal(a,c,d,g)};b.prototype._executeRequestLocal=function(a,c,d,g){this._executeRequestV5(a,c,d,g)};
b.prototype._executeRequestV5=function(a,c,d,g){if("/"==a.charAt(0))var h=a;else{h="/cmd";var l=c;c={};c.XC_FNC=a;if(l)for(var m in l)"XC_FNC"!=m&&(c[m]=l[m])}m=l=a=null;var n=h,p=0,q="GET";d&&"POST"==d.method?(q="POST",c&&(this._options.command_source&&c.data&&(c.data.source=this._options.command_source),l=c,a=JSON.stringify(c),p=a.length)):c&&(this._options.command_source&&c.data&&(c.source=this._options.command_source),n=h+"?"+require("querystring").stringify(c),m=c);c={method:q,url:n,path:h,query:m?
m:{},body:a,json:l,size:p,hasValidAuth:!0};this._logger.log("trace","execute command mediola "+JSON.stringify(c));var r=this;require("x.hub.js").getServer().doRequest(h,c,function(t){r._logger.log("trace","execute command mediola return:"+JSON.stringify(t));var u=null;if(t)try{(u=JSON.parse(t))&&u.XC_SUC?g&&g(null,u.XC_SUC):u&&u.XC_ERR?g&&g(Error(t),u.XC_ERR):g&&g(Error(h+" request return invalid format"))}catch(v){g&&g(v)}else g&&g(Error(h+" request return null"))})};return b}(),e=function(b){this._logger=
require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6");this._deviceManager=b};e.prototype.executeCommandWithCommandInfo=function(b,a,c){if(b)if(b.device&&b.device.restricted&&c&&("webserver"==c.source||"cloud"==c.source))b=Error("restricted"),b.code="000005",a&&a(b);else if(b.id)this.executeDeviceCommandWithId(b.id,b,a,c?c.source:null);else if(void 0!=b.rule&&null!=b.rule)this.executeRuleCommandWithId(b.rule,b,a,c);else if(void 0!=b.group&&null!=b.group)this.executeGroupCommandWithId(b.group,
b,a,c);else if(void 0!=b.device&&null!=b.device){var d=b.device.mod;d?"cloud"==d?(d=b.device,this.executeCloudCommand(d,b,a,c?c.source:null)):this.executeDeviceCommandWithJson(b.device,b.device.gateway,b,a):(d=b.device,this.executeCommandMediola(d,b,a,c?c.source:null))}else b.command?this.executeCommandRaw(b,a):b.legacycloudaction?this.executeLegacyCloudAction(b.legacycloudaction,a,c?c.source:null):b.cloudaction?this.executeCloudAction(b.cloudaction,a,c?c.source:null):(b=Error("unsupported command"),
b.code="000005",a&&a(b));else b=Error("invalid parameter"),b.code="000005",a&&a(b)};e.prototype.executeCommandRaw=function(b,a){if(b&&b.command){var c="GET";b.value&&(c="POST");var d=require("url").parse(b.command),g=d.pathname;d=d.query;var h={};d&&(h=require("querystring").parse(d));d={method:c,url:b.command,path:g,query:h,body:b.value?JSON.stringify(b.value):null,json:b.value,size:b.value?(new Buffer(JSON.stringify(b.value),"utf8")).length:0,hasValidAuth:!0};this._logger.log("trace","execute command raw "+
JSON.stringify(d));if(b.gateway)if(d=this._getGateway(b.gateway,null))if(b&&b.command)try{if(b.value)var l=b.value.XC_FNC,m=b.value;else{var n=b.command.indexOf("/"),p=b.command.indexOf("?");l=b.command.slice(n,p);m=this._getParamsFromStringCommand(b.command)}d._executeRequest(l,m,{method:c},function(r){a&&a(r)})}catch(r){a&&a(r.message)}else a&&a(Error("invalid command json"));else a(Error("can not find the corresponding gw "+b.gateway));else{var q=this;require("x.hub.js").getServer().doRequest(g,
d,function(r){q._logger.log("trace","execute command raw return:"+JSON.stringify(r));var t=null;if(r)try{(t=JSON.parse(r))&&t.XC_SUC?a&&a(null,t.XC_SUC):t&&t.XC_ERR?a&&a(Error(r)):a&&a(Error(g+" request return invalid format"))}catch(u){a&&a(u)}else a&&a(Error(g+" request return null"))})}}else a&&a(Error("invalid command json"))};e.prototype._getParamsFromStringCommand=function(b){b=b.replace("/cmd?","");var a=b.split("&");b={};a=$jscomp.makeIterator(a);for(var c=a.next();!c.done;c=a.next())c=c.value.split("="),
b[c[0]]=c[1];return b};e.prototype.executeCommandMediola=function(b,a,c){if(b&&(b.id||b.sys))if(a&&(a.command||a.cmd)){var d=this._getGateway(b.gateway,a);if(d)if(b=JSON.parse(JSON.stringify(b)),b=this._convertDevice(b,a),a=this._convertCommand(b,a),b.id)d._executeRequest("SendGenericCmd",{id:b.id,data:{cmd:a.value,value:a.ext}},{method:"POST"},function(h){c&&c(h)});else if("HM"==b.type&&"heater"==b.data&&b.address.includes(".BidCos-RF."))d._executeRequest("SendSC",{address:b.address,data:""+a.ext,
type:"HM"},null,function(h){c&&c(h)});else{var g=require("xnm.aio.gateway.js").devicemanager.getSystem(b);g&&g.executeCommandCreator?g.executeCommandCreator(d,b,a,function(h){c&&c(h)}):c&&c(Error("unknown device type"))}else c&&c(Error("unknown or invalid gateway"))}else c&&c(Error("invalid command json"));else c&&c(Error("invalid device json"))};e.prototype.executeDeviceCommandWithId=function(b,a,c,d){var g=require("x.hub.deviceman.js").deviceManagerV6,h=g.getDevice(b);if(h)if("cloud"==d&&h.restricted)a=
Error("invalid parameter"),a.code="000005",this._logger.log("error","access from cloud is restricted for "+b),c&&c(a);else{d=null;if(h.gateway&&(d=g.getGateway(h.gateway),!d)){a=Error("invalid parameter");a.code="000005";this._logger.log("error","can not find gateway info for "+b+" - gw :"+h.gateway);c&&c(a);return}this.executeDeviceCommandWithJson(h,d,a,function(l){l||g.setBufferedStates(b,null);c&&c(l)})}else a=Error("invalid parameter"),a.code="000005",this._logger.log("error","can not find device with id "+
b+" "),c&&c(a)};e.prototype.executeDeviceCommandWithJson=function(b,a,c,d){var g=b.mod;a&&a.type&&(g=a.type);"alpha"==g&&(g="moehlenhoff");try{var h=require("x.hub.m."+g+".js");if(h&&h.executeCommandV6)h.executeCommandV6(b,a,c,function(m){m&&(m.code="000000");d&&d(m)});else{var l=Error("invalid parameter");l.code="000005";d&&d(l)}}catch(m){l=Error("invalid parameter"),l.code="000005",d&&d(l)}};e.prototype.executeRuleCommandWithId=function(b,a,c,d){if(d)if("webserver"==d.source){if(1==d.locked&&0==
d.pinMatch){a=Error("access denied (locked)");a.code="000007";c&&c(a);return}}else if("cloud"==d.source&&1==d.locked&&(0==d.pinMatch||0==d.rcs)){a=Error("access denied (locked)");a.code="000007";c&&c(a);return}b?(b=require("x.hub.rule.js").getRuleManager().getRule(b))?b.executeCommand(a,function(g){g&&!g.code&&(g.code="000005");c&&c(g)}):(a=Error("invalid parameter"),a.code="000005",c&&c(a)):(a=Error("invalid parameter"),a.code="000005",c&&c(a))};e.prototype.executeGroupCommandWithId=function(b,a,
c,d){if(b)if(a){var g=require("x.hub.group.js").getGroupManager();g.getGroup(b)?g.executeGroupCommand(b,a,function(h){h&&!h.code&&(h.code="000005");c&&c(h)},d):(b=Error("invalid parameter"),b.code="000005",c&&c(b))}else b=Error("invalid parameter"),b.code="000005",c&&c(b);else b=Error("invalid parameter"),b.code="000005",c&&c(b)};e.prototype.executeCloudCommand=function(b,a,c,d){this._logger.log("trace","execute cloud device: "+JSON.stringify(b)+" command: "+JSON.stringify(a));d=require("x.hub.js").getServer();
if(d.isCloudConnected()){var g=this,h={command:{sys:b.sys,data:b.data,command:a.command}};a.value&&(h.command.value=a.value);d._cloudConnect.sendMessageWithType(h,6,function(l){g._logger.log("trace","execute cloud device: "+JSON.stringify(b)+" command: "+JSON.stringify(a)+" "+(l?"failed: "+l.message:"success"));c&&c(l)})}else this._logger.log("trace","execute cloud command failed: cloud connection not connected"),c&&c(Error("cloud connection not connected"))};e.prototype.executeLegacyCloudAction=
function(b,a,c){this._logger.log("trace","execute legacy cloud action "+b+" from: "+c);var d=null;localStorage&&(d=localStorage.getItem("x.hub.v5.SID"));if(d){var g=parseInt(b,16);c=new Buffer(32);c.writeUInt8(Math.floor(256*Math.random()),0);var h=Math.round((new Date).getTime()/1E3);c.writeInt32BE(h,1);c.writeUInt8(1,5);c.writeUInt8(1,6);for(h=0;h<d.length/2;h++){var l=d.substr(2*h,2);l=parseInt(l,16);c.writeUInt8(l,h+7)}c=Buffer.concat([c,new Buffer(d,"hex")]);c.writeUInt8(1,23);255<g?(c.writeUInt8(2,
5),c.writeUInt8(2,23),c.writeInt16BE(g,24)):c.writeUInt8(g,24);this._logger.log("trace","execute legacy cloud action "+b+" plain buffer: "+c.toString("hex").substr(0,8)+" ...");g=require("crypto");h=new Buffer([42,115,204,166,146,83,35,244,99,130,213,30,57,56,21,227]);l=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]);d="";g=g.createCipheriv("aes-128-cbc",h,l);g.setAutoPadding(!1);d+=g.update(c,null,"hex");d+=g.final("hex");this._logger.log("trace","execute legacy cloud action "+
b+" encrypted: "+d.substr(0,8)+" ...");c=require("x.hub.js").getServer();var m=this;c.isCloudConnected()?(this._logger.log("trace","execute legacy cloud action "+b+" via cloud connection"),c={event:{type:"LEGACYRA",data:d}},require("x.hub.js").server._cloudConnect.sendMessageActive(c,function(n){m._logger.log("trace","execute legacy cloud action "+b+" via cloud connection "+(n?"failed: "+n.message:"success"));a&&a(n)})):(this._logger.log("trace","execute legacy cloud action "+b+" via http request"),
c=c.getCloudServer(),c=require("http").request({host:c,port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},function(n){n.setEncoding("utf8");var p="";n.on("data",function(q){p+=q});n.on("end",function(){m._logger.log("trace","execute legacy cloud action "+b+" via http response:"+n.statusCode+" - "+p);var q;200!=n.statusCode&&(q=Error("http request failed with status code:"+n.statusCode));a&&(a(q),a=null)})}),c.setTimeout(5E3,function(){m._logger.log("trace",
"execute legacy cloud action "+b+" via http timeout");a&&(a(Error("http timeout")),calback=null)}),c.on("error",function(n){m._logger.log("trace","execute legacy cloud action "+b+" via http failed:"+n.message);a&&(a(Error("http error: "+n.message)),calback=null)}),c.write(new Buffer(d,"hex")),c.end())}else this._logger.log("trace","execute legacy cloud action "+b+" failed: no sid"),a&&a(Error("no sid"))};e.prototype.executeCloudAction=function(b,a,c){this._logger.log("trace","execute cloud action "+
b+" from: "+c);c=require("x.hub.js").getServer();if(c.isCloudConnected()){var d=this;c._cloudConnect.sendMessageActive({event:{type:"ACTION",data:b}},function(g){d._logger.log("trace","execute cloud action "+b+" via cloud connection "+(g?"failed: "+g.message:"success"));a&&a(g)})}else this._logger.log("trace","execute cloud action "+b+" failed: cloud connection not connected"),a&&a(Error("cloud connection not connected"))};e.prototype.getBufferedDeviceStates=function(b){var a=require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();
b&&b(null,a)};e.prototype.getDeviceStatesWithStateInfo=function(b,a,c){if(b)if(void 0!=b.id&&null!=b.id)this.getDeviceStatesWithId(b.id,a,c);else if(void 0!=b.device&&null!=b.device){var d=b.device.mod;d?"cloud"==d?(b=Error("not support get states with "+JSON.stringify(b)),b.code="000005",a&&a(b)):this.getDeviceStatesWithJson(b.device,b.device.gateway,a):this.getDeviceStatesMediola(b.device,a,c)}else void 0!=b.rule&&null!=b.rule?this.getRuleStatesWithId(b.rule,a,c):void 0!=b.rules&&null!=b.rules&&
b.rules.length?this.getRulesStates(a,c):(b=Error("invalid parameter"),b.code="000005",a&&a(b));else a&&a(Error("state info is null"))};e.prototype.getDeviceStatesMediola=function(b,a,c){if(b&&(b.id||b.sys))if(c=this._getGateway(b.gateway)){var d=this._convertDevice(b);if(d){var g=this._getSystem(d),h=this;this._logger.log("trace","get states from gateway "+JSON.stringify(b.gateway));c._executeRequest("getStates",null,null,function(l,m){if(l)a&&a(l);else{l=null;for(var n=0;n<m.length;n++){var p=m[n];
if(p){if(b.id&&p.sid==b.id&&p.state){l=p.state;break}if(g&&g._handleState&&(p=g._handleState(d,p))&&Object.keys(p)){l=p;break}}}l&&(l=h._convertStates(d,l));a&&a(null,l)}})}else a&&a(Error("invalid device"))}else a&&a(Error("unknown or invalid gateway"));else a&&a(Error("invalid device json"))};e.prototype.getDeviceStatesWithId=function(b,a,c){if(b){var d=require("x.hub.deviceman.js").deviceManagerV6,g=d.getDevice(b);if(g)if("cloud"==c&&g.restricted)c=Error("invalid parameter"),c.code="000005",this._logger.log("error",
"access from cloud is restricted for "+b),a&&a(c);else{c=null;if(g.gateway&&(c=d.getGateway(g.gateway),!c)){c=Error("invalid parameter");c.code="000005";this._logger.log("error","can not find gateway info for "+b+" - gw :"+g.gateway);a&&a(c);return}this.getDeviceStatesWithJson(g,c,function(h,l){!h&&l&&d.setBufferedStates(b,l);a&&a(h,l)})}else c=Error("invalid parameter"),c.code="000005",this._logger.log("error","can not find device with id "+b+" "),a&&a(c)}else c=Error("invalid parameter"),c.code=
"000005",a&&a(c)};e.prototype.getDeviceStatesWithJson=function(b,a,c){var d=b.mod;a&&a.type&&(d=a.type);"alpha"==d&&(d="moehlenhoff");try{var g=require("x.hub.m."+d+".js");if(g&&g.getStatesV6)g.getStatesV6(b,a,function(l,m){l&&(l.code="000000");c&&c(l,m)});else{var h=Error("invalid parameter");h.code="000005";this._logger.log("error","can not find the module for "+d);c&&c(h)}}catch(l){h=Error("invalid parameter"),h.code="000005",this._logger.log("error",l.stack?l.stack:l),c&&c(h)}};e.prototype.getRuleStatesWithId=
function(b,a,c){b?(c=require("x.hub.rule.js").getRuleManager().getRule(b),c||(b=Error("invalid parameter"),b.code="000005",a&&a(b)),c.getStates(function(d,g){a&&a(d,g)})):(b=Error("invalid parameter"),b.code="000005",a&&a(b))};e.prototype.getRulesStates=function(b,a){a=require("x.hub.rule.js").getRuleManager().getRules();if(!a){var c=Error("invalid parameter");c.code="000005";b&&b(c)}var d={},g;for(g in a)a[g].getStates(function(h,l){d[g]=l});b&&b(c,d)};e.prototype._getGateway=function(b,a){if(!b)return b=
{},a&&a.source&&(b.command_source=a.source),new f(b);a=b;if("object"!=typeof a&&(a=require("x.hub.deviceman.js").deviceManagerV6.getGateway(a),!a))return null;a=this._convertGateway(a);return require("xnm.aio.gateway.js").resolveGateway(a)};e.prototype._convertDevice=function(b,a){var c=JSON.parse(JSON.stringify(b));c.data=c.type;"light"==c.data&&(c.data="switch");c.type=c.sys;c.sys="aio";if("IT"==c.type)c.address&&-1==c.address.indexOf(".")&&(b=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"IT"}),
b=b._resolveAddress(c.address),"object"==typeof b?(c.address=b.address,c.data="bell"):c.address=b);else if("HM"==c.type||"HMIP"==c.type){if("HMIP"==c.type||c.address&&"HMIP"==c.address.substr(0,4).toUpperCase())c._ver="v5+";"v5+"==c._ver?(c.type="HM","switch"==b.type||"light"==b.type?c.data="ip_switch":"dimmer"==b.type?c.data="ip_dimmer":"heater"==b.type?c.data="ip_heater":"shutter"==b.type?c.data="ip_blind":"blind"==b.type?c.data="ip_jalousie":"sensor"==b.type?"water"==b.subtype&&(c.data="ip_water"):
b.type||(c.data=a&&a.command?"up"==a.command||"down"==a.command||"brightness"==a.command?"ip_dimmer":"stop"==a.command||"position"==a.command?"ip_blind":"lamella"==a.command?"ip_jalousie":"temperature"==a.command||"mode"==a.command?"ip_heater":"ip_switch":"ip_switch")):"shutter"==b.type?c.data="blind":"sensor"==b.type?("illumination"==b.subtype&&(c.data="lux"),"weather"==b.subtype&&(c.data="weather_station")):b.type||(c.data=a&&a.command?"up"==a.command||"down"==a.command||"brightness"==a.command?
"dimmer":"stop"==a.command||"position"==a.command||"lamella"==a.command?"blind":"temperature"==a.command||"mode"==a.command?"heater":"switch":"switch")}else"R2"==c.type?"shutter"==b.type?c.data="blind":"blind"==b.type&&(c.data="blind"):"FS20"==c.type||"FS"==c.type?(c.type="FS20",c.address&&-1==c.address.indexOf(".")&&(b=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"FS20"}),b=b._resolveAddress(c.address),c.address=b)):"KP"==c.type||"KOPP"==c.type?c.type="KOPP":"BK"==c.type?"shutter"==
c.data&&(c.data="blind"):"DY"==c.type?"shutter"==c.data&&(c.data="blind"):"DY2"==c.type?"shutter"==c.data&&(c.data="blind"):"SL"==c.type?"shutter"==c.data&&(c.data="blind"):"RT"==c.type&&"shutter"==c.data&&(c.data="jalousie");return c};e.prototype._convertCommand=function(b,a){var c=a.command?a.command:a.cmd,d=c,g=a.value;if(b.id)return"brightness"==d?d="dimTo":"position"==d?d="moveTo":"temperature"==d?d="tempTo":"lamella"==d?d="lamellaTo":"mode"!=d||"auto"!=g&&"manu"!=g&&"boost"!=g||(d="boost"==
g?"boostOn":g,g=""),("HM"==b.type&&"v5+"==b._ver||"CL"==b.sys||"BL"==b.sys)&&"moveTo"==d&&(g=100-parseInt(g)),{value:d,ext:g};"brightness"==c&&(d="dimTo");"position"==c&&(d="moveTo");if("HM"==b.type){if("blind"==b.data||"ip_blind"==b.data||"ip_jalousie"==b.data)"up"==c?d="moveUp":"down"==c&&(d="moveDown");else if("dimmer"==b.data||"ip_dimmer"==b.data)"up"==c?d="dimUp":"down"==c&&(d="dimDown");else if("heater"==b.data||"ip_heater"==b.data)"up"==c?d="tempUp":"down"==c?d="tempDown":"mode"==c?"auto"==
a.value?d="ip_heater"==b.data?"auto":"setAuto":"manu"==a.value?d="ip_heater"==b.data?"manu":"setManu":"boost"==a.value&&(d="ip_heater"==b.data?"boostOn":"setBoost"):"boostOff"==c&&(d="boostOff");"temperature"==c?d="tempTo":"position"==c?d="moveTo":"lamella"==c&&(d="lamellaTo");"v5+"==b._ver&&"moveTo"==d&&(g=100-g)}else"FS"==b.type||"FS20"==b.type?"up"==c?"dimmer"==b.data?d="dimUp":"shutter"==b.data&&(d="moveUp"):"down"==c&&("dimmer"==b.data?d="dimDown":"shutter"==b.data&&(d="moveDown")):"KP"==b.type||
"KOPP"==b.type?"up"==c?d="on":"down"==c&&(d="off"):"CF3"==b.type||"CF4"==b.type?"brightness"==c?d="bri":"color"==c?"CF3"==b.type?d="rgb":"CF4"==b.type&&(d="rgbw"):"scene"==c&&(d="scene"+a.value):"IN"==b.type?"fan"==b.data?"up"==c?d="levelUp":"down"==c?d="levelDown":"level"==c?d="level"+a.value:"mode"==c&&("auto"==a.value?d="auto":"turbo"==a.value&&(d="turbo")):"blind"==b.data&&("up"==c?d="moveUp":"down"==c?d="moveDown":"scene"==c?d="gotoP":"position"==c&&(d="position")):"BK"==b.type?"blind"==b.data&&
("up"==c?d="moveUp3s":"down"==c?d="moveDown3s":"stepUp"==c?d="moveUp":"stepDown"==c?d="moveDown":"position"==c&&(1==a.value?d="pos1":2==a.value&&(d="pos2"))):"DY"==b.type?"blind"==b.data&&("up"==c?d="moveUp":"down"==c?d="moveDown":"stepUp"==c?d="up":"stepDown"==c&&(d="down")):"DY2"==b.type?"blind"==b.data&&("up"==c?d="moveUp":"down"==c?d="moveDown":"stepUp"==c?d="up":"stepDown"==c&&(d="down")):"ER"==b.type?"shutter"==b.data&&("up"==c?d="3sUp":"down"==c?d="3sDown":"position"==c&&("air"==a.value?d=
"doubleUp":"shadow"==a.value&&(d="doubleDown"))):"SL"==b.type?"blind"==b.data&&("up"==c?d="moveUp":"down"==c?d="moveDown":"stepUp"==c?d="on":"stepDown"==c&&(d="off")):"RT"==b.type?"up"==c?d="fullUp":"down"==c?d="fullDown":"stepUp"==c?d="up":"stepDown"==c&&(d="down"):"WA"==b.type?"up"==c?d="moveUp":"down"==c?d="moveDown":"stepUp"==c?d="up":"stepDown"==c&&(d="down"):"WR"==b.type?"up"==c?d="moveUp":"down"==c&&(d="moveDown"):"CL"==b.type?"moveTo"==d&&(g=100-g):"BL"==b.type&&"moveTo"==d&&(g=100-g);return{value:d,
ext:g}};e.prototype._convertGateway=function(b){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.ip=b.address;b.username=b.user;b.password=b.pwd;b.version="ca";1==b.legacy&&(b.version="e1");return b};e.prototype._getSystem=function(b){return require("xnm.aio.gateway.js").devicemanager.getSystem(b)};e.prototype.resolveDeviceStates=function(b,a){var c=a.value,d=a.source;a=a.type;var g=null,h=!1;if(b.id&&b.id==c.id)g=c.state;else if(b.device){if(b.device.gateway){if("ST"==d)return null;if("object"==typeof b.device.gateway){if(b.device.gateway.address!=
d)return null}else{var l=this._deviceManager.getGateway(b.device.gateway);if(!l||l.address!=d)return null}}d=this._convertDevice(b.device);if(b.device.id&&c.sid==b.device.id&&(h=!0,g=c.state,c.changed)){l={};for(var m in g)-1!=c.changed.indexOf(m)&&(l[m]=g[m]);g=l}if(!h&&b.device.address){if(!d)return null;b=this._getSystem(d);if(!b)return null;"state"==a?b._handleState&&(g=b._handleState(d,c)):b._handleUdpState&&(g=b._handleUdpState(d,c))}g&&(g=this._convertStates(d,g))}return g?g:null};e.prototype._convertStates=
function(b,a){a=JSON.parse(JSON.stringify(a));"IW"==b.type?(a.state=a.windowState,delete a.windowState):"IT"==b.type?a.windowState?(a.state=a.windowState,delete a.windowState):a.doorState&&(a.state=a.doorState,delete a.doorState):"HM"==b.type&&("v5+"==b._ver?"undefined"!=typeof a.blindLevel&&null!=a.blindLevel&&(a.position=100-parseInt(a.blindLevel)):("undefined"!=typeof a.blindState&&null!=a.blindState&&(a.position=a.blindState),"lux"==b.data?a.illumination=a.state:"blind"==b.data?a.position=a.blindState:
"weather_station"==b.data&&(a.temperature=a.temp,delete a.temp,a.humidity=a.hum,delete a.hum,a.speed=a.winS,delete a.winS,a.direction=a.winD,delete a.winD,a.rain="on"==a.rain)));return a};e.prototype.matchDeviceState=function(b,a){if(!b||!a)return!1;var c=a.value;c||(c="state");var d=a.states,g="==";!d&&a.comp&&(a.comp.operator&&(g=a.comp.operator),void 0!=a.comp.value&&null!=a.comp.value&&(d=[a.comp.value]));if(!d)return!1;a=b[c];if(void 0==a||null==a)return!1;b=!1;switch(g){case "==":b="true"==
a||1==a?-1!=d.indexOf("true")||-1!=d.indexOf(!0):"false"==a||0==a?-1!=d.indexOf("false")||-1!=d.indexOf(!1):-1!=d.indexOf(a);break;case "!=":b="true"==a||1==a?-1==d.indexOf("true")||-1==d.indexOf(!0):"false"==a||0==a?-1==d.indexOf("false")||-1==d.indexOf(!1):-1==d.indexOf(a);break;case ">=":b=parseFloat(a)>=parseFloat(d[0]);break;case ">":b=parseFloat(a)>parseFloat(d[0]);break;case "<=":b=parseFloat(a)<=parseFloat(d[0]);break;case "<":b=parseFloat(a)<parseFloat(d[0])}return b};return e}();
x.hub.commandman.Handler=function(){var k=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2);this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6(require("./x.hub.deviceman.js").deviceManagerV6)};k.prototype.CommandHandler=x.hub.commandman.CommandHandler;k.prototype.CommandHandlerV6=x.hub.commandman.CommandHandlerV6;k.prototype.init=
function(f,e){"CA"==global.HARDWARE_VERSION?this._config(f):this._configOld(f);this.commandHandler.init(e)};k.prototype._config=function(f){var e=this;f=require("x.hub.js").getServer();f.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(b,a){(b=b.json)?e.commandHandler.executeCommand(b.device,b.gateway,b.command,function(c){a.json(e._toRestfulResponse(c.error,"ok"))}):a.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/xhub/commandman/getState",
{method:"POST"},function(b,a){(b=b.json)?e.commandHandler.getState(b.device,b.gateway,b.status,function(c){a.json(e._toRestfulResponse(c.error,c.data))}):a.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/api/command",function(b,a){var c=b.json;c||"GET"!=b.method||(c=b.query);e.commandHandlerV6.executeCommandWithCommandInfo(c,function(d){d?a.json({XC_ERR:{code:d.code,msg:d.message}}):a.json({XC_SUC:{}})},b)});f.addRoute("/api/state",function(b,a){var c=b.json;
c||"GET"!=b.method||(c=b.query);e.commandHandlerV6.getDeviceStatesWithStateInfo(c,function(d,g){d?a.json({XC_ERR:{code:d.code,msg:d.message}}):a.json({XC_SUC:g})},b.source)});f.addRoute("/api/states",function(b,a){e.commandHandlerV6.getBufferedDeviceStates(function(c,d){c?a.json({XC_ERR:{code:c.code,msg:c.message}}):a.json({XC_SUC:d})})})};k.prototype._configOld=function(f){var e=require("body-parser");f.use("/xhub/commandman",e.json({limit:"50mb"}));f.post("/xhub/commandman/executeCommand",function(a,
c){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(d){c.json(this._toRestfulResponse(d.error,"ok"))}.bind(this))}.bind(this));f.post("/xhub/commandman/getState",function(a,c){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(d){c.json(this._toRestfulResponse(d.error,d.data))}.bind(this))}.bind(this));var b=this;f=require("x.hub.js").getServer();f.addRoute("/api/command",function(a,c){b.commandHandlerV6.executeCommandWithCommandInfo(a.query,
function(d){d?c.json({XC_ERR:{code:d.code,msg:d.message}}):c.json({XC_SUC:{}})},a.source)});f.addRoute("/api/state",function(a,c){b.commandHandlerV6.getDeviceStatesWithId(a.query?a.query.id:null,function(d,g){d?c.json({XC_ERR:{code:d.code,msg:d.message}}):c.json({XC_SUC:g})},a.source)});f.addRoute("/api/states",function(a,c){b.commandHandlerV6.getBufferedDeviceStates(function(d,g){d?c.json({XC_ERR:{code:d.code,msg:d.message}}):c.json({XC_SUC:g})})})};k.prototype._toRestfulResponse=function(f,e){return f?
{status:"fail",message:f.message,code:f.code?f.code:0}:{status:"success",data:e}};return k}();module.exports=new x.hub.commandman.Handler;
