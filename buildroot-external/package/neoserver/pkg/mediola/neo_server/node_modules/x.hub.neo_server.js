var x=x||{};x.hub=x.hub||{};x.hub.neo_server=x.hub.neo_server||{};
x.hub.neo_server.Time=function(){var k=function(a){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Time");this._handler=a};k.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},
{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},
{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,
zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}];k.prototype.init=function(a){a&&a()};k.prototype.getTimezoneSync=function(){var a=new Date,b=new Date(a.getFullYear(),
0,1);a=new Date(a.getFullYear(),6,1);b=b.getTimezoneOffset();a=a.getTimezoneOffset();var c=b!=a,d=Math.round((0-Math.max(b,a))/60),m=null;k.TimeZone_MAP.forEach(function(n){n.utc==d&&n.dst==c&&(m=n.zone)});return m};k.prototype.getTimezoneEncoded=function(a){var b=new Date,c=new Date(b.getFullYear(),0,1);b=new Date(b.getFullYear(),6,1);c=c.getTimezoneOffset();b=b.getTimezoneOffset();var d=Math.round((0-Math.max(c,b))/60)+11;0>d&&(d=0);12<d&&(d=12);c=(((c!=b?1:0)<<7|d&31)&255).toString(16).toUpperCase();
2>c.length&&(c="0"+c);a&&a(null,c)};return k}();
x.hub.neo_server.Network=function(){var k=function(a){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Network");this._handler=a};k.prototype.init=function(a){a&&a()};k.prototype.getNetwork=function(a){var b=this;this._getDNS(function(c,d){b._getRouter(function(m,n){m=require("os").networkInterfaces();var r={},f;for(f in m)if("lo"!=f.substr(0,2))for(var l=m[f],e=0;e<l.length;e++){var h=l[e];h.internal||"IPv4"!=h.family||(h={ip:h.address,subnet:h.netmask,mac:h.mac,dns:d},h.router=n?
n[f]:null,r[f]=h)}a&&a(null,r)})})};k.prototype._getDNS=function(a){var b=require("dns"),c=[];b&&b.getServers&&(c=b.getServers());a(null,c)};k.prototype._getRouter=function(a){try{var b=require("netroute").getInfo(),c={};if(b&&b.IPv4)for(var d=0;d<b.IPv4.length;d++)"0.0.0.0"==b.IPv4[d].destination&&b.IPv4[d].interface&&b.IPv4[d].gateway&&(c[b.IPv4[d].interface]=b.IPv4[d].gateway);a(null,c)}catch(m){a(m)}};return k}();
x.hub.neo_server.Handler=function(){var k=function(){this._network=new x.hub.neo_server.Network(this);this._time=new x.hub.neo_server.Time(this);this._hub=null};k.prototype.init=function(a,b){this._hub=a;this._network.init();this._time.init();b&&b()};k.prototype.setTZData=function(a,b){b&&b()};k.prototype.getTZData=function(a){this._time.getTimezoneEncoded(a)};k.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync()};k.prototype.reset=function(a,b){var c=this;switch(a){case "factory":this._stm.reset(function(d){d?
b&&b(d,d?!1:!0):c._zwayServer.reset(function(){c._sysConf.reset(function(m){b&&b(m,m?!1:!0)})})});break;default:b&&b(Error("unknonw reset type: "+a))}};k.prototype.backup=function(a,b,c){var d=this,m=function(e,h,g){var p=require("fs-extra"),q=require("path"),y=require("os").tmpdir(),v=require("archiver"),t=new Date,u=t.getFullYear()+"",w=t.getMonth()+1+"";1==w.length&&(w="0"+w);var B=t.getDate()+"";1==B.length&&(B="0"+B);var C=t.getHours()+"";1==C.length&&(C="0"+C);var D=t.getMinutes()+"";1==D.length&&
(D="0"+D);t=t.getSeconds()+"";1==t.length&&(t="0"+t);var E="backup_"+(u+w+B+C+D+t)+".xbp",A=q.join(y,E);q=p.createWriteStream(A);v=v("zip");q.on("close",function(){if(h){var z=require("crypto").createCipher("aes-256-cbc",h),G=p.createReadStream(A),F=p.createWriteStream(A+".enc");F.on("finish",function(){p.removeSync(A);g(null,A+".enc",E)});G.pipe(z).pipe(F)}else g(null,A,E)});q.on("error",function(z){d._logger.log("warn","write backup zip file failed:"+z.message);g(z)});v.on("error",function(z){d._logger.log("warn",
"zip backup data failed:"+z.message);g(z)});v.pipe(q);v.directory(e+"/","backup");v.finalize()},n=null,r=require("x.crypt.js");a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?n=a.query.at:a.query.auth&&(n=r.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));a=require("fs");r=require("os").tmpdir();var f=require("path"),l=f.join(r,"backup");if(a.existsSync(l))try{a.rmdirRecursiveSync(l)}catch(e){}try{a.mkdirSync(l)}catch(e){b.status(500).end();c&&c(Error('create backup folder "'+f+
'" failed:'+e.message));return}this._backup(l,function(e){e?(b.status(500).end(),c&&c(e)):m(l,n,function(h,g,p){h?(b.status(500).end(),c&&c(h)):(b.setHeader("Content-disposition","attachment; filename="+p),b.sendFile(g,null,function(q){require("fs-extra").removeSync(g);q&&b.status(500).end();c&&c(q)}))})})};k.prototype._backup=function(a,b){require("async").series([function(c){var d=require("fs-extra"),m=require("path"),n=require("x.hub.fileman.js").fileManager.getUserRootDataPath();d.copy(n,m.join(a,
"data"),function(r){r?c(r):d.exists(m.join(a,"data","localstorage","x.hub.Server.pwd"),function(f){f?d.remove(m.join(a,"data","localstorage","x.hub.Server.pwd"),function(l){c(l)}):c()})})}],function(c){b&&b(c)})};k.prototype.restore=function(a,b,c){var d=function(f,l,e){var h=require("fs"),g=require("fs-extra"),p=require("os").tmpdir(),q=require("path"),y=q.join(p,"restore"),v=q.join(y,"backup");if(g.existsSync(y))try{g.removeSync(y)}catch(w){e(w);return}g=require("fs-extra");var t=require("adm-zip"),
u=null;try{(new t(f)).extractAllTo(y,!0)}catch(w){u="invalid backup file/password"}u?l?(l=require("crypto").createDecipher("aes-256-cbc",l),p=h.createReadStream(f),h=h.createWriteStream(f+".dec.zip"),l.on("error",function(){g.removeSync(f);g.removeSync(f+".dec.zip");e(Error(u))}),h.on("finish",function(){u=null;try{(new t(f+".dec.zip")).extractAllTo(y,!0)}catch(w){u="invalid backup file/password"}g.removeSync(f);g.removeSync(f+".dec.zip");e(u?Error(u):null,v)}),p.pipe(l).pipe(h)):(g.removeSync(f),
e(Error(u)),e=null):(g.removeSync(f),e(null,v),e=null)},m=require("x.crypt.js"),n=null;a.query.key?n=a.query.key:a.query.at?n=a.query.at:a.query.auth&&(n=m.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));var r=this;(function(f,l){var e=require("fs"),h=require("os").tmpdir(),g=require("path").join(h,"restore.zip");if(e.existsSync(g))try{e.unlinkSync(g)}catch(q){l(q);return}var p=e.createWriteStream(g);f.pipe(p);p.on("finish",function(){p.close(function(){l(null,g)})});p.on("error",function(q){e.unlink(g);
l(q)})})(a,function(f,l){f?(b.json({XC_ERR:{code:"000000",msg:"donwload backup file failed:"+f.message}}),c&&c(f)):d(l,n,function(e,h){e?(b.json({XC_ERR:{code:"000000",msg:"extract backup data failed:"+e.message}}),c&&c(e)):r._restore(h,function(g){try{var p=require("fs-extra");p.removeSync(l);p.removeSync(h)}catch(q){}g?b.json({XC_ERR:{code:"000000",msg:"restore backup data failed:"+g.message}}):b.json({XC_SUC:{}});c&&c(g)})})})};k.prototype._restore=function(a,b){require("async").series([function(c){var d=
require("fs-extra"),m=require("path"),n=require("x.hub.fileman.js").fileManager.getUserRootDataPath();d.copy(m.join(a,"data"),n,function(r){c(r?Error("restore standard data failed:"+r.message):null)})}],function(c){b&&b(c)})};return k}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.neo_server.Handler);
