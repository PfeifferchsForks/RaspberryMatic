var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.panasonic=xnm.aio.panasonic||{};
xnm.aio.panasonic.BDP=function(){var b=function(d,a,c,e){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.BDP");this.ip=d;this.port=a;this.port||(this.port=80);this.username=c;this.password=e};b.URL="/WAN/dvdr/dvdr_ctrl.cgi";b.prototype._executeCommand=function(d,a){this._doRequest(d,a)};b.prototype._doRequest=function(d,a){var c=this,e=a;this._logger.log("trace","send data:"+d+" to:"+this.ip);a={host:this.ip,port:this.port,path:b.URL,method:"POST",headers:{"User-Agent":"MEI-LAN-REMOTE-CALL"}};
if(this.username||this.password)a.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),a.headers.Authorization="Basic "+(new Buffer((this.username?this.username:"")+":"+(this.password?this.password:""))).toString("base64");var h="",g=require("http").request(a,function(f){f.on("data",function(k){h+=k});f.on("end",function(){200==f.statusCode?(c._logger.log("trace","http request success"),e&&(e(null,h),e=null)):(c._logger.log("trace","http request error:"+f.statusCode),e&&(e(Error("post request failed with status code:"+
f.statusCode)),e=null))})});g.setTimeout&&g.setTimeout(3E3,function(){c._logger.log("trace","http request timeout");g.abort()});if(g.on&&"function"==typeof g.on)g.on("error",function(f){f||(f=Error("http request error"));c._logger.log("trace","http request error:"+f.message);e&&e(f);e=null});g.write(d);g.end()};return b}();xnm.aio.panasonic.BDP.DM=function(){return{SYS:"panasonic_bdp",getIPDeviceType:function(){return{sys:this.SYS,name:"Panasonic BDP"}}}}();
xnm.aio.panasonic.TV=function(){var b=function(d,a,c,e,h){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.TV");this.ip=d;this.port=a;if(!a||0>a)this.port=55E3;this.path=c;c||(this.path="/nrc/control_0");this.username=e;this.password=h};b.XML_HEADER='<?xml version="1.0" encoding="utf-8"?>';b.SOAP_EVELOPE_START='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">';b.SOAP_EVELOPE_END="</s:Envelope>";b.SOAP_BODY_START=
"<s:Body>";b.SOAP_BODY_END="</s:Body>";b.SOAP_SENDKEY_START='<u:X_SendKey xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">';b.SOAP_SENDKEY_END="</u:X_SendKey>";b.KEY_CODE_START="<X_KeyEvent>";b.KEY_CODE_END="</X_KeyEvent>";b.SOAP_SENDTXT_START='<u:X_SendString xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">';b.SOAP_SENDTXT_END="</u:X_SendString>";b.TXT_START="<X_String>";b.TXT_END="</X_String>";b.prototype._sendTxt=function(d,a){d=this._buildSoapReq(d,!0);this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendString",
d,function(c){a&&a(c)})};b.prototype._executeCommand=function(d,a){this._logger.log("debug","send key:"+d);d=this._buildSoapReq(d);var c=this;this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendKey",d,function(e){c._logger.log("debug","send key "+(e?"error:"+e.message:"success"));a&&a(e)})};b.prototype._buildSoapReq=function(d,a){var c=b.XML_HEADER;c+=b.SOAP_EVELOPE_START;c+=b.SOAP_BODY_START;c+=a?b.SOAP_SENDTXT_START:b.SOAP_SENDKEY_START;c+=a?b.TXT_START:b.KEY_CODE_START;c=c+d+(a?
b.TXT_END:b.KEY_CODE_END);c+=a?b.SOAP_SENDTXT_END:b.SOAP_SENDKEY_END;c+=b.SOAP_BODY_END;return c+=b.SOAP_EVELOPE_END};b.prototype._doRequest=function(d,a,c){var e=this,h="http://"+this.ip+":"+this.port+this.path,g=c;this._logger.log("trace","send data:"+a+" to:"+h);$.ajax({url:h,type:"POST",timeout:3E3,data:a,cache:!1,headers:{SOAPAction:'"'+d+'"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":a.length},username:this.username,password:this.password,success:function(){e._logger.log("trace",
"http request success");c&&c()},error:function(f,k){f="http request error:"+(f?f.status:"0")+"-"+k;g&&(g(Error(f)),g=null)}})};return b}();
xnm.aio.panasonic.DM=function(){var b=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};b.prototype=Error();b.prototype.name="PanasonicDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{getSys:function(){var d=[],a;for(a in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(a)&&xnm.aio.lg[a]&&xnm.aio.lg[a].DM&&d.push(xnm.aio.lg[a]);return d},registModule:function(d){for(var a=this.getSys(),c=0;c<a.length;c++)a[c]&&a[c].DM&&
a[c].DM.SYS&&d.register(a[c].DM.SYS,"panasonic")},getIPDeviceType:function(){for(var d=[],a=this.getSys(),c=0;c<a.length;c++)if(a[c]&&a[c].DM&&a[c].DM.getIPDeviceType){var e=a[c].DM.getIPDeviceType();e&&d.push(e)}return d}}}();xnm.aio.panasonic.Handler=function(){var b=function(){};b.prototype.devicemanager=xnm.aio.panasonic.DM;b.prototype.BDP=xnm.aio.panasonic.BDP;b.prototype.TV=xnm.aio.panasonic.TV;b.prototype.registModule=function(d){this.devicemanager.registModule(d)};return b}();
"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.panasonic.Handler);
