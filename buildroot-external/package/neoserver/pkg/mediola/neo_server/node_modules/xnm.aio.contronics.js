var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.contronics=xnm.aio.contronics||{};xnm.aio.contronics.ExecEngine=function(a,b,c,d){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.contronics.ExecEngine"):{log:function(){}};this.ip=a;this.port=b;if(!this.port||0>this.port)this.port=2110;this.user=c;this.password=d;this._sessionID=-1;this._statusBuffer=this._sessionTimeout=null};
xnm.aio.contronics.ExecEngine.prototype._doRequest2=function(a,b){if(a&&"string"==typeof a){this._logger.log("trace","[_doRequest2] do request: "+a);var c={host:this.ip,port:this.port,path:"/RPC2",method:"POST",headers:{"Content-Type":"text/xml","Content-length":a.length,"User-Agent":"mediola",Connection:"keep-alive"}},d=b,e=this,f=require("http").request(c,function(g){g.setEncoding("utf-8");var h=g.statusCode,m="";g.on("data",function(l){m+=l});g.on("end",function(){e._logger.log("debug","[_doRequest2] response status code: "+
h);e._logger.log("trace","[_doRequest2] response data: "+m);200==h?d&&(d(null,m),d=null):d&&(d(Error("http request error: "+h),m),d=null)})});f.setTimeout(6E4,function(){e._logger.log("warn","[_doRequest2] http request timeout");f.abort()});f.on("error",function(g){e._logger.log("warn","[_doRequest2] http request error: "+g.message);d&&(d(g),d=null)});a&&f.write(a);f.end()}else b&&b(Error("data invalid"))};
xnm.aio.contronics.ExecEngine.prototype._doRequestAjax=function(a,b){if(a&&"string"==typeof a){var c=this,d="http://"+this.ip+":"+this.port+"/RPC2";this._logger.log("trace","[_doRequestAjax] send POST to url: "+d+" data: "+a);var e=b;$.ajax({url:d,type:"POST",timeout:6E4,headers:{"Content-Type":"text/xml","Content-length":a.length,"User-Agent":"mediola",Connection:"keep-alive"},data:a,dataType:"text",cache:!0,success:function(f){c._logger.log("trace","[_doRequestAjax] http request success: "+f);e&&
(e(null,f),e=null)},error:function(f,g){f="http request error:"+(f?f.status:"0")+"-"+g;c._logger.log("trace","[_doRequestAjax] "+f);e&&(e(Error(f)),e=null)}})}else b&&b(Error("data invalid"))};
xnm.aio.contronics.ExecEngine.prototype._doXmlRpcReq=function(a,b,c){var d=require("x.xmlrpc.js"),e=this,f=function(h,m){if(h)xnm.aio.contronics.SessionBuffer.sessionHttpError(e.ip),c&&c(h);else{xnm.aio.contronics.SessionBuffer.sessionHttpOK(e.ip);try{var l=d.deserializeRsp(m);l.error?c&&c(Error("xmlrpc fault "+l.error.faultCode+":"+l.error.faultString)):l.params&&l.params[0]?c&&c(null,l.params[0]):c&&c(Error("xmlrpc response error"))}catch(r){e._logger.log("error","[_doXmlRpcReq] "+r.message),c&&
c(r)}}};try{var g=d.serializeReq(a,b);"undefined"!==typeof ARN&&ARN.isAndroid()?this._doRequestAjax(g,f):this._doRequest2(g,f)}catch(h){this._logger.log("error","[_doXmlRpcReq] "+h.message),c&&c(h)}};
xnm.aio.contronics.ExecEngine.prototype._execReq=function(a,b){this._logger.log("trace","[_execReq] execute requeset param: "+JSON.stringify(a));var c=this;this._doXmlRpcReq("appreq",a,function(d,e){d?b&&b(d):(c._logger.log("trace","[_execReq] get response param: "+JSON.stringify(e)+" for req: "+JSON.stringify(a)),e&&null!=e[0]&&"undefined"!=typeof e[0]?"*ERROR"==e[0]?(d=Error("ExecEngine api error"),d._errorCode=1,b&&b(d)):"*ERROR ID"==e[0]?(d=Error("ExecEngine invalid session id"),d._errorCode=
2,b&&b(d)):b&&b(null,e[0]):b&&b(Error("ExecEngine response format invalid")))})};xnm.aio.contronics.ExecEngine.prototype._doExecReq=function(a,b){var c=this;this._execReq(a,function(d,e){d?2==d._errorCode?(c._logger.log("debug","[_doExecReq] session invalid"),xnm.aio.contronics.SessionBuffer.removeSession(c.ip),c.signon(function(f,g){f?b&&b(f):(a[0]=g,31==a[1]&&(a[1]=24),c._doExecReq(a,b))})):b&&b(d):b&&b(null,e)})};
xnm.aio.contronics.ExecEngine.prototype._signon=function(a){this._logger.log("debug","signon");var b=[0,1];if(this.user&&null!=this.password&&"undefined"!=typeof this.password){var c=this._encodeCred(this.user,this.password);b.push(c)}var d=this;this._doExecReq(b,function(e,f){if(f){var g=parseInt(f);d._logger.log("debug","signon: "+g);0>=g&&!e&&(e=Error("can not acquire session id"),e._errorCode=3)}else e||(d._logger.log("debug","signon return invalid response"),e=Error("invalid response"));a&&a(e,
e?null:g)})};xnm.aio.contronics.ExecEngine.prototype._signoff=function(a,b){this._logger.log("debug","signoff:"+a);this._doExecReq([a,2],function(c,d){b&&b(c,d)})};
xnm.aio.contronics.ExecEngine.prototype._getDeviceList=function(a,b){var c=this;this._logger.log("debug","getDeviceList: "+a);this._doExecReq([a,8],function(d,e){if(d)b&&b(d);else if(e){var f=[];e.split("%06").forEach(function(g){if(g&&(g=g.split("%07"),5<=g.length)){for(var h={name:g[0],systemLabel:g[1],moduleLabel:g[2],moduleID:g[3],objects:[]},m=4;m<g.length;m++)if(g[m]){var l=g[m].split("%08");10==l.length&&(4!=m||h.name||(h.name=l[0]),h.objects.push({name:l[0],label:l[1],group:l[2],art:l[3],
type:l[4],min:l[5],max:l[6],valueInfo:l[7],ioInfo:l[8],deviceCode:l[9]}))}f.push(h)}});c._logger.log("debug","finish getDeviceList: "+a);b&&b(null,f)}else b&&b(null,[])})};xnm.aio.contronics.ExecEngine.prototype._getDeviceGroup=function(a,b){this._doExecReq([a,9],function(c,d){c?b&&b(c):b&&b(null,d)})};
xnm.aio.contronics.ExecEngine.prototype._getAllDeviceValue=function(a,b){this._logger.log("debug","getAllDeviceValue: "+a);var c=require("x.xmlrpc.js");this._doExecReq([a,24],function(d,e){if(d)b&&b(d);else if(e){d={};e=e.split("%06");for(var f=0;f<e.length;f++)if(e[f]){var g=e[f].indexOf("=");if(!(0>=g)){var h=e[f].substr(0,g);g=e[f].substr(g+1);h&&(d[h]=c._unescapeXml(g))}}b&&b(null,d)}else b&&b(null,{})})};
xnm.aio.contronics.ExecEngine.prototype._getIncDeviceValue=function(a,b){this._logger.log("debug","getIncDeviceValue: "+a);var c=require("x.xmlrpc.js");this._doExecReq([a,31],function(d,e){if(d)b&&b(d);else if(e){d={};e=e.split("%06");for(var f=0;f<e.length;f++)if(e[f]){var g=e[f].indexOf("=");if(!(0>=g)){var h=e[f].substr(0,g);g=e[f].substr(g+1);h&&(d[h]=c._unescapeXml(g))}}b&&b(null,d)}else b&&b(null,{})})};
xnm.aio.contronics.ExecEngine.prototype._changeValue=function(a,b,c,d){this._logger.log("debug","_changeValue: "+a);this._doExecReq([a,64,b+(null==c||"undefined"==typeof c?"":"="+c)],function(e,f){d&&d(e,f)})};
xnm.aio.contronics.ExecEngine.prototype._encodeCred=function(a,b){var c=function(d){for(var e=[],f=0;f<d.length;f++)e.push(d.charCodeAt(f));return e};a=c(a);a.push(127);b=c(b);a=a.concat(b);return function(d){for(var e=d[d.length-1]<<1,f=[],g=1;5>g;g++)f.push(Math.floor(220*Math.random())+32);d=f.concat(d);if(e){f=[];for(g=d.length-1;0<=g;g--)f.push(d[g]);d=f;f=[];for(var h,m=0;m<d.length;m++)g=d[m],h=g^e,31<g&&31<h?f.push(h):f.push(g);d=f}d[d.length-2]=e;e=d;d=e.length;f="";for(h=0;h<d;h++)g=e[h],
f=64>g?f+"1"+String.fromCharCode(g+64):191<g?f+"2"+String.fromCharCode(g-128):127<g?f+"3"+String.fromCharCode(g-64):f+String.fromCharCode(g);return f}(a)};xnm.aio.contronics.ExecEngine.prototype.signon=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(b)a&&a(null,b);else{var c=this;this._signon(function(d,e){!d&&e&&xnm.aio.contronics.SessionBuffer.addSession(c.ip,e,c);a&&a(d,d?null:e)})}};
xnm.aio.contronics.ExecEngine.prototype.signoff=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);b?(xnm.aio.contronics.SessionBuffer.removeSession(this.ip),this._signoff(b,function(c){a&&a(c)})):a&&a()};xnm.aio.contronics.ExecEngine.prototype.getDeviceList=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(b)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getDeviceList(b,a);else{var c=this;this.signon(function(d){d?a&&a(d):c.getDeviceList(a)})}};
xnm.aio.contronics.ExecEngine.prototype._executeCommand=function(a,b,c){var d=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(d)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._changeValue(d,a,b,function(f){c&&c(f)});else{var e=this;this.signon(function(f){f?c&&c(f):e._executeCommand(a,b,c)})}};
xnm.aio.contronics.ExecEngine.prototype._getStates=function(a){var b=function(g){return g?6500<(new Date).getTime()-g.getTime():!0},c=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip),d=xnm.aio.contronics.SessionBuffer.getStates(this.ip),e=xnm.aio.contronics.SessionBuffer.getStatesTimestamp(this.ip),f=this;c?!d||b(e)?(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getAllDeviceValue(c,function(g,h){g?a&&a(g):(xnm.aio.contronics.SessionBuffer.setStates(f.ip,h),a&&a(null,h))})):
(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getIncDeviceValue(c,function(g,h){g?a&&a(g):(xnm.aio.contronics.SessionBuffer.addStates(f.ip,h),a&&a(null,xnm.aio.contronics.SessionBuffer.getStates(f.ip)))})):this.signon(function(g){g?a&&a(g):f._getStates(a)})};
xnm.aio.contronics.ExecEngine.prototype.executeCommandCreator=function(a,b,c){if(a&&a.name&&a.art&&"string"==typeof a.art&&b)if(null==b.value||"undefined"==typeof b.value)c&&c(Error("comamnd value invalid"));else{var d=a.name;switch(a.art.toLowerCase()){case "u":var e=-1;if(a.valueInfo){a=a.valueInfo.split(";");for(var f=0;f<a.length;f++)if(a[f]==b.value){e=f;break}}b=-1==e?b.value:e;break;case "n":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("comamnd ext invalid"));return}b=b.ext;break;
case "s":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("comamnd ext invalid"));return}b=b.ext;break;case "m":b=null;break;default:c&&c(Error("device art do not supported"));return}this._executeCommand(d,b,c)}else c&&c(Error("execute comamnd argument invalid"))};
xnm.aio.contronics.ExecEngine.prototype.getStatesCreator=function(a,b,c){b?this._getStates(function(d,e){if(d)c&&c(d);else{d=[];for(var f=0;f<b.length;f++)if(b[f].id&&b[f].device&&b[f].status){var g=b[f].device.name,h=b[f].device.art,m=b[f].device.valueInfo;g&&(g=e[g],null!=g&&"undefined"!=typeof g&&("N"==h?"0"==m?d.push({id:b[f].id,status:parseInt(g)}):d.push({id:b[f].id,status:parseFloat(g)}):"U"==h&&m?(h=m.split(";"),m=parseInt(g),h[m]?d.push({id:b[f].id,status:h[m]}):d.push({id:b[f].id,status:g})):
d.push({id:b[f].id,status:g})))}c&&c(null,d)}}):c&&c(Error("deviceList is null"))};xnm.aio.contronics.ExecEngine.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.contronics.ExecEngine?this.ip==a.ip&&this.port==a.port&&this.user==a.user&&this.password==a.password:!1};xnm.aio.contronics.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.contronics.DMError.prototype=Error();xnm.aio.contronics.DMError.prototype.name="ContronicsDMError";
xnm.aio.contronics.DMError.prototype.code=0;xnm.aio.contronics.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.contronics.DM={SYS:"execengine",getGatewayType:function(){return[{sys:this.SYS,name:"Contronics ExecEngine",port:2110}]},createGateway:function(a,b,c){b=xnm.aio.contronics.DMError;var d=xnm.aio.contronics.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,"info is invalid"))},updateGateway:function(a,b,c,d){a=xnm.aio.contronics.DMError;c=xnm.aio.contronics.DMError.ERROR_CODE;b?b.ip?d(null,b):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"update is invalid"))},
deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var d=xnm.aio.contronics.DMError,e=xnm.aio.contronics.DMError.ERROR_CODE;if(a)if(null==a.art||"undefined"==typeof a.art)c(new d(e.INVALID,"art is invalid"));else if(a.name)if(a.gateway)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"name is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=xnm.aio.contronics.DMError,e=xnm.aio.contronics.DMError.ERROR_CODE;if(a)if(null==a.art||"undefined"==typeof a.art)c(new d(e.INVALID,"address is invalid"));else if(a.name)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):
c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"catagory is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=function(h,m){if("*"==h)return!0;for(var l=!1,r=0;r<h.length;r++)if(h[r]==m){l=!0;break}return l},d=function(h,m,l){var r=[];switch(l.catagory){case "command":h.command&&h.command.forEach(function(k){c(l.elems,k.type)&&(k=JSON.parse(JSON.stringify(k)),
r.push(k))});break;case "status":h.status&&h.status.forEach(function(k){c(l.elems,k.type)&&(k=JSON.parse(JSON.stringify(k)),r.push(k))})}return r},e=function(h,m){var l=[];if(!h.art||"string"!=typeof h.art)return null;var r=!0,k=!0;if(h.ioInfo)switch(parseInt(h.ioInfo)){case 1:k=!1;break;case 2:r=!1}var q,n=null;switch(h.art.toLowerCase()){case "u":n={};var p;h.valueInfo&&(p=h.valueInfo.split(";"));if(k&&p)for(n.command=[],q=0;q<p.length;q++)p[q]&&n.command.push({type:"enum",name:p[q],ref:{value:p[q]}});
if(r){n.status=[];k={type:"enum",name:"status",ref:{value:"status"}};if(p)for(k.ref.options=[],q=0;q<p.length;q++)p[q]&&k.ref.options.push(p[q]);n.status.push(k)}break;case "n":p=0;h.valueInfo&&0<parseInt(h.valueInfo)&&(p=h.valueInfo);var u=n=null,t;null!=h.min&&"undefined"!=typeof h.min&&(n=p?parseFloat(h.min):parseInt(h.min));null!=h.max&&"undefined"!=typeof h.max&&(u=p?parseFloat(h.max):parseInt(h.max));null==n||null==u||isNaN(n)||isNaN(u)||(q=""+n+"-"+u);p&&(t=""+1/Math.pow(10,p));n={};k&&(k=
{type:p?"float":"int",name:"set value",ref:{value:"set value",ext:p?"%f":"%d"}},q&&(k.ref.extMeta=q),t&&(k.ref.scale=t),n.command=[k]);r&&(k={type:p?"float":"int",name:"state",ref:{value:"state"}},q&&(k.ref.extMeta=q),t&&(k.ref.scale=t),n.status=[k]);break;case "s":n={};k&&(k={type:"string",name:"set value",ref:{value:"set value",ext:"%s"}},n.command=[k]);r&&(k={type:"string",name:"state",ref:{value:"state"}},n.status=[k]);break;case "m":n={},k&&(k={type:"enum",name:"execute",ref:{value:"execute"}},
n.command=[k])}n&&(k=d(n,h,m),l=l.concat(k));return l};if(!a.art)return null;var f=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=e(a,b);f.command=g;break;case "status":g=e(a,b);f.status=g;break;default:return null}return g&&0!=g.length?f:null}};
xnm.aio.contronics.SessionBuffer={MAX_HTTP_ERROR_COUNT:5,_sessionBuffer:{},_statesBuffer:{},addSession:function(a,b,c){this._sessionBuffer[a]&&this.removeSession(a);var d=this._createSessionTimeout(c);this._sessionBuffer[a]={sessionID:b,engine:c,timeout:d,httpError:0}},getSessionID:function(a){return this._sessionBuffer[a]?this._sessionBuffer[a].sessionID:0},removeSession:function(a){this._sessionBuffer[a]&&this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);delete this._sessionBuffer[a];
delete this._statesBuffer[a]},refreshSession:function(a){if(this._sessionBuffer[a]){null!=this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);var b=this._sessionBuffer[a].engine;b&&(this._sessionBuffer[a].timeout=this._createSessionTimeout(b))}},sessionHttpError:function(a){this._sessionBuffer[a]&&(this._sessionBuffer[a].httpError+=1,this._sessionBuffer[a].httpError>=this.MAX_HTTP_ERROR_COUNT&&this.removeSession(a))},sessionHttpOK:function(a){this._sessionBuffer[a]&&(this._sessionBuffer[a].httpError=
0)},removeAllSessions:function(){for(var a in this._sessionBuffer)this._sessionBuffer.hasOwnProperty(a)&&this._sessionBuffer[a]&&this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);this._sessionBuffer={};this._statesBuffer={}},_createSessionTimeout:function(a){return setInterval(function(){a._getStates()},3E3)},getStates:function(a){return this._statesBuffer[a]?this._statesBuffer[a].states:null},getStatesTimestamp:function(a){return this._statesBuffer[a]?this._statesBuffer[a].timestamp:
null},removeStates:function(a){this._statesBuffer[a]&&delete this._statesBuffer[a].states},setStates:function(a,b){this._statesBuffer[a]={states:b,timestamp:new Date}},addStates:function(a,b){this._statesBuffer[a]||(this._statesBuffer[a]={});if(this._statesBuffer[a].states){if(this._statesBuffer[a].timestamp=new Date,b)for(var c in b)b.hasOwnProperty(c)&&(this._statesBuffer[a].states[c]=b[c])}else this._statesBuffer[a]={states:b,timestamp:new Date}},finalize:function(a){var b=[],c;for(c in this._sessionBuffer)if(this._sessionBuffer.hasOwnProperty(c)){var d=
this._sessionBuffer[c];d&&d.engine&&b.push(d.engine)}if(0==b.length)a&&a();else{var e=0;for(c=0;c<b.length;c++)b[c].signoff(function(){e++;e==b.length&&a&&a()})}}};xnm.aio.contronics.Handler=function(){};xnm.aio.contronics.Handler.prototype.ExecEngine=xnm.aio.contronics.ExecEngine;xnm.aio.contronics.Handler.prototype.devicemanager=xnm.aio.contronics.DM;xnm.aio.contronics.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"contronics")};
xnm.aio.contronics.Handler.prototype.resolveGateway=function(a){return a.ip?new xnm.aio.contronics.ExecEngine(a.ip,a.port,a.username,a.password):null};xnm.aio.contronics.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.contronics.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};xnm.aio.contronics.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.contronics.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};
xnm.aio.contronics.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};xnm.aio.contronics.Handler.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(f,g){f?e&&e(f):e&&e(null,g[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.contronics.Handler.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);c?c.getDeviceList(function(d,e){c.signoff(function(){b&&b(d,e)})}):b&&b(Error("gateway json format invalid"))};xnm.aio.contronics.Handler.prototype.finalize=function(a){var b=a;setTimeout(function(){b&&(b(),b=null)},3E3);xnm.aio.contronics.SessionBuffer.finalize(function(){b&&(b(),b=null)})};xnm.aio.contronics.Handler.prototype.pause=function(a){this.finalize(a)};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.contronics.Handler);
