var m=m||{};m.aio=m.aio||{};m.aio.backupmanager=m.aio.backupmanager||{};
m.aio.backupmanager.BackupManager=function(){var p=function(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager");this._restoreListener=this._fm=null};p.prototype.BACKUP_DIR="backups";p.prototype.init=function(a,b,c){this._fm=a;this._restoreListener=b;c&&c()};p.prototype.getBackups=function(a){var b=require("fs-extra"),c=require("path"),k=require("async"),e=this._getBackupDir(),l=[];b.ensureDir(e,function(f){f?a&&a(f):b.readdir(e,function(r,q){r?a&&a(r):k.eachLimit(q,
10,function(g,t){var n=c.extname(g),d=c.basename(g);d=d.substr(0,d.length-n.length).toLowerCase();if(n&&".zip"==n.toLowerCase()&&d&&!(6>=d.length)&&"backup"==d.substr(0,6)&&(n=d.indexOf("_"),-1!=n&&n!=d.length-1)){var h=d.substr(n+1);h.match(/^\d+$/)&&(h=parseInt(h,10),l.push({file:g,name:d.substr(0,n),time:h}))}t()}.bind(this),function(g){a&&a(g,l)})})})};p.prototype.restoreBackup=function(a,b){var c=require("fs-extra"),k=require("path"),e=this._getBackupDir(),l=this._fm.getUserRootDataPath(),f=
this,r=k.join(e,a);e=k.basename(a);a=k.extname(a);var q=e.substr(0,e.length-a.length);c.stat(r,function(g){g?(f._logger.log("warn","restore backup 1 error:"+g.message),b&&b(g)):f._unzip(r,q,function(t,n){if(t)f._logger.log("warn","restore backup 2 error:"+t.message),b&&b(t);else{var d=f._getBackupContentDirs();f._deleteCurrentFolders(d,function(h){if(h)f._logger.log("warn","restore backup 3 error:"+h.message),b&&b(h);else try{for(h=0;h<d.length;h++)c.copySync(k.join(n,d[h]),k.join(l,d[h]));f._restoreListener?
f._restoreListener(function(v){v?(f._logger.log("warn","restore backup 5 error:"+v.message),b&&b(v)):c.remove(n,function(){b&&b()})}):c.remove(n,function(){b&&b()})}catch(v){f._logger.log("warn","restore backup 4 error:"+v.message),b&&b(v)}})}})})};p.prototype.createBackup=function(a){var b=require("fs-extra"),c=require("path"),k=this._getBackupDir(),e=this;e._logger.log("debug","Backup dir: "+k);b.ensureDir(k,function(l){l?(e._logger.log("warn","create backup 1 error:"+l.message),a&&a(l)):b.readdir(k,
function(f,r){if(f)e._logger.log("warn","create backup 2 error:"+f.message),a&&a(f);else{f=e._findBackupPrefix(r);var q=e._getBackupContentDirs(),g=e._fm.getUserRootDataPath(),t=f+"_"+Math.round((new Date).getTime()/1E3)+".zip";e._logger.log("debug","ZIP file to create: "+t);var n=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(n,function(d){e._logger.log("debug","Checked CPU for features: "+n.join(", ")+". Result: "+d);if(d){var h=require("archiver");d=b.createWriteStream(c.join(k,t));h=h("zip");d.on("error",
function(u){e._logger.log("warn","create backup 3 error:"+u.message);a&&(a(u),a=null)});d.on("close",function(){a&&(a(),a=null)});h.on("error",function(u){e._logger.log("warn","create backup 4 error:"+u.message);a&&(a(u),a=null)});h.pipe(d);for(d=0;d<q.length;d++)e._logger.log("debug","Adding directory: "+q[d]),h.directory(c.join(g,q[d]),q[d]);e._logger.log("debug","Calling ZIP finalize.");h.finalize()}else{var v=new (require("jszip")),y=Date.now(),B=function(u){v.folder(u);for(var A=b.readdirSync(c.join(g,
u),{withFileTypes:!0}),z=0;z<A.length;z++){var w=A[z];if(w.isFile()){var x=w.name.toLowerCase();".ds_store"!==x&&"thumbs.db"!==x&&(x=c.join(g,u,w.name),x=b.readFileSync(x),w=w.name,u&&(w=u+"/"+w),v.file(w,x))}else w.isDirectory()&&B(u+"/"+w.name)}};for(d=0;d<q.length;d++)B(q[d]);e._logger.log("debug","Listed all folders and files in "+(Date.now()-y)+" ms.");y=Date.now();v.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(b.createWriteStream(c.join(k,
t))).on("finish",function(){e._logger.log("debug","Backup ZIP has been created: "+t);e._logger.log("debug","Creating the ZIP took "+(Date.now()-y)+" ms.");a&&(a(),a=null)})}})}})})};p.prototype.deleteBackup=function(a,b){var c=require("fs-extra"),k=require("path"),e=this._getBackupDir();c.ensureDir(e,function(l){l?b&&b(l):c.remove(k.join(e,a),function(f){b&&b(f)})})};p.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR)};p.prototype._getBackupContentDirs=
function(){return["tenants","resources"]};p.prototype._findBackupPrefix=function(a){for(var b=0,c="backup"+b;this._hasBackupWithPrefix(c,a);)b++,c="backup"+b;return c};p.prototype._hasBackupWithPrefix=function(a,b){for(var c=0;c<b.length;c++)if(b[c]&&b[c].substr(0,a.length)==a)return!0;return!1};p.prototype._unzip=function(a,b,c){var k=this._fm.getTmpDir(),e=require("path"),l=require("fs-extra"),f=e.join(k,b);try{l.existsSync(f)&&l.removeSync(f),l.ensureDirSync(f)}catch(g){c&&c(g);return}var r=this,
q=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(q,function(g){r._logger.log("debug","Checked CPU for features: "+q.join(", ")+". Result: "+g);if(g){r._logger.log("debug","Unzipping backup file with ADM-ZIP.");g=Date.now();var t=new (require("adm-zip"))(a);try{t.extractAllTo(f,!0),r._logger.log("debug","Finished unzipping after "+(Date.now()-g)+" ms."),c&&c(null,f)}catch(n){c&&c(n)}}else XC.unzip(a,f,r._logger,c)})};p.prototype._deleteCurrentFolders=function(a,b){var c=require("fs-extra"),k=require("path"),
e=this._fm.getUserRootDataPath();try{for(var l=0;l<a.length;l++)c.removeSync(k.join(e,a[l]));b()}catch(f){b(f)}};return p}();m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler);
