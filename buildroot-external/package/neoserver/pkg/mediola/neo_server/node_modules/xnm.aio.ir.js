var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ir=xnm.aio.ir||{};
xnm.aio.ir.RedEye=function(){var d=function(a,c,b){var e=require("x.logger.js");this._logger=e?e.getLogger("RedEye"):{log:function(){}};this._host=a;this._serial=b;this._port=c;if(!this._port||0>this._port)this._port=80};d.SEND_PATH="/cgi-bin/play_iph.sh?/devicedata/";d.LEARN_PATH="/cgi-bin/RedEyeApp?debug=1";d.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value)if(a&&a.ircodes&&a.ircodes.codes){for(var e,f=0;f<a.ircodes.codes.length;f++){var g=a.ircodes.codes[f];if(g.key==c.value){e=g.code;
break}}e?this.executeCommand(a,e,function(h){b&&b(h)}):b&&b(Error("no such ir code:"+c.value))}else b&&b(Error("device has no ir codes"));else b&&b(Error("command invalid"))};d.prototype.executeCommand=function(a,c,b){c?this._doGetRequest(this._host,this._port,d.SEND_PATH+c,function(e){b&&b(e)}):b&&b(Error("command invalid"))};d.prototype.learnIrCode=function(a){this._doPostRequest(this._host,82,d.LEARN_PATH,'<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>id</key><integer>-1</integer><key>serialNumber</key><string>'+
this._serial+"</string><key>clientType</key><integer>99999</integer><key>softwareVersion</key><string>2.6.0</string><key>type</key><integer>26</integer><key>isInitialRequest</key><string>no</string><key>hostName</key><string></string><key>cookie</key><integer>-1</integer><key>actions</key></dict></plist>",function(c,b){c?a&&a(c):b&&-1!=b.indexOf("/devicedata/")?(c=b.indexOf("/devicedata/"),b=b.substr(c+12),c=b.indexOf("<"),-1==c?a&&a(Error("learn ir code response error")):(b=b.substr(0,c),a&&a(null,
b))):a&&a(Error("learn ir code response error"))})};d.prototype._doGetRequest=function(a,c,b,e){var f=e;a={host:a,port:c,path:b,method:"GET"};var g=this,h="";a=require("http").request(a,function(k){200==k.statusCode?(k.setEncoding("utf8"),k.on("data",function(l){h+=l}),k.on("end",function(){f&&f(null,h);f=null})):(g._logger.log("warn","Failed to do get request to "+g.ip+" with status code:"+k.statusCode),f&&f(Error("post request failed with status code:"+k.statusCode)),f=null)});if(a.on&&"function"==
typeof a.on)a.on("error",function(k){f&&f(k);f=null});a.end()};d.prototype._doPostRequest=function(a,c,b,e,f){var g=f;a={host:a,port:c,path:b,method:"POST",headers:{"Content-Type":'text/xml; charset="UTF-8"',"Content-Length":e.length,"User-Agent":"mediola",Connection:"close"}};var h=this,k="";a=require("http").request(a,function(l){200==l.statusCode?(l.setEncoding("utf8"),l.on("data",function(m){k+=m}),l.on("end",function(){g&&g(null,k);g=null})):(h._logger.log("warn","Failed to do get request to "+
h.ip+" with status code:"+l.statusCode),g&&g(Error("post request failed with status code:"+l.statusCode)),g=null)});if(a.on&&"function"==typeof a.on)a.on("error",function(l){g&&g(l);g=null});a.write(e);a.end()};d.prototype.toJSON=function(){return{sys:xnm.aio.ir.RedEye.DM.SYS,ip:this._host,port:this._port,serial:this._serial}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this._host==a._host:!1};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port,a.serial):null};d.discoveryWithTimeout=
function(a,c){var b=require("x.mdns.js");b.clearRecordBuffer();b.discoverServiceWithTimeout("_tf_redeye._tcp.local",a,function(e,f){if(e)c&&c(e);else{for(var g=[],h=0;h<f.length;h++){var k=f[h];if(k.target&&k.ip&&0<k.ip.length){var l=k.target.replace("RedEye_","");l=l.replace(".local","");k=new d(k.ip[0],80,l);g.push(k)}}c&&c(e,g)}})};return d}();
xnm.aio.ir.RedEye.DM=function(){return{SYS:"redeye",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"RedEye"}},createGateway:function(d,a,c){a=xnm.aio.ir.DMError;var b=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?c(null,d):c(new a(b.INVALID,"ip is invalid")):c(new a(b.INVALID,"info is invalid"))},updateGateway:function(d,a,c,b){d=xnm.aio.ir.DMError;c=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?b(null,a):b(new d(c.INVALID,"ip is invalid")):b(new d(c.INVALID,
"update is invalid"))},deleteGateway:function(d,a,c){c()},createDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else c(new b(e.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.INVALID,"gateway is invalid"));else c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,c){c()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var c=0;c<d.ircodes.codes.length;c++){var b=
d.ircodes.codes[c];a.command.push({type:"enum",name:b.key,ref:{value:b.key}})}return a}return null}}}();
xnm.aio.ir.IRTrans=function(){var d=function(a,c){var b=require("x.logger.js");this._logger=b?b.getLogger("IRTrans"):{log:function(){}};this._ip=a;this._port=c;this._port||(this._port=21E3);this._idleTimer=this._socket=null;this._commandTasks=[]};d.SO_TIMEOUT=2E3;d.IDLE_TIMEOUT=6E4;d.CONNECTION_PREAMBLE="ASCI\n";d.prototype.executeCommandCreator=function(a,c,b,e){if(c&&c.value)if(a&&a.ircodes&&a.ircodes.codes){for(var f,g=0;g<a.ircodes.codes.length;g++){var h=a.ircodes.codes[g];if(h.key==c.value){f=
h.code;break}}f?this.executeCommand(a,f,function(){b&&b()},e):b&&b(Error("no such ir code:"+c.value))}else b&&b(Error("device has no ir codes"));else b&&b(Error("command invalid"))};d.prototype.executeCommand=function(a,c,b,e){var f="Asndhex ";switch(a.address){case "LD":case "LI":case "LE":case "LB":case "L1":case "L2":case "L3":case "L4":case "L5":case "L6":case "L7":case "L8":f+=a.address+" "}f+="H"+c+"\n";var g=this;this._createSocket(function(h){h?b&&b(h):g._addTask("command",f,e,b)})};d.prototype.learnIrCode=
function(a,c){var b="Alearn M"+(a&a.mode?a.mode:0)+" I"+(a&a.timeout?a.timeout:0)+" R"+(a&a.receiver?a.receiver:"I1")+" W10\n",e=this;this._createSocket(function(f){f?c&&c(f):e._addTask("learn",b,!0,c)})};d.prototype.toJSON=function(){return{sys:xnm.aio.ir.IRTrans.DM.SYS,ip:this._ip,port:this._port}};d.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.ir.IRTrans?this._ip==a._ip&&this._port==a._port:!1};d.prototype._createSocket=function(a){if(this._socket)a();else{var c=this,b={port:this._port,
host:this._ip},e=require("net").connect(b);e.setTimeout(d.SO_TIMEOUT);e.setEncoding("utf8");e.on("connect",function(){c._logger.log("trace","connect to irtrans:"+c._ip);e.write(d.CONNECTION_PREAMBLE);c._socket=e;a()});e.on("data",function(f){c._logger.log("trace","receive from irtrans:"+c._ip+" data:"+f);c._onSocketData(f)});e.on("error",function(f){c._socket?(c._logger.log("trace","irtrans:"+c._ip+" error:"+f.message),c._onSocketError(f)):(c._logger.log("trace","irtrans:"+c._ip+" connection error:"+
f.message),a(f))});e.on("timeout",function(){c._socket?(c._logger.log("trace","irtrans:"+c._ip+" data timeout"),c._onSocketTimeout()):(c._logger.log("trace","irtrans:"+c._ip+" connection timeout"),e.destroy(),a(Error("timeout")))});e.on("close",function(){c._logger.log("trace","irtrans:"+c._ip+" close socket");c._onSocketClose()});e._doConnect&&"function"==typeof e._doConnect&&e._doConnect()}};d.prototype._closeSocket=function(){this._socket&&this._socket.end();this._clean()};d.prototype._clean=function(){this._idleTimer&&
(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._commandTasks)for(var a=0;a<this._commandTasks.length;a++){var c=this._commandTasks[a];c&&c.callback&&c.callback(Error("socket closed"))}this._commandTasks=[]};d.prototype._onSocketError=function(a){this._closeSocket()};d.prototype._onSocketTimeout=function(){4<this._commandTasks.length&&this._closeSocket()};d.prototype._onSocketClose=function(){this._clean()};d.prototype._onSocketData=function(a){a=a.split(" ");var c=
2<a.length&&"LEARN"==a[1],b;c&&(b=a[2].replace(/\r?\n|\r/g,""));var e=!1;if(0<this._commandTasks.length){var f=this._commandTasks[0];e=f.closeSocket;this._commandTasks.splice(0,1);if("learn"==f.type&&0==a[2].indexOf("Error")){a=a.slice(2);var g=Error(a.join(" ").replace(/\r?\n|\r/g,""))}f.callback&&f.callback(g,c?b:null)}e&&0==this._commandTasks.length&&this._closeSocket()};d.prototype._addTask=function(a,c,b,e){this._logger.log("trace","add task to buffer");this._commandTasks.push({type:a,data:c,
callback:e,closeSocket:b});var f=this;this._idleTimer&&clearTimeout(this._idleTimer);this._idleTimer=setTimeout(function(){f._closeSocket()},d.IDLE_TIMEOUT);this._doRequest(c)};d.prototype._doRequest=function(a){this._logger.log("trace","send data to irtrans:"+this._ip+" data:"+a);this._socket&&this._socket.write(a)};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port):null};d._discovery=function(a,c){var b=function(g,h,k){g=g.toString("hex");2<g.length&&0==g.toLowerCase().indexOf("e7")&&(h=new xnm.aio.ir.IRTrans(h.address),
k.push(h))},e=function(g,h,k,l){var m=l,n=require("dgram").createSocket({type:"udp4",reuseAddr:!0});n.on("listening",function(){n.setBroadcast(!0);m&&(m(null,n),m=null)});n.on("message",function(r,p){b(r,p,k)});n.on("error",function(r){m&&(m(r),m=null)});n.bind(g,h);return n},f=function(g){var h=new Buffer([200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,214,2,39,11,100,179,139]);g.send(h,0,h.length,21E3,"255.255.255.255")};
(function(g){var h=g,k=[],l=[],m=require("os"),n=require("dgram");if(m&&m.networkInterfaces){var r=n.createSocket({type:"udp4",reuseAddr:!0});r.on("listening",function(){r.setBroadcast(!0);var p=m.networkInterfaces(),q=[],t;for(t in p)for(var u=p[t],v=0;v<u.length;v++)"IPv4"==u[v].family&&0==u[v].internal&&q.push(u[v].address);var w=0;for(p=0;p<q.length;p++)e(21E3,q[p],k,function(y,x){!y&&x&&l.push(x);w++;w==q.length&&h&&(h(null,l,k),h=null)})});r.on("message",function(p,q){b(p,q,k)});r.on("error",
function(p){r.close();h&&(h(p),h=null)});r.bind(21E3);r._isListenerSocket=!0;l.push(r)}else e(21E3,null,k,function(p,q){p?g&&g(p):(q&&l.push(q),g&&g(null,l,k))})})(function(g,h,k){if(!g&&h){for(g=0;g<h.length;g++){var l=h[g];l._isListenerSocket||f(l)}setTimeout(function(){if(h)for(var m=0;m<h.length;m++)h[m].close();c&&c(null,k)},a)}})};return d}();
xnm.aio.ir.IRTrans.DM=function(){return{SYS:"irtrans",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"IRTrans"}},createGateway:function(d,a,c){a=xnm.aio.ir.DMError;var b=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?c(null,d):c(new a(b.INVALID,"ip is invalid")):c(new a(b.INVALID,"info is invalid"))},updateGateway:function(d,a,c,b){d=xnm.aio.ir.DMError;c=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?b(null,a):b(new d(c.INVALID,"ip is invalid")):b(new d(c.INVALID,
"update is invalid"))},deleteGateway:function(d,a,c){c()},createDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else c(new b(e.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.INVALID,"gateway is invalid"));else c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,c){c()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var c=0;c<d.ircodes.codes.length;c++){var b=
d.ircodes.codes[c];a.command.push({type:"enum",name:b.key,ref:{value:b.key}})}return a}return null}}}();
xnm.aio.ir.iTach=function(){var d=function(b,e,f){this.type="learnIR";this.itach=b;this.closeSocket=e;this.callback=f;this.timer=null;this._step=0;this._data=""};d.prototype.run=function(){var b=this;this.itach._createSocket(function(e){e?(b.itach._delTask(b),b.callback&&b.callback(e),b._taskFinish()):(b.itach._doRequest("get_IRL\r"),b._step=1,b.timer=setTimeout(function(){b.itach._doRequest("stop_IRL\r");b.callback&&b.callback(Error("learn ir code timeout"));b.itach._delTask(b);b._taskFinish()},
2E4))})};d.prototype.onData=function(b){this._data+=b;-1!=this._data.indexOf("\r")&&(1==this._step?"IR Learner Enabled"==this._data.trim()?(this._data="",this._step=2):(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):2==this._step&&(0==this._data.indexOf("sendir")?(b=this._data.split(","),b.splice(0,2),b=b.join().trim(),this._step=3,this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(null,
b),this._taskFinish()):this._data=""))};d.prototype.onTimeout=function(){switch(this._step){case 1:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error("learn ir code req timeout")),this._taskFinish()}};d.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var a=function(b,e,f){this.type="sendIR";this.itach=b;this.closeSocket=e.closeSocket;this.address=
e.address?e.address:"1:1";this.code=e.code;this.callback=f;this._step=0;this._data=""};a.prototype.run=function(){var b=this;this.itach._createSocket(function(e){e?(b.itach._delTask(b),b.callback&&b.callback(e),b._taskFinish()):(b.itach._doRequest("set_IR,"+b.address+",IR\r"),b._step=1)})};a.prototype.onData=function(b){this._data+=b;if(-1!=this._data.indexOf("\r"))if(1==this._step)-1!=this._data.trim().indexOf("ERR")?(this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):
(this._data="",this._step=2,this.itach._doRequest("sendir,"+this.address+","+this.code+"\r"));else if(2==this._step){if(-1!=this._data.trim().indexOf("ERR")||-1!=this._data.trim().indexOf("busyIR"))var e=Error(this._data);this.itach._delTask(this);this.callback&&this.callback(e);this._taskFinish()}};a.prototype.onTimeout=function(){switch(this._step){case 1:case 2:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback("send ir code timeout"),this._taskFinish()}};
a.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var c=function(b,e,f){var g=require("x.logger.js");this.ip=b;this.port=e?e:4998;this.uuid=f;this.model=null;this._logger=g?g.getLogger("xnm.aio.ir.iTach"):{log:function(){}};this._idleTimer=this._socket=null;this._taskBuffer=[]};c.prototype.toJSON=function(){return{sys:xnm.aio.ir.iTach.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid?this.uuid:
"",model:this.model?this.model:""}};c.prototype.equalsTo=function(b){return b&&b instanceof c?this.ip==b.ip&&this.port==b.port:!1};c.prototype.executeCommandCreator=function(b,e,f,g){if(e&&e.value)if(b&&b.ircodes&&b.ircodes.codes){for(var h,k=0;k<b.ircodes.codes.length;k++){var l=b.ircodes.codes[k];if(l.key==e.value){h=l.code;break}}h?this.executeCommand(b.address,h,g,function(){f&&f()}):f&&f(Error("no such ir code:"+e.value))}else f&&f(Error("device has no ir codes"));else f&&f(Error("command invalid"))};
c.prototype.executeCommand=function(b,e,f,g){b=new a(this,{address:b,code:e,closeSocket:f},g);this._addTask(b)};c.prototype.learnIrCode=function(b,e){e&&(b=new d(this,b,e),this._addTask(b))};c.SO_TIMEOUT=2E3;c.IDLE_TIMEOUT=6E4;c.prototype._createSocket=function(b){if(this._socket)b();else{var e=this,f={port:this.port,host:this.ip},g=require("net").connect(f);g.setTimeout(c.SO_TIMEOUT);g.setEncoding("utf8");g.on("connect",function(){e._logger.log("trace","connect to itach:"+e.ip);e._socket=g;b()});
g.on("data",function(h){e._logger.log("trace","receive from itach:"+e.ip+" data:"+h);e._onSocketData(h)});g.on("error",function(h){e._socket?(e._logger.log("trace","itach:"+e.ip+" error:"+h.message),e._onSocketError(h)):(e._logger.log("trace","itach:"+e.ip+" connection error:"+h.message),b(h))});g.on("timeout",function(){e._socket?(e._logger.log("trace","itach:"+e.ip+" data timeout"),e._onSocketTimeout()):(e._logger.log("trace","itach:"+e.ip+" connection timeout"),g.destroy(),b(Error("timeout")))});
g.on("close",function(){e._logger.log("trace","itach:"+e.ip+" close socket");e._onSocketClose()});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()}};c.prototype._closeSocket=function(){this._logger.log("trace","to close itach socket");this._socket&&this._socket.end();this._clean()};c.prototype._clean=function(){this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._taskBuffer)for(var b=0;b<this._taskBuffer.length;b++){var e=this._taskBuffer[b];
e&&e.callback&&e.callback(Error("socket closed"))}this._taskBuffer=[]};c.prototype._onSocketError=function(b){this._closeSocket()};c.prototype._onSocketTimeout=function(){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onTimeout()};c.prototype._onSocketClose=function(){this._clean()};c.prototype._onSocketData=function(b){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onData(b)};c.prototype._addTask=function(b){this._logger.log("trace","add task to buffer");this._idleTimer&&
clearTimeout(this._idleTimer);var e=this;this._idleTimer=setTimeout(function(){e._logger.log("trace","idle timer triggered");e._closeSocket()},c.IDLE_TIMEOUT);var f=this._taskBuffer.length;this._taskBuffer.push(b);0==f&&this._doNextTask()};c.prototype._delTask=function(b){this._logger.log("trace","delete task from buffer");for(var e=-1,f=0;f<this._taskBuffer.length;f++)if(this._taskBuffer[f]===b){e=f;break}-1!=e&&this._taskBuffer.splice(e,1)};c.prototype._doNextTask=function(){this._taskBuffer&&0<
this._taskBuffer.length&&this._taskBuffer[0].run()};c.prototype._doRequest=function(b){this._logger.log("trace","send data to itach:"+this.ip+" data:"+b);this._socket&&this._socket.write(b)};c.parseJSON=function(b){if(!b||!b.ip)return null;var e=new c(b.ip,b.port,b.uuid);e.model=b.model;return e};c.discovery=function(b){if(b&&(this._discoverCallbacks||(this._discoverCallbacks=[]),this._addDiscoverCallback(b),!this._discoverRunning)){this._discoverRunning=!0;var e=this;this._startDiscovery(function(f){if(f){for(var g=
0;g<e._discoverCallbacks.length;g++)e._discoverCallbacks[g](f);e._discoverCallbacks=[];e._discoverRunning=!1}else setTimeout(function(){e._stopDiscovery(function(){var h=[],k;for(k in e._discoverResults)e._discoverResults.hasOwnProperty(k)&&h.push(e._discoverResults[k]);for(k=0;k<e._discoverCallbacks.length;k++)e._discoverCallbacks[k](null,h);e._discoverCallbacks=[]})},1E4)})}};c._addDiscoverCallback=function(b){for(var e=!1,f=0;f<this._discoverCallbacks.length;f++)if(this._discoverCallbacks[f]===
b){e=!0;break}e||this._discoverCallbacks.push(b)};c._removeDiscoverCallback=function(b){for(var e=-1,f=0;f<this._discoverCallbacks.length;f++)if(this._discoverCallbacks[f]===b){e=f;break}-1!=e&&this._discoverCallbacks.splice(e,1)};c._startDiscovery=function(b){var e=require("x.logger.js");this._logger||(this._logger=e?e.getLogger("xnm.aio.ir.iTach"):{log:function(){}});this._discoverResults={};var f=this;(function(g,h){var k=h,l=[],m=require("os");h=require("dgram");if(m&&m.networkInterfaces){m=m.networkInterfaces();
for(var n in m)if(m.hasOwnProperty(n))for(var r=m[n],p=0;p<r.length;p++)"IPv4"==r[p].family&&0==r[p].internal&&l.push(r[p].address)}var q=h.createSocket("udp4");q.on("listening",function(){q.setBroadcast(!0);if(0<l.length)for(var t=0;t<l.length;t++)q.addMembership("239.255.250.250",l[t]);else q.addMembership("239.255.250.250");k&&(k(null,q),k=null)});q.on("message",function(t,u){g(t,u)});q.on("error",function(t){q.close();k&&(k(t),k=null)});q.bind(9131)})(function(g,h){g=g.toString();if(0==g.indexOf("AMXB")){0==
g.indexOf("AMXB")&&(g=g.substr(4));var k=g.split(/<-/g);g={};for(var l=0;l<k.length;l++){var m=k[l].trim();m=m.substr(0,m.length-1);m=m.split("=");2<=m.length&&m[0]&&(g[m[0]]=m[1])}f._logger.log("trace","find iTach:"+JSON.stringify(g));g.UUID&&!f._discoverResults[g.UUID]&&(h=new c(h.address,4998,g.UUID),h.model=g.Model,f._discoverResults[g.UUID]=h)}},function(g,h){g?b&&b(g):(f._discoverSocket=h,b&&b())})};c._stopDiscovery=function(b){this._discoverSocket||b&&b();this._discoverSocket.close();this._discoverSocket=
null;this._discoverRunning=!1;b&&b()};return c}();
xnm.aio.ir.iTach.DM=function(){return{SYS:"itach",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"Global Cach\u00e9 iTach (IR)"}},createGateway:function(d,a,c){a=xnm.aio.ir.DMError;var b=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?c(null,d):c(new a(b.INVALID,"ip is invalid")):c(new a(b.INVALID,"info is invalid"))},updateGateway:function(d,a,c,b){d=xnm.aio.ir.DMError;c=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?b(null,a):b(new d(c.INVALID,"ip is invalid")):
b(new d(c.INVALID,"update is invalid"))},deleteGateway:function(d,a,c){c()},createDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else c(new b(e.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?c(null,d):c(new b(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new b(e.INVALID,"gateway is invalid"));else c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,c){c()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var c=0;c<d.ircodes.codes.length;c++){var b=
d.ircodes.codes[c];a.command.push({type:"enum",name:b.key,ref:{value:b.key}})}return a}return null}}}();xnm.aio.ir.DMError=function(){var d=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="IrDmError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return d}();
xnm.aio.ir.DM=function(){return{getGatewayType:function(d){var a=[],c;for(c in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(c)){var b=xnm.aio.ir[c];b&&b.DM&&b.DM.getGatewayType&&(b=b.DM.getGatewayType(d))&&a.push(b)}return a},_getSystem:function(d){for(var a in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(a)){var c=xnm.aio.ir[a];if(c&&c.DM&&c.DM.SYS&&c.DM.SYS==d)return c}return null},createGateway:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);
f&&f.DM&&f.DM.createGateway?f.DM.createGateway(d,a,c):c&&c(new b(e.INVALID,"no such sys:"+d.sys))}else c&&c(new b(e.INVALID,"sys is invalid"));else c&&c(new b(e.INVALID,"info is invalid"))},updateGateway:function(d,a,c,b){var e=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(a)if(a.sys){var g=this._getSystem(a.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(d,a,c,b):b&&b(new e(f.INVALID,"no such sys:"+a.sys))}else b&&b(new e(f.INVALID,"sys is invalid"));else b&&b(new e(f.INVALID,"update is invalid"))},
deleteGateway:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.deleteGateway?f.DM.deleteGateway(d,a,c):c&&c(new b(e.INVALID,"no such sys:"+d.sys))}else c&&c(new b(e.INVALID,"sys is invalid"));else c&&c()},createDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.createDevice?f.DM.createDevice(d,a,c):c&&c(new b(e.INVALID,"no such sys:"+
d.sys))}else c&&c(new b(e.INVALID,"sys is invalid"));else c&&c(new b(e.INVALID,"info is invalid"))},updateDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.updateDevice?f.DM.updateDevice(d,a,c):c&&c(new b(e.INVALID,"no such sys:"+d.sys))}else c&&c(new b(e.INVALID,"sys is invalid"));else c&&c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,c){var b=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;
if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.deleteDevice?f.DM.deleteDevice(d,a,c):c&&c(new b(e.INVALID,"no such sys:"+d.sys))}else c&&c(new b(e.INVALID,"sys is invalid"));else c&&c()},applyUIFilter:function(d,a){var c=function(h,k){if("*"==h)return!0;for(var l=!1,m=0;m<h.length;m++)if(h[m]==k){l=!0;break}return l},b=function(h,k,l){var m=[];switch(l.catagory){case "command":h.command&&h.command.forEach(function(n){c(l.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),m.push(n))});break;
case "status":h.status&&h.status.forEach(function(n){c(l.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),m.push(n))})}return m},e=function(h,k){var l=[],m;if(h.sys){var n=this._getSystem(h.sys);n&&n.DM&&n.DM.getCommandStatusMap&&(m=n.DM.getCommandStatusMap(h))}m&&(h=b(m,h,k),l=l.concat(h));return l};if(!d.sys)return null;var f=JSON.parse(JSON.stringify(d)),g=null;switch(a.catagory){case "command":g=e.call(this,d,a);f.command=g;break;case "status":g=e.call(this,d,a);f.status=g;break;default:return null}return g&&
0!=g.length?f:null}}}();
xnm.aio.ir.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.ir.DM;d.prototype.registModule=function(a){for(var c in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(c)){var b=xnm.aio.ir[c];b&&b.DM&&b.DM.registModule&&b.DM.registModule(a)}};d.prototype.resolveGateway=function(a){switch(a.sys){case xnm.aio.ir.IRTrans.DM.SYS:return xnm.aio.ir.IRTrans.parseJSON(a);case xnm.aio.ir.RedEye.DM.SYS:return xnm.aio.ir.RedEye.parseJSON(a);case xnm.aio.ir.iTach.DM.SYS:return xnm.aio.ir.iTach.parseJSON(a);default:return null}};
d.prototype.getDeviceCommands=function(a,c){a=(a=xnm.aio.ir.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];c&&c(null,a)};d.prototype.searchIRTransWithTimeout=function(a,c){xnm.aio.ir.IRTrans._discovery(a,c)};d.prototype.learnIRTransCode=function(a,c,b){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.learnIrCode(c,b):b&&b(Error("gateway json format invalid"))};d.prototype.doIRTransCommand=function(a,c,b,e){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.executeCommandCreator(c,b,e,!0):e&&e(Error("gateway json format invalid"))};
d.prototype.searchRedeyeWithTimeout=function(a,c){xnm.aio.ir.RedEye.discoveryWithTimeout(a,c)};d.prototype.learnRedeyeCode=function(a,c){(a=xnm.aio.ir.RedEye.parseJSON(a))?a.learnIrCode(c):c&&c(Error("gateway json format invalid"))};d.prototype.doRedeyeCommand=function(a,c,b,e){(a=xnm.aio.ir.RedEye.parseJSON(a))?a.executeCommandCreator(c,b,e):e&&e(Error("gateway json format invalid"))};d.prototype.searchITach=function(a){xnm.aio.ir.iTach.discovery(a)};d.prototype.learnITachCode=function(a,c){(a=xnm.aio.ir.iTach.parseJSON(a))?
a.learnIrCode(!0,c):c&&c(Error("gateway json format invalid"))};d.prototype.doITachCommand=function(a,c,b,e){(a=xnm.aio.ir.iTach.parseJSON(a))?a.executeCommandCreator(c,b,e,!0):e&&e(Error("gateway json format invalid"))};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ir.Handler);
