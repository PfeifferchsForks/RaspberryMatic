var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var d=0;return function(){return d<e.length?{done:!1,value:e[d++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,d,g){if(e==Array.prototype||e==Object.prototype)return e;e[d]=g.value;return e};$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var d=0;d<e.length;++d){var g=e[d];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,d){var g=$jscomp.propertyToPolyfillSymbol[d];if(null==g)return e[d];g=e[g];return void 0!==g?g:e[d]};
$jscomp.polyfill=function(e,d,g,k){d&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,d,g,k):$jscomp.polyfillUnisolated(e,d,g,k))};$jscomp.polyfillUnisolated=function(e,d,g,k){g=$jscomp.global;e=e.split(".");for(k=0;k<e.length-1;k++){var f=e[k];if(!(f in g))return;g=g[f]}e=e[e.length-1];k=g[e];d=d(k);d!=k&&null!=d&&$jscomp.defineProperty(g,e,{configurable:!0,writable:!0,value:d})};
$jscomp.polyfillIsolated=function(e,d,g,k){var f=e.split(".");e=1===f.length;k=f[0];k=!e&&k in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var q=0;q<f.length-1;q++){var n=f[q];if(!(n in k))return;k=k[n]}f=f[f.length-1];g=$jscomp.IS_SYMBOL_NATIVE&&"es6"===g?k[f]:null;d=d(g);null!=d&&(e?$jscomp.defineProperty($jscomp.polyfills,f,{configurable:!0,writable:!0,value:d}):d!==g&&(void 0===$jscomp.propertyToPolyfillSymbol[f]&&(g=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[f]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(f):$jscomp.POLYFILL_PREFIX+g+"$"+f),$jscomp.defineProperty(k,$jscomp.propertyToPolyfillSymbol[f],{configurable:!0,writable:!0,value:d})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(e){if(e)return e;var d=function(q,n){this.$jscomp$symbol$id_=q;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:n})};d.prototype.toString=function(){return this.$jscomp$symbol$id_};var g="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",k=0,f=function(q){if(this instanceof f)throw new TypeError("Symbol is not a constructor");return new d(g+(q||"")+"_"+k++,q)};return f},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var d="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),g=0;g<d.length;g++){var k=$jscomp.global[d[g]];"function"===typeof k&&"function"!=typeof k.prototype[e]&&$jscomp.defineProperty(k.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return e},"es6",
"es3");$jscomp.iteratorPrototype=function(e){e={next:e};e[Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,d){e instanceof String&&(e+="");var g=0,k=!1,f={next:function(){if(!k&&g<e.length){var q=g++;return{value:d(q,e[q]),done:!1}}k=!0;return{done:!0,value:void 0}}};f[Symbol.iterator]=function(){return f};return f};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.onkyo=xnm.aio.onkyo||{};xnm.aio.onkyo.AVReceiverBuffer={getAVR:function(e,d){return e&&d?this[e+":"+d]:null},setAVR:function(e){if(!e||!e.getIp())return null;this[e.getIp()+":"+e.getPort()]=e}};
xnm.aio.onkyo.AVReceiver=function(){var e=[1,2,3,4],d=function(a,b,c,h){this._taskBuffer=a;this._avr=b;this._datapoints=c;this._callback=h};d.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,b={},c=0,h=function(l,p){if(!l||1!=l.errorCode&&2!=l.errorCode&&3!=l.errorCode){l=a._datapoints[c];var r=null,t=l.indexOf(":");0<t&&(r=l.substr(0,t),l=l.substr(t+1));t="?";"frontTone"==l?p&&(null!=p.mainzone.frontBass&&"undefined"!=typeof p.mainzone.frontBass&&
(b["mainzone:frontBass"]=p.mainzone.frontBass),null!=p.mainzone.frontTreble&&"undefined"!=typeof p.mainzone.frontTreble&&(b["mainzone:frontTreble"]=p.mainzone.frontTreble)):(p&&(r||null==p[l]||"undefined"==typeof p[l]?r&&p[r]&&null!=p[r][l]&&"undefined"!=typeof p[r][l]&&(t=p[r][l]):t=p[l]),b[a._datapoints[c]]=t);c+=1;c<a._datapoints.length?(p=a._avr._getStateQuest(a._datapoints[c]),a._avr._doStateReq(p,h)):a._taskBuffer._finishLastTask(null,b)}else a._taskBuffer._finishAllTask(l)},m=this._avr._getStateQuest(this._datapoints[c]);
m?this._avr._doStateReq(m,h):h(Error("unknow status"))};d.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var b=0;b<a.length;++b)for(var c=b+1;c<a.length;++c)a[b]===a[c]&&a.splice(c,1);this._datapoints=a}else this._datapoints=a._datapoints};var g=function(a,b,c,h){this._taskBuffer=a;this._avr=b;this._commandTxt=c;this._callback=h};g.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=
this,b=this._commandTxt,c=null,h=b.indexOf(":");0<h&&(c=b.substr(0,h),b=b.substr(h+1));var m=null;"toggle"==b?(m=this._avr._getStateQuest(c+":power"),this._avr._doStateReq(m,function(l,p){l?1==l.errorCode||2==l.errorCode||3==l.errorCode?a._taskBuffer._finishAllTask(l):a._taskBuffer._finishLastTask(l):(l="on",p&&p[c]&&"on"==p[c].power&&(l="off"),m=a._avr._getCommandQuest(c+":"+l),a._avr._doCommandReq(m,function(r){!r||1!=r.errorCode&&2!=r.errorCode&&3!=r.errorCode?a._taskBuffer._finishLastTask(r):
a._taskBuffer._finishAllTask(r)}))})):(m=this._avr._getCommandQuest(this._commandTxt),this._avr._doCommandReq(m,function(l){!l||1!=l.errorCode&&2!=l.errorCode&&3!=l.errorCode?a._taskBuffer._finishLastTask(l):a._taskBuffer._finishAllTask(l)}))};var k=function(a){this._avr=a;this._buffer=[]};k.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else if(a instanceof g)1<this._buffer.length&&this._buffer[this._buffer.length-1]&&this._buffer[this._buffer.length-
1]instanceof d?this._buffer.splice(this._buffer.length-1,0,a):this._buffer.push(a);else{if(a instanceof d){var b=[];if(1<this._buffer.length){for(var c=1;c<this._buffer.length;c++)this._buffer[c]&&this._buffer[c]instanceof d&&(b.push(c),a.merge(this._buffer[c]));for(c=0;c<b.length;c++)this._buffer.splice(b[c],1)}}this._buffer.push(a)}};k.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};k.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var c=this._buffer[0];
c&&c._callback&&(c._callback(a,b),c._callback=null);this._buffer.splice(0,1)}this._doNextTask()};k.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=[];for(var c=0;c<b.length;c++)b[c]&&b[c]._callback&&(b[c]._callback(a),b[c]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=1E3;f.prototype.PACKET_IDLE_TO=6E4;f.prototype.sendPacket=function(a,b,c){if(a){var h=this._buffer.length;this._buffer.push({packet:a,ignoreRsp:b,
callback:c});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==h&&this._sendNextPacket()}else c&&c(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._avr._sendPacket(b.packet,function(c){c?(c.errorCode=e[0],a._finishAllPacket(c)):b.ignoreRsp?a._finishLastPacket():b.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");var h=Error("packet reponse timeout");
h.errorCode=e[3];a._finishLastPacket(h)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var c=this;this._bufferEmptyTo=setTimeout(function(){c._bufferEmptyTo=null;0==c._buffer.length&&c._avr._disconnect()},this.PACKET_IDLE_TO)}else this._sendNextPacket()};
f.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var c=0;c<b.length;c++)b[c]&&(b[c].timeout&&(clearTimeout(b[c].timeout),b[c].timeout=null),b[c].callback&&(b[c].callback(a),b[c].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");12<a.length&&(a=a.slice(18,18+(a[11]-2)).toString().trim(),a=a.replace(/[\x1a]/g,""),this._avr&&this._avr._datapointBuffer&&
this._avr._datapointBuffer.updateDpt(a),0<this._buffer.length&&this._buffer[0]&&this._buffer[0].packet&&this._buffer[0].packet.substr(0,3)==a.substr(0,3)&&this._finishLastPacket(null,a))};f.prototype._onSocketTimeout=function(){};f.prototype._onSocketError=function(a){a.errorCode=e[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=e[2];this._finishAllPacket(a)};var q=function(){this._buffer={}};q.prototype.EXPIRE_TO=3E3;q.prototype.updateDpt=
function(a){if(a&&3<a.length){var b=a.substr(0,3);this._buffer[b]={status:a,timestamp:(new Date).getTime()}}};q.prototype.getDpt=function(a){if(a&&3<a.length&&(a=a.substr(0,3),this._buffer[a])){if(!this._buffer[a].timestamp)return delete this._buffer[a],null;var b=(new Date).getTime(),c=b-this._buffer[a].timestamp;return c>this.EXPIRE_TO||0>c?(this._buffer[a].timestamp=b,null):null==this._buffer[a].status||"undefined"==typeof this._buffer[a].status?(delete this._buffer[a],null):this._buffer[a].status}return null};
q.prototype.delDpt=function(a){a&&3<a.length&&(a=a.substr(0,3),"AMT"!=a?delete this._buffer[a]:this._buffer[a].timestamp=(new Date).getTime())};q.prototype.refreshDptTime=function(){var a=(new Date).getTime(),b;for(b in this._buffer)this._buffer.hasOwnProperty(b)&&(this._buffer[b].timestamp=a)};var n=function(a,b,c,h,m){this._ip=a;this._port=b;this._port||(this._port=60128);this._uuid=c;this._logger=require("x.logger.js").getLogger("xnm.aio.onkyo.AVReceiver");this._model=h;this._name=m;this._socket=
null;this._taskBuffer=new k(this);this._packetBuffer=new f(this);this._datapointBuffer=new q};n.prototype.getIp=function(){return this._ip};n.prototype.getPort=function(){return this._port};n.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"onkyo-remote3://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM",
"startApp",{scheme:"com.onkyo.jp.onkyoremote"})),c&&c();else{a="";b.path&&b.path[0]&&"global"!=b.path[0]&&(a=b.path[0]+":");var h=a+b.value;if("setTo"==b.value||"tuner"==b.value||"frontBassTo"==b.value||"frontTrebleTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command setTo ext format invalid"));return}h+=b.ext}else if("audioMode"==b.value){if(!b.ext){c&&c(Error("command audioMode ext format invalid"));return}h+=b.ext}else if("setInput"==b.value){if(!b.ext){c&&c(Error("command setInput ext format invalid"));
return}h=a+b.ext}else if("customCMD"==b.value){if(!b.ext){c&&c(Error("command customCMD ext format invalid"));return}h=a+b.ext}var m=this;this._executeCommand(h,function(l){if(l)c&&c(l);else if("on"==b.value||"off"==b.value||"toggle"==b.value)setTimeout(function(){c&&c()},4E3);else{if("mute"==b.value||"unmute"==b.value||"toggleMute"==b.value){if(b.path&&b.path[0]&&"mainzone"==b.path[0]){m._datapointBuffer&&m._datapointBuffer.refreshDptTime();setTimeout(function(){c&&c()},3E3);return}}else if("volumeUp"==
b.value||"volumeDown"==b.value){setTimeout(function(){c&&c()},100);return}c&&c(l)}})}else c&&c(Error("command json format invalid"))};n.prototype.getStatesCreator=function(a,b,c){a=function(t,w){for(var v=0;v<w.length;v++)if(w[v]===t)return!0;return!1};for(var h=[],m=[],l=0;l<b.length;l++)if(b[l]&&b[l].id&&b[l].status&&b[l].status.value){var p="";b[l].status.path&&b[l].status.path[0]&&"global"!=b[l].status.path[0]&&(p=b[l].status.path[0]+":");var r=b[l].status.value;h.push({id:b[l].id,datapoint:p+
r});if("frontBass"==r||"frontTreble"==r)r="frontTone";a(p+r,m)||m.push(p+r)}this._getStates(m,function(t,w){if(t)c&&c(t);else{t=[];for(var v=0;v<h.length;v++){var y="?",z=h[v].id,x=h[v].datapoint;w&&null!=w[x]&&"undefined"!=typeof w[x]&&(y=w[x]);t.push({id:z,status:y})}c&&c(null,t)}})};n.prototype.executeCommand=function(a,b){this._executeCommand(a,b)};n.prototype.getStates=function(a){var b=Object.keys(n.STATUS_DPT_QUEST);this._getStates(b,function(c,h){a&&a(c,h)})};n.prototype._executeCommand=function(a,
b){this._logger.log("debug","execute command: "+a);a=new g(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};n.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));a=new d(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};n.prototype._getCommandQuest=function(a){var b=a;var c=null;var h=a.indexOf(":");0<h&&(c=a.substr(0,h),a=a.substr(h+1));if("on"==a)b="zone2"==c?"ZPW01":"zone3"==c?"PW301":"PWR01";else if("off"==a)b="zone2"==c?"ZPW00":"zone3"==
c?"PW300":"PWR00";else if("mute"==a)b="zone2"==c?"ZMT01":"zone3"==c?"MT301":"AMT01";else if("unmute"==a)b="zone2"==c?"ZMT00":"zone3"==c?"MT300":"AMT00";else if("toggleMute"==a)b="zone2"==c?"ZMTTG":"zone3"==c?"MT3TG":"AMTTG";else if("volumeDown"==a)b="zone2"==c?"ZVLDOWN":"zone3"==c?"VL3DOWN":"MVLDOWN";else if("volumeUp"==a)b="zone2"==c?"ZVLUP":"zone3"==c?"VL3UP":"MVLUP";else if("BDDVD"==a||"BD/DVD"==a)b="zone2"==c?"SLZ10":"zone3"==c?"SL310":"SLI10";else if("STRMBOX"==a||"STRM BOX"==a)b="zone2"==c?
"SLZ11":"zone3"==c?"SL311":"SLI11";else if("CBLSAT"==a||"CBL/SAT"==a)b="zone2"==c?"SLZ01":"zone3"==c?"SL301":"SLI01";else if("PC"==a)b="zone2"==c?"SLZ05":"zone3"==c?"SL305":"SLI05";else if("GAME"==a)b="zone2"==c?"SLZ02":"zone3"==c?"SL302":"SLI02";else if("AUX"==a)b="zone2"==c?"SLZ03":"zone2"==c?"SL303":"SLI03";else if("CD"==a)b="zone2"==c?"SLZ23":"zone3"==c?"SL323":"SLI23";else if("TV"==a)b="zone2"==c?"SLZ12":"zone3"==c?"SL312":"SLI12";else if("FM"==a)b="zone2"==c?"SLZ24":"zone3"==c?"SL324":"SLI24";
else if("AM"==a)b="zone2"==c?"SLZ25":"zone3"==c?"SL325":"SLI25";else if("NET"==a)b="zone2"==c?"SLZ2B":"zone3"==c?"SL32B":"SLI2B";else if("BLUETOOTH"==a)b="zone2"==c?"SLZ2E":"zone3"==c?"SL32E":"SLI2E";else if("Optical"==a)b="zone2"==c?"SLZ44":"zone3"==c?"SL344":"SLI44";else if(0==a.indexOf("audioMode")){if(a=a.replace(/audioMode/g,""),"STEREO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a)"STEREO"==a&&(a="00"),b="LMD"+a}else if("play"==a)b="NTCPLAY";else if("pause"==a)b="NTCPAUSE";else if("stop"==a)b="NTCSTOP";
else if("previous"==a)b="NTCTRDN";else if("next"==a)b="NTCTRUP";else if("frontBassUp"==a)b="TFRBUP";else if("frontBassDown"==a)b="TFRBDOWN";else if("frontTrebleUp"==a)b="TFRTUP";else if("frontTrebleDown"==a)b="TFRTDOWN";else if(0==a.indexOf("frontBassTo"))0==a.indexOf("frontBassTo")&&(a=a.replace(/frontBassTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),c=!1,0>a&&(c=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),b="TFRB"+(c?"-"+a:"+"+a);else if(0==a.indexOf("frontTrebleTo"))0==a.indexOf("frontTrebleTo")&&
(a=a.replace(/frontTrebleTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),c=!1,0>a&&(c=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),b="TFRT"+(c?"-"+a:"+"+a);else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),"Up"==a?b="zone2"==c?"PRZUP":"zone3"==c?"PR3UP":"PRSUP":"Down"==a?b="zone2"==c?"PRZDOWN":"zone3"==c?"PR3DOWN":"PRSDOWN":(a=parseInt(a),0>a?a=0:40<a&&(a=40),b="zone2"==c?"PRZ"+XC.getHexVal(a,2):"zone3"==c?"PR3"+XC.getHexVal(a,2):"PRS"+XC.getHexVal(a,2));else if(0==a.indexOf("setTo")||
/^\d+$/.test(a))0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==c?(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="ZVL"+XC.getHexVal(a,2)):"zone3"==c?(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="VL3"+XC.getHexVal(a,2)):(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="MVL"+XC.getHexVal(a,2));return b};n.STATUS_DPT_QUEST={"mainzone:power":"PWRQSTN","mainzone:volume":"MVLQSTN","mainzone:mute":"AMTQSTN","mainzone:audioMode":"LMDQSTN","mainzone:input":"SLIQSTN","mainzone:frontTone":"TFRQSTN",
"zone2:power":"ZPWQSTN","zone2:volume":"ZVLQSTN","zone2:mute":"ZMTQSTN","zone2:input":"SLZQSTN","zone3:power":"PW3QSTN","zone3:volume":"VL3QSTN","zone3:mute":"MT3QSTN","zone3:input":"SL3QSTN"};n.LMD_MAP={"00":"Stereo","01":"Direct","02":"SURROUND","03":"Game-RPG","04":"THX","05":"Game-Action","06":"Game-Rock","07":"MONO MOVIE","08":"Orchestra","09":"Unplugged","0A":"Studio-Mix","0B":"TV Logic","0C":"All Ch Stereo","0D":"Theater-Dimensional","0E":"Game-Sports","0F":"Mono",11:"Pure Audio",12:"MULTIPLEX",
13:"Full Mono",14:"DOLBY VIRTUAL",15:"DTS Surround Sensation",16:"Audyssey DSX","1F":"Whole House Mode",23:"Stage",25:"Action",26:"Music","2E":"Sports",40:"Straight Decode*1",41:"Dolby EX*2",42:"THX Cinema",43:"THX Surround EX",44:"THX Music",45:"THX Games",50:"THX U2/S2/I/S Cinema/Cinema2",51:"THX U2/S2/I/S Music",52:"THX U2/S2/I/S Games",80:"Dolby Surround",81:"PLII/PLIIx Music",82:"DTS Neo:6 Cinema",83:"DTS Neo:6 Music",84:"PLII/PLIIx THX Cinema",85:"Neo:6/Neo:X THX Cinema",86:"PLII/PLIIx Game",
87:"Neural Surr*3",88:"Neural THX/Neural Surround",89:"PLII/PLIIx THX Games","8A":"Neo:6/Neo:X THX Games","8B":"PLII/PLIIx THX Music","8C":"Neo:6/Neo:X THX Music","8D":"Neural THX Cinema","8E":"Neural THX Music","8F":"Neural THX Games",90:"PLIIz Height",91:"Neo:6 Cinema DTS Surround Sensation",92:"Neo:6 Music DTS Surround Sensation",93:"Neural Digital Music",94:"PLIIz Height + THX Cinema",95:"PLIIz Height + THX Music",96:"PLIIz Height + THX Games",97:"PLIIz Height + THX U2/S2 Cinema",98:"PLIIz Height + THX U2/S2 Music",
99:"PLIIz Height + THX U2/S2 Games","9A":"Neo:X Game",A0:"PLIIx/PLII Movie + Audyssey DSX",A1:"PLIIx/PLII Music + Audyssey DSX",A2:"PLIIx/PLII Game + Audyssey DSX",A3:"Neo:6 Cinema + Audyssey DSX",A4:"Neo:6 Music + Audyssey DSX",A5:"Neural Surround + Audyssey DSX",A6:"Neural Digital Music + Audyssey DSX",A7:"Dolby EX + Audyssey DSX"};n.prototype._getStateQuest=function(a){return a?n.STATUS_DPT_QUEST[a]:null};n.prototype._buildData=function(a){var b=[73,83,67,80,0,0,0,16,0,0,0,8,1,0,0,0,33,49],c=2+
a.length+1&4294967295;b[8]=c>>24&255;b[9]=c>>16&255;b[9]=c>>8&255;b[11]=c&255;for(c=0;c<a.length;c++)b.push(a.charCodeAt(c));b.push(13);return new Buffer(b)};n.prototype._resolveStatus=function(a){var b={mainzone:{},zone2:{},zone3:{}};if(0==a.indexOf("MVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.mainzone.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PWR"))"00"==a.substr(3)?b.mainzone.power="off":"01"==a.substr(3)&&(b.mainzone.power="on");else if(0==a.indexOf("AMT"))"00"==a.substr(3)?b.mainzone.mute=
"off":"01"==a.substr(3)&&(b.mainzone.mute="on");else if(0==a.indexOf("LMD"))a=a.substr(3).trim(),n.LMD_MAP[a]&&(b.mainzone.audioMode=n.LMD_MAP[a]);else if(0==a.indexOf("TFR")){if(a=a.substr(3),6==a.length){var c=parseInt(a.substr(2,1),16),h="-"==a.charAt(1);h&&(c=0-c);var m=parseInt(a.substr(5,1),16);(h="-"==a.charAt(4))&&(m=0-m);b.mainzone.frontBass=c;b.mainzone.frontTreble=m}}else if(0==a.indexOf("ZVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone2.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("ZPW"))"00"==
a.substr(3)?b.zone2.power="off":"01"==a.substr(3)&&(b.zone2.power="on");else if(0==a.indexOf("ZMT"))"00"==a.substr(3)?b.zone2.mute="off":"01"==a.substr(3)&&(b.zone2.mute="on");else if(0==a.indexOf("VL3"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone3.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PW3"))"00"==a.substr(3)?b.zone3.power="off":"01"==a.substr(3)&&(b.zone3.power="on");else if(0==a.indexOf("MT3"))"00"==a.substr(3)?b.zone3.mute="off":"01"==a.substr(3)&&(b.zone3.mute="on");else if(0==
a.indexOf("SLI")||0==a.indexOf("SLZ")||0==a.indexOf("SL3"))c=b.mainzone,0==a.indexOf("SLZ")?c=b.zone2:0==a.indexOf("SL3")&&(c=b.zone3),"10"==a.substr(3)?c.input="BD/DVD":"11"==a.substr(3)?c.input="STRM BOX":"01"==a.substr(3)?c.input="CBL/SAT":"05"==a.substr(3)?c.input="PC":"02"==a.substr(3)?c.input="GAME":"03"==a.substr(3)?c.input="AUX":"23"==a.substr(3)?c.input="CD":"12"==a.substr(3)?c.input="TV":"24"==a.substr(3)?c.input="FM":"25"==a.substr(3)?c.input="AM":"2B"==a.substr(3)?c.input="NET":"2E"==
a.substr(3)?c.input="BLUETOOTH":"44"==a.substr(3)&&(c.input="Optical");return b};n.prototype._doCommandReq=function(a,b){this._datapointBuffer&&this._datapointBuffer.delDpt(a);this._packetBuffer.sendPacket(a,!0,b)};n.prototype._doStateReq=function(a,b){var c=this;if(this._datapointBuffer){var h=this._datapointBuffer.getDpt(a);if(h){a=this._resolveStatus(h);b(null,a);return}}this._packetBuffer.sendPacket(a,!1,function(m,l){m?b(m):(m=c._resolveStatus(l),b(null,m))})};n.prototype._sendPacket=function(a,
b){if(this._socket){this._logger.log("trace","send ISCP message:"+a);var c=this._buildData(a);this._socket.write(c,"binary");b()}else{var h=this;this._connect(function(m){m?b(m):h._sendPacket(a,b)})}};n.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,c={port:this._port,host:this._ip},h=require("net").connect(c);h.setTimeout(2E3);h.__connected=!1;h.on("connect",function(){b._logger.log("trace","connect to onkyo avr:"+b._ip);h.__connected=!0;b._socket=
h;a()});h.on("data",function(m){b._logger.log("trace","receive from onkyo avr "+(h.__disconnected?"(closed)":"")+":"+b._ip+" data:"+m);h.__disconnected||b._packetBuffer._onSocketData(m)});h.on("error",function(m){h.__connected?(b._logger.log("trace","onkyo avr"+(h.__disconnected?"(closed)":"")+":"+b._ip+" error:"+m.message),h.destroy(),h.__disconnected||(h.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(m))):(b._logger.log("trace","onkyo avr:"+b._ip+" connection error:"+m.message),
a(m))});h.on("timeout",function(){h.__connected?(b._logger.log("trace","onkyo avr"+(h.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),h.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","onkyo avr:"+b._ip+" connection timeout"),h.destroy&&h.destroy(),a(Error("timeout")))});h.on("close",function(){b._logger.log("trace","onkyo avr"+(h.__disconnected?"(closed)":"")+":"+b._ip+" close socket");h.__disconnected||(h.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(h))});
h._doConnect&&"function"==typeof h._doConnect&&h._doConnect();return h};n.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};n.prototype.toJSON=function(){var a={sys:xnm.aio.onkyo.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model};this._name&&(a.name=this._name);return a};n.prototype.equalsTo=function(a){return a&&a instanceof n?this._ip==a._ip&&this._port==
a._port:!1};n.parseJSON=function(a){return a.ip?new n(a.ip,a.port,a.uuid,a.model,a.name):null};var u=function(a,b,c,h,m){this._avr=xnm.aio.onkyo.AVReceiverBuffer.getAVR(a,b);this._avr||(this._avr=new n(a,b,c,h,m),xnm.aio.onkyo.AVReceiverBuffer.setAVR(this._avr))};u.prototype.getUUID=function(){return this._avr?this._avr._uuid:null};u.prototype.executeCommandCreator=function(a,b,c){this._avr.executeCommandCreator(a,b,c)};u.prototype.getStatesCreator=function(a,b,c){this._avr.getStatesCreator(a,b,c)};
u.prototype.executeCommand=function(a,b){this._avr.executeCommand(a,b)};u.prototype.getStates=function(a){this._avr.getStates(a)};u.prototype.toJSON=function(){return this._avr.toJSON()};u.prototype.equalsTo=function(a){return this._avr.equalsTo(a._avr)};u.parseJSON=function(a){return a.ip?new u(a.ip,a.port,a.uuid,a.model,a.name):null};return u}();
xnm.aio.onkyo.DM=function(){var e=function(g,k){this.code=g;this.message=k;this.stack=Error().stack};e.prototype=Error();e.prototype.name="OnkyoDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var d={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open Onkyo Remote App",ref:{value:"openNative",value_t:"open_app_onkyo"}}]},
{type:"root",name:"NET",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},
{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","STEREO"]}},{type:"enum",name:"front bass up",
ref:{value:"frontBassUp",value_t:"bassUp"}},{type:"enum",name:"front bass down",ref:{value:"frontBassDown",value_t:"bassDown"}},{type:"int",name:"front bass to",ref:{value:"frontBassTo",value_t:"bassTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"front treble up",ref:{value:"frontTrebleUp",value_t:"trebleUp"}},{type:"enum",name:"front treble down",ref:{value:"frontTrebleDown",value_t:"trebleDown"}},{type:"int",name:"front treble to",ref:{value:"frontTrebleTo",value_t:"trebleTo",ext:"%d",
extMeta:"-10-10",scale:"2"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",
name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},
{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},
{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",
name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]}],status:[{type:"root",name:"main zone",value:"mainzone",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},
{type:"int",name:"front bass",ref:{value:"frontBass",value_t:"bass",extMeta:"-10-10",scale:"2"}},{type:"int",name:"front treble",ref:{value:"frontTreble",value_t:"treble",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["Stereo","All Ch Stereo"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",
ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on",
"off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]}]}};return{SYS:"onkyo",getIPDeviceType:function(){return[{sys:this.SYS,name:"Onkyo AV Receiver",type:"avr"}]},createDevice:function(g,k,f){k=e.ERROR_CODE;g?g.ip?f(null,g):f(new e(k.INVALID,"ip is invalid")):f(new e(k.INVALID,"info is invalid"))},updateDevice:function(g,k,f){k=e.ERROR_CODE;
g?g.ip?f(null,g):f(new e(k.INVALID,"ip is invalid")):f(new e(k.INVALID,"info is invalid"))},deleteDevice:function(g,k,f){f()},applyUIFilter:function(g,k,f){var q=function(b,c,h){var m=[];b.forEach(function(l){if("root"==l.type){l=JSON.parse(JSON.stringify(l));var p=q(l.children,c,h);p&&0<p.length&&(l.children=p,m.push(l))}else{p=h.elems;if("*"==p)p=!0;else{for(var r=!1,t=0;t<p.length;t++)if(p[t]==l.type){r=!0;break}p=r}p&&(l=JSON.parse(JSON.stringify(l)),m.push(l))}});return m},n=function(b,c){var h=
[],m=xnm.aio.onkyo.DM.getCommandStatusMap(b,f);if(m){var l=[];switch(c.catagory){case "command":m.command&&(l=q(m.command,b,c));break;case "status":m.status&&(l=q(m.status,b,c))}h=h.concat(l)}return h};if(!g.sys)return null;var u=JSON.parse(JSON.stringify(g)),a=null;switch(k.catagory){case "command":a=n(g,k);u.command=a;break;case "status":a=n(g,k);u.status=a;break;default:return null}return a&&0!=a.length?u:null},getCommandStatusMap:function(g){return g&&g.type?d[g.type]:null}}}();
xnm.aio.onkyo.Handler=function(){var e=function(){this.detectedAVRs={}};e.prototype.devicemanager=xnm.aio.onkyo.DM;e.prototype.AVReceiver=xnm.aio.onkyo.AVReceiver;e.prototype.registModule=function(d){d.register(xnm.aio.onkyo.DM.SYS,"onkyo")};e.prototype.resolveDevice=function(d){if(!d)return null;switch(d.type){case "avr":return xnm.aio.onkyo.AVReceiver.parseJSON(d);default:return null}};e.prototype.getDeviceCommands=function(d,g){d=(d=xnm.aio.onkyo.DM.applyUIFilter(d,{catagory:"command",elems:"*"}))?
d.command:[];g&&g(null,d)};e.prototype.getDeviceStatus=function(d,g){d=(d=xnm.aio.onkyo.DM.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];g&&g(null,d)};e.prototype.doCommand=function(d,g,k){var f=this.resolveDevice(d);f?f.executeCommandCreator(d,g,function(q){k&&k(q)}):k&&k(Error("device json format invalid"))};e.prototype.doStatus=function(d,g,k,f){var q=this.resolveDevice(g);q?q.getStatesCreator(null,[{id:d,device:g,status:k}],function(n,u){n?f&&f(n):f&&f(null,u[0])}):f&&f(Error("device json format invalid"))};
e.prototype.getDeviceCommandList=function(d,g,k){var f=[];if(g)f.push({id:window.XC_Text.on,cmd:"on"}),f.push({id:window.XC_Text.off,cmd:"off"});else if(k&&"avr"==d.type){d=[];d.push({id:"on",cmd:"on"});d.push({id:"off",cmd:"off"});d.push({id:"toggle",cmd:"toggle"});d.push({id:"volumeDown",cmd:"volumeDown"});d.push({id:"volumeUp",cmd:"volumeUp"});d.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});d.push({id:"mute",cmd:"mute"});d.push({id:"unmute",cmd:"unmute"});d.push({id:"toggleMute",cmd:"toggleMute"});
d.push({id:"CBLSAT",cmd:"CBLSAT"});d.push({id:"BDDVD",cmd:"BDDVD"});d.push({id:"STRMBOX",cmd:"STRMBOX"});d.push({id:"GAME",cmd:"GAME"});d.push({id:"AUX",cmd:"AUX"});d.push({id:"PC",cmd:"PC"});d.push({id:"CD",cmd:"CD"});d.push({id:"TV",cmd:"TV"});d.push({id:"NET",cmd:"NET"});d.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});d.push({id:"FM",cmd:"FM"});d.push({id:"AM",cmd:"AM"});d.push({id:"tunerUp",cmd:"tunerUp"});d.push({id:"tunerDown",cmd:"tunerDown"});d.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",
max:"40"});cl=d.length;for(g=0;g<cl;g++)k=JSON.parse(JSON.stringify(d[g])),k.ch="mainzone",f.push(k),k=JSON.parse(JSON.stringify(d[g])),k.ch="zone2",f.push(k);f.push({id:"MOVIE",cmd:"MOVIE"});f.push({id:"MUSIC",cmd:"MUSIC"});f.push({id:"GAME",cmd:"GAME"});f.push({id:"STEREO",cmd:"STEREO"});f.push({id:"play",cmd:"play"});f.push({id:"pause",cmd:"pause"});f.push({id:"stop",cmd:"stop"});f.push({id:"previous",cmd:"previous"});f.push({id:"next",cmd:"next"})}return f};e.prototype.discoverDevices=function(d){var g=
require("x.upnp.js");if(g){var k=this;g.discoverDevicesWithTimeout(3E3,function(f){if(f.manufacturer&&0==f.manufacturer.indexOf("ONKYO")&&"AV Receiver"==f.modelDescription){var q=new xnm.aio.onkyo.AVReceiver(f.ip,null,f.uuid,f.modelName,f.name);k.detectedAVRs["uuid:"+f.uuid]||(k.detectedAVRs["uuid:"+f.uuid]=q);d(q)}})}};e.prototype.discoverWithTimeout=function(d,g){var k={};this.discoverDevices(function(f){f&&f.getUUID()&&!k[f.getUUID()]&&(k[f.getUUID()]=f)});setTimeout(function(){var f=[],q;for(q in k)k.hasOwnProperty(q)&&
f.push(k[q]);g&&g(null,f)},d)};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.onkyo.Handler);
