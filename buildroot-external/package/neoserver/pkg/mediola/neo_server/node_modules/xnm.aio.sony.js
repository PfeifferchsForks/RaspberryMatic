var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sony=xnm.aio.sony||{};
xnm.aio.sony.IRCC=function(){var e=function(f,c,d,g,a){this._logger=require("x.logger.js").getLogger("xnm.aio.sony.IRCC");this.ip=f;this.port=c;this.path=d;this.username=g;this.password=a;this._presharedkey=null};e.SOAP_PREFIX='<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:X_SendIRCC xmlns:u="urn:schemas-sony-com:service:IRCC:1"><IRCCCode>';e.SOAP_SUFFIX="</IRCCCode></u:X_SendIRCC></s:Body></s:Envelope>";
e.prototype._executeCommand=function(f,c){var d=this;f=this._buildSoapReq(f);this._doRequest(f,function(g){g&&g._code&&d._logger.log("warn","sony access forbidden");c&&c(g)})};e.prototype._register=function(f){var c=this,d="http://"+this.ip+":50002/?action=register&name=aioRemote&registrationType=initial&deviceId=aioRemote%3A00-00-00-00-00-00";this._logger.log("trace","register:"+d);$.ajax({url:d,method:"GET",timeout:3E3,cache:!1,headers:{"Content-Type":"text/xml; charset=UTF-8","X-CERS-DEVICE-ID":"aioRemote:00-00-00-00-00-00"},
username:this.username,password:this.password,success:function(){c._logger.log("trace","http request success");f&&f()},error:function(g,a){c._logger.log("trace","http request error:"+a);f&&f(Error(a?a:"http error"))}})};e.prototype._doRequest=function(f,c){var d=this,g="http://"+this.ip+":"+this.port+this.path,a=c;this._logger.log("trace","send data:"+f+" to:"+g);c={SOAPAction:'"urn:schemas-sony-com:service:IRCC:1#X_SendIRCC"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":f.length,"X-CERS-DEVICE-ID":"aioRemote:00-00-00-00-00-00"};
this._presharedkey&&(c["X-Auth-PSK"]=this._presharedkey);$.ajax({url:g,type:"POST",timeout:3E3,data:f,cache:!1,headers:c,username:this.username,password:this.password,statusCode:{401:function(){if(a){var b=Error("http response 401");b._errSource="xnm.aio.sony.IRCC";b._code=401;b._device=d;a(b);a=null}},403:function(){if(a){var b=Error("http response 403");b._errSource="xnm.aio.sony.IRCC";b._code=403;b._device=d;a(b);a=null}}},success:function(){d._logger.log("trace","http request success");a&&(a(),
a=null)},error:function(b,h){d._logger.log("trace","http request error:"+h);b&&401==b.status?(b=Error("http response 401"),b._errSource="xnm.aio.sony.IRCC",b._code=401,b._device=d,a(b),a=null):b&&403==b.status?(b=Error("http response 403"),b._errSource="xnm.aio.sony.IRCC",b._code=403,b._device=d,a(b),a=null):a&&(a(Error(h?h:"http error")),a=null)}})};e.prototype._buildSoapReq=function(f){return e.SOAP_PREFIX+f+e.SOAP_SUFFIX};return e}();
xnm.aio.sony.BDP=function(){var e=function(f,c,d,g,a){if(!c||0>c)c=50001;d||(d="/upnp/control/IRCC");xnm.aio.sony.IRCC.call(this,f,c,d,g,a)};e.prototype=Object.create(xnm.aio.sony.IRCC.prototype);return e.prototype.constructor=e}();xnm.aio.sony.TV=function(){var e=function(f,c,d,g,a){if(!c||0>c)c=80;d||(d="/IRCC");xnm.aio.sony.IRCC.call(this,f,c,d,g,a)};e.prototype=Object.create(xnm.aio.sony.IRCC.prototype);return e.prototype.constructor=e}();
xnm.aio.sony.Handler=function(){var e=function(){};e.prototype.IRCC=xnm.aio.sony.IRCC;e.prototype.BDP=xnm.aio.sony.BDP;return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.sony.Handler);
