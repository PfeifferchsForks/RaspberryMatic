var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rgb=xnm.aio.rgb||{};
xnm.aio.rgb.Util={rgbToHsv:function(f,b,c){f/=255;b/=255;c/=255;var a=Math.max(f,b,c),d=Math.min(f,b,c),e=a,g=a-d;var h=0==a?0:g/a;if(a==d)var k=0;else{switch(a){case f:k=(b-c)/g+(b<c?6:0);break;case b:k=(c-f)/g+2;break;case c:k=(f-b)/g+4}k=Math.round(60*k);h=Math.round(100*h);e=Math.round(100*e)}return[k,h,e]},hsvToMilightColor:function(f){return(432-Math.floor(Number(f[0])/360*255))%256},rgbToHue:function(f,b,c){f=this.rgbToHsv(f,b,c);return(432-Math.floor(Number(f[0])/360*255))%256}};
xnm.aio.rgb.ArtNetNode=function(){var f=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3],b=function(c,a){this.ip=c;this.port=a;this.port||(this.port=6454)};b.prototype.executeCommandCreator=function(c,a,d){this._executeCommand(a,function(e){d&&d(e)})};b.prototype.equalsTo=function(c){return c&&c instanceof b?this.ip==c.ip&&this.port==c.port:!1};b.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port}};b.prototype._executeCommand=function(c,a){if(c){switch(c.value){case "hex":c=
c.ext;break;default:a&&a(Error("no such command:"+c.value));return}c?(c=this._buildData(c),this._doRequest(c,function(){a&&a()})):a&&a(Error("command is empty"))}else a&&a(Error("command format invalid"))};b.prototype._buildData=function(c){0!=c.length%2&&(c="0"+c);var a=f.slice();a[16]=c.length/2>>8&15;a[17]=c.length/2&15;for(var d=0;d<c.length/2;d++){var e=c.substr(2*d,2);a.push(parseInt(e,16))}return a};b.prototype._doRequest=function(c,a){var d=require("dgram"),e=new Buffer(c),g=d.createSocket("udp4");
g.send(e,0,c.length,this.port,this.ip,function(h){g.close();a&&a(h)})};b._stateBuffer={};b.parseJSON=function(c){return c.ip?new b(c.ip,c.port):null};return b}();
xnm.aio.rgb.ArtNetNode.DM=function(){var f={command:[{type:"string",name:"HEX command",ref:{value:"hex",ext:"%s"}}]};return{SYS:"artnet",registModule:function(b){b.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"ArtNet Node"}},createDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;b?b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid")):a(new c(d.INVALID,"info is invalid"))},updateDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;
b?b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid")):a(new c(d.INVALID,"info is invalid"))},deleteDevice:function(b,c,a){a()},getCommandStatusMap:function(){return f}}}();
xnm.aio.rgb.WiFiLED2=function(){var f=function(b,c){var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.rgb.WiFiLED2"):{log:function(){}};this.ip=b;this.port=c;this.port||(this.port=5E4)};f.prototype._doRequest=function(b,c){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(b));var a=require("dgram");b=new Buffer(b);var d=a.createSocket("udp4");d.send(b,0,b.length,this.port,this.ip,function(e){d.close();c&&setTimeout(function(){c(e)},250)})};f.prototype.executeCommand=
function(b,c){var a=[32,0,85];if("on"==b)a[0]=34;else if("off"==b)a[0]=33;else if("up"==b)a[0]=35;else if("down"==b)a[0]=36;else if("modeUp"==b)a[0]=39;else if("modeDown"==b)a[0]=40;else if("speedUp"==b)a[0]=37;else if("speedDown"==b)a[0]=38;else if("allBulbsOn"==b)a[0]=53;else if("allBulbsOff"==b)a[0]=57;else if("bulbUp"==b)a[0]=60;else if("bulbDown"==b)a[0]=52;else if("bulbLightUp"==b)a[0]=62;else if("bulbLightDown"==b)a[0]=63;else if("zone1On"==b)a[0]=56;else if("zone1Off"==b)a[0]=59;else if("zone2On"==
b)a[0]=61;else if("zone2Off"==b)a[0]=51;else if("zone3On"==b)a[0]=55;else if("zone3Off"==b)a[0]=58;else if("zone4On"==b)a[0]=50;else if("zone4Off"==b)a[0]=54;else if(6==b.length){var d=parseInt(b.substr(0,2),16),e=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);var g=0,h=85,k=b,l=e;b<=d&&b<=e?(k=e,l=d,g=86,h=170):e<=d&&e<=b&&(k=d,l=b,g=171,h=255);g=(255==k?g+l/255*((h-g)/2):h-k/255*((h-g)/2))+10;255<g&&(g-=255);0==d&&0==e&&0==b?a[0]=21:a[1]=g}this._doRequest(a,c)};f.prototype.executeCommandCreator=
function(b,c,a){b=c.value;if("rgb"==b||"rgbS"==b)b=c.ext;this.executeCommand(b,function(){a&&a()})};f.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.rgb.WiFiLED2?this.ip==b.ip&&this.port==b.port:!1};f.parseJSON=function(b){return b.ip?new f(b.ip,b.port):null};return f}();
xnm.aio.rgb.WiFiLED2.DM=function(){var f={command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"modeUp",ref:{value:"modeUp"}},{type:"enum",name:"modeDown",ref:{value:"modeDown"}},{type:"enum",name:"speedUp",ref:{value:"speedUp"}},{type:"enum",name:"speedDown",ref:{value:"speedDown"}},{type:"enum",name:"allBulbsOn",ref:{value:"allBulbsOn"}},{type:"enum",name:"allBulbsOff",
ref:{value:"allBulbsOff"}},{type:"enum",name:"bulbUp",ref:{value:"bulbUp"}},{type:"enum",name:"bulbDown",ref:{value:"bulbDown"}},{type:"enum",name:"bulbLightUp",ref:{value:"bulbLightUp"}},{type:"enum",name:"bulbLightDown",ref:{value:"bulbLightDown"}},{type:"enum",name:"zone1On",ref:{value:"zone1On"}},{type:"enum",name:"zone1Off",ref:{value:"zone1Off"}},{type:"enum",name:"zone2On",ref:{value:"zone2On"}},{type:"enum",name:"zone2Off",ref:{value:"zone2Off"}},{type:"enum",name:"zone3On",ref:{value:"zone3On"}},
{type:"enum",name:"zone3Off",ref:{value:"zone3Off"}},{type:"enum",name:"zone4On",ref:{value:"zone4On"}},{type:"enum",name:"zone4Off",ref:{value:"zone4Off"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]};return{SYS:"wifiled2",registModule:function(b){b.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"Wifi LED II"}},createDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;
b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid"))},updateDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid"))},deleteDevice:function(b,c,a){a()},getCommandStatusMap:function(){return f}}}();
xnm.aio.rgb.DMX4ALL=function(){var f=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3,0,0,0],b=function(c,a){this.ip=c;this.port=a;this.port||(this.port=6454)};b.prototype.executeCommandCreator=function(c,a,d){this._executeCommand(a,function(e){d&&d(e)})};b.prototype.equalsTo=function(c){return c&&c instanceof b?this.ip==c.ip&&this.port==c.port:!1};b.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port}};b.prototype._executeCommand=function(c,a){if(c){var d=
0,e=0,g=0,h=0,k=100;if(b._stateBuffer[this.ip]){var l=b._stateBuffer[this.ip];null!=l.red&&"undefined"!=typeof l.red&&(d=l.red);null!=l.green&&"undefined"!=typeof l.green&&(e=l.green);null!=l.blue&&"undefined"!=typeof l.blue&&(g=l.blue);null!=l.white&&"undefined"!=typeof l.white&&(h=l.white);null!=l.bri&&"undefined"!=typeof l.bri&&(k=l.bri)}switch(c.value){case "off":h=g=e=d=0;break;case "red":case "green":case "blue":case "white":if(null==c.ext||"undefined"==typeof c.ext){a&&a(Error("command red value invalid"));
return}if("number"==typeof c.ext)switch(c.value){case "red":d=parseInt(c.ext);break;case "green":e=parseInt(c.ext);break;case "blue":g=parseInt(c.ext);break;case "white":h=parseInt(c.ext)}else if(c.ext.match(/^[-+]?[0-9]+$/))switch(c.value){case "red":d=parseInt(c.ext);break;case "green":e=parseInt(c.ext);break;case "blue":g=parseInt(c.ext);break;case "white":h=parseInt(c.ext)}else{a&&a(Error("command red value invalid"));return}break;case "rgb":case "rgbS":if(!c.ext||6>c.ext.length){a&&a(Error("command rgb value invalid"));
return}d=parseInt(c.ext.substr(0,2),16);e=parseInt(c.ext.substr(2,2),16);g=parseInt(c.ext.substr(4,2),16);break;case "rgbw":case "rgbwS":if(!c.ext||8>c.ext.length){a&&a(Error("command rgbw value invalid"));return}d=parseInt(c.ext.substr(0,2),16);e=parseInt(c.ext.substr(2,2),16);g=parseInt(c.ext.substr(4,2),16);h=parseInt(c.ext.substr(6,2),16);break;case "brightness":if(null==c.ext||"undefined"==typeof c.ext){a&&a(Error("command brightness value invalid"));return}if("number"==typeof c.ext)k=parseInt(c.ext);
else if(c.ext.match(/^[-+]?[0-9]+$/))k=parseInt(c.ext);else{a&&a(Error("command brightness value invalid"));return}break;default:a&&a(Error("no such command:"+c.value));return}b._stateBuffer[this.ip]={red:d,green:e,blue:g,white:h,bri:k};c=this._buildColor(d,e,g,h,k/100);this._doRequest(new Buffer(c),function(){a&&a()})}else a&&a(Error("command format invalid"))};b.prototype._buildColor=function(c,a,d,e,g){c=Math.round(c*g);a=Math.round(a*g);d=Math.round(d*g);e=Math.round(e*g);255<c&&(c=255);255<a&&
(a=255);255<d&&(d=255);255<e&&(e=255);g=f.slice();g[17]=4;g[18]=c;g[19]=a;g[20]=d;g.push(e);return g};b.prototype._doRequest=function(c,a){var d=require("dgram").createSocket("udp4");d.send(c,0,c.length,this.port,this.ip,function(e){d.close();a&&a(e)})};b._stateBuffer={};b._discovery=function(c,a){if(!b._logger){var d=require("x.logger.js");b._logger=d?d.getLogger("xnm.aio.rgb.DMX4ALL"):{log:function(){}}}var e=function(n,q){var r=q,m=require("dgram").createSocket("udp4");m.on("listening",function(){b._logger.log("trace",
"sender socket started:"+n);m.setBroadcast(!0);r&&(r(null,m),r=null)});m.on("error",function(p){r&&(r(p),r=null)});m.bind(null,n)},g=function(n){var q=[],r=[],m=require("os");require("dgram");if(m&&m.networkInterfaces){m=m.networkInterfaces();for(var p in m)if(m.hasOwnProperty(p))for(var v=m[p],x=0;x<v.length;x++)"IPv4"==v[x].family&&0==v[x].internal&&q.push(v[x].address)}else q.push("0.0.0.0");var y=0;for(p=0;p<q.length;p++)m=q[p],"0.0.0.0"==m&&(m=null),e(m,function(A,z){y++;!A&&z&&r.push(z);y==
q.length&&n&&n(null,r)})},h=function(n,q){if(0==n.length)q();else for(var r=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]),m=0,p=0;p<n.length;p++)n[p].send(r,0,r.length,6454,"255.255.255.255",function(){m++;m==n.length&&q()})};if(a){this._discoveryCallback||(this._discoveryCallback=[]);d=!1;for(var k=0;k<this._discoveryCallback.length;k++)if(this._discoveryCallback[k]===a){d=!0;break}d||this._discoveryCallback.push(a);if(!this._discoverRunning){this._discoverResults={};this._discoverRunning=
!0;var l,t,u=this._discoverResults,w=this;(function(n,q){var r=require("dgram"),m=q,p=r.createSocket("udp4");p.on("listening",function(){b._logger.log("trace","listener socket started");p.setBroadcast(!0);m&&(m(null,p),m=null)});p.on("message",function(v,x){n(v,x)});p.on("error",function(v){m?(b._logger.log("warn","create listener socket error:"+v),m(v),m=null):b._logger.log("warn","listener socket error:"+v)});p.bind(6454)})(function(n){n=n.toString("hex");var q=n.substr(0,16);if(16<n.length&&"4172742d4e657400"==
q.toLowerCase()&&(q=n.substr(16,4),20<n.length&&"0021"==q.toLowerCase()&&28<n.length)){var r=parseInt(n.substr(20,2),16)+"."+parseInt(n.substr(22,2),16)+"."+parseInt(n.substr(24,2),16)+"."+parseInt(n.substr(26,2),16);q=n.substr(48,4);52<n.length&&"1a2c"==q.toLowerCase()&&(q=n.substr(52,36),88<n.length&&"4172744e65742d4c45442044696d6d657200"==q.toLowerCase()&&(u[r]=new b(r)))}},function(n,q){if(n){for(q=0;q<w._discoveryCallback.length;q++)w._discoveryCallback[q](n);w._discoverRunning=!1}else l=q,g(function(r,
m){if(r){for(m=0;m<w._discoveryCallback.length;m++)w._discoveryCallback[m](r);w._discoverRunning=!1;l.end()}else t=m,h(t,function(){setTimeout(function(){for(var p=0;p<t.length;p++)t[p].close();l.close();for(p=0;p<w._discoveryCallback.length;p++){var v=[],x;for(x in w._discoverResults)w._discoverResults.hasOwnProperty(x)&&v.push(w._discoverResults[x]);w._discoveryCallback[p](null,v)}w._discoverRunning=!1;w._discoveryCallback=[]},c)})})})}}};b.parseJSON=function(c){return c.ip?new b(c.ip,c.port):null};
return b}();
xnm.aio.rgb.DMX4ALL.DM=function(){var f={command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"int",name:"red",ref:{value:"red",ext:"%d",extMeta:"0-255"}},{type:"int",name:"green",ref:{value:"green",ext:"%d",extMeta:"0-255"}},{type:"int",name:"blue",ref:{value:"blue",ext:"%d",extMeta:"0-255"}},{type:"int",name:"white",ref:{value:"white",ext:"%d",extMeta:"0-255"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"int",
name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100"}},{type:"string",name:"rgb+white color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}}]};return{SYS:"dmx4all",registModule:function(b){b.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"DMX4ALL"}},createDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;b?b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid")):a(new c(d.INVALID,
"info is invalid"))},updateDevice:function(b,c,a){c=xnm.aio.rgb.DMError;var d=xnm.aio.rgb.DMError.ERROR_CODE;b?b.ip?a(null,b):a(new c(d.INVALID,"ip is invalid")):a(new c(d.INVALID,"info is invalid"))},deleteDevice:function(b,c,a){a()},getCommandStatusMap:function(){return f}}}();
xnm.aio.rgb.MiLight=function(){var f=function(b,c,a){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.rgb.MiLight"):{log:function(){}};this.ip=b;this.port=c;this.port||(this.port=8899);this.uuid=a};f.prototype._doRequest=function(b,c){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(b));var a=require("dgram");b=new Buffer(b);var d=a.createSocket("udp4"),e=this;d.send(b,0,b.length,this.port,this.ip,function(g){g&&e._logger.log("warn","send data error:"+g.message);
d.close();c&&setTimeout(function(){c(g)},250)})};f.prototype.executeCommand=function(b,c,a){if(b&&b.type&&null!=c&&"undefined"!=typeof c)switch(b.type){case "easy_rgbw":case "easy_white":if(null==b.address||"undefined"==typeof b.address){a&&a(Error("address invalid"));break}"easy_rgbw"==b.type?this._execEasyRGBW(b.address,c,a):this._execEasyWhite(b.address,c,a);break;case "rgb":this._execRGB(c,a);break;default:a&&a(Error(b.type+" not supported"))}else a&&a(Error("argument invalid"))};f.prototype.executeCommandCreator=
function(b,c,a){if(b&&b.type&&c){var d=c.value;switch(b.type){case "easy_rgbw":case "easy_white":switch(c.value){case "brightness":case "rgbS":case "rgb":d=c.ext}break;case "rgb":switch(c.value){case "rgbS":case "rgb":d=c.ext}}null==d||"undefined"==typeof d?a&&a(Error("command invalid")):this.executeCommand(b,d,function(e){a&&a(e)})}else a&&a(Error("argument invalid"))};f.prototype._execEasyRGBW=function(b,c,a){var d=this;switch(c){case "speedDown":case "speedUp":case "discoMode":case "on":case "off":var e=
this._buildEasyRGBWData(b,c);this._doRequest(e,a);break;default:"white"==c||6==c.length||0<=parseInt(c)&&100>=parseInt(c)?(e=this._buildEasyRGBWData(b,"on"),this._doRequest(e,function(g){g?a&&a(g):(e=d._buildEasyRGBWData(b,c),setTimeout(function(){d._doRequest(e,a)},100))})):a&&a(Error("no such command"))}};f.prototype._buildEasyRGBWData=function(b,c){b=parseInt(b);var a=[255,0,85];switch(c){case "speedDown":a[0]=67;break;case "speedUp":a[0]=68;break;case "discoMode":a[0]=77;break;case "on":switch(b){case 0:a[0]=
66;break;case 1:a[0]=69;break;case 2:a[0]=71;break;case 3:a[0]=73;break;case 4:a[0]=75}break;case "off":switch(b){case 0:a[0]=65;break;case 1:a[0]=70;break;case 2:a[0]=72;break;case 3:a[0]=74;break;case 4:a[0]=76}break;case "white":switch(b){case 0:a[0]=194;break;case 1:a[0]=197;break;case 2:a[0]=199;break;case 3:a[0]=201;break;case 4:a[0]=203}break;default:if(6==c.length){var d=parseInt(c.substr(0,2),16),e=parseInt(c.substr(2,2),16);c=parseInt(c.substr(4,2),16);var g=0;var h=85,k=c,l=e;c<=d&&c<=
e?(k=e,l=d,g=86,h=170):e<=d&&e<=c&&(k=d,l=c,g=171,h=255);g=(255==k?g+l/255*((h-g)/2):h-k/255*((h-g)/2))+10;255<g&&(g-=255);if(0==d&&0==e&&0==c)return this._buildEasyRGBWData(b,"off");a[0]=64;a[1]=g}else if(0<=parseInt(c)&&100>=parseInt(c)){g=Math.round(parseInt(c)/100*26)+1;1>g?g=1:27<g&&(g=27);if(1==g)return this._buildEasyRGBWData(b,"off");a[0]=78;a[1]=g}}return 255==a[0]?null:a};f.prototype._execEasyWhite=function(b,c,a){var d=this;switch(c){case "briUp":case "briDown":case "warmUp":case "coolUp":case "on":case "off":var e=
this._buildEasyWhiteData(b,c);this._doRequest(e,a);break;case "night":case "fullbri":e="night"==c?this._buildEasyWhiteData(b,"off"):this._buildEasyWhiteData(b,"on");this._doRequest(e,function(g){g?a&&a(g):(e=d._buildEasyWhiteData(b,c),setTimeout(function(){d._doRequest(e,a)},100))});break;default:a&&a(Error("no such command"))}};f.prototype._buildEasyWhiteData=function(b,c){b=parseInt(b);var a=[255,0,85];switch(c){case "briUp":a[0]=60;break;case "briDown":a[0]=52;break;case "warmUp":a[0]=62;break;
case "coolUp":a[0]=63;break;case "on":switch(b){case 0:a[0]=53;break;case 1:a[0]=56;break;case 2:a[0]=61;break;case 3:a[0]=55;break;case 4:a[0]=50}break;case "off":switch(b){case 0:a[0]=57;break;case 1:a[0]=59;break;case 2:a[0]=51;break;case 3:a[0]=58;break;case 4:a[0]=54}break;case "night":switch(b){case 0:a[0]=185;break;case 1:a[0]=187;break;case 2:a[0]=179;break;case 3:a[0]=186;break;case 4:a[0]=182}break;case "fullbri":switch(b){case 0:a[0]=181;break;case 1:a[0]=184;break;case 2:a[0]=189;break;
case 3:a[0]=183;break;case 4:a[0]=178}}return 255==a[0]?null:a};f.prototype._execRGB=function(b,c){var a=this;switch(b){case "speedDown":case "speedUp":case "briUp":case "briDown":case "modeUp":case "modeDown":case "on":case "off":var d=this._buildRGBData(b);this._doRequest(d,c);break;default:6==b.length?(d=this._buildRGBData("on"),this._doRequest(d,function(e){e?c&&c(e):(d=a._buildRGBData(b),setTimeout(function(){a._doRequest(d,c)},100))})):c&&c(Error("no such command"))}};f.prototype._buildRGBData=
function(b){var c=[255,0,85];switch(b){case "off":c[0]=33;break;case "on":c[0]=34;break;case "briUp":c[0]=35;break;case "briDown":c[0]=36;break;case "speedUp":c[0]=37;break;case "speedDown":c[0]=38;break;case "modeUp":c[0]=39;break;case "modeDown":c[0]=40;break;default:if(6==b.length){var a=parseInt(b.substr(0,2),16),d=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);var e=0,g=85,h=b,k=d;b<=a&&b<=d?(h=d,k=a,e=86,g=170):d<=a&&d<=b&&(h=a,k=b,e=171,g=255);e=(255==h?e+k/255*((g-e)/2):g-h/255*((g-
e)/2))+10;255<e&&(e-=255);if(0==a&&0==d&&0==b)return this._buildRGBData("off");c[0]=32;c[1]=e}}return 255==c[0]?null:c};f.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.rgb.MiLight?this.ip==b.ip&&this.port==b.port:!1};f.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLight.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};f.parseJSON=function(b){return b.ip?new f(b.ip,b.port,b.uuid):null};return f}();
xnm.aio.rgb.MiLight.Discovery=function(){var f=function(){var b=require("x.logger.js");this._logger=b?b.getLogger("xnm.aio.rgb.MiLight.Discovery"):{log:function(){}};this._searching=!1;this._tempCallbacks=[];this._callbacks=[];this._controllers={};this._sockets=[];b=require("os");require("dgram");if(b&&b.networkInterfaces){b=b.networkInterfaces();for(var c in b)if(b.hasOwnProperty(c))for(var a=b[c],d=0;d<a.length;d++)this._addDiscoverSocket(48899,a[d])}else this._addDiscoverSocket(48899,null)};f.prototype.discoverDevices=
function(b){this._addCallback(b,this._callbacks);this._sendDiscoveryMessages()};f.prototype.discoverWithTimeout=function(b,c){this._addCallback(c,this._tempCallbacks);this._searching||(this._controllers={},this._searching=!0,this._sendDiscoveryMessages());var a=this;setTimeout(function(){a._removeCallback(c,a._tempCallbacks);var d=[],e;for(e in a._controllers)a._controllers.hasOwnProperty(e)&&a._controllers[e]&&d.push(a._controllers[e]);c(d);0==a._tempCallbacks.length&&(a._searching=!1)},b)};f.prototype._addCallback=
function(b,c){if(b)for(var a=0;a<c.length;a++)if(c[a]===b)return;c.push(b)};f.prototype._removeCallback=function(b,c){if(b){for(var a=-1,d=0;d<c.length;d++)if(c[d]===b){a=d;break}-1!=a&&c.splice(a,1)}};f.prototype._addDiscoverSocket=function(b,c){var a=require("dgram"),d=this;try{var e=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){e=a.createSocket("udp4")}c?"IPv4"==c.family&&0==c.internal&&(e.on("listening",function(){e.setBroadcast(!0)}),e.on("message",function(g,h){d._receivedData(h.address,
g)}),e.on("error",function(g){d._logger.log("warn","milight listener error on address:"+c.address+" mesage:"+(g?g.message:null))}),e.bind(b,c.address),this._logger.log("start listener on address:"+c.address+"-port:"+b),this._sockets.push(e)):(e.on("message",function(g,h){d._receivedData(h.address,g)}),e.on("error",function(g){d._logger.log("warn","milight listener error:"+(g?g.message:null))}),e.bind(b),this._logger.log("debug","start listener on address:[ANY]-port:"+b),this._sockets.push(e))};f.prototype._receivedData=
function(b,c){"object"==typeof c&&(c=c.toString());this._logger.log("trace","receive discovery response:"+c);var a=c.split(",");if(2<=a.length&&(c=a[0],b=a[1],a=a[2],c&&b))for(c=a?new xnm.aio.rgb.MiLightV6(c,null,b):new xnm.aio.rgb.MiLight(c,null,b),this._controllers[b]=c,b=0;b<this._callbacks.length;b++)if(this._callbacks[b])this._callbacks[b](c)};f.prototype._sendDiscoveryMessages=function(){for(var b="Link_Wi-Fi",c=0;c<this._sockets.length;c++)this._sockets[c].send(b,0,b.length,48899,"255.255.255.255");
b="HF-A11ASSISTHREAD";for(c=0;c<this._sockets.length;c++)this._sockets[c].send(b,0,b.length,48899,"255.255.255.255")};return f}();
xnm.aio.rgb.MiLight.DM=function(){return{SYS:"milight",MAP:{easy_rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]},easy_rgbw_all:{command:[{type:"enum",name:"disco mode",ref:{value:"discoMode"}},
{type:"enum",name:"disco speed up",ref:{value:"speedUp"}},{type:"enum",name:"disco speed down",ref:{value:"speedDown"}}]},easy_white:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night mode",ref:{value:"night"}},{type:"enum",name:"full brightness",ref:{value:"fullbri"}}]},easy_white_all:{command:[{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"warm white up",
ref:{value:"warmUp"}},{type:"enum",name:"cool white up",ref:{value:"coolUp"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}},
{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]}},registModule:function(f){f.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,name:"Mi.Light Controller (WiFi)",port:8899}},getGatewayDeviceType:function(f){return f.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"MultiZone RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"MultiZone White Bulb"},{sys:this.SYS,type:"rgb",name:"SingleZone RGB Bulb"}]:null},
createGateway:function(f,b,c){b=xnm.aio.rgb.DMError;var a=xnm.aio.rgb.DMError.ERROR_CODE;f?f.ip?c(null,f):c(new b(a.INVALID,"ip is invalid")):c(new b(a.INVALID,"info is invalid"))},updateGateway:function(f,b,c,a){f=xnm.aio.rgb.DMError;c=xnm.aio.rgb.DMError.ERROR_CODE;b?b.ip?a(null,b):a(new f(c.INVALID,"ip is invalid")):a(new f(c.INVALID,"update is invalid"))},deleteGateway:function(f,b,c){c()},createDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.gateway)if(null==
f.type||"undefined"==typeof f.type)c(new a(d.INVALID,"type is invalid"));else{if("easy_rgbw"==f.type||"easy_white"==f.type)if(null==f.address||"undefined"==typeof f.address){c(new a(d.INVALID,"address is invalid"));return}if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===f.gateway){var g=b[e];break}g?c(null,f):c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+
" not exists"))}else c(new a(d.INVALID,"gateway is invalid"));else c(new a(d.INVALID,"info is invalid"))},updateDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.gateway)if(null==f.type||"undefined"==typeof f.type)c(new a(d.INVALID,"type is invalid"));else{if("easy_rgbw"==f.type||"easy_white"==f.type)if(null==f.address||"undefined"==typeof f.address){c(new a(d.INVALID,"address is invalid"));return}if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=
b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===f.gateway){var g=b[e];break}g?c(null,f):c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.INVALID,"gateway is invalid"));else c(new a(d.INVALID,"info is invalid"))},deleteDevice:function(f,b,c){c()},getCommandStatusMap:function(f){if(!f)return null;var b=null;switch(f.type){case "easy_rgbw":b=JSON.parse(JSON.stringify(this.MAP.easy_rgbw));
0==parseInt(f.address)&&(f=JSON.parse(JSON.stringify(this.MAP.easy_rgbw_all)),b.command=b.command.concat(f.command));break;case "easy_white":b=JSON.parse(JSON.stringify(this.MAP.easy_white));0==parseInt(f.address)&&(f=JSON.parse(JSON.stringify(this.MAP.easy_white_all)),b.command=b.command.concat(f.command));break;case "rgb":b=JSON.parse(JSON.stringify(this.MAP.rgb))}return b}}}();
xnm.aio.rgb.MiLightV6=function(){var f={bridges:{},socket:null,init:function(){this.socket=new b(this)},receiveData:function(a,d){(a=this.bridges[a])&&a.receiveData(d)},getBridge:function(a){return this.bridges[a]},setBridge:function(a,d){this.bridges[a]=d},sendPacket:function(a,d,e){this.socket&&this.socket.sendPacket(a,d,e)}},b=function(a){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.rgb.MiLightV6.UdpSocket"):{log:function(){}};this._listener=a;this._sockets=[];a=require("os");
require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var e in a)if(a.hasOwnProperty(e)){d=a[e];for(var g=0;g<d.length;g++)this._addDiscoverSocket(5987,d[g])}}else this._addDiscoverSocket(5987,null)};b.prototype._receivedData=function(a,d){d=d.toString("hex");d=new Buffer(d,"hex");this._listener&&this._listener.receiveData(a,d)};b.prototype._addDiscoverSocket=function(a,d){var e=require("dgram"),g=this;if(!d){try{var h=e.createSocket({reuseAddr:!0,type:"udp4"})}catch(k){h=e.createSocket("udp4")}h.on("message",
function(k,l){g._receivedData(l.address,k)});h.on("error",function(k){g._logger.log("error","udp socket at"+a+" error:"+k.message)});h.bind(a);this._sockets.push(h)}else if("IPv4"==d.family&&0==d.internal){try{h=e.createSocket({reuseAddr:!0,type:"udp4"})}catch(k){h=e.createSocket("udp4")}h.on("listening",function(){h.setBroadcast(!0)});h.on("message",function(k,l){g._receivedData(l.address,k)});h.on("error",function(k){g._logger.log("error","udp socket at"+a+"@"+d.address+" error:"+k.message)});h.bind(a,
d.address);this._sockets.push(h)}};b.prototype.sendPacket=function(a,d,e){for(var g=0;g<this._sockets.length;g++)this._sockets[g].send(a,0,a.length,e,d)};var c=function(a,d,e){var g=require("x.logger.js");this._logger=g?g.getLogger("xnm.aio.rgb.MiLightV6"):{log:function(){}};this.ip=a;this.port=d;this.port||(this.port=5987);this.uuid=e;f.getBridge(a)||f.setBridge(a,this);this._packetBuffer=[];this._sessionCreating=!1;this._session=this._sessionCreateTimeout=null;this._seqNo=-1};c.prototype.executeCommandCreator=
function(a,d,e){if(a&&a.type&&d){switch(a.type){case "wifi_box":var g=this._buildWifiBoxCommand(d.value,d.ext);break;case "rgb":g=this._buildRGBCommand(d.value,d.ext);break;case "rgbw":if("undefined"==typeof a.address||null==a.address){e&&e(Error("device has no address"));return}g=this._buildRGBWCommand(a.address,d.value,d.ext);break;case "rgbww_cw":if("undefined"==typeof a.address||null==a.address){e&&e(Error("device has no address"));return}g=this._buildRGBWWCommand(a.address,d.value,d.ext);break;
case "ww_cw":if("undefined"==typeof a.address||null==a.address){e&&e(Error("device has no address"));return}g=this._buildWWCommand(a.address,d.value,d.ext)}g?this.sendCommand(g,function(h){e&&e(h)}):e&&e(Error("command invalid"))}else e&&e(Error("argument invalid"))};c.prototype._buildWifiBoxCommand=function(a,d){var e=[49,0,0,0,255,255,0,0,0,1];switch(a){case "on":e[4]=3;e[5]=3;break;case "off":e[4]=3;e[5]=4;break;case "white":e[4]=3;e[5]=5;break;case "speedUp":e[4]=3;e[5]=2;break;case "speedDown":e[4]=
3;e[5]=1;break;case "mode":if(!e)return null;e[4]=4;e[5]=parseInt(d);break;case "brightness":e[4]=2;e[5]=parseInt(d);break;case "rgb":case "rgbS":if(!d||6>d.length)return null;a=parseInt(d.substr(0,2),16);var g=parseInt(d.substr(2,2),16);d=parseInt(d.substr(4,2),16);d=xnm.aio.rgb.Util.rgbToHue(a,g,d);d=Math.min(Math.max(d,0),255);d=255-d-82;0>d&&(d=255+d);e[4]=1;e[5]=d;e[6]=d;e[7]=d;e[8]=d;break;default:return null}return e};c.prototype._buildRGBWWCommand=function(a,d,e){var g=[49,0,0,8,255,255,0,
0,0,255];g[9]=parseInt(a);switch(d){case "on":g[4]=4;g[5]=1;break;case "off":g[4]=4;g[5]=2;break;case "night":g[4]=4;g[5]=5;break;case "white":g[4]=5;g[5]=100;break;case "speedUp":g[4]=4;g[5]=3;break;case "speedDown":g[4]=4;g[5]=4;break;case "mode":if(!g)return null;g[4]=6;g[5]=parseInt(e);break;case "brightness":g[4]=3;g[5]=parseInt(e);break;case "saturation":g[4]=2;g[5]=parseInt(e);break;case "kelvin":g[4]=5;e=(parseInt(e)-2700)/18;0>e&&(e=0);100<e&&(e=100);g[5]=e;break;case "rgb":case "rgbS":if(!e||
6>e.length)return null;a=parseInt(e.substr(0,2),16);d=parseInt(e.substr(2,2),16);e=parseInt(e.substr(4,2),16);e=xnm.aio.rgb.Util.rgbToHue(a,d,e);e=Math.min(Math.max(e,0),255);e=255-e-82;0>e&&(e=255+e);g[4]=1;g[5]=e;g[6]=e;g[7]=e;g[8]=e;break;default:return null}return g};c.prototype._buildRGBWCommand=function(a,d,e){var g=[49,0,0,7,255,255,0,0,0,255];g[9]=parseInt(a);switch(d){case "on":g[4]=3;g[5]=1;break;case "off":g[4]=3;g[5]=2;break;case "night":g[4]=3;g[5]=6;break;case "white":g[4]=3;g[5]=5;
break;case "speedUp":g[4]=3;g[5]=3;break;case "speedDown":g[4]=3;g[5]=4;break;case "mode":if(!g)return null;g[4]=4;g[5]=parseInt(e);break;case "brightness":g[4]=2;g[5]=parseInt(e);break;case "rgb":case "rgbS":if(!e||6>e.length)return null;a=parseInt(e.substr(0,2),16);d=parseInt(e.substr(2,2),16);e=parseInt(e.substr(4,2),16);e=xnm.aio.rgb.Util.rgbToHue(a,d,e);e=Math.min(Math.max(e,0),255);e=255-e-55;0>e&&(e=255+e);g[4]=1;g[5]=e;g[6]=e;g[7]=e;g[8]=e;break;default:return null}return g};c.prototype._buildRGBCommand=
function(a,d){var e=[49,0,0,5,255,255,0,0,0,1];switch(a){case "on":e[4]=2;e[5]=9;break;case "off":e[4]=2;e[5]=10;break;case "briUp":e[4]=2;e[5]=1;break;case "briDown":e[4]=2;e[5]=2;break;case "speedUp":e[4]=2;e[5]=3;break;case "speedDown":e[4]=2;e[5]=4;break;case "modeUp":e[4]=2;e[5]=5;break;case "modeDown":e[4]=2;e[5]=6;break;case "rgb":case "rgbS":if(!d||6>d.length)return null;a=parseInt(d.substr(0,2),16);var g=parseInt(d.substr(2,2),16);d=parseInt(d.substr(4,2),16);d=xnm.aio.rgb.Util.rgbToHue(a,
g,d);d=Math.min(Math.max(d,0),255);d=255-d-55;0>d&&(d=255+d);e[4]=1;e[5]=d;e[6]=d;e[7]=d;e[8]=d;break;default:return null}return e};c.prototype._buildWWCommand=function(a,d,e){e=[49,0,0,1,255,255,0,0,0,255];e[9]=parseInt(a);switch(d){case "on":e[4]=1;e[5]=7;break;case "off":e[4]=1;e[5]=8;break;case "night":e[4]=1;e[5]=6;break;case "briUp":e[4]=1;e[5]=1;break;case "briDown":e[4]=1;e[5]=2;break;case "briMax":e[4]=129;e[5]=7;break;case "warmer":e[4]=1;e[5]=3;break;case "cooler":e[4]=1;e[5]=4;break;default:return null}return e};
c.prototype.sendCommand=function(a,d){this._logger.log("trace","start send command");var e=this._packetBuffer.length;this._packetBuffer.push({command:a,callback:d});null!=this._session||this._sessionCreating?this._session&&0==e&&this._sendNextPacket():this._createSession()};c.prototype._buildPacket=function(a,d,e){var g=[128,0,0,0,17,255,255,0,255,0,255,255,255,255,255,255,255,255,255,255,0,255];g[5]=d[0];g[6]=d[1];g[8]=e;for(d=0;d<a.length;d++)g[10+d]=a[d];for(e=d=0;e<a.length;e++)d+=a[e];g[21]=
d&255;return new Buffer(g)};c.prototype._sendNextPacket=function(){if(0<this._packetBuffer.length){var a=this._packetBuffer[0];if(a){if(a.command){var d=this._buildPacket(a.command,this._session,this._seqNo++);this._logger.log("trace","send command:"+d.toString("hex"));f.sendPacket(d,this.ip,this.port)}a.callback&&a.callback()}this._packetBuffer.splice(0,1);this._sendNextPacket()}else this._sessionCreating=!1,this._session=this._sessionCreateTimeout=null,this._seqNo=-1};c.prototype._cancelAllPacket=
function(){var a=this._packetBuffer;this._packetBuffer=[];for(var d=0;d<a.length;d++){var e=a[d];e&&e.callback&&e.callback(Error("can not create session"))}};c.prototype._createSession=function(){if(!this._sessionCreating){this._sessionCreating=!0;var a=this,d=new Buffer([32,0,0,0,22,2,98,58,213,237,163,1,174,8,45,70,97,65,167,246,220,175,211,230,0,0,30]);this._logger.log("trace","start session:"+d.toString("hex"));f.sendPacket(d,this.ip,this.port);setTimeout(function(){a._sessionCreated(!1)},2E3)}};
c.prototype._sessionCreated=function(a){a?(this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._seqNo=0,this._sendNextPacket()):(this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._session=null,this._seqNo=-1,this._cancelAllPacket())};c.prototype.receiveData=function(a){this._logger.log("trace","receive ("+this.ip+") data:"+a.toString("hex"));
if(40==a[0]){this._session=[];for(var d=19;21>d;d++)this._session.push(a[d]);this._logger.log("trace","get session id:"+(new Buffer(this._session)).toString("hex"));this._sessionCreated(!0)}};c.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rgb.MiLightV6?this.ip==a.ip&&this.port==a.port:!1};c.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLightV6.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};c.parseJSON=function(a){if(!a.ip)return null;var d=new c(a.ip,a.port,a.uuid);return(a=
f.getBridge(a.ip))?a:d};c.init=function(){f.init()};return c}();
xnm.aio.rgb.MiLightV6.DM=function(){return{SYS:"milightv6",MAP:{wifi_box:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",
ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},ww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"max brightness",ref:{value:"briMax"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"warmer",ref:{value:"warmer"}},{type:"enum",name:"cooler",
ref:{value:"cooler"}}]},rgbww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"saturation",ref:{value:"saturation",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"kelvin",ref:{value:"kelvin",ext:"%d",extMeta:"2700-6500",scale:"18"}},{type:"string",
name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",
name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",
ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}}]}},registModule:function(f){f.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,
name:"Mi.Light iBox",port:5987}},getGatewayDeviceType:function(f){return f.sys==this.SYS?[{sys:this.SYS,type:"wifi_box",name:"WIFI Box"},{sys:this.SYS,type:"rgbww_cw",name:"RGBWW/CW Bulb"},{sys:this.SYS,type:"rgbw",name:"RGBW Bulb"},{sys:this.SYS,type:"rgb",name:"RGB Bulb"},{sys:this.SYS,type:"ww_cw",name:"WW/CW Bulb"}]:null},createGateway:function(f,b,c){b=xnm.aio.rgb.DMError;var a=xnm.aio.rgb.DMError.ERROR_CODE;f?f.ip?c(null,f):c(new b(a.INVALID,"ip is invalid")):c(new b(a.INVALID,"info is invalid"))},
updateGateway:function(f,b,c,a){f=xnm.aio.rgb.DMError;c=xnm.aio.rgb.DMError.ERROR_CODE;b?b.ip?a(null,b):a(new f(c.INVALID,"ip is invalid")):a(new f(c.INVALID,"update is invalid"))},deleteGateway:function(f,b,c){c()},createDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.gateway)if(null==f.type||"undefined"==typeof f.type)c(new a(d.INVALID,"type is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===
f.gateway){var g=b[e];break}g?c(null,f):c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"));else c(new a(d.INVALID,"gateway is invalid"));else c(new a(d.INVALID,"info is invalid"))},updateDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.gateway)if(null==f.type||"undefined"==typeof f.type)c(new a(d.INVALID,"type is invalid"));else{if("easy_rgbw"==f.type||"easy_white"==
f.type)if(null==f.address||"undefined"==typeof f.address){c(new a(d.INVALID,"address is invalid"));return}if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===f.gateway){var g=b[e];break}g?c(null,f):c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.NOT_FOUND,"gateway with index "+f.gateway+" not exists"))}else c(new a(d.INVALID,"gateway is invalid"));else c(new a(d.INVALID,"info is invalid"))},deleteDevice:function(f,
b,c){c()},getCommandStatusMap:function(f){return f?this.MAP[f.type]:null}}}();
xnm.aio.rgb.EasyLED=function(){var f=function(b,c,a){xnm.aio.rgb.MiLight.call(this,b,c,a);this._logger=(b=require("x.logger.js"))?b.getLogger("xnm.aio.rgb.EasyLED"):{log:function(){}}};f.prototype=Object.create(xnm.aio.rgb.MiLight.prototype);f.prototype.constructor=f;f.prototype.equalsTo=function(b){return b&&b instanceof f?this.ip==b.ip&&this.port==b.port:!1};f.prototype.toJSON=function(){return{sys:xnm.aio.rgb.EasyLED.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};f.parseJSON=function(b){return b.ip?
new f(b.ip,b.port,b.uuid):null};return f}();
xnm.aio.rgb.EasyLED.DM=function(){return{SYS:"easyled",registModule:function(f){f.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,name:"EasyLED Controller (WiFi)",port:8899}},getGatewayDeviceType:function(f){return f.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"Easy RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"Easy White Bulb"}]:null},createGateway:function(f,b,c){xnm.aio.rgb.MiLight.DM.createGateway(f,b,c)},updateGateway:function(f,b,c,a){xnm.aio.rgb.MiLight.DM.updateGateway(f,
b,c,a)},deleteGateway:function(f,b,c){xnm.aio.rgb.MiLight.DM.deleteGateway(f,b,c)},createDevice:function(f,b,c){xnm.aio.rgb.MiLight.DM.createDevice(f,b,c)},updateDevice:function(f,b,c){xnm.aio.rgb.MiLight.DM.updateDevice(f,b,c)},deleteDevice:function(f,b,c){xnm.aio.rgb.MiLight.DM.deleteDevice(f,b,c)},getCommandStatusMap:function(f){return xnm.aio.rgb.MiLight.DM.getCommandStatusMap(f)}}}();
xnm.aio.rgb.DMError=function(){var f=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};f.prototype=Error();f.prototype.name="RgbDmError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return f}();
xnm.aio.rgb.DM=function(){return{getGatewayType:function(){var f=[],b;for(b in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(b)){var c=xnm.aio.rgb[b];c&&c.DM&&c.DM.getGatewayType&&(c=c.DM.getGatewayType())&&f.push(c)}return f},getGatewayDeviceType:function(f){var b=[],c;for(c in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(c)){var a=xnm.aio.rgb[c];a&&a.DM&&a.DM.getGatewayDeviceType&&(a=a.DM.getGatewayDeviceType(f))&&(Array.isArray(a)?b=b.concat(a):b.push(a))}return b},getIPDeviceType:function(f,b){var c=
[],a;for(a in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(a)){var d=xnm.aio.rgb[a];d&&d.DM&&d.DM.getIPDeviceType&&(d=d.DM.getIPDeviceType(f,b))&&c.push(d)}return c},_getSystem:function(f){for(var b in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(b)){var c=xnm.aio.rgb[b];if(c&&c.DM&&c.DM.SYS&&c.DM.SYS==f)return c}return null},createGateway:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.sys){var e=this._getSystem(f.sys);e&&e.DM&&e.DM.createGateway?e.DM.createGateway(f,
b,c):c&&c(new a(d.INVALID,"no such sys:"+f.sys))}else c&&c(new a(d.INVALID,"sys is invalid"));else c&&c(new a(d.INVALID,"info is invalid"))},updateGateway:function(f,b,c,a){var d=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(b)if(b.sys){var g=this._getSystem(b.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(f,b,c,a):a&&a(new d(e.INVALID,"no such sys:"+b.sys))}else a&&a(new d(e.INVALID,"sys is invalid"));else a(new d(e.INVALID,"info is invalid"))},deleteGateway:function(f,b,c){var a=
xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.sys){var e=this._getSystem(f.sys);e&&e.DM&&e.DM.deleteGateway?e.DM.deleteGateway(f,b,c):c&&c(new a(d.INVALID,"no such sys:"+f.sys))}else c&&c(new a(d.INVALID,"sys is invalid"));else c()},createDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.sys){var e=this._getSystem(f.sys);e&&e.DM&&e.DM.createDevice?e.DM.createDevice(f,b,c):c&&c(new a(d.INVALID,"no such sys:"+f.sys))}else c&&c(new a(d.INVALID,
"sys is invalid"));else c&&c(new a(d.INVALID,"info is invalid"))},updateDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.sys){var e=this._getSystem(f.sys);e&&e.DM&&e.DM.updateDevice?e.DM.updateDevice(f,b,c):c&&c(new a(d.INVALID,"no such sys:"+f.sys))}else c&&c(new a(d.INVALID,"sys is invalid"));else c(new a(d.INVALID,"info is invalid"))},deleteDevice:function(f,b,c){var a=xnm.aio.rgb.DMError,d=xnm.aio.rgb.DMError.ERROR_CODE;if(f)if(f.sys){var e=this._getSystem(f.sys);
e&&e.DM&&e.DM.deleteDevice?e.DM.deleteDevice(f,b,c):c&&c(new a(d.INVALID,"no such sys:"+f.sys))}else c&&c(new a(d.INVALID,"sys is invalid"));else c()},applyUIFilter:function(f,b){var c=function(h,k){if("*"==h)return!0;for(var l=!1,t=0;t<h.length;t++)if(h[t]==k){l=!0;break}return l},a=function(h,k,l){var t=[];switch(l.catagory){case "command":h.command&&h.command.forEach(function(u){c(l.elems,u.type)&&(u=JSON.parse(JSON.stringify(u)),t.push(u))});break;case "status":h.status&&h.status.forEach(function(u){c(l.elems,
u.type)&&(u=JSON.parse(JSON.stringify(u)),t.push(u))})}return t},d=function(h,k){var l=[],t;if(h.sys){var u=this._getSystem(h.sys);u&&u.DM&&u.DM.getCommandStatusMap&&(t=u.DM.getCommandStatusMap(h))}t&&(h=a(t,h,k),l=l.concat(h));return l};if(!f.sys)return null;var e=JSON.parse(JSON.stringify(f)),g=null;switch(b.catagory){case "command":g=d.call(this,f,b);e.command=g;break;case "status":g=d.call(this,f,b);e.status=g;break;default:return null}return g&&0!=g.length?e:null}}}();
xnm.aio.rgb.Handler=function(){var f=function(){this._milightDiscovery=new xnm.aio.rgb.MiLight.Discovery;this.MiLightV6.init()};f.prototype.devicemanager=xnm.aio.rgb.DM;f.prototype.MiLight=xnm.aio.rgb.MiLight;f.prototype.MiLightV6=xnm.aio.rgb.MiLightV6;f.prototype.EasyLED=xnm.aio.rgb.EasyLED;f.prototype.registModule=function(b){for(var c in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(c)){var a=xnm.aio.rgb[c];a&&a.DM&&a.DM.registModule&&a.DM.registModule(b)}};f.prototype.resolveDevice=function(b){switch(b.sys){case xnm.aio.rgb.WiFiLED2.DM.SYS:return xnm.aio.rgb.WiFiLED2.parseJSON(b);
case xnm.aio.rgb.DMX4ALL.DM.SYS:return xnm.aio.rgb.DMX4ALL.parseJSON(b);case xnm.aio.rgb.ArtNetNode.DM.SYS:return xnm.aio.rgb.ArtNetNode.parseJSON(b);default:return null}};f.prototype.resolveGateway=function(b){switch(b.sys){case xnm.aio.rgb.MiLight.DM.SYS:return xnm.aio.rgb.MiLight.parseJSON(b);case xnm.aio.rgb.MiLightV6.DM.SYS:return xnm.aio.rgb.MiLightV6.parseJSON(b);case xnm.aio.rgb.EasyLED.DM.SYS:return xnm.aio.rgb.EasyLED.parseJSON(b);default:return null}};f.prototype.getDeviceCommands=function(b,
c){b=(b=xnm.aio.rgb.DM.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];c&&c(null,b)};f.prototype.doWifiLED2Command=function(b,c,a){(b=this.resolveDevice(b))?b.executeCommandCreator(null,c,function(d){a&&a(d)}):a&&a(Error("device json format invalid"))};f.prototype.doDMX4ALLCommand=function(b,c,a){(b=this.resolveDevice(b))?b.executeCommandCreator(null,c,function(d){a&&a(d)}):a&&a(Error("device json format invalid"))};f.prototype.discoverDMX4ALLWithTimeout=function(b,c){xnm.aio.rgb.DMX4ALL._discovery(b,
c)};f.prototype.doArtNetCommand=function(b,c,a){(b=this.resolveDevice(b))?b.executeCommandCreator(null,c,function(d){a&&a(d)}):a&&a(Error("device json format invalid"))};f.prototype.doMilightCommand=function(b,c,a,d){(b=this.resolveGateway(b))?b.executeCommandCreator(c,a,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};f.prototype.discoverMilightWithTimeout=function(b,c){this._milightDiscovery.discoverWithTimeout(b,function(a){c&&c(null,a)})};f.prototype.doEasyLEDCommand=function(b,
c,a,d){(b=this.resolveGateway(b))?b.executeCommandCreator(c,a,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};f.prototype.discoverEasyLEDWithTimeout=function(b,c){this._milightDiscovery.discoverWithTimeout(b,function(a){var d=[];if(a)for(var e=0;e<a.length;e++)a[e]&&d.push(new xnm.aio.rgb.EasyLED(a[e].ip,a[e].port,a[e].uuid));c&&c(null,d)})};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rgb.Handler);
