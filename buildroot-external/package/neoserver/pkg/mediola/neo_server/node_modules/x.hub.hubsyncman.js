var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.hubsyncman=x.hub.hubsyncman||{};x.hub.hubsyncman.Error=function(m,c){Error.call(this,m);this.code=c};util.inherits(x.hub.hubsyncman.Error,Error);
x.hub.hubsyncman.SyncManager=function(){var m=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.SyncManager");this._tenant2=this._tenant=null};m.prototype.init=function(c,b){this._logger.log("info","init hub sync managaer");var e=require("m.aio.configmanager.js");c=this._generateTenantParent(c);this._tenant=new e.Tenant(c);this._tenant.license="dummy";this._tenant.folder="db";this._tenant2=new e.Tenant(c);this._tenant2.license="dummy";this._tenant2.folder="db2";b&&b()};m.prototype.deploy=
function(c,b,e,a,f){var g=this;require("async").waterfall([function(d){g._writeZip(c,d)},function(d,l){var h=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),n=require("path"),k=require("fs-extra");h=n.resolve(h,"db");if(k.existsSync(h))try{var p=k.lstatSync(h);if(p.isDirectory(h)){var q=n.resolve(h,"device_db");k.existsSync(q)&&(p=k.lstatSync(q),p.isFile()||k.removeSync(q));var r=n.resolve(h,"macros_db");k.existsSync(r)&&(p=k.lstatSync(r),p.isFile()||k.removeSync(r))}else k.removeSync(h)}catch(t){}g._unzip(d,
l)},function(d){g._encryptDeviceDB(d)},function(d){require("x.hub.taskman.js").taskManager.clear();d()},function(d){require("x.hub.deviceman.js").deviceManager.reload(d)},function(d){require("x.hub.macroman.js").macroManager.reload(d)},function(d){require("x.hub.taskman.js").taskManager.reload(d)},function(d){require("x.hub.scriptman.js").scriptManager.reload(d)},function(d){localStorage.setItem("x.hub.hubsyncman.SyncManager.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager.USERID",
b);localStorage.setItem("x.hub.hubsyncman.SyncManager.APPID",e);a&&(localStorage.setItem("x.hub.m.gateway.DB1NeoIdx",a),require("x.hub.m.gateway.js").updateGatewayNeoIndex());d()}],function(d){f&&f(d)})};m.prototype._encryptDeviceDB=function(c){var b=require("path"),e=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),a=b.join(e,"db","device_db");b=b.join(e,"db2","device_db");this._encryptDeviceDBFileSync(a);this._encryptDeviceDBFileSync(b);c&&c()};m.prototype._encryptDeviceDBFileSync=
function(c){var b=require("fs"),e=require("x.crypt"),a=require("m.aio.devicemanager");try{if(b.existsSync(c)){this._logger.log("trace","[_encryptDeviceDB] Encrypting "+c);var f=b.readFileSync(c,"utf8");f&&(f=e.AES.encodeString(f,a.ml_v1_info()),b.writeFileSync(c+".enc",f),b.unlinkSync(c))}}catch(g){console.error(g),this._logger.log("error","[_encryptDeviceDB] "+g.message)}};m.prototype.deploy2=function(c,b,e,a,f){var g=this;require("async").waterfall([function(d){g._writeZip(c,d)},function(d,l){var h=
require("x.hub.fileman.js").fileManager.getUserRootDataPath(),n=require("path"),k=require("fs-extra");h=n.resolve(h,"db2");if(k.existsSync(h))try{var p=k.lstatSync(h);if(p.isDirectory(h)){var q=n.resolve(h,"device_db");k.existsSync(q)&&(p=k.lstatSync(q),p.isFile()||k.removeSync(q));var r=n.resolve(h,"macros_db");k.existsSync(r)&&(p=k.lstatSync(r),p.isFile()||k.removeSync(r))}else k.removeSync(h)}catch(t){}g._unzip(d,l)},function(d){g._encryptDeviceDB(d)},function(d){require("x.hub.deviceman.js").deviceManager2.reload(d)},
function(d){require("x.hub.macroman.js").macroManager2.reload(d)},function(d){localStorage.setItem("x.hub.hubsyncman.SyncManager2.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager2.USERID",b);localStorage.setItem("x.hub.hubsyncman.SyncManager2.APPID",e);a&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",a),require("x.hub.m.gateway.js").updateGatewayNeoIndex());d()}],function(d){f&&f(d)})};m.prototype._writeZip=function(c,b){var e=require("os"),a=require("fs"),f=
require("path"),g="nam_"+Math.round((new Date).getTime()/1E3)+".zip",d=f.join(e.tmpdir(),g);this._logger.log("trace","create temp deploy zip:"+d);e=a.createWriteStream(d);c.pipe(e);var l=b;e.on("error",function(h){l&&l(h);l=null});e.on("close",function(){l&&l(null,d);l=null})};m.prototype._unzip=function(c,b){var e=require("adm-zip"),a=require("x.hub.fileman.js").fileManager.getUserRootDataPath();require("path");var f=require("fs-extra");try{(new e(c)).extractAllTo(a,!0),b&&b()}catch(g){b&&b(g)}f.remove(c)};
m.prototype.writeFile=function(c,b,e){var a=this._tenant.getFolderPath(),f=require("path"),g=require("fs-extra"),d=a+f.sep+c,l=this;g.writeFile(d,b,function(h){h?(l._logger.log("warn","write file:"+d+" error:"+h.message),e&&e(h)):require("x.hub.deviceman.js").deviceManager.reload(function(n){n?(l._logger.log("warn","reload device error:"+n.message),e&&e(n)):require("x.hub.macroman.js").macroManager.reload(function(k){k&&l._logger.log("warn","reload macro error:"+k.message);e&&e(k)})})})};m.prototype.writeFile2=
function(c,b,e,a){var f=this._tenant2.getFolderPath(),g=require("path"),d=require("fs-extra"),l=f+g.sep+c,h=this;d.writeFile(l,b,function(n){n?(h._logger.log("warn","write file:"+l+" error:"+n.message),a&&a(n)):("device_db"==c&&h._encryptDeviceDBFileSync(l),require("x.hub.deviceman.js").deviceManager2.reload(function(k){k?(h._logger.log("warn","reload device error:"+k.message),a&&a(k)):require("x.hub.macroman.js").macroManager2.reload(function(p){p&&h._logger.log("warn","reload macro error:"+p.message);
e&&"device_db"==c&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",e),require("x.hub.m.gateway.js").updateGatewayNeoIndex());a&&a(p)})}))})};m.prototype._generateTenantParent=function(c){return{fileManager:c,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return m}();
x.hub.hubsyncman.Handler=function(){var m=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.Handler");this.syncManager=new x.hub.hubsyncman.SyncManager};m.prototype.SyncManager=x.hub.hubsyncman.SyncManager;m.prototype.init=function(c,b,e){"CA"==global.HARDWARE_VERSION?this._configNew(c):this._config(c);this.syncManager.init(b,e)};m.prototype._configNew=function(c){var b=this;c=require("x.hub.js").getServer();c.addRoute("/xhub/xhubsync/upload2",{method:"POST"},function(e,a){var f=
e.query.fileName;f?b.syncManager.writeFile2(f,e.body,e.query.gatewayid,function(g){a.send(b._toRestfulResponse(g,"ok"))}):a.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))});c.addRoute("/xhub/xhubsync/deploy2",{method:"POST",source:1,body:"stream"},function(e,a){var f=e.query.userid;f?b.syncManager.deploy2(e,f,e.query.appid,e.query.gatewayid,function(g){a.send(b._toRestfulResponse(g,"ok"))}):a.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))});c.addRoute("/xhub/xhubsync/upload",
{method:"POST"},function(e,a){var f=e.query.fileName;f?b.syncManager.writeFile(f,e.body,function(g){a.send(b._toRestfulResponse(g,"ok"))}):a.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))});c.addRoute("/xhub/xhubsync/deploy",{method:"POST",source:1,body:"stream"},function(e,a){var f=e.query.userid;f?b.syncManager.deploy(e,f,e.query.appid,e.query.gatewayid,function(g){a.send(b._toRestfulResponse(g,"ok"))}):a.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))})};
m.prototype._config=function(c){var b=this,e=require("body-parser");c.use("/xhub/xhubsync/",function(a,f,g){var d=require("x.hub.js").server,l=!0;if(d._pwd&&0<d._pwd.length){l=!1;if(!a.query.at&&a.query.auth){var h=require("x.crypt.js");a.query.at=h.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))}a.query.at&&a.query.at==d._pwd&&(l=!0)}l?g():f.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')});c.use("/xhub/xhubsync/upload",e.text({limit:"50mb"}));c.post("/xhub/xhubsync/upload",function(a,
f){var g=a.query.fileName;g?b.syncManager.writeFile(g,a.body,function(d){f.send(b._toRestfulResponse(d,"ok"))}):f.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));c.post("/xhub/xhubsync/deploy",function(a,f){var g=a.query.userid;g?this.syncManager.deploy(a,g,a.query.appid,a.query.gatewayid,function(d){f.send(b._toRestfulResponse(d,"ok"))}):f.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this));c.use("/xhub/xhubsync/upload2",e.text({limit:"50mb"}));
c.post("/xhub/xhubsync/upload2",function(a,f){var g=a.query.fileName;g?b.syncManager.writeFile2(g,a.body,a.query.gatewayid,function(d){f.send(b._toRestfulResponse(d,"ok"))}):f.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));c.post("/xhub/xhubsync/deploy2",function(a,f){var g=a.query.userid;g?this.syncManager.deploy2(a,g,a.query.appid,a.query.gatewayid,function(d){f.send(b._toRestfulResponse(d,"ok"))}):f.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this))};
m.prototype._toRestfulResponse=function(c,b){return c?{status:"fail",message:c.message,code:c.code?c.code:0}:{status:"success",data:b}};return m}();module.exports=new x.hub.hubsyncman.Handler;
