var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.openhab=xnm.aio.openhab||{};
xnm.aio.openhab.Server=function(){var f=function(a){if(!a)throw Error("No server information given.");this._logger="undefined"===typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.openhab.Server");this.ip=a.ip;this.port=a.port;this.port||(this.port=8080);this.timeout=1E4};f.prototype.executeCommandCreator=function(a,b,c){if(a&&a.address)if(b&&b.value){switch(b.value){case "on":b="ON";break;case "off":b="OFF";break;case "toggle":b="TOGGLE";break;default:c&&c(Error("No such command."));
return}this._sendItemCommand(a.address,b,c)}else c&&c(Error("Command JSON format invalid."));else c&&c(Error("Device JSON format invalid."))};f.prototype.getStatesCreator=function(a,b,c){var d=this;this.getStates(function(e,g){e=[];for(var h=0;h<b.length;h++)if(b[h]&&b[h].id){var k="?";if(g&&b[h].status&&b[h].status.value&&b[h].device&&b[h].device.address){var l=b[h].status.value,q=b[h].device.address;g[q]&&(k=(k=d._toState(b[h].device,g[q]))?k[l]:null,"undefined"===typeof k||null==k)&&(k="?")}e.push({id:b[h].id,
status:k})}c&&c(null,e)})};f.prototype.getDevices=function(a){var b=this;this._listItems(null,function(c,d){if(c)a&&a(c);else{c=[];if(d)for(var e=0;e<d.length;e++){var g=d[e];g&&(g=b._toDevice(g))&&c.push(g)}a&&a(null,c)}})};f.prototype.getStates=function(a){this._listItems({recursive:!0,fields:"name,state"},function(b,c){if(b)a&&a(b);else{b={};if(c)for(var d=0;d<c.length;d++){var e=c[d];e.name&&(b[e.name]=e)}a&&a(null,b)}})};f.prototype._toDevice=function(a){var b=null;switch(a.type){case "Switch":b=
{sys:"openhab",type:"switch",address:a.name,data:a.type,stateDescription:a.stateDescription}}return b};f.prototype._toState=function(a,b){var c=null;"switch"===a.type?"Switch"===a.data&&(c={state:b.state.toLowerCase()}):"contact"===a.type&&"Switch"===a.data&&(c={state:"ON"==b.state?"open":"closed"});return c};f.prototype._sendItemCommand=function(a,b,c){this._callRestAPI("POST","/items/"+a,b,function(d,e){c&&c(d,e)})};f.prototype._listItems=function(a,b){var c="/items";if(a){c+="?";for(var d in a)c+=
d+"="+encodeURIComponent(a[d]),c+="&";"&"===c[c.length-1]&&(c=c.substring(0,c.length-1))}this._callRestAPI("GET",c,null,function(e,g){b&&b(e,g)})};f.prototype._callRestAPI=function(a,b,c,d){var e=null;c&&(e="string"===typeof c?c:JSON.stringify(c));this._doRequest(a,"/rest"+b,e,function(g,h,k){if(g)d&&d(g);else if(200!=h)d&&d(Error("HTTP error: "+h));else try{d&&d(null,k?JSON.parse(k):null)}catch(l){d&&d(l)}})};f.prototype._doRequest=function(a,b,c,d){this._logger.log("trace","Sending "+a+" to URL: http://"+
(this.ip+":"+this.port+b));c&&this._logger.log("trace","... with data: "+c);a={host:this.ip,port:this.port,path:b,method:a,headers:{"User-Agent":"mediola",Connection:"close"}};c&&(a.headers["Content-Length"]=c.length);var e=this,g=d;d=require("http").request(a,function(h){var k="";h.setEncoding("utf-8");h.on("data",function(l){k+=l});h.on("end",function(){e._logger.log("trace","Received response (status code: "+h.statusCode+"): "+k);g&&(g(null,h.statusCode,k),g=null)})});d.setTimeout(this.timeout,
function(){e._logger.log("error","HTTP request timeout ("+e.timeout+" ms).");g&&(g(Error("timeout")),g=null)});d.on("error",function(h){e._logger.log("error","HTTP request error: "+h.message);g&&(g(h),g=null)});c&&d.write(c);d.end()};f.prototype.toJSON=function(){return{sys:"openhab",ip:this.ip,port:this.port}};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip===a.ip&&this.port===a.port:!1};return f}();
xnm.aio.openhab.DM=function(){var f=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};f.prototype=Error();f.prototype.name="OpenHABDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"openhab",MAP:{switch:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]},contact:{status:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"openHAB Server",port:8080}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}]},createGateway:function(a,b,c){b=f.ERROR_CODE;a?a.ip?c(null,
a):c(new f(b.INVALID,"ip is invalid")):c(new f(b.INVALID,"info is invalid"))},updateGateway:function(a,b,c,d){a=f.ERROR_CODE;b?b.ip?d(null,b):d(new f(a.INVALID,"ip is invalid")):d(new f(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var g=b[e];break}g?c(null,a):c(new f(d.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"))}else c(new f(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new f(d.INVALID,"address is invalid"));else c(new f(d.INVALID,"gateway is invalid"));else c(new f(d.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var g=b[e];break}g?c(null,a):c(new f(d.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"))}else c(new f(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new f(d.INVALID,"address is invalid"));else c(new f(d.INVALID,"gateway is invalid"));else c(new f(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(l,q){if("*"==l)return!0;for(var m=!1,n=0;n<l.length;n++)if(l[n]==q){m=!0;break}return m},e=function(l,q,m){var n=[];switch(m.catagory){case "command":l.command&&
l.command.forEach(function(p){d(m.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))});break;case "status":l.status&&l.status.forEach(function(p){d(m.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))})}return n},g=function(l,q){var m=[],n=c.getCommandStatusMap(l);n&&(l=e(n,l,q),m=m.concat(l));return m};if(!a||null==a.type||"undefined"==typeof a.type)return null;var h=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=g(a,b);h.command=k;break;case "status":k=
g(a,b);h.status=k;break;default:return null}return k&&0!=k.length?h:null},applyIPEventFilter:function(a,b){if(!a.sys)return null;b=this.getCommandStatusMap(a);if(!b)return null;a=JSON.parse(JSON.stringify(a));a.ipevt=b.ipevt;return a},getCommandStatusMap:function(a){var b=this.MAP[a.type];a&&a.stateDescription&&1==a.stateDescription.readOnly&&(b=JSON.parse(JSON.stringify(b)),delete b.command);return b}}}();
xnm.aio.openhab.Handler=function(){var f=function(){};f.prototype.devicemanager=xnm.aio.openhab.DM;f.prototype.Server=xnm.aio.openhab.Server;f.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"openhab")};f.prototype.resolveGateway=function(a){return a&&a.ip?new this.Server(a):null};f.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};f.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,
{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};f.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};f.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(g,h){g?e&&e(g):e&&e(null,h[0])}):e&&e(Error("gateway json format invalid"))};f.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(c,
d){b&&b(c,d)}):b&&b(Error("gateway json format invalid"))};f.prototype.discover=function(a,b){var c=require("x.mdns.js");c.clearRecordBuffer();var d=this,e={};c.discoverServiceWithTimeout("_openhab-server._tcp.local",a,function(g,h){if(g)b&&b(g);else{for(g=0;g<h.length;g++){var k=h[g];k.target&&k.ip&&0<k.ip.length&&(k=k.ip[0],e[k]||(e[k]=new d.Server({ip:k})))}h=[];for(var l in e)h.push(e[l]);b&&b(null,h)}})};return f}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.openhab.Handler);
