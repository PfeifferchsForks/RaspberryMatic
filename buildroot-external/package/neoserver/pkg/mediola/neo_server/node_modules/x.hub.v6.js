var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(k){var c=0;return function(){return c<k.length?{done:!1,value:k[c++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,c,e){if(k==Array.prototype||k==Object.prototype)return k;k[c]=e.value;return k};$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<k.length;++c){var e=k[c];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,c){var e=$jscomp.propertyToPolyfillSymbol[c];if(null==e)return k[c];e=k[e];return void 0!==e?e:k[c]};
$jscomp.polyfill=function(k,c,e,g){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,c,e,g):$jscomp.polyfillUnisolated(k,c,e,g))};$jscomp.polyfillUnisolated=function(k,c,e,g){e=$jscomp.global;k=k.split(".");for(g=0;g<k.length-1;g++){var h=k[g];if(!(h in e))return;e=e[h]}k=k[k.length-1];g=e[k];c=c(g);c!=g&&null!=c&&$jscomp.defineProperty(e,k,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(k,c,e,g){var h=k.split(".");k=1===h.length;g=h[0];g=!k&&g in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var a=0;a<h.length-1;a++){var b=h[a];if(!(b in g))return;g=g[b]}h=h[h.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?g[h]:null;c=c(e);null!=c&&(k?$jscomp.defineProperty($jscomp.polyfills,h,{configurable:!0,writable:!0,value:c}):c!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[h]&&(e=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[h]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(h):$jscomp.POLYFILL_PREFIX+e+"$"+h),$jscomp.defineProperty(g,$jscomp.propertyToPolyfillSymbol[h],{configurable:!0,writable:!0,value:c})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(k){if(k)return k;var c=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};c.prototype.toString=function(){return this.$jscomp$symbol$id_};var e="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",g=0,h=function(a){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new c(e+(a||"")+"_"+g++,a)};return h},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(k){if(k)return k;k=Symbol("Symbol.iterator");for(var c="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<c.length;e++){var g=$jscomp.global[c[e]];"function"===typeof g&&"function"!=typeof g.prototype[k]&&$jscomp.defineProperty(g.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return k},"es6",
"es3");$jscomp.iteratorPrototype=function(k){k={next:k};k[Symbol.iterator]=function(){return this};return k};$jscomp.iteratorFromArray=function(k,c){k instanceof String&&(k+="");var e=0,g=!1,h={next:function(){if(!g&&e<k.length){var a=e++;return{value:c(a,k[a]),done:!1}}g=!0;return{done:!0,value:void 0}}};h[Symbol.iterator]=function(){return h};return h};$jscomp.polyfill("Array.prototype.keys",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");
$jscomp.checkStringArgs=function(k,c,e){if(null==k)throw new TypeError("The 'this' value for String.prototype."+e+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+e+" must not be a regular expression");return k+""};
$jscomp.polyfill("String.prototype.startsWith",function(k){return k?k:function(c,e){var g=$jscomp.checkStringArgs(this,c,"startsWith");c+="";var h=g.length,a=c.length;e=Math.max(0,Math.min(e|0,g.length));for(var b=0;b<a&&e<h;)if(g[e++]!=c[b++])return!1;return b>=a}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.v6=x.hub.v6||{};
x.hub.v6.API=function(){var k=function(c){this._version="v1";this._handler=c};k.prototype.init=function(c,e){var g=this;c.addRoute("/api/"+this._version+"/command",function(h,a){g._handler.command(h.body,function(b,d){a.json(g._buildResponseJSON(b,d))})});c.addRoute("/api/"+this._version+"/state",function(h,a){g._handler.state(h.query,function(b,d){a.json(g._buildResponseJSON(b,d))})});e&&e()};k.prototype.handleTunnelReuqest=function(c,e){var g=c.pathname.split("/"),h=this;"state"==g[3]?this._handler.state(c.query,
function(a,b){e&&e(h._buildResponseJSON(a,b))}):"command"==g[3]?this._handler.command(c.body,function(a,b){e&&e(h._buildResponseJSON(a,b))}):e&&e(h._buildResponseJSON(Error("invalid request")))};k.prototype._buildResponseJSON=function(c,e){if(c){for((e=c.code+"")||(e="0");6>e.length;)e="0"+e;return{XC_ERR:{code:e,msg:c.message}}}return{XC_SUC:e?e:{}}};return{V1:k}}();
x.hub.v6.CentralUnit=function(){var k=function(c){this._api=new x.hub.v6.API.V1(this);this._server=c};k.prototype.init=function(c){this._api.init(this._server,c)};k.prototype.handleTunnelReuqest=function(c,e){this._api.handleTunnelReuqest(c,e)};k.prototype.command=function(c,e){};k.prototype.state=function(c,e){c&&"true"==c.force?this._updatesStates(c,e):e&&e(null,null)};k.prototype._updatesStates=function(c,e){c&&c.id?this._getStates(c.id,function(g,h){g?e&&e(g):h?(g={},g[c.id]={},c.key?g[c.id][c.key]=
h[c.key]:g[c.id]=h,e&&e(null,g)):e&&e(null,{})}):this._updateStatesAll(c.timeout,e)};k.prototype._updateStatesAll=function(c,e){c&&(c*=1E3);require("x.hub.commandman.js").commandHandler2.updateGeneralDeviceStates(c,e)};k.prototype._updateStates=function(c,e){require("x.hub.deviceman.js").deviceManager2.toGeneralDevice(c,function(g,h){if(g)e&&e(g);else if(h)if(h.states&&h.details&&h.details.states){g=[];for(var a in h.details.states){var b=h.details.states[a];b&&b.value&&g.push({id:a,value:b.value})}0==
g.length?e&&e(null,null):require("x.hub.commandman.js").commandHandler2.getStatesWithIdx(c,null,g,function(d){d&&d.data?e&&e(null,d.data):e&&e(Error("get device states error"))})}else e&&e(null,null);else e&&e(Error("can not find general device"))})};return k}();
x.hub.v6.Time=function(){var k=function(c){this._logger=require("x.logger.js").getLogger("x.hub.v6.Time");this._handler=c;this._writeRTCInterval=null;this._tz=k.DEFAULT_TZ;this._timezone=k.DEFAULT_TTIMEZONE;this._ntpServers=["0.de.pool.ntp.org","1.de.pool.ntp.org","2.de.pool.ntp.org","3.de.pool.ntp.org"]};k.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,
zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},
{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},
{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},
{utc:-11,dst:!0,zone:"Etc/GMT+11"}];k.DEFAULT_TZ="21";k.DEFAULT_TTIMEZONE="Europe/Berlin";k.TIMEZONE_SCRIPT="/etc/init.d/S00settimezone";k.TIMEZONE_CONF="/etc/timezone";k.NTP_SCRIPT="/etc/init.d/S49ntp";k.NTP_CONF="/etc/ntp.conf";k.WRITE_RTC_PERIOD=6E5;k.prototype.init=function(c){global.SYSTEM_ROOT&&(k.TIMEZONE_SCRIPT=SYSTEM_ROOT+k.TIMEZONE_SCRIPT,k.TIMEZONE_CONF=SYSTEM_ROOT+k.TIMEZONE_CONF,k.NTP_CONF=SYSTEM_ROOT+k.NTP_CONF,k.NTP_SCRIPT=SYSTEM_ROOT+k.NTP_SCRIPT);var e=this;if(localStorage){var g=
localStorage.getItem("x.hub.Server.timezone");g&&(e._tz=g)}this._writeRTCInterval=setInterval(function(){var h=Math.round((new Date).getTime()/1E3);e._writeTimeToRTC(h)},k.WRITE_RTC_PERIOD);this._readNTPConf(function(){e._readTimezoneConf(function(){c&&c()})})};k.prototype.getNTPServers=function(c){c&&c(null,this._ntpServers)};k.prototype.setNTPServers=function(c,e){if(c&&c.length){var g=c.filter(function(a){return!!a});if(g&&g.length){var h=this;this._handler._sysConf.setValue("NTP",g.join(","),
function(a){a?e&&e(a):h._restartNTPD(function(b){b?e&&e(b):(h._ntpServers=g,e&&e())})})}else e&&e(Error("invalid ntp servers"))}else e&&e(Error("invalid ntp servers"))};k.prototype.getTimezoneSync=function(){return this._decodeTimeZone(this._tz)};k.prototype.getTimezoneEncoded=function(c){c&&c(null,this._tz)};k.prototype.setTimezoneEncoded=function(c,e){if(c){var g=this._decodeTimeZone(c);if(g){var h=this;this._handler._sysConf.setValue("TZ",g,function(a){a?e&&e(a):h._reloadTimeZone(function(b){b?
e&&e(b):(localStorage&&localStorage.setItem("x.hub.Server.timezone",c),h._tz=c,h._timezone=g,h._handler._stm.sendCommand(16,"XC_FNC=setTZ&data="+c,function(d){e&&e(d?d.error:null)}))})})}else e&&e(Error("invalid timezone"))}else e&&e(Error("invalid timezone"))};k.prototype.setTime=function(c,e){if(c){var g=c.year,h=c.month+"";1==h.length&&(h="0"+h);var a=c.date+"";1==a.length&&(a="0"+a);var b=c.hour+"";1==b.length&&(b="0"+b);c=c.minute+"";1==c.length&&(c="0"+c);var d=this;this._logger.log("trace",
"set system time: "+g+"-"+h+"-"+a+" "+b+":"+c);this._setSystemTime({year:g,month:h,date:a,hour:b,minute:c},function(f){d._logger.log("trace","set system time "+(f?"failed:"+f.message:"success"));f?e&&e(f):(f=new Date,f=Math.round(f.getTime()/1E3),d._logger.log("trace","set stm time: "+f),d._writeTimeToRTC(f,function(l){d._logger.log("trace","set stm time "+(l?"failed:"+l.message:"success"));e&&e(l)}))})}else e&&e(Error("invalid time"))};k.prototype.restore=function(c,e,g){this._logger.log("trace",
"restore timezone");var h=require("fs"),a=null,b=this,d=function(){if(!a)a=k.DEFAULT_TZ;else if(e&&"v5+"==e.backupType){a=parseInt(a,16);var l=(a&31)-11;a=0!=(a&128)?32:0;0>l&&(a|=16,l=0-l);a|=l&15;a=a.toString(16);2>a.length&&(a="0"+a);b._logger.log("trace","convert v5+ timezone to v6+ format: "+a);try{b._logger.log("trace","overwrite v6+ format tz to "+f),h.writeFileSync(f,a.toUpperCase())}catch(m){b._logger.log("trace","overwrite v6+ format tz to "+f+" failed:"+m.message)}}b.setTimezoneEncoded(a,
g)},f=require("path").join(c,"data","localstorage","x.hub.Server.timezone");h.existsSync(f)?(this._logger.log("trace","read timezone from backup file: "+f),h.readFile(f,{encoding:"utf8"},function(l,m){b._logger.log("trace","read timezone from backup file"+(l?" failed:"+l.message:" success:"+m));!l&&m&&(a=m);d()})):d()};k.prototype._setSystemTime=function(c,e){if("PI-CM3+"!=global.PLATFORM)e&&e();else{c="date +%Y%m%d%H%M -s "+(c.year+c.month+c.date+c.hour+c.minute);var g=require("child_process").exec;
c=g(c);c.on("error",function(h){e&&(e(h),e=null)});c.on("close",function(h){e&&(e(0==h?null:Error("set system time failed")),e=null)})}};k.prototype._restartNTPD=function(c){var e=require("child_process").exec;e=e(k.NTP_SCRIPT+" restart");e.stdout.on("data",function(g){console.log(String(g))});e.on("error",function(g){c&&(c(g),c=null)});e.on("close",function(g){c&&(c(0==g?null:Error("restart ntpd failed")),c=null)})};k.prototype._readNTPConf=function(c){var e=this;require("fs").readFile(k.NTP_CONF,
{encoding:"utf8"},function(g,h){if(!g&&h){g=[];h=h.split("\n");for(var a=0;a<h.length;a++){var b=h[a].trim();b&&"server"==b.substr(0,6)&&(b=b.split(" "),2<=b.length&&b[1]&&-1==g.indexOf(b[1])&&g.push(b[1]))}e._ntpServers=g}c()})};k.prototype._readTimezoneConf=function(c){var e=this;require("fs").readFile(k.TIMEZONE_CONF,{encoding:"utf8"},function(g,h){!g&&h&&(e._timezone=h.trim());c()})};k.prototype._decodeTimeZone=function(c){c=parseInt(c,16);var e=0!=(c&32),g=c&15;c&16&&(g=0-g);c&64&&(g-=.5);var h=
null;k.TimeZone_MAP.forEach(function(a){a.utc==g&&a.dst==e&&(h=a.zone)});return h};k.prototype._reloadTimeZone=function(c){var e=require("child_process").exec;e=e(k.TIMEZONE_SCRIPT+" reload");var g=this;e.stdout.on("data",function(h){g._logger.log("trace","_reloadTimeZone:"+String(h))});e.on("error",function(h){c&&(c(h),c=null)});e.on("close",function(h){c&&(c(0==h?null:Error("reload timezone failed")),c=null)})};k.prototype._writeTimeToRTC=function(c,e){var g=new Buffer(4);g.writeInt32BE(c);var h=
this;this._logger.log("trace","write time "+c+" to stm "+g.toString("hex"));this._handler._stm.sendCommand(55,g,function(a){h._logger.log("trace","write time to stm "+(a&&a.error?" failed:"+a.error:" success"));e&&e(a?a.error:null,a?a.data:null)})};return k}();
x.hub.v6.Network=function(){var k={calculate:function(a,b){var d=[];try{var f=this.toDecimal(a);var l=this.toDecimal(b)}catch(m){return null}if(l<f)return null;for(a=f;a<=l;){a=this.getOptimalRange(a,l);if(null===a)return null;d.push(a);a=a.ipHigh+1}return d},calculateSubnetMask:function(a,b){try{var d=this.toDecimal(a)}catch(f){return null}return this.getMaskRange(d,b)},calculateCIDRPrefix:function(a,b){var d=0;try{var f=this.toDecimal(a);var l=this.toDecimal(b)}catch(m){return null}for(a=0;32>a&&
(d=d+(1<<32-(a+1))>>>0,(l&d)>>>0===d);a++);return this.getMaskRange(f,a)},getOptimalRange:function(a,b){var d,f=null;for(d=32;0<=d;d--){var l=this.getMaskRange(a,d);if(l.ipLow===a&&l.ipHigh<=b)f=l;else break}return f},getMaskRange:function(a,b){var d=this.getPrefixMask(b),f=this.getMask(32-b),l=(a&d)>>>0;a=((a&d)>>>0)+f>>>0;return{ipLow:l,ipLowStr:this.toString(l),ipHigh:a,ipHighStr:this.toString(a),prefixMask:d,prefixMaskStr:this.toString(d),prefixSize:b,invertedMask:f,invertedMaskStr:this.toString(f),
invertedSize:32-b}},getPrefixMask:function(a){var b=0,d;for(d=0;d<a;d++)b+=1<<32-(d+1)>>>0;return b},getMask:function(a){var b=0,d;for(d=0;d<a;d++)b+=1<<d>>>0;return b},isIp:function(a){if("string"!==typeof a)return!1;a=a.match(/^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/);if(null===a)return!1;for(var b=1;4>=b;b++){var d=parseInt(a[b],10);if(255<d||0>d)return!1}return!0},isDecimalIp:function(a){return"number"===typeof a&&0===a%1&&0<=a&&4294967295>=a},toDecimal:function(a){if("number"===
typeof a&&!0===this.isDecimalIp(a))return a;if(!1===this.isIp(a))throw Error("Not an IP address: "+a);a=a.split(".");return 256*(256*(256*+a[0]+ +a[1])+ +a[2])+ +a[3]},toString:function(a){if("string"===typeof a&&!0===this.isIp(a))return a;if(!1===this.isDecimalIp(a))throw Error("Not a numeric IP address: "+a);for(var b=a%256,d=3;0<d;d--)a=Math.floor(a/256),b=a%256+"."+b;return b}},c=function(a){this._file=a;this._file||(this._file=c.FILE);this._globalOptions=[];this._interfaceOptions={}};c.FILE=
"/etc/dhcpcd.conf";c.prototype.init=function(a){this._read(function(b){a&&a(b)})};c.prototype.getConfig=function(a){var b={dhcp:!0};if(!this._interfaceOptions||!this._interfaceOptions[a])return b;a=this._interfaceOptions[a];for(var d=0;d<a.length;d++){var f=a[d];if(f&&"static"==f.substr(0,6)){b.dhcp=!1;f=f.substr(6).trim();var l=f.indexOf("=");if(-1!=l){var m=f.substr(0,l);f=f.substr(l+1);switch(m){case "ip_address":m=f.split("/");1==m.length?(b.ip=m[0],b.subnet="255.255.255.0"):(f=k.calculateSubnetMask(m[0],
parseInt(m[1])),b.ip=m[0],b.subnet=f.prefixMaskStr);break;case "routers":b.router=f.split(" ");break;case "domain_name_servers":b.dns=f.split(" ")}}}}return b};c.prototype.setConfig=function(a,b,d){if(a&&b)if(b.dhcp||b.ip&&b.subnet&&b.router&&b.dns){if(b.dhcp)delete this._interfaceOptions[a];else{var f=k.calculateSubnetMask(b.ip,b.subnet);if(!f){d&&d(Error("invalid argument"));return}this._interfaceOptions[a]=["static ip_address="+b.ip+"/"+f.prefixSize,"static routers="+(Array.isArray(b.router)?b.router.join(" "):
b.router),"static domain_name_servers="+(Array.isArray(b.dns)?b.dns.join(" "):b.dns)]}this._write(function(l){d&&d(l)})}else d&&d(Error("invalid argument"));else d&&d(Error("invalid argument"))};c.prototype._read=function(a){var b=this;require("fs").readFile(this._file,{encoding:"utf8"},function(d,f){if(d)a(d);else{if(f){d=f.split("\n");f=null;for(var l=0;l<d.length;l++){var m=d[l].trim();m&&"#"!=m.charAt(0)&&(m=m.trim(),"interface"==m.substr(0,9)?f=m.substr(9).trim():f?(b._interfaceOptions[f]||(b._interfaceOptions[f]=
[]),b._interfaceOptions[f].push(m)):b._globalOptions.push(m))}}a()}})};c.prototype._write=function(a){var b="";this._globalOptions.forEach(function(m){b+=m+"\n\n"});for(var d in this._interfaceOptions){b+="interface "+d+"\n";for(var f=this._interfaceOptions[f],l=0;l<f.length;l++)b+="  "+f[l]+"\n";b+="\n"}require("fs").writeFile(this._file,b,function(m){a(m)})};var e=function(a){this._file=a;a||(this._file=e.FILE)};e.FILE="/etc/resolv.conf";e.prototype.getDns=function(a){require("fs").readFile(this._file,
{encoding:"utf8"},function(b,d){if(b)a&&a(b);else{b=[];d=d.split("\n");for(var f=0;f<d.length;f++){var l=d[f].trim();"#"!=l.charAt(0)&&"nameserver"==l.substr(0,10)&&(l=l.substr(10).trim(),b.push(l))}a&&a(null,b)}})};var g=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network.Wifi");this._file=a;a||(this._file=g.FILE);this._networks=[];this._wpaSocket=null;this._state=-2;this._initFinish=!1;this._scanCallback=null;this._scanTimeout=2E4;this._scanTo=null};g.FILE="/config/wpa_supplicant.conf";
g.SOCKET_PATH="/var/run/wpa_supplicant";g.prototype.init=function(a){var b=this;this._read(function(d,f){b._initFinish=!0;!d&&f&&(b._networks=f);a&&a(d);0==b._state&&b._checkInitWifiStatus()})};g.prototype.getFile=function(){return this._file};g.prototype.reset=function(a){this._logger.log("trace","reset");var b=this;this._networks=[];this._write(function(d){b._logger.log("trace","reset "+(d?" failed: "+d.message:"success"));a&&a(d)})};g.prototype.restore=function(a,b){this._logger.log("trace","restore from:"+
a);var d=require("fs"),f=require("fs-extra");try{d.existsSync(a+"/config/wpa_supplicant.conf")&&f.copySync(a+"/config/wpa_supplicant.conf",this._file),this._logger.log("trace","restore success"),b&&b()}catch(l){this._logger.log("trace","restore failed: "+l.message),b&&b(l)}};g.prototype.backup=function(a,b){this._logger.log("trace","backup to:"+a);var d=this;require("fs-extra").copy(this._file,a+"/config/wpa_supplicant.conf",function(f){d._logger.log("trace","backup "+(f?"failed: "+f.message:"success"));
b&&b(f)})};g.prototype.info=function(a,b){this._logger.log("trace","get wifi info");if(this._wpaSocket)if(0!=this._state)b&&b(Error("current state not idle:"+this._state));else{var d=this,f={};this._status(function(l,m){l?b&&b(l):(f.status={connected:!1},m&&("COMPLETED"==m.wpa_state&&(f.status.connected=!0),m.ssid&&(f.status.ssid=m.ssid)),f.networks=d._networks.map(function(n){var p=n.ssid;'"'==p.charAt(0)?(p=p.substr(1),'"'==p.charAt(p.length-1)&&(p=p.substr(0,p.length-1))):p=(new Buffer(n.ssid,
"hex")).toString("utf8");return{ssid:p}}),f.status.connected?d._signalPoll(function(n,p){!n&&p&&(f.status.rssi=parseInt(p.RSSI));b&&b(null,f)}):b&&b(null,f))})}else b&&b(Error("wlan not exist"))};g.prototype.scan=function(a,b){this._logger.log("trace","scan wifi on "+a);if(this._wpaSocket)if(0!=this._state)b&&b(Error("current state not idle:"+this._state));else{var d=this;this._state=1;this._scanCallback=b;this._scan(function(f){f?(d._state=0,d._scanCallback=null,b&&b(f)):d._scanTo=setTimeout(function(){d._logger.log("trace",
"scan wifi timeout");d._state=0;d._scanTo=null;d._scanCallback&&(d._scanCallback(Error("scan wifi timeout")),d._scanCallback=null)},d._scanTimeout)})}else b&&b(Error("wlan not exist"))};g.prototype.connect=function(a,b,d){if(a&&b&&b.ssid&&b.password)if(this._logger.log("trace","connect wifi on "+a+" to "+b.ssid),this._wpaSocket)if(0!=this._state)d&&d(Error("current state not idle:"+this._state));else{var f=this;this._state=2;this._logger.log("trace","calculate wpa passphrase");this._wpaPassphrase(b.ssid,
b.password,function(l,m){l?(f._logger.log("trace","calculate wpa passphrase failed:"+l.message),f._state=0,d&&d(l)):(l=(new Buffer(b.ssid)).toString("hex"),f._networks=[{ssid:l,psk:m,id_str:'"'+b.ssid+'"'}],f._write(function(n){d&&d(n)}))})}else d&&d(Error("wlan not exist"));else d&&d(Error("invalid arguments"))};g.prototype.disconnect=function(a,b,d){a?(this._logger.log("trace","disconnect wifi on "+a),this._wpaSocket?0!=this._state?d&&d(Error("current state not idle:"+this._state)):(this._networks=
[],this._write(function(f){d&&d(f)})):d&&d(Error("wlan not exist"))):d&&d(Error("invalid arguments"))};g.prototype.startWPAClient=function(a,b){this._logger.log("trace","start wpa client on "+a);if(this._wpaSocket)b&&b();else{var d=this;this._state=-1;this._checkWPADaemon(function(f){d._state=0;if(f)d._logger.log("trace","wpa_supplicant not running"),b&&b(f);else{f=new (require("wpa-client-socket"));var l=g.SOCKET_PATH+"/"+a;f.on("data",function(m){d._onWPAData(m.toString("utf8"))});f.bind(l);f.start();
d._wpaSocket=f;b&&b();d._initFinish&&d._checkInitWifiStatus()}})}};g.prototype._onWPAData=function(a){a=a.trim();this._logger.log("trace","wpa data:"+a);"<"==a.charAt(0)&&">"==a.charAt(2)&&(a=a.substr(3));var b=this;"CTRL-EVENT-SCAN-RESULTS"==a.substr(0,23)?1==this._state&&this._scanResults(function(d,f){b._state=0;b._scanTo&&(clearTimeout(b._scanTo),b._scanTo=0);b._scanCallback&&(b._scanCallback(d,f),b._scanCallback=null)}):"CTRL-EVENT-CONNECTED"==a.substr(0,20)?require("x.hub.v6.js")._led.stopWifiDisconnect():
"CTRL-EVENT-DISCONNECTED"==a.substr(0,23)&&require("x.hub.v6.js")._led.startWifiDisconnect()};g.prototype._status=function(a){this._logger.log("trace","do STATUS command");var b=this._wpaSocket.write("STATUS");this._logger.log("trace","STATUS command result:\n"+b.toString("utf8"));var d=b.toString("utf8");if(d){b={};d=d.trim().split("\n");for(var f=0;f<d.length;f++){var l=d[f].trim();if(l){var m=l.indexOf("=");if(-1!=m){var n=l.substr(0,m);l=l.substr(m+1);n&&(b[n]="ssid"==n?this._ssid2utf8(l):l)}}}a(null,
b)}else a(Error("do STATUS command failed"))};g.prototype._scan=function(a){this._logger.log("trace","do SCAN command");var b=this._wpaSocket.write("SCAN");this._logger.log("trace","SCAN command result:\n"+b.toString());"OK\n"!=b.toString()?a(Error("do scan command failed")):a()};g.prototype._scanResults=function(a){this._logger.log("trace","do SCAN_RESULTS command");var b=this._wpaSocket.write("SCAN_RESULTS");this._logger.log("trace","SCAN_RESULTS command result:\n"+b.toString("utf8"));var d=b.toString("utf8");
if(d){b=[];d=d.trim().split("\n");for(var f=1;f<d.length;f++){var l=d[f].trim();if(l&&(l=l.split("\t"),5<=l.length&&l[4])){var m=l[4].trim();if(m=this._ssid2utf8(m).trim())l={bssid:l[0].trim(),frequency:parseInt(l[1].trim()),signal:parseInt(l[2].trim()),flags:l[3].trim(),ssid:m},b.push(l)}}a(null,b)}else a(Error("do SCAN_RESULTS command failed"))};g.prototype._signalPoll=function(a){this._logger.log("trace","do SIGNAL_POLL command");var b=this._wpaSocket.write("SIGNAL_POLL");this._logger.log("trace",
"SIGNAL_POLL command result:\n"+b.toString("utf8"));var d=b.toString("utf8");if(d){b={};d=d.trim().split("\n");for(var f=0;f<d.length;f++){var l=d[f].trim();if(l){var m=l.indexOf("=");if(-1!=m){var n=l.substr(0,m);l=l.substr(m+1);n&&(b[n]=l)}}}a(null,b)}else a(Error("do SIGNAL_POLL command failed"))};g.prototype._checkInitWifiStatus=function(){var a=this;this._status(function(b,d){!b&&d&&"COMPLETED"!=d.wpa_state&&a._networks.length&&require("x.hub.v6.js")._led.startWifiDisconnect()})};g.prototype._wpaPassphrase=
function(a,b,d){this._logger.log("trace","call wpa_passphrase wiht ssid:"+a+" password:********");var f=require("child_process").exec;a=f('wpa_passphrase "'+a+'" "'+b+'"');var l=this,m=null;a.stdout.on("data",function(n){m+=String(n)});a.on("error",function(n){d&&(d(n),d=null)});a.on("close",function(n){if(0==n){n=null;for(var p=m.split("\n"),t=0;t<p.length;t++){var r=p[t].trim();if(r&&"psk="==r.substr(0,4)){n=r.substr(4);break}}l._logger.log("trace","call wpa_passphrase get psk:"+n);d&&(d(null,n),
d=null)}else d&&(d(Error("exit with code:"+n)),d=null)})};g.prototype._read=function(a){require("fs").readFile(this._file,{encoding:"utf8"},function(b,d){if(b)a(b);else{b=[];if(d){d=d.split("\n");for(var f=null,l=0;l<d.length;l++){var m=d[l].trim();if(m&&"#"!=m.charAt(0))if("network="==m.substr(0,8))f={};else if("}"==m)f&&b.push(f),f=null;else if(f){var n=m.split("=");m=n[0];n=n[1];m&&(f[m]=n)}}}a(null,b)}})};g.prototype._write=function(a){var b="ctrl_interface=/var/run/wpa_supplicant\nupdate_config=1\n\n";
for(var d=0;d<this._networks.length;d++){var f=this._networks[d];if(f){b+="network={\n";for(var l in f)b+="\t"+l+"="+f[l]+"\n";b+="}\n"}}require("fs").writeFile(this._file,b,function(m){a(m)})};g.prototype._checkWPADaemon=function(a){var b=0,d=this,f=function(l,m){b++;!l&&m?a():10<=b?a(Error("no pid")):setTimeout(function(){d._getWpaSupplicantPID(f)},1E3)};this._getWpaSupplicantPID(f)};g.prototype._getWpaSupplicantPID=function(a){var b=require("child_process").exec;b=b("pidof wpa_supplicant");var d=
null;b.stdout.on("data",function(f){d=String(f).trim()});b.on("error",function(f){a&&(a(f),a=null)});b.on("close",function(f){a&&(a(null,d),a=null)})};g.prototype._ssid2utf8=function(a){for(var b=[],d=0;d<a.length;)if("\\"!=a.charAt(d))b.push(a.charCodeAt(d)),d++;else if(d==a.length-1)b.push(a.charCodeAt(d)),d++;else if("x"!=a.charAt(d+1))b.push(a.charCodeAt(d+1)),d+=2;else{if(!(d+3>=a.length)){var f=a.charAt(d+2)+a.charAt(d+3);f=parseInt(f,16);isNaN(f)||b.push(f)}d+=4}return(new Buffer(b)).toString("utf8")};
var h=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network");this._handler=a;this._wlan0=this._eth0=this._wifi=this._resolvConf=this._dhcpcdConf=null};h.DHCPCD_CONF="/etc/dhcpcd.conf";h.RESOLV_CONF="/etc/resolv.conf";h.WPA_SUPPLICANT_CONF="/config/wpa_supplicant.conf";h.SET_MAC_SCRIPT="/opt/scripts/set_mac_address.sh";h.prototype.init=function(a){global.SYSTEM_ROOT&&(h.DHCPCD_CONF=global.SYSTEM_ROOT+h.DHCPCD_CONF,h.RESOLV_CONF=global.SYSTEM_ROOT+h.RESOLV_CONF,h.WPA_SUPPLICANT_CONF=
global.SYSTEM_ROOT+h.WPA_SUPPLICANT_CONF,h.SET_MAC_SCRIPT=global.SYSTEM_ROOT+h.SET_MAC_SCRIPT);var b=require("x.hub.eventbus.js");b.on("x.hub.peripheralman.ADD_WLAN",function(f){d._logger.log("debug","insert wlan usb stick: "+f.port);"wlan0"==f.port&&d._readMac(f.port,function(l,m){!l&&m&&(d._wlan0={mac:m});d._wifi.startWPAClient("wlan0")})});b.on("x.hub.peripheralman.REMOVE_WLAN",function(f){d._logger.log("debug","eject wlan usb stick: "+f.port);"wlan0"==f.port&&(d._wlan0=null)});this._resolvConf=
new e(h.RESOLV_CONF);this._dhcpcdConf=new c(h.DHCPCD_CONF);this._wifi=new g(h.WPA_SUPPLICANT_CONF);var d=this;this._readMac("eth0",function(f,l){!f&&l&&(d._eth0={mac:l});d._dhcpcdConf.init(function(){d._wifi.init(a)})})};h.prototype.getMediolaMac=function(){return this._eth0?this._eth0.mac:null};h.prototype.getNetwork=function(a){var b=this;this._getDNS(function(d,f){b._getRouter(function(l,m){l=require("os").networkInterfaces();var n={},p;for(p in l)if("lo"!=p.substr(0,2))for(var t=l[p],r=0;r<t.length;r++){var z=
t[r];if(!z.internal&&"IPv4"==z.family){z={ip:z.address,subnet:z.netmask,mac:z.mac};var u=b._dhcpcdConf.getConfig(p);(z.dhcp=u.dhcp)?(z.router=m?m[p]:null,z.dns=f):(z.router=u.router[0],z.dns=u.dns);n[p]=z}}b._eth0&&!n.eth0&&(n.eth0={mac:b._eth0.mac});b._wlan0&&!n.wlan0&&(n.wlan0={mac:b._wlan0.mac});a&&a(null,n)})})};h.prototype.setNetwork=function(a,b,d){if(b)if(1!=b.dhcp&&0!=b.dhcp)d&&d(Error("invalid argument"));else{a||(a="eth0");var f={};"eth0"==a?1==b.dhcp?f.ETH0_DHCP="true":0==b.dhcp&&(f.ETH0_DHCP=
"false",f.ETH0_IP=b.ip,f.ETH0_MASK=b.subnet,f.ETH0_ROUTER=b.router,f.ETH0_DNS=b.dns.join(" ")):"wlan0"==a&&(1==b.dhcp?f.WLAN0_DHCP="true":0==b.dhcp&&(f.WLAN0_DHCP="false",f.WLAN0_IP=b.ip,f.WLAN0_MASK=b.subnet,f.WLAN0_ROUTER=b.router,f.WLAN0_DNS=b.dns.join(" ")));this._handler._sysConf.setValues(f,function(l){d&&d(l)})}else d&&d(Error("invalid argument"))};h.prototype.setMAC=function(a,b){var d=require("child_process").exec;a=d(h.SET_MAC_SCRIPT+" "+a);a.stdout.on("data",function(f){console.log(String(f))});
a.on("error",function(f){b&&(b(f),b=null)});a.on("close",function(f){b&&(b(0==f?null:Error("set mac address failed")),b=null)})};h.prototype.scanWifi=function(a,b){if(this._wlan0){var d=this;this._logger.log("debug","scan wifi with options: "+JSON.stringify(a));this._wifi.scan("wlan0",function(f,l){d._logger.log("debug","scan wifi "+(f?"failed: "+f.message:"success: "+JSON.stringify(l)));!f&&l&&(l=l.filter(function(m){return m&&m.flags&&-1==m.flags.indexOf("EAP")&&-1==m.flags.indexOf("WEP")?!0:!1}));
b&&b(f,l)})}else b&&b(Error("wlan not avaliable"))};h.prototype.connectWifi=function(a,b){if(this._wlan0)if(a&&a.ssid&&a.password){var d=!1;if("true"==a.dhcp||"1"==a.dhcp||1==a.dhcp)d=!0;var f=this;this._logger.log("debug","connect to wifi to: "+a.ssid+(d?" (dhcp=true)":""));this._wifi.connect("wlan0",a,function(l){f._logger.log("debug","connect wifi "+(l?"failed: "+l.message:"success"));l?b&&b(l):d?(f._logger.log("debug","enable dhcp of wlan0"),f._handler._sysConf.setValues({WLAN0_DHCP:"true"},function(m){f._logger.log("debug",
"enable dhcp of wlan0 "+(m?" failed: "+m.message:" success"));b&&b(m)})):b&&b()})}else b&&b(Error("invalid arguments"));else b&&b(Error("wlan not avaliable"))};h.prototype.disconnectWifi=function(a,b){if(this._wlan0){var d=this;this._logger.log("debug","disconnect wifi");this._wifi.disconnect("wlan0",a,function(f){d._logger.log("debug","disconnect wifi "+(f?"failed: "+f.message:"success"));b&&b(f)})}else b&&b(Error("wlan not avaliable"))};h.prototype.getWifiInfo=function(a,b){if(this._wlan0){var d=
this;this._logger.log("debug","get wifi info");this._wifi.info(null,function(f,l){d._logger.log("debug","get wifi status "+(f?" failed:"+f.message:" success:"+JSON.stringify(l)));if(f)b&&b(f);else{var m=d._handler._sysConf.getValueSync("WLAN0_DHCP");l.config={wlan0:{dhcp:"true"==m||1==m||""==m}};l.config.wlan0.dhcp||(l.config.wlan0.ip=d._handler._sysConf.getValueSync("WLAN0_IP"),l.config.wlan0.subnet=d._handler._sysConf.getValueSync("WLAN0_MASK"),l.config.wlan0.router=d._handler._sysConf.getValueSync("WLAN0_ROUTER"),
m=d._handler._sysConf.getValueSync("WLAN0_DNS"),l.config.wlan0.dns=m?m.split(" "):[]);b&&b(f,l)}})}else b&&b(Error("wlan not avaliable"))};h.prototype.resetNetwork=function(a){this._logger.log("debug","reset");var b=this;this._wifi.reset(function(d){d?(b._logger.log("debug","reset wifi failed: "+d.message),a&&a(d)):b._handler._sysConf.setValues({ETH0_DHCP:"true",WLAN0_DHCP:"true"},function(f){f?b._logger.log("debug","reset to dhcp failed: "+f.message):b._logger.log("debug","reset success");a&&a(f)})})};
h.prototype.restore=function(a,b){this._logger.log("debug","restore from:"+a);var d=this;this._wifi.restore(a,function(f){d._logger.log("debug","restore "+(f?"failed: "+f.message:"success"));b&&b(f)})};h.prototype.backup=function(a,b){this._logger.log("debug","backup to:"+a);var d=this;this._wifi.backup(a,function(f){d._logger.log("debug","backup "+(f?"failed: "+f.message:"success"));b&&b(f)})};h.prototype._getDNS=function(a){this._resolvConf.getDns(a)};h.prototype._getRouter=function(a){var b=require("child_process").exec;
b=b("route -n");var d=null;b.stdout.on("data",function(f){d+=String(f)});b.on("error",function(f){a&&(a(f),a=null)});b.on("close",function(f){if(0==f){f={};for(var l=d.split("\n"),m=2;m<l.length;m++){var n=l[m].trim().split(" ").filter(function(p){return!!p});n.length&&"0.0.0.0"==n[0].trim()&&(f[n[7].trim()]=n[1].trim())}a&&(a(null,f),a=null)}else a&&(a(Error("exit with code:"+f)),a=null)})};h.prototype._readMac=function(a,b){if("PI-CM3+"!=global.PLATFORM)b();else{var d=this;this._logger.log("trace",
"read "+a+" mac");require("fs").readFile("/sys/class/net/"+a+"/address",{encoding:"utf8"},function(f,l){d._logger.log("trace","read "+a+" mac "+(f?" failed:"+f.message:" success:"+l));if(l){l=l.trim();var m=l.replace(/:/g,"-")}b(f,m)})}};return h}();
x.hub.v6.SystemConf=function(){var k=function(){this._conf={};this._writeCallbacks=[];this._writing=!1};k.FILE="/config/system.conf";k.prototype.init=function(c){global.SYSTEM_ROOT&&(k.FILE=SYSTEM_ROOT+k.FILE);this._readConf(function(){c&&c()})};k.prototype.getValueSync=function(c){if(void 0==c||null==c||"string"!=typeof c)throw Error("invalid key");c=this._conf[c];if(void 0==c||null==c)c="";return c};k.prototype.getValue=function(c,e){if(void 0==c||null==c||"string"!=typeof c)e&&e(Error("invalid key"));
else{c=this._conf[c];if(void 0==c||null==c)c="";e&&e(null,c)}};k.prototype.setValue=function(c,e,g){void 0==c||null==c||"string"!=typeof c?g&&g(Error("invalid key")):void 0==e||null==e||"string"!=typeof e?g&&g(Error("invalid value")):(this._conf[c]=e,g&&this._writeCallbacks.push(g),this._writing||this._doNextWrite())};k.prototype.setValues=function(c,e){if(c){var g=0,h;for(h in c)if(void 0!=h&&null!=h&&"string"==typeof h){var a=c[h];void 0!=a&&null!=a&&"string"==typeof a&&(g++,this._conf[h]=a)}0==
g?e&&e(Error("no valid entry")):(e&&this._writeCallbacks.push(e),this._writing||this._doNextWrite())}else e&&e(Error("invalid map"))};k.prototype.reset=function(c){this._conf={};c&&this._writeCallbacks.push(c);this._writing||this._doNextWrite()};k.prototype.restore=function(c,e){var g=require("fs"),h=require("fs-extra");if(g.existsSync(c+"/config/system.conf"))try{h.copySync(c+"/config/system.conf",k.FILE)}catch(a){}e&&e()};k.prototype.backup=function(c,e){require("fs-extra").copy(k.FILE,c+"/config/system.conf",
function(g){e&&e(g)})};k.prototype._doNextWrite=function(){var c=this._writeCallbacks;this._writeCallbacks=[];this._writing=!0;var e=this;this._writeConf(function(g){e._writing=!1;for(var h=0;h<c.length;h++){var a=c[h];try{a(g)}catch(b){}}e._writeCallbacks&&e._writeCallbacks.length&&e._doNextWrite()})};k.prototype._readConf=function(c){var e=this;this._readFile(function(g,h){if(!g&&h)for(g=h.split("\n"),h=0;h<g.length;h++){var a=g[h].trim();if(a){var b=a.indexOf("=");if(-1!=b){var d=a.substr(0,b).trim();
a=a.substr(b+1).trim();d&&(e._conf[d]=a)}}}c()})};k.prototype._writeConf=function(c){var e="",g;for(g in this._conf)e+=g+"="+this._conf[g]+"\n";this._writeFile(e,c)};k.prototype._readFile=function(c){require("fs").readFile(k.FILE,{encoding:"utf8"},function(e,g){c(e,g)})};k.prototype._writeFile=function(c,e){require("fs").writeFile(k.FILE,c,function(g){e(g)})};return k}();
x.hub.v6.Location=function(){var k=function(c){this._logger=require("x.logger.js").getLogger("x.hub.v6.Location");this._lat=k.DEFAULT_LATITUDE;this._long=k.DEFAULT_LONGITUDE;this._handler=c};k.DEFAULT_LATITUDE="020D";k.DEFAULT_LONGITUDE="0087";k.prototype.init=function(c){if(localStorage){var e=localStorage.getItem("x.hub.Server.geo.lat");e&&(self._lat=e);if(e=localStorage.getItem("x.hub.Server.geo.long"))self._long=e}c&&c()};k.prototype.setLocation=function(c,e,g){this._logger.log("debug","set location lat="+
c+" long="+e);if(c&&e){this._lat=c;this._long=e;var h=this;this._handler._stm.sendCommand(16,"XC_FNC=setLocation&lat="+c+"&long="+e,function(a){h._logger.log("debug","set location to stm lat="+c+" long="+e+" result:"+JSON.stringify(a));localStorage&&(localStorage.setItem("x.hub.Server.geo.lat",c),localStorage.setItem("x.hub.Server.geo.long",e));g&&g(a?a.error:null)})}else g&&g(Error("invalid lat/long"))};k.prototype.getLocation=function(c){c&&c(null,this._lat,this._long)};k.prototype.restore=function(c,
e,g){this._logger.log("trace","restore geo location");var h=require("fs"),a=require("path"),b=null,d=null,f=0,l=this,m=function(){f++;if(2==f){if(e&&"v5+"==e.backupType){b&&d||(b="1392",d="035C");var t=parseInt(b,16);t=Math.round(t/10);for(t=t.toString(16);4>t.length;)t="0"+t;var r=parseInt(d,16);r=Math.round(r/10);for(r=r.toString(16);4>r.length;)r="0"+r;l._logger.log("trace","convert v5+ format to v6+ format: "+t+","+r);b=t;d=r;try{l._logger.log("trace","overwrite v6+ format latitude to "+n),h.writeFileSync(n,
b.toUpperCase())}catch(z){l._logger.log("trace","overwrite v6+ format latitude to "+n+" failed:"+z.message)}try{l._logger.log("trace","overwrite v6+ format longitude to "+p),h.writeFileSync(p,d.toUpperCase())}catch(z){l._logger.log("trace","overwrite v6+ format longitude to "+p+" failed:"+z.message)}}else b&&d||(b=k.DEFAULT_LATITUDE,d=k.DEFAULT_LONGITUDE);l.setLocation(b,d,g)}},n=a.join(c,"data","localstorage","x.hub.Server.geo.lat");h.existsSync(n)?(this._logger.log("trace","read latitude from backup file: "+
n),h.readFile(n,{encoding:"utf8"},function(t,r){l._logger.log("trace","read latitude from backup file"+(t?" failed:"+t.message:" success:"+r));!t&&r&&(b=r);m()})):m();var p=a.join(c,"data","localstorage","x.hub.Server.geo.long");h.existsSync(p)?(this._logger.log("trace","read longitude from backup file: "+n),h.readFile(p,{encoding:"utf8"},function(t,r){l._logger.log("trace","read longitude from backup file"+(t?" failed:"+t.message:" success:"+r));!t&&r&&(d=r);m()})):m()};return k}();
x.hub.v6.STM=function(){var k=require("util"),c=require("events"),e=require("x.hub.v5.js").USBSerial,g=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM.Serial");this._port=a?a:h.SERIAL_PORT;this._baudrate=b?b:h.SERIAL_BAUDRATE;this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=5;this.ACK_TO=200;this.RSP_TO=1E4;this.MAX_RSP_TO=3E4;this.RSP_END_TO=2E3};k.inherits(g,e);g.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&
a(!0);else{var b=this,d=a;a=require("xnm.aio.m10T.js");var f=this._baudrate,l=new a.STMUSBSerial;l.on("error",function(){b._logger.log("trace","st port error");try{b._stmUSBSerial.close()}catch(m){}b._stmUSBSerial=null;d&&d(!1);d=null});l.on("timeout",function(){b._logger.log("trace","st port timeout")});l.on("data",function(m){b._logger.log("trace","st data:"+m.toString("hex"));b._receiveBuffer=Buffer.concat([b._receiveBuffer,m]);for(m=b._getNextDataPackage();m;){b._logger.log("trace","st package:"+
m.toString("hex"));var n=m.slice(1,m.length-1);switch(m[0]){case 80:b._logger.log("info","receive st event:"+n.toString());b._sendAck();break;case 0:b._onNak();break;case 1:b._onAck();break;case 34:b._sendAck();b._onRspError(n);break;case 32:b._sendAck();b._onRsp(n);break;case 33:b._sendAck();b._onRspEnd(n);break;default:b._sendAck()}b._onData&&b._onData({type:m[0],data:n});m=b._getNextDataPackage()}});l.open(this._port,function(){b._logger.log("trace","st connected");b._stmUSBSerial=l;d&&d(!0);d=
null},f)}};var h=function(a,b,d,f){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM");this._handler=a;this._pin=f?f:h.RESET_PIN;this._last_error=this._state=0;var l=this;this._serial=new g(b?b:h.SERIAL_PORT,d?d:h.SERIAL_BAUDRATE);this._serial.on("data",function(m){l._onData(m)});this._flashTO=this._flashCB=this._resetTO=this._resetCB=null;this._enableStatesBuffer=!1;this._deviceStatesBuffer=null;this._deviceStatesBufferTimeout=10;this._deviceStatesBufferTO=null};k.inherits(h,c);h.SERIAL_PORT=
"/dev/ttyS0";h.SERIAL_BAUDRATE=230400;h.BOOT_PIN=4;h.RESET_PIN=5;h.MODE_SCRIPT="/opt/scripts/set_stm_mode.sh";h.FIRMWARE_FILE="/opt/firmware/latest.bin";h.prototype.init=function(a){global.SYSTEM_ROOT&&(h.MODE_SCRIPT=SYSTEM_ROOT+h.MODE_SCRIPT,h.FIRMWARE_FILE=SYSTEM_ROOT+h.FIRMWARE_FILE);if(localStorage){var b=localStorage.getItem("x.hub.v6.STM.ENABLE_STATES_BUFFER");b&&"true"==b&&(this._enableStatesBuffer=!0);(b=localStorage.getItem("x.hub.v6.STM.STATES_BUFFER_TIMEOUT"))&&!isNaN(parseInt(b))&&(this._deviceStatesBufferTimeout=
parseInt(b))}var d=this;this._state=1;this._serial._openSTMUSB(function(f){f?d._state=2:(d._state=0,d._last_error=1);a&&a(f)})};h.prototype.getSettings=function(a){a&&a(null,{enable_stm_states_buffer:this._enableStatesBuffer,stm_states_buffer_timeout:this._deviceStatesBufferTimeout})};h.prototype.setSettings=function(a,b){a&&(null!=a.enable_stm_states_buffer&&"undefined"!=typeof a.enable_stm_states_buffer&&(localStorage&&localStorage.setItem("x.hub.v6.STM.ENABLE_STATES_BUFFER",a.enable_stm_states_buffer),
this._enableStatesBuffer=a.enable_stm_states_buffer),null!=a.stm_states_buffer_timeout&&"undefined"!=typeof a.stm_states_buffer_timeout&&(localStorage&&localStorage.setItem("x.hub.v6.STM.STATES_BUFFER_TIMEOUT",a.stm_states_buffer_timeout),this._deviceStatesBufferTimeout=a.stm_states_buffer_timeout));b&&b()};h.prototype.reset=function(a){if(5==this._state)a&&a(Error("stm is resetting"));else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","do stm factory reset");
var b=this;this._state=5;this._serial.reset(function(){b._serial.sendCommand(53,[],function(d){var f=null;if(!d||d.error)f=d?d.error:Error("reset stm failed");f?(b._logger.log("trace","do stm factory reset failed:"+f.message),a&&a(f)):(b._resetCB=function(){b._resetTO&&(clearTimeout(b._resetTO),b._resetTO=null);b._state=2;a&&a()},b._resetTO=setTimeout(function(){b._resetTO=null;b._state=2;a&&a(Error("reset timeout"))},3E4))})})}};h.prototype.reboot=function(a){if(3==this._state)a&&a(Error("stm is rebooting"));
else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","reboot stm");var b=this;this._state=3;this._serial.reset(function(){b._setSTMMode("reboot",function(d){b._logger.log("trace","reboot stm "+(d?"failed:"+d.message:"success"));b._state=2;a&&a(d)})})}};h.prototype.backup=function(a,b){var d=this,f=function(l,m,n){d.sendCommand(16,l,function(p){p&&p.data?p.error?n(Error("response error:"+p.data.toString())):require("fs").writeFile(m,p.data.toString(),function(t){n(t)}):
n(Error("invalid response"))})};d._logger.log("trace","backup get all");f("XC_FNC=GetAll",a+"/all.json",function(l){d._logger.log("trace","backup get states");f("XC_FNC=GetStates&config=1",a+"/states.json",function(m){m?(d._logger.log("warn","backup get states failed:"+m.message),b&&b(m)):(d._logger.log("trace","backup get si"),f("XC_FNC=GetSI",a+"/si.json",function(n){n?(d._logger.log("warn","backup get si failed:"+n.message),b&&b(n)):(d._logger.log("trace","backup get config (hmip)"),f("XC_FNC=GetConfig&sys=HmIP",
a+"/conf_hmip.json",function(p){p?(d._logger.log("warn","backup get config (hmip) failed:"+p.message),b&&b(p)):(d._logger.log("trace","backup get sys (hmip)"),f("XC_FNC=GetSys&sys=HmIP",a+"/sys_hmip.json",function(t){t&&d._logger.log("warn","backup get sys (hmip) failed:"+t.message);b&&b(t)}))}))}))})})};h.prototype.restore=function(a,b){if(6==this._state)b&&b(Error("stm restore process is running"));else if(2!=this._state)b&&b(Error("stm has state:"+this._state));else{this._state=6;var d=this,f=
function(t,r){var z=function(w,A){w.TZ?d._serial.sendCommand(16,"XC_FNC=setTZ&data="+w.TZ,function(C){A()}):A()},u=function(w,A){w.LAT&&w.LONG?d._serial.sendCommand(16,"XC_FNC=setLocation&lat="+w.LAT+"&long="+w.LONG,function(C){A()}):A()},q=function(w,A){var C="XC_FNC=setRFM&data="+w.mode;w.type&&(C+="&type="+w.type);d._serial.sendCommand(16,C,function(D){A()})},v=function(w,A){var C=null;w.ER&&"object"===typeof w.ER&&"string"===typeof w.ER.ADR?C=w.ER.ADR:"string"===typeof w.EID&&(C=w.EID,isLegacy=
!0);C?d._serial.sendCommand(16,"XC_FNC=setConfig&type=ER&adr="+C,function(D){A()}):A()},y=function(w,A){var C=null;w.HM&&"object"===typeof w.HM&&"string"===typeof w.HM.ADR?C=w.HM.ADR:"string"===typeof w.HMADR&&(C=w.HMADR);C?d._serial.sendCommand(16,"XC_FNC=setConfig&sys=HM&type=ADR&config="+C,function(D){A()}):A()},B=function(w,A){d._logger.log("trace","restore tz");z(w,function(C){C&&d._logger.log("warn","restore tz failed:"+C.message);d._logger.log("trace","restore geo location");u(w,function(D){D&&
d._logger.log("warn","restore geo location failed:"+D.message);var E={mode:w.RFM.substr(2,2),type:433};d._logger.log("trace","restore 433 sensor mode");q(E,function(G){G&&d._logger.log("warn","restore 433 sensor mode failed:"+G.message);E={mode:w.RFM.substr(0,2)};d._logger.log("trace","restore 868 sensor mode");q(E,function(F){F&&d._logger.log("warn","restore 868 sensor mode failed:"+F.message);d._logger.log("trace","restore elero address");v(w,function(H){H&&d._logger.log("warn","restore elero address failed:"+
H.message);d._logger.log("trace","restore hm address");y(w,function(I){I&&d._logger.log("warn","restore hm address failed:"+I.message);A()})})})})})})};(function(w,A){var C=require("fs-extra");w+="/si.json";C.existsSync(w)?C.readFile(w,{encoding:"utf8"},function(D,E){if(D)A(D);else if(E)try{var G=JSON.parse(E);A(null,G)}catch(F){A(F)}else A(null,null)}):A()})(t,function(w,A){w?r(w):A&&0!=Object.keys(A).length?B(A,function(){r()}):r()})},l=function(t,r){var z=function(u,q){if(u.length){var v=u.pop();
if("string"!==typeof v.sys)z(u,q);else{var y="Add"+v.sys.charAt(0).toUpperCase()+v.sys.slice(1).toLowerCase();"sevent"===v.sys.toLowerCase()&&(y="AddSensorEvent");v.XC_FNC=y;d._serial.sendCommand(17,JSON.stringify(v),function(B){z(u,q)})}}else q()};(function(u,q){var v=require("fs-extra");u+="/all.json";v.existsSync(u)?v.readFile(u,{encoding:"utf8"},function(y,B){if(y)q(y);else if(y=[],B)try{var w=JSON.parse(B);q(null,w)}catch(A){q(A)}else q(null,y)}):q()})(t,function(u,q){u?r(u):q&&0!=q.length?z(q,
function(){r()}):r()})},m=function(t,r){var z=function(u,q){if(u.length){var v=require("querystring"),y=u.pop();if("EVENT"==y.type)z(u,q);else{if("HM"===y.type||"HMFHT"===y.type){if(String(y.adr).toUpperCase().startsWith("HMIP-")){z(u,q);return}var B=null;12==y.adr.length?(B=y.adr.substr(-4),y.adr=y.adr.substr(0,8)):B="FFFF";y.adr=B+y.adr;"HMFHT"===y.type&&delete y.state}else"CF4"==y.type&&(y.adr="0001"+y.adr);v=v.stringify(y);d._serial.sendCommand(16,"XC_FNC=AddSensor&"+v,function(w){z(u,q)})}}else q()};
(function(u,q){var v=require("fs-extra");u+="/states.json";v.existsSync(u)?v.readFile(u,{encoding:"utf8"},function(y,B){if(y)q(y);else if(y=[],B)try{var w=JSON.parse(B);q(null,w)}catch(A){q(A)}else q(null,y)}):q()})(t,function(u,q){u?r(u):q&&0!=q.length?z(q,function(){r()}):r()})},n=function(t,r){var z=function(u,q){u.XC_FNC="setConfig";u.sys="HmIP";d._serial.sendCommand(17,JSON.stringify(u),function(v){v&&v.data?q(null,v.data.toString()):v&&v.error?q(Error(v.error)):q(Error("fail"))})};(function(u,
q){var v=require("fs-extra");u+="/conf_hmip.json";v.existsSync(u)?v.readFile(u,{encoding:"utf8"},function(y,B){if(y)q(y);else if(B)try{var w=JSON.parse(B);q(null,w)}catch(A){q(A)}else q(null,null)}):q()})(t,function(u,q){u?r(u):q?z(q,r):r()})},p=function(t,r){var z=function(u,q){if(u.length){var v=u.pop();v?(v.XC_FNC="addSensor",v.type&&"HmIP"==v.type||(v.type="HmIP"),d._serial.sendCommand(17,JSON.stringify(v),function(y){z(u,q)})):z(u,q)}else q()};(function(u,q){var v=require("fs-extra");u+="/sys_hmip.json";
v.existsSync(u)?v.readFile(u,{encoding:"utf8"},function(y,B){if(y)q(y);else if(B)try{var w=JSON.parse(B);q(null,w)}catch(A){q(A)}else q(null,null)}):q()})(t,function(u,q){u?r(u):q&&0!=q.length?z(q,function(){r()}):r()})};d._logger.log("trace","reset stm for restore");(function(t){d._serial.reset(function(){d._serial.sendCommand(53,[],function(r){var z=null;if(!r||r.error)z=r?r.error:Error("reset stm failed");z?t(z):(d._resetCB=function(){d._resetTO&&(clearTimeout(d._resetTO),d._resetTO=null);t()},
d._resetTO=setTimeout(function(){d._resetTO=null;t(Error("reset timeout"))},3E4))})})})(function(t){t?(d._state=2,d._logger.log("warn","reset stm for restore failed:"+t.message),b&&b(t)):(d._logger.log("trace","restore system info"),f(a,function(r){r&&d._logger.log("warn","restore system info failed:"+r.message);d._logger.log("trace","restore tasks");l(a,function(z){z&&d._logger.log("warn","restore tasks failed:"+z.message);d._logger.log("trace","restore state devices");m(a,function(u){u&&d._logger.log("warn",
"restore state devices failed:"+u.message);d._logger.log("trace","restore config (hmip)");n(a,function(q){q&&d._logger.log("warn","restore config (hmip) failed:"+q.message);d._logger.log("trace","restore sys (hmip)");p(a,function(v){v&&d._logger.log("warn","restore sys (hmip) failed:"+v.message);d._state=2;b&&b()})})})})}))})}};h.prototype.flashFirmware=function(a,b){if(4==this._state)b&&b(Error("flash stm firmware proceess is running"));else if(0!=this._state&&2!=this._state)b&&b(Error("stm has state:"+
this._state));else{a||(a=h.FIRMWARE_FILE);this._logger.log("trace","start to flash stm firmware:"+a);var d=this._state;this._state=4;var f=this,l=function(m){f._logger.log("trace","wait stm reboot");f._flashCB=function(){f._logger.log("trace","stm reboot finish");f._flashTO&&(clearTimeout(f._flashTO),f._flashTO=null);f._state=d;b&&b(m)};f._flashTO=setTimeout(function(){f._logger.log("trace","stm reboot timeout");f._flashTO=null;f._state=d;b&&b(Error("reboot timeout"))},1E4)};this._serial.reset(function(){f._setSTMMode("bootloader",
function(m){m?(f._logger.logger("trace","flash stm failed to enter bootloader mode:"+m.message),f._setSTMMode("reboot",function(){f._state=d;b&&b(m)})):f._flashFirmware(a,function(n){n?f._setSTMMode("reboot",function(){f._state=d;b&&b(n)}):(f._logger.log("trace","flash stm firmware finish success"),l())})})})}};h.prototype.sendCommand=function(a,b,d){if(2!=this._state)this._logger.log("trace","reject send stm command, stm connection state:"+this._state),d&&d({error:"stm connection state:"+this._state});
else{var f=this._isGetStatesReq(b),l=this._isExecuteCommandReq(b);if(f&&this._enableStatesBuffer&&this._deviceStatesBuffer)d&&d({data:this._deviceStatesBuffer});else{var m=this;this._serial.sendCommand(a,b,function(n){f?m._handleGetStatesRes(n):l&&m._handleExecuteCommandRes(n);d&&d(n)})}}};h.prototype._onData=function(a){if(a&&a.type&&a.data)if(80==a.type){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),
b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");this._clearDeviceStatesBuffer();this.emit("event",a,b)}else if(87==a.type)if(5==this._state||6==this._state){if(this._resetCB){try{this._resetCB()}catch(d){}this._resetCB=null}}else{if(4==this._state&&this._flashCB){try{this._flashCB()}catch(d){}this._flashCB=null}}else if(81==a.type||83==a.type)b=a.data.readUInt8(0),b=b.toString(16),0!=b.length%2&&(b="0"+b),require("x.hub.commandman.js").commandHandlerV6.executeCommandWithCommandInfo(81==
a.type?{legacycloudaction:b}:{cloudaction:b},function(){},"stm");else if(69==a.type)b=a.data.readUInt8(0),a=require("x.hub.v6.js")._led,b?a.startDutyCycle():a.stopDutyCycle();else if(70==a.type)switch(b=a.data.readUInt8(1),a=require("x.hub.v6.js")._led,b){case 0:a.setColor(0,0,0);break;case 1:a.setColor(0,255,0);break;case 2:a.setColor(0,0,255);break;case 3:a.setColor(255,0,0);break;case 4:a.setColor(255,255,0);break;case 5:a.setColor(255,255,255);break;case 6:a.setColor(255,0,255);break;case 7:a.setColor(0,
255,255)}else 90==a.type?(b=a.data.readUInt8(0),require("x.hub.action.js").getActionManager().executeActionWithId(b,function(){})):145==a.type&&require("x.hub.m.enocean.js").sendToFGW14(a.data,function(d){})};h.prototype._setSTMMode=function(a,b){var d=require("child_process").exec;d=d(h.MODE_SCRIPT+" "+a);d.on("error",function(f){b&&(b(f),b=null)});d.on("close",function(f){b&&(b(0==f?null:Error("set stm mode: "+a+" failed")),b=null)})};h.prototype._flashFirmware=function(a,b){var d=this;a=new (require("xnm.aio.m10T.js").STMUpdater)(a);
this._logger.log("trace","flash stm with dfu-util");a.startDFUUpdate("dfu-util",function(f){b&&f&&(f.error?(d._logger.log("trace","flash stm failed:"+f.error),b(Error(f.error)),b=null):f.state&&(d._logger.log("trace","flash stm progress:"+f.state),d.emit("flash",{progress:f.state}),100==f.state&&(d._logger.log("trace","flash stm success"),b(),b=null)))},null,"v6p")};h.prototype._isGetStatesReq=function(a){if("string"!=typeof a)return!1;a=a.toLowerCase();return-1!=a.indexOf("xc_fnc=getstates")||-1!=
a.indexOf('"xc_fnc":"getstates"')?!0:!1};h.prototype._handleGetStatesRes=function(a){a&&!a.error&&a.data&&this._setDeviceStatesBuffer(a.data)};h.prototype._isExecuteCommandReq=function(a){if("string"!=typeof a)return!1;a=a.toLowerCase();return-1!=a.indexOf("xc_fnc=sendsc")||-1!=a.indexOf('"xc_fnc":"sendsc"')||-1!=a.indexOf("xc_fnc=setvar")||-1!=a.indexOf('"xc_fnc":"setvar"')||-1!=a.indexOf("xc_fnc=sendgenericcmd")||-1!=a.indexOf('"xc_fnc":"sendgenericcmd"')||-1!=a.indexOf("xc_fnc=refreshsc")||-1!=
a.indexOf('"xc_fnc":"refreshsc"')||-1!=a.indexOf("xc_fnc=refreshhm")||-1!=a.indexOf('"xc_fnc":"refreshhm"')||-1!=a.indexOf("xc_fnc=ingetstate")||-1!=a.indexOf('"xc_fnc":"ingetstate"')||-1!=a.indexOf("xc_fnc=refresh")||-1!=a.indexOf('"xc_fnc":"refresh"')?!0:!1};h.prototype._handleExecuteCommandRes=function(a){a&&!a.error&&this._clearDeviceStatesBuffer()};h.prototype._setDeviceStatesBuffer=function(a){this._deviceStatesBuffer=a;this._deviceStatesBufferTO&&clearTimeout(this._deviceStatesBufferTO);var b=
this;this._deviceStatesBufferTO=setTimeout(function(){b._deviceStatesBuffer=null},1E3*this._deviceStatesBufferTimeout)};h.prototype._clearDeviceStatesBuffer=function(){this._deviceStatesBufferTO&&(clearTimeout(this._deviceStatesBufferTO),this._deviceStatesBufferTO=null);this._deviceStatesBuffer=null};return h}();
x.hub.v6.LED=function(){var k=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.LED");this._rgb=[255,255,255];this._state=0;this._buffer=[]};k.STATE_NORMAL=0;k.STATE_BLINK=1;k.STATE_WIFI_DISCONNECT=2;k.STATE_DUTY_CYCLE=3;k.STATE_FLASH_STM=4;k.STATE_INIT_SYSTEM=5;k.STATE_RESET_SYSTEM=6;k.PROCESS="setlight";k.NAMED_PIPE="/tmp/rgb.cfg";k.prototype.init=function(){if(localStorage){var c=localStorage.getItem("x.hub.Server.led");c&&6==c.length&&c.match(/^([a-fA-F0-9]){6}/g)&&(this._rgb=
[parseInt(c.substr(0,2),16),parseInt(c.substr(2,2),16),parseInt(c.substr(4,2),16)])}};k.prototype.saveColor=function(c,e,g,h){var a=this;this.setColor(c,e,g,function(b){if(!b&&localStorage){a._rgb=[c,e,g];for(var d=(new Buffer(a._rgb)).toString("hex");6>d.length;)d="0"+d;localStorage.setItem("x.hub.Server.led",d)}h&&h(b)})};k.prototype.setColor=function(c,e,g,h){if(this._state>k.STATE_BLINK)h&&h(Error("led state:"+this._state));else{var a=this;this._state=k.STATE_NORMAL;this._buffer[k.STATE_BLINK]=
null;this._setColor(c,e,g,function(b){b||(a._buffer[k.STATE_NORMAL]=[c,e,g]);h&&h(b)})}};k.prototype.blinkColor=function(c,e,g,h,a){if(this._state>k.STATE_BLINK)a&&a(Error("led state:"+this._state));else{var b=this;this._state=k.STATE_BLINK;this._buffer[k.STATE_BLINK]=[c,e,g,h];this._blinkColor(c,e,g,h,function(d){d?(b._state=k.STATE_NORMAL,b._buffer[k.STATE_BLINK]=null,b._setLastColor(function(){a&&a(d)})):a&&a()})}};k.prototype.stopBlinkColor=function(c){this._state!=k.STATE_BLINK?c&&c():(this._state=
k.STATE_NORMAL,this._buffer[k.STATE_BLINK]=null,this._setLastColor(function(e){c&&c(e)}))};k.prototype.startWifiDisconnect=function(c){this._logger.log("trace","start wifi disconnect (state="+this._state+")");if(this._state==k.STATE_WIFI_DISCONNECT)c&&c();else if(this._buffer[k.STATE_WIFI_DISCONNECT]=!0,this._state>k.STATE_WIFI_DISCONNECT)c&&c(Error("led state:"+this._state));else{var e=this;this._state=k.STATE_WIFI_DISCONNECT;this._blinkColor(255,255,0,1E3,function(g){g&&(e._state=k.STATE_NORMAL,
e._buffer[k.STATE_WIFI_DISCONNECT]=null,e._setLastColor(c));c&&c(g)})}};k.prototype.stopWifiDisconnect=function(c){this._buffer[k.STATE_WIFI_DISCONNECT]=null;this._state!=k.STATE_WIFI_DISCONNECT?c&&c():(this._state=k.STATE_NORMAL,this._setLastColor(function(e){c&&c(e)}))};k.prototype.startDutyCycle=function(c){this._logger.log("trace","start duty cycle");if(this._state==k.STATE_DUTY_CYCLE)c&&c();else if(this._buffer[k.STATE_DUTY_CYCLE]=!0,this._state>k.STATE_DUTY_CYCLE)c&&c(Error("led state:"+this._state));
else{var e=this;this._state=k.STATE_DUTY_CYCLE;this._blinkColor(255,0,0,500,function(g){g&&(e._state=k.STATE_NORMAL,e._buffer[k.STATE_DUTY_CYCLE]=null,e._setLastColor(c));c&&c(g)})}};k.prototype.stopDutyCycle=function(c){this._logger.log("trace","stop duty cycle");this._buffer[k.STATE_DUTY_CYCLE]=null;this._state!=k.STATE_DUTY_CYCLE?c&&c():(this._state=k.STATE_NORMAL,this._setLastColor(function(e){c&&c(e)}))};k.prototype.startFlashSTM=function(c){if(this._state==k.STATE_FLASH_STM)c&&c();else if(this._state>
k.STATE_FLASH_STM)c&&c(Error("led state:"+this._state));else{var e=this;this._state=k.STATE_FLASH_STM;this._buffer[k.STATE_FLASH_STM]=!0;this._blinkColor(255,255,0,50,function(g){g&&(e._state=k.STATE_NORMAL,e._buffer[k.STATE_FLASH_STM]=null,e._setLastColor(c));c&&c(g)})}};k.prototype.stopFlashSTM=function(c){this._buffer[k.STATE_FLASH_STM]=null;this._state!=k.STATE_FLASH_STM?c&&c():(this._state=k.STATE_NORMAL,this._setLastColor(function(e){c&&c(e)}))};k.prototype.startSystemInit=function(c){this._logger.log("trace",
"start system init");if(this._state==k.STATE_INIT_SYSTEM)c&&c();else if(this._state>k.STATE_INIT_SYSTEM)c&&c(Error("led state:"+this._state));else{var e=this;this._state=k.STATE_INIT_SYSTEM;this._buffer[k.STATE_INIT_SYSTEM]=!0;this._blinkColor(255,255,255,1E3,function(g){g&&(e._state=k.STATE_NORMAL,e._buffer[k.STATE_INIT_SYSTEM]=null,e._setLastColor(c));c&&c(g)})}};k.prototype.stopSystemInit=function(c){this._logger.log("trace","stop system init");this._state!=k.STATE_INIT_SYSTEM?c&&c():(this._state=
k.STATE_NORMAL,this._buffer[k.STATE_INIT_SYSTEM]=null,this._setLastColor(function(e){c&&c(e)}))};k.prototype.startResetSystem=function(c,e,g,h){if(this._state>k.STATE_RESET_SYSTEM)h&&h(Error("led state:"+this._state));else{var a=this;this._state=k.STATE_RESET_SYSTEM;this._buffer[k.STATE_RESET_SYSTEM]=[c,e,g];this._setColor(c,e,g,function(b){b&&(a._state=k.STATE_NORMAL,a._buffer[k.STATE_RESET_SYSTEM]=null,a._setLastColor(h));h&&h(b)})}};k.prototype.stopResetSystem=function(c){this._state>k.STATE_RESET_SYSTEM?
c&&c(Error("led state:"+this._state)):(this._state=k.STATE_NORMAL,this._buffer[k.STATE_RESET_SYSTEM]=null,this._setColor(0,0,0,function(e){c&&c(e)}))};k.prototype._setLastColor=function(c){this._buffer[k.STATE_INIT_SYSTEM]?this.startSystemInit(c):this._buffer[k.STATE_FLASH_STM]?this.startFlashSTM(c):this._buffer[k.STATE_DUTY_CYCLE]?this.startDutyCycle(c):this._buffer[k.STATE_WIFI_DISCONNECT]?this.startWifiDisconnect(c):this._buffer[k.STATE_BLINK]?this.blinkColor(this._buffer[1][0],this._buffer[1][1],
this._buffer[1][2],this._buffer[1][3],c):this._buffer[k.STATE_NORMAL]?this.setColor(this._buffer[0][0],this._buffer[0][1],this._buffer[0][2],c):this.setColor(this._rgb[0],this._rgb[1],this._rgb[2],c)};k.prototype._setColor=function(c,e,g,h){c=this._buildCommand([1,c,e,g,0,0]);this._logger.log("trace","set color:"+c.toString("hex"));this._doCommand(c,function(a){h&&h(a)})};k.prototype._blinkColor=function(c,e,g,h,a){c=[1,c,e,g,0,0];0==h%1E3?c[4]=h/1E3:(c[4]=Math.floor(h/1E3),c[5]=Math.round(h%1E3/
20));h=this._buildCommand(c);this._logger.log("trace","blink color:"+h.toString("hex"));this._doCommand(h,function(b){a&&a(b)})};k.prototype._buildCommand=function(c){var e=[170,c.length+3];e=e.concat(c);c=e[2];for(var g=3;g<e.length;g++)c^=e[g];e.push(c);return new Buffer(e)};k.prototype._doCommand=function(c,e){var g=this;this._getPID(function(h,a){h?(g._logger.log("trace","get program pid error:"+h.message),e&&e(h)):a?g._write(c,e):(g._logger.log("trace","program not running"),e&&e(Error("program not running")))})};
k.prototype._write=function(c,e){var g=require("fs"),h=this;g.access(k.NAMED_PIPE,g.F_OK,function(a){if(a)h._logger.log("warn","led control program not running"),e&&e(a);else{var b=g.createWriteStream(k.NAMED_PIPE);b.on("open",function(){h._logger.log("trace","stream open and write bytes");b.end(c)});b.on("error",function(d){h._logger.log("trace","stream error:"+d.messae);b.__writeTO&&(clearTimeout(b.__writeTO),b.__writeTO=null);e&&(e(d),e=null);b.destroy()});b.on("close",function(){h._logger.log("trace",
"stream close");b.__writeTO&&(clearTimeout(b.__writeTO),b.__writeTO=null);e&&(e(),e=null)});b.__writeTO=setTimeout(function(){h._logger.log("trace","stream write timeout");e&&(e(Error("write timeout")),e=null);b.destroy()},2E3)}})};k.prototype._getPID=function(c){var e=require("child_process").exec;e=e("pidof "+k.PROCESS);var g=null;e.stdout.on("data",function(h){g=String(h).trim()});e.on("error",function(h){c&&(c(h),c=null)});e.on("close",function(h){c&&(c(null,g),c=null)})};return k}();
x.hub.v6.ResetPin=function(){var k=function(c,e){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin");this._handler=c;this._pinID=e;this._pinID||(this._pinID=k.PIN);this._checkInterval=this._pressedTS=this._resetMode=this._pin=null};k.PIN=24;k.prototype.init=function(){this._logger.log("trace","init reset pin:"+this._pinID);if("PI-CM3+"==global.PLATFORM){var c=require("onoff").Gpio;(new c(this._pinID,"in","both")).unexport();this._pin=new c(this._pinID,"in","both");var e=this;this._pin.watch(function(g,
h){e._logger.log("trace","reset pin value:"+h);1==h?e._onPress():0==h&&e._onRelease()})}};k.prototype._checkResetPin=function(){var c=this._pin.readSync();this._logger.log("trace","check reset pin value:"+c);0==c?this._onRelease():(c=Date.now()-this._pressedTS,8E3<c?"reboot"!=this._resetMode&&(this._pressedTS=Date.now(),this._resetMode="reboot",this._onModeChange()):6E3<c?"factory"!=this._resetMode&&(this._resetMode="factory",this._onModeChange()):4E3<c?"passwords"!=this._resetMode&&(this._resetMode=
"passwords",this._onModeChange()):2E3<c&&"network"!=this._resetMode&&(this._resetMode="network",this._onModeChange()))};k.prototype._onPress=function(){this._logger.log("trace","reset pin pressed");this._resetMode="reboot";this._pressedTS=Date.now();this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var c=this;this._checkInterval=setInterval(function(){c._checkResetPin()},200);this._onModeChange()};k.prototype._onRelease=function(){this._logger.log("trace","reset pin released, reset mode:"+
this._resetMode);this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var c=this._resetMode;this._pressedTS=this._resetMode=null;var e=this,g=this._handler._hub,h=require("x.hub.v6.js")._led;if(g)switch(c){case "reboot":g.restart();break;case "factory":case "passwords":case "network":g.reset(c,function(a,b){e._logger.log("trace",c+" reset finish, reboot:"+b);h.stopResetSystem();!a&&b&&g.restart(1E3)})}};k.prototype._onModeChange=function(){this._logger.log("trace","reset mode change to:"+
this._resetMode);var c=require("x.hub.v6.js")._led;switch(this._resetMode){case "reboot":c.startResetSystem(0,0,0);break;case "network":c.startResetSystem(0,255,0);break;case "passwords":c.startResetSystem(255,255,0);break;case "factory":c.startResetSystem(255,0,0)}};return k}();
x.hub.v6.Recovery=function(){var k=function(){};k.FILE="/config/.recoveryMode";k.prototype.init=function(c){global.SYSTEM_ROOT&&(k.FILE=SYSTEM_ROOT+k.FILE);c&&c()};k.prototype.createEmptyFile=function(c){this._writeProperties({},function(e){c&&c(e)})};k.prototype.setFirmwareUpdateUrl=function(c,e){var g=this;this._readProperties(function(h,a){h?e&&e(h):(a||(a={}),a.URL=c,g._writeProperties(a,function(b){e&&e(b)}))})};k.prototype._readProperties=function(c){var e=require("fs");e.existsSync(k.FILE)?
e.readFile(k.FILE,{encoding:"utf8"},function(g,h){if(g)c&&c(g);else{g={};if(h){h=h.split("\n");for(var a=0;a<h.length;a++){var b=h[a].trim().split("=");g[b[0]]=b[1]}}c(null,g)}}):c(null,{})};k.prototype._writeProperties=function(c,e){var g=require("fs"),h=[],a;for(a in c){var b=c[a];if(void 0==b||null==b)b="";h.push(a+"="+b)}c=h.length?h.join("\n"):"";g.writeFile(k.FILE,c,function(d){e(d)})};return k}();
x.hub.v6.ExtraInfo=function(){var k=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ExtraInfo")};k.prototype.getInfo=function(c){var e=this,g={};this._logger.log("trace","get cpu temperature");this._getCPUTemperature(function(h,a){e._logger.log("trace","get cpu temperature "+(h?"failed:"+h.message:"success:"+a));h||(g.cpuTemp=a);e._logger.log("trace","get gpu temperature");e._getGPUTemperature(function(b,d){e._logger.log("trace","get gpu temperature "+(b?"failed:"+b.message:"success:"+
a));b||(g.gpuTemp=d);c&&c(null,g)})})};k.prototype._getCPUTemperature=function(c){require("fs").readFile("/sys/class/thermal/thermal_zone0/temp",{encoding:"utf8"},function(e,g){e?c(e):(e=parseInt(g),isNaN(e)?c(Error("invalid temperature")):c(null,e/1E3))})};k.prototype._getGPUTemperature=function(c){var e=require("child_process").exec;e=e("vcgencmd measure_temp");var g=null,h=this;e.stdout.on("data",function(a){h._logger.log("trace","get gpu temperature:"+String(a));a=String(a).trim();"temp="==a.substr(0,
5)&&(a=a.substring(5,a.length-2),a=parseFloat(a),isNaN(a)||(g=a))});e.on("error",function(a){c&&(c(a),c=null)});e.on("close",function(a){0!=a?c&&(c(Error("read gpu temperature failed")),c=null):null==g?c&&(c(Error("invalid temperature")),c=null):c&&(c(null,g),c=null)})};return k}();
x.hub.v6.ZwayServer=function(){var k=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ZwayServer");this._state=0};k.SCRIPT="/srv/init.d/S01z-way-server";k.FOLDER="/srv/z-way-server";k.prototype.init=function(c){global.SYSTEM_ROOT&&(k.FOLDER=SYSTEM_ROOT+k.FOLDER,k.SCRIPT=SYSTEM_ROOT+k.SCRIPT);c&&c()};k.prototype._getConfigFolder=function(){return k.FOLDER+"/config"};k.prototype._getAutomationFolder=function(){return k.FOLDER+"/automation"};k.prototype._getAutomationStorageFolder=
function(){return this._getAutomationFolder()+"/storage"};k.prototype.start=function(c){if(this._state)c&&c(Error("current state is:"+this._state));else{var e=this;this._state=1;this._startAndCheck(3,1E3,function(g){e._state=0;c&&c(g)})}};k.prototype.stop=function(c){if(this._state)c&&c(Error("current state is:"+this._state));else{var e=this;this._state=2;this._stopAndCheck(3,1E3,function(g){e._state=0;c&&c(g)})}};k.prototype.reset=function(c){if(this._state)c&&c(Error("current state is:"+this._state));
else{var e=this;this._state=3;this._logger.log("trace","reset z-way-server");var g=!1;require("async").series([function(h){e._logger.log("trace","check z-way-server state");e._isRunning(function(a,b){e._logger.log("trace","check z-way-server state "+(a?" failed:"+a.message:" running:"+b));a||(g=b);h()})},function(h){g?(e._logger.log("trace","stop z-way-server"),e._stopAndCheck(3,1E3,function(a){h(a)})):h()},function(h){e._logger.log("trace","clear z-way-server folder");e._reset(!1,h)},function(h){g?
(e._logger.log("trace","start z-way-server"),e._startAndCheck(3,1E3,h)):h()}],function(h){e._state=0;c&&c(h)})}};k.prototype.restore=function(c,e,g){if(this._state)g&&g(Error("current state is:"+this._state));else{var h=e?e.restoreUZB:null,a=this;this._state=5;this._logger.log("trace","retore zway data (restoreUZB="+h+") from:"+c+" to:"+k.FOLDER);var b=!1;require("async").series([function(d){if(e&&"v5+"==e.backupType){var f=require("fs");f.existsSync(c+"/zway/automation/storage")&&f.readdir(c+"/zway/automation/storage",
function(l,m){if(!l&&m)for(l=0;l<m.length;l++){var n=m[l];if(n&&"configjson-"==n.substr(0,11))try{a._logger.log("trace","v5+ backup, remove file:"+n),f.unlinkSync(c+"/zway/automation/storage/"+n)}catch(p){}}d()})}else d()},function(d){a._logger.log("trace","check z-way-server state");a._isRunning(function(f,l){a._logger.log("trace","check z-way-server state "+(f?" failed:"+f.message:" running:"+l));f||(b=l);d()})},function(d){if(h){a._logger.log("trace","retore uzb");var f;require("fs").existsSync(c+
"/zway/z-way-backup.zbk")?(f=require("x.hub.m.zway.js").getZway())?f.restore(c+"/zway/z-way-backup.zbk",!0,function(l){a._logger.log("trace","retore uzb "+(l?" failed:"+l.message:" success"));l&&!l.code&&(l.code=-313);d(l)}):(a._logger.log("trace","retore uzb failed: z-way-server not running"),f=Error("z-way-server not running"),f.code=-312,d(f)):(a._logger.log("trace","retore uzb failed: no uzb backup file"),f=Error("no uzb backup file"),f.code=-311,d(f))}else d()},function(d){b?(a._logger.log("trace",
"stop z-way-server"),a._stopAndCheck(3,1E3,function(f){a._logger.log("trace","stop z-way-server "+(f?" failed:"+f.message:" success"));f&&!f.code&&(f.code=-314);d(f)})):d()},function(d){a._logger.log("trace","clear z-way-server folder (restoreUZB="+h+")");a._reset(h,function(f){a._logger.log("trace","clear z-way-server folder (restoreUZB="+h+")"+(f?" failed:"+f.message:" success"));f&&!f.code&&(f.code=-315);d(f)})},function(d){a._logger.log("trace","restore z-way-server folder (restoreUZB="+h+")");
a._restore(c,h,function(f){a._logger.log("trace","restore z-way-server folder (restoreUZB="+h+")"+(f?" failed:"+f.message:" success"));f&&!f.code&&(f.code=-316);d(f)})},function(d){b?(a._logger.log("trace","start z-way-server"),a._startAndCheck(3,1E3,function(f){a._logger.log("trace","start z-way-server "+(f?" failed:"+f.message:" success"));f&&!f.code&&(f.code=-317);d(f)})):d()}],function(d){a._state=0;g&&g(d)})}};k.prototype.backup=function(c,e,g){if(this._state)g&&g(Error("current state is:"+this._state));
else{this._state=4;this._logger.log("trace","backup zway data (backupUZB="+e+") to:"+c);var h=require("fs-extra"),a=this._getConfigFolder(),b=this._getAutomationStorageFolder();if(h.existsSync(a))try{h.copySync(a,c+"/zway/config")}catch(f){}if(h.existsSync(b))try{h.copySync(b,c+"/zway/automation/storage")}catch(f){}if(0==e)this._state=0,g&&g();else if((h=require("x.hub.m.zway.js").getZway())||e)if(!h&&e)this._state=0,g&&g(Error("z-way-server not running"));else{var d=this;this._logger.log("trace",
"backup zwave usb stick");h.backup(c+"/zway",function(f){d._logger.log("trace","backup zwave usb stick "+(f?" failed:"+f.message:" success"));d._state=0;g&&g(f)})}else this._state=0,g&&g()}};k.prototype._startAndCheck=function(c,e,g){var h=this;this._start(function(a){if(a)g&&g(a);else{var b=0,d=function(f,l){f?g&&g(f):l?g&&g():(b++,b<c?setTimeout(function(){h._isRunning(d)},e):g&&g(Error("z-way-server do not run after execute start command")))};setTimeout(function(){h._isRunning(d)},e)}})};k.prototype._stopAndCheck=
function(c,e,g){var h=this;this._stop(function(a){if(a)g&&g(a);else{var b=0,d=function(f,l){f?g&&g(f):l?(b++,b<c?setTimeout(function(){h._isRunning(d)},e):g&&g(Error("z-way-server still run after execute stop command"))):g&&g()};setTimeout(function(){h._isRunning(d)},e)}})};k.prototype._isRunning=function(c){this._logger.log("trace","check z-way-server pid");var e=require("child_process").exec;e=e("pidof z-way-server");var g=this,h=null;e.stdout.on("data",function(a){g._logger.log("trace","get z-way-server pid out:"+
String(a));h=String(a)});e.on("error",function(a){g._logger.log("trace","get z-way-server pid error:"+a.message);c&&(c(a),c=null)});e.on("close",function(a){g._logger.log("trace","get z-way-server pid finish: code="+a);0==a?c&&(c(null,h?!0:!1),c=null):1==a?c&&(c(null,!1),c=null):c&&(c(Error("get z-way-server pid failed, return code:"+a)),c=null)})};k.prototype._start=function(c){var e=k.SCRIPT+" start";this._logger.log("trace","start z-way-server with command:"+e);var g=require("child_process").exec;
e=g(e);var h=this;e.stdout.on("data",function(a){h._logger.log("trace","start z-way-server out:"+String(a))});e.on("error",function(a){h._logger.log("trace","start z-way-server error:"+a.message);c&&(c(a),c=null)});e.on("close",function(a){h._logger.log("trace","start z-way-server "+(0==a?"success":"failed"));0!=a?c&&(c(Error("start z-way-server failed, return code:"+a)),c=null):c&&(c(0==a?null:Error("start z-way-server failed")),c=null)})};k.prototype._stop=function(c){var e=k.SCRIPT+" stop";this._logger.log("trace",
"stop z-way-server with command:"+e);var g=require("child_process").exec;e=g(e);var h=this;e.stdout.on("data",function(a){h._logger.log("trace","stop z-way-server out:"+String(a))});e.on("error",function(a){h._logger.log("trace","stop z-way-server error:"+a.message);c&&(c(a),c=null)});e.on("close",function(a){h._logger.log("trace","stop z-way-server "+(0==a?"success":"failed"));c&&(c(0==a?null:Error("stop z-way-server failed")),c=null)})};k.prototype._reset=function(c,e){var g=this._getConfigFolder(),
h=this._getAutomationStorageFolder();c||this._logger.log("trace","clear z-way-server config folder:"+g);this._logger.log("trace","clear z-way-server automation storage folder:"+h);g="rm -f "+g+"/zddx/*.xml && rm -f "+h+"/*.json";c&&(g="rm -f "+h+"/*.json");c=require("child_process").exec;c=c(g);var a=this;c.stdout.on("data",function(b){a._logger.log("trace","reset z-way-server out:"+String(b))});c.on("error",function(b){a._logger.log("trace","reset z-way-server error:"+b.message);e&&(e(b),e=null)});
c.on("close",function(b){a._logger.log("trace","clear z-way-server config "+(0==b?"success":"failed"));e&&(e(0==b?null:Error("clear z-way-server config failed")),e=null)})};k.prototype._restore=function(c,e,g){this._logger.log("trace","retore zway data (restoreUZB="+e+") from:"+c+" to:"+k.FOLDER);var h=require("fs"),a=require("fs-extra");if(!e&&h.existsSync(c+"/zway/config")&&h.existsSync(k.FOLDER)){this._logger.log("trace","copy zway data from:"+c+"/zway/config to:"+this._getConfigFolder());try{a.copySync(c+
"/zway/config",this._getConfigFolder())}catch(b){}}if(h.existsSync(c+"/zway/automation/storage")&&h.existsSync(this._getAutomationFolder())){this._logger.log("trace","copy zway data from:"+c+"/zway/automation/storag to:"+this._getAutomationStorageFolder());try{a.copySync(c+"/zway/automation/storage",this._getAutomationStorageFolder())}catch(b){}}g&&g()};return k}();
x.hub.v6.Handler=function(){var k=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.Handler");this._centralUnit=null;this._recovery=new x.hub.v6.Recovery;this._sysConf=new x.hub.v6.SystemConf;this._stm=new x.hub.v6.STM(this,global.STM?global.STM:null);this._led=new x.hub.v6.LED;this._resetPin=new x.hub.v6.ResetPin(this);this._network=new x.hub.v6.Network(this);this._time=new x.hub.v6.Time(this);this._location=new x.hub.v6.Location(this);this._zwayServer=new x.hub.v6.ZwayServer(this);
this._extraInfo=new x.hub.v6.ExtraInfo(this);this._hub=null};k.prototype.CentralUnit=x.hub.v6.CentralUnit;k.prototype.LED=x.hub.v6.LED;k.prototype.ResetPin=x.hub.v6.ResetPin;k.prototype.init=function(c,e){var g=this;this._hub=c;this._led.init();this._resetPin.init();this._recovery.init();this._sysConf.init(function(){g._network.init();g._time.init();e&&e()});this._stm.init();this._zwayServer.init()};k.prototype.setIPData=function(c,e){var g=this,h=function(d,f){if(d.MAC)if(12==d.MAC.length&&d.MAC.match(/^([a-fA-F0-9]{2}){6}/g)){g._logger.log("trace",
"set mac:"+d.MAC);var l=d.MAC.substr(0,2)+":"+d.MAC.substr(2,2)+":"+d.MAC.substr(4,2)+":"+d.MAC.substr(6,2)+":"+d.MAC.substr(8,2)+":"+d.MAC.substr(10,2),m=new Buffer(d.MAC,"hex");g._logger.log("trace","set mac "+d.MAC+" on stm");g._stm.sendCommand(57,m,function(n){n&&n.error?(g._logger.log("trace","set mac "+d.MAC+" on stm failed: "+n.error),f(err,!1)):(g._logger.log("trace","set mac "+d.MAC+" on file"),g._network.setMAC(l,function(p){f(p,p?!1:!0)}))})}else f(Error("invalid mac address"));else f(null,
!1)},a=function(d,f){if(1!=d.DHCP&&0!=d.DHCP)f(null,!1);else{var l={dhcp:!0};if(0==d.DHCP){if(!(d.IP&&d.SN&&d.GW&&d.DNS)){f(Error("invalid static ip settings"));return}l.dhcp=!1;l.ip=d.IP;l.subnet=d.SN;l.router=d.GW;l.dns=d.DNS.split(",")}g._logger.log("trace","set network eth0:"+JSON.stringify(l));g._network.setNetwork("eth0",l,function(m){f(m,m?!1:!0)})}},b=!1;this._logger.log("trace","set ip data:"+JSON.stringify(c));(function(d,f){d.NTP?(g._logger.log("trace","set ntp:"+d.NTP),d=d.NTP.split(","),
g._time.setNTPServers(d,function(l){f(l,!1)})):f(null,!1)})(c,function(d,f){d?(g._logger.log("trace","set ntp failed:"+d.stack),e&&e(d)):(b=b||f,h(c,function(l,m){l?(g._logger.log("trace","set mac failed:"+l.stack),e&&e(l)):(b=b||m,a(c,function(n,p){n?(g._logger.log("trace","set network failed:"+n.stack),e&&e(n)):(b=b||p,g._logger.log("trace","set ip data finish (reboot="+b+")"),e&&e(null,b))}))}))})};k.prototype.setTZData=function(c,e){c?this._time.setTimezoneEncoded(c,function(g){e&&e(g)}):e&&e(Error("invalid timezone"))};
k.prototype.getTZData=function(c){this._time.getTimezoneEncoded(c)};k.prototype.setLocation=function(c,e,g){this._location.setLocation(c,e,g)};k.prototype.getLocation=function(c){this._location.getLocation(c)};k.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync()};k.prototype.setTime=function(c,e){this._time.setTime(c,e)};k.prototype.reboot=function(c,e,g){this._logger.log("trace","reboot");if("PI-CM3+"!=global.PLATFORM)g&&g();else{var h=this;require("async").series([function(a){"recovery"==
c?h._recovery.createEmptyFile(function(b){a(b)}):a()},function(a){e?setTimeout(function(){a()},e):a()},function(a){h._reboot(a)}],function(a){g&&g(a)})}};k.prototype._reboot=function(c){var e=require("child_process").exec;e=e("reboot");e.on("error",function(g){c&&(c(g),c=null)});e.on("close",function(g){c&&(c(0==g?null:Error("system reboot failed")),c=null)})};k.prototype.poweroff=function(c,e){this._logger.log("trace","power off");if("PI-CM3+"!=global.PLATFORM)e&&e();else{var g=this;require("async").series([function(h){c?
setTimeout(function(){h()},c):h()},function(h){g._led.setColor(0,0,0,function(){h()})},function(h){g._poweroff(h)}],function(h){e&&e(h)})}};k.prototype._poweroff=function(c){var e=require("child_process").exec;e=e("poweroff");e.on("error",function(g){c&&(c(g),c=null)});e.on("close",function(g){c&&(c(0==g?null:Error("system poweroff failed")),c=null)})};k.prototype.reset=function(c,e){this._logger.log("trace","reset "+c);var g=this;switch(c){case "network":this._network.resetNetwork(function(h){e&&
e(h,h?!1:!0)});break;case "factory":this._logger.log("trace","reset stm");this._stm.reset(function(h){g._logger.log("trace","reset stm "+(h?"failed:"+h.message:"success"));h?e&&e(h,h?!1:!0):(g._logger.log("trace","reset z-way-server"),g._zwayServer.reset(function(a){g._logger.log("trace","reset z-way-server "+(a?"failed:"+a.message:"success"));a?e&&e(a,a?!1:!0):(g._logger.log("trace","reset network"),g._network.resetNetwork(function(b){g._logger.log("trace","reset network "+(b?"failed:"+b.message:
"success"));g._logger.log("trace","reset system.conf");g._sysConf.reset(function(d){g._logger.log("trace","reset system.conf "+(d?"failed:"+d.message:"success"));e&&e(d,d?!1:!0)})}))}))});break;default:e&&e(Error("unknonw reset type: "+c))}};k.prototype.getSTM=function(){return this._stm};k.prototype.updateSTM=function(c,e,g){var h=this,a=function(b,d,f){var l=function(m){m&&m.progress&&d.write(m.progress+".")};h._led.startFlashSTM(function(){h._stm.on("flash",l);h._stm.flashFirmware(b,function(m){h._stm.removeListener("flash",
l);m?d.write(JSON.stringify({XC_ERR:{code:"000000",msg:m.message}})):d.write(JSON.stringify({XC_SUC:{}}));d.end();h._led.stopFlashSTM(function(){f&&f(m)})})})};c?this._saveTempFile("stm.bin",c,function(b,d){b?g&&g(b):a(d,e,g)}):a(null,e,g)};k.prototype._saveTempFile=function(c,e,g){var h=require("fs"),a=require("os"),b=require("path");a=a.tmpdir();var d=b.join(a,c);h.existsSync(b)&&h.unlinkSync(b);var f=h.createWriteStream(d);e.pipe(f);f.on("finish",function(){f.close(function(){g&&g(null,d)})});
f.on("error",function(l){h.unlink(d);g&&g(l)})};k.prototype.backup=function(c,e,g){var h=this,a=function(m,n,p){var t=require("fs-extra"),r=require("path"),z=require("os").tmpdir(),u=require("archiver"),q=new Date,v=q.getFullYear()+"",y=q.getMonth()+1+"";1==y.length&&(y="0"+y);var B=q.getDate()+"";1==B.length&&(B="0"+B);var w=q.getHours()+"";1==w.length&&(w="0"+w);var A=q.getMinutes()+"";1==A.length&&(A="0"+A);q=q.getSeconds()+"";1==q.length&&(q="0"+q);var C="backup_"+(v+y+B+w+A+q)+".xbp",D=r.join(z,
C);r=t.createWriteStream(D);u=u("zip");r.on("close",function(){if(n){var E=require("crypto").createCipher("aes-256-cbc",n),G=t.createReadStream(D),F=t.createWriteStream(D+".enc");F.on("finish",function(){t.removeSync(D);p(null,D+".enc",C)});G.pipe(E).pipe(F)}else p(null,D,C)});r.on("error",function(E){h._logger.log("warn","write backup zip file failed:"+E.message);p(E)});u.on("error",function(E){h._logger.log("warn","zip backup data failed:"+E.message);p(E)});u.pipe(r);u.directory(m+"/","backup");
u.finalize()},b=null,d=require("x.crypt.js");c.query.enc&&"0"!=c.query.enc&&"false"!=c.query.enc&&(c.query.at?b=c.query.at:c.query.auth&&(b=d.MD5(unescape(encodeURI(c.query.auth+"_SALT!")))));this._logger.log("trace","generate backup"+(b?" (encrypted)":""));d=require("fs");var f=require("os").tmpdir(),l=require("path").join(f,"backup");if(d.existsSync(l))try{d.rmdirRecursiveSync(l)}catch(m){}try{this._logger.log("trace","create backup folder: "+l),d.mkdirSync(l)}catch(m){e.status(500).json({code:-1,
message:'create backup folder "'+l+'" failed:'+m.message});this._logger.log("trace",'create backup folder "'+l+'" failed:'+m.message);g&&g(Error('create backup folder "'+l+'" failed:'+m.message));return}this._logger.log("trace","assemble backup files");this._backup(l,c.query,function(m){m?(e.status(500).json({code:m.code?m.code:-2,message:"assemble backup files failed:"+m.message}),h._logger.log("warn","assemble backup files failed:"+m.message),g&&g(m)):(h._logger.log("trace","compress backup files"),
a(l,b,function(n,p,t){n?(e.status(500).json({code:-3,message:"compress backup files failed:"+n.message}),h._logger.log("warn","compress backup files failed:"+n.message),g&&g(n)):(h._logger.log("trace","return backup file:"+p),e.setHeader("Content-disposition","attachment; filename="+t),e.sendFile(p,null,function(r){require("fs-extra").removeSync(p);r?(h._logger.log("warn","return backup file failed:"+r.message),e.status(500).json({code:-4,message:"return backup file failed:"+r.message})):h._logger.log("trace",
"backup data finish");g&&g(r)}))}))})};k.prototype._backup=function(c,e,g){var h=null;if(e)if("true"==e.backup_uzb||1==e.backup_uzb||"1"==e.backup_uzb)h=!0;else if("false"==e.backup_uzb||0==e.backup_uzb||"0"==e.backup_uzb)h=!1;var a=this;require("async").series([function(b){a._zwayServer?(a._logger.log("trace","backup zwave data"),a._zwayServer.backup(c,h,function(d){a._logger.log("trace","backup zwave data "+(d?" failed:"+d.message:" success"));if(d){var f=Error("backup zwave data failed: "+d.message);
f.code=d.code?d.code:-210}b(f)})):b()},function(b){a._stm?(a._logger.log("trace","backup stm data"),a._stm.backup(c,function(d){a._logger.log("trace","backup stm data "+(d?" failed:"+d.message:" success"));if(d){var f=Error("backup stm data failed: "+d.message);f.code=d.code?d.code:-220}b(f)})):b()},function(b){a._network?(a._logger.log("trace","backup network config"),a._network.backup(c,function(d){a._logger.log("trace","backup network config "+(d?" failed:"+d.message:" success"));if(d){var f=Error("backup network config failed: "+
d.message);f.code=d.code?d.code:-230}b(f)})):b()},function(b){a._sysConf?(a._logger.log("trace","backup system config"),a._sysConf.backup(c,function(d){a._logger.log("trace","backup system config "+(d?" failed:"+d.message:" success"));if(d){var f=Error("backup system config failed: "+d.message);f.code=d.code?d.code:-240}b(f)})):b()},function(b){var d=require("fs-extra"),f=require("path"),l=require("x.hub.fileman.js").fileManager.getUserRootDataPath();a._logger.log("trace","backup general data");d.copy(l,
f.join(c,"data"),{dereference:!0},function(m){if(m){a._logger.log("trace","backup general data failed:"+m.message);var n=Error("backup system config failed: "+m.message);n.code=m.code?m.code:-250;b(n)}else m=f.join(c,"data","localstorage","x.hub.Server.lock"),d.existsSync(m)&&d.removeSync(m),d.exists(f.join(c,"data","localstorage","x.hub.Server.pin"),function(p){p&&d.removeSync(f.join(c,"data","localstorage","x.hub.Server.pin"));d.exists(f.join(c,"data","localstorage","x.hub.Server.pwd"),function(t){t?
d.remove(f.join(c,"data","localstorage","x.hub.Server.pwd"),function(r){a._logger.log("trace","backup general data "+(r?" failed:"+r.message:" success"));if(r){var z=Error("backup general data failed: "+r.message);z.code=r.code?r.code:-250}b(z)}):(a._logger.log("trace","backup general data success"),b())})})})},function(b){a._logger.log("trace","backup plugins started ...");require("./pluginmanager").backup(c,function(d,f){a._logger.log("trace","backup plugins finished!");if(d){try{var l=JSON.stringify(d)}catch(m){l=
"can not stringify error"}a._logger.log("error",l);b(d)}else b(null,f)})}],function(b){g&&g(b)})};k.prototype.restore=function(c,e,g){var h=function(f,l,m){var n=require("fs"),p=require("fs-extra"),t=require("os").tmpdir(),r=require("path"),z=r.join(t,"restore"),u=r.join(z,"backup");if(p.existsSync(z))try{p.removeSync(z)}catch(y){m(y);return}var q=require("adm-zip"),v=null;try{(new q(f)).extractAllTo(z,!0)}catch(y){d._logger.log("warn","backup file may be encrypted"),v="invalid backup file/password"}v?
l?(d._logger.log("trace","decrpyt backup file"),l=require("crypto").createDecipher("aes-256-cbc",l),t=n.createReadStream(f),n=n.createWriteStream(f+".dec.zip"),l.on("error",function(){p.removeSync(f);p.removeSync(f+".dec.zip");m(Error(v))}),n.on("finish",function(){v=null;try{(new q(f+".dec.zip")).extractAllTo(z,!0)}catch(y){v="invalid backup file/password"}p.removeSync(f);p.removeSync(f+".dec.zip");m(v?Error(v):null,u)}),t.pipe(l).pipe(n)):(p.removeSync(f),m(Error(v)),m=null):(p.removeSync(f),m(null,
u),m=null)},a=require("x.crypt.js"),b=null;c.query.key?b=c.query.key:c.query.at?b=c.query.at:c.query.auth&&(b=a.MD5(unescape(encodeURI(c.query.auth+"_SALT!"))));var d=this;this._logger.log("trace","restore backup");(function(f,l){var m=require("fs"),n=require("os").tmpdir(),p=require("path").join(n,"restore.zip");if(m.existsSync(p))try{m.unlinkSync(p)}catch(r){l(r);return}var t=m.createWriteStream(p);f.pipe(t);t.on("finish",function(){t.close(function(){l(null,p)})});t.on("error",function(r){m.unlink(p);
l(r)})})(c,function(f,l){f?(d._logger.log("warn","download backup file failed: "+f.message),e.json({XC_ERR:{code:-1,msg:"donwload backup file failed:"+f.message}}),g&&g(f)):(d._logger.log("trace","extract backup data from: "+l),h(l,b,function(m,n){m?(d._logger.log("warn","extract backup data failed: "+m.message),e.json({XC_ERR:{code:-2,msg:"extract backup data failed:"+m.message}}),g&&g(m)):(d._logger.log("trace","restore data from: "+n),d._restore(n,c.query,function(p){try{var t=require("fs-extra");
t.removeSync(l);t.removeSync(n)}catch(r){}p?(d._logger.log("warn","restore data failed: "+p.message),e.json({XC_ERR:{code:p.code?p.code:-3,msg:"restore backup data failed:"+p.message}})):(d._logger.log("trace","restore data finish"),e.json({XC_SUC:{}}),d.reboot(null,1E3));g&&g(p)}))}))})};k.prototype._restore=function(c,e,g){var h=null;if(e)if("true"==e.restore_uzb||1==e.restore_uzb||"1"==e.restore_uzb)h=!0;else if("false"==e.restore_uzb||0==e.restore_uzb||"0"==e.restore_uzb)h=!1;var a=!1,b=require("fs"),
d=require("fs-extra"),f=require("path");b.existsSync(c+"/config/system.conf")||(a=!0);var l=this;require("async").series([function(m){l._zwayServer?(l._logger.log("trace","restore zwave data"),l._zwayServer.restore(c,{restoreUZB:h,backupType:a?"v5+":"v6+"},function(n){l._logger.log("trace","restore zwave data"+(n?" failed:"+n.message:" success"));if(n){var p=Error("restore zwave data failed: "+n.message);p.code=n.code?n.code:-310}m(p)})):m()},function(m){l._stm?(l._logger.log("trace","restore stm data"),
l._stm.restore(c,function(n){l._logger.log("trace","restore stm data"+(n?" failed:"+n.message:" success"));if(n){var p=Error("restore stm data failed: "+n.message);p.code=n.code?n.code:-320}m(p)})):m()},function(m){l._logger.log("trace","restore location");l._location.restore(c,{backupType:a?"v5+":"v6+"},function(n){l._logger.log("trace","restore location "+(n?" failed:"+n.message:" success"));if(n){var p=Error("restore location failed: "+n.message);p.code=n.code?n.code:-360}m(p)})},function(m){l._logger.log("trace",
"restore timezone");l._time.restore(c,{backupType:a?"v5+":"v6+"},function(n){l._logger.log("trace","restore timezone"+(n?" failed:"+n.message:" success"));if(n){var p=Error("restore timezone failed: "+n.message);p.code=n.code?n.code:-370}m(p)})},function(m){if(a){l._logger.log("trace","remove v5+ cloud connection settings");var n=f.join(c,"data","localstorage","x.hub.v5.cloudKey"),p=f.join(c,"data","localstorage","x.hub.v5.cloudServer"),t=f.join(c,"data","localstorage","x.hub.v5.cloudPort");try{b.existsSync(n)&&
(l._logger.log("trace","remove v5+ cloud key file: "+n),b.unlinkSync(n)),b.existsSync(p)&&(l._logger.log("trace","remove v5+ cloud server file: "+p),b.unlinkSync(p)),b.existsSync(t)&&(l._logger.log("trace","remove v5+ cloud port file: "+t),b.unlinkSync(t))}catch(r){}}m()},function(m){if(l._network)if(a){var n=f.join(c,"data","localstorage","x.hub.v5.config");try{b.existsSync(n)&&(l._logger.log("trace","remove v5+ config file: "+n),b.unlinkSync(n))}catch(p){}m()}else l._logger.log("trace","restore network config"),
l._network.restore(c,function(p){l._logger.log("trace","restore network config"+(p?" failed:"+p.message:" success"));if(p){var t=Error("restore network config failed: "+p.message);t.code=p.code?p.code:-340}m(t)});else m()},function(m){var n=function(q,v,y){l._logger.log("trace","move "+q+" to "+v);d.exists(q,function(B){B?d.rename(q,v,function(w){w&&l._logger.log("trace","move "+q+" to "+v+" failed:"+w.message);y(w)}):(l._logger.log("trace",q+" not exist"),y())})},p=function(q,v,y){l._logger.log("trace",
"restore current lock,pin,pwd");var B=f.join(q,"localstorage","x.hub.Server.lock"),w=f.join(v,"x.hub.Server.lock"),A=f.join(q,"localstorage","x.hub.Server.pin"),C=f.join(v,"x.hub.Server.pin"),D=f.join(q,"localstorage","x.hub.Server.pwd"),E=f.join(v,"x.hub.Server.pwd");n(w,B,function(){n(C,A,function(){n(E,D,function(){y()})})})},t=function(q,v){l._logger.log("trace","clear "+q);d.emptyDir(q,function(y){y&&l._logger.log("trace","clear "+q+" failed:"+y.message);v(y)})};l._logger.log("trace","restore standard data");
var r=require("x.hub.fileman.js").fileManager,z=r.getUserRootDataPath(),u=r.getTmpDir();(function(q,v,y){l._logger.log("trace","backup current lock,pin,pwd");var B=f.join(q,"localstorage","x.hub.Server.lock"),w=f.join(v,"x.hub.Server.lock"),A=f.join(q,"localstorage","x.hub.Server.pin"),C=f.join(v,"x.hub.Server.pin"),D=f.join(q,"localstorage","x.hub.Server.pwd"),E=f.join(v,"x.hub.Server.pwd");n(B,w,function(){n(A,C,function(){n(D,E,function(){y()})})})})(z,u,function(){t(z,function(){d.copy(f.join(c,
"data"),z,function(q){l._logger.log("trace","restore standard data"+(q?" failed:"+q.message:" success"));if(q){var v=Error("restore standard data failed: "+q.message);v.code=q.code?q.code:-330}p(z,u,function(){m(v)})})})})},function(m){l._sysConf?(l._logger.log("trace","restore system config"),l._sysConf.restore(c,function(n){l._logger.log("trace","restore system config"+(n?" failed:"+n.message:" success"));if(n){var p=Error("restore system config failed: "+n.message);p.code=n.code?n.code:-350}m(p)})):
m()},function(m){l._logger.log("trace","restore plugins started ...");require("./pluginmanager").restore(c,function(n,p){l._logger.log("trace","restore plugins finished!");n?m(n):m(null,p)})}],function(m){g&&g(m)})};k.prototype.updateFirmware=function(c,e){var g=this,h=function(a,b){g._recovery.setFirmwareUpdateUrl(a,function(d){b(d)})};this._logger.log("trace","update firmware with url:"+c);(function(a,b){if(a){a=require("url").parse(a);var d=80;if(a.port){d=parseInt(a.port);if(0===d||isNaN(d))d=
80;if(!(0<d&&65536>d)){b(Error("invalid port"));return}}"https:"==a.protocol&&80==d&&(d=443);d={host:a.hostname,port:d,path:a.path,method:"HEAD"};a=require("https:"==a.protocol?"https":"http").request(d,function(f){b&&(200==f.statusCode?b():b(Error("http response code:"+f.statusCode)),b=null)});a.setTimeout(5E3,function(){b&&(b(Error("http timeout")),b=null)});a.on("error",function(f){b&&(b(f),b=null)});a.end()}else b(Error("invalid firmware url"))})(c,function(a){g._logger.log("trace","check online firmware"+
(a?" failed:"+a.message:" success"));a?e&&e(Error("check online firmware failed:"+a.message)):(g._logger.log("trace","set reboot to recovery mode"),h(c,function(b){g._logger.log("trace","save firmware url"+(b?" failed:"+b.message:" success"));e&&e(b?Error("save firmware url failed:"+b.message):null,b?!1:!0)}))})};k.prototype.getExtraInfo=function(c){this._extraInfo.getInfo(c)};k.prototype.getSTMSettings=function(c){this._stm.getSettings(c)};return k}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v6.Handler);
