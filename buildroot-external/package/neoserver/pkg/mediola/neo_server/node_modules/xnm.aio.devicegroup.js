var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.devicegroup=xnm.aio.devicegroup||{};
xnm.aio.devicegroup.Group=function(){var d=function(a){this.info=a};d.prototype.executeCommandCreator=function(a,c,b,h){if(this.info&&this.info.devices)if(c&&c.value)if(h)if(0==this.info.devices.length)b&&b();else{var n=this,v=0,w=function(q){v++;v==n.info.devices.length?b&&b():n._executeCommand(h,n.info.devices[v],c,w)};this._executeCommand(h,this.info.devices[v],c,w)}else b&&b(Error("commandhandler invlaid"));else b&&b(Error("command value is empty"));else b&&b(Error("info devices is invalid"))};
d.prototype._executeCommand=function(a,c,b,h){a._executeCommand({device:{room:c.room,name:c.device},cmd:b},function(n){h&&h(n)})};return d}();
xnm.aio.devicegroup.DM=function(){var d=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="DeviceGroupDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"devicegroup",createDevice:function(a,c,b){c=d.ERROR_CODE;a?a.devices?b(null,a):b(new d(c.INVALID,"devices is invalid")):b(new d(c.INVALID,"info is invalid"))},updateDevice:function(a,c,b){c=d.ERROR_CODE;a?a.devices?
b(null,a):b(new d(c.INVALID,"devices is invalid")):b(new d(c.INVALID,"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c,b,h){var n=function(e,z){if("*"==e)return!0;for(var m=!1,l=0;l<e.length;l++)if(e[l]==z){m=!0;break}return m},v=function(e,z,m){var l=[];switch(m.catagory){case "command":e.command&&e.command.forEach(function(g){n(m.elems,g.type)&&(g=JSON.parse(JSON.stringify(g)),l.push(g))});break;case "status":e.status&&e.status.forEach(function(g){n(m.elems,g.type)&&
(g=JSON.parse(JSON.stringify(g)),l.push(g))})}return l};b=function(e,z){var m=[];if(e&&h&&h.findDevice&&h.dm&&e.devices&&0!=e.devices.length){var l={command:[],status:[]};for(var g=0;g<e.devices.length;g++)if(e.devices[g]){var k=h.findDevice(e.devices[g].room,e.devices[g].device);if(k&&k.info&&k.info.sys){var f=h.dm.getModule(k.info.sys);if(f&&f.devicemanager&&f.devicemanager.applyUIFilter&&(k=f.devicemanager.applyUIFilter(k.info,c,h.deviceinfo,h))){if(k.command){f=l;var x=k.command;if(f.command){for(var r=
[],t=0;t<x.length;t++){var y=!1,p=x[t];if(p&&p.ref&&p.ref.value){for(var u=0;u<f.command.length;u++){var A=f.command[t];if(A&&A.ref&&A.ref.value&&p.ref.value==A.ref.value){y=!0;break}}y||r.push(p)}}f.command=f.command.concat(r)}else f.command=x}if(k.status)if(f=l,k=k.status,f.status){x=[];for(r=0;r<k.length;r++)if(t=!1,(y=k[r])&&y.ref&&y.ref.value){for(p=0;p<f.status.length;p++)if((u=f.status[r])&&u.ref&&u.ref.value&&u.ref.value==u.ref.value){t=!0;break}t||x.push(y)}f.status=f.status.concat(x)}else f.status=
k}}}}else l=null;l&&(e=v(l,e,z),m=m.concat(e));return m};if(!a.sys)return null;var w=JSON.parse(JSON.stringify(a)),q=null;switch(c.catagory){case "command":q=b(a,c);w.command=q;break;case "status":q=b(a,c);w.status=q;break;default:return null}return q&&0!=q.length?w:null}}}();
xnm.aio.devicegroup.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.devicegroup.DM;d.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"devicegroup")};d.prototype.resolveDevice=function(a){return a&&a.devices?new xnm.aio.devicegroup.Group(a):null};return d}();"undefined"!=typeof module&&module&&module.exports&&(module.exports=new xnm.aio.devicegroup.Handler);
