var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.synology=xnm.aio.synology||{};
xnm.aio.synology.Syno=function(){var k={},n={Auth:{path:"/auth.cgi",api:"SYNO.API.Auth",version:3,login:function(c,a){c._doApiReq({path:this.path,api:this.api,version:this.version,method:"login",account:c.username,passwd:c.password},function(b,d){b?a&&a(b):d&&d.sid?a&&a(null,d.sid):(b=Error("login response format invalid"),b.code=-1,a&&a(b))})},logout:function(c,a){c._doApiReq({path:this.path,api:this.api,version:this.version,method:"logout",account:c.username,passwd:c.password},function(b){a&&a(b)})}}},
h=function(c,a,b,d){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.synology.Syno");this.ip=c;this.port=a;this.port||(this.port=5E3);this.username=b;this.password=d};h.prototype.getPlaylist=function(c){var a=this;this._login(function(b){b?c&&c(b):h.AudioStation.Playlist.list(a,function(d,e){a._logout(function(){c&&c(d,e)})})})};h.prototype.playPlaylist=function(c,a,b){var d=this;this._login(function(e){if(e)b&&b(e);else{var f={library:c.library,
offset:0,limit:1,play:!0,id:a};h.AudioStation.RemotePlayer.updateplaylist(d,[{type:"playlist",id:c.id}],f,function(g){g?b&&b(g):(f={action:"play",value:0,id:a},h.AudioStation.RemotePlayer.control(d,f,function(l){d._logout(function(){b&&b(l)})}))})}})};h.prototype.getPlayerStatus=function(c,a){var b=this;this._login(function(d){d?a&&a(d):h.AudioStation.RemotePlayer.getstatus(b,{id:c},function(e,f){b._logout(function(){a&&a(e,f)})})})};h.prototype.stop=function(c,a){var b=this;this._login(function(d){d?
a&&a(d):h.AudioStation.RemotePlayer.control(b,{action:"stop",value:0,id:c},function(e){b._logout(function(){a&&a(e)})})})};h.prototype._getSid=function(){return k[this.ip]};h.prototype._setSid=function(c){k[this.ip]=c};h.prototype._login=function(c){var a=this;n.Auth.login(this,function(b,d){b?c&&c(b):(a._setSid(d),c&&c())})};h.prototype._logout=function(c){var a=this;n.Auth.logout(this,function(b){a._setSid(null);c&&c(b)})};h.prototype._doApiReq=function(c,a){var b=this,d=this._getSid();if(d||"SYNO.API.Auth"==
c.api||"login"==c.method){var e=[];d&&e.push("_sid="+d);for(var f in c)c.hasOwnProperty(f)&&"path"!=f&&e.push(f+"="+encodeURIComponent(c[f]));e=e.join("&");this._doRequest("GET","/webapi"+c.path+"?"+e,null,function(g,l){if(g)g.code=-1,a&&a(g);else try{var m=JSON.parse(l);m.success?a&&a(null,m.data):(g=Error("api error"),g.code=m.error?m.error.code:-1,a&&a(g))}catch(p){p.code=-1,a&&a(p)}})}else this._login(function(g){g?a&&a(g):b._doApiReq(c,a)})};h.prototype._doRequest=function(c,a,b,d){var e=this;
a="http://"+this.ip+":"+this.port+a;this._logger.log("trace","send "+c+" to url:"+a+" data:"+b);var f=d;$.ajax({url:a,type:c,timeout:this.timeout,data:b,dataType:"text",cache:!0,success:function(g){e._logger.log("trace","http request success:"+g);f&&(f(null,g),f=null)},error:function(g,l){g="http request error:"+(g?g.status:"0")+"-"+l;e._logger.log("trace",g);f&&(f(Error(g)),f=null)}})};h.API=n;h.AudioStation={Playlist:{path:"/AudioStation/playlist.cgi",api:"SYNO.AudioStation.Playlist",version:2,
list:function(c,a){c._doApiReq({path:this.path,api:this.api,version:this.version,method:"list"},function(b,d){b?a&&a(b):d&&d.playlists?a&&a(null,d.playlists):(b=Error("playlist list response format invalid"),b.code=-1,a&&a(b))})}},RemotePlayer:{path:"/AudioStation/remote_player.cgi",api:"SYNO.AudioStation.RemotePlayer",version:2,updateplaylist:function(c,a,b,d){var e={path:this.path,api:this.api,version:this.version,method:"updateplaylist"},f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);e.containers_json=
JSON.stringify(a);c._doApiReq(e,function(g){d&&d(g)})},control:function(c,a,b){var d={path:this.path,api:this.api,version:this.version,method:"control"},e;for(e in a)a.hasOwnProperty(e)&&(d[e]=a[e]);c._doApiReq(d,function(f){b&&b(f)})},getstatus:function(c,a,b){var d={path:this.path,api:this.api,version:this.version,method:"getstatus"},e;for(e in a)a.hasOwnProperty(e)&&(d[e]=a[e]);c._doApiReq(d,function(f,g){f?b&&b(f):b&&b(null,g)})}}};return h}();
xnm.aio.synology.Handler=function(){var k=function(){};k.prototype.Syno=xnm.aio.synology.Syno;return k}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.synology.Handler);
