var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.yellowstone=xnm.aio.yellowstone||{};
xnm.aio.yellowstone.Cloudy=function(){var n=[1,2,3,4,5],e=function(a,b,c){this._taskBuffer=null;this._cloudy=a;this._command=b;this._callback=c};e.prototype.run=function(){this._cloudy._logger.log("debug","run command task: "+JSON.stringify(this._command));var a=this;if(this._command.raw)var b=this._cloudy._buildRawCommandReq(this._command.raw);else if(this._command.hexValue)b=this._cloudy._buildHexCommandReq(this._command.bg,this._command.sig,this._command.hexValue);else if("toggle"==this._command.command){var c=
this._cloudy._buildStateReq(this._command.bg);this._cloudy._doStateReq(c,function(d,f){if(d)!d||1!=d.errorCode&&2!=d.errorCode&&3!=d.errorCode?a._taskBuffer._finishLastTask(d):a._taskBuffer._finishAllTask(d);else{var k=a._command.sig;f&&f.intState&&"undefined"!=typeof f.intState[k]&&null!=f.intState[k]?(b=a._cloudy._buildCommandReq(a._command.bg,a._command.sig,0==f.intState[k]?1:0),a._cloudy._doCommandReq(b,function(p){!p||1!=p.errorCode&&2!=p.errorCode&&3!=p.errorCode?a._taskBuffer._finishLastTask(p):
a._taskBuffer._finishAllTask(p)})):a._taskBuffer._finishLastTask(d)}})}else b=this._cloudy._buildCommandReq(this._command.bg,this._command.sig,this._command.value);b&&this._cloudy._doCommandReq(b,function(d){!d||1!=d.errorCode&&2!=d.errorCode&&3!=d.errorCode?a._taskBuffer._finishLastTask(d):a._taskBuffer._finishAllTask(d)})};var h=function(a,b,c){this._taskBuffer=null;this._cloudy=a;this._bgs=b;this._callback=c};h.prototype.run=function(){this._cloudy._logger.log("debug","run status task: "+JSON.stringify(this._bgs));
var a=this,b={},c=0,d=function(k,p){k&&4!=k.errorCode&&5!=k.errorCode?1==k.errorCode||2==k.errorCode||3==k.errorCode?a._taskBuffer._finishAllTask(k):a._taskBuffer._finishLastTask(k):(p&&(b[a._bgs[c]]=p),c++,c<a._bgs.length?(k=-1==a._bgs[c]?a._cloudy._buildRawMsgReq():a._cloudy._buildStateReq(a._bgs[c]),a._cloudy._doStateReq(k,d)):a._taskBuffer._finishLastTask(null,b))};var f=-1==this._bgs[c]?this._cloudy._buildRawMsgReq():this._cloudy._buildStateReq(this._bgs[c]);this._cloudy._doStateReq(f,d)};var u=
function(a){this._cloudy=a;this._buffer=[]};u.prototype.executeTask=function(a){var b=this._buffer.length;a._taskBuffer=this;this._buffer.push(a);0==b&&this._doNextTask()};u.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};u.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var c=this._buffer[0];c&&c._callback&&(c._callback(a,b),c._callback=null);this._buffer.splice(0,1)}this._doNextTask()};u.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=
[];for(var c=0;c<b.length;c++)b[c]&&b[c]._callback&&(b[c]._callback(a),b[c]._callback=null)};var m=function(a){this._cloudy=a;this._logger=a._logger;this._buffer=[];this._dataBuffer=this._bufferEmptyTo=null};m.prototype.RESPONSE_TO=2E3;m.prototype.sendPacket=function(a,b){if(a){var c=this._buffer.length;this._buffer.push({packet:a,callback:b});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==c&&this._sendNextPacket()}else b&&b(Error("message is null"))};m.prototype._sendNextPacket=
function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._cloudy._sendPacket(b.packet,function(c){c?(c.errorCode=n[0],a._finishAllPacket(c)):b.timeout=setTimeout(function(){a._logger.log("warn","packet response timeout");var d=Error("packet reponse timeout");d.errorCode=n[3];a._finishLastPacket(d)},a.RESPONSE_TO)})}};m.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=
null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var c=this;this._bufferEmptyTo=setTimeout(function(){c._bufferEmptyTo=null;0==c._buffer.length&&c._cloudy._disconnect()},500)}else this._sendNextPacket()};m.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var c=0;c<b.length;c++)b[c]&&(b[c].timeout&&
(clearTimeout(b[c].timeout),b[c].timeout=null),b[c].callback&&(b[c].callback(a),b[c].callback=null))};m.prototype._hex2ascii=function(a){for(var b="",c=0;c<a.length;c+=2)b+=String.fromCharCode(parseInt(a.substr(c,2),16));return b};m.prototype._handlePacket=function(a){if(0<this._buffer.length&&this._buffer[0]){var b=this._buffer[0].packet;if(b&&3<=b.length)switch(b.substr(0,3)){case "CRO":case "CWO":case "CRS":a.raw&&2<=a.raw.length&&(a.params=a.raw.substr(1));break;case "CGO":a.raw&&2<=a.raw.length&&
(a.params=a.raw.substr(1).trim().split(" "))}this._logger.log("trace","parsed packet:"+JSON.stringify(a));this._finishLastPacket(null,a)}};m.prototype._handleData=function(){for(var a=null,b=!1,c=0;c<=this._dataBuffer.length-2;c+=2){var d=this._dataBuffer.substr(c,2),f=null;c<=this._dataBuffer.length-4&&(f=this._dataBuffer.substr(c+2,2));if("04"==d.toLowerCase()){a=this._dataBuffer.substr(0,c);b=!0;this._dataBuffer=c==this._dataBuffer.length-2?null:this._dataBuffer.substr(c+2);break}else if(("0d"==
d.toLowerCase()||"0a"==d.toLowerCase())&&"03"==f.toLowerCase()){a=this._dataBuffer.substr(0,c);this._dataBuffer=c==this._dataBuffer.length-4?null:this._dataBuffer.substr(c+4);break}}"undefined"!=typeof a&&null!=a&&(a=this._hex2ascii(a),c={},c.interrupt=b,c.raw=a,c.ok=">"==a.charAt(0),this._logger.log("trace","receive packet:"+JSON.stringify(c)),this._handlePacket(c));"undefined"!=typeof a&&null!=a&&this._dataBuffer&&this._handleData()};m.prototype._onSocketData=function(a){a&&(this._dataBuffer=this._dataBuffer?
this._dataBuffer+a:a);this._dataBuffer&&this._handleData()};m.prototype._onSocketTimeout=function(){};m.prototype._onSocketError=function(a){a.errorCode=n[1];this._finishAllPacket(a)};m.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=n[2];this._finishAllPacket(a)};var g=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.yellowstone.Cloudy");this._ip=a;this._port=b;this._port||(this._port=4E3);this._socket=null;this._taskBuffer=new u(this);this._packetBuffer=
new m(this)};g.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){switch(b.value){case "rawCmd":if(!b.ext){c&&c(Error("command rawCmd ext null"));return}var d={raw:b.ext};break;default:if(!a||"undefined"==typeof a.bg||null==a.bg||"undefined"==typeof a.sig||null==a.sig){c&&c(Error("device invalid"));return}switch(b.value){case "on":d={bg:a.bg,sig:a.sig,value:1};break;case "off":d={bg:a.bg,sig:a.sig,value:0};break;case "toggle":d={bg:a.bg,sig:a.sig,command:"toggle"};break;default:if("undefined"==
typeof b.ext||null==b.ext){c&&c(Error("command setValue ext null"));return}switch(b.value){case "setHex":d={bg:a.bg,sig:a.sig,hexValue:b.ext};break;case "setInt":b=parseInt(b.ext);d={bg:a.bg,sig:a.sig,value:b};break;case "setFloat":b=parseFloat(b.ext);if(0==parseFloat(a.scale))b=0;else{d=parseFloat(a.scale);if(isNaN(d)||!d)d=1;b=Math.round(b/d)}d={bg:a.bg,sig:a.sig,value:b}}}}d?this._executeCommand(d,c):c&&c(Error("no such command"))}else c&&c(Error("command is null"))};g.prototype.getStatesCreator=
function(a,b,c){if(b)if(0==b.length)c&&c(null,[]);else{a=[];for(var d=0;d<b.length;d++){var f=b[d];f&&(f=!f.device||f.device.ip?-1:f.device.bg,-1==a.indexOf(f)&&a.push(f))}this._getStates(a,function(k,p){k=[];if(p)for(var q=0;q<b.length;q++)if(b[q]&&b[q].id){var t="?";if((!b[q].device||b[q].device.ip)&&b[q].status&&b[q].status.value)"undefined"!=typeof p["-1"]&&null!=p["-1"]&&(t=p["-1"]);else if(b[q].device&&b[q].status&&b[q].status.value){var l=b[q].device.bg,r=b[q].device.sig,v=b[q].device.scale;
if("undefined"!=typeof l&&null!=l&&"undefined"!=typeof r&&null!=r&&p[l]&&(l=p[l],"undefined"!=typeof l&&null!=l))switch(b[q].status.value){case "stateHex":l.hexState&&l.hexState[r]&&(t=l.hexState[r]);break;case "stateFloat":l.intState&&"undefined"!=typeof l.intState[r]&&null!=l.intState[r]&&(t=l.intState[r],"undefined"!=typeof v&&null!=v&&(t*=parseFloat(v)));break;case "stateInt":l.intState&&"undefined"!=typeof l.intState[r]&&null!=l.intState[r]&&(t=l.intState[r]);break;case "stateBi":l.intState&&
"undefined"!=typeof l.intState[r]&&null!=l.intState[r]&&(t=l.intState[r],t=0==t?"off":"on")}}if("undefined"==typeof t||null==t)t="?";k.push({id:b[q].id,status:t})}c&&c(null,k)})}else c&&c(Error("deviceList is null"))};g.prototype._executeCommand=function(a,b){this._logger.log("debug","execute command: "+JSON.stringify(a));a=new e(this,a,b);this._taskBuffer.executeTask(a)};g.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));a=new h(this,a,b);this._taskBuffer.executeTask(a)};
g.prototype._resolveMsg=function(a){var b=null;a&&(a=a.params.replace(/"/g,""),">"==a.charAt(0)&&1<a.length&&(a=a.substr(1)),b=a.trim());return b};g.prototype._resolveStatus=function(a){var b=[],c=[];if(a.params)for(var d=0;d<a.params.length;d++){var f=parseInt(a.params[d],16);f&2147483648&&(f=(f&2147483647)-2147483648);for(var k=a.params[d];8>k.length;)k="0"+k;c.push(k);b.push(f)}return{hexState:c,intState:b}};g.prototype._doCommandReq=function(a,b){this._packetBuffer.sendPacket(a,function(c,d){c?
b(c):d&&!d.interrupt&&d.ok&&d.params?b():(c=Error("CWO response error"),c.errorCode=5,b(c))})};g.prototype._doStateReq=function(a,b){var c=this;this._packetBuffer.sendPacket(a,function(d,f){d?b(d):f&&!f.interrupt&&f.ok&&f.params?(d=0==a.indexOf("CRS")?c._resolveMsg(f):c._resolveStatus(f),b(null,d)):(d=Error("state (CGO, CRS) response error"),d.errorCode=5,b(d))})};g.prototype._buildCommandReq=function(a,b,c){-2147483648>c&&(c=-2147483648);2147483647<c&&(c=2147483647);0>c&&(c=c+2147483648|2147483648);
return"CWO "+a+" "+b+" "+c.toString(16)};g.prototype._buildRawCommandReq=function(a){return'CWR "'+a+'"'};g.prototype._buildHexCommandReq=function(a,b,c){8<c.length&&(c=c.substr(c.length-8));return"CWO "+a+" "+b+" "+c};g.prototype._buildStateReq=function(a){return"CGO "+a+" 0 64"};g.prototype._buildRawMsgReq=function(){return"CRS"};g.prototype._buildData=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));b.push(13);b.push(3);return new Buffer(b)};g.prototype._sendPacket=function(a,
b){if(this._socket){this._logger.log("trace","send packet:"+a);var c=this._buildData(a);this._socket.write(c,"binary");b()}else{var d=this;this._connect(function(f){f?b(f):d._sendPacket(a,b)})}};g.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,c={port:this._port,host:this._ip},d=require("net").connect(c);d.setTimeout(5E3);d.__connected=!1;d.setEncoding("hex");d.on("connect",function(){b._logger.log("trace","connect to cloudy:"+b._ip);d.__connected=!0;
b._socket=d;a()});d.on("data",function(f){b._logger.log("trace","receive from cloudy "+(d.__disconnected?"(closed)":"")+":"+b._ip+" data:"+f);d.__disconnected||b._packetBuffer._onSocketData(f)});d.on("error",function(f){d.__connected?(b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" error:"+f.message),d.destroy(),d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(f))):(b._logger.log("trace","cloudy:"+b._ip+" connection error:"+f.message),
a(f))});d.on("timeout",function(){d.__connected?(b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),d.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","cloudy:"+b._ip+" connection timeout"),d.destroy&&d.destroy(),a(Error("timeout")))});d.on("close",function(){b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" close socket");d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(d))});
d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();return d};g.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};g.prototype.toJSON=function(){return{sys:"cloudy",ip:this._ip,port:this._port}};g.prototype.equalsTo=function(a){return a&&a instanceof g?this._ip==a._ip&&this._port==a._port:!1};return g}();
xnm.aio.yellowstone.Handler=function(){var n=function(){};n.prototype.Cloudy=xnm.aio.yellowstone.Cloudy;n.prototype.devicemanager=null;n.prototype.registModule=function(e){e.register("cloudy","yellowstone")};n.prototype.resolveGateway=function(e){return e&&e.ip?new xnm.aio.yellowstone.Cloudy(e.ip,e.port):null};n.prototype.getDeviceCommands=function(e,h){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}))?e.command:[];h&&h(null,e)};n.prototype.getDeviceStatus=function(e,h){e=(e=
this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];h&&h(null,e)};n.prototype.getGatewayCommands=function(e,h){e=(e=this.devicemanager.applyUIFilterGateway(e,{catagory:"command",elems:"*"}))?e.command:[];h&&h(null,e)};n.prototype.getGatewayStatus=function(e,h){e=(e=this.devicemanager.applyUIFilterGateway(e,{catagory:"status",elems:"*"}))?e.status:[];h&&h(null,e)};n.prototype.doCommand=function(e,h,u,m){(e=this.resolveGateway(e))?e.executeCommandCreator(h,u,function(g){m&&
m(g)}):m&&m(Error("gateway json format invalid"))};n.prototype.doStatus=function(e,h,u,m,g){(h=this.resolveGateway(h))?h.getStatesCreator(null,[{id:e,device:u,status:m}],function(a,b){a?g&&g(a):g&&g(null,b[0])}):g&&g(Error("gateway json format invalid"))};n.prototype.getDeviceList=function(e,h){this.resolveGateway(e)?h&&h(null,this.devicemanager.BG_LIST):h&&h(Error("gateway json format invalid"))};return n}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.yellowstone.Handler);
