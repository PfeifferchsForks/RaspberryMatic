var x=x||{};x.hub=x.hub||{};x.hub.deviceman=x.hub.deviceman||{};
x.hub.deviceman.DeviceManager=function(){var g=function(b,a){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager");this._tenant=null;this._folder=b;this._folder||(this._folder="db");this._tenantIdx=a;this._tenantIdx||(this._tenantIdx=1)};g.prototype.init=function(b,a){this._logger.log("info","init device managaer:"+this._folder);var d=require("m.aio.configmanager.js");b=this._generateTenantParent(b);this._tenant=new d.Tenant(b);this._tenant.index=this._tenantIdx;this._tenant.license=
"dummy";this._tenant.folder=this._folder;var c=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){c._load(a)})};g.prototype.reload=function(b){var a=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(d){d&&a._logger.log("warn","reload device error:"+d.message);b&&b(d)})};g.prototype.execute=function(b,a,d,c,e){try{require("m.aio.devicemanager.js").execute(b,this._tenant.index,d,c,e)}catch(f){console.error(f.stack)}};g.prototype.getDeviceInfo=function(){var b=
require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.getDeviceInfo():null};g.prototype.findDevice=function(b,a){var d=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return d?d.findDeviceIgnoreLicense(b,a):null};g.prototype.findGateway=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findGatewayIgnoreLicense(b):null};g.prototype.findGatewayWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);
return a?a.findGatewayWithIndexIngnoreLicense(b):null};g.prototype.findDeviceWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findDeviceWithIndexIngnoreLicense(b):null};g.prototype.getAllGeneralDevice=function(b){var a=this;require("m.aio.devicemanager.js").execute("readWithoutLicense",this._tenant.index,"device",{filter:"prop","cloud.enabled":!0},function(d,c){if(d)b&&b(d);else{var e=[];if(c&&0!=c.length){var f=0,h=function(k,m){!k&&m&&(m._origin=
c[f],e.push(m));f++;f<c.length?a.toGeneralDevice(c[f].index,h):b&&b(null,e)};a.toGeneralDevice(c[f].index,h)}else b&&b(null,e)}})};g.prototype.toGeneralDevice=function(b,a){require("m.aio.devicemanager.js").toGeneralDevice(this._tenant.index,b,!0,function(d,c){a&&a(d,c)})};g.prototype.getOwnIdx=function(){return localStorage?localStorage.getItem("x.hub.m.gateway.DB"+this._tenantIdx+"NeoIdx"):-1};g.prototype._load=function(b){var a=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(d){d&&
a._logger.log("warn","init device error:"+d.message);b&&b(d)})};g.prototype._generateTenantParent=function(b){return{fileManager:b,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return g}();
x.hub.deviceman.DeviceManagerV6=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManagerV6");this._devices=this._dataFolder=null;this._statesBuffer={}};g.FILE_NAME="db_v6.enc";g.prototype.getGateways=function(){return this._devices&&this._devices.gateways?this._devices.gateways:{}};g.prototype.getGateway=function(b){return this._devices&&this._devices.gateways&&this._devices.gateways[b]?this._devices.gateways[b]:null};g.prototype.setGateway=function(b,
a,d){b?(a?this._devices.gateways[b]=a:delete this._devices.gateways[b],this._writeDB(function(c){d&&d(c,a)})):d&&d(Error("invalid gateway id"))};g.prototype.getDevices=function(){return this._devices&&this._devices.devices?this._devices.devices:{}};g.prototype.getDevice=function(b){return this._devices&&this._devices.devices&&this._devices.devices[b]?this._devices.devices[b]:null};g.prototype.setDevice=function(b,a,d){b?(a?this._devices.devices[b]=a:(delete this._devices.devices[b],delete this._statesBuffer[b]),
this._writeDB(function(c){d&&d(c,a)})):d&&d(Error("invalid device id"))};g.prototype.setBufferedStates=function(b,a){b&&(a?this._statesBuffer[b]=a:delete this._statesBuffer[b])};g.prototype.getAllBufferedStates=function(){return this._statesBuffer};g.prototype.init=function(b,a,d){var c=require("path");a=a.getUserRootDataPath();this._dataFolder=c.resolve(a,"db_v6");this._logger.log("info","init device manager v6:"+this._dataFolder);"CA"==global.HARDWARE_VERSION?this._initHttpApi(b):this._initHttpApiOld(b);
this._loadDB(function(e){d&&d(e)})};g.prototype._initHttpApi=function(b){var a=this;b=require("x.hub.js").getServer();b.addRoute("/api/gateways",{method:"GET"},function(d,c,e){d=a.getGateways();c.json({XC_SUC:d?d:{}})});b.addRoute("/data/gtw/",{method:"GET"},function(d,c,e){d=d.path.substr(10);(d=a.getGateway(d))?c.json({XC_SUC:d}):c.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});b.addRoute("/data/gtw/",{method:"POST"},function(d,c){var e=d.path.substr(10);try{a.setGateway(e,d.json,function(f,
h){f?c.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+f.message}}):h?c.json({XC_SUC:{bytes:d.size}}):c.json({XC_SUC:{bytes:0}})})}catch(f){c.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+f.message}})}});b.addRoute("/api/devices",{method:"GET"},function(d,c,e){d=a.getDevices();c.json({XC_SUC:d?d:{}})});b.addRoute("/data/dev/",{method:"GET"},function(d,c,e){d=d.path.substr(10);(d=a.getDevice(d))?c.json({XC_SUC:d}):c.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});b.addRoute("/data/dev/",
{method:"POST"},function(d,c){var e=d.path.substr(10);try{a.setDevice(e,d.json,function(f,h){f?c.json({XC_ERR:{code:"000101",msg:"failed to set device:"+f.message}}):h?c.json({XC_SUC:{bytes:d.size}}):c.json({XC_SUC:{bytes:0}})})}catch(f){c.json({XC_ERR:{code:"000101",msg:"failed to set device:"+f.message}})}})};g.prototype._initHttpApiOld=function(b){var a=this,d=require("x.hub.js").getServer();b.get("/api/gateways",function(c,e,f){d.auth(c)?(c=a.getGateways(),e.json({XC_SUC:c?c:{}})):e.json({XC_ERR:{code:"000007",
msg:"access denied"}})});b.get("/data/gtw/:id",function(c,e,f){d.auth(c)?(c=a.getGateway(c.params.id))?e.json({XC_SUC:c}):e.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):e.json({XC_ERR:{code:"000007",msg:"access denied"}})});b.post("/data/gtw/:id",function(c,e){if(d.auth(c)){var f=new Buffer(0);c.on("data",function(h){f=Buffer.concat([f,h])});c.on("end",function(){var h=c.params.id,k=f.toString("utf8");try{var m=null;k&&(m=JSON.parse(k));a.setGateway(h,m,function(l,n){l?e.json({XC_ERR:{code:"000101",
msg:"failed to set gateway:"+l.message}}):n?e.json({XC_SUC:{bytes:f.length}}):e.json({XC_SUC:{bytes:0}})})}catch(l){e.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+l.message}})}})}else e.json({XC_ERR:{code:"000007",msg:"access denied"}})});b.get("/api/devices",function(c,e,f){d.auth(c)?(c=a.getDevices(),e.json({XC_SUC:c?c:{}})):e.json({XC_ERR:{code:"000007",msg:"access denied"}})});b.get("/data/dev/:id",function(c,e,f){d.auth(c)?(c=a.getDevice(c.params.id))?e.json({XC_SUC:c}):e.json({XC_ERR:{code:"000101",
msg:"failed to open file"}}):e.json({XC_ERR:{code:"000007",msg:"access denied"}})});b.post("/data/dev/:id",function(c,e){if(d.auth(c)){var f=new Buffer(0);c.on("data",function(h){f=Buffer.concat([f,h])});c.on("end",function(){var h=c.params.id,k=f.toString("utf8");try{var m=null;k&&(m=JSON.parse(k));a.setDevice(h,m,function(l,n){l?e.json({XC_ERR:{code:"000101",msg:"failed to set device:"+l.message}}):n?e.json({XC_SUC:{bytes:f.length}}):e.json({XC_SUC:{bytes:0}})})}catch(l){e.json({XC_ERR:{code:"000101",
msg:"failed to set device:"+l.message}})}})}else e.json({XC_ERR:{code:"000007",msg:"access denied"}})})};g.prototype._loadDB=function(b){var a=require("fs-extra"),d=this._getFile(),c=this;a.ensureFile(d,function(e){e?b(e):c._loadFile(function(f,h){f?(c._devices={gateways:{},devices:{}},b(f)):(c._devices=h?h:{gateways:{},devices:{}},b())})})};g.prototype._writeDB=function(b){this._writeFile(this._devices,function(a){b(a)})};g.prototype._getFile=function(){return require("path").resolve(this._dataFolder,
g.FILE_NAME)};g.prototype._loadFile=function(b){var a=require("fs"),d=this._getFile(),c=this;a.readFile(d,"utf8",function(e,f){if(e)b(e);else if(f)try{f=require("x.crypt").AES.decodeString(f,c._ml_v1_info());var h=JSON.parse(f);b(null,h)}catch(k){b(null,{})}else b(null,"")})};g.prototype._writeFile=function(b,a){var d=require("fs"),c=require("x.crypt.js"),e=this._getFile();try{var f=c.AES.encodeString(JSON.stringify(b),this._ml_v1_info());d.writeFile(e,f,function(h){a&&a(h)})}catch(h){a&&a(h)}};g.prototype._ml_v1_info=
function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3")};return g}();x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1);this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2);this.deviceManagerV6=new x.hub.deviceman.DeviceManagerV6};x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager;
x.hub.deviceman.Handler.prototype.init=function(g,b,a){this._config(g);var d=0;this.deviceManager.init(b,function(c){d++;3==d&&a&&a(c)});this.deviceManager2.init(b,function(c){d++;3==d&&a&&a(c)});this.deviceManagerV6.init(g,b,function(c){d++;3==d&&a&&a(c)})};
x.hub.deviceman.Handler.prototype._config=function(g){var b=this;g.use("/xhub/devicemanager/:id/:type",function(a,d,c){if(a._body)return c();a.body=a.body||{};if("GET"==a.method||"HEAD"==a.method||!a.is("text/xml"))return c();a._body=!0;var e="";a.setEncoding("utf8");a.on("data",function(f){e+=f});a.on("end",function(){a.body=e;c()})});g.use("/xhub/devicemanager/:id/:type",function(a,d){var c=a.method.toLowerCase(),e=a.params.id,f=a.params.type,h=null,k=null;switch(c){case "get":k="readWithoutLicense";
h=a.query;break;case "post":k="create";h=a.body;break;case "put":k="update";h=a.body;break;case "delete":k="delete",h=a.query.index}k?b.deviceManager.execute(k,e,f,h,function(m,l){m?d.send(this.error2json(m)):l.toJSON&&"function"==typeof l.toJSON?d.send(l.toJSON()):(f&&"deviceinfo"==f&&d.set("Content-Type","text/xml"),d.send(l))}.bind(this)):(a=Error("invalid http method"),a.code=500,d.send(this.error2json(a)))}.bind(this))};module.exports=new x.hub.deviceman.Handler;
