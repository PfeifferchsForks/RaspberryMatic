var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mystrom=xnm.aio.mystrom||{};
xnm.aio.mystrom.WifiDevice=function(){var h=function(a,b,e,g){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiDevice");this.ip=a;this.port=b;this.uuid=e;this.port||(this.port=80);this.token=g;this.timeout=2E3};h.prototype.executeCommandCreator=function(a,b,e){b&&b.value?this.executeCommand(b,function(g){e&&e(g)}):e&&e(Error("command value is empty"))};h.prototype.getStatesCreator=function(a,b,e){this.getStates(function(g,
q){g=[];for(var f=0;f<b.length;f++)if(b[f]&&b[f].id&&q&&b[f].status&&b[f].status.value){var k=q[b[f].status.value];"undefined"!=typeof k&&null!=k&&g.push({id:b[f].id,status:k})}e&&e(null,g)})};h.prototype._doRequest=function(a,b,e,g,q){var f=b,k;b="http://"+this.ip+":"+this.port+b;if(e){var m=[];for(k in e)if(e.hasOwnProperty(k)){var r=k+"=";var v=e[k];"undefined"!=typeof v&&null!=v&&(r+=encodeURIComponent(v));m.push(r)}b+="?"+m.join("&");f+="?"+m.join("&")}e="";if(g){r=[];for(k in g)g.hasOwnProperty(k)&&
r.push(k+"="+g[k]);e=r.join("&")}this._logger.log("trace","send "+a+" to url:"+b+" with data:"+e);a={host:this.ip,port:this.port,path:f,method:a,headers:{"Content-Type":'application/x-www-form-urlencoded; charset="UTF-8"',"User-Agent":"mediola",Connection:"close",Referer:"http://"+this.ip}};e&&(a.headers["Content-Length"]=e.length);this.token&&(a.headers.TOKEN=this.token);var w=this,t=q,p=require("http").request(a,function(x){var z="";x.setEncoding("utf-8");x.on("data",function(u){z+=u});x.on("end",
function(){w._logger.log("trace","recevice "+x.statusCode+" response:"+z);if(z)try{var u=JSON.parse(z);t&&(t(null,x.statusCode,u),t=null)}catch(y){t&&(t(y,x.statusCode),t=null)}else t&&(t(null,x.statusCode,""),t=null)})});p.setTimeout(this.timeout,function(){w._logger.log("trace","http request timeout");p.abort();t&&(t(Error("timeout")),t=null)});p.on("error",function(x){w._logger.log("trace","http request error:"+x.message);t&&(t(x),t=null)});e&&p.write(e);p.end()};h.prototype._doRequestWithSocket=
function(a,b,e,g,q){var f;if(e){var k=[];for(f in e)if(e.hasOwnProperty(f)){var m=f+"=";var r=e[f];"undefined"!=typeof r&&null!=r&&(m+=encodeURIComponent(r));k.push(m)}b+="?"+k.join("&")}var v=a+" "+b+" HTTP/1.1\r\n";v+="Host: "+this.ip+(80!=this.port?":"+this.port:"")+"\r\n";v+='Content-Type: application/x-www-form-urlencoded; charset="UTF-8"\r\n';v+="User-Agent: mediola\r\n";this.token&&(v+="Token: "+this.token+"\r\n");g&&(v+="Content-Length: "+g.length+"\r\n");v+="Connection: close\r\n\r\n";g&&
(v+=g);var w=this,t=null,p=q,x="connect",z="",u=require("net").connect({port:this.port,host:this.ip});u.setTimeout(this.timeout);u.setEncoding("utf8");this._logger.log("trace","start connect to "+this.ip+":"+this.port);u.on("connect",function(){w._logger.log("trace","success to connect "+w.ip+":"+w.port);x="connected";t=setTimeout(function(){u.destroy();p&&(w._logger.log("trace","http timeout"),p(Error("http timeout")),p=null)},w.timeout);w._logger.log("trace","send req "+v);u.write(v)});u.on("data",
function(y){w._logger.log("trace","receive data: "+y.toString());z+=y.toString();t&&(clearTimeout(t),t=null);12<=z.length?(y=z.substr(0,12).split(" "),y=parseInt(y[1]),u.destroy(),p&&p(null,y)):t=setTimeout(function(){u.destroy();p&&(w._logger.log("trace","http timeout"),p(Error("http timeout")),p=null)},w.timeout)});u.on("error",function(y){w._logger.log("trace","socket error: "+y.message);u.destroy();p&&(p(y),p=null)});u.on("timeout",function(){"connect"==x&&(w._logger.log("trace","connection timeout"),
u.destroy(),p&&(p(Error("connection timeout")),p=null))});u.on("close",function(){w._logger.log("trace","socket closed");u.destroy()});u._doConnect&&"function"==typeof u._doConnect&&u._doConnect()};h.prototype.toJSON=function(){return{ip:this.ip,port:this.port,uuid:this.uuid,token:this.token}};h.build=function(a){if(!a||!a.type||!a.ip)return null;switch(a.type){case "switch":return new c(a.ip,a.port,a.uuid,a.token);case "bulb":return new d(a.ip,a.port,a.uuid,a.token);case "strip":return new l(a.ip,
a.port,a.uuid,a.token);case "button":return new n(a.ip,a.port,a.uuid,a.token)}};var c=function(a,b,e,g){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiSwitch");h.call(this,a,b,e,g)};c.prototype=new h;c.prototype.constructor=c;c.prototype.executeCommand=function(a,b){if(a){switch(a.value){case "on":a="/relay";var e={state:1};break;case "off":a="/relay";e={state:0};break;case "toggle":a="/toggle";break;default:b&&b(Error("unknown command"));return}this._doRequestWithSocket("GET",
a,e,null,b)}else b&&b(Error("command object is null"))};c.prototype.getStates=function(a){this._doRequest("GET","/report",null,null,function(b,e,g){b?a&&a(b):g?(g.state=g.relay?"on":"off",a&&a(null,g)):a&&a(Error("get states result invalid"))})};c.prototype.toJSON=function(){var a=h.prototype.toJSON.call(this);a.type="switch";return a};c.prototype.equalsTo=function(a){return a&&a instanceof c?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var d=function(a,b,e,g){this._logger="undefined"==
typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");h.call(this,a,b,e,g);this._stateBufferTS=this._stateBuffer=null};d.prototype=new h;d.prototype.constructor=d;d.prototype.executeCommand=function(a,b){if(a)if(this.uuid){var e=this,g="/api/v1/device/"+this.uuid.toUpperCase(),q=null;switch(a.value){case "on":q={action:"on"};break;case "off":q={action:"off"};break;case "toggle":q={action:"toggle"};break;case "white":this.getStatesIncludBuffer(function(f,
k){f?b&&b(f):(f=100,k&&k.color&&(k=k.color.split(";"),f=3>k.length?k[1]:k[2]),e._doRequest("POST",g,void 0,{mode:"mono",color:"18;"+f},b))});return;case "dimTo":case "dimUp":case "dimDown":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(f,k){if(f)b&&b(f);else if(k&&k.color){f=k.color.split(";");var m=2==f.length?f[1]:f[2];switch(a.value){case "dimTo":m=parseInt(a.ext);break;case "dimUp":m=parseInt(m)+parseInt(a.ext);break;case "dimDown":m=
parseInt(m)-parseInt(a.ext)}0>m&&(m=0);100<m&&(m=100);2==f.length?f[1]=m:f[2]=m;e._doRequest("POST",g,void 0,{action:"on",ramp:k.ramp,color:f.join(";")},b)}else b&&b(Error("can not get color state"))});return;case "setCT":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(f,k){if(f)b&&b(f);else{f=parseInt(a.ext);var m=100;1>f&&(f=1);18<f&&(f=18);k&&k.color&&(k=k.color.split(";"),m=3>k.length?k[1]:k[2]);e._doRequest("POST",g,void 0,
{mode:"mono",color:f+";"+m},b)}});return;case "setRGB":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(f,k){if(f)b&&b(f);else{f=parseInt(a.ext.substr(0,2),16);var m=parseInt(a.ext.substr(2,2),16),r=parseInt(a.ext.substr(4,2),16);f/=255;m/=255;r/=255;var v=Math.max(f,m,r),w=Math.min(f,m,r),t=v-w;if(v==w)var p=0;else{switch(v){case f:p=(m-r)/t+(m<r?6:0);break;case m:p=(r-f)/t+2;break;case r:p=(f-m)/t+4}p/=6}p=[p,0==v?0:t/v,v];
f=[];k&&k.color&&(f=k.color.split(";"),3>f.length&&(f[2]=f[1]));f[0]=Math.round(360*p[0]);f[1]=Math.round(100*p[1]);f[2]||(f[2]=Math.round(100*p[2]));e._doRequest("POST",g,void 0,{color:f.join(";")},b)}});return;default:b&&b(Error("unknown command"));return}this._doRequest("POST",g,void 0,q,b)}else b&&b(Error("mac address is null"));else b&&b(Error("command object is null"))};d.prototype.getStates=function(a){if(this.uuid){var b=this;this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),
null,null,function(e,g,q){if(e)a&&a(e);else if(q)if(e=q[b.uuid.toUpperCase()]){e.state=e.on?"on":"off";if(g=e.color)g=g.split(";"),2==g.length?(e.ct=parseInt(g[0]),e.level=parseInt(g[1])):e.level=parseInt(g[2]);b._stateBuffer=e;b._stateBufferTS=(new Date).getTime();a&&a(null,e)}else a&&a(Error("get states result do not contain this device"));else a&&a(Error("get states result invalid"))})}else a&&a(Error("mac address in null"))};d.prototype.getStatesIncludBuffer=function(a){var b=(new Date).getTime();
this._stateBuffer&&this._stateBufferTS&&3E4>b-this._stateBufferTS?a&&a(null,this._stateBuffer):(this._stateBufferTS=this._stateBuffer=null,this.getStates(a))};d.prototype.toJSON=function(){var a=h.prototype.toJSON.call(this);a.type="bulb";return a};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var l=function(a,b,e,g){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");h.call(this,a,b,e,g);this._stateBufferTS=
this._stateBuffer=null};l.prototype=new d;l.prototype.constructor=l;l.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.type="strip";return a};l.prototype.equalsTo=function(a){return a&&a instanceof l?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var n=function(a,b,e,g){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiButton");h.call(this,a,b,e,g)};n.prototype=new h;n.prototype.constructor=n;n.prototype.getInfo=function(a){this.uuid?this._doRequest("GET",
"/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(b,e,g){b?a&&a(b):g?a&&a(null,g):a&&a(Error("get info result invalid"))}):a&&a(Error("mac address in null"))};n.prototype.toJSON=function(){var a=h.prototype.toJSON.call(this);a.type="button";return a};n.prototype.equalsTo=function(a){return a&&a instanceof n?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};h.Switch=c;h.Bulb=d;h.Strip=l;h.Button=n;return h}();
xnm.aio.mystrom.Discovery=function(){var h=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.Discovery");this._devices={};this._callbacks=[];this._searchTimeout=null;this._sockets=[]};h.prototype.start=function(c,d){d||(d=function(){});if(!c||0>c)c=1E4;var l=this._callbacks.length;-1==this._callbacks.indexOf(d)&&this._callbacks.push(d);if(!l){var n=this;this._searchTimeout=setTimeout(function(){n._searchFinish()},c);this._searchStart()}};h.prototype._searchStart=function(){this._logger.log("debug",
"start search for devices");var c=require("os");require("dgram");if(c&&c.networkInterfaces){c=c.networkInterfaces();for(var d in c){for(var l=c[d],n=0;n<l.length;n++)this._addDiscoverSocket(7979,l[n]);this._addDiscoverSocket(7979,null)}}else this._addDiscoverSocket(7979,null);var a=this;(d=require("x.upnp.js"))&&d.discoverDevices(function(b){if(0==b.name.indexOf("myStrom")){a._logger.log("debug","upnp find switch:"+b.uuid+" ip:"+b.ip);var e=b.ip;b=b.uuid.substr(b.uuid.length-12,12);a._devices[e]=
new xnm.aio.mystrom.WifiDevice.Switch(e,null,b)}})};h.prototype._searchFinish=function(){this._searchTimeout=null;var c=this._sockets;this._sockets=[];for(var d=c.length;d--;){var l=c[d];l&&l.close()}c=this._callbacks;this._callbacks=[];d=c.length;l=[];for(var n in this._devices)if(this._devices.hasOwnProperty(n)){var a=this._devices[n];a&&l.push(a)}for(this._devices={};d--;)(n=c[d])&&n(null,l)};h.prototype._receivedData=function(c,d){d=d.toString("hex");this._logger.log("debug","received data from "+
c+" ("+d+")");if(!(14>d.length)){var l=d.substr(0,12);d=d.substr(12,2);d=parseInt(d,16);switch(d){case 101:case 106:case 107:this._devices[c]=new xnm.aio.mystrom.WifiDevice.Switch(c,null,l);break;case 102:this._devices[c]=new xnm.aio.mystrom.WifiDevice.Bulb(c,null,l);break;case 105:this._devices[c]=new xnm.aio.mystrom.WifiDevice.Strip(c,null,l);break;case 103:case 104:this._devices[c]=new xnm.aio.mystrom.WifiDevice.Button(c,null,l)}}};h.prototype._addDiscoverSocket=function(c,d){var l=require("dgram"),
n=this;if(!d){try{var a=l.createSocket({reuseAddr:!0,type:"udp4"})}catch(b){a=l.createSocket("udp4")}a.on("message",function(b,e){n._receivedData(e.address,b)});a.on("error",function(b){});a.bind(c);this._sockets.push(a)}else if("IPv4"==d.family&&0==d.internal){try{a=l.createSocket({reuseAddr:!0,type:"udp4"})}catch(b){a=l.createSocket("udp4")}a.on("listening",function(){a.setBroadcast(!0)});a.on("message",function(b,e){n._receivedData(e.address,b)});a.on("error",function(b){});a.bind(c,d.address);
this._sockets.push(a)}};return h}();
xnm.aio.mystrom.DM=function(){var h=function(c,d){this.code=c;this.message=d;this.stack=Error().stack};h.prototype=Error();h.prototype.name="MystromDMError";h.prototype.code=0;h.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mystrom",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}}]},bulb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},
{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]},strip:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},
{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]}},getIPDeviceType:function(){return[{sys:this.SYS,name:"myStrom"}]},createDevice:function(c,d,l){d=h.ERROR_CODE;c?c.ip?c.type?l(null,c):l(new h(d.INVALID,"type is invalid")):l(new h(d.INVALID,"ip is invalid")):l(new h(d.INVALID,"info is invalid"))},updateDevice:function(c,
d,l){d=h.ERROR_CODE;c?c.ip?c.type?l(null,c):l(new h(d.INVALID,"type is invalid")):l(new h(d.INVALID,"ip is invalid")):l(new h(d.INVALID,"info is invalid"))},deleteDevice:function(c,d,l){l()},applyUIFilter:function(c,d){var l=this,n=function(q,f){if("*"==q)return!0;for(var k=!1,m=0;m<q.length;m++)if(q[m]==f){k=!0;break}return k},a=function(q,f,k){var m=[];switch(k.catagory){case "command":q.command&&q.command.forEach(function(r){n(k.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),m.push(r))});break;
case "status":q.status&&q.status.forEach(function(r){n(k.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),m.push(r))})}return m},b=function(q,f){var k=[],m=l.getCommandStatusMap(q);m&&(q=a(m,q,f),k=k.concat(q));return k};if(!c||null==c.type||"undefined"==typeof c.type)return null;var e=JSON.parse(JSON.stringify(c)),g=null;switch(d.catagory){case "command":g=b(c,d);e.command=g;break;case "status":g=b(c,d);e.status=g;break;default:return null}return g&&0!=g.length?e:null},getCommandStatusMap:function(c){return this.MAP[c.type]}}}();
xnm.aio.mystrom.Handler=function(){var h=function(){this._discovery=new xnm.aio.mystrom.Discovery};h.prototype.devicemanager=xnm.aio.mystrom.DM;h.prototype.Device=xnm.aio.mystrom.WifiDevice;h.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"mystrom")};h.prototype.resolveDevice=function(c){return c&&c.type&&c.ip?this.Device.build(c):null};h.prototype.getDeviceCommands=function(c,d){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];d&&d(null,
c)};h.prototype.getDeviceStatus=function(c,d){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];d&&d(null,c)};h.prototype.doCommand=function(c,d,l){var n=this.resolveDevice(c);n?n.executeCommandCreator(c,d,function(a){l&&l(a)}):l&&l(Error("gateway json format invalid"))};h.prototype.doStatus=function(c,d,l,n){var a=this.resolveDevice(d);a?a.getStatesCreator(null,[{id:c,device:d,status:l}],function(b,e){b?n&&n(b):n&&n(null,e[0])}):n&&n(Error("gateway json format invalid"))};
h.prototype.discovery=function(c){this._discovery.start(1E4,c)};return h}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.mystrom.Handler);
