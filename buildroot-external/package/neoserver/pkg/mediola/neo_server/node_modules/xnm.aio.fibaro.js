var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fibaro=xnm.aio.fibaro||{};xnm.aio.fibaro.Util={clearHttpOptionForLog:function(g){try{var d=JSON.parse(JSON.stringify(g));d.auth&&(d.auth="xxxxxx:xxxxxx");if(d.headers)for(var a in headers)if(a&&"authorization"==a.toLocaleLowerCase()){var b=headers[a];if(b){var c=b.indexOf(" ");headers[a]=-1==c?"xxxxxx":b.substr(0,c)+" xxxxxx"}}return d}catch(e){return g}}};
xnm.aio.fibaro.HomeCenter=function(){var g=function(d,a,b,c,e){var f=require("x.logger.js");this._logger=f?f.getLogger("xnm.aio.fibaro.HomeCenter"):{log:function(){}};this.ip=d;this.uuid=c;this.user=a;this.password=b;this.name=e;this.CommandHandler=null;this._getStatesCBs=[]};g.ACTION_LIST="turnOn turnOff setValue startLevelIncrease startLevelDecrease stopLevelChange close open stop pressButton setArmed setSetpointMode setThermostatSetpoint setMode setFanMode setTargetLevel setTime setColor startProgram".split(" ");
g.PROPERTY_LIST="value state batteryLevel power energy armed tamper on mute volume mode targetLevel wakeUpTime Humidity Pressure Temperature WeatherCondition Wind".split(" ");g.SET_POINT_MODES=["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"];g.OP_MODES="OFF HEATING COOLING AUTO PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" ");
g.FAN_MODES="AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" ");g.prototype._callAction=function(d,a,b,c){d="/api/callAction?deviceID="+d+"&name="+a;for(a=0;a<b.length;a++)d+="&arg"+(a+1)+"="+encodeURIComponent(b[a]);this._doRestApi("GET",d,null,function(e,f){c&&c(e,f)})};g.prototype._getRooms=function(d){this._doRestApi("GET","/api/rooms",null,function(a,b){d&&d(a,b)})};g.prototype._getDevices=function(d){this._doRestApi("GET",
"/api/devices",null,function(a,b){d&&d(a,b)})};g.prototype._getGlobalVariables=function(d){this._doRestApi("GET","/api/globalVariables",null,function(a,b){d&&d(a,b)})};g.prototype._setGlobalVariableValue=function(d,a,b){this._doRestApi("PUT","/api/globalVariables/"+d,JSON.stringify({name:d,value:a+""}),function(c,e){b&&b(c,e)})};g.prototype._doRestApi=function(d,a,b,c){this._doRequest(d,a,b,function(e,f,h){if(e)e.code="timeout"==e.reason?2:1,c&&c(e);else if(200!=h&&202!=h)e=Error("http result status code:"+
h),e.code=h,c&&c(e);else try{var l=JSON.parse(f);c&&c(null,l)}catch(k){k.code=3,c&&c(k)}})};g.prototype._doRequest=function(d,a,b,c){d={host:this.ip,path:a,method:d,headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64"),Connection:"close","Content-Type":"text/plain"}};b&&(d.headers["Content-Length"]=b.length);var e=this;a=require("http");this._logger.log("trace","do http request:"+JSON.stringify(xnm.aio.fibaro.Util.clearHttpOptionForLog(d)));d=a.request(d,function(f){f.setEncoding("utf-8");
var h="";f.on("data",function(l){h+=l});f.on("end",function(){e._logger.log("trace","receive http response:"+h+" with code:"+f.statusCode);c&&c(null,h,f.statusCode);c=null})});d.on("error",function(f){e._logger.log("warn","do http request error:"+f.message);c&&c(f);c=null});d.setTimeout(4E3,function(){e._logger.log("warn","do http request timeout");var f=Error("timeout");f.reason="timeout";c&&c(f);c=null});b&&d.write(b);d.end()};g.prototype.executeCommandCreator=function(d,a,b){if(d&&d.address)if(a&&
a.value){var c=a.value;if("global_variable"==d.type)c=a.ext;else if("setSetpointMode"==c){if(!a.ext){b&&b(Error("setSetpointMode invalid"));return}a=g.SET_POINT_MODES.indexOf(a.ext);if(-1==a){b&&b(Error("unknown setSetpointMode mode"));return}c+=a}else if(0==c.indexOf("setThermostatSetpoint")){if(!a.ext){b&&b(Error("setThermostatSetpoint invalid"));return}c+=":"+a.ext}else if("setMode"==c){if(!a.ext){b&&b(Error("setMode invalid"));return}a=g.OP_MODES.indexOf(a.ext);if(-1==a){b&&b(Error("unknown setMode mode"));
return}c+=a}else if("setFanMode"==c){if(!a.ext){b&&b(Error("setFanMode invalid"));return}a=g.FAN_MODES.indexOf(a.ext);if(-1==a){b&&b(Error("unknown setFanMode mode"));return}c+=a}else if(0==c.indexOf("setTargetLevel")){if(!a.ext){b&&b(Error("setTargetLevel invalid"));return}c+=a.ext}else if(0==c.indexOf("setTime")){if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("setTime invalid"));return}c+=a.ext}else if("rgbw"==c){if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("rgbw invalid"));return}c=
"setColor"+a.ext}else if("startProgram"==c){if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("startProgram invalid"));return}c+=a.ext}else"undefined"!=typeof a.ext&&null!=a.ext&&("setValue"==c&&(c+=a.ext),"disarm"==c&&(c+=a.ext));this.executeCommand(d,c,function(e,f){b&&b(e,f)})}else b&&b(Error("command invalid"));else b&&b(Error("device invalid"))};g.prototype.getStatesCreator=function(d,a,b){if(a)if(0==a.length)b&&b(null,[]);else if(a){for(var c=[],e=0;e<a.length;e++){var f=a[e];f&&f.device&&
f.device.address&&c.push(f.device.address)}this.getStates(d,c,function(h,l,k){if(h)b&&b(h);else{h=[];if(l)for(var p=0;p<a.length;p++)if(a[p]){var n=a[p].id,m=a[p].device,q=a[p].status;if(n&&q&&q.value&&m&&m.address){var r="?";if("global_variable"==m.type)m=k[m.address],r=parseInt(m);else if(m=l[m.address])switch(q.value){case "onoffValue":r=m.value;r="true"==r?"on":"off";break;case "intValue":r=m.value;r=parseInt(r);break;case "boolValue":r=m.value;break;case "floatValue":r=m.value;r=parseFloat(r);
break;case "setpointMode":r=m.mode;r=g.SET_POINT_MODES[parseInt(r)];break;case "opMode":r=m.mode;r=g.OP_MODES[parseInt(r)];break;case "fanMode":r=m.mode;r=g.FAN_MODES[parseInt(r)];break;default:r=m[q.value]}if("undefined"==typeof r||null==r)r="?";h.push({id:n,status:r})}}b&&b(null,h)}})}else b&&b(Error("deviceList is null"));else b&&b(Error("deviceList is null"))};g.prototype.getDevices=function(d){var a={},b={};a[0]={name:"Unassigned"};var c=this;this._getRooms(function(e,f){if(e)d&&d(e);else{if(f)for(e=
0;e<f.length;e++)a[f[e].id]={name:f[e].name,section:f[e].sectionID};c._getDevices(function(h,l){if(h)d&&d(h);else{if(l)for(h=0;h<l.length;h++){var k=l[h];k.visible&&"HC_user"!=k.type&&(b[k.id]={sys:"fibaro",name:k.name,address:k.id,room:k.roomID,type:k.type,baseType:k.baseType,actions:k.actions,states:k.properties})}c._getGlobalVariables(function(p,n){if(p)d&&d(p);else{p={};for(var m=0;m<n.length;m++){var q=n[m];q&&q.name&&(p[q.name]={sys:"fibaro",name:q.name,address:q.name,readOnly:q.readOnly,isEnum:q.isEnum,
type:"global_variable"})}d&&d(null,{rooms:a,devices:b,variables:p})}})}})}})};g.prototype.executeCommand=function(d,a,b){if("global_variable"==d.type)"undefined"==typeof a&&null==a?b&&b(Error("command ext invalid")):this._setGlobalVariableValue(d.address,a,function(l){b&&b(l)});else{var c=a,e=[];if("number"==typeof a)c="setValue",e.push(a);else if("string"==typeof a)if("on"==a)c="turnOn";else if("off"==a)c="turnOff";else{if("toggle"==a){var f=this;this._getDevices(function(l,k){if(l)b&&b(l);else{l=
null;for(var p=0;p<k.length;p++){var n=k[p];if(n.id&&n.properties&&n.id==d.address){"false"==n.properties.value?l="on":"true"==n.properties.value&&(l="off");break}}l?f.executeCommand(d,l,b):b&&b(Error("device has no on/off state"))}});return}if("arm"==a)c="setArmed",e=[1];else if(0==a.indexOf("disarm"))e=[0],e.push(a.replace(/disarm/g,"")),c="setArmed";else if(0==a.indexOf("dimTo"))e.push(parseInt(a.replace(/dimTo/g,""))),c="setValue";else if(0==a.indexOf("moveTo"))e.push(parseInt(a.replace(/moveTo/g,
""))),c="setValue";else if(0==a.indexOf("setTo"))e.push(parseInt(a.replace(/setTo/g,""))),c="setValue";else if(0==a.indexOf("setValue"))e.push(parseInt(a.replace(/setValue/g,""))),c="setValue";else if(0==a.indexOf("setSetpointMode"))e.push(parseInt(a.replace(/setSetpointMode/g,""))),c="setSetpointMode";else if(0==a.indexOf("setThermostatSetpoint"))a=a.replace(/setThermostatSetpoint/g,""),a=a.split(":"),e.push(parseInt(a[0]),parseFloat(a[1])),c="setThermostatSetpoint";else if(0==a.indexOf("setMode"))e.push(parseInt(a.replace(/setMode/g,
""))),c="setMode";else if(0==a.indexOf("setFanMode"))e.push(parseInt(a.replace(/setFanMode/g,""))),c="setFanMode";else if(0==a.indexOf("setTargetLevel"))e.push(parseFloat(a.replace(/setTargetLevel/g,""))),c="setTargetLevel";else if(0==a.indexOf("setTime"))e.push(parseInt(a.replace(/setTime/g,""))),c="setTime";else if(0==a.indexOf("setColor")){var h=a.replace(/setColor/g,"");e=h.substr(0,2);a=h.substr(2,2);c=h.substr(4,2);h=h.substr(6,2);e=[parseInt(e,16),parseInt(a,16),parseInt(c,16),parseInt(h,16)];
c="setColor"}else 0==a.indexOf("startProgram")?(e.push(parseInt(a.replace(/startProgram/g,""))),c="startProgram"):c=a}this._callAction(d.address,c,e,function(l,k){b&&b(l,k)})}};g.prototype.getStates=function(d,a,b){b||(b=function(){});var c=this._getStatesCBs.length;-1==this._getStatesCBs.indexOf(b)&&this._getStatesCBs.push(b);if(!(0<c)){var e=this;this.CommandHandler=d;this._getGlobalVariables(function(f,h){if(f){h=e._getStatesCBs;e._getStatesCBs=[];for(var l=0;l<h.length;l++)h[l](f)}else{var k=
{};for(l=0;l<h.length;l++)(f=h[l])&&f.name&&(k[f.name]=f.value);e._getDevices(function(p,n){if(p){n=e._getStatesCBs;e._getStatesCBs=[];for(var m=0;m<n.length;m++)n[m](p)}else{p={};for(m=0;m<n.length;m++){var q=n[m];if(q.id&&q.properties&&(null==a||-1!=a.indexOf(q.id))){p[q.id]={};for(var r in q.properties)-1!=g.PROPERTY_LIST.indexOf(r)&&(p[q.id][r]=q.properties[r])}}n=e._getStatesCBs;e._getStatesCBs=[];for(m=0;m<n.length;m++)n[m](null,p,k)}})}})}};g.prototype.getStateValues=function(d,a){return a};
g.prototype.toJSON=function(){return{sys:"fibaro",ip:this.ip,username:this.user,password:this.password,uuid:this.uuid,name:this.name}};g.prototype.equalsTo=function(d){return d&&d instanceof g?this.ip==d.ip&&this.user==d.user&&this.password==d.password:!1};g.Discovery=function(){this._homeCenters=[];this._sockets=[];this._searchTimeout=null;this._running=!1;this._listeners=[];this._callbacks=[];var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.fibaro.HomeCenter.Discovery"):{log:function(){}};
this.discoverHomeCenters=function(a,b,c){b&&-1==this._listeners.indexOf(b)&&this._listeners.push(b);c&&-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);a||(a=5E3);if(!this._running){this._logger.log("debug","start search home center");var e=this;this._running=!0;this._createSockets(function(f){f?e._finishDiscover(f):(e._sendDiscoveryMessages(),e._searchTimeout=setTimeout(function(){e._finishDiscover(null,e._homeCenters)},a))})}};this._createSockets=function(a){var b=require("os");require("dgram");
var c=this;if(b&&b.networkInterfaces){b=b.networkInterfaces();var e=[];for(p in b)if(b.hasOwnProperty(p))for(var f=b[p],h=0;h<f.length;h++)"IPv4"==f[h].family&&0==f[h].internal&&e.push(f[h]);var l=0,k=0;var p=function(n,m){l++;n&&(k++,m&&(m=c._sockets.indexOf(m),-1!=m&&c._sockets.splice(m,1)));l==e.length&&(k==l?a&&a(n):a&&a())};for(b=0;b<e.length;b++)this._addDiscoverSocket(44444,e[b],p)}else this._addDiscoverSocket(44444,null,function(n,m){n&&m&&(m=c._sockets.indexOf(m),-1!=m&&c._sockets.splice(m,
1));a&&a(n)})};this._closeSockets=function(){for(var a=0;a<this._sockets.length;a++)this._sockets[a].close()};this._addDiscoverSocket=function(a,b,c){var e=this,f=require("dgram");try{var h=f.createSocket({reuseAddr:!0,type:"udp4"})}catch(l){h=f.createSocket("udp4")}h.on("listening",function(){h.setBroadcast(!0);h._listening=!0;e._logger.log("trace","success to bind on port:"+a+(b?" with interface:"+b.address:""));c&&c(null,h)});h.on("message",function(l,k){e._receivedData(k.address,l)});h.on("error",
function(l){h._listening||(e._logger.log("trace","failed to bind on port:"+a+(b?" with interface:"+b.address:"")),c&&c(l,h))});try{b?(e._logger.log("trace","try to bind on port:"+a+" with interface:"+b.address),h.bind(a,b.address)):(e._logger.log("trace","try to bind on port:"+a),h.bind(a)),this._sockets.push(h)}catch(l){c&&c(l)}};this._sendDiscoveryMessages=function(){for(var a=new Buffer([70,73,66,65,82,79]),b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,44444,"255.255.255.255")};
this._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");if(3<=b.length&&(b=b.toString(),this._logger.log("trace","receive packet:"+b+" from:"+a),b=b.split(" "),3==b.length&&"ACK"==b[0])){a=new g(a,null,null,b[2]);a.name=b[1];var c=!1;for(b=0;b<this._homeCenters.length;b++){var e=this._homeCenters[b];if(e&&e.uuid==a.uuid){c=!0;break}}if(!c)for(this._homeCenters.push(a),c=0;b<this._listeners.length;c++)this._listeners[c](a)}};this._finishDiscover=function(a,b){var c=this._callbacks;
this._closeSockets();this._sockets=[];this._homeCenters=[];this._running=!1;this._listeners=[];this._callbacks=[];for(var e=0;e<c.length;e++){var f=c[e];f&&f(a,b)}}};return g}();
xnm.aio.fibaro.DM=function(){var g=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="FibaroDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"fibaro",getGatewayType:function(){return[{sys:this.SYS,name:"FIBARO Home Center 2"}]},getGatewayDeviceType:function(){return[]},createGateway:function(d,a,b){a=g.ERROR_CODE;d?d.ip?d.username?d.password?b(null,d):b(new g(a.INVALID,
"password is invalid")):b(new g(a.INVALID,"username is invalid")):b(new g(a.INVALID,"ip is invalid")):b(new g(a.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=g.ERROR_CODE;a?a.ip?a.username?a.password?c(null,a):c(new g(d.INVALID,"password is invalid")):c(new g(d.INVALID,"username is invalid")):c(new g(d.INVALID,"ip is invalid")):c(new g(d.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=g.ERROR_CODE;if(d)if(d.gateway)if(d.address)if(d.type)if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var f=a[e];break}f?b(null,d):b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new g(c.INVALID,"type is invalid"));else b(new g(c.INVALID,"address is invalid"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=
g.ERROR_CODE;if(d)if(d.gateway)if(d.address)if(d.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var f=a[e];break}f?b(null,d):b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new g(c.INVALID,"type is invalid"));else b(new g(c.INVALID,"address is invalid"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,
"info is invalid"))},deleteDevice:function(d,a,b){b()},applyUIFilter:function(d,a){var b=this,c=function(k,p){if("*"==k)return!0;for(var n=!1,m=0;m<k.length;m++)if(k[m]==p){n=!0;break}return n},e=function(k,p,n){var m=[];switch(n.catagory){case "command":k.command&&k.command.forEach(function(q){c(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),m.push(q))});break;case "status":k.status&&k.status.forEach(function(q){c(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),m.push(q))})}return m},f=function(k,
p){var n=[],m=b.getCommandStatusMap(k);m&&(k=e(m,k,p),n=n.concat(k));return n};if(!d||null==d.type||"undefined"==typeof d.type)return null;var h=JSON.parse(JSON.stringify(d)),l=null;switch(a.catagory){case "command":l=f(d,a);h.command=l;break;case "status":l=f(d,a);h.status=l;break;default:return null}return l&&0!=l.length?h:null},getCommandStatusMap:function(d){if(!d)return null;var a={command:[],status:[]};if("global_variable"==d.type)return d.readOnly||a.command.push({type:"int",name:"set value",
ref:{value:"setValue",ext:"%d"}}),a.status.push({type:"int",name:"value",ref:{value:"value"}}),a;var b=d.actions,c=d.states;if(b)for(var e in b)if(e&&-1!=xnm.aio.fibaro.HomeCenter.ACTION_LIST.indexOf(e))switch(e){case "turnOn":a.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case "turnOff":a.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setValue":a.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d",extMeta:"0-100"}});break;case "startLevelIncrease":a.command.push({type:"enum",
name:"up",ref:{value:"startLevelIncrease"}});break;case "startLevelDecrease":a.command.push({type:"enum",name:"down",ref:{value:"startLevelDecrease"}});break;case "stopLevelChange":a.command.push({type:"enum",name:"stop level change",ref:{value:"stopLevelChange"}});break;case "setArmed":a.command.push({type:"enum",name:"arm",ref:{value:"arm"}});a.command.push({type:"string",name:"disarm",ref:{value:"disarm",ext:"%s",unit:"(pin)"}});break;case "setTargetLevel":d&&"com.fibaro.hvac"==d.baseType?a.command.push({type:"float",
name:"set point",ref:{value:"setTargetLevel",ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}}):a.command.push({type:"float",name:"set target level",ref:{value:"setTargetLevel",ext:"%f"}});break;case "setTime":a.command.push({type:"int",name:"set time",ref:{value:"setTime",ext:"%d",extMeta:"0-21600",unit:"s"}});break;case "setSetpointMode":if(c&&c.supportedModes){var f=c.supportedModes.split(",");if(0<f.length){var h={type:"enum",name:"set point mode",ref:{value:"setSetpointMode",ext:"%e",extMeta:[]}};f.forEach(function(k){(k=
xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(k)])&&h.ref.extMeta.push(k)});a.command.push(h)}}break;case "setThermostatSetpoint":c&&c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&f.forEach(function(k){var p=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(k)];p&&a.command.push({type:"float",name:"set point ("+p+")",ref:{value:"setThermostatSetpoint"+k,ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}})}));break;case "setMode":c&&c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&
(h={type:"enum",name:"set op mode",ref:{value:"setMode",ext:"%e",extMeta:[]}},f.forEach(function(k){(k=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(k)])&&h.ref.extMeta.push(k)}),a.command.push(h)));break;case "setFanMode":c&&c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"set fan mode",ref:{value:"setFanMode",ext:"%e",extMeta:[]}},f.forEach(function(k){(k=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(k)])&&h.ref.extMeta.push(k)}),a.command.push(h)));break;case "setColor":a.command.push({type:"rgbw",
name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}});break;case "startProgram":a.command.push({type:"int",name:"start program",ref:{value:"startProgram",ext:"%d"}});break;default:a.command.push({type:"enum",name:e,ref:{value:e}})}if(c)for(var l in c)if(l&&-1!=xnm.aio.fibaro.HomeCenter.PROPERTY_LIST.indexOf(l))switch(l){case "value":b&&b.setValue?a.status.push({type:"int",name:"value",ref:{value:"intValue",ext:"%d"}}):b&&b.setThermostatSetpoint?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",
ext:"%f"}}):d&&"com.fibaro.hvac"==d.baseType?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",ext:"%f"}}):b&&"undefined"!=typeof b.turnOn&&null!=b.turnOn?(a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}}),a.status.push({type:"enum",name:"value",ref:{value:"onoffValue",options:["on","off"]}})):"true"==c.value||"false"==c.value?a.status.push({type:"enum",name:"value",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"value",
ref:{value:"floatValue",ext:"%f"}});break;case "targetLevel":b&&b.setThermostatSetpoint?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):d&&"com.fibaro.hvac"==d.baseType?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):a.status.push({type:"float",name:"target level",ref:{value:"targetLevel",ext:"%f"}});break;case "mode":b&&b.setSetpointMode?c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"set point mode",
ref:{value:"setpointMode",options:[]}},f.forEach(function(k){(k=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(k)])&&h.ref.options.push(k)}),a.status.push(h))):b&&b.setMode?c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"op mode",ref:{value:"opMode",options:[]}},f.forEach(function(k){(k=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(k)])&&h.ref.options.push(k)}),a.status.push(h))):b&&b.setFanMode?c.supportedModes&&(f=c.supportedModes.split(","),0<f.length&&(h={type:"enum",
name:"fan mode",ref:{value:"fanMode",options:[]}},f.forEach(function(k){(k=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(k)])&&h.ref.options.push(k)}),a.status.push(h))):"true"==c.value||"false"==c.value?a.status.push({type:"enum",name:"state",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"state",ref:{value:"floatValue",ext:"%f"}});break;case "armed":case "tamper":a.status.push({type:"enum",name:l,ref:{value:l,options:["true","false"]}});break;case "WeatherCondition":a.status.push({type:"string",
name:l,ref:{value:l}});break;default:a.status.push({type:"float",name:l,ref:{value:l,ext:"%f"}})}return a}}}();
xnm.aio.fibaro.Handler=function(){var g=function(){this.detectedHomecenters={};this.discovery=new this.HomeCenter.Discovery};g.prototype.HomeCenter=xnm.aio.fibaro.HomeCenter;g.prototype.devicemanager=xnm.aio.fibaro.DM;g.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"fibaro")};g.prototype.discoverHomeCenters=function(d,a){this.discovery.discoverHomeCenters(d,null,function(b,c){a&&a(b,c)})};g.prototype.resolveGateway=function(d){return d&&d.ip&&d.username?new this.HomeCenter(d.ip,
d.username,d.password,d.uuid,d.name):null};g.prototype.getDeviceCommands=function(d,a){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];a&&a(null,d)};g.prototype.getDeviceStatus=function(d,a){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];a&&a(null,d)};g.prototype.doCommand=function(d,a,b,c){(d=this.resolveGateway(d))?d.executeCommandCreator(a,b,function(e){c&&c(e)}):c&&c(Error("gateway json format invalid"))};g.prototype.doStatus=
function(d,a,b,c,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:d,device:b,status:c}],function(f,h){f?e&&e(f):e&&e(null,h[0])}):e&&e(Error("gateway json format invalid"))};g.prototype.getDeviceList=function(d,a){(d=this.resolveGateway(d))?d.getDevices(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};g.prototype.getStateValues=function(d,a){return(new xnm.aio.fibaro.HomeCenter).getStateValues(d.type,a)};g.prototype.getDeviceCommandList=function(d,a,b){a=[];if(d.actions)for(var c in d.actions)switch(c){case "setVolume":a.push({id:c,
cmd:"setTo",step:"1",min:"0",max:"100"});break;default:a.push({id:c,cmd:c})}return a};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fibaro.Handler);
