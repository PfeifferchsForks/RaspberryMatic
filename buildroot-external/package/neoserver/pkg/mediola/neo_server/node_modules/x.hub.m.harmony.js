var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.harmony=x.hub.m.harmony||{};x.hub.m.harmony.HARMONY_MODULE=require("xnm.aio.harmony.js");
x.hub.m.harmony.Monitor=function(){var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.harmony.Monitor");var c=this;this._state=d.STATE.IDLE;this._hub=a;this._monitorListener={onData:function(e,f){c.onData(e,f)},onClose:function(){c.onClose()}};this._autoreconn=b;this._reconnectTO=null;this._getActivityStateCallbacks=[];this._activities={}};d.STATE={IDLE:0,CONNECTING:1,CONNECTED:2,WAITING_RECONN:3};d.prototype.addStateDevice=function(a,b){a&&a.id&&a.type?"Activity"!=a.type?
b&&b(Error("device type:"+a.type+" has no status")):this._activities[a.id]?b&&b():this.getStates(a,b):b&&b(Error("device json invalid"))};d.prototype.getStates=function(a,b){if(a&&a.id&&a.type)if("Activity"!=a.type)b&&b(Error("device type:"+a.type+" has no status"));else{var c=a.id;this._activities[c]||(this._activities[c]={device:a,states:{state:{value:"?",time:-1}}});var e=this;this._getActivityState(function(f){f?b&&b(f):b&&b(null,e.getBufferedStates(a))})}else b&&b(Error("device json invalid"))};
d.prototype.getBufferedStates=function(a){if(!a||!a.id||!a.type||"Activity"!=a.type)return null;a=a.id;return this._activities[a]&&this._activities[a].states?this._activities[a].states:{state:null}};d.prototype.getAllBufferedStates=function(){var a=[],b;for(b in this._activities)if(this._activities.hasOwnProperty(b)){var c=this._activities[b];c&&c.device&&c.states&&a.push({device:c.device,states:c.states})}return a};d.prototype.executeCommand=function(a,b,c){switch(this._state){case d.STATE.WAITING_RECONN:case d.STATE.IDLE:case d.STATE.CONNECTING:c&&
c(Error("monitor not connected"));return}this._hub.executeCommandCreator(a,b,function(e){c&&c(e)})};d.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._hub.ip);var b=this;this._state=d.STATE.CONNECTING;this._hub.setMonitorListener(this._monitorListener);this._hub.startMonitor(function(c){c?(b._logger.log("debug","monitor connected err:"+c.message),b._autoreconn?(b._state=d.STATE.WAITING_RECONN,b._reconnect(1E4)):b._state=d.STATE.IDLE):(b._logger.log("debug","monitor connected:"+
b._hub.ip),b._state=d.STATE.CONNECTED,b._initStates());a&&a(c)})};d.prototype._reconnect=function(a){this._logger.log("trace","reconnect monitor:"+this._hub.ip);this._reconnectTO&&(clearTimeout(this._reconnectTO),this._reconnectTO=null);var b=this;a?this._reconnectTO=setTimeout(function(){b.start()},a):b.start()};d.prototype._initStates=function(a){this._getActivityState(a)};d.prototype._getActivityState=function(a){switch(this._state){case d.STATE.WAITING_RECONN:case d.STATE.IDLE:case d.STATE.CONNECTING:a&&
a(Error("monitor not connected"));return}var b=this._getActivityStateCallbacks.length;a||(a=function(){});-1==this._getActivityStateCallbacks.indexOf(a)&&this._getActivityStateCallbacks.push(a);if(!b){var c=this;this._hub.getCurrentActivity(function(e,f){e||-1==f||c._updateActivityBuffer(f,"RUNNING");var g=c._getActivityStateCallbacks;c._getActivityStateCallbacks=[];g.forEach(function(h){h&&h(e,f)})})}};d.prototype._updateActivityBuffer=function(a,b){var c=!1,e=null;if(-1==a)this._produceEvent(-1,
{value:"?",time:-1},{value:"allOff",time:(new Date).getTime()}),this._produceEvent(-1,{value:"?",time:-1},{value:"off",time:(new Date).getTime()});else{for(var f in this._activities)if(this._activities.hasOwnProperty(f)){var g=this._activities[f];g.states||(g.states={state:{}});e=g.states.state;if(-1!=f)if(a!=f){if("on"==e.value){g.lastStatus="NO_ACTIVITY";var h={value:this._resolveState("NO_ACTIVITY"),time:(new Date).getTime()};g.states.state=h;this._produceEvent(f,e,h)}}else g.lastStatus=b,c=!0,
h={value:this._resolveState(b),time:(new Date).getTime()},g.states.state=h,this._produceEvent(f,e,h)}c||-1==a||(h={value:this._resolveState(b),time:(new Date).getTime()},this._activities[a]={activity:null,states:{state:h},lastStatus:b},this._produceEvent(a,e,h))}};d.prototype._produceEvent=function(a,b,c){if((a=this._activities[a]?this._activities[a].device:null)&&b){var e=c.value!=b.value;var f=require("x.hub.eventbus.js");e&&f.emit("status",{module:"harmony",device:a,gateway:a.gateway,data:{key:"event",
value:c.value,oldvalue:b.value,changed:!0}})}};d.prototype._resolveState=function(a){switch(a){case "RUNNING":case "STARTING":a="on";break;default:a="off"}return a};d.prototype.onData=function(a,b){b&&(this._logger.log("trace","receive notify:"+JSON.stringify(b)),this._updateActivityBuffer(b.activityId,b.activityStatus))};d.prototype.onClose=function(){this._logger.log("debug","monitor closed:"+this._hub.ip);this._reconnect()};return d}();
x.hub.m.harmony.Handler=function(){var d=function(){this._monitors={}};util.inherits(d,EventEmitter);d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["harmony"]};d.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,e){c?b&&b({error:c}):e.addStateDevice(a,function(f){b&&b({error:f})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};d.prototype.getAllStates=function(){var a=[],b;for(b in this._monitors)if(this._monitors.hasOwnProperty(b)){var c=
this._monitors[b].getAllBufferedStates();c&&(a=a.concat(c))}return a};d.prototype.getStates=function(a){if(!a||!a.gateway||!a.gateway.ip)return null;var b=this._monitors[a.gateway.ip];return b?b.getBufferedStates(a):(this._startMonitor(a.gateway,function(c,e){c||e.addStateDevice(a,function(f){})}),null)};d.prototype.getState=function(a,b,c){a?a.gateway?this._startMonitor(a.gateway,function(e,f){if(e)c&&c({error:e});else{var g=f.getBufferedStates(a);g?null!=g[b]?c&&c({data:g[b]}):f.getStates(a,function(h,
k){h?c&&c({error:h}):k&&k[b]?c&&c({data:k[b]}):c&&c({error:Error("get states result invalid")})}):c&&c({error:e})}}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};d.prototype.executeCommand=function(a,b,c){a?b?a.gateway?this._startMonitor(a.gateway,function(e,f){e?c&&c({error:e}):f.executeCommand(a,b,function(g){c&&c({error:g})})}):c&&c({error:Error("gateway is null")}):c&&c({error:Error("command invalid")}):c&&c({error:Error("device is null")})};
d.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.id==a.device.id:!1};d.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;this._monitors[c]?b&&b(null,this._monitors[c]):(a=x.hub.m.harmony.HARMONY_MODULE.resolveGateway(a))?(a=new x.hub.m.harmony.Monitor(a,!0),this._monitors[c]=a,a.start(),b&&b(null,a)):b&&b(Error("harmony hub format invalid"))}else b&&b(Error("harmony hub format invalid"))};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.harmony.Handler);
