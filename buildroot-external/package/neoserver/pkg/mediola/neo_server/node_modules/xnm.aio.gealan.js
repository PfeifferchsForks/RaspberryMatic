var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.gealan=xnm.aio.gealan||{};
xnm.aio.gealan.Fan=function(){var q={_stateTimeout:10,_errorTimeout:5,_buffer:{},getFanStates:function(a){var b=this._buffer[a];b||(this._buffer[a]={},b=this._buffer[a]);if(a=b.fan){b=a.time;var c=Math.round((new Date).getTime()/1E3);if(!(!b||c-b>this._stateTimeout||null==a.states&&c-b>this._errorTimeout))return a.states}else b.fan={}},setFanStates:function(a,b){var c=this._buffer[a];c||(this._buffer[a]={},c=this._buffer[a]);a=c.fan;a||(c.fan={},a=c.fan);c=Math.round((new Date).getTime()/1E3);a.states=
b;a.time=c},getFilterStates:function(a){var b=this._buffer[a];b||(this._buffer[a]={},b=this._buffer[a]);if(a=b.filter){b=a.time;var c=Math.round((new Date).getTime()/1E3);if(!(!b||c-b>this._stateTimeout||null==a.states&&c-b>this._errorTimeout))return a.states}else b.filter={}},setFilterStates:function(a,b){var c=this._buffer[a];c||(this._buffer[a]={},c=this._buffer[a]);a=c.filter;a||(c.filter={},a=c.filter);c=Math.round((new Date).getTime()/1E3);a.states=b;a.time=c}},d=function(a,b,c,e){this._logger=
require("x.logger.js").getLogger("xnm.aio.gealan.Fan");this._ip=a;this._port=b;this._port||(this._port=443);80==this._port&&(this._port=443);this._username=c;this._password=e;this._timeout=5E3;this._readMainCallbacks=[];this._readAmbientsCallbacks=[];this._readFilterCallbacks=[];this._readLogCallbacks=[];this._readFanCallbacks=[];this._readWlanScanCallbacks=[];this._readCounterCallbacks=[];this._httpReqBuffer=[];this._configUdpServerInterval=null;"undefined"!=typeof process&&null!=process&&process.env&&
(this._keepAliveAgent=new (require("https").Agent)({keepAlive:!0,maxSockets:1}))};d.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value)switch(b.value){case "on":this._setOn(c);break;case "off":this._setStandBy(c);break;case "setLevel":a=parseInt(b.ext);if(isNaN(a)){c&&c(Error("level value invalid"));break}switch(a){case 0:this._setStandBy(c);break;case 1:this._setLevel1(c);break;case 2:this._setLevel2(c);break;case 3:this._setLevel3(c);break;case 4:this._setLevel4(c);break;case 5:this._setLevel5(c);
break;default:c&&c(Error("level value out of range"))}break;case "automatic":this._setAutomatic(c);break;case "manual":this._setManual(c);break;case "nextLevel":this._setNextLevel(c);break;case "previousLevel":this._setPreviousLevel(c);break;case "nightIn":a=parseInt(b.ext);if(isNaN(a)){c&&c(Error("night in value invalid"));break}switch(a){case 1:this._setNightIn1(c);break;case 2:this._setNightIn2(c);break;case 3:this._setNightIn3(c);break;default:c&&c(Error("night in value out of range"))}break;
case "nightOut":a=parseInt(b.ext);if(isNaN(a)){c&&c(Error("night out value invalid"));break}switch(a){case 1:this._setNightOut1(c);break;case 2:this._setNightOut2(c);break;case 3:this._setNightOut3(c);break;default:c&&c(Error("night out value out of range"))}break;case "resetFilter":this._resetFilter(calllback);break;case "resetError":this._resetError(calllback)}else c&&c(Error("command value is empty"))};d.prototype.getStatesCreator=function(a,b,c){for(var e=this,f=function(v,p,t){var y=[],u,n;switch(v){case "main":e.getMainStates(function(w,
x){if(w)t(w);else{for(u=0;u<p.length;u++)if((n=p[u])&&n.id&&n.status)switch(n.status.value){case "tempIn":case "tempOut":case "humIn":case "humOut":case "sleepMode":y.push({id:n.id,status:x[n.status.value]})}t(null,y)}});break;case "general":e.getGeneralStates(function(w,x){if(w)t(w);else{for(u=0;u<p.length;u++)if((n=p[u])&&n.id&&n.status)switch(n.status.value){case "level":case "mode":case "stateNr":case "stateNrInt":case "error":case "errorNr":case "nightSpeed":case "filterReplace":case "logEntries":case "humidityNr":case "freezeNr":case "usageMode":case "nightModeState":y.push({id:n.id,
status:x[n.status.value]})}t(null,y)}});break;case "ambients":e.getAmbientsStates(function(w,x){if(w)t(w);else{for(u=0;u<p.length;u++)if((n=p[u])&&n.id&&n.status)switch(n.status.value){case "temp1":case "temp2":case "temp3":case "temp4":case "hum1":case "hum2":y.push({id:n.id,status:x[n.status.value]})}t(null,y)}});break;case "filter":e.getFilterStates(function(w,x){if(w)t(w);else{for(u=0;u<p.length;u++)if((n=p[u])&&n.id&&n.status)switch(n.status.value){case "elapsed":case "remaining":y.push({id:n.id,
status:x?x[n.status.value]:"?"})}t(null,y)}});break;case "fan":e.getFanStates(function(w,x){if(w)t(w);else{for(u=0;u<p.length;u++)if((n=p[u])&&n.id&&n.status)switch(n.status.value){case "targetRSIn":case "currentRSIn":case "targetRSOut":case "currentRSOut":case "maxRS":case "minRS":y.push({id:n.id,status:x?x[n.status.value]:"?"})}t(null,y)}})}},g=[],h=0;h<b.length;h++){var m=b[h];if(m&&m.id&&m.status&&m.status.value)switch(m.status.value){case "tempIn":case "tempOut":case "humIn":case "humOut":case "sleepMode":-1==
g.indexOf("main")&&g.push("main");break;case "level":case "mode":case "stateNr":case "stateNrInt":case "error":case "errorNr":case "nightSpeed":case "filterReplace":case "logEntries":case "humidityNr":case "freezeNr":case "usageMode":case "nightModeState":-1==g.indexOf("general")&&g.push("general");break;case "temp1":case "temp2":case "temp3":case "temp4":case "hum1":case "hum2":-1==g.indexOf("ambients")&&g.push("ambients");break;case "elapsed":case "remaining":-1==g.indexOf("filter")&&g.push("filter");
break;case "targetRSIn":case "currentRSIn":case "targetRSOut":case "currentRSOut":case "maxRS":case "minRS":-1==g.indexOf("fan")&&g.push("fan")}}if(0==g.length)c&&c(null,[]);else{var k=0,l=[],r=function(v,p){k++;!v&&p&&(l=l.concat(p),"undefined"!=typeof a&&null!=a&&"undefined"!=typeof a.reportStates&&null!=a.reportStates&&a.reportStates(null,p));k<g.length?f(g[k],b,r):c&&c(null,l)};f(g[k],b,r)}};d.prototype.getMainStates=function(a){var b=this;this._readMain(function(c,e){c?a&&a(c):(c=b._resolveMainStates(e),
a&&a(null,c))})};d.prototype._resolveMainStates=function(a){var b={};b.tempIn=parseInt(a.TempIn)/100;b.tempOut=parseInt(a.TempOut)/100;b.humIn=parseInt(a.HumidityIn)/100;b.humOut=parseInt(a.HumidityOut)/100;b.sleepMode="yes"==a.SleepMode;return b};d.prototype.getGeneralStates=function(a){var b=this;this._readStatus(function(c,e){c?a&&a(c):(c=b._resolveGeneralStates(e),a&&a(null,c))})};d.prototype._resolveGeneralStates=function(a){var b={};b.stateNr=parseInt(a.StateNr);5>=b.stateNr?(b.level=b.stateNr,
b.mode="MANUAL"):(b.level="",b.mode=a.State);10==b.stateNr?(b.error=a.Error,b.errorNr=a.ErrorNr):(b.error="",b.errorNr="");b.nightSpeed=7==b.stateNr||8==b.stateNr?parseInt(a.NightSpeed):"";b.stateNrInt=parseInt(a.StateNrInternal);b.logEntries=parseInt(a.LOGEntries);b.filterReplace="yes"==a.ReplaceFilter;b.humidityNr=parseInt(a.StateOfHumidityNr);b.freezeNr=parseInt(a.StateOfFreezeNr);b.usageMode=parseInt(a.UsageMode);b.nightModeState=parseInt(a.NightModeState);return b};d.prototype.getAmbientsStates=
function(a){var b=this;this._readAmbients(function(c,e){c?a&&a(c):(c=b._resolveAmbientsStates(e),a&&a(null,c))})};d.prototype._resolveAmbientsStates=function(a){var b={};b.temp1=parseInt(a.Temp1)/100;b.temp2=parseInt(a.Temp2)/100;b.temp3=parseInt(a.Temp3)/100;b.temp4=parseInt(a.Temp4)/100;b.hum1=parseInt(a.Humidity1)/100;b.hum2=parseInt(a.Humidity2)/100;return b};d.prototype.getFilterStates=function(a){var b=q.getFilterStates(this._ip);if("undefined"!=typeof b)null!=b&&(b=this._resolveFilterStates(b)),
a&&a(null,b);else{var c=this;this.readFilter(function(e,f){q.setFilterStates(c._ip,e?null:f);e=c._resolveFilterStates(f);a&&a(null,e)})}};d.prototype._resolveFilterStates=function(a){var b={};b.elapsed=parseInt(a.Elapsed);b.remaining=parseInt(a.Remaining);return b};d.prototype.getFanStates=function(a){var b=q.getFanStates(this._ip);if("undefined"!=typeof b)null!=b&&(b=this._resolveFanStates(b)),a&&a(null,b);else{var c=this;this.readFan(function(e,f){q.setFanStates(c._ip,e?null:f);e=c._resolveFanStates(f);
a&&a(null,e)})}};d.prototype._resolveFanStates=function(a){var b={};b.targetRSIn=parseInt(a.TargetRotationSpeedIN);b.currentRSIn=parseInt(a.ActualRotationSpeedIN);b.targetRSOut=parseInt(a.TargetRotationSpeedOUT);b.currentRSOut=parseInt(a.ActualRotationSpeedOUT);b.maxRS=parseInt(a.MaxRotationSpeed);b.minRS=parseInt(a.MinRotationSpeed);return b};d.prototype.configUdpServer=function(a,b,c){a||(a="255.255.255.255");b||(b=1903);var e=this;this.setUdpServer(a,b,function(f){f?c&&c(f):(e._configUdpServerInterval&&
clearInterval(e._configUdpServerInterval),e._configUdpServerInterval=setInterval(function(){e.setUdpServer(a,b)},6E5),c&&c())})};d.prototype.setStandBy=function(a){this._setStandBy(a)};d.prototype._setStandBy=function(a){this._doRequest("POST","/CommandSET_STANDBY.cmd",null,function(b){a&&a(b)})};d.prototype.setOn=function(a){this._setOn(a)};d.prototype._setOn=function(a){this._doRequest("POST","/CommandSET_ON.cmd",null,function(b){a&&a(b)})};d.prototype.setLevel1=function(a){this._setLevel1(a)};
d.prototype._setLevel1=function(a){this._doRequest("POST","/CommandSET_LEVEL1.cmd",null,function(b){a&&a(b)})};d.prototype.setLevel2=function(a){this._setLevel2(a)};d.prototype._setLevel2=function(a){this._doRequest("POST","/CommandSET_LEVEL2.cmd",null,function(b){a&&a(b)})};d.prototype.setLevel3=function(a){this._setLevel3(a)};d.prototype._setLevel3=function(a){this._doRequest("POST","/CommandSET_LEVEL3.cmd",null,function(b){a&&a(b)})};d.prototype.setLevel4=function(a){this._setLevel4(a)};d.prototype._setLevel4=
function(a){this._doRequest("POST","/CommandSET_LEVEL4.cmd",null,function(b){a&&a(b)})};d.prototype.setLevel5=function(a){this._setLevel5(a)};d.prototype._setLevel5=function(a){this._doRequest("POST","/CommandSET_LEVEL5.cmd",null,function(b){a&&a(b)})};d.prototype.setAutomatic=function(a){this._setAutomatic(a)};d.prototype._setAutomatic=function(a){this._doRequest("POST","/CommandSET_AUTOMATIC.cmd",null,function(b){a&&a(b)})};d.prototype.setManual=function(a){this._setManual(a)};d.prototype._setManual=
function(a){this._doRequest("POST","/CommandSET_MANUAL.cmd",null,function(b){a&&a(b)})};d.prototype.setNextLevel=function(a){this._setNextLevel(a)};d.prototype._setNextLevel=function(a){this._doRequest("POST","/CommandSET_NEXT_LEVEL.cmd",null,function(b){a&&a(b)})};d.prototype.setPreviousLevel=function(a){this._setPreviousLevel(a)};d.prototype._setPreviousLevel=function(a){this._doRequest("POST","/CommandSET_PREV_LEVEL.cmd",null,function(b){a&&a(b)})};d.prototype.setNightIn1=function(a){this._setNightIn1(a)};
d.prototype._setNightIn1=function(a){this._doRequest("POST","/CommandSET_N_IN1.cmd",null,function(b){a&&a(b)})};d.prototype.setNightIn2=function(a){this._setNightIn2(a)};d.prototype._setNightIn2=function(a){this._doRequest("POST","/CommandSET_N_IN2.cmd",null,function(b){a&&a(b)})};d.prototype.setNightIn3=function(a){this._setNightIn3(a)};d.prototype._setNightIn3=function(a){this._doRequest("POST","/CommandSET_N_IN3.cmd",null,function(b){a&&a(b)})};d.prototype.setNightOut1=function(a){this._setNightOut1(a)};
d.prototype._setNightOut1=function(a){this._doRequest("POST","/CommandSET_N_OUT1.cmd",null,function(b){a&&a(b)})};d.prototype.setNightOut2=function(a){this._setNightOut2(a)};d.prototype._setNightOut2=function(a){this._doRequest("POST","/CommandSET_N_OUT2.cmd",null,function(b){a&&a(b)})};d.prototype.setNightOut3=function(a){this._setNightOut3(a)};d.prototype._setNightOut3=function(a){this._doRequest("POST","/CommandSET_N_OUT3.cmd",null,function(b){a&&a(b)})};d.prototype._resetFilter=function(a){this._doRequest("POST",
"/CommandRESET_FILTER.cmd",null,function(b){a&&a(b)})};d.prototype.readMainA=function(a){this._readMain(function(b,c){a&&a(b,c)})};d.prototype.readMainB=function(a){this._asyncRead("_readMainCallbacks","_cmdReadMain","_readMain",a)};d.prototype._cmdReadMain=function(a){this._doRequest("POST","/CommandREAD_MAIN.cmd",null,function(b){a&&a(b)})};d.prototype._readMain=function(a){this._doRequestXML("GET","/CmdResultREAD_MAIN.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_MAIN response invalid"))})};
d.prototype.readStatus=function(a){this._readStatus(function(b,c){a&&a(b,c)})};d.prototype._readStatus=function(a){this._doRequestXML("GET","/CmdResultREAD_STATUS.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_STATUS response invalid"))})};d.prototype.readSoftware=function(a){this._readSoftware(function(b,c){a&&a(b,c)})};d.prototype._readSoftware=function(a){this._doRequestXML("GET","/CmdResultREAD_SOFTWARE.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):
a&&a(Error("READ_SOFTWARE response invalid"))})};d.prototype.readAmbientsA=function(a){this._readAmbients(function(b,c){a&&a(b,c)})};d.prototype.readAmbientsB=function(a){this._asyncRead("_readAmbientsCallbacks","_cmdReadAmbients","_readAmbients",a)};d.prototype._cmdReadAmbients=function(a){this._doRequest("POST","/CommandREAD_AMBIENTS.cmd",null,function(b){a&&a(b)})};d.prototype._readAmbients=function(a){this._doRequestXML("GET","/CmdResultREAD_AMBIENTS.cmd",null,function(b,c){b?a&&a(b):c&&c.State?
a&&a(null,c.State):a&&a(Error("READ_AMBIENTS response invalid"))})};d.prototype.readFilter=function(a){this._asyncRead("_readFilterCallbacks","_cmdReadFilter","_readFilter",a)};d.prototype.readFilter2=function(a){this._readFilter(function(b,c){a&&a(b,c)})};d.prototype._cmdReadFilter=function(a){this._doRequest("GET","/CommandREAD_FILTER.cmd",null,function(b){a&&a(b)})};d.prototype._readFilter=function(a){this._doRequestXML("GET","/CmdResultREAD_FILTER.cmd",null,function(b,c){b?a&&a(b):c&&c.State?
a&&a(null,c.State):a&&a(Error("READ_FILTER response invalid"))})};d.prototype.readLog=function(a,b){var c=this._readLogCallbacks.length;b&&-1==this._readLogCallbacks.indexOf(b)&&this._readLogCallbacks.push(b);if(0==c){var e=this,f=function(g,h){var m=e._readLogCallbacks;e._readLogCallbacks=[];for(var k=0;k<m.length;k++)try{m[k](g,h)}catch(l){}};this._cmdParameterReadLog(a,function(g){if(g)f(g);else{var h=0,m=function(k,l){k?f(k):"yes"==l.ready?f(null,l):50<h?f(Error("result not ready")):(h++,setTimeout(function(){e._readLog(a,
m)},500))};e._readLog(a,m)}})}};d.prototype._cmdParameterReadLog=function(a,b){this._doRequest("POST","/CommandPARAMETER_READ_LOG"+a+".cmd",null,function(c){b&&b(c)})};d.prototype._readLog=function(a,b){this._doRequestXML("GET","/CmdResultPARAMETER_READ_LOG"+a+".cmd",null,function(c,e){c?b&&b(c):e&&e.State?b&&b(null,e.State):b&&b(Error("PARAMETER_READ_LOG response invalid"))})};d.prototype.readFan=function(a){this._asyncRead("_readFanCallbacks","_cmdReadFan","_readFan",a)};d.prototype._cmdReadFan=
function(a){this._doRequest("POST","/CommandREAD_FAN.cmd",null,function(b){a&&a(b)})};d.prototype._readFan=function(a){this._doRequestXML("GET","/CmdResultREAD_FAN.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_FAN response invalid"))})};d.prototype.readWlanScan=function(a){this._asyncRead("_readWlanScanCallbacks","_cmdReadWlanScan","_readWlanScan",a)};d.prototype._cmdReadWlanScan=function(a){this._doRequest("POST","/CommandREAD_WLANSCAN.cmd",null,function(b){a&&
a(b)})};d.prototype._readWlanScan=function(a){this._doRequestXML("GET","/CmdResultREAD_WLANSCAN.cmd",null,function(b,c){b?a&&a(b):c&&c.WiFi?a&&a(null,c.WiFi):a&&a(Error("READ_WLANSCAN response invalid"))})};d.prototype.readIpMac=function(a){this._readIpMac(function(b,c){a&&a(b,c)})};d.prototype._readIpMac=function(a){this._doRequestXML("GET","/CmdResultREAD_IPMAC.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("CmdResultREAD_IPMAC.cmd response invalid"))})};d.prototype.readWifiSettings=
function(a){this._readWifiSettings(function(b,c){a&&a(b,c)})};d.prototype._readWifiSettings=function(a){this._doRequestXML("GET","/CmdResultREAD_WIFISETTINGS.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_MAIN response invalid"))})};d.prototype.readSignal=function(a){this._readSignal(function(b,c){a&&a(b,c)})};d.prototype._readSignal=function(a){this._doRequestXML("GET","/CmdResultREAD_SIGNAL.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_SIGNAL response invalid"))})};
d.prototype.readLED=function(a){this._readLED(function(b,c){a&&a(b,c)})};d.prototype._readLED=function(a){this._doRequestXML("GET","/CmdResultREAD_LED.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_LED response invalid"))})};d.prototype.readCommon=function(a){this._readCommon(function(b,c){a&&a(b,c)})};d.prototype._readCommon=function(a){this._doRequestXML("GET","/CmdResultREAD_COMMON.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_COMMON response invalid"))})};
d.prototype.readCounter=function(a){this._asyncRead("_readCounterCallbacks","_cmdReadCounter","_readCounter",a)};d.prototype._cmdReadCounter=function(a){this._doRequest("GET","/CommandREAD_COUNTER.cmd",null,function(b){a&&a(b)})};d.prototype._readCounter=function(a){this._doRequestXML("GET","/CmdResultREAD_COUNTER.cmd",null,function(b,c){b?a&&a(b):c&&c.State?a&&a(null,c.State):a&&a(Error("READ_COUNTER response invalid"))})};d.prototype.readSerial=function(a){this._readSerial(function(b,c){a&&a(b,
c)})};d.prototype._readSerial=function(a){this._doRequest("GET","/CmdResultREAD_SERIALNR.cmd",null,function(b,c){a&&a(b,c)})};d.prototype.readName=function(a){this._readName(function(b,c){a&&a(b,c)})};d.prototype._readName=function(a){this._doRequest("GET","/CmdResultREAD_NAME.cmd",null,function(b,c){a&&a(b,c)})};d.prototype.changeName=function(a,b){this._cmdParamChangeName(a,function(c){b&&b(c)})};d.prototype._cmdParamChangeName=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHANGE_NAME"+
a+".cmd",null,function(c){b&&b(c)})};d.prototype.setWlanOff=function(a,b){this._cmdParamWlanOff(a,function(c){b&&b(c)})};d.prototype._cmdParamWlanOff=function(a,b){this._doRequest("POST","/CommandPARAMETER_WLAN_OFF"+a+".cmd",null,function(c){b&&b(c)})};d.prototype.selectSTA=function(a,b,c){var e=this;this._cmdParamChooseWlanNet(a,function(f){f?c&&c(f):e._cmdParamChooseWlanPwd(b,function(g){g?c&&c(g):e._cmdSelectSTA(function(h){c&&c(h)})})})};d.prototype._cmdParamChooseWlanNet=function(a,b){this._doRequest("POST",
"/CommandPARAMETER_CHOOSEWLANNET"+a+".cmd",null,function(c){b&&b(c)})};d.prototype._cmdParamChooseWlanPwd=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANPWD"+a+".cmd",null,function(c){b&&b(c)})};d.prototype._cmdSelectSTA=function(a){this._doRequest("POST","/CommandSELECT_STA.cmd",null,function(b){a&&a(b)})};d.prototype.setLedTimeout=function(a,b){this._cmdParamLedTimeout(a,function(c){b&&b(c)})};d.prototype._cmdParamLedTimeout=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_TIMEOUT"+
a+".cmd",null,function(c){b&&b(c)})};d.prototype.setLedIntensity=function(a,b){this._cmdParamLedIntensity(a,function(c){b&&b(c)})};d.prototype._cmdParamLedIntensity=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_INTENSITY"+a+".cmd",null,function(c){b&&b(c)})};d.prototype.setLedReverseDirection=function(a,b){this._cmdParamLedReverseDirection(a?"yes":"no",function(c){b&&b(c)})};d.prototype._cmdParamLedReverseDirection=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_REVERSE_DIRECTION"+
a+".cmd",null,function(c){b&&b(c)})};d.prototype.setExtKeyActive=function(a,b){this._cmdParamExtkeyActive(a?"yes":"no",function(c){b&&b(c)})};d.prototype._cmdParamExtkeyActive=function(a,b){this._doRequest("POST","/CommandPARAMETER_EXTKEY_ACTIVE"+a+".cmd",null,function(c){b&&b(c)})};d.prototype.setUdpServer=function(a,b,c){this._cmdParamUdpServer(a,b,function(e){c&&c(e)})};d.prototype._cmdParamUdpServer=function(a,b,c){this._doRequest("POST","/CommandPARAMETER_UDP_SERVER"+a+":"+b+".cmd",null,function(e){c&&
c(e)})};d.prototype.identify=function(a,b,c){this._cmdParamIdentify(a,b,function(e){c&&c(e)})};d.prototype._cmdParamIdentify=function(a,b,c){this._doRequest("POST","/CommandPARAMETER_IDENTIFY"+a+"_"+b+".cmd",null,function(e){c&&c(e)})};d.prototype.startTestRGBs=function(a,b){this._cmdParamTestRGBs(a,1,function(c){b&&b(c)})};d.prototype.stopTestRGBs=function(a){this._cmdParamTestRGBs("ffffff",0,function(b){a&&a(b)})};d.prototype._cmdParamTestRGBs=function(a,b,c){this._doRequest("POST","/CommandPARAMETER_TESTRGBS"+
a+"_"+b+".cmd",null,function(e){c&&c(e)})};d.prototype.resetError=function(a){this._resetError(function(b){a&&a(b)})};d.prototype._resetError=function(a){this._doRequest("POST","/CommandRESET_ERROR.cmd",null,function(b){a&&a(b)})};d.prototype.quitError=function(a){this._cmdQuitError(function(b){a&&a(b)})};d.prototype._cmdQuitError=function(a){this._doRequest("POST","/CommandQUIT_ERROR.cmd",null,function(b){a&&a(b)})};d.prototype.restart=function(a){this._cmdRestart(function(b){a&&a(b)})};d.prototype._cmdRestart=
function(a){this._doRequest("POST","/CommandRESTART.cmd",null,function(b){a&&a(b)})};d.prototype.resetWlan=function(a){this._cmdResetWlan(function(b){a&&a(b)})};d.prototype._cmdResetWlan=function(a){this._doRequest("POST","/CommandRESET_WLAN.cmd",null,function(b){a&&a(b)})};d.prototype.resetData=function(a){this._cmdResetData(function(b){a&&a(b)})};d.prototype._cmdResetData=function(a){this._doRequest("POST","/CommandRESET_DATA.cmd",null,function(b){a&&a(b)})};d.prototype.saveStampStartup=function(a,
b){var c=a.getFullYear()+"";c=c.substr(2,2);var e=a.getMonth()+1+"";2>e.length&&(e="0"+e);var f=a.getDate()+"";2>f.length&&(f="0"+f);var g=a.getHours()+"";2>g.length&&(g="0"+g);a=a.getMinutes()+"";2>a.length&&(a="0"+a);this._cmdParamStampStartup(c,e,f,g,a,function(h){b&&b(h)})};d.prototype._cmdParamStampStartup=function(a,b,c,e,f,g){this._doRequest("POST","/CommandPARAMETER_STAMP_STARTUP"+a+b+c+e+f+".cmd",null,function(h){g&&g(h)})};d.prototype.changeAPPwd=function(a,b){this._cmdParamChangeAppwd(a,
function(c){b&&b(c)})};d.prototype._cmdParamChangeAppwd=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHANGE_APPWD"+a+".cmd",null,function(c){b&&b(c)})};d.prototype._asyncRead=function(a,b,c,e){var f=this[a].length;e&&-1==this[a].indexOf(e)&&this[a].push(e);if(0==f){var g=this,h=function(m,k){var l=g[a];g[a]=[];for(var r=0;r<l.length;r++)try{l[r](m,k)}catch(v){}};this[b](function(m){if(m)h(m);else{var k=0,l=function(r,v){r?h(r):"yes"==v.ready?h(null,v):50<k?h(Error("result not ready")):
(k++,setTimeout(function(){g[c](l)},500))};g[c](l)}})}};d.prototype._doRequestXML=function(a,b,c,e){var f=this;this._doRequest(a,b,c,function(g,h){g?e&&e(g):(g=null,h&&(g=f._xml2json(h))&&g["?xml-stylesheet"]&&(g=g["?xml-stylesheet"]),e&&e(null,g))})};d.prototype._xml2json=function(a){var b=function(h){var m={};h.children().each(function(){var k=$(this),l=k.prop("tagName");k=0==k.children().length?k.text():b(k);var r=m[l];"undefined"==typeof r||null==r?m[l]=k:Array.isArray(r)?r.push(k):m[l]=[r,k]});
return m};try{var c=$($.parseXML(a));var e=c.getRootNode?c.getRootNode():$(c.children()[0]);if(!e)return null;var f=e.prop("tagName"),g=b(e);a={};a[f]=g;return a}catch(h){return null}};d.prototype._doRequest=function(a,b,c,e){var f=this._httpReqBuffer.length;this._httpReqBuffer.push({method:a,path:b,data:c,callback:e});0==f&&this._doNextHttpReq()};d.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var a=this._httpReqBuffer[0],b=this;this._doRequestHttp(a.method,a.path,a.data,
function(c,e){a.callback&&a.callback(c,e);b._httpReqBuffer.splice(0,1);b._doNextHttpReq()})}};d.prototype._doRequestHttp=function(a,b,c,e){var f="https://"+this._ip+":"+this._port+b;this._logger.log("trace","send "+a+" to url: "+f+" data:"+c);a={host:this._ip,port:this._port,path:b,method:a,headers:{}};if(this._username||this._password)a.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),a.headers.Authorization="Basic "+(new Buffer((this._username?this._username:"")+":"+
(this._password?this._password:""))).toString("base64");var g=this,h=e;e=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",a.agent=this._keepAliveAgent);var m=e.request(a,function(k){k.setEncoding("utf-8");var l="";k.on("data",function(r){l+=r});k.on("end",function(){g._logger.log("trace",f+" response "+k.statusCode+": "+l);if(200==k.statusCode)h&&h(null,l);else{var r=Error("http response "+k.statusCode);h&&h(r)}h=null})});m.setTimeout(this._timeout,
function(){g._logger.log("trace","http request "+f+" timeout");h&&(h(Error("http request timeout")),h=null);m.abort()});m.on("error",function(k){g._logger.log("trace","http request "+f+" error:"+k.message);h&&(h(k),h=null)});c&&m.write(c);m.end()};d.prototype._doRequestAjax=function(a,b,c,e){var f=this;b="http://"+this._ip+":"+this._port+b;this._logger.log("trace","send "+a+" to url:"+b+" data:"+c);var g=e;$.ajax({url:b,type:a,timeout:this._timeout,data:c,dataType:"text",cache:!1,username:this._username,
password:this._password,success:function(h){f._logger.log("trace","http request success:"+h);g&&(g(null,h),g=null)},error:function(h,m){h="http request error:"+(h?h.status:"0")+"-"+m;f._logger.log("trace",h);g&&(g(Error(h)),g=null)}})};d.prototype.toJSON=function(){return{sys:"gealan",ip:this._ip,port:this._port,username:this._username,password:this._password}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this._ip==a._ip&&this._port==a._port:!1};d.parseJSON=function(a){return a&&a.ip?
new d(a.ip,a.port,a.username,a.password):null};return d}();
xnm.aio.gealan.UdpListener=function(){var q=function(d){this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.EventListener");this._port=d;this._port||(this._port=1903);this._state=0;this._socket=null;this._callbacks=[];this._listeners=[]};q.prototype.start=function(d){if(2==this._state)d&&d();else if(1==this._state)d&&-1==this._callbacks.indexOf(d)&&this._callbacks.push(d);else{var a=this;this._state=1;this._logger.log("debug","start listen to port "+this._port);this._startUdpListener(this._port,
function(b,c){b?(a._state=0,a._logger.log("debug","failed to listen to port "+a._port+":"+b.message)):(a._state=2,a._socket=c,a._logger.log("debug","listen to port "+a._port+" success"));c=a._callbacks;a._callbacks=[];for(var e=0;e<c.length;e++)c[e](b)})}};q.prototype.stop=function(d){0!=this._state&&(this._socket&&(this._socket.close(),this._socket=null),this._state=0);d&&d()};q.prototype.addListener=function(d){d&&-1==this._listeners.indexOf(d)&&this._listeners.push(d)};q.prototype.removeListener=
function(d){d&&(d=this._listeners.indexOf(d),-1!=d&&this._listeners.splice(d,1))};q.prototype._startUdpListener=function(d,a){var b=this,c=a,e=require("dgram").createSocket({type:"udp4",reuseAddr:!0});e.on("listening",function(){e.setBroadcast&&e.setBroadcast(!0);b._logger.log("trace","udp listener started at port:"+d);c&&(c(null,e),c=null)});e.on("error",function(f){c?(b._logger.log("trace","bind udp listener at port:"+d+" error:"+f.stack),c(f),c=null):(b._logger.log("trace","udp listener at port:"+
d+" error:"+f.stack),b.stop())});e.on("message",function(f,g){f=f.toString();b._logger.log("trace","receive udp message at port:"+d+" from:"+g.address+" data:"+f);f=f.split(" ");f="Status"==f[0]&&"changed"==f[1]?{key:"Status changed",value:f[2]}:"new"==f[0]&&"IP"==f[1]?{key:"new IP",value:f[2]}:{key:f[0],value:f[1]};for(var h=0;h<b._listeners.length;h++)try{b._listeners[h](f,g)}catch(m){}});e.bind(d)};return q}();
xnm.aio.gealan.DM=function(){var q={command:[{type:"int",name:"set level",ref:{value:"setLevel",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"automatic",ref:{value:"automatic"}},{type:"enum",name:"manual",ref:{value:"manual"}},{type:"enum",name:"next level",ref:{value:"nextLevel"}},{type:"enum",name:"previous level",ref:{value:"previousLevel"}},{type:"enum",name:"reset filter",ref:{value:"resetFilter"}},{type:"enum",name:"reset error",ref:{value:"resetError"}}],status:[{type:"int",name:"temperature inside",
ref:{value:"tempIn",ext:"%d"}},{type:"int",name:"temperature outside",ref:{value:"tempOut",ext:"%d"}},{type:"int",name:"humidity inside",ref:{value:"humIn",ext:"%d"}},{type:"int",name:"humidity outside",ref:{value:"humOut",ext:"%d"}},{type:"int",name:"level",ref:{value:"level",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"mode",ref:{value:"mode",options:"MANUAL AUTOMATIC NIGHT_IN NIGHT_OUT FLAP_CLOSED ERROR FROST_PROTECTION MOISTURE_PROTECTION".split(" ")}},{type:"int",name:"state no.",ref:{value:"stateNr",
ext:"%d",extMeta:"0-12"}},{type:"int",name:"state no. (internal)",ref:{value:"stateNrInt",ext:"%d"}},{type:"string",name:"error message",ref:{value:"error",ext:"%s"}},{type:"int",name:"error no.",ref:{value:"errorNr",ext:"%d"}},{type:"int",name:"night speed",ref:{value:"nightSpeed",ext:"%d",extMeta:"1-3"}},{type:"enum",name:"replace filter",ref:{value:"filterReplace",options:["true","false"]}},{type:"enum",name:"sleep mode",ref:{value:"sleepMode",options:["true","false"]}},{type:"int",name:"log entries",
ref:{value:"logEntries",ext:"%d"}},{type:"int",name:"humidity no.",ref:{value:"humidityNr",ext:"%d"}},{type:"int",name:"freeze no.",ref:{value:"freezeNr",ext:"%d"}},{type:"int",name:"usage mode",ref:{value:"usageMode",ext:"%d"}},{type:"int",name:"night mode state",ref:{value:"nightModeState",ext:"%d"}},{type:"int",name:"temperature exhaust air (outside)",ref:{value:"temp1",ext:"%d"}},{type:"int",name:"temperature supply air (inside)",ref:{value:"temp2",ext:"%d"}},{type:"int",name:"temperature supply air (outside)",
ref:{value:"temp3",ext:"%d"}},{type:"int",name:"temperature exhaust air (inside)",ref:{value:"temp4",ext:"%d"}},{type:"int",name:"humidity supply air (outside)",ref:{value:"hum1",ext:"%d"}},{type:"int",name:"humidity exhaust air (inside)",ref:{value:"hum2",ext:"%d"}},{type:"int",name:"filter elapsed time",ref:{value:"elapsed",ext:"%d"}},{type:"int",name:"filter remaining time",ref:{value:"remaining",ext:"%d"}},{type:"int",name:"target rotation speed in",ref:{value:"targetRSIn",ext:"%d"}},{type:"int",
name:"actual rotation speed in",ref:{value:"currentRSIn",ext:"%d"}},{type:"int",name:"target rotation speed out",ref:{value:"targetRSOut",ext:"%d"}},{type:"int",name:"actual rotation speed out",ref:{value:"currentRSOut",ext:"%d"}},{type:"int",name:"max rotation speed",ref:{value:"maxRS",ext:"%d"}},{type:"int",name:"min rotation speed",ref:{value:"minRS",ext:"%d"}}]},d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="GealanDMError";d.prototype.code=
0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"gealan",getIPDeviceType:function(){return[{sys:this.SYS,name:"Gealan Fan"}]},createDevice:function(a,b,c){b=d.ERROR_CODE;a?a.type?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"type is invalid")):c(new d(b.INVALID,"info is invalid"))},updateDevice:function(a,b,c){b=d.ERROR_CODE;a?a.type?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"type is invalid")):
c(new d(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,c){var e=this,f=function(l,r){if("*"==l)return!0;for(var v=!1,p=0;p<l.length;p++)if(l[p]==r){v=!0;break}return v},g=function(l,r,v){var p=[];switch(v.catagory){case "command":l.command&&l.command.forEach(function(t){f(v.elems,t.type)&&(t=JSON.parse(JSON.stringify(t)),p.push(t))});break;case "status":l.status&&l.status.forEach(function(t){f(v.elems,t.type)&&(t=JSON.parse(JSON.stringify(t)),p.push(t))})}return p},
h=function(l,r){var v=[],p=e.getCommandStatusMap(l,c);p&&(l=g(p,l,r),v=v.concat(l));return v};if(!a.sys)return null;var m=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=h(a,b);m.command=k;break;case "status":k=h(a,b);m.status=k;break;default:return null}return k&&0!=k.length?m:null},getCommandStatusMap:function(a,b){return q}}}();
xnm.aio.gealan.Handler=function(){var q=function(){this._udpListener=new xnm.aio.gealan.UdpListener(1903)};q.prototype.devicemanager=xnm.aio.gealan.DM;q.prototype.Fan=xnm.aio.gealan.Fan;q.prototype.registModule=function(d){d.register("gealan","gealan")};q.prototype.resolveDevice=function(d){return this.Fan.parseJSON(d)};q.prototype.getDeviceCommands=function(d,a){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];a&&a(null,d)};q.prototype.getDeviceStatus=function(d,
a){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];a&&a(null,d)};q.prototype.doCommand=function(d,a,b){var c=this.resolveDevice(d);c?c.executeCommandCreator(d,a,function(e){b&&b(e)}):b&&b(Error("device json format invalid"))};q.prototype.doStatus=function(d,a,b,c){var e=this.resolveDevice(a);e?e.getStatesCreator(null,[{id:d,device:a,status:b}],function(f,g){f?c&&c(f):c&&c(null,g[0])}):c&&c(Error("device json format invalid"))};q.prototype.getUdpListener=function(){return this._udpListener};
return q}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gealan.Handler);
