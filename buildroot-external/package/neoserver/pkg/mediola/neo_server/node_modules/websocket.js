var WebSocket=function(b){this._secure=!1;this._socket=null;this._handshakeDone=!1;b=require("url").parse(b);this._host=b.hostname;this._port=b.port;this._path=b.path;this._path||(this._path="/");"wss:"==b.protocol?(this._secure=!0,this._port||(this._port=443)):this._port||(this._port=80);this.onclose=this.onopen=this.onerror=this.onmessage=null};
WebSocket.prototype.open=function(){if(this._secure){var b=require("tls");process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";var a=this;this._socket=b.connect(this._port,this._host,function(){a._socket.setEncoding("utf-8");var c="GET "+a._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";c+="Host: "+a._host+"\r\n";a._socket.write(c+"Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\nSec-WebSocket-Version: 13\r\n\r\n")});this._socket.addListener("data",function(c){if(a._handshakeDone){if(c=
a._decodeWSData(c).trim(),a.onmessage&&0<c.length)a.onmessage(c)}else if(0==c.indexOf("HTTP")&&(a._handshakeDone=!0,a.onopen))a.onopen()});this._socket.addListener("error",function(c){if(a.onerror)a.onerror(c.code)});this._socket.addListener("close",function(){if(a.onclose)a.onclose();a.onmessage=null;a.onerror=null;a.onopen=null;a.onclose=null})}else this._open()};
WebSocket.prototype._open=function(){var b=this;this._socket=require("net").connect(this._port,this._host,function(){b._socket.setEncoding("utf-8");var a="GET "+b._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";a+="Host: "+b._host+"\r\n";b._socket.write(a+"Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\nSec-WebSocket-Version: 13\r\n\r\n")});this._socket.addListener("data",function(a){if(b._handshakeDone){if(a=b._decodeWSData(a).trim(),b.onmessage&&0<a.length)b.onmessage(a)}else if(0==
a.indexOf("HTTP")&&(b._handshakeDone=!0,b.onopen))b.onopen()});this._socket.addListener("error",function(a){if(b.onerror)b.onerror(a.code)});this._socket.addListener("close",function(){if(b.onclose)b.onclose();b.onmessage=null;b.onerror=null;b.onopen=null;b.onclose=null})};WebSocket.prototype.send=function(b){this._socket.write(this._encodeWSData(b))};WebSocket.prototype.sendJSON=function(b){this.send(JSON.stringify(b))};
WebSocket.prototype.close=function(){this._socket.end();if(this.onclose)this.onclose();this.onclose=this.onopen=this.onerror=this.onmessage=null};
WebSocket.prototype._encodeWSData=function(b){b=new Buffer(b,"binary");var a=[],c=0;a[c++]=129;if(125>=b.length)a[c++]=b.length+128;else if(65535>=b.length)a[c++]=254,a[c++]=b.length>>8&255,a[c++]=b.length&255;else return null;for(var d=[],e=0;4>e;e++)d.push(Math.floor(255*Math.random())),a[c++]=d[e];for(e=0;e<b.length;e++)a[c++]=b[e]^d[e%4];return new Buffer(a,"binary")};WebSocket.prototype._decodeWSData=function(b){var a=b.charCodeAt(1)&127,c=2;126==a?c=4:127==a&&(c=10);return b.substr(c)};
var WebSocketJS=function(){var b=function(a){this._logger=require("x.logger.js").getLogger("WebSocketJS");this._url=a;this._ws=null;this._state="IDLE";this._eventListeners={}};b.prototype.on=function(a,c){a&&c&&(this._eventListeners[a]||(this._eventListeners[a]=[]),-1==this._eventListeners[a].indexOf(c)&&this._eventListeners[a].push(c))};b.prototype.off=function(a,c){a&&c&&this._eventListeners[a]&&(c=this._eventListeners[a].indexOf(c),-1!=c&&this._eventListeners[a].splice(c,1))};b.prototype.open=
function(){if("IDLE"==this._state){this._state="OPEN";var a=this,c=new (require("ws"))(url);c.on("open",function(){a._onOpen()});c.on("close",function(){a._onClose()});c.on("error",function(d){a._onError(d)});c.on("message",function(d){a._onMessage(d)});c.on("pong",function(){});this._ws=c}};b.prototype.close=function(){"CLOSE"!=this._state&&this._ws.close()};b.prototype._emitEvent=function(a,c){if(a){var d=this._eventListeners[a];if(d&&0<d.length)for(var e=0;e<d.length;e++){var f=d[e];try{f(c)}catch(g){this._logger.log("trace",
"call "+a+" listener failed, error:"+g.message)}}}};b.prototype._onOpen=function(){this._logger.log("trace","ws open");"RUN"!=this._state&&(this._state="RUN",this._emitEvent("open"))};b.prototype._onClose=function(){this._logger.log("trace","ws closed");"CLOSE"!=this._state&&(this._state="CLOSE",this._emitEvent("close"),this._eventListeners={},this._ws=null)};b.prototype._onError=function(a){this._logger.log("trace","ws error:"+a.message);"CLOSE"!=this._state&&(this._state="CLOSE",this._emitEvent("error",
a),this._eventListeners={},this._ws.close(),this._ws=null)};b.prototype._onMessage=function(){};return b}();exports.createWebSocket=function(b){return new WebSocket(b)};
