var x=x||{};x.hub=x.hub||{};x.hub.sysvarman=x.hub.sysvarman||{};
x.hub.sysvarman.SysvarManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager");this._sysvarFile=null;this._sysvars={};this._writing=!1;this._writeQueue=0};e.FILE_NAME="sysvar.json";e.prototype.init=function(a,b){this._logger.log("info","init sysvar mananger");var c=require("fs-extra"),f=require("path");this._sysvarFile||(this._sysvarFile=f.resolve(a.getUserRootDataPath(),e.FILE_NAME));var m=this;c.ensureFile(this._sysvarFile,function(r){r?
b&&b(r):m._readData(function(p,q){!p&&q&&(m._sysvars=q);b&&b(p)})})};e.prototype.setVar=function(a,b){this._logger.log("trace","setVar:"+(a?JSON.stringify(a):null));if(a&&a.id&&a.type)if(-1==["ONOFF","FLOAT","INT","STRING"].indexOf(a.type))b&&b(Error("invalid sysvar type"));else{var c=parseInt(a.id,16);if(0>=c)b&&b(Error("sysvar out of range"));else{c=c.toString(16).toUpperCase();2>c.length&&(c="0"+c);a={id:c,type:a.type,value:a.value};c=this._sysvars[a.id];switch(a.type){case "ONOFF":a.value||(a.value=
"OFF");a.value=a.value.toUpperCase();if("ON"!=a.value&&"OFF"!=a.value&&"TOGGLE"!=a.value){b&&b(Error("ONOFF sysvar value invalid"));return}if("TOGGLE"==a.value)if(c){if(c.type!=a.type){b&&b(Error("sysvar is not a ONOFF type"));return}a.value="ON"==c.value?"OFF":"ON"}else a.value="OFF";break;case "FLOAT":case "INT":a.value||(a.value="00000000");var f=parseInt(a.value,16);if(isNaN(f)){b&&b(Error("FLOAT/INT sysvar value invalid"));return}break;case "STRING":a.value||(a.value=""),a.value=decodeURIComponent(a.value+
"")}a.time=(new Date).getTime();this._sysvars[a.id]=a;f=require("x.hub.eventbus.js");c&&c.value==a.value||f.emit("gatewayevent",this.getSysvarStateLegacy(a.id),{address:"Sysvar"},"STA");f.emit("udpevent",this.getSysvarStateLegacy(a.id),"STA");this._postWrite(function(m){b&&b(m)})}}else b&&b(Error("sysvar format invalid"))};e.prototype.delVar=function(a,b){a&&this._sysvars[a]?(delete this._sysvars[a],this._postWrite(function(c){b&&b(c)})):b&&b()};e.prototype.getVar=function(a){return a?this._sysvars[a]:
null};e.prototype.getSysvars=function(){return this._sysvars};e.prototype.getSysvarStateLegacy=function(a){if(!a||!this._sysvars[a])return null;a=this._sysvars[a];return{type:a.type,adr:a.id,state:a.value}};e.prototype.getSysvarStatesLegacy=function(){var a=[],b;for(b in this._sysvars)if(this._sysvars.hasOwnProperty(b)){var c=this.getSysvarStateLegacy(b);c&&a.push(c)}return a};e.prototype._readData=function(a){require("fs").readFile(this._sysvarFile,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{var f=
JSON.parse(c);a&&a(null,f?f:{})}catch(m){a&&a(m)}else a&&a(null,{})})};e.prototype._postWrite=function(a){this._writeQueue++;this._writing||this._doWrite();a&&a()};e.prototype._doWrite=function(){if(0<this._writeQueue){var a=this;this._writeQueue=0;this._writing=!0;this._writeData(function(b){b&&a._logger.log("warn","write file failed:"+b.message);a._writing=!1;a._doWrite()})}};e.prototype._writeData=function(a){require("fs").writeFile(this._sysvarFile,JSON.stringify(this._sysvars,null,2),function(b){a&&
a(b)})};return e}();
x.hub.sysvarman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler");this.sysvarManager=new x.hub.sysvarman.SysvarManager};e.prototype.SysvarManager=x.hub.sysvarman.SysvarManager;e.prototype.init=function(a,b,c){this.sysvarManager.init(b,function(f){c&&c({error:f})})};e.prototype.setVar=function(a,b){this.sysvarManager.setVar(a,function(c){b&&b({error:c})})};e.prototype.delVar=function(a,b){this.sysvarManager.delVar(a,function(c){b&&b({error:c})})};
e.prototype.getSysvarStates=function(a){var b=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(b));a&&a({data:b})};e.prototype.processSysvarST=function(a,b,c){var f=this;f._logger.log("trace","process st sysvars:"+JSON.stringify(b));for(var m=function(h,d,g){if(h&&d&&0!=d.length){var k=0,l=function(t){k++;t?g&&g(t):k==d.length?g&&g():r(h,d[k],l)};r(h,d[k],l)}else g&&g()},r=function(h,d,g){if(h&&d&&d.id){f._logger.log("trace","delete st sysvar "+
JSON.stringify(d));var k=g;g="/cmd?XC_FNC=delVar&id="+d.id;var l=setTimeout(function(){console.log("delete st sysvar "+d.id+" timeout");k&&k(Error("st timeout"));k=null},1E4);h._doSTMCommandRequest(g,!1,function(t){l&&(clearTimeout(l),l=null);f._logger.log("trace","delete st sysvar "+d.id+" return",t);k&&k();k=null})}else g&&g()},p=[],q=[],v=[],u=0;u<b.length;u++){var n=b[u];if(n)switch(n.type){case "ONOFF":case "FLOAT":case "INT":case "STRING":var w={id:n.adr,type:n.type,value:n.state};p.push(w);
this.sysvarManager.getVar(n.adr)||q.push(w);break;default:v.push(n)}}f._logger.log("trace","find st sysvars:"+JSON.stringify(p));f._logger.log("trace","find new sysvars:"+JSON.stringify(q));(function(h,d){if(h&&0!=h.length){var g=0,k=function(l){f._logger.log("trace","add new sysvar "+JSON.stringify(h[g])+":"+l);g++;l?d&&d(l):g==h.length?d&&d():f.sysvarManager.setVar(h[g],k)};f.sysvarManager.setVar(h[g],k)}else d&&d()})(q,function(h){h?c&&c({error:h}):(m(a,p),f.getSysvarStates(function(d){d&&d.error||
(d.data||(d.data=[]),d.data=d.data.concat(v));c&&c(d)}))})};return e}();module.exports=new x.hub.sysvarman.Handler;
