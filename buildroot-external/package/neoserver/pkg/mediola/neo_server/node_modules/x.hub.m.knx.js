var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var a=0;return function(){return a<e.length?{done:!1,value:e[a++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,a,b){if(e==Array.prototype||e==Object.prototype)return e;e[a]=b.value;return e};$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<e.length;++a){var b=e[a];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,a){var b=$jscomp.propertyToPolyfillSymbol[a];if(null==b)return e[a];b=e[b];return void 0!==b?b:e[a]};
$jscomp.polyfill=function(e,a,b,c){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,a,b,c):$jscomp.polyfillUnisolated(e,a,b,c))};$jscomp.polyfillUnisolated=function(e,a,b,c){b=$jscomp.global;e=e.split(".");for(c=0;c<e.length-1;c++){var d=e[c];if(!(d in b))return;b=b[d]}e=e[e.length-1];c=b[e];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(e,a,b,c){var d=e.split(".");e=1===d.length;c=d[0];c=!e&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<d.length-1;f++){var g=d[f];if(!(g in c))return;c=c[g]}d=d[d.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?c[d]:null;a=a(b);null!=a&&(e?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:a}):a!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+b+"$"+d),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:a})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(e){if(e)return e;var a=function(f,g){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",c=0,d=function(f){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new a(b+(f||"")+"_"+c++,f)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<a.length;b++){var c=$jscomp.global[a[b]];"function"===typeof c&&"function"!=typeof c.prototype[e]&&$jscomp.defineProperty(c.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return e},"es6",
"es3");$jscomp.iteratorPrototype=function(e){e={next:e};e[Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,a){e instanceof String&&(e+="");var b=0,c=!1,d={next:function(){if(!c&&b<e.length){var f=b++;return{value:a(f,e[f]),done:!1}}c=!0;return{done:!0,value:void 0}}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var util=require("util"),EventEmitter=require("events"),crypto=require("crypto"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.knx=x.hub.m.knx||{};
x.hub.m.knx.KNXIPGateway=function(){var e=function(a,b,c,d){this._gid=a;this._ip=b;this._port=c;this._port||(this.port=3671);this._mac=d;this._serial_number=this._physical_address=this._name=null};e.prototype.getID=function(){return this._gid};e.prototype.getIP=function(){return this._ip};e.prototype.getPort=function(){return this._port};e.prototype.getMAC=function(){return this._mac};e.prototype.toJSON=function(){return{gid:this._gid,ip:this._ip,port:this._port,mac:this._mac,name:this._name,physical_address:this._physical_address,
serial_number:this._serial_number}};e.prototype.fromJSON=function(a){this._gid=a.gid;this._ip=a.ip;this._port=a.port;this._port||(this.port=3671);this._mac=a.mac;this._name=a.name;this._physical_address=a.physical_address;this._serial_number=a.serial_number};e.prototype.updateJSON=function(a){a&&a.ip&&(this._ip=a.ip,this._port=a.port,this._port||(this.port=3671),this._mac=a.mac,this._name=a.name,this._physical_address=a.physical_address,this._serial_number=a.serial_number)};e.fromJSON=function(a){if(!a||
!a.gid||!a.ip)return null;var b=new e;b.fromJSON(a);return b};return e}();
x.hub.m.knx.KNXIPDevice=function(){var e=function(a,b,c,d){this._did=a;this._type=b;this._gid=c;this._name=null;this._channels=d};e.prototype.getID=function(){return this._did};e.prototype.getGID=function(){return this._gid};e.prototype.getChannels=function(){return this._channels};e.prototype.toJSON=function(){var a={};a.did=this._did;a.data=this._type;a.gid=this._gid;a.name=this._name;a.channels=this._channels;return a};e.prototype.fromJSON=function(a){this._did=a.did;this._type=a.data;this._name=
a.name;this._gid=a.gid;this._channels=a.channels};e.prototype.updateJSON=function(a){a&&a.data&&(this._type=a.data,this._name=a.name,this._gid=a.gid,this._channels=a.channels)};e.fromJSON=function(a){if(!(a&&a.data&&a.did&&a.gid))return null;var b=new e;b.fromJSON(a);return b};return e}();
x.hub.m.knx.DeviceHandler=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.DeviceHandler");this._controller=a;this._gateways=[];this._devices=[]};e.prototype.IP_GATEWAY_FILE="knx_gateway.json";e.prototype.DEVICE_FILE="knx_device.json";e.prototype.init=function(a){this._logger.log("trace","init");var b=this,c=2;this._loadGateways(function(d,f){c--;d&&b._logger.log("warn","load knx ip gateways error:"+d.message);f&&(b._gateways=f);0==c&&a&&a()});this._loadDevices(function(d,
f){c--;d&&b._logger.log("warn","load knx devices error:"+d.message);f&&(b._devices=f);0==c&&a&&a()})};e.prototype.getIPGatewayObjs=function(){return this._gateways};e.prototype.getIPGatewayObj=function(a){for(var b=0;b<this._gateways.length;b++){var c=this._gateways[b];if(a==c.getID())return c}return null};e.prototype.getIPGateways=function(a){var b=[];this._gateways.forEach(function(c){c&&(c=c.toJSON())&&b.push(c)});a&&a(null,b)};e.prototype.addIPGateway=function(a,b){if(a&&a.ip){for(var c=[],d=
0;d<this._gateways.length;d++){var f=this._gateways[d];if(f){var g=f.getID(),k=f.getIP(),h=f.getMAC();c.push(g);if(k==a.ip){a=Error("find knx ip gateway with same ip");a.code="09002";b&&b(null,f.toJSON());return}if(h&&a.mac&&h==a.mac){a=Error("find knx ip gateway with mac address");a.code="09003";b&&b(a);return}}}for(f=1;-1!=c.indexOf(f);)f++;a.gid=f;var l=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(l){this._gateways.push(l);var n=this;this._saveGateways(this._gateways,function(m){m?(m.code="09006",b&&
b(m)):n._controller._monitorManager.startMonitor(l,function(){b&&b(null,l.toJSON())})})}else a=Error("json format invalid"),a.code="09001",b&&b(a)}else a=Error("json format invalid"),a.code="09001",b&&b(a)};e.prototype.updateIPGateway=function(a,b){var c=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(c){var d=null;this._gateways.forEach(function(l){l&&l.getID()==c.getID()&&(d=l)});if(d){var f=d.getIP(),g=d.getPort();d.updateJSON(a)}else this._gateways.push(c);var k=this;this._saveGateways(this._gateways,
function(l){l?(l.code="09006",b&&b(l)):f!=a.ip||g!=a.port?k._controller._monitorManager.stopMonitor(d,function(){k._controller._monitorManager.startMonitor(d,function(){b&&b(null,d.toJSON())})}):b&&b(null,d.toJSON())})}else{var h=Error("json format invalid");h.code="09001";b&&b(h)}};e.prototype.deleteIPGateway=function(a,b){if(a&&a.gid){for(var c=-1,d=null,f=0;f<this._gateways.length;f++){var g=this._gateways[f];if(g&&g.getID()==a.gid){c=f;d=g;break}}if(-1==c)b&&b();else{this._gateways.splice(c,1);
var k=this;this._saveGateways(this._gateways,function(h){h?(h.code="09006",b&&b(h)):k._controller._monitorManager.stopMonitor(d,function(){b&&b()})})}}else a=Error("json format invalid"),a.code="09001",b&&b(a)};e.prototype.deleteAllIPGateway=function(a){this._gateways=[];var b=this;this._saveGateways(this._gateways,function(c){c?(c.code="09006",a&&a(c)):b._controller._monitorManager.stopAllMonitors(function(){a&&a()})})};e.prototype.getAllDevices=function(){return this._devices};e.prototype.getDevices=
function(a){var b=[];this._devices.forEach(function(c){c&&(c=c.toJSON())&&b.push(c)});a&&a(null,b)};e.prototype.addDevice=function(a,b){if(a)if(a.gid)if(this.getIPGatewayObj(a.gid)){var c=[];this._devices.forEach(function(g){g&&(g=g.getID(),c.push(g))});for(var d=1;-1!=c.indexOf(d);)d++;a.did=d;var f=x.hub.m.knx.KNXIPDevice.fromJSON(a);f?(this._devices.push(f),this._saveDevices(this._devices,function(g){g&&(g.code="09007");b&&b(g,f.toJSON())})):(a=Error("json format invalid"),a.code="09001",b&&b(a))}else a=
Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("json format invalid"),a.code="09001",b&&b(a)};e.prototype.updateDevice=function(a,b){var c=x.hub.m.knx.KNXIPDevice.fromJSON(a);if(c)if(a.gid)if(this.getIPGatewayObj(a.gid)){var d=null;this._devices.forEach(function(f){f&&f.getID()==c.getID()&&(d=f)});d?d.updateJSON(a):this._devices.push(c);this._saveDevices(this._devices,function(f){f&&(f.code=
"09007");b&&b(f,d.toJSON())})}else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("json format invalid"),a.code="09001",b&&b(a)};e.prototype.deleteDevice=function(a,b){if(a&&a.did){for(var c=-1,d=null,f=0;f<this._devices.length;f++)if((d=this._devices[f])&&d.getID()==a.did){c=f;break}-1==c?b&&b():(this._devices.splice(c,1),this._saveDevices(this._devices,function(g){g&&(g.code="09007");
b&&b(g)}))}else a=Error("json format invalid"),a.code="09001",b&&b(a)};e.prototype.deleteAllDevice=function(a){this._devices=[];this._saveDevices(this._devices,function(b){b&&(b.code="09007");a&&a(b)})};e.prototype.getDeviceObj=function(a){if(!this._devices)return null;for(var b=0;b<this._devices.length;b++){var c=this._devices[b];if(c&&c.getID()==a)return c}return null};e.prototype._getGatewayFile=function(){var a=fileman.fileManager,b=require("path");a=a.getUserRootDataPath();return b.resolve(a,
this.IP_GATEWAY_FILE)};e.prototype._getDeviceFile=function(){var a=fileman.fileManager,b=require("path");a=a.getUserRootDataPath();return b.resolve(a,this.DEVICE_FILE)};e.prototype._loadGateways=function(a){var b=require("fs-extra"),c=this._getGatewayFile();b.ensureFile(c,function(d){d?a&&a(d):b.readFile(c,"utf8",function(f,g){if(f)a&&a(f);else if(g)try{var k=[];JSON.parse(g).forEach(function(h){(h=x.hub.m.knx.KNXIPGateway.fromJSON(h))&&k.push(h)});a&&a(null,k)}catch(h){a&&a(h)}else a&&a(null,[])})})};
e.prototype._saveGateways=function(a,b){var c=this._getGatewayFile(),d=[];a&&a.forEach(function(f){(f=f.toJSON())&&d.push(f)});fs_extra.writeFile(c,JSON.stringify(d,null,2),function(f){b&&b(f)})};e.prototype._loadDevices=function(a){var b=require("fs-extra"),c=this._getDeviceFile();b.ensureFile(c,function(d){d?a&&a(d):b.readFile(c,"utf8",function(f,g){if(f)a&&a(f);else if(g)try{var k=[];JSON.parse(g).forEach(function(h){(h=x.hub.m.knx.KNXIPDevice.fromJSON(h))&&k.push(h)});a&&a(null,k)}catch(h){a&&
a(h)}else a&&a(null,[])})})};e.prototype._saveDevices=function(a,b){var c=this._getDeviceFile(),d=[];a&&a.forEach(function(f){(f=f.toJSON())&&d.push(f)});fs_extra.writeFile(c,JSON.stringify(d,null,2),function(f){b&&b(f)})};return e}();
x.hub.m.knx.Monitor=function(){var e=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Monitor");this._ip=a;this._port=b;this._manager=null;this._gateways=[];this._knx=null;this._monitorState=0;this._monitorError=this._reconnTO=null;this._forceStopped=!1};e.prototype.getIP=function(){return this._ip};e.prototype.getPort=function(){return this._port};e.prototype.getKNXSession=function(){return this._knx};e.prototype.setManager=function(a){this._manager=a};e.prototype.addGateway=
function(a){if(a){for(var b=a.getID(),c=!1,d=0;d<this._gateways.length;d++){var f=this._gateways[d];if(f&&f.getID()==b){c=!0;break}}c||this._gateways.push(a)}};e.prototype.hasGateway=function(a){if(!a)return!1;a=a.getID();for(var b=!1,c=0;c<this._gateways.length;c++){var d=this._gateways[c];if(d&&d.getID()==a){b=!0;break}}return b};e.prototype.getGateways=function(){return this._gateways};e.prototype.getGatewayWithMac=function(a){if(!a)return null;for(var b=0;b<this._gateways.length;b++){var c=this._gateways[b];
if(c&&c.getMAC()==a)return c}return null};e.prototype.start=function(a){this._forceStopped=!1;if(0!=this._monitorState&&4!=this._monitorState)a&&a(Error("monitor already started"));else{this._logger.log("debug","start monitor: "+this._ip+":"+this._port);var b=this;this._knx=new (require("xnm.aio.knx.js").KNXGateway)(this._ip,null,null);this._knx.on("message",function(c,d,f){var g=f.getData();b._logger.log("debug","receive monitor message:"+g.toString("hex")+"@"+d);var k=require("x.hub.m.knx.js");
b._gateways.forEach(function(h){if(h&&h.getID())k.onMonitorMessage(h.getID(),d,g)})});this._knx.on("error",function(c){b._monitorError=c;b._logger.log("warn","monitor error:"+c.message+" + code:"+(c.code?c.code:""))});this._knx.on("close",function(){b._logger.log("warn","monitor closed");b._restart()});this._monitorState=1;this._knx.startMonitor(function(){b._monitorState=2;a&&a()})}};e.prototype.stop=function(a){this._forceStopped=!0;if(0==this._monitorState||3==this._monitorState)a&&a();else if(this._monitorState=
3,this._logger.log("debug","stop monitor: "+this._ip+":"+this._port),this._knx){var b=this;this._knx.stopMonitor(function(){b._monitorState=0;b._knx.removeAllListeners();b._knx=null;a&&a()})}else a&&a()};e.prototype.stopForGateway=function(a,b){this._logger.log("debug","stop monitor for gateway: "+a.getID());for(var c=-1,d=0;d<this._gateways.length;d++){var f=this._gateways[d];f&&f.getID()==a.getID()&&(c=d)}-1!=c&&this._gateways.splice(c,1);0==this._gateways.length?this.stop(function(){b&&b(null,
!0)}):b&&b(null,!1)};e.prototype.getState=function(){return{state:this._monitorState,error:this._monitorError}};e.prototype._restart=function(){if(0==this._gateways.length)this._monitorState=0;else if(4!=this._monitorState&&!this._forceStopped){this._logger.log("debug","try to restart monitor after 30sec");var a=this;this._monitorState=4;this._reconnTO=setTimeout(function(){a.start()},3E4)}};return e}();
x.hub.m.knx.MonitorManager=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.MonitorManager");this._controller=a;this._monitors={}};e.prototype.init=function(a){var b=this;if(this._controller&&this._controller._deviceHandler){var c=this._controller._deviceHandler.getIPGatewayObjs(),d=0,f=function(){d++;d<c.length&&b.startMonitor(c[d],f)};this.startMonitor(c[d],f)}a&&a()};e.prototype.startMonitor=function(a,b){if(a){var c=a.getIP(),d=a.getPort();this._startMonitor(c,
d,a,b)}else b&&b(Error("gateway is null"))};e.prototype._startMonitor=function(a,b,c,d){if(c){this._logger.log("info","start connect monitor to gateway "+c.getID()+" ("+a+":"+b+")");var f=b+"@"+a,g=this._monitors[f];g?(g.addGateway(c),d&&d()):(g=new x.hub.m.knx.Monitor(a,b),g.addGateway(c),g.setManager(this),this._monitors[f]=g,g.start(d))}else d&&d(Error("gateway is null"))};e.prototype.stopMonitor=function(a,b){var c=null,d=null,f;for(f in this._monitors){var g=this._monitors[f];if(g&&g.hasGateway(a)){c=
g;d=f;break}}if(c){var k=this;c.stopForGateway(a,function(h,l){l&&(k._logger.log("debug","monitor "+d+" stopped"),delete k._monitors[d]);b&&b(h)})}else b&&b()};e.prototype.stopAllMonitors=function(a){var b=Object.keys(this._monitors);if(0==b.length)a&&a();else{var c=0,d=this._monitors;this._monitors={};var f=function(){c++;c>=b.length?a&&a():d[b[c]].stop(f)};d[b[c]].stop(f)}};e.prototype.onFindKNX=function(a){if(a){var b=a.getIP(),c=a.getPort();a=a.getMAC();var d=c+"@"+b,f=null,g=null,k;for(k in this._monitors){var h=
this._monitors[k].getGatewayWithMac(a);if(h){f=h;g=k;break}}if(f&&g!=d){var l=this;this.stopMonitor(f,function(){l._startMonitor(b,c,f)})}}};e.prototype.listMonitors=function(a){var b=[],c;for(c in this._monitors)this._monitors.hasOwnProperty(c)&&b.push(this._monitors[c]);a&&a(null,b)};e.prototype.getMonitorForGateway=function(a){for(var b in this._monitors)if(this._monitors.hasOwnProperty(b)){var c=this._monitors[b];if(c&&c.hasGateway(a))return c}return null};return e}();
x.hub.m.knx.SearchHandler=function(){var e=require("xnm.aio.knx.js").Finder,a=function(b){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.SearchHandler");this._controller=b;var c=this;this._searchListener=function(d,f){c._onFindKNX(d,f)};this._errorListener=function(d){c._onKNXFinderError(d)};this._searching=!1;this._searchCB=[];this._searchResult=[];this._nextSearchTO=this._searchTO=null};a.SEARCH_INTERVAL=3E5;a.prototype.init=function(b){e.on("found",this._searchListener);e.on("error",
this._errorListener);this._search();b&&b()};a.prototype._onFindKNX=function(b,c){b=b.toJSON();this._logger.log("info","find knx ip gateway:"+JSON.stringify(b));if(b.hapi&&b.hapi.ip&&b.mac){var d={ip:b.hapi.ip,port:b.hapi.port,mac:b.mac,name:b.name.replace(/\0/g,""),physical_address:b.physical_address,serial_number:b.serial_number};b=new x.hub.m.knx.KNXIPGateway;b.fromJSON(d);d=!1;for(var f=0;f<this._searchResult.length;f++){var g=this._searchResult[f];g&&g.getIP()==b.getIP()&&g.getPort()==b.getPort()&&
(d=!0)}d||this._searchResult.push(b);if(this._controller&&this._controller._monitorManager)this._controller._monitorManager.onFindKNX(b,c)}};a.prototype._onKNXFinderError=function(b){this._logger.log("debug","knx finder error:"+b.message);e.stopSearchKNX();this._search()};a.prototype.search=function(b){b&&-1==this._searchCB.indexOf(b)&&this._searchCB.push(b);this._searching||this._search()};a.prototype._search=function(){this._logger.log("debug","start search knx ip gateway");this._searching=!0;this._nextSearchTO&&
(this._logger.log("trace","clear next automatic search"),clearTimeout(this._nextSearchTO),this._nextSearchTO=null);var b=this;e.startSearchKNX();this._searchTO=setTimeout(function(){b._logger.log("trace","finish searching knx ip gateway");e.stopSearchKNX();b._searching=!1;b._searchTO=null;var c=b._searchCB;b._searchCB=[];var d=b._searchResult;b._searchResult=[];b._nextSearchTO=setTimeout(function(){b._nextSearchTO=null;b._logger.log("trace","start next automatic search");b._search()},a.SEARCH_INTERVAL);
c.forEach(function(f){f&&f(null,d)})},3E3)};return a}();
x.hub.m.knx.Handler=function(){var e={sendSTAEvent:function(b){var c=require("x.hub.eventbus.js");c.emit("gatewayevent",b,{address:"KNX"},"STA");c.emit("udpevent",b,"STA")}},a=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Handler");this._deviceHandler=new this.DeviceHandler(this);this._monitorManager=new this.MonitorManager(this);this._searchHandler=new this.SearchHandler(this)};a.prototype.DeviceHandler=x.hub.m.knx.DeviceHandler;a.prototype.MonitorManager=x.hub.m.knx.MonitorManager;
a.prototype.SearchHandler=x.hub.m.knx.SearchHandler;a.prototype.init=function(b){var c=this;this._deviceHandler.init(function(){c._monitorManager.init(function(){c._searchHandler.init(function(){b&&b({})})})})};a.prototype.getSystems=function(){return["knx"]};a.prototype.addStateDevice=function(b,c){c&&c({})};a.prototype.getAllStates=function(){var b=null,c=this;this._deviceHandler.getAllDevices().forEach(function(d){var f=c.getStates(d);f&&(b||(b={}),b[d.getID()]=f)});return b};a.prototype.getStates=
function(b){return b&&b.getID()?this._getStates(b.getID()):null};a.prototype._getStates=function(b){b=this._deviceHandler.getDeviceObj(b);if(!b)return null;var c=b.getGID();if(!c)return null;c=this._deviceHandler.getIPGatewayObj(c);if(!c)return null;c=this._monitorManager.getMonitorForGateway(c);if(!c)return null;c=c.getKNXSession();return c?(b=require("xnm.aio.knx.js").KNXGateway._Device.resolve(b.toJSON()))?b.getStates(c):null:null};a.prototype.executeCommand=function(b,c,d){d&&d({error:Error("not implemented yet")})};
a.prototype._executeCommand=function(b,c,d){var f=this._deviceHandler.getDeviceObj(b);if(f){var g=f.getGID();if(g)if(b=this._deviceHandler.getIPGatewayObj(g))if(b=this._monitorManager.getMonitorForGateway(b)){var k=b.getState().state;2!=k?d&&d(Error("monitor for gateway "+g+" is in state:"+k)):(b=b.getKNXSession())?(f=require("xnm.aio.knx.js").KNXGateway._Device.resolve(f.toJSON()))?f.executeCommand(c,b,function(h){d&&d(h)}):d&&d(Error("device format invalid")):d&&d(Error("knx session for gateway "+
g+" is null"))}else d&&d(Error("no monitor for gateway with id:"+g));else d&&d(Error("no such gateway with id:"+g));else d&&d(Error("device "+b+" has no gid"))}else d&&d(Error("no such device with id:"+b))};a.prototype.executeCommandLegacy=function(b,c,d){b?c?this._executeCommand(b,c,function(f){d&&d({error:f})}):d&&d({error:Error("command invalid")}):d&&d({error:Error("address invalid")})};a.prototype.getAllStatesLegacy=function(b,c){c=[];try{var d=this.getAllStates(),f;for(f in d)d.hasOwnProperty(f)&&
c.push({type:"KNX",adr:f,state:d[f]});b&&b({data:c})}catch(g){b&&b({error:g})}};a.prototype.getIPGateways=function(b){this._deviceHandler.getIPGateways(function(c,d){b&&b({error:c,data:d})})};a.prototype.addIPGateway=function(b,c){this._deviceHandler.addIPGateway(b,function(d,f){c&&c({error:d,data:f})})};a.prototype.updateIPGateway=function(b,c){this._deviceHandler.updateIPGateway(b,function(d,f){c&&c({error:d,data:f})})};a.prototype.deleteIPGateway=function(b,c){this._deviceHandler.deleteIPGateway(b,
function(d){c&&c({error:d})})};a.prototype.getDevices=function(b){this._deviceHandler.getDevices(function(c,d){b&&b({error:c,data:d})})};a.prototype.addDevice=function(b,c){this._deviceHandler.addDevice(b,function(d,f){c&&c({error:d,data:f})})};a.prototype.updateDevice=function(b,c){this._deviceHandler.updateDevice(b,function(d,f){c&&c({error:d,data:f})})};a.prototype.deleteDevice=function(b,c){this._deviceHandler.deleteDevice(b,function(d){c&&c({error:d})})};a.prototype.clean=function(b){this._monitorManager.stopAllMonitors(b)};
a.prototype.listMonitors=function(b){this._monitorManager.listMonitors(function(c,d){if(c)b&&b({error:c});else{var f=[];d.forEach(function(g){if(g){var k=g.getGateways();k&&k.forEach(function(h){if(h){var l=g.getState();h={gateway:h.getID(),monitor:{ip:g.getIP(),port:g.getPort()},state:l.state,error:l.error?l.error.message:null};f.push(h)}})}});b&&b({data:f})}})};a.prototype.reset=function(b){var c=this;this._deviceHandler.deleteAllDevice(function(){c._deviceHandler.deleteAllIPGateway(function(){b&&
b({})})})};a.prototype.searchKNXGateway=function(b){this._searchHandler.search(function(c,d){if(c)b&&b({error:c});else{var f=[];d&&d.forEach(function(g){g&&(g=g.toJSON())&&f.push(g)});b&&b({data:f})}})};a.prototype.onMonitorMessage=function(b,c,d){var f=this._deviceHandler.getAllDevices(),g=require("xnm.aio.knx.js").KNXGateway;require("x.hub.eventbus.js");var k=this;f.forEach(function(h){if(h&&h.getGID()==b){var l=h.getChannels();if(l){var n=!1,m;for(m in l)if(l.hasOwnProperty(m)){var p=l[m];if(p&&
p.event&&p.event.ga&&g._adr2long(p.event.ga)==c){n=!0;break}}n&&(l=k.getStates(h),k._logger.log("info","receive event ("+d.toString("hex")+"@"+c+") for device "+h.getID()+":"+JSON.stringify(l)),h={type:"KNX",adr:h.getID(),state:l},e.sendSTAEvent(h))}}})};return a}();module.exports=new x.hub.m.knx.Handler;
