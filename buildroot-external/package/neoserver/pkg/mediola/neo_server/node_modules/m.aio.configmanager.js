var m=m||{};m.aio=m.aio||{};m.aio.configmanager=m.aio.configmanager||{};m.aio.configmanager.Path=function(){this._routes=[]};m.aio.configmanager.Path.prototype.isEmpty=function(){return 0===this._routes.length};m.aio.configmanager.Path.prototype.pop=function(){return 0===this._routes.length?null:this._routes.splice(0,1)[0]};
m.aio.configmanager.Path.resolve=function(a){if(!a)return null;var b=new m.aio.configmanager.Path;a=a.split("/");for(var c=0;c<a.length;c++)if(0===a[c].length){if(0!==c&&c!==a.length-1)return null}else b._routes.push(a[c]);return b};m.aio.configmanager.Path.trace=function(a,b){for(var c=null,d;null!==(d=b.pop());)if(a=a.getChild(d))c=a;else return null;return c};m.aio.configmanager.Node=function(a){this.index=-1;this.classid="";this.parent=a};
m.aio.configmanager.Node.prototype.getChild=function(a){return a&&"string"===typeof a?this[a]:null};m.aio.configmanager.ListNode=function(a){m.aio.configmanager.Node.call(this,a);this.children=[]};m.aio.configmanager.ListNode.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.ListNode.prototype.constructor=m.aio.configmanager.ListNode;m.aio.configmanager.ListNode.prototype.size=function(){return this.children.length};m.aio.configmanager.ListNode.prototype.get=function(a){return this.children[a]};
m.aio.configmanager.License=function(a){m.aio.configmanager.Node.call(this,a);this.type=this.licenseTxt=this.id=this.parent=null;this.duration=0;this.valid=!1;this.version=0;this.features=null};m.aio.configmanager.License.TYPE={NORMAL:"normal",TEST:"test"};m.aio.configmanager.License.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.License.prototype.constructor=m.aio.configmanager.License;
m.aio.configmanager.License.prototype.getDaysLeft=function(){if(this.type!=m.aio.configmanager.License.TYPE.TEST||!this.licenseTxt||!m.aio.configmanager.CM.filemanager)return 0;if(1==this.version&&0==this.id)return-1;var a=m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt);if(!a)return-1;a=new Date(parseInt(a));a=Math.floor(((new Date).getTime()-a.getTime())/1E3/60/60/24);return 0>=7*this.duration-a?0:7*this.duration-a};
m.aio.configmanager.License.prototype.saveStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM){var a=m.aio.configmanager.CM.filemanager.Preference;if(!a.read(this.licenseTxt)){var b=(new Date).getTime();a.save(this.licenseTxt,b.toString())}}};m.aio.configmanager.License.prototype.getStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM)return m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt)};
m.aio.configmanager.License.prototype.saveStartDateWithDate=function(a){m.aio.configmanager.CM.filemanager.Preference.save(this.licenseTxt,a)};m.aio.configmanager.License.prototype.isTestLicense=function(){return this.type==m.aio.configmanager.License.TYPE.TEST};m.aio.configmanager.License.prototype.isExpired=function(){return this.type==m.aio.configmanager.License.TYPE.TEST&&0==this.getDaysLeft()?!0:!1};m.aio.configmanager.License.prototype.getFeatureModules=function(){return require("m.aio.infomanager.js").getFeatureModules(this)};
m.aio.configmanager.License.prototype.getFeatureModulesSUS=function(){return require("m.aio.infomanager.js").getFeatureModulesSUS(this)};m.aio.configmanager.License.prototype.getSUSFlatrate=function(){return require("m.aio.infomanager.js").getSUSFlatrate(this)};m.aio.configmanager.License.prototype.isUltimateTestLicense=function(){return this.isTestLicense()?1==this.version&&0==this.id:!1};
m.aio.configmanager.License.prototype.isPartnerUltimateLicense=function(){return this.isTestLicense()||2!=this.version||!this.features?!1:this.features.readUInt8(0)>>7&1};
m.aio.configmanager.LicenseManager={BLOCKED:[],UUENCODE_MAP:"MXBPWG7QJD6K3R4S2U98ETFH51AZNCYV",resolve:function(a){if(!a)return null;a=a.toUpperCase();var b=new m.aio.configmanager.License;b.licenseTxt=a;var c=a.replace(/-/g,"");if(20!=c.length)return b.valid=!1,b;c=this._uudecode(c);if(!c)return b.valid=!1,b;c=this._decrypt(c);if(!c)return b.valid=!1,b;if(c=this._resolve(c))return this._isBlocked(c)&&(c.valid=!1),c.licenseTxt=a,c;b.valid=!1;return b},_isBlocked:function(a){if(require("m.aio.infomanager.js").isLicenseBlocked(a))return!0;
if(0!=a.version)return!1;var b=m.aio.configmanager.CM.filemanager.getPref().read("blockedid");b||(b=this.BLOCKED);b.length<this.BLOCKED.length&&(b=this.BLOCKED);for(var c=0;c<b.length;c++)if(a.id==b[c])return!0;return!1},_uudecode:function(a){var b=require("big-integer")(0),c;for(c=0;20>c;c++){var d=this.UUENCODE_MAP.indexOf(a.charAt(c));if(-1==d)return null;b=b.shiftLeft(5).add(d)}return b},_decrypt:function(a){var b=require("big-integer");if(15!=a.and(15).toJSNumber())return null;a=a.shiftRight(4);
var c=b("43138825561077299640793988347");b=b("23300244857271456227675018177");b=a.modPow(b,c);return 7!=b.shiftRight(92).toJSNumber()?null:b},_resolve:function(a){var b=new m.aio.configmanager.License;a=a.toString(16);0!=a.length%2&&(a="0"+a);a=new Buffer(a,"hex");b.version=a.readUInt8(0)&15;var c=a.readUInt8(1);b.type=c>>7?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL;switch(b.type){case m.aio.configmanager.License.TYPE.TEST:b.duration=c>>4&7;b.id=(a.readUInt8(1)<<
16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&1048575;break;case m.aio.configmanager.License.TYPE.NORMAL:b.id=(a.readUInt8(1)<<16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&8388607}b.features=a.slice(4);"test"==b.type&&1==b.id&&(a=b.features.readUInt8(7),a|=192,c=b.features.readUInt8(6),c|=63,b.features.writeUInt8(a,7),b.features.writeUInt8(c,6));b.valid=!0;return b},permit:function(a,b){return b?b instanceof m.aio.configmanager.Config||b instanceof m.aio.configmanager.Tenants||b instanceof m.aio.configmanager.Tenant||
b instanceof m.aio.configmanager.License&&b.parent?!0:(a=this._getTenant(b))&&a.license&&a.license.valid?!(a.license.isTestLicense()&&a.license.isExpired()):!1:!1},permitFeature:function(a,b,c,d,e,f){return"delete"==a?!0:require("m.aio.infomanager.js").permitFeature(a,b,c,d,e,f)},_getTenant:function(a){for(;a;){if(a instanceof m.aio.configmanager.Tenant)return a;a=a.parent}return null}};
m.aio.configmanager.LicenseHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.LicenseJSONHandler.toJSON(a));break;case "update":if(!a){d&&d(Error("license is null"));break}if(!c){d&&d(Error("data is null"));break}if(!a.parent){d&&d(Error("license is isolated"));break}b=m.aio.configmanager.TenantJSONHandler.toJSON(a.parent);b.license=c;m.aio.configmanager.TenantHandler.execute(a.parent,"update",b,function(e,f){e?d&&d(e):d&&d(null,f.license)});break;default:d(Error("no such method"))}}};
m.aio.configmanager.LicenseJSONHandler={fromJSON:function(a){return a&&a.classid&&"license"===a.classid&&a.license?m.aio.configmanager.LicenseManager.resolve(a.license):null},toJSON:function(a){a={classid:"license",license:a.licenseTxt,partner_ultimate:a.isPartnerUltimateLicense(),type:a.type,duration:a.duration,valid:a.valid,daysLeft:a.getDaysLeft(),features:a.getFeatureModules(),features_sus:a.getFeatureModulesSUS(),features_sus_flatrate:a.getSUSFlatrate()};-1==a.daysLeft&&delete a.daysLeft;return a}};
m.aio.configmanager.Config=function(a){m.aio.configmanager.Node.call(this,null);this.folder=a;this.tenants=new m.aio.configmanager.Tenants(this)};m.aio.configmanager.Config.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Config.prototype.constructor=m.aio.configmanager.Config;m.aio.configmanager.Config.SETTING="settings";m.aio.configmanager.Config.prototype.getFolderPath=function(){return this.folder};
m.aio.configmanager.ConfigHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.ConfigJSONHandler.toJSON(a));break;default:d(Error("no such method"))}}};m.aio.configmanager.ConfigJSONHandler={toJSON:function(a){return a?{classid:"config",tenants:a.tenants?m.aio.configmanager.TenantsJSONHandler.toJSON(a.tenants):null}:null}};
m.aio.configmanager.ConfigPersistHandler={save:function(a,b){var c=a.getFolderPath();if(c){a=require("async");var d=require("fs");a.series([function(e){d.exists(c,function(f){f?d.stat(c,function(g,l){g?e(g):l.isDirectory()?e():e(Error(c+" is not a folder"))}):require("fs-extra").mkdirs(c,function(g){e(g)})})},function(e){var f=require("path");d.writeFile(c+f.sep+m.aio.configmanager.Config.SETTING,JSON.stringify({}),function(g){e(g)})}],function(e){b(e)})}else b(Error("folder of the config is invalid"))},
load:function(a,b){var c=new m.aio.configmanager.Config,d=require("path");this._loadSettings(a+d.sep+m.aio.configmanager.Config.SETTING,function(e){e?b(e):(c.folder=a,m.aio.configmanager.TenantsPersistHandler.load(c,a,function(f,g){f?b(f):(g.parent=c,c.tenants=g,b(null,c))}))})},_loadSettings:function(a,b){var c=require("fs");c.exists(a,function(d){d?c.readFile(a,function(e,f){if(e)b(e);else{e={};if(0<f.length)try{e=JSON.parse(f.toString())}catch(g){b(null,{});return}b(null,e)}}):b(null,{})})}};
m.aio.configmanager.Tenants=function(a){m.aio.configmanager.ListNode.call(this,a);this.children=[]};m.aio.configmanager.Tenants.prototype=Object.create(m.aio.configmanager.ListNode.prototype);m.aio.configmanager.Tenants.prototype.constructor=m.aio.configmanager.Tenants;
m.aio.configmanager.Tenants.prototype.decideOnDefault=function(a){for(var b=!1,c=[],d=0;d<this.children.length;d++){var e=this.children[d];e.default&&(e.license?b=!0:c.push(e))}if(b&&0<c.length){var f=this,g=function(l){if(l>=c.length)a();else{var k=c[l];k.default=!1;m.aio.configmanager.TenantPersistHandler.save(f,k,function(h){g(l+1)})}};g(0)}else a()};m.aio.configmanager.Tenants.prototype.getFolderPath=function(){return this.parent?this.parent.getFolderPath():null};
m.aio.configmanager.Tenants.prototype.getChildren=function(){return this.children};m.aio.configmanager.Tenants.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};m.aio.configmanager.Tenants.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};
m.aio.configmanager.Tenants.prototype.sort=function(){var a=this.children.length-1;do{var b=!1;for(var c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0)}while(b)};
m.aio.configmanager.TenantsHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.TenantsJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.TenantJSONHandler.fromJSON(c))?this._add(a,b,function(e,f){e?d(e):(f&&f.license&&!f.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),d(null,m.aio.configmanager.TenantJSONHandler.toJSON(f)))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_add:function(a,b,c){var d=
this;require("async").waterfall([function(e){d._preAddNode(a,b,e)},function(e,f){d._addNode(a,e,f)},function(e,f){d._postAddNode(a,e,f)}],function(e,f){c(e,f)})},_preAddNode:function(a,b,c){var d=1;if(b.name)if(b.license)if(b.license.valid)if(b.license.isTestLicense()&&b.license.isExpired())c(Error("test license is expired"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("tenant with same id exists","configmanager.js"));return}if(f.name==b.name){c(Error("remote with same name exists",
"configmanager.js"));return}if(f.license&&b.license&&f.license.licenseTxt&&b.license.licenseTxt&&f.license.type==b.license.type&&f.license.id==b.license.id&&f.license.version==b.license.version){c(Error("tenant with same license exists","configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.TenantPersistHandler.save(a,b,function(g){b.license&&b.license.valid&&b.license.isTestLicense()&&b.license.saveStartDate();c(g,b)})}else c(Error("license is invalid"));
else c(Error("license is null"));else c(Error("name is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();a=require("m.aio.devicemanager.js");var d=require("m.aio.macromanager.js");a.addTenant(b,function(e){e?c&&c(e):d.addTenant(b,function(f){c&&c(f,b)})})}};
m.aio.configmanager.TenantsJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++)b.push(m.aio.configmanager.TenantJSONHandler.toJSON(a.children[c]));return b}};
m.aio.configmanager.TenantsPersistHandler={load:function(a,b,c){var d=new m.aio.configmanager.Tenants;d.parent=a;var e=this,f=require("fs");f.readdir(b,function(g,l){g?c(g):require("async").eachSeries(l,function(k,h){var n=require("path");f.stat(b+n.sep+k,function(p,q){!p&&q.isDirectory()?m.aio.configmanager.TenantPersistHandler.load(d,b+n.sep+k,function(r,t){t?e._load(d,t,function(u,v){h(u,v)}):h()}):h()})},function(k){k?c(k):(d.sort(),d.decideOnDefault(function(){c(null,d)}))})})},_load:function(a,
b,c){var d=this;require("async").waterfall([function(e){d._preLoadNode(a,b,e)},function(e,f){d._loadNode(a,e,f)},function(e,f){d._postLoadNode(a,e,f)}],function(e,f){c(e,f)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;b.name||(b.name="new_config",d=!0);do{var e=!1;for(var f=0;f<a.children.length;f++){var g=a.children[f];g.index==b.index&&(b.index++,e=d=!0);g.name==b.name&&(d=/[(]{1}[\d]+[)]{1}$/,d.test(b.name)?(e=b.name.match(d)[0],e=parseInt(e),e++,b.name=b.name.replace(d,
"("+e+")")):b.name+="(0)",e=d=!0);g.license&&g.license.licenseTxt&&b.license&&b.license.licenseTxt&&g.license.type==b.license.type&&g.license.id==b.license.id&&g.license.version==b.license.version&&(b.license=null,e=d=!0)}}while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,b,c){b._changed?m.aio.configmanager.TenantPersistHandler.save(a,b,function(d){delete b._changed;c(d,b)}):c(null,b)}};
m.aio.configmanager.Tenant=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.license=this.name=this.folder=null;this.default=!1;this.remotes=new m.aio.configmanager.Remotes(this)};m.aio.configmanager.Tenant.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Tenant.prototype.constructor=m.aio.configmanager.Tenant;m.aio.configmanager.Tenant.SETTING="settings";m.aio.configmanager.Tenant.REMOTES="remotes";
m.aio.configmanager.Tenant.prototype.getFolder=function(){this.folder||(this.folder=Math.round((new Date).getTime()/1E3).toString());return this.folder};m.aio.configmanager.Tenant.prototype.getFolderPath=function(){var a=this.parent?this.parent.getFolderPath():null,b=this.getFolder(),c=require("path");return a&&b?a+c.sep+b:null};m.aio.configmanager.Tenant.prototype.getDeviceFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"device_db"};
m.aio.configmanager.Tenant.prototype.getMacrosFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"macros_db"};m.aio.configmanager.Tenant.prototype.getDeviceinfoFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"deviceinfo.xml"};m.aio.configmanager.Tenant.prototype.getRemotes=function(){return this.remotes};
m.aio.configmanager.Tenant.prototype.isAccessible=function(){return this.license&&this.license.valid?!(this.license.isTestLicense()&&this.license.isExpired()):!1};m.aio.configmanager.Tenant.prototype.isDefault=function(){return this.default};
m.aio.configmanager.Tenant.prototype.reloadRemotes=function(a){var b=require("path"),c=this.getFolderPath(),d=this;m.aio.configmanager.RemotesPersistHandler.load(this,c+b.sep+m.aio.configmanager.Tenant.REMOTES,function(e,f){e?a&&a(e):(d.remotes.parent=null,f.parent=d,d.remotes=f,a&&a(null))})};
m.aio.configmanager.TenantHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("tenant is isolated"));break}m.aio.configmanager.TenantPersistHandler.remove(e,a,function(q){if(q)d(q);else{q=require("m.aio.devicemanager.js");var r=require("m.aio.macromanager.js");q.removeTenant(a,function(){r.removeTenant(a,function(){e.removeChild(a);d(null,{success:!0})})})}});break;case "update":if(!e){d(Error("tenant is isolated"));
break}b=m.aio.configmanager.TenantJSONHandler.fromJSON(c);if(!b){d(Error("data format invalid"));break}var f=null,g=!1;if(b.name&&a.name!=b.name){for(c=0;c<e.children.length;c++){var l=e.children[c];if(l.name==b.name){d(Error("tenant name is already existed"));return}}g=!0;f=a.name;a.name=b.name}var k=!1,h=null;if(b.default){k=!0;for(c=0;c<e.children.length;c++)if(l=e.children[c],l.default){l.default=!1;h=l;break}a.default=b.default}var n=null,p=!1;if(b.license&&b.license.licenseTxt&&(!a.license||
a.license.licenseTxt!=b.license.licenseTxt)){if(!b.license.valid){d(Error("license invalid"));break}for(c=0;c<e.children.length;c++)if(l=e.children[c],l.index!=b.index&&l.license&&l.license.type==b.license.type&&l.license.id==b.license.id&&l.license.version==b.license.version){d(Error("tenant license is already existed"));return}p=!0;n=a.license;a.license=b.license}g||p||k?m.aio.configmanager.TenantPersistHandler.save(e,a,function(q){q?(g&&(a.id=f),p&&(a.license=n),k&&(a.default=!1,h&&(h.default=
!0)),d(q)):(p&&a.license&&!a.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),p&&a.license&&a.license.isTestLicense()&&(n&&n.id==a.license.id?(q=n.getStartDate(),a.license.saveStartDateWithDate(q)):a.license.saveStartDate()),k&&h?m.aio.configmanager.TenantPersistHandler.save(e,h,function(r){d(r,m.aio.configmanager.TenantJSONHandler.toJSON(a))}):d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a)))}):d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a));break;default:d(Error("no such method"))}}};
m.aio.configmanager.TenantJSONHandler={fromJSON:function(a){if(!a||!a.classid||"tenant"!==a.classid)return null;var b=new m.aio.configmanager.Tenant;b.index=a.index?a.index:-1;b.name=a.name;b.default=a.default?!0:!1;b.license=null;a.license&&(b.license=m.aio.configmanager.LicenseJSONHandler.fromJSON(a.license),b.license&&(b.license.parent=b));return b},toJSON:function(a){return{classid:"tenant",index:a.index,name:a.name,default:a.default,folder:a.getFolderPath(),license:a.license?m.aio.configmanager.LicenseJSONHandler.toJSON(a.license):
null,remotes:a.remotes?m.aio.configmanager.RemotesJSONHandler.toJSON(a.remotes):null}}};
m.aio.configmanager.TenantPersistHandler={save:function(a,b,c){a=a.getFolderPath();var d=b.getFolder();if(a)if(d){var e=require("path");d=a+e.sep+d;a=require("async");var f=require("fs");a.series([function(g){f.exists(d,function(l){l?f.stat(d,function(k,h){k?g(k):h.isDirectory()?g():g(Error(d+" is not a folder"))}):require("fs-extra").mkdirs(d,function(k){g(k)})})},function(g){f.writeFile(d+e.sep+m.aio.configmanager.Tenant.SETTING,JSON.stringify({index:b.index,name:b.name,default:b.default?!0:!1,
license:b.license?b.license.licenseTxt:null}),function(l){g(l)})}],function(g){c(g)})}else c(Error("tenant folder is null"));else c(Error("parent folder path is null"))},load:function(a,b,c){var d=new m.aio.configmanager.Tenant;d.parent=a;var e=require("path");this._loadSettings(b+e.sep+m.aio.configmanager.Tenant.SETTING,function(f,g){f?c(f):g?(d.index=g.index?g.index:-1,f=b.lastIndexOf(e.sep),d.folder=b.substr(f+1),d.name=g.name,d.license=g.license,d.default=g.default?!0:!1,d&&d.license&&(d.license.parent=
d,d.license.isTestLicense()&&!d.license.getStartDate()&&d.license.saveStartDate()),m.aio.configmanager.RemotesPersistHandler.load(d,b+e.sep+m.aio.configmanager.Tenant.REMOTES,function(l,k){l?c(l):(k.parent=d,d.remotes=k,c(null,d))})):c(null,null)})},_loadSettings:function(a,b){var c=require("fs");c.exists(a,function(d){d?c.readFile(a,function(e,f){if(e)b(e);else{e={};if(0<f.length)try{e=JSON.parse(f.toString())}catch(g){b(null,e);return}e.license&&(e.license=m.aio.configmanager.LicenseManager.resolve(e.license));
b(null,e)}}):b(null,null)})},remove:function(a,b,c){a=a.getFolderPath();b=b.getFolder();if(a)if(b){var d=require("path");b=a+d.sep+b;require("fs-extra").remove(b,function(e){c(e)})}else c(Error("tenant folder is null"));else c(Error("parent folder path is null"))}};m.aio.configmanager.Remotes=function(a){m.aio.configmanager.ListNode.call(this,a);this.parent=a;this.children=[]};m.aio.configmanager.Remotes.prototype=Object.create(m.aio.configmanager.ListNode.prototype);
m.aio.configmanager.Remotes.prototype.constructor=m.aio.configmanager.Remotes;m.aio.configmanager.Remotes.FOLDER="remotes";m.aio.configmanager.Remotes.prototype.size=function(){return this.children?this.children.length:0};m.aio.configmanager.Remotes.prototype.getChildren=function(){return this.children};m.aio.configmanager.Remotes.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remotes.FOLDER};
m.aio.configmanager.Remotes.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};m.aio.configmanager.Remotes.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};
m.aio.configmanager.Remotes.prototype.sort=function(){var a=this.children.length-1;do{var b=!1;for(var c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0)}while(b)};
m.aio.configmanager.RemotesHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.RemotesJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.RemoteJSONHandler.fromJSON(c))?this._add(a,b,function(e,f){e?d(e):d(null,m.aio.configmanager.RemoteJSONHandler.toJSON(f))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_getFreeIndex:function(a){a.sort();for(var b=1,c=0;c<a.children.length;c++)a.children[c].index==b&&b++;return b},_add:function(a,
b,c){var d=this;require("async").waterfall([function(e){d._preAddNode(a,b,e)},function(e,f){d._addNode(a,b,f)},function(e,f){d._postAddNode(a,b,f)}],function(e,f){c(e,f)})},_preAddNode:function(a,b,c){var d=1;if(b.id)if(b.id.match(m.aio.configmanager.Util.FILENAME_REGEX))c(Error("remote id has invalid character"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("remote with same index exists","configmanager.js"));return}if(f.id==b.id){c(Error("remote with same id exists",
"configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.RemotePersistHandler.save(a,b,function(g){c(g,b)})}else c(Error("id is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();c(null,b)}};m.aio.configmanager.RemotesJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++){var d=m.aio.configmanager.RemoteJSONHandler.toJSON(a.children[c]);d&&b.push(d)}return b}};
m.aio.configmanager.RemotesPersistHandler={load:function(a,b,c){var d=new m.aio.configmanager.Remotes;d.parent=a;var e=this,f=require("fs");f.exists(b,function(g){g?f.readdir(b,function(l,k){if(l)c(l);else{l=require("async");var h=require("path");l.eachSeries(k,function(n,p){f.stat(b+h.sep+n,function(q,r){!q&&r.isDirectory()?m.aio.configmanager.RemotePersistHandler.load(d,b+h.sep+n,function(t,u){u?e._load(d,u,function(v,w){p(v,w)}):p()}):p()})},function(n){n?c(n):(d.sort(),c(null,d))})}}):c(null,
d)})},_load:function(a,b,c){var d=this;require("async").waterfall([function(e){d._preLoadNode(a,b,e)},function(e,f){d._loadNode(a,e,f)},function(e,f){d._postLoadNode(a,e,f)}],function(e,f){c(e,f)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;do{var e=!1;for(var f=0;f<a.children.length;f++)a.children[f].index==b.index&&(b.index++,e=d=!0)}while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,
b,c){b._changed?m.aio.configmanager.RemotePersistHandler.save(a,b,function(d){delete b._changed;c(d,b)}):c(null,b)}};m.aio.configmanager.Remote=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.skin=this.id=null;this.info={};this.pages=new m.aio.configmanager.Pages(this)};m.aio.configmanager.Remote.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Remote.prototype.constructor=m.aio.configmanager.Remote;
m.aio.configmanager.Remote.SETTING="settings";m.aio.configmanager.Remote.PAGES="controls";m.aio.configmanager.Remote.prototype.getFolder=function(){return this.id};m.aio.configmanager.Remote.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+this.id};m.aio.configmanager.Remote.prototype.getSettingsFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"settings"};
m.aio.configmanager.Remote.prototype.getDeviceFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"device_db"};m.aio.configmanager.Remote.prototype.getMacrosFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"macros_db"};m.aio.configmanager.Remote.prototype.getDeviceinfoFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"deviceinfo.xml"};
m.aio.configmanager.Remote.prototype.getResourcesFolderPath=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"resources"};m.aio.configmanager.Remote.prototype.getPagesFolderPath=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remote.PAGES};
m.aio.configmanager.Remote.prototype.processResourceList=function(a,b){this.pages?this.pages.children?require("async").each(this.pages.children,function(c,d){c.processResourceList(a,function(e){d(e)})},function(c){b&&b(c)}):b&&b(null):b&&b(null)};
m.aio.configmanager.RemoteHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.RemoteJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("remote is isolated"));break}m.aio.configmanager.RemotePersistHandler.remove(e,a,function(g){g?d(g):(e.removeChild(a),d(null,{success:!0}))});break;case "update":if(!e){d(Error("remote is isolated"));break}var f=m.aio.configmanager.RemoteJSONHandler.fromJSON(c);if(!f){d(Error("data format invalid"));break}if(!f.id){d(Error("data format invalid: id is empty"));
break}if(f.id.match(m.aio.configmanager.Util.FILENAME_REGEX)){d(Error("remote id has invalid character"));break}console.log("start update remote");require("async").series([function(g){console.log("start check skin");if(f.skin)if(a.skin&&f.skin.id==a.skin.id&&f.skin.inRemote==a.skin.id)g();else{var l=a.skin;a.skin=f.skin;m.aio.configmanager.RemotePersistHandler.save(e,a,function(k){k&&(a.skin=l);g(k)})}else g()},function(g){if(f.info&&"object"==typeof f.info){var l=a.info;a.info=f.info;m.aio.configmanager.RemotePersistHandler.save(e,
a,function(k){k&&(a.info=l);g(k)})}else g()},function(g){console.log("start check remote name");if(a.id==f.id)g();else{for(var l=0;l<e.children.length;l++)if(e.children[l].id==f.id){g(Error("remote id is already existed"));return}e.getFolderPath()?m.aio.configmanager.RemotePersistHandler.move(e,a,f.id,function(k){console.log("finish move remote folder:"+k);k?g(k):(a.id=f.id,g())}):g(Error("remotes folder invalid"))}}],function(g){d(g,m.aio.configmanager.RemoteJSONHandler.toJSON(a))});break;case "create":this.saveRemote(a,
c,d);break;default:d(Error("no such method"))}},saveRemote:function(a,b,c){var d=a.parent;if(d){var e=m.aio.configmanager.RemoteJSONHandler.fromJSON(b);e?e.id?e.id.match(m.aio.configmanager.Util.FILENAME_REGEX)?c(Error("remote id has invalid character")):require("async").waterfall([function(f){if(e.info&&"object"==typeof e.info){var g=a.info;a.info=e.info;m.aio.configmanager.RemotePersistHandler.save(d,a,function(l){l&&(a.info=g);f(l)})}else f()},function(f){if(a.id!=e.id){for(var g=0;g<d.children.length;g++)if(d.children[g].id==
e.id){f(Error("remote id is already existed"));return}g=require("path");var l=d.getFolderPath()+g.sep+e.id;m.aio.configmanager.RemotePersistHandler.copy(d,a,e.id,function(k){k?f(k):m.aio.configmanager.RemotePersistHandler.load(d,l,function(h,n){h?f(h):(n.index=a.index,a.index=m.aio.configmanager.RemotesHandler._getFreeIndex(a.parent),m.aio.configmanager.RemotePersistHandler._saveSettings(a,function(p){p?f(p):m.aio.configmanager.RemotesHandler._add(d,n,function(q,r){f(q,n)})}))})})}else f(null,a)}.bind(this),
function(f,g){var l=require("m.aio.devicemanager.js");l.saveRemote(f,function(k){l.clearRemoteDB(f,function(){g(k,f)})})}.bind(this),function(f,g){require("m.aio.macromanager.js").saveRemote(f,function(l){g(l,f)})}.bind(this),function(f,g){require("m.aio.skinmanager.js").saveRemote(f,e,function(l,k){l?g(l):(f.skin=k.skin,m.aio.configmanager.RemotePersistHandler.save(d,f,function(h){g(h,m.aio.configmanager.RemoteJSONHandler.toJSON(f))}))})}.bind(this)],function(f,g){c&&c(f,g)}):c(Error("data format invalid: id is empty")):
c(Error("data format invalid"))}else c(Error("remote is isolated"))}};
m.aio.configmanager.RemoteJSONHandler={fromJSON:function(a){if(!a||!a.classid||"remote"!==a.classid)return null;var b=new m.aio.configmanager.Remote;b.index=a.index?a.index:-1;b.id=a.id;b.skin=a.skin;a.info&&"object"==typeof a.info&&(b.info=a.info);return b},toJSON:function(a){return{classid:"remote",index:a.index,id:a.id,info:a.info,skin:a.skin,folder:a.getFolderPath(),pages:a.pages?m.aio.configmanager.PagesJSONHandler.toJSON(a.pages):null}}};
m.aio.configmanager.RemotePersistHandler={save:function(a,b,c){a=a.getFolderPath();var d=b.getFolder();if(a)if(d){var e=require("path");d=a+e.sep+d;a=require("async");var f=require("fs");a.series([function(g){f.exists(d,function(l){l?f.stat(d,function(k,h){k?g(k):h.isDirectory()?g():g(Error(d+" is not a folder"))}):require("fs-extra").mkdirs(d,function(k){g(k)})})},function(g){f.writeFile(d+e.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify({index:b.index,info:b.info,skin:b.skin}),function(l){g(l)})}],
function(g){c(g)})}else c(Error("remote folder is null"));else c(Error("parent folder path is null"))},_saveSettings:function(a,b){var c=a.parent;if(c){c=c.getFolderPath();var d=a.getFolder();if(c)if(d){var e=require("path");d=c+e.sep+d;require("fs").writeFile(d+e.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify({index:a.index,info:a.info,skin:a.skin}),function(f){b(f)})}else b(Error("remote folder is null"));else b(Error("parent folder path is null"))}else b(Error("remote is isolated"))},load:function(a,
b,c){var d=new m.aio.configmanager.Remote;d.parent=a;var e=require("path");this._loadSettings(b+e.sep+m.aio.configmanager.Remote.SETTING,function(f,g){f?c(f):g?(d.index=g.index?g.index:-1,d.skin=g.skin?g.skin:null,d.info=g.info?g.info:{},f=b.lastIndexOf(e.sep),d.id=b.substr(f+1),m.aio.configmanager.PagesPersistHandler.load(d,b+e.sep+m.aio.configmanager.Remote.PAGES,function(l,k){l?c(l):(k.parent=d,d.pages=k,c(null,d))})):c(null,null)})},_loadSettings:function(a,b){var c=require("fs");c.exists(a,function(d){d?
c.readFile(a,function(e,f){if(e)b(e);else{e={};if(0<f.length)try{e=JSON.parse(f.toString())}catch(g){b(null,e);return}b(null,e)}}):b(null,null)})},remove:function(a,b,c){var d=function(f){for(var g=require("fs"),l=require("path"),k=g.readdirSync(f),h=0;h<k.length;h++){var n=l.join(f,k[h]);console.log("try to delete:"+n);var p=g.statSync(n);"."!=n&&".."!=n&&(p.isDirectory()?(console.log(n+" is folder"),d(n)):(g.unlinkSync(n),console.log(n+" deleted ("+h+"/"+k.length+")")))}console.log("try to delete folder:"+
f);g.rmdirSync(f);console.log("folder:"+f+" deleted")};a=a.getFolderPath();b=b.getFolder();if(a)if(b){var e=require("path");b=a+e.sep+b;try{d(b),c()}catch(f){console.error(f),c(f)}}else c(Error("remote folder is null"));else c(Error("parent folder path is null"))},move:function(a,b,c,d){a=a.getFolderPath();b=b.getFolder();if(a)if(b){var e=require("path");b=a+e.sep+b;c=a+e.sep+c;a=require("fs");console.log("start to move remote folder");a.rename(b,c,function(f){d(f)})}else d(Error("remote folder is null"));
else d(Error("parent folder path is null"))},copy:function(a,b,c,d){var e=require("path");(b=b.getFolderPath())?(a=a.getFolderPath()+e.sep+c,require("fs-extra").copy(b,a,function(f){d&&d(f)})):d&&d(Error("remote folder invalid"))}};m.aio.configmanager.Pages=function(a){m.aio.configmanager.ListNode.call(this,a);this.parent=a;this.children=[]};m.aio.configmanager.Pages.prototype=Object.create(m.aio.configmanager.ListNode.prototype);m.aio.configmanager.Pages.prototype.constructor=m.aio.configmanager.Pages;
m.aio.configmanager.Pages.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remote.PAGES};m.aio.configmanager.Pages.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};
m.aio.configmanager.Pages.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};m.aio.configmanager.Pages.prototype.sort=function(){var a=this.children.length-1;do{var b=!1;for(var c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0)}while(b)};
m.aio.configmanager.PagesHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.PagesJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.PageJSONHandler.fromJSON(c))?this._add(a,b,function(e,f){e?d(e):d(null,m.aio.configmanager.PageJSONHandler.toJSON(f))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_add:function(a,b,c){var d=this;require("async").waterfall([function(e){d._preAddNode(a,b,e)},function(e,f){d._addNode(a,b,f)},
function(e,f){d._postAddNode(a,b,f)}],function(e,f){c(e,f)})},_preAddNode:function(a,b,c){var d=1;if(b.id)if(b.id.match(m.aio.configmanager.Util.FILENAME_REGEX))c(Error("page id has invalid character"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("page with same index exists","configmanager.js"));return}if(f.id==b.id){c(Error("page with same name exists","configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.PagePersistHandler.save(a,
b,function(g){c(g,b)})}else c(Error("name is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();c(null,b)}};m.aio.configmanager.PagesJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++){var d=m.aio.configmanager.PageJSONHandler.toJSON(a.children[c]);d&&b.push(d)}return b}};
m.aio.configmanager.PagesPersistHandler={load:function(a,b,c){var d=m.aio.configmanager.Page.FILE_EXT,e=new m.aio.configmanager.Pages;e.parent=a;var f=this,g=require("fs");g.exists(b,function(l){l?g.readdir(b,function(k,h){if(k)c(k);else{k=require("async");var n=require("path");k.eachLimit(h,10,function(p,q){var r=n.extname(p);if(r!==d.PAGE&&r!==d.POPUP)q();else{var t=b+n.sep+p;g.stat(t,function(u,v){u||!v.isFile()?q(u):m.aio.configmanager.PagePersistHandler.load(e,t,function(w,x){x?f._load(e,x,function(y,
z){q(y,z)}):q()})})}},function(p){e.sort();p?c(p):c(null,e)})}}):c(null,e)})},_load:function(a,b,c){var d=this;require("async").waterfall([function(e){d._preLoadNode(a,b,e)},function(e,f){d._loadNode(a,e,f)},function(e,f){d._postLoadNode(a,b,f)}],function(e,f){c(e,f)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;do{var e=!1;for(var f=0;f<a.children.length;f++)a.children[f].index==b.index&&(b.index++,e=d=!0)}while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,
b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,b,c){b._changed?m.aio.configmanager.PagePersistHandler.save(a,b,function(d){delete b._changed;c(d,b)}):c(null,b)}};m.aio.configmanager.Page=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.id=null;this.isPopup=!1};m.aio.configmanager.Page.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Page.prototype.constructor=m.aio.configmanager.Page;
m.aio.configmanager.Page.FILE_EXT={PAGE:".p",POPUP:".popup"};m.aio.configmanager.Page.prototype.getChild=function(a){return a&&"string"===typeof a?"pagecontent"==a?(a=m.aio.configmanager.PageContentPersistHandler.loadSync(this.getFolderPath()),a.parent=this,a):this[a]:null};m.aio.configmanager.Page.prototype.getFile=function(a){return this.id?!0===a?this.id+this.getFileExt():this.id:this.id};
m.aio.configmanager.Page.prototype.getFileExt=function(){return this.isPopup?m.aio.configmanager.Page.FILE_EXT.POPUP:m.aio.configmanager.Page.FILE_EXT.PAGE};m.aio.configmanager.Page.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+this.getFile(!0)};
m.aio.configmanager.Page.prototype.processResourceList=function(a,b){var c=this;m.aio.configmanager.PageContentPersistHandler.load(this.getFolderPath(),function(d,e){d?b&&b(d):e.processResourceList(c,a,function(f){b&&b(f)})})};
m.aio.configmanager.PageHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.PageJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("page is isolated"));break}m.aio.configmanager.PagePersistHandler.remove(e,a,function(g){g?d(g):(e.removeChild(a),d(null,{success:!0}))});break;case "update":if(!e){d(Error("page is isolated"));break}var f=m.aio.configmanager.PageJSONHandler.fromJSON(c);if(!f){d(Error("data format invalid"));break}if(!f.id){d(Error("data format invalid:id is empty"));
break}if(f.id.match(m.aio.configmanager.Util.FILENAME_REGEX)){d(Error("page id has invalid character"));break}if(a.id==f.id){d(null,m.aio.configmanager.PageJSONHandler.toJSON(a));break}for(b=0;b<e.children.length;b++)if(e.children[b].id==f.id){d(Error("page id is already existed"));return}m.aio.configmanager.PagePersistHandler.move(e,a,f.id,function(g){g?d(g):(a.id=f.id,d(null,m.aio.configmanager.PageJSONHandler.toJSON(a)))});break;default:d(Error("no such method"))}}};
m.aio.configmanager.PageJSONHandler={fromJSON:function(a){if(!a||!a.classid||"page"!==a.classid)return null;var b=new m.aio.configmanager.Page;b.index=a.index?a.index:-1;b.id=a.id;b.isPopup=!!a.isPopup;return b},toJSON:function(a){return{classid:"page",index:a.index,id:a.id,isPopup:!!a.isPopup}}};
m.aio.configmanager.PagePersistHandler={save:function(a,b,c){var d=a.getFolderPath(),e=b.getFile(!0);if(d)if(e){var f=require("path");e=d+f.sep+e;m.aio.configmanager.PageContentPersistHandler.load(e,function(g,l){g?c(g):(l.content||(l.content={}),l.content.index=b.index,m.aio.configmanager.PageContentPersistHandler.save(a,b,l,function(k){c(k,b)}))})}else c(Error("page file is null"));else c(Error("parent folder path is null"))},load:function(a,b,c){var d=this,e=m.aio.configmanager.Page.FILE_EXT,f=
new m.aio.configmanager.Page;f.parent=a;var g=require("fs");g.exists(b,function(l){l?g.readFile(b,function(k,h){if(k)c(k);else{k=require("path");k=b.lastIndexOf(k.sep);var n=b.substr(k+1),p=!1;k=n.indexOf(e.PAGE);0<=k&&k===n.length-e.PAGE.length&&(p=!0,f.id=n.replace(e.PAGE,""));k=n.indexOf(e.POPUP);0<=k&&k===n.length-e.POPUP.length&&(p=!0,f.id=n.replace(e.POPUP,""),f.isPopup=!0);if(p){if(0<h.length)try{var q=JSON.parse(h.toString());f.index=q.index}catch(r){d.saveDamageFile(b,h,function(){c(null,
f)});return}c(null,f)}else c(null,null)}}):c(null,null)})},saveDamageFile:function(a,b,c){require("fs").writeFile(a+".bk",b,c)},remove:function(a,b,c){a=a.getFolderPath();b=b.getFile(!0);if(a)if(b){var d=require("path");b=a+d.sep+b;require("fs-extra").remove(b,function(e){c(e)})}else c(Error("page file is null"));else c(Error("parent folder path is null"))},move:function(a,b,c,d){a=a.getFolderPath();var e=b.getFile();if(a)if(e){var f=require("path");b=b.getFileExt();e=a+f.sep+e+b;c=a+f.sep+c+b;require("fs-extra").move(e,
c,function(g){d(g)})}else d(Error("page file is null"));else d(Error("parent folder path is null"))}};m.aio.configmanager.PageContent=function(a){m.aio.configmanager.Node.call(this,a);this.content=null};m.aio.configmanager.PageContent.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.PageContent.prototype.constructor=m.aio.configmanager.PageContent;
m.aio.configmanager.PageContent.prototype.processResourceList=function(a,b,c){var d=function(h,n,p){return n?h.processResourceSync(n,p):null},e=function(h,n){if(n&&n.states&&"object"===typeof n.states){var p="string"===typeof n.path?n.path.length:0,q;for(q in n.states){var r=n.states[q];if(r&&"object"===typeof r&&"string"===typeof r.i){var t=0!==r.p&&"string"===typeof n.path;k=d(h,t?n.path+"/"+r.i:r.i,r.s);l=l||!!k;k&&(r=t?p+1:0,0===r&&"/"==k[0]&&r++,n.states[q].i=k.substr(r))}}}},f=function(h,n){if(n&&
n.info&&"object"===typeof n.info){var p="string"===typeof n.info.path?n.info.path+"/":"",q;for(q in n.info){var r=n.info[q];"path"!=q&&r&&"string"===typeof r&&(k=d(h,p+r,n.img_skin),l=l||!!k,k&&(n.info[q]=k.substr(0<p.length?p.length:1)))}}};try{var g,l=!1;if(this.content){if(this.content.widget&&this.content.widget.bgimg){var k=d(b,this.content.widget.bgimg,this.content.widget.bgimg_skin);l=l||!!k;k&&(this.content.widget.bgimg=k)}this.content.infos&&this.content.infos.forEach(function(h){if(h.widget){k=
d(b,h.widget.img,h.widget.img_skin);l=l||(k?h.widget.img!==k:!1);k&&(h.widget.img=k);k=d(b,h.widget.bgimg,h.widget.bgimg_skin);l=l||(k?h.widget.bgimg!==k:!1);k&&(h.widget.bgimg=k);if(h.widget.path&&h.widget.images)for(g=0;g<h.widget.images.length;g++){var n=h.widget.images[g];if(n){var p=0<=n.indexOf("/")?"":h.widget.path+"/";k=d(b,p+n,h.widget.img_skin);l=l||(k?p+n!==k:!1);k&&(h.widget.images[g]=k.substr(p.length))}}h.widget._default&&"string"===typeof h.widget._default&&b.processDefaultImageSync(h.widget);
e(b,h.widget);f(b,h.widget);"string"===typeof h.widget.stateRuleRef&&a&&a.parent&&(n=(n=a.parent.parent)&&n.info&&n.info.stateRules)&&n[h.widget.stateRuleRef]&&e(b,n[h.widget.stateRuleRef])}});this.content.buttons&&this.content.buttons.forEach(function(h){if(h.widget){k=d(b,h.widget.img,h.widget.img_skin);l=l||(k?h.widget.img!==k:!1);k&&(h.widget.img=k);k=d(b,h.widget.bgimg,h.widget.bgimg_skin);l=l||(k?h.widget.bgimg!==k:!1);k&&(h.widget.bgimg=k);if(h.widget.path&&h.widget.images)for(g=0;g<h.widget.images.length;g++){var n=
h.widget.images[g];if(n){var p=0<=n.indexOf("/")?"":h.widget.path+"/";k=d(b,p+n,h.widget.img_skin);l=l||(k?p+n!==k:!1);k&&(h.widget.images[g]=k.substr(p.length))}}h.widget._default&&"string"===typeof h.widget._default&&b.processDefaultImageSync(h.widget);e(b,h.widget);f(b,h.widget);"string"===typeof h.widget.stateRuleRef&&a&&a.parent&&(n=(n=a.parent.parent)&&n.info&&n.info.stateRules)&&n[h.widget.stateRuleRef]&&e(b,n[h.widget.stateRuleRef])}});this.content.selects&&this.content.selects.forEach(function(h){h.widget&&
(k=d(b,h.widget.img_n,h.widget.img_skin_n),l=l||(k?h.widget.img_n!==k:!1),k&&(h.widget.img_n=k),k=d(b,h.widget.img_y,h.widget.img_skin_y),l=l||(k?h.widget.img_y!==k:!1),k&&(h.widget.img_y=k),k=d(b,h.widget.bgimg,h.widget.bgimg_skin),l=l||(k?h.widget.bgimg!==k:!1),k&&(h.widget.bgimg=k))});this.content.selectdevices&&this.content.selectdevices.forEach(function(h){h.widget&&(k=d(b,h.widget.img_n,h.widget.img_skin_n),l=l||(k?h.widget.img_n!==k:!1),k&&(h.widget.img_n=k),k=d(b,h.widget.img_y,h.widget.img_skin_y),
l=l||(k?h.widget.img_y!==k:!1),k&&(h.widget.img_y=k),k=d(b,h.widget.bgimg,h.widget.bgimg_skin),l=l||(k?h.widget.bgimg!==k:!1),k&&(h.widget.bgimg=k))});this.content.sliders&&this.content.sliders.forEach(function(h){h.widget&&(h=h.widget)&&b.processWidgetSync(h)});this.content.roundsliders&&this.content.roundsliders.forEach(function(h){h.widget&&(h=h.widget)&&b.processWidgetSync(h)});this.content.colorchoosers&&this.content.colorchoosers.forEach(function(h){h.widget&&(h=h.widget)&&b.processWidgetSync(h)});
this.content.analogmeters&&this.content.analogmeters.forEach(function(h){h.widget&&(h=h.widget)&&b.processWidgetSync(h)});this.content.amps&&this.content.amps.forEach(function(h){h.widget&&(h=h.widget)&&b.processWidgetSync(h)})}l?m.aio.configmanager.PageContentPersistHandler.save(a.parent,a,this,function(h){c&&c(h)}):c&&c(null)}catch(h){c&&c(h)}};
m.aio.configmanager.PageContentHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.PageContentJSONHandler.toJSON(a));break;case "update":b=m.aio.configmanager.PageContentJSONHandler.fromJSON(c);if(!b){d(Error("data format invalid"));break}c=a.parent;if(!c){d(Error("page content is isolated"));break}var e=c.parent;if(!e){d(Error("page content is isolated"));break}m.aio.configmanager.PageContentPersistHandler.save(e,c,b,function(f){d(f,m.aio.configmanager.PageContentJSONHandler.toJSON(a))});
break;default:d(Error("no such method"))}}};m.aio.configmanager.PageContentJSONHandler={fromJSON:function(a){if(!a||!a.classid||"control"!==a.classid)return null;var b=new m.aio.configmanager.PageContent;b.content=a;return b},toJSON:function(a){return a.content}};
m.aio.configmanager.PageContentPersistHandler={save:function(a,b,c,d){a=a.getFolderPath();var e=b.getFile(!0);if(a)if(e)if(c)if(c.content&&"object"===typeof c.content){var f=require("fs-extra"),g=require("path"),l=require("unorm");c=c.content;c.index=b.index;c.classid&&"control"===c.classid||(c.classid="control");var k=null;try{k=l.nfc(JSON.stringify(c))}catch(p){d(p);return}if(k){var h=null;e=a+g.sep+e;try{f.existsSync(e)&&(h=e+"-"+Date.now()+".old",f.copySync(e,h))}catch(p){XC.debugf("[m.aio.configmanager.PageContentPersistHandler.save] Could either not check file or copy it."+
p.message,"error");d(p);return}var n=function(){if(h)try{XC.debugf('[m.aio.configmanager.PageContentPersistHandler.save] Trying to restore backup "'+h+'" ...'),f.moveSync(h,e,{overwrite:!0}),XC.debugf("[m.aio.configmanager.PageContentPersistHandler.save] Restored file as "+e),h=null}catch(p){XC.debugf("[m.aio.configmanager.PageContentPersistHandler.save] Failed to restore backup: "+p.message,"error")}};f.ensureFile(e,function(p){p?(n(),d(p)):f.writeFile(e,k,function(q){if(q)n();else if(h)try{f.unlinkSync(h)}catch(r){XC.debugf("[m.aio.configmanager.PageContentPersistHandler.save] Failed to delete backup file: "+
r.message,"error")}d(q)})})}else d(Error("Stringified and normalized data is empty."))}else d(Error("missing page content"));else d(Error("content is null"));else d(Error("page file is null"));else d(Error("parent folder path is null"))},load:function(a,b){var c=new m.aio.configmanager.PageContent,d=require("fs");d.exists(a,function(e){e?d.readFile(a,function(f,g){if(f)b(f);else{if(0<g.length)try{c.content=JSON.parse(g.toString())}catch(l){b(l,c);return}b(null,c)}}):b(null,c)})},loadSync:function(a){var b=
new m.aio.configmanager.PageContent,c=require("fs");try{var d=c.readFileSync(a);0<d.length?b.content=JSON.parse(d.toString()):XC.debugf("[m.aio.configmanager.PageContentPersistHandler.loadSync] Page content is empty of file: "+a,"warn")}catch(e){XC.debugf("[m.aio.configmanager.PageContentPersistHandler.loadSync] "+e.message,"error")}return b}};m.aio.configmanager.Util={FILENAME_REGEX:/[\\/:"*?<>|]+/g};
m.aio.configmanager.ConfigManager=function(){m.aio.configmanager.Node.call(this,null);this.filemanager=this.config=null};m.aio.configmanager.ConfigManager.USER_CONFIG="";m.aio.configmanager.ConfigManager.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.ConfigManager.prototype.constructor=m.aio.configmanager.ConfigManager;
m.aio.configmanager.ConfigManager.prototype.init=function(a,b){var c=require("path"),d=require("fs");this.filemanager=a;m.aio.configmanager.ConfigManager.USER_CONFIG=a.getUserRootDataPath()+c.sep+"tenants";var e=this;require("async").series([function(f){var g=m.aio.configmanager.ConfigManager.USER_CONFIG;d.exists(g,function(l){l?d.stat(g,function(k,h){k?f(k):h.isDirectory()?f():d.unlink(g,function(n){n?f(n):d.mkdir(g,function(p){f(p)})})}):d.mkdir(g,function(k){f(k)})})},function(f){m.aio.configmanager.ConfigPersistHandler.load(m.aio.configmanager.ConfigManager.USER_CONFIG,
function(g,l){g?f(g):(e.config=l,f())})},function(f){if(e.config&&e.config.tenants&&0!=e.config.tenants.size())f();else{e.config.tenants||(e.config.tenants=new m.aio.configmanager.Tenants,e.config.tenants.parent=e.config);var g=new m.aio.configmanager.Tenant;g.index=1;g.name="default";g.parent=e.config.tenants;e.config.tenants.children.push(g);m.aio.configmanager.TenantPersistHandler.save(e.config.tenants,g,function(l){f(l)})}},function(f){if(e.config&&e.config.tenants&&0<e.config.tenants.size()){for(var g=
!1,l,k=0;k<e.config.tenants.size();k++)if(l=e.config.tenants.get(k),l.default){g=!0;break}g?f():(l=e.config.tenants.get(0),l.default=!0,m.aio.configmanager.TenantPersistHandler.save(e.config.tenants,l,function(h){f(h)}))}else f()}],function(f){b&&b(f)})};
m.aio.configmanager.ConfigManager.prototype.execute=function(a,b,c,d){if(b=m.aio.configmanager.Path.resolve(b))if(b=m.aio.configmanager.Path.trace(this,b)){var e=this._getCRUDHandler(b);e?m.aio.configmanager.LicenseManager.permit(a,b)?e.execute(b,a,c,function(f,g){f?d(f):d(null,g)}):d(Error("not permitted")):d(Error("no handler"))}else d(Error("no such route"));else d(Error("invalid route format"))};
m.aio.configmanager.ConfigManager.prototype.trace=function(a,b){(a=m.aio.configmanager.Path.resolve(a))?(a=m.aio.configmanager.Path.trace(this,a))?b&&b(null,a):b&&b(Error("no such route")):b&&b(Error("invalid route format"))};m.aio.configmanager.ConfigManager.prototype.getChild=function(a){switch(a.toLowerCase()){case "config":return this.config;default:return null}};
m.aio.configmanager.ConfigManager.prototype._getCRUDHandler=function(a){return a instanceof m.aio.configmanager.Config?m.aio.configmanager.ConfigHandler:a instanceof m.aio.configmanager.License?m.aio.configmanager.LicenseHandler:a instanceof m.aio.configmanager.Tenants?m.aio.configmanager.TenantsHandler:a instanceof m.aio.configmanager.Tenant?m.aio.configmanager.TenantHandler:a instanceof m.aio.configmanager.Remotes?m.aio.configmanager.RemotesHandler:a instanceof m.aio.configmanager.Remote?m.aio.configmanager.RemoteHandler:
a instanceof m.aio.configmanager.Pages?m.aio.configmanager.PagesHandler:a instanceof m.aio.configmanager.Page?m.aio.configmanager.PageHandler:a instanceof m.aio.configmanager.PageContent?m.aio.configmanager.PageContentHandler:null};
m.aio.configmanager.ConfigManager.prototype.updateBlockedLicenses=function(a,b){if(this.config&&this.config.tenants&&this.config.tenants.children)for(var c=0;c<this.config.tenants.children.length;c++){var d=this.config.tenants.children[c];if(d.license)for(var e=0;e<a.length;e++)if(d.license.id==a[e].id&&d.license.version==a[e].version&&d.license.type==(a[e].type?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL)){d.license.valid=!1;break}}b&&b()};
m.aio.configmanager.ConfigManager.prototype.getAllLicenses=function(){if(!this.config||!this.config.tenants)return null;var a=this.config.tenants.getChildren();if(!a||0==a.length)return[];for(var b=[],c=0;c<a.length;c++){var d=a[c];d&&d.license&&b.push(d.license)}return b};m.aio.configmanager.CM=new m.aio.configmanager.ConfigManager;m.aio.configmanager.CM.License=m.aio.configmanager.License;m.aio.configmanager.CM.LicenseManager=m.aio.configmanager.LicenseManager;m.aio.configmanager.CM.Config=m.aio.configmanager.Config;
m.aio.configmanager.CM.ConfigPersistHandler=m.aio.configmanager.ConfigPersistHandler;m.aio.configmanager.CM.ConfigJSONHandler=m.aio.configmanager.ConfigJSONHandler;m.aio.configmanager.CM.Tenants=m.aio.configmanager.Tenants;m.aio.configmanager.CM.TenantsPersistHandler=m.aio.configmanager.TenantsPersistHandler;m.aio.configmanager.CM.TenantsHandler=m.aio.configmanager.TenantsHandler;m.aio.configmanager.CM.Tenant=m.aio.configmanager.Tenant;m.aio.configmanager.CM.TenantPersistHandler=m.aio.configmanager.TenantPersistHandler;
m.aio.configmanager.CM.TenantHandler=m.aio.configmanager.TenantHandler;m.aio.configmanager.CM.Remotes=m.aio.configmanager.Remotes;m.aio.configmanager.CM.RemotesPersistHandler=m.aio.configmanager.RemotesPersistHandler;m.aio.configmanager.CM.RemotesHandler=m.aio.configmanager.RemotesHandler;m.aio.configmanager.CM.Remote=m.aio.configmanager.Remote;m.aio.configmanager.CM.RemotePersistHandler=m.aio.configmanager.RemotePersistHandler;m.aio.configmanager.CM.RemoteHandler=m.aio.configmanager.RemoteHandler;
m.aio.configmanager.CM.Pages=m.aio.configmanager.Pages;m.aio.configmanager.CM.PagesPersistHandler=m.aio.configmanager.PagesPersistHandler;m.aio.configmanager.CM.PagesHandler=m.aio.configmanager.PagesHandler;m.aio.configmanager.CM.Page=m.aio.configmanager.Page;m.aio.configmanager.CM.PagePersistHandler=m.aio.configmanager.PagePersistHandler;m.aio.configmanager.CM.PageHandler=m.aio.configmanager.PageHandler;m.aio.configmanager.CM.PageContent=m.aio.configmanager.PageContent;
m.aio.configmanager.CM.PageContentHandler=m.aio.configmanager.PageContentHandler;"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.configmanager.CM);
