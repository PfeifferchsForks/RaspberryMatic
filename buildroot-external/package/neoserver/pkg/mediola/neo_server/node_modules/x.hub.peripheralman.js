var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.peripheralman=x.hub.peripheralman||{};
x.hub.peripheralman.PeripheralManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.PeripheralManager");this._peripherals=[]};e.FILE_NAME="pm.json";e.prototype.init=function(a){var d=this;this._load(function(c){c?a&&a(c):(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION||global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM||d._initUdevMonitor(),a&&a())})};e.prototype.getUSBDevices=function(){return this._peripherals};e.prototype._load=
function(a){var d=this,c=require("fs-extra"),b=require("x.hub.fileman.js").fileManager,f=require("path");b=b.getUserRootDataPath();var g=f.resolve(b,e.FILE_NAME);c.ensureFile(g,function(h){h?a&&a(h):d._loadData(g,function(k,l){k?a&&a(k):(d._peripherals=l,a&&a())})})};e.prototype._loadData=function(a,d){require("fs").readFile(a,"utf8",function(c,b){if(c)d&&d(c);else if(b)try{var f=JSON.parse(b);d&&d(null,f)}catch(g){d&&d(g)}else d&&d(null,[])})};e.prototype._initUdevMonitor=function(){var a=require("udev").monitor();
a.on("add",this._onAdd.bind(this));a.on("remove",this._onRemove.bind(this));a.on("change",this._onChange.bind(this));a=this._listSerialDev();var d=this;a&&a.forEach(function(c){(c=d._udev2dev(c))&&d._onFindUsbDevice(c)})};e.prototype._listSerialDev=function(){if(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION||global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM)return null;var a=require("udev"),d=a.list("tty");a=a.list("net");var c=[];d&&(c=c.concat(d));a&&(c=c.concat(a));
return c};e.prototype._isSameDev=function(a,d){for(var c in a)if(a.hasOwnProperty(c)&&a[c]!=d[c])return!1;for(c in d)if(d.hasOwnProperty(c)&&a[c]!=d[c])return!1;return!0};e.prototype._onAdd=function(a){this._logger.log("trace","add: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onFindUsbDevice(a)};e.prototype._onRemove=function(a){this._logger.log("trace","remove: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onRemoveUsbDevice(a)};e.prototype._onChange=function(a){this._logger.log("trace",
"changed: "+JSON.stringify(a))};e.prototype._udev2dev=function(a){if(!a||"usb"!=a.ID_BUS)return null;var d=a.DEVNAME,c={},b;for(b in a)a.hasOwnProperty(b)&&"ID"==b.substr(0,2)&&(c[b]=a[b]);"wlan"==a.DEVTYPE&&a.INTERFACE&&(d=a.INTERFACE);if(!d)return null;a={port:d,info:c};if("EnOcean_GmbH"==c.ID_VENDOR&&c.ID_USB_DRIVER)a.type="enocean";else if("0658"==c.ID_VENDOR&&c.ID_USB_DRIVER)a.type="zwave";else if("0451"==c.ID_VENDOR_ID&&"16a8"==c.ID_MODEL_ID&&c.ID_USB_DRIVER)a.type="zigbee";else if("2341"==
c.ID_VENDOR_ID&&"8036"==c.ID_MODEL_ID&&c.ID_USB_DRIVER)a.type="mbus";else if("wlan0"==a.port||"wlan1"==a.port)a.type="wlan";return a};e.prototype._onFindUsbDevice=function(a){for(var d=this._peripherals.length,c=!1,b=null;d;)if(d--,b=this._peripherals[d],this._isSameDev(b.info,a.info)){c=!0;b.port=a.port;break}c||(b=a,b.type?this._peripherals.push(b):b.info&&b.info.ID_USB_DRIVER&&this._peripherals.push(b));a=require("x.hub.eventbus.js");switch(b.type){case "enocean":this._logger.log("debug","add enocean stick: "+
JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ENOCEAN",b);break;case "zwave":this._logger.log("debug","add zwave stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ZWAVE",b);break;case "zigbee":this._logger.log("debug","add zigbee stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ZIGBEE",b);break;case "wlan":this._logger.log("debug","add wlan stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_WLAN",b);break;case "mbus":this._logger.log("debug","add mbus port: "+JSON.stringify(b)),
a.emit("x.hub.peripheralman.ADD_MBUS",b)}b&&b.info&&b.info.ID_USB_DRIVER&&a.emit("x.hub.peripheralman.ADD_SEIRAL",b)};e.prototype._onRemoveUsbDevice=function(a){for(var d=this._peripherals.length,c=!1,b=null;d;)if(d--,b=this._peripherals[d],this._isSameDev(b.info,a.info)){c=!0;break}c&&this._peripherals.splice(d,1);a=require("x.hub.eventbus.js");switch(b.type){case "enocean":this._logger.log("debug","remove enocean stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_ENOCEAN",b);break;case "zwave":this._logger.log("debug",
"remove zwave stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_ZWAVE",b);break;case "zigbee":this._logger.log("debug","remove zigbee stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_ZIGBEE",b);break;case "wlan":this._logger.log("debug","remove wlan stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_WLAN",b);break;case "mbus":this._logger.log("debug","remove mbus port: "+JSON.stringify(b)),a.emit("x.hub.peripheralman.REMOVE_MBUS",b)}b&&b.info&&b.info.ID_USB_DRIVER&&
a.emit("x.hub.peripheralman.REMOVE_SEIRAL",b)};return e}();
x.hub.peripheralman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.Handler");this.peripheralManager=new x.hub.peripheralman.PeripheralManager};e.prototype.PeripheralManager=x.hub.peripheralman.PeripheralManager;e.prototype.init=function(a,d,c){this.peripheralManager.init(c)};e.prototype.getUSBDevices=function(a){var d=this.peripheralManager.getUSBDevices();a&&a({data:d})};e.prototype.getUSBDevicesShortInfo=function(a){for(var d=this.peripheralManager.getUSBDevices(),
c=[],b=0;b<d.length;b++){var f=d[b];f.type&&c.push({port:f.port,type:f.type,model:f.info?f.info.ID_MODEL:null,serial:f.info?f.info.ID_SERIAL:null,vendor:f.info?f.info.ID_VENDOR:null})}a&&a({data:c})};return e}();module.exports=new x.hub.peripheralman.Handler;
