var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.scriptman=x.hub.scriptman||{};x.hub.scriptman.Error=function(h,a){Error.call(this,h);this.code=a};util.inherits(x.hub.scriptman.Error,Error);
x.hub.scriptman.Hashids=function(){function h(a,b,c){this.version="1.0.1";this.minAlphabetLength=16;this.sepDiv=3.5;this.guardDiv=12;this.errorAlphabetLength="error: alphabet must contain at least X unique characters";this.errorAlphabetSpace="error: alphabet cannot contain spaces";this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";this.seps="cfhistuCFHISTU";this.minHashLength=0<parseInt(b,10)?b:0;this.salt="string"===typeof a?a:"";"string"===typeof c&&(this.alphabet=c);
c="";a=0;for(b=this.alphabet.length;a!==b;a++)-1===c.indexOf(this.alphabet[a])&&(c+=this.alphabet[a]);this.alphabet=c;if(this.alphabet.length<this.minAlphabetLength)throw this.errorAlphabetLength.replace("X",this.minAlphabetLength);if(-1!==this.alphabet.search(" "))throw this.errorAlphabetSpace;a=0;for(b=this.seps.length;a!==b;a++)c=this.alphabet.indexOf(this.seps[a]),-1===c?this.seps=this.seps.substr(0,a)+" "+this.seps.substr(a+1):this.alphabet=this.alphabet.substr(0,c)+" "+this.alphabet.substr(c+
1);this.alphabet=this.alphabet.replace(/ /g,"");this.seps=this.seps.replace(/ /g,"");this.seps=this.consistentShuffle(this.seps,this.salt);if(!this.seps.length||this.alphabet.length/this.seps.length>this.sepDiv)a=Math.ceil(this.alphabet.length/this.sepDiv),1===a&&a++,a>this.seps.length?(a-=this.seps.length,this.seps+=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a)):this.seps=this.seps.substr(0,a);this.alphabet=this.consistentShuffle(this.alphabet,this.salt);a=Math.ceil(this.alphabet.length/
this.guardDiv);3>this.alphabet.length?(this.guards=this.seps.substr(0,a),this.seps=this.seps.substr(a)):(this.guards=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a))}h.prototype.encode=function(){var a,b=Array.prototype.slice.call(arguments);if(!b.length)return"";b[0]instanceof Array&&(b=b[0]);var c=0;for(a=b.length;c!==a;c++)if("number"!==typeof b[c]||0!==b[c]%1||0>b[c])return"";return this._encode(b)};h.prototype.decode=function(a){var b=[];return a.length&&"string"===typeof a?this._decode(a,
this.alphabet):b};h.prototype.encodeHex=function(a){var b;a=a.toString();if(!/^[0-9a-fA-F]+$/.test(a))return"";var c=a.match(/[\w\W]{1,12}/g);a=0;for(b=c.length;a!==b;a++)c[a]=parseInt("1"+c[a],16);return this.encode.apply(this,c)};h.prototype.decodeHex=function(a){var b=[],c,f=this.decode(a);a=0;for(c=f.length;a!==c;a++)b+=f[a].toString(16).substr(1);return b};h.prototype._encode=function(a){var b,c,f,d=this.alphabet,e=a.length;var g=f=0;for(c=a.length;g!==c;g++)f+=a[g]%(g+100);var k=b=d[f%d.length];
g=0;for(c=a.length;g!==c;g++){var l=a[g];var m=k+this.salt+d;d=this.consistentShuffle(d,m.substr(0,d.length));m=this.hash(l,d);b+=m;g+1<e&&(l%=m.charCodeAt(0)+g,l%=this.seps.length,b+=this.seps[l])}b.length<this.minHashLength&&(a=(f+b[0].charCodeAt(0))%this.guards.length,a=this.guards[a],b=a+b,b.length<this.minHashLength&&(a=(f+b[2].charCodeAt(0))%this.guards.length,a=this.guards[a],b+=a));for(f=parseInt(d.length/2,10);b.length<this.minHashLength;)d=this.consistentShuffle(d,d),b=d.substr(f)+b+d.substr(0,
f),a=b.length-this.minHashLength,0<a&&(b=b.substr(a/2,this.minHashLength));return b};h.prototype._decode=function(a,b){var c=[],f=0;var d=new RegExp("["+this.guards+"]","g");var e=a.replace(d," ");var g=e.split(" ");if(3===g.length||2===g.length)f=1;e=g[f];if("undefined"!==typeof e[0]){var k=e[0];e=e.substr(1);d=new RegExp("["+this.seps+"]","g");e=e.replace(d," ");g=e.split(" ");f=0;for(d=g.length;f!==d;f++){e=g[f];var l=k+this.salt+b;b=this.consistentShuffle(b,l.substr(0,b.length));c.push(this.unhash(e,
b))}this._encode(c)!==a&&(c=[])}return c};h.prototype.consistentShuffle=function(a,b){var c,f,d;if(!b.length)return a;var e=a.length-1;for(d=f=0;0<e;e--,f++){f%=b.length;d+=c=b[f].charCodeAt(0);c=(c+f+d)%e;var g=a[c];a=a.substr(0,c)+a[e]+a.substr(c+1);a=a.substr(0,e)+g+a.substr(e+1)}return a};h.prototype.hash=function(a,b){var c="",f=b.length;do c=b[a%f]+c,a=parseInt(a/f,10);while(a);return c};h.prototype.unhash=function(a,b){var c=0,f;for(f=0;f<a.length;f++){var d=b.indexOf(a[f]);c+=d*Math.pow(b.length,
a.length-f-1)}return c};"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define(function(){return h});return h}();
x.hub.scriptman.Debugger=function(){var h=function(a){this._ws=a;this._executor=null;var b=this;a.on("message",function(c,f){});a.on("error",function(c){});a.on("close",function(c,f){b._ws=null;b._executor&&x.hub.scriptman.ScriptExecutorService.stop(b._executor._id)})};h.prototype.onStart=function(a){this._executor=a;this._ws&&this._ws.send(JSON.stringify({type:"start"}))};h.prototype.onError=function(a){this._ws&&(this._ws.send(JSON.stringify({type:"error",message:a.message})),this._ws&&this._ws.close(),
this._ws=null)};h.prototype.onSTDOutMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stdout",message:a}))};h.prototype.onSTDErrMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stderr",message:a}))};h.prototype.onFinish=function(){this._ws&&(this._ws.send(JSON.stringify({type:"finish"})),this._ws.close(),this._ws=null)};return h}();
x.hub.scriptman.Executor=function(){var h=function(a,b,c,f){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Executor");this._id=(new x.hub.scriptman.Hashids).encode((new Date).getTime());this._executorService=a;this.scriptInfo=b;this.callback=c;this.finishCallback=f;this._debugListener=this._childProcess=null;this._jsonrpcRequests=[]};h.prototype.isForScript=function(a){return a&&this.scriptInfo&&a.id==this.scriptInfo.id};h.prototype.setDebugListener=function(a){this._debugListener=
a};h.prototype.start=function(a){this._logger.log("debug","start script:"+this.scriptInfo.id);var b=this;this._processJsFile(a,function(c,f){c&&b._logger.log("warn","process script file:"+b.scriptInfo.id+" error:"+c.message);if(c||!f)b._executorService._removeExecutor(b),b.callback&&(b.callback(c?c:Error("js file path is empty")),b.callback=null),b._debugListener&&(b._debugListener.onError(c?c:Error("js file path is empty")),b._debugListener=null);else{var d=[];process.execArgv.forEach(function(e){-1==
e.indexOf("--debug")&&d.push(e)});process.execArgv=d;c=require("x.hub.scriptman.js").httpServer.address().port;b._logger.log("trace","start child process for script:"+b.scriptInfo.id);b._logger.log("trace","callback port:"+c);f=require("child_process").fork(f,[c],{silent:!0});f.stdout.setEncoding("utf8");f.stderr.setEncoding("utf8");f.stdout.on("data",function(e){b._logger.log("trace","stdout data:"+e);b._logger.log("debug",e);process.stdout.write(e);b._debugListener&&b._debugListener.onSTDOutMessage(e)});
f.stdout.on("error",function(e){b._logger.log("trace","stdout error:"+e.stack);console.error("child process stdout error",e);b._debugListener&&b._debugListener.onError(e)});f.stderr.on("data",function(e){b._logger.log("trace","stderr data:"+e);b._logger.log("debug",e);process.stderr.write(e);b._debugListener&&b._debugListener.onSTDErrMessage(e)});f.stderr.on("error",function(e){b._logger.log("trace","stderr error:"+e.stack);console.error("child process stderr error",e);b._debugListener&&b._debugListener.onError(e)});
f.on("message",function(e){b._onChildprocessMessage(e)});f.on("error",function(e){b._logger.log("error","child process error:"+e.stack);console.error("child process error",e);b._onProcessExit(e);b._debugListener&&b._debugListener.onError(e)});f.on("exit",function(e,g){b._logger.log("trace","child process exit for script:"+b.scriptInfo.id);console.log("child process exit",e,g);b._onProcessExit();b._debugListener&&b._debugListener.onFinish()});b._childProcess=f;b._debugListener&&b._debugListener.onStart(b);
b.callback&&b.callback();b.callback=null}})};h.prototype.stop=function(){this._childProcess&&this._childProcess.kill();this.callback&&this.callback(Error("interrupted"));this.callback=null;this.finishCallback&&this.finishCallback(Error("canceled"));this.finishCallback=null};h.prototype.toJSON=function(){return{id:this._id,scriptInfo:this.scriptInfo,debug:this._debugListener?!0:!1}};h.prototype._onProcessExit=function(a){this._logger.log("debug","finish execute script:"+this.scriptInfo.id+(a?"with error:"+
a.message:""));this._executorService._removeExecutor(this);this.finishCallback&&this.finishCallback()};h.prototype._processJsFile=function(a,b){var c=require("fs"),f=require("path"),d=f.resolve(__dirname,"runner.js"),e=require("loop-protect");e.method="protect";c.readFile(d,{encoding:"utf8"},function(g,k){if(g)b(g);else{g=k.replace("//%CODE",a);g=e.rewriteLoops(g);var l=require("os").tmpdir()+f.sep+"_runner_"+(new Date).getTime()+".js";c.writeFile(l,g,function(m){b(m,l)})}})};h.prototype._onChildprocessMessage=
function(a){this._logger.log("trace","child process message:"+JSON.stringify(a));a&&"2.0"==a.jsonrpc?this._onChildProcessJsonRPC(a):"win32"==process.platform&&(a&&a.log?(process.stdout.write(JSON.stringify(a.log)),this._debugListener&&this._debugListener.onSTDOutMessage(a.log)):a&&a.error&&(process.stderr.write(JSON.stringify(a.error)),this._debugListener&&this._debugListener.onSTDErrMessage(a.error)))};h.prototype._onChildProcessJsonRPC=function(a){};return h}();
x.hub.scriptman.ScriptExecutorService={_executors:[],execute:function(h,a,b,c){h&&a?(h=new x.hub.scriptman.Executor(this,h,b,c),this._executors.push(h),h.start(a)):b&&b(Error("argument invalid"))},debug:function(h,a,b,c){if(h&&a)h=new x.hub.scriptman.Executor(this,h,c),h.setDebugListener(b),this._executors.push(h),h.start(a);else b.onError(Error("argument invalid"))},stop:function(h,a){if(h){for(var b=[],c=null,f=0;f<this._executors.length;f++)this._executors[f]&&this._executors[f]._id==h?c=this._executors[f]:
this._executors[f]&&b.push(this._executors[f]);this._executors=b;c&&c.stop();a&&a()}else a&&a(Error("argument invalid"))},stopScript:function(h,a){if(h){for(var b=[],c=0;c<this._executors.length;c++)this._executors[c]&&this._executors[c].isForScript(h)?this._executors[c].stop():this._executors[c]&&b.push(this._executors[c]);this._executors=b;a&&a()}else a&&a(Error("argument invalid"))},getAllRunning:function(){var h=[];this._executors.forEach(function(a){h.push(a.toJSON())});return h},_removeExecutor:function(h){for(var a=
-1,b=0;b<this._executors.length;b++)if(this._executors[b]===h){a=b;break}-1!=a&&this._executors.splice(a,1)}};
x.hub.scriptman.ScriptExecutorService2=function(){var h=function(b,c){this._executor=b;this._request=c};h.prototype.execute=function(){if(this._request&&this._request.method){var b=this,c=require("x.hub.scriptman.js");switch(this._request.method){case "executeCommand":case "getStatus":case "executeMacro":c._doCallback(this._request.params,function(f,d){var e=null;f&&(e={},e.message=f instanceof Error?f.message:f,e.code=f.code?f.code:0);b._finishWithResponse(e,d)});break;default:this._finishWithResponse({code:-32601,
message:"Method not found"})}}else this._finishWithResponse({code:-32600,message:"Invalid Request"})};h.prototype._finishWithResponse=function(b,c){b={jsonrpc:"2.0",id:this._request.id,error:b,result:c};this._executor&&this._executor._childProcess&&this._executor._childProcess.send(b);this._executor&&this._executor._jsonrpcRequests&&(b=this._executor._jsonrpcRequests.indexOf(this),-1!=b&&this._executor._jsonrpcRequests.splice(b,1))};var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptExecutorService2");
this._childProcess=null;this._jsonrpcRequests=[];this._start()};a.prototype.execute=function(b,c,f,d){if(b&&c)if(this._childProcess){this._logger.log("debug","start script:"+b.id);var e=this;this._processJsFile(c,function(g,k){g&&e._logger.log("warn","process script file:"+b.id+" error:"+g.message);g||!k?f&&f(g?g:Error("js file path is empty")):(e._childProcess.send({runScript:k}),f&&f(),d&&d())})}else f&&f(Error("child process is null"));else f&&f(Error("argument invalid"))};a.prototype.execute2=
function(b,c,f){b?this._childProcess?(this._logger.log("debug","start script:"+b),this._childProcess.send({runScript:b}),c&&c(),f&&f()):c&&c(Error("child process is null")):c&&c(Error("argument invalid"))};a.prototype.stopScript=function(b,c){b?c&&c():c&&c(Error("argument invalid"))};a.prototype._processJsFile=function(b,c){var f=require("fs"),d=require("path"),e=d.resolve(__dirname,"runner2.js"),g=require("loop-protect");g.method="protect";f.readFile(e,{encoding:"utf8"},function(k,l){if(k)c(k);else{k=
l.replace("//%CODE",b);k=g.rewriteLoops(k);var m=require("os").tmpdir()+d.sep+"_runner_"+(new Date).getTime()+".js";f.writeFile(m,k,function(n){c(n,m)})}})};a.prototype._start=function(b){require("fs");var c=require("path").resolve(__dirname,"script_executor.js"),f=[];process.execArgv.forEach(function(g){-1==g.indexOf("--debug")&&-1==g.indexOf("--inspect")&&f.push(g)});process.execArgv=f;this._logger.log("trace","start js executor child process");var d=this,e=require("child_process").fork(c,[],{silent:!0});
e.stdout.setEncoding("utf8");e.stderr.setEncoding("utf8");e.stdout.on("data",function(g){d._logger.log("trace","stdout data:"+g);d._logger.log("debug",g);process.stdout.write(g)});e.stdout.on("error",function(g){d._logger.log("trace","stdout error:"+g.stack);console.error("child process stdout error",g)});e.stderr.on("data",function(g){d._logger.log("trace","stderr data:"+g);d._logger.log("debug",g);process.env.DEBUG?process.stdout.write(g):process.stderr.write(g)});e.stderr.on("error",function(g){d._logger.log("trace",
"stderr error:"+g.stack);console.error("child process stderr error",g)});e.on("message",function(g){d._onChildprocessMessage(g)});e.on("error",function(g){d._logger.log("error","child process error:"+g.stack);console.error("child process error",g);e.__closed||(e.__closed=!0,d._onProcessExit(g))});e.on("exit",function(g,k){d._logger.log("trace","child process exit for script executor");console.log("child process exit",g,k);e.__closed||(e.__closed=!0,d._onProcessExit())});this._childProcess=e;b&&b()};
a.prototype._onChildprocessMessage=function(b){this._logger.log("trace","child process message:"+JSON.stringify(b));b&&"2.0"==b.jsonrpc?this._onChildProcessJsonRPC(b):"win32"==process.platform&&(b&&b.log?process.stdout.write(JSON.stringify(b.log)):b&&b.error&&process.stderr.write(JSON.stringify(b.error)))};a.prototype._onChildProcessJsonRPC=function(b){b=new h(this,b);this._jsonrpcRequests.push(b);b.execute()};a.prototype._onProcessExit=function(b){this._logger.log("debug","script executor finished"+
(b?" with error:"+b.message:""));this._start()};return a}();
x.hub.scriptman.ScriptManager=function(){var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptManager");this._scripts=[];this._service=x.hub.scriptman.ScriptExecutorService;this._service2=new x.hub.scriptman.ScriptExecutorService2};h.FOLDER_NAME="scripts";h.FILE_NAME="sm.json";h.prototype.init=function(a){var b=this._getScriptIndexFile(),c=this;require("fs-extra").ensureFile(b,function(f){f?a&&a(f):c._loadData(function(d,e){d?a&&a(d):(c._scripts=e,c._sort(),a&&a())})})};
h.prototype.reload=function(a){this.init(a)};h.prototype.createScript=function(a,b,c){if(a){for(var f=1,d=-1,e=1,g=0;g<this._scripts.length;g++)if(this._scripts[g].id>f){e=f;d=g;break}else f++;-1==d&&(e=f,d=this._scripts.length);var k=this,l={id:e,name:a,file:e};this._writeScript(e,b,function(m){m?c&&c(m):(k._scripts.splice(d,0,l),k._writeData(function(n){n&&k._scripts.splice(d,1);c&&c(n,l)}))})}else c&&c(Error("name is null"))};h.prototype.readScriptContent=function(a,b){if(a){for(var c=null,f=0;f<
this._scripts.length;f++){var d=this._scripts[f];if(d.id==a){c=d;break}}c?this._readScript(a,function(e,g){b&&b(e,g)}):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};h.prototype.readAllScripts=function(a){a&&a(null,this._scripts)};h.prototype.updateScript=function(a,b,c,f){if(a){for(var d=null,e=0;e<this._scripts.length;e++){var g=this._scripts[e];if(g.id==a){d=g;break}}if(d){var k=this;this._writeScript(a,c,function(l){l?f&&f(l):b&&d.name!=b?(d.name=b,k._writeData(f)):
f&&f()})}else f&&f(Error("no such script with id:"+a))}else f&&f(Error("script id is null"))};h.prototype.deleteScript=function(a,b){if(a){for(var c=-1,f=null,d=0;d<this._scripts.length;d++){var e=this._scripts[d];if(e.id==a){c=d;f=e;break}}var g=this;this.stopScript(a);this._deleteScript(a,function(k){k?b&&b(k):(g._scripts.splice(c,1),g._writeData(function(l){l&&g._scripts.splice(c,0,f);b&&b(l)}))})}else b&&b(Error("script id is null"))};h.prototype.runScript=function(a,b,c){if(a){for(var f=null,
d=0;d<this._scripts.length;d++){var e=this._scripts[d];if(e.id==a){f=e;break}}f?(f=require("path"),a+="",d=this._getScriptDir(),a=f.resolve(d,a),this._service2.execute2(a,b,c)):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};h.prototype.debugScript=function(a,b,c){if(a){for(var f=null,d=0;d<this._scripts.length;d++){var e=this._scripts[d];if(e.id==a){f=e;break}}if(f){var g=this;this.readScriptContent(a,function(k,l){if(k)b.onError(k);else g._service.debug(f,l,b,c)})}else b.onError(Error("no such script with id:"+
a))}else b.onError(Error("script id is null"))};h.prototype.stopScript=function(a,b){if(a){for(var c=[],f=0;f<this._scripts.length;f++){var d=this._scripts[f];if(d.id==a){c.push(d);break}}if(0==c.length)b&&b(Error("no such script with id:"+a));else{var e=this,g=0,k=function(){g++;g>=c.length?b&&b():e._service.stopScript(c[g],k)};this._service2.stopScript(c[g],k)}}else b&&b(Error("script id is null"))};h.prototype.deleteAllScripts=function(a){for(var b=0;b<this._scripts.length;b++)this.stopScript(this._scripts[b].id);
var c=this;this._scripts=[];this._writeData(function(f){f?a&&a(f):c._emptyScriptFolder(function(d){a&&a(d)})})};h.prototype._getScriptDir=function(){var a=require("path"),b=require("x.hub.fileman.js").fileManager.getUserRootDataPath();return a.resolve(b,h.FOLDER_NAME)};h.prototype._getScriptIndexFile=function(){var a=require("path"),b=this._getScriptDir();return a.resolve(b,h.FILE_NAME)};h.prototype._writeData=function(a){var b=this._scripts,c=require("fs"),f=this._getScriptIndexFile();c.writeFile(f,
JSON.stringify(b,null,2),function(d){a&&a(d)})};h.prototype._loadData=function(a){var b=require("path"),c=require("fs"),f=this._getScriptDir();b=b.resolve(f,h.FILE_NAME);c.readFile(b,"utf8",function(d,e){if(d)a&&a(d);else if(e)try{a&&a(null,JSON.parse(e))}catch(g){a&&a(g)}else a&&a(null,[])})};h.prototype._writeScript=function(a,b,c){var f=require("fs-extra"),d=require("path");a+="";var e=this._getScriptDir();a=d.resolve(e,a);f.writeFile(a,b,function(g){c&&c(g)})};h.prototype._readScript=function(a,
b){var c=require("fs-extra"),f=require("path");a+="";var d=this._getScriptDir();a=f.resolve(d,a);c.readFile(a,"utf8",function(e,g){b&&b(e,g)})};h.prototype._deleteScript=function(a,b){var c=require("fs-extra"),f=require("path");a+="";var d=this._getScriptDir();a=f.resolve(d,a);c.remove(a,function(e){b&&b(e)})};h.prototype._emptyScriptFolder=function(a){var b=require("fs-extra");require("path");var c=this._getScriptDir();b.emptyDir(c,function(f){a&&a(f)})};h.prototype._sort=function(){var a=this._scripts.length-
1;do{var b=!1;for(var c=0;c<a;++c)this._scripts[c].id>this._scripts[c+1].id&&(b=this._scripts[c],this._scripts[c]=this._scripts[c+1],this._scripts[c+1]=b,b=!0)}while(b)};return h}();
x.hub.scriptman.Handler=function(){var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Handler");this.scriptManager=new x.hub.scriptman.ScriptManager;this.httpServer=null};h.prototype.ScriptManager=x.hub.scriptman.ScriptManager;h.prototype.init=function(a,b,c){"CA"==global.HARDWARE_VERSION?this._configNew(a,b):this._config(a,b);this.scriptManager.init(c)};h.prototype._configNew=function(a,b){var c=this;this.httpServer=b;var f=require("url");a=new (require("ws").Server)({server:b,
path:"/xhub/script/debug"});a.on("connection",function(d){var e=f.parse(d.upgradeReq.url,!0);e.query&&e.query.id?(d=new x.hub.scriptman.Debugger(d),c.scriptManager.debugScript(e.query.id,d)):(d.send(JSON.stringify({type:"error",message:"no script id"})),d.close())});a.on("error",function(d){c._logger.log("warn","script web socket server error:"+d.stack)});a=require("x.hub.js").getServer();a.addRoute("/xhub/script/do",{method:"GET"},function(d,e){(d=d.query.id)?c.scriptManager.runScript(d,function(g){e.send(c._toRestfulResponse(g,
"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script/stop",{method:"GET"},function(d,e){(d=d.query.id)?x.hub.scriptman.ScriptExecutorService.stop(d,function(g){e.send(c._toRestfulResponse(g,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no executor id")))});a.addRoute("/xhub/script/running",{method:"GET"},function(d,e){d=x.hub.scriptman.ScriptExecutorService.getAllRunning();e.send(c._toRestfulResponse(null,d))});a.addRoute("/xhub/script/callback",
{method:"POST"},function(d,e){(d=d.body)?c._doCallback(d,function(g,k){e.send(c._toRestfulResponse(g,k))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no callback body")))});a.addRoute("/xhub/scripts",{method:"GET"},function(d,e){c.scriptManager.readAllScripts(function(g,k){g?e.send(c._toRestfulResponse(g)):e.json(k)})});a.addRoute("/xhub/script",{method:"POST",body:"text"},function(d,e){var g=d.query.name;g?c.scriptManager.createScript(g,d.body,function(k,l){e.send(c._toRestfulResponse(k,
l))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script name")))});a.addRoute("/xhub/script",{method:"GET"},function(d,e){(d=d.query.id)?c.scriptManager.readScriptContent(d,function(g,k){g?e.send(c._toRestfulResponse(g)):e.send(k)}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script",{method:"PUT",body:"text"},function(d,e){var g=d.query.id;g?c.scriptManager.updateScript(g,d.query.name,d.body,function(k){e.send(c._toRestfulResponse(k,
"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script",{method:"DELETE"},function(d,e){(d=d.query.id)?c.scriptManager.deleteScript(d,function(g){e.send(c._toRestfulResponse(g,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))})};h.prototype._config=function(a,b){var c=this;this.httpServer=b;var f=require("url");b=new (require("ws").Server)({server:b,path:"/xhub/script/debug"});b.on("connection",function(d){var e=f.parse(d.upgradeReq.url,
!0);e.query&&e.query.id?(d=new x.hub.scriptman.Debugger(d),c.scriptManager.debugScript(e.query.id,d)):(d.send(JSON.stringify({type:"error",message:"no script id"})),d.close())});b.on("error",function(d){c._logger.log("warn","script web socket server error:"+d.stack)});b=require("body-parser");a.use("/xhub/script/callback",b.json({limit:"50mb"}));a.use("/xhub/script",b.text({limit:"50mb"}));a.post("/xhub/script",function(d,e){var g=d.query.name;g?c.scriptManager.createScript(g,d.body,function(k,l){e.send(c._toRestfulResponse(k,
l))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script name")))}.bind(this));a.get("/xhub/script",function(d,e){(d=d.query.id)?c.scriptManager.readScriptContent(d,function(g,k){g?e.send(c._toRestfulResponse(g)):e.send(k)}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/scripts",function(d,e){c.scriptManager.readAllScripts(function(g,k){g?e.send(c._toRestfulResponse(g)):e.send(JSON.stringify(k))})}.bind(this));a.put("/xhub/script",
function(d,e){var g=d.query.id;g?c.scriptManager.updateScript(g,d.query.name,d.body,function(k){e.send(c._toRestfulResponse(k,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.delete("/xhub/script",function(d,e){(d=d.query.id)?c.scriptManager.deleteScript(d,function(g){e.send(c._toRestfulResponse(g,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/do",function(d,e){(d=d.query.id)?c.scriptManager.runScript(d,
function(g){e.send(c._toRestfulResponse(g,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/stop",function(d,e){(d=d.query.id)?x.hub.scriptman.ScriptExecutorService.stop(d,function(g){e.send(c._toRestfulResponse(g,"ok"))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no executor id")))}.bind(this));a.get("/xhub/script/running",function(d,e){d=x.hub.scriptman.ScriptExecutorService.getAllRunning();e.send(c._toRestfulResponse(null,
d))}.bind(this));a.post("/xhub/script/callback",function(d,e){(d=d.body)?c._doCallback(d,function(g,k){e.headersSent||e.send(c._toRestfulResponse(g,k))}):e.send(c._toRestfulResponse(new x.hub.scriptman.Error("no callback body")))}.bind(this))};h.prototype._toRestfulResponse=function(a,b){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:b}};h.prototype._doCallback=function(a,b){this._logger.log("trace","do callback:"+JSON.stringify(a));var c=require("x.hub.commandman.js").commandHandler;
"executeCommand"==a.func?a.device&&a.command&&a.device.device&&a.device.room?c.executeCommandWithRef(a.device.room,a.device.device,null,a.command,function(f){b&&b(f.error,f.data)}):b&&b(Error("execute command argument invalid")):"getStatus"==a.func?a.device&&a.status&&a.device.device&&a.device.room?c.getStateWithRef(a.device.room,a.device.device,null,a.status,function(f){b&&b(f.error,f.data)}):b&&b(Error("get status argument invalid")):"executeMacro"==a.func?a.groupName&&a.macroName?require("x.hub.macroman.js").execute(a.groupName,
a.macroName,function(f){b&&b(f.error,f.data)}):b&&b(Error("execute macro argument invalid")):b&&b()};return h}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.scriptman.Handler);
