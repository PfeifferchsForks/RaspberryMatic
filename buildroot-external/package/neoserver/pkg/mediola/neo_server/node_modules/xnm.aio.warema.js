var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.warema=xnm.aio.warema||{};
xnm.aio.warema.WebControl=function(){var h={_buffer:[],addComm:function(a){this._buffer.push(a)},removeComm:function(a){a=this._buffer.indexOf(a);-1!=a&&this._buffer.splice(a)},finalize:function(){for(var a=0;a<this._buffer.length;a++)this._buffer[a]&&this._buffer[a].close();this._buffer=[]}},l=function(a){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl.Comm");this._listener=a;this._connectCallbacks=[];this._port=this._host=null;this._packetBuffer=[];this._status=0;this._timeout=
1E3;this._responseTimeout=2E3;this._idleTimeout=15E3;this._idleTO=null;this._cnt=0;this._socket=null};l.prototype.connect=function(a,b,c){if(2==this._status)c&&c();else if(c&&-1==this._connectCallbacks.indexOf(c)&&this._connectCallbacks.push(c),1!=this._status){this._host=a;this._port=b;this._logger.log("trace","connect socket:"+this._host);var e=this;a={port:this._port,host:this._host};var d=require("net").connect(a);d.setTimeout(this._timeout);this._status=1;d.on("connect",function(){e._logger.log("trace",
"connected to warema:"+e._host);d.__disconnected||e._onSocketConnect()});d.on("data",function(f){e._logger.log("trace","receive from warema "+(d.__disconnected?"(closed)":"")+":"+e._host+" data:"+f.toString("hex"));d.__disconnected||e._onSocketData(f)});d.on("error",function(f){e._logger.log("trace","warema gateway:"+e._host+" error:"+f.message);d.__disconnected||(1==e._status?e._onSocketConnect(f):(d.destroy&&d.destroy(),d.end(),e._onSocketClose(f)))});d.on("timeout",function(){d.__disconnected||
1!=e._status||(e._logger.log("trace","warema connect:"+e._host+" timeout"),d.destroy&&d.destroy(),e._onSocketConnect(Error("connect timeout")))});d.on("close",function(){e._logger.log("trace","warema gateway:"+(d.__disconnected?"(closed)":"")+":"+e._host+" close socket");d.__disconnected||e._onSocketClose()});d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();this._socket=d}};l.prototype.close=function(){this._logger.log("trace","close socket");this._socket&&(this._socket.__disconnected=
!0,this._socket.end());this._onSocketClose()};l.prototype.sendPacket=function(a,b){if(2!=this._status)b&&b(Error("socket not connected"));else{var c=this;this._cnt++;255<this._cnt&&(this._cnt=0);var e={cnt:this._cnt,data:a,callback:b};this._packetBuffer.push(e);e.timeout=setTimeout(function(){c._logger.log("trace","response timeout for packet:"+e.cnt);var d=c._packetBuffer.indexOf(e);-1!=d&&c._packetBuffer.splice(d,1);b&&b(Error("reponse timeout"))},this._responseTimeout);this._send(e.cnt,a)}};l.prototype._send=
function(a,b){this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);var c=this;this._idleTO=setTimeout(function(){c._logger.log("trace","idle timeout");c.close()},this._idleTimeout);a=[144,this._cnt,b.length].concat(b);this._logger.log("trace","send data:"+(new Buffer(a)).toString("hex"));this._socket&&this._socket.write(new Buffer(a))};l.prototype._onSocketConnect=function(a){this._status=a?0:2;var b=this._connectCallbacks;this._connectCallbacks=[];for(var c=0;c<b.length;c++){var e=b[c];e&&
e(a)}if(!a){var d=this;this._idleTO&&clearTimeout(this._idleTO);this._idleTO=setTimeout(function(){d._logger.log("trace","connection idle timeout");d.close()},this._idleTimeout)}a||h.addComm(this)};l.prototype._onSocketClose=function(a){this._logger.log("trace","socket closed with err:"+(a?a.message:null));h.removeComm(this);this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);this._socket&&(this._socket.__disconnected=!0);this._status=0;this._socket=null;var b=this._packetBuffer;this._packetBuffer=
[];for(var c=0;c<b.length;c++){var e=b[c];e.timeout&&clearTimeout(e.timeout);a||(a=Error("socket closed"));e.callback&&e.callback(a)}};l.prototype._onSocketData=function(a){var b=-1;if(2<a.length)for(var c=a[1],e=0;e<this._packetBuffer.length;e++){var d=this._packetBuffer[e];if(d&&d.cnt==c){d.timeout&&clearTimeout(d.timeout);b=e;d.callback&&d.callback(null,a.slice(2));break}}-1!=b&&this._packetBuffer.splice(b,1)};var g=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl");
this._host=a;this._port=b;this._port||(this._port=5E4);this._comm=new l(this);this.CommandHandler=null;this._reqBuffer=[];this._positionReqCallbacks={};this._blackList=[]};g.prototype._setPersistantData=function(a){};g.prototype._getString=function(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b};g.prototype._adr2id=function(a){var b=a.split(".");a=parseInt(b[0]);b=parseInt(b[1]);return{roomid:a,deviceid:b}};g.prototype._sendRequest=function(a,b){var c=this;this._comm.connect(this._host,
this._port,function(e){e?b&&b(e):c._comm.sendPacket(a,function(d,f){d?b&&b(d):f?b&&b(d,f):b&&b(Error("response is null"))})})};g.prototype.POLL_MAP={33:0,35:1,103:11};g.prototype._doRequest=function(a,b){var c=this;this._sendRequest(a,function(e,d){if(e)b&&b(e);else if(3==d[0]&&52==d[1])e=Error("error message"),e.requestID=d[2],e.errorCode=d[3],b&&b(e);else if(3==d[0]&&51==d[1]){var f=c.POLL_MAP[a[0]];if(2==d[3])e=Error("gateway stack timeout"),e.errorCode=-2,b&&b(e);else{var n=function(k,m){k?b&&
b(k):51==m[1]||50==m[1]?51==m[1]&&2==m[3]||50==m[1]&&2==m[5]?(k=Error("gateway stack timeout"),k.errorCode=-2,b&&b(k)):setTimeout(function(){c._poll(a[1],a[2],f,n)},50):b&&b(null,m)};c._poll(a[1],a[2],f,n)}}else b&&b(null,d)})};g.prototype._executeNextRequest=function(){if(0!=this._reqBuffer.length){for(var a=-1,b=0;b<this._reqBuffer.length;b++){var c=this._reqBuffer[b];if(c&&c.data&&35!=c.data[0]){a=b;break}}-1==a&&(a=0);var e=this,d=this._reqBuffer[a];d.timeout&&(clearTimeout(d.timeout),d.timeout=
null);this._doRequest(d.data,function(f,n){d.callback&&d.callback(f,n);f=e._reqBuffer.indexOf(d);-1!=f&&e._reqBuffer.splice(f,1);e._executeNextRequest()})}};g.prototype._executeRequest=function(a,b){var c=this,e=this._reqBuffer.length,d={data:a,callback:b};d.timeout=setTimeout(function(){var f=c._reqBuffer.indexOf(d);-1!=f&&c._reqBuffer.splice(f,1);b&&b(Error("queue busy"))},1E4);this._reqBuffer.push(d);0==e&&this._executeNextRequest()};g.prototype._closeSocket=function(){this._comm.close()};g.prototype._getRoomDevice=
function(a,b,c){var e=this;this._doRequest([13,a,b],function(d,f){d?c&&c(d):!f||6>f[0]||14!=f[1]?c&&c(Error("response invalid")):6==f[0]?c&&c(null,null):(d={},d.name=e._getString(f.slice(7)),d.id=b,0==f[4]?(d.type="device",7==f[6]?d.type="switch":2==f[6]?d.type="blind":3==f[6]?d.type="shutter":4==f[6]?d.type="awning":4==f[5]&&5==f[6]||6==f[5]&&5==f[6]?d.type="awning_valance":22==f[5]&&5==f[6]||23==f[5]&&5==f[6]?d.type="awning_valance2":15==f[5]&&1==f[6]?d.type="window":26==f[5]&&6==f[6]&&(d.type=
"dimmer"),d.data=[f[5],f[6]]):(d.type="scene",d.data=[f[4]]),c&&c(null,d))})};g.prototype._getRoomDevices=function(a,b){var c=this,e=0,d=[],f=function(n,k){n?2==n.errorCode?b&&b(null,d):b&&b(n):k?(k.address=a+"."+k.id,d.push(k),c._getRoomDevice(a,++e,f)):b&&b(null,d)};this._getRoomDevice(a,e,f)};g.prototype._getRoom=function(a,b){var c=this;this._doRequest([3,a],function(e,d){if(e)b&&b(e);else if(!d||2>d[0]||4!=d[1])b&&b(Error("response invalid"));else if(2==d[0])b&&b(null,null);else{var f=c._getString(d.slice(3));
c._getRoomDevices(a,function(n,k){b&&b(n,n?null:{name:f,id:a,devices:k})})}})};g.prototype._poll=function(a,b,c,e){this._sendRequest([49,a,b,c],function(d,f){d?e&&e(d):f?e&&e(null,f):e&&e(Error("response invalid"))})};g.prototype._getPosition=function(a,b,c){this._executeRequest([35,a,b],function(e,d){e?c&&c(e):!d||8>d[0]||36!=d[1]?c&&c(Error("response invalid")):(e={},e.roomid=d[2],e.deviceid=d[3],e.fahrt=d[4],e.position=d[5],e.winkel=d[6],e.pos_volant1=d[7],e.pos_volant2=d[8],c&&c(null,e))})};g.prototype._control=
function(a,b,c,e,d){a=[33,a,b,c];e||(e=[255,255,255,255]);a=a.concat(e);this._executeRequest(a,function(f,n){if(f)d&&d(f);else if(n){var k=null;4==n[0]&&34==n[1]&&(k={code:n[1],roomid:n[2],deviceid:n[3],feedback:n[4]});k||(f=Error("unknow response"));d&&d(f,k)}else d&&d(Error("response is null"))})};g.prototype._comfort=function(a,b,c,e){this._executeRequest([103,a,b,c],function(d,f){if(d)e&&e(d);else if(f){var n=null;4==f[0]&&104==f[1]&&(n={code:f[1],roomid:f[2],deviceid:f[3],execution:f[4]});n||
(d=Error("unknow response"));e&&e(d,n)}else e&&e(Error("response is null"))})};g.prototype._resolveStates=function(a,b){var c=null;if(null==a)return{timeout:!0};switch(b.type){case "switch":200==a.position?c={state:"on"}:0==a.position&&(c={state:"off"});break;case "dimmer":c={};c.state=a.position/2;break;case "blind":case "shutter":case "awning":case "window":case "awning_valance":case "awning_valance2":c={};c.position=a.position/2;c.positionT=30>=c.position?"top":70<=c.position?"bottom":"middle";
c.winkel=a.winkel-127;c.posVolant1=a.pos_volant1/2;c.posVolant2=a.pos_volant2/2;break;default:return null}c&&(c.timeout=!1);return c};g.prototype._getStates=function(a,b){if(-1!=this._blackList.indexOf(a)){var c=Error("device unreachable");c.errorCode=-2;b&&b(c)}else{c=this._positionReqCallbacks[a];c||(c=[],this._positionReqCallbacks[a]=c);var e=c.length;b&&-1==c.indexOf(b)&&c.push(b);if(0==e){b=this._adr2id(a);var d=this;this._getPosition(b.roomid,b.deviceid,function(f,n){f&&-2==f.errorCode&&d._blackList.push(a);
var k=d._positionReqCallbacks[a];d._positionReqCallbacks[a]=[];for(var m=0;m<k.length;m++)k[m]&&k[m](f,n)})}}};g.prototype.getDevices=function(a){var b=this,c=0,e=[],d=function(f,n){f?1==f.errorCode?a&&a(null,e):a&&a(f):n?(e.push(n),b._getRoom(++c,d)):a&&a(null,e)};this._getRoom(c,d)};g.prototype.executeCommandCreator=function(a,b,c){if(a&&a.address)if(b){var e=a.address.split(".");if(2!=e.length)c&&c(Error("device address invalid"));else{var d=parseInt(e[0]);e=parseInt(e[1]);var f=null,n=this;if("reset"==
b.value)d=this._blackList.indexOf(a.address),-1!=d&&(this._blackList.splice(d,1),c&&c());else{switch(a.type){case "switch":switch(b.value){case "on":var k=21;break;case "off":k=22;break;case "toggle":k=10;break;default:c&&c(Error("no such command"));return}break;case "dimmer":switch(b.value){case "on":k=28;f=[0,0,0,0];break;case "off":k=24;f=[0,0,0,0];break;case "dimTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=3;f=[2*b,255,255,255];
break;default:c&&c(Error("no such command"));return}break;case "awning":case "shutter":case "window":switch(b.value){case "stepUp":this._getStates(a.address,function(m,r){m?c&&c(m):(m=n._resolveStates(r,a))?(m=m.position,0==m?c&&c():n.executeCommandCreator(a,{value:"moveTo",ext:m-.5},c)):c&&c(Error("get rolladen states return invalid"))});return;case "stepDown":this._getStates(a.address,function(m,r){m?c&&c(m):(m=n._resolveStates(r,a))?(m=m.position,0==m?c&&c():n.executeCommandCreator(a,{value:"moveTo",
ext:m+.5},c)):c&&c(Error("get rolladen states return invalid"))});return}case "blind":case "awning_valance":case "awning_valance2":switch(b.value){case "moveTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=2;f=[2*b,255,255,255];break;case "winkelTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=3;f=[255,b+127,255,255];break;case "valanceTo":if("undefined"==typeof b.ext||null==
b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=3;"awning_valance"==a.type?f=[255,255,2*b,255]:"awning_valance2"==a.type&&(f=[255,255,2*b,2*b]);break;case "stepUp":k=4;break;case "stepDown":k=5;break;case "up":k=6;break;case "down":k=7;break;case "stop":k=1;break;case "comfort":this._comfort(d,e,1,c);return;default:c&&c(Error("no such command"));return}break;case "scene":switch(b.value){case "run":k=8;break;default:c&&c(Error("no such command"));return}}this._control(d,e,k,
f,function(m,r){c&&c(m,r)})}}}else c&&c(Error("command is null"));else c&&c(Error("device format invalid"))};g.prototype.getStatesCreator=function(a,b,c){var e=function(q,p){for(var t=q.roomid+"."+q.deviceid,v=[],u=0;u<p.length;u++)if(p[u]&&p[u].id){var w="?";if(p[u]&&p[u].device&&p[u].status&&p[u].status.value){var y=p[u].status.value,x=p[u].device;if(x.address&&x.address==t){(x=q.timeout?{timeout:!0}:d._resolveStates(q,x))&&(w=x[y]);if("undefined"==typeof w||null==w)w="?";v.push({id:p[u].id,status:w})}}}return v},
d=this;this.CommandHandler=a;var f=[];for(a=0;a<b.length;a++)if(b[a]&&b[a].device){var n=b[a].device;n.address&&-1==f.indexOf(n.address)&&f.push(n.address)}var k=0,m=[],r=function(q,p){if(q&&-2==q.errorCode){var t=d._adr2id(f[k]);t.timeout=!0;(t=e(t,b))&&(m=m.concat(t))}!q&&p&&(t=e(p,b))&&(m=m.concat(t));k++;k==f.length?c&&c(null,m):d._getStates(f[k],r)};this._getStates(f[k],r)};g.prototype.toJSON=function(){return{sys:"warema",ip:this._host,port:this._port}};g.prototype.equalsTo=function(a){return a&&
a instanceof g?this._host==a._host&&this._port==a._port:!1};g.finalize=function(){h.finalize()};return g}();
xnm.aio.warema.DM=function(){var h=function(g,a){this.code=g;this.message=a;this.stack=Error().stack};h.prototype=Error();h.prototype.name="WaremaDMError";h.prototype.code=0;h.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var l={"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"state",ref:{value:"state",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",
options:["true","false"]}}]},blind:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"winkel to",ref:{value:"winkelTo",ext:"%d",extMeta:"-80-80"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"winkel",ref:{value:"winkel",ext:"%d",extMeta:"-80-80"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},shutter:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",
name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top",
"middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},
{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle",
"bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance2:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",
ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true",
"false"]}}]},window:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",
ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"run"}}]}};return{SYS:"warema",getGatewayType:function(){return[{sys:this.SYS,name:"warema WebControl",port:5E4}]},getGatewayDeviceType:function(){return[{sys:this.SYS,name:"Switch",type:"switch"},{sys:this.SYS,name:"Dimmer",type:"dimmer"},
{sys:this.SYS,name:"Blind",type:"blind"},{sys:this.SYS,name:"Shutter",type:"shutter"},{sys:this.SYS,name:"Awning",type:"awning"},{sys:this.SYS,name:"Awning with Valance",type:"awning_valance"},{sys:this.SYS,name:"Awning with 2 Valance",type:"awning_valance2"},{sys:this.SYS,name:"Scene",type:"scene"}]},createGateway:function(g,a,b){a=h.ERROR_CODE;g?g.ip?b(null,g):b(new h(a.INVALID,"ip is invalid")):b(new h(a.INVALID,"info is invalid"))},updateGateway:function(g,a,b,c){g=h.ERROR_CODE;a?a.ip?c(null,
a):c(new h(g.INVALID,"ip is invalid")):c(new h(g.INVALID,"update is invalid"))},deleteGateway:function(g,a,b){b()},createDevice:function(g,a,b){var c=h.ERROR_CODE;if(g)if(g.gateway)if(null==g.address||"undefined"==typeof g.address)b(new h(c.INVALID,"address is invalid"));else if(null==g.type||"undefined"==typeof g.type)b(new h(c.INVALID,"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===g.gateway){var d=a[e];
break}d?b(null,g):b(new h(c.NOT_FOUND,"gateway with index "+g.gateway+" not exists"))}else b(new h(c.NOT_FOUND,"gateway with index "+g.gateway+" not exists"));else b(new h(c.INVALID,"gateway is invalid"));else b(new h(c.INVALID,"info is invalid"))},updateDevice:function(g,a,b){var c=h.ERROR_CODE;if(g)if(g.gateway)if(null==g.address||"undefined"==typeof g.address)b(new h(c.INVALID,"address is invalid"));else if(null==g.type||"undefined"==typeof g.type)b(new h(c.INVALID,"type is invalid"));else if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===g.gateway){var d=a[e];break}d?b(null,g):b(new h(c.NOT_FOUND,"gateway with index "+g.gateway+" not exists"))}else b(new h(c.NOT_FOUND,"gateway with index "+g.gateway+" not exists"));else b(new h(c.INVALID,"gateway is invalid"));else b(new h(c.INVALID,"info is invalid"))},deleteDevice:function(g,a,b){b()},applyUIFilter:function(g,a,b){var c=function(n,k,m){var r=[];n.forEach(function(q){if("root"==
q.type){q=JSON.parse(JSON.stringify(q));var p=c(q.children,k,m);p&&0<p.length&&(q.children=p,r.push(q))}else{p=m.elems;if("*"==p)p=!0;else{for(var t=!1,v=0;v<p.length;v++)if(p[v]==q.type){t=!0;break}p=t}p&&(q=JSON.parse(JSON.stringify(q)),r.push(q))}});return r},e=function(n,k){var m=[],r=xnm.aio.warema.DM.getCommandStatusMap(n,b);if(r){var q=[];switch(k.catagory){case "command":r.command&&(q=c(r.command,n,k));break;case "status":r.status&&(q=c(r.status,n,k))}m=m.concat(q)}return m};if(!g.sys)return null;
var d=JSON.parse(JSON.stringify(g)),f=null;switch(a.catagory){case "command":f=e(g,a);d.command=f;break;case "status":f=e(g,a);d.status=f;break;default:return null}return f&&0!=f.length?d:null},getCommandStatusMap:function(g){return g&&g.type?l[g.type]:null}}}();xnm.aio.warema.Handler=function(){this.detectedWebControls={}};xnm.aio.warema.Handler.prototype.getStateValues=function(h,l){return(new xnm.aio.warema.WebControl).getStateValues(h.type,l)};
xnm.aio.warema.Handler.prototype.getDeviceCommandList=function(h,l,g){l=[];"Switch"==h.type&&(l.push({id:"on",cmd:"ON"}),l.push({id:"off",cmd:"OFF"}));return l};xnm.aio.warema.Handler.prototype.WebControl=xnm.aio.warema.WebControl;xnm.aio.warema.Handler.prototype.devicemanager=xnm.aio.warema.DM;xnm.aio.warema.Handler.prototype.registModule=function(h){h.register(this.devicemanager.SYS,"warema")};
xnm.aio.warema.Handler.prototype.resolveGateway=function(h){return h&&h.ip?new this.WebControl(h.ip,h.port):null};xnm.aio.warema.Handler.prototype.getDeviceCommands=function(h,l){h=(h=this.devicemanager.applyUIFilter(h,{catagory:"command",elems:"*"}))?h.command:[];l&&l(null,h)};xnm.aio.warema.Handler.prototype.getDeviceStatus=function(h,l){h=(h=this.devicemanager.applyUIFilter(h,{catagory:"status",elems:"*"}))?h.status:[];l&&l(null,h)};
xnm.aio.warema.Handler.prototype.doCommand=function(h,l,g,a){(h=this.resolveGateway(h))?h.executeCommandCreator(l,g,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.doStatus=function(h,l,g,a,b){(l=this.resolveGateway(l))?l.getStatesCreator(null,[{id:h,device:g,status:a}],function(c,e){c?b&&b(c):b&&b(null,e[0])}):b&&b(Error("gateway json format invalid"))};
xnm.aio.warema.Handler.prototype.discoveryWithTimeout=function(h,l){var g=this,a=require("x.mdns.js");a.clearRecordBuffer();a.discoverServiceWithTimeout("_ipp._tcp.local",h,function(b,c){if(b)l&&l(b);else{for(var e=[],d=0;d<c.length;d++){var f=c[d];f.target&&f.ip&&0<f.ip.length&&-1!=f.target.toLowerCase().indexOf("webcontrol")&&(f=new g.WebControl(f.ip[0]),e.push(f))}l&&l(b,e)}})};
xnm.aio.warema.Handler.prototype.getDeviceList=function(h,l){(h=this.resolveGateway(h))?h.getDevices(function(g,a){l&&l(g,a)}):l&&l(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.finalize=function(h){var l=h;setTimeout(function(){l&&(l(),l=null)},3E3);this.WebControl.finalize(function(){l&&(l(),l=null)})};xnm.aio.warema.Handler.prototype.pause=function(h){this.finalize(h)};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.warema.Handler);
