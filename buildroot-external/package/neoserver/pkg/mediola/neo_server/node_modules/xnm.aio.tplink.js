var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tplink=xnm.aio.tplink||{};xnm.aio.tplink.SmartPlug=function(a,b){this._host=a;this._port=b;this._port||(this._port=9999);this._timeout=2E3;this.CommandHandler=null};xnm.aio.tplink.SmartPlug.prototype._decryptData=function(a){var b=null;if(a&&4<a.length&&a[3]+(a[2]<<8)==a.length-4){b="";for(var c=171,d=4;d<a.length;d++){b.charCodeAt(d);var e=c^a[d];c=a[d];b+=String.fromCharCode(e)}}return b};
xnm.aio.tplink.SmartPlug.prototype._send=function(a,b){var c=[0,0,0,0];b=JSON.stringify(b);for(var d=171,e=0;e<b.length;e++){var f=b.charCodeAt(e);d=f^=d;c.push(f)}c[3]=c.length-4;c=new Buffer(c);a&&a.write(c)};
xnm.aio.tplink.SmartPlug.prototype._doRequest=function(a,b){var c=this,d=require("net").connect({port:this._port,host:this._host});d.setTimeout(this._timeout);d.on("connect",function(){c._send(d,a)});d.on("data",function(e){e=c._decryptData(e);var f=null;try{f=JSON.parse(e)}catch(g){}b&&b(f)});d.on("error",function(e){b&&b(null)});d.on("timeout",function(){d&&d.destroy();b&&b(null)});d.on("close",function(){d=null})};
xnm.aio.tplink.SmartPlug.prototype.executeCommand=function(a,b,c){var d=null;if("on"==b)d={system:{set_relay_state:{state:1}}};else if("off"==b)d={system:{set_relay_state:{state:0}}};else if("ledOn"==b)d={system:{set_led_off:{off:0}}};else if("ledOff"==b)d={system:{set_led_off:{off:1}}};else if("toggle"==b||"toggleLED"==b){var e=this;this.getState(function(f){f?"toggle"==b?"off"==f.state?e.executeCommand(a,"on",c):e.executeCommand(a,"off",c):"toggleLED"==b&&("off"==f.led?e.executeCommand(a,"ledOn",
c):e.executeCommand(a,"ledOff",c)):c&&c()})}else c&&c();d&&this._doRequest(d,function(f,g){c&&c()})};
xnm.aio.tplink.SmartPlug.prototype.getState=function(a){var b=this;this._doRequest({system:{get_sysinfo:{}}},function(c,d){var e={state:"?"};c&&c.system&&c.system.get_sysinfo?(1==c.system.get_sysinfo.relay_state?e.state="on":0==c.system.get_sysinfo.relay_state&&(e.state="off"),1==c.system.get_sysinfo.led_off?e.led="off":0==c.system.get_sysinfo.led_off&&(e.led="on"),b._doRequest({emeter:{get_realtime:{}}},function(f,g){f&&f.emeter&&f.emeter.get_realtime&&(e.current=f.emeter.get_realtime.current,e.power=
f.emeter.get_realtime.power);a&&a(e)})):a&&a(e)})};xnm.aio.tplink.SmartPlug.prototype.getStates=function(a,b,c){var d=this;this.CommandHandler=a;this.getState(function(e){device&&d.CommandHandler.setState?d.CommandHandler.setState(device.id,e.state):d.CommandHandler.receivedState&&d.CommandHandler.receivedState("tplink",d.host,e);c&&c(e)})};xnm.aio.tplink.SmartPlug.prototype.getStateValues=function(a,b){return b};xnm.aio.tplink.Handler=function(){this.detectedSmartPlugs={}};
xnm.aio.tplink.Handler.prototype.discoverSmartPlugs=function(a){};xnm.aio.tplink.Handler.prototype.SmartPlug=xnm.aio.tplink.SmartPlug;xnm.aio.tplink.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.tplink.SmartPlug).getStateValues(a.type,b)};xnm.aio.tplink.Handler.prototype.getDeviceCommandList=function(a,b,c){a=[];a.push({id:"on",cmd:"on"});a.push({id:"off",cmd:"off"});a.push({id:"toggle",cmd:"toggle"});return a};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tplink.Handler);
