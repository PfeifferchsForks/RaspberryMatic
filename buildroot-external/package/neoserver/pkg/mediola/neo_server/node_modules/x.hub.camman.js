var x=x||{};x.hub=x.hub||{};x.hub.camman=x.hub.camman||{};
x.hub.camman.CamManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.x.hub.camman.CamManager");this._folder=null};e.prototype.init=function(a,c){this._logger.log("info","init cam managaer");var b=require("fs-extra"),f=require("path");a=a.getUserRootDataPath();this._folder=f.resolve(a,"cam");b.ensureDir(this._folder,function(){c&&c()})};e.prototype.saveSnapshot=function(a,c,b){if(a&&a.deviceName&&c){var f=require("fs-extra"),g=require("path"),h=g.resolve(this._folder,
a.deviceName);f.ensureDir(h,function(d){d?b&&b(d):(d=new Date,d=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"_"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds(),d=g.resolve(h,d+".jpg"),f.move(c,d,{clobber:!0},function(k){b&&b(k)}))})}else b&&b(Error("argument error"))};e.prototype.getSnapshot=function(a,c,b){a=require("path").resolve(this._folder,a,c);b&&b(null,a)};e.prototype.getSnapshots=function(a){var c=require("fs-extra"),b=require("path"),f=this;c.readdir(this._folder,function(g,
h){if(g)a&&a(g);else{var d={},k=0,m=function(n,l){d[h[k]]=!n&&l?l:[];k++;k==h.length?a&&a(null,d):c.readdir(b.resolve(f._folder,h[k]),m)};c.readdir(b.resolve(f._folder,h[k]),m)}})};return e}();
x.hub.camman.Handler=function(){var e=function(){this.camManager=new x.hub.camman.CamManager};e.prototype.DeviceManager=x.hub.camman.CamManager;e.prototype.init=function(a,c,b){this._config(a);this.camManager.init(c,b)};e.prototype.saveSnapshot=function(a,c,b){this.camManager.saveSnapshot(a,c,b)};e.prototype._config=function(a){a.use("/xhub/cammanager/snapshots",function(c,b){this.camManager.getSnapshots(function(f,g){b.json(this._toRestfulResponse(f,g))}.bind(this))}.bind(this));a.use("/xhub/cammanager/snapshot",
function(c,b){var f=c.query.cam;c=c.query.file;f&&c?this.camManager.getSnapshot(f,c,function(g,h){g?b.status(404).end():b.sendFile(h,function(d){d&&d.statusCode&&b.status(d.statusCode).end(d.message)})}.bind(this)):b.status(404).end()}.bind(this))};e.prototype._toRestfulResponse=function(a,c){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:c}};return e}();module.exports=new x.hub.camman.Handler;
