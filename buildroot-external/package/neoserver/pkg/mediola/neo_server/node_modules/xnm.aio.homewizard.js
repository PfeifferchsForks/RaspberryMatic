var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.homewizard=xnm.aio.homewizard||{};xnm.aio.homewizard.HomeWizard=function(a,b,c){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.HomeWizard");this.ip=a;this.port=b;b||(this.port=80);this.password=c;this.CommandHandler=null};
xnm.aio.homewizard.HomeWizard.prototype._doRequest=function(a,b){var c=this,f="http://"+this.ip+":"+this.port+"/"+this.password+"/"+a;this._logger.log("trace","send to url: http://"+this.ip+":"+this.port+"/xxxxxx/"+a);var e=b;$.ajax({url:f,type:"GET",timeout:1E4,dataType:"json",success:function(d){c._logger.log("trace","http request success:"+JSON.stringify(d));e&&(e(null,d),e=null)},error:function(d,g){d="http request error:"+(d?d.status:"0")+"-"+g;c._logger.log("trace",d);e&&(e(Error(d)),e=null)}})};
xnm.aio.homewizard.HomeWizard.prototype._sendRequest=function(a,b){this._doRequest(a,function(c,f){!c&&f&&f.response&&"ok"==f.status?f&&f.response&&"ok"==f.status?b&&b(null,f.response):(f&&f.status?(c=Error(f.status),c.errCode=f.error):c=Error("response is empty"),b&&b(c)):b&&b(c)})};xnm.aio.homewizard.HomeWizard.prototype.getDevices=function(a){this._sendRequest("get-sensors",function(b,c){a&&a(b,c)})};
xnm.aio.homewizard.HomeWizard.prototype._resolveState=function(a,b){if(!a||!a.type||!b||"undefined"==typeof a.address||null==a.address)return null;var c=null;switch(a.type){case "switch":case "proswitch":case "dimmer":case "prodimmer":case "radiator":case "asun":case "somfy":var f="switches";break;case "wind":f="windmeters";break;case "rain":f="rainmeters";break;case "thermo":f="thermometers";break;case "doorbell":case "smoke":case "contact":case "motion":case "smoke868":f="kakusensors";break;case "energylink":f=
"energylinks";break;default:return null}if(b[f])for(var e=0;e<b[f].length;e++)if(b[f][e]&&a.address+""==b[f][e].id+""){var d=b[f][e];break}if(d)switch(c={},a.type){case "switch":case "proswitch":case "dimmer":case "prodimmer":case "radiator":case "asun":case "somfy":"undefined"!=typeof d.status&&null!=d.status&&(c.status=d.status);"undefined"!=typeof d.dimlevel&&null!=d.dimlevel&&(c.dimlevel=d.dimlevel);"undefined"!=typeof d.tte&&null!=d.tte&&(c.status=d.tte,c.tte=d.tte);"undefined"!=typeof d.color&&
null!=d.color&&(c.dimlevel=d.color.bri?d.color.bri:0);break;case "wind":c.windLowBat="no"!=d.lowBattery;c.windS=d.ws;d.dir&&-1!=d.dir.indexOf(" ")&&(a=d.dir.split(" "),c.windD=parseInt(a[1].trim()),c.windDS=a[0].trim());c.windGS=d.gu;c.windT=d.wc;c.windSMax=d["ws+"];c.windSMaxT=d["ws+t"];c.windSMin=d["ws-"];c.windSMinT=d["ws-t"];break;case "rain":c.rainLowBat="no"!=d.lowBattery;c.rainL=d.mm;c.rainL3h=d["3h"];break;case "thermo":c.thermoLowBat="no"!=d.lowBattery;c.thermoT=d.te;c.thermoH=d.hu;c.thermoTMax=
d["te+"];c.thermoTMaxT=d["te+t"];c.thermoTMin=d["te-"];c.thermoTMinT=d["te-t"];c.thermoHMax=d["hu+"];c.thermoHMaxT=d["hu+t"];c.thermoHMin=d["hu-"];c.thermoHMinT=d["hu-t"];break;case "doorbell":c.doorbellE=d.status?"ring":"none";c.doorbellET=d.timestamp;break;case "smoke":case "smoke868":c.smokeE=d.status?"alarm":"ok";c.smokeET=d.timestamp;break;case "motion":c.motionE=d.status&&"no"!=d.status?"on":"off";c.motionET=d.timestamp;break;case "contact":c.contactE=d.status?"open":"closed";c.contactET=d.timestamp;
break;case "energylink":d.s1&&(c.s1Value=d.s1.po,c.s1TotalD=d.s1.dayTotal,c.s1Max=d.s1["po+"],c.s1MaxT=d.s1["po+t"],c.s1Min=d.s1["po-"],c.s1MinT=d.s1["po-t"]),d.s2&&(c.s2Value=d.s2.po,c.s2TotalD=d.s2.dayTotal,c.s2Max=d.s2["po+"],c.s2MaxT=d.s2["po+t"],c.s2Min=d.s2["po-"],c.s2MinT=d.s2["po-t"])}return c};
xnm.aio.homewizard.HomeWizard.prototype.executeCommand=function(a,b,c){var f=null,e=!0;if("on"==b)"switch"==a.type||"dimmer"==a.type||"radiator"==a.type||"proswitch"==a.type||"prodimmer"==a.type?f="sw/"+a.address+"/on":"scene"==a.type&&(f="gp/"+a.address+"/on");else if("off"==b)"switch"==a.type||"dimmer"==a.type||"radiator"==a.type||"proswitch"==a.type||"prodimmer"==a.type?f="sw/"+a.address+"/off":"scene"==a.type&&(f="gp/"+a.address+"/off");else if("toggle"==b){if("switch"==a.type||"dimmer"==a.type||
"proswitch"==a.type||"prodimmer"==a.type){var d=this;this.getStates(null,[a],function(g,k){f="sw/"+a.address+"/off";1==k.length&&k[0].state&&"off"==k[0].state.status&&(f="sw/"+a.address+"/on");d._sendRequest(f,function(l){c&&c(l)})});e=!1}}else if("up"==b)if("somfy"==a.type)f="sf/"+a.address+"/up";else{if("asun"==a.type||"brel"==a.type)f="sw/"+a.address+"/up"}else if("down"==b)if("somfy"==a.type)f="sf/"+a.address+"/down";else{if("asun"==a.type||"brel"==a.type)f="sw/"+a.address+"/down"}else"stop"==
b?"somfy"==a.type?f="sf/"+a.address+"/stop":"brel"==a.type&&(f="sw/"+a.address+"/stop"):(0==b.indexOf("dimTo")&&(b=b.replace(/dimTo/g,"")),0==b.indexOf("setTo")&&(b=b.replace(/setTo/g,"")),b=b.replace(/%/g,""),"dimmer"==a.type?f="sw/dim/"+a.address+"/"+b:"radiator"==a.type&&(f="sw/"+a.address+"/settarget/"+b));e&&!f?c&&c(Error("no such command")):e&&f&&this._sendRequest(f,function(g){c&&c(g)})};
xnm.aio.homewizard.HomeWizard.prototype.getStates=function(a,b,c){var f=this;this.CommandHandler=a;this._sendRequest("get-sensors",function(e,d){if(e)c&&c(e,b);else{for(e=0;e<b.length;e++){var g=f._resolveState(b[e],d);g&&(b[e].state=g)}c&&c(null,b)}})};xnm.aio.homewizard.HomeWizard.prototype.getStateValues=function(a,b){return b};
xnm.aio.homewizard.HomeWizard.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){var f=b.value;if("dimTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command dimTo ext format invalid"));return}f=b.value+b.ext}else if("setTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command setTo ext format invalid"));return}f=b.value+b.ext}this.executeCommand(a,f,function(e){c&&c(e)})}else c&&c(Error("command json format invalid"))};
xnm.aio.homewizard.HomeWizard.prototype.getStatesCreator=function(a,b,c){if(b)if(0==b.length)c&&c(null,[]);else{for(var f=[],e=0;e<b.length;e++)if(b[e]&&b[e].device){var d=JSON.parse(JSON.stringify(b[e].device));f.push(d)}this.getStates(a,f,function(g,k){for(var l=[],h=0;h<b.length;h++)if(b[h].id){var m="?";b[h].status&&b[h].status.value&&k&&k[h]&&k[h].state&&(m=k[h].state[b[h].status.value],"undefined"==typeof m||null==m)&&(m="?");l.push({id:b[h].id,status:m})}c&&c(g,l)})}else c&&c(Error("deviceList is null"))};
xnm.aio.homewizard.HomeWizard.prototype.toJSON=function(){return{sys:xnm.aio.homewizard.DM.SYS,ip:this.ip,port:this.port,password:this.password}};xnm.aio.homewizard.HomeWizard.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.homewizard.HomeWizard?this.ip==a.ip&&this.port==a.port&&this.password==a.password:!1};
xnm.aio.homewizard.DM=function(){var a=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};a.prototype=Error();a.prototype.name="HomewizardDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"homewizard",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"status",
options:["on","off"]}}]},proswitch:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"status",options:["on","off"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",
name:"status",ref:{value:"status",options:["on","off"]}},{type:"int",name:"dim level",ref:{value:"dimlevel",extMeta:"0-100"}}]},prodimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"status",ref:{value:"status",options:["on","off"]}},{type:"int",name:"dim level",ref:{value:"dimlevel",extMeta:"0-100"}}]},
radiator:{command:[{type:"enum",name:"night mode",ref:{value:"off"}},{type:"enum",name:"day mode",ref:{value:"on"}},{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-28.0",scale:"0.5"}}],status:[{type:"float",name:"temperature",ref:{value:"status",extMeta:"5.0-28.0",scale:"0.5"}}]},somfy:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},asun:{command:[{type:"enum",name:"up",ref:{value:"up"}},
{type:"enum",name:"down",ref:{value:"down"}}]},brel:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},scene:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}]},wind:{status:[{type:"enum",name:"battery low",ref:{value:"windLowBat",options:["true","false"]}},{type:"float",name:"wind speed",ref:{value:"windS"}},{type:"int",name:"wind direction",ref:{value:"windD"}},
{type:"string",name:"wind direction (string)",ref:{value:"windDS"}},{type:"float",name:"gust speed",ref:{value:"windGS"}},{type:"float",name:"wind temperature",ref:{value:"windT"}},{type:"float",name:"max wind speed",ref:{value:"windSMax"}},{type:"string",name:"max wind speed time",ref:{value:"windSMaxT"}},{type:"float",name:"min wind speed",ref:{value:"windSMin"}},{type:"string",name:"min wind speed time",ref:{value:"windSMinT"}}]},rain:{status:[{type:"enum",name:"battery low",ref:{value:"rainLowBat",
options:["true","false"]}},{type:"int",name:"rain level",ref:{value:"rainL"}},{type:"int",name:"rain level (3h)",ref:{value:"rainL3h"}}]},thermo:{status:[{type:"enum",name:"battery low",ref:{value:"thermoLowBat",options:["true","false"]}},{type:"float",name:"temperature",ref:{value:"thermoT"}},{type:"float",name:"humidity",ref:{value:"thermoH"}},{type:"float",name:"max temperature",ref:{value:"thermoTMax"}},{type:"string",name:"max temperature time",ref:{value:"thermoTMaxT"}},{type:"float",name:"min temperature",
ref:{value:"thermoTMin"}},{type:"string",name:"min temperature time",ref:{value:"thermoTMinT"}},{type:"float",name:"max humidity",ref:{value:"thermoHMax"}},{type:"string",name:"max humidity time",ref:{value:"thermoHMaxT"}},{type:"float",name:"min humidity",ref:{value:"thermoHMin"}},{type:"string",name:"min humidity time",ref:{value:"thermoHMinT"}}]},doorbell:{status:[{type:"enum",name:"last event",ref:{value:"doorbellE",options:["none","ring"]}},{type:"string",name:"last event time",ref:{value:"doorbellET"}}]},
smoke:{status:[{type:"enum",name:"last event",ref:{value:"smokeE",options:["ok","alarm"]}},{type:"string",name:"last event time",ref:{value:"smokeET"}}]},motion:{status:[{type:"enum",name:"last event",ref:{value:"motionE",options:["on","off"]}},{type:"string",name:"last event time",ref:{value:"motionET"}}]},contact:{status:[{type:"enum",name:"last event",ref:{value:"contactE",options:["open","closed"]}},{type:"string",name:"last event time",ref:{value:"contactET"}}]},energylink:{status:[{type:"float",
name:"s1 value",ref:{value:"s1Value"}},{type:"float",name:"s1 daily total",ref:{value:"s1TotalD"}},{type:"float",name:"max s1 value",ref:{value:"s1Max"}},{type:"string",name:"max s1 value time",ref:{value:"s1MaxT"}},{type:"float",name:"min s1 value",ref:{value:"s1Min"}},{type:"string",name:"min s1 value time",ref:{value:"s1MinT"}},{type:"float",name:"s2 value",ref:{value:"s2Value"}},{type:"float",name:"s2 daily total",ref:{value:"s2TotalD"}},{type:"float",name:"max s2 value",ref:{value:"s2Max"}},
{type:"string",name:"max s2 value time",ref:{value:"s2MaxT"}},{type:"float",name:"min s2 value",ref:{value:"s2Min"}},{type:"string",name:"min s2 value time",ref:{value:"s2MinT"}}]},smoke868:{status:[{type:"enum",name:"last event",ref:{value:"smokeE",options:["ok","alarm"]}},{type:"string",name:"last event time",ref:{value:"smokeET"}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"HomeWizard",port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"proswitch",name:"Switch"},{sys:this.SYS,type:"prodimmer",name:"Dimmer"},{sys:this.SYS,type:"radiator",name:"Thermostat"},{sys:this.SYS,type:"somfy",name:"Somfy Blind"},{sys:this.SYS,type:"asun",name:"ASUN Blind"}]},createGateway:function(b,c,f){c=a.ERROR_CODE;b?b.ip?b.password?f(null,b):f(new a(c.INVALID,"password is invalid")):f(new a(c.INVALID,"ip is invalid")):f(new a(c.INVALID,"info is invalid"))},updateGateway:function(b,c,f,e){b=a.ERROR_CODE;
c?c.ip?c.password?e(null,c):e(new a(b.INVALID,"password is invalid")):e(new a(b.INVALID,"ip is invalid")):e(new a(b.INVALID,"update is invalid"))},deleteGateway:function(b,c,f){f()},createDevice:function(b,c,f){var e=a.ERROR_CODE;if(b)if(b.gateway)if(null==b.address||"undefined"==typeof b.address)f(new a(e.INVALID,"address is invalid"));else if(null==b.type||"undefined"==typeof b.type)f(new a(e.INVALID,"type is invalid"));else if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;
var d;for(d=0;d<c.length;d++)if(c[d].index===b.gateway){var g=c[d];break}g?f(null,b):f(new a(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else f(new a(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else f(new a(e.INVALID,"gateway is invalid"));else f(new a(e.INVALID,"info is invalid"))},updateDevice:function(b,c,f){var e=a.ERROR_CODE;if(b)if(b.gateway)if(null==b.address||"undefined"==typeof b.address)f(new a(e.INVALID,"address is invalid"));else if(null==b.type||"undefined"==
typeof b.type)f(new a(e.INVALID,"type is invalid"));else if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var d;for(d=0;d<c.length;d++)if(c[d].index===b.gateway){var g=c[d];break}g?f(null,b):f(new a(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else f(new a(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else f(new a(e.INVALID,"gateway is invalid"));else f(new a(e.INVALID,"info is invalid"))},deleteDevice:function(b,c,f){f()},applyUIFilter:function(b,
c){var f=this,e=function(h,m){if("*"==h)return!0;for(var n=!1,p=0;p<h.length;p++)if(h[p]==m){n=!0;break}return n},d=function(h,m,n){var p=[];switch(n.catagory){case "command":h.command&&h.command.forEach(function(q){e(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});break;case "status":h.status&&h.status.forEach(function(q){e(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))})}return p},g=function(h,m){var n=[],p=f.getCommandStatusMap(h);p&&(h=d(p,h,m),n=n.concat(h));return n};
if(!b||null==b.type||"undefined"==typeof b.type)return null;var k=JSON.parse(JSON.stringify(b)),l=null;switch(c.catagory){case "command":l=g(b,c);k.command=l;break;case "status":l=g(b,c);k.status=l;break;default:return null}return l&&0!=l.length?k:null},getCommandStatusMap:function(b){return b&&b.type?this.MAP[b.type]:null}}}();xnm.aio.homewizard.Handler=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.Handler");this.detectedHomeWizards={}};
xnm.aio.homewizard.Handler.prototype.HomeWizard=xnm.aio.homewizard.HomeWizard;xnm.aio.homewizard.Handler.prototype.devicemanager=xnm.aio.homewizard.DM;xnm.aio.homewizard.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"homewizard")};xnm.aio.homewizard.Handler.prototype.resolveGateway=function(a){return a&&a.ip&&a.password?new xnm.aio.homewizard.HomeWizard(a.ip,a.port,a.password):null};
xnm.aio.homewizard.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.homewizard.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};xnm.aio.homewizard.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.homewizard.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.homewizard.Handler.prototype.doCommand=function(a,b,c,f){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){f&&f(e)}):f&&f(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.doStatus=function(a,b,c,f,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:f}],function(d,g){d?e&&e(d):e&&e(null,g[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.getDeviceList=function(a,b){if(a=this.resolveGateway(a)){var c=this;a.getDevices(function(f,e){if(f)b&&b(f);else{var d=[];e&&(e.switches&&e.switches.forEach(function(g){if(g)switch(g.type){case "switch":case "proswitch":case "dimmer":case "prodimmer":case "radiator":case "somfy":case "asun":case "brel":d.push({sys:c.devicemanager.SYS,type:g.type,address:g.id,name:g.name})}}),e.scenes&&e.scenes.forEach(function(g){g&&d.push({sys:c.devicemanager.SYS,type:"scene",
address:g.id,name:g.name})}),e.windmeters&&e.windmeters.forEach(function(g){g&&d.push({sys:c.devicemanager.SYS,type:"wind",address:g.id,name:g.name})}),e.rainmeters&&e.rainmeters.forEach(function(g){g&&d.push({sys:c.devicemanager.SYS,type:"rain",address:g.id,name:g.name})}),e.thermometers&&e.thermometers.forEach(function(g){g&&d.push({sys:c.devicemanager.SYS,type:"thermo",address:g.id,name:g.name})}),e.kakusensors&&e.kakusensors.forEach(function(g){g&&g.type&&("doorbell"==g.type||"smoke"==g.type||
"contact"==g.type||"motion"==g.type||"smoke868"==g.type)&&d.push({sys:c.devicemanager.SYS,type:g.type,address:g.id,name:g.name})}),e.energylinks&&e.energylinks.forEach(function(g){g&&d.push({sys:c.devicemanager.SYS,type:"energylink",address:g.id,name:g.name})}));b&&b(null,d)}})}else b&&b(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.discoverHomeWizards=function(a){var b=this,c=function(f,e){$.ajax({url:"http://"+f,type:"GET",timeout:2E3,success:function(d){b._logger.log("trace","local search success:"+JSON.stringify(d));e&&(e(null),e=null)},error:function(d,g){d="local search error:"+(d?d.status:"0")+"-"+g;b._logger.log("trace",d);e&&(e(Error(d)),e=null)}})};(function(f){$.ajax({url:"http://gateway.homewizard.nl/discovery.php",type:"GET",timeout:2E3,dataType:"json",success:function(e){b._logger.log("trace",
"remote search success:"+JSON.stringify(e));var d,g;e&&"ok"==e.status&&e.ip?g=e.ip:d=Error("repsonse not ok");f&&(f(d,g),f=null)},error:function(e,d){e="remote search error:"+(e?e.status:"0")+"-"+d;b._logger.log("trace",e);f&&(f(Error(e)),f=null)}})})(function(f,e){f||!e?a&&a(null,[]):c(e,function(d){d?a&&a(null,[]):a&&a(null,[new xnm.aio.homewizard.HomeWizard(e)])})})};
xnm.aio.homewizard.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.homewizard.HomeWizard).getStateValues(a.type,b)};xnm.aio.homewizard.Handler.prototype.getDeviceCommandList=function(a,b,c){a=[];b&&(a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"}));return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homewizard.Handler);
