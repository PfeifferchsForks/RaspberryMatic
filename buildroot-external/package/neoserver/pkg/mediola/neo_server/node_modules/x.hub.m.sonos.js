var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(e,c,b){if(null==e)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return e+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,c,b){if(e==Array.prototype||e==Object.prototype)return e;e[c]=b.value;return e};
$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<e.length;++c){var b=e[c];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,c){var b=$jscomp.propertyToPolyfillSymbol[c];if(null==b)return e[c];b=e[b];return void 0!==b?b:e[c]};$jscomp.polyfill=function(e,c,b,a){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,c,b,a):$jscomp.polyfillUnisolated(e,c,b,a))};
$jscomp.polyfillUnisolated=function(e,c,b,a){b=$jscomp.global;e=e.split(".");for(a=0;a<e.length-1;a++){var d=e[a];if(!(d in b))return;b=b[d]}e=e[e.length-1];a=b[e];c=c(a);c!=a&&null!=c&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(e,c,b,a){var d=e.split(".");e=1===d.length;a=d[0];a=!e&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<d.length-1;g++){var f=d[g];if(!(f in a))return;a=a[f]}d=d[d.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?a[d]:null;c=c(b);null!=c&&(e?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:c}):c!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+b+"$"+d),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("String.prototype.repeat",function(e){return e?e:function(c){var b=$jscomp.checkStringArgs(this,null,"repeat");if(0>c||1342177279<c)throw new RangeError("Invalid count value");c|=0;for(var a="";c;)if(c&1&&(a+=b),c>>>=1)b+=b;return a}},"es6","es3");var util=require("util"),EventEmitter=require("events"),x=x||{};
x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.sonos=x.hub.m.sonos||{};x.hub.m.sonos.MODULE=require("xnm.aio.sonos.js");
x.hub.m.sonos.AudioPlayer=function(){var e=function(){this._process={}};e.prototype.playFile=function(c,b,a){if(b&&b.file){var d=require("x.hub.resource.js").getFileURL(b.file,c.ip);d?(b.url=d,this.playUrl(c,b,a)):a&&a(Error("no such file"))}else a&&a(Error("invalid file"))};e.prototype.playUrl=function(c,b,a){if(b){var d=b.url;d||(d=b.ext);if(d){var g=x.hub.m.sonos.MODULE.resolveDevice(c);if(g){var f=this;this._cancelPlay(g,function(h){h?a&&a(h):f._setVolume(g,b.volume,function(k){k?a&&a(k):f._unmute(g,
function(l){l?a&&a(l):f._playUrl(g,d,function(m){m?a&&a(m):f._setRepeat(g,b.repeat,function(n){n?a&&a(n):b.repeat&&-1!=b.repeat&&(f._process[g.ip]={url:d},f._process[g.ip].timeout=setTimeout(function(){var p=f._process[g.ip].url;f._process[g.ip]=null;f._stopPlay(g,p)},1E3*parseInt(b.repeat)))})})})})});a&&a(null,1)}else a&&a(Error("invalid device json"))}else a&&a(Error("invalid url"))}else a&&a(Error("invalid command"))};e.prototype._cancelPlay=function(c,b){if(c.ip&&this._process[c.ip]){this._process[c.ip].timeout&&
clearTimeout(this._process[c.ip].timeout);var a=this._process[c.ip].url;this._process[c.ip]=null;a?this._stopPlay(c,a,b):b&&b()}else b&&b()};e.prototype._stopPlay=function(c,b,a){c.getMediaInfo(function(d,g){d||!g?c.stop(a):g.currentURI&&g.currentURI!=b?a&&a():c.stop(a)})};e.prototype._setVolume=function(c,b,a){b?c.setVolume(b,a):a&&a()};e.prototype._setRepeat=function(c,b,a){b?c.repeatOne(a):c.repeatOff(a)};e.prototype._unmute=function(c,b){c.unmute(b)};e.prototype._playUrl=function(c,b,a){b?c.playUrl(b,
a):a&&a(Error("invalid url"))};return e}();
x.hub.m.sonos.Handler=function(){var e=function(){this._audioPlayer=new x.hub.m.sonos.AudioPlayer};util.inherits(e,EventEmitter);e.prototype.init=function(c){setTimeout(function(){x.hub.m.sonos.MODULE._master._autoSearchTimeout&&clearTimeout(x.hub.m.sonos.MODULE._master._autoSearchTimeout);var b=require("xnm.aio.raumfeld.js");b.discovery._autoSearchTimeout&&clearTimeout(b.discovery._autoSearchTimeout);b=require("xnm.aio.bose.js");b.master._autoSearchTO&&clearTimeout(b.master._autoSearchTO)},15E3);
c&&c()};e.prototype.getSystems=function(){return["sonos"]};e.prototype.executeCommand=function(c,b,a){b?"playFile"==b.value?this._audioPlayer.playFile(c,b,function(d){a&&a({error:d})}):"playUrl"==b.value?this._audioPlayer.playUrl(c,b,function(d){a&&a({error:d})}):x.hub.m.sonos.MODULE.doCommand(c,b,a):a&&a({error:Error("invalid command")})};e.prototype.executeCommandV6=function(c,b,a,d){if(c&&c.address)if(a){c={sys:"sonos",ip:c.address,port:c.port};var g=x.hub.m.sonos.MODULE.resolveDevice(c);if(g)if("alarm"==
a.command)a.value&&a.value.file?(b={},b.volume=a.value.volume,b.repeat=a.value.time,a=a.value.file,"file://file/"==a.substr(0,12)?(b.value="playFile",b.file=a.substr(12),this.executeCommand(c,b,function(f){f&&f.error?d&&d(f.error):d&&d()})):(b.value="playUrl",b.url=a,this.executeCommand(c,b,function(f){f&&f.error?d&&d(f.error):d&&d()}))):(a=Error("invalid command"),a.code="000000",d&&d(a));else{b={value:null,ext:null};switch(a.command){case "pause":case "stop":case "previous":case "next":case "mute":case "unmute":b.value=
a.command;break;case "play":a.value?(b.value="playUrl",b.ext=a.value):b.value="play";break;case "volume":b.value="volume";b.ext=a.value;break;default:a=Error("unknown command");a.code="000000";d&&d(a);return}g.executeCommandCreator(c,b,function(f){f&&(f.code="000000");d&&d(f)})}else a=Error("invalid device json"),a.code="000000",d&&d(a)}else a=Error("invalid command"),a.code="000000",d&&d(a);else a=Error("invalid device json"),a.code="000000",d&&d(a)};e.prototype.getStatesV6=function(c,b,a){c&&c.address?
(c={sys:"sonos",ip:c.address,port:c.port},(b=x.hub.m.sonos.MODULE.resolveDevice(c))?b.getStatesCreator(null,[{id:"playState",device:c,status:{value:"playState"}},{id:"volume",device:c,status:{value:"volume"}},{id:"muted",device:c,status:{value:"muted"}}],function(d,g){if(d)a&&a(d);else{d={};if(g)for(var f=0;f<g.length;f++){var h=g[f];h&&("playState"==h.id&&h.status?d.state="PLAYING"==h.status?"playing":"paused":"volume"==h.id&&null!=h.status&&void 0!=h.status?d.volume=parseInt(h.status):"muted"==
h.id&&(d.muted="true"==h.status||1==h.status))}a&&a(null,d)}}):(c=Error("invalid device json"),c.code="000000",a&&a(c))):(c=Error("invalid device json"),c.code="000000",a&&a(c))};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.sonos.Handler);
