var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rehau=xnm.aio.rehau||{};
xnm.aio.rehau.Gauzy=function(){var f=function(b,a){this.address=b;this.port=a;a&&""!=a||(this.port=5E3)};f.prototype._setScene=function(b,a){this._doJsonRequest("POST","/scene",{scene:b},function(c,d){a&&a(c,d)})};f.prototype._setInvert=function(b,a){var c=this;this._getBlindStates(function(d,e){d?a&&a(d):c._setInvertAndBlindOpacity(b,e.opacity,a)})};f.prototype._setBlindPosition=function(b,a){var c=this;this._getBlindStates(function(d,e){d?a&&a(d):c._setInvertAndBlindOpacity(e.invert,b,a)})};f.prototype._setBlindOpacity=
function(b,a){var c=this;this._getBlindStates(function(d,e){d?a&&a(d):c._setInvertAndBlindOpacity(e.invert,b,a)})};f.prototype._setInvertAndBlindOpacity=function(b,a,c){this._doJsonRequest("POST","/blind",{opacity:a,invert:b},function(d,e){c&&c(d,e)})};f.prototype._setLightsensor=function(b,a){var c=this;this._getLEDStates(function(d,e){d?a&&a(d):c._setLedPaintAndLightsensor(e.ledpaint,b,a)})};f.prototype._setLedPaint=function(b,a){var c=this;this._getLEDStates(function(d,e){d?a&&a(d):c._setLedPaintAndLightsensor(b,
e.lightsensoractive,a)})};f.prototype._setLedPaintAndLightsensor=function(b,a,c){this._doJsonRequest("POST","/external",{ledpaint:b,lightsensoractive:a},function(d,e){c&&c(d,e)})};f.prototype.getAllStates=function(b){this._getAllStates(function(a,c){a?b&&b(a):(c&&(c.ledpaint=c.ledpaint?"on":"off",c.lightsensoractive=c.lightsensoractive?"on":"off",c.invert=c.invert?"on":"off"),b&&b(null,c))})};f.prototype._getAllStates=function(b){var a=function(d){[].slice.call(arguments,1).forEach(function(e){for(var g in e)d[g]=
e[g]});return d},c=this;this._getBlindStates(function(d,e){d?b&&b(d):c._getLEDStates(function(g,h){g?b&&b(g):(g=a({},h,e),b&&b(null,g))})})};f.prototype._getLEDStates=function(b){this._doJsonRequest("GET","/external",null,function(a,c){b&&b(a,c)})};f.prototype._getBlindStates=function(b){this._doJsonRequest("GET","/blind",null,function(a,c){b&&b(a,c)})};f.prototype._doJsonRequest=function(b,a,c,d){try{var e=c?JSON.stringify(c):null;this._doRequest(b,a,e,function(g,h){if(g)d&&d(g);else try{g=null,
h&&(g=JSON.parse(h)),d&&d(null,g)}catch(l){d&&d(l)}})}catch(g){d&&d(g)}};f.prototype._doRequest=function(b,a,c,d){b={host:this.address,port:this.port,path:a,method:b,headers:{"Content-Type":"application/json"}};b=require("http").request(b,function(e){e.setEncoding("utf-8");var g="";e.on("data",function(h){g+=h});e.on("end",function(){d&&d(null,g)})});c&&b.write(c);b.setTimeout&&b.setTimeout(2E3,function(){d&&d(Error("http request timeout"))});b.on("error",function(e){d&&d(e)});b.end()};f.prototype.executeCommand=
function(b,a,c){console.log("======> command",a);if(a){var d=this;if(0<=a&&100>=a)this._getBlindStates(function(h,l){h?c&&c(h):d._setInvertAndBlindOpacity(l.invert,0==l.invert?100-a:a,c)});else if(-1!=a.indexOf("lightsensoractive")||-1!=a.indexOf("ledpaint")){b=a.split("_");if(-1!=a.indexOf("lightsensoractive")){var e=parseInt(b[1]);var g="?"!=b[2]?parseInt(b[2]):0}else-1!=a.indexOf("ledpaint")&&(g=parseInt(b[1]),e="?"!=b[2]?parseInt(b[2]):0);this._setLedPaintAndLightsensor(g,e,c)}else-1!=a.indexOf("scene")?
(b=a.split("_"),this._setScene(parseInt(b[1]),c)):-1!=a.indexOf("invert")&&(b=a.split("_"),g=parseInt(b[1]),b=parseInt(b[2]),this._setInvertAndBlindOpacity(g,b,c,!0))}else c&&c("missing params")};f.prototype.getStates=function(b,a,c){this._getAllStates(function(d,e){if(!d&&e&&b)for(var g in e)e.hasOwnProperty(g)&&("opacity"==g?(d=e.opacity,0===e.invert&&(d=100-e.opacity),b.setState(a.id+":opacity",e.opacity),b.setState(a.id+":slider_opacity",d)):b.setState(a.id+":"+g,e[g]))})};f.prototype.executeCommandCreator=
function(b,a,c){if(a&&a.value)switch(a.value){case "invertOn":case "invertOff":b=0;"invertOn"==a.value&&(b=1);this._setInvert(b,c);break;case "ledpaintOn":case "ledpaintOff":b=0;"ledpaintOn"==a.value&&(b=1);this._setLedPaint(b,c);break;case "lightsensorOn":case "lightsensorOff":b=0;"lightsensorOn"==a.value&&(b=1);this._setLightsensor(b,c);break;case "doScene":if("undefined"==typeof a.ext||null==a.ext){c&&c("command ext invalid");break}a=parseInt(a.ext);1>a&&(a=1);6<a&&(a=6);this._setScene(a,c);break;
case "moveTo":if("undefined"==typeof a.ext||null==a.ext){c&&c("command ext invalid");break}a=parseInt(a.ext);0>a&&(a=0);100<a&&(a=100);this._setBlindPosition(a,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command json format invalid"))};f.prototype.getStatesCreator=function(b,a,c){this._getAllStates(function(d,e){if(d)c&&c(d);else{d=[];for(var g=0;g<a.length;g++)if(a[g]&&a[g].id&&a[g].status&&a[g].status.value){var h=e[a[g].status.value];"undefined"!=typeof h&&null!=h&&d.push({id:a[g].id,
status:h})}c&&c(null,d)}})};f.prototype.getSingleDeviceStatesCreator=function(b,a,c,d){this.getAllStates(function(e,g){d&&d(e,g)})};f.prototype.toJSON=function(){return{sys:"rehau",type:"gauzy",address:this.address,port:this.port}};f.prototype.equalsTo=function(b){return b&&b instanceof f?this.address==b.address&&this.port==b.port:!1};return f}();
xnm.aio.rehau.DM=function(){var f=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};f.prototype=Error();f.prototype.name="RehauDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={gauzy:{command:[{type:"enum",name:"invert on",ref:{value:"invertOn"}},{type:"enum",name:"invert off",ref:{value:"invertOff"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"enum",name:"LED-Paint on",
ref:{value:"ledpaintOn"}},{type:"enum",name:"LED-Paint off",ref:{value:"ledpaintOff"}},{type:"enum",name:"activate light sensor",ref:{value:"lightsensorOn"}},{type:"enum",name:"deactivate light sensor",ref:{value:"lightsensorOff"}},{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d",extMeta:"1-6",scale:"1"}}],status:[{type:"int",name:"position",ref:{value:"position",extMeta:"0-100",scale:"5"}},{type:"enum",name:"invert",ref:{value:"invert",options:["on","off"]}},{type:"enum",name:"LED-Paint",
ref:{value:"ledpaint",options:["on","off"]}},{type:"enum",name:"light sensor",ref:{value:"lightsensoractive",options:["on","off"]}}]}};return{SYS:"rehau",getIPDeviceType:function(){return[{sys:this.SYS,name:"Gauzy Scheibe",type:"gauzy"}]},createDevice:function(a,c,d){c=f.ERROR_CODE;a?a.address?d(null,a):d(new f(c.INVALID,"address is invalid")):d(new f(c.INVALID,"info is invalid"))},updateDevice:function(a,c,d){c=f.ERROR_CODE;a?a.address?d(null,a):d(new f(c.INVALID,"address is invalid")):d(new f(c.INVALID,
"info is invalid"))},deleteDevice:function(a,c,d){d()},applyUIFilter:function(a,c,d){var e=function(q,r,p){var n=[];q.forEach(function(k){if("root"==k.type){k=JSON.parse(JSON.stringify(k));var m=e(k.children,r,p);m&&0<m.length&&(k.children=m,n.push(k))}else{m=p.elems;if("*"==m)m=!0;else{for(var u=!1,t=0;t<m.length;t++)if(m[t]==k.type){u=!0;break}m=u}m&&(k=JSON.parse(JSON.stringify(k)),n.push(k))}});return n},g=function(q,r){var p=[],n=xnm.aio.pioneer.DM.getCommandStatusMap(q,d);if(n){var k=[];switch(r.catagory){case "command":n.command&&
(k=e(n.command,q,r));break;case "status":n.status&&(k=e(n.status,q,r))}p=p.concat(k)}return p};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),l=null;switch(c.catagory){case "command":l=g(a,c);h.command=l;break;case "status":l=g(a,c);h.status=l;break;default:return null}return l&&0!=l.length?h:null},getCommandStatusMap:function(a){return a&&a.type?b[a.type]:null}}}();
xnm.aio.rehau.Handler=function(){var f=function(){};f.prototype.devicemanager=xnm.aio.rehau.DM;f.prototype.Gauzy=xnm.aio.rehau.Gauzy;f.prototype.registModule=function(b){b.register("rehau","rehau")};f.prototype.resolveDevice=function(b){if(!b)return null;switch(b.type){case "gauzy":return b.address?new this.Gauzy(b.address,b.port):null;default:return null}};f.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};
f.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};f.prototype.doCommand=function(b,a,c){var d=this.resolveDevice(b);d?d.executeCommandCreator(b,a,function(e){c&&c(e)}):c&&c(Error("device json format invalid"))};f.prototype.doStatus=function(b,a,c,d){var e=this.resolveDevice(a);e?e.getStatesCreator(null,[{id:b,device:a,status:c}],function(g,h){g?d&&d(g):d&&d(null,h[0])}):d&&d(Error("device json format invalid"))};
f.prototype.getDevice=function(b){return new xnm.aio.rehau.Gauzy(b.address,b.port)};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rehau.Handler);
