var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var g=a[e];if(b.call(c,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<e.length-1;g++){var h=e[g];if(!(h in d))return;d=d[h]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+c+"$"+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.endsWith",function(a){return a?a:function(b,c){var d=$jscomp.checkStringArgs(this,b,"endsWith");b+="";void 0===c&&(c=d.length);c=Math.max(0,Math.min(c|0,d.length));for(var e=b.length;0<e&&0<c;)if(d[--c]!=b[--e])return!1;return 0>=e}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.devicemanager=m.aio.devicemanager||{};m.aio.devicemanager._configmanager=null;
m.aio.devicemanager.DeviceInfo=function(){var a=function(){this._rootnode=null};a.prototype.getIPCams=function(){return this._rootnode?this._rootnode.find("cam"):[]};a.prototype.getDevices=function(){return this._rootnode?this._rootnode.find("device"):[]};a.prototype.find=function(b){return this._rootnode?this._rootnode.find(b):null};a.parse=function(b){try{var c=new a;c._rootnode=$($.parseXML(b));c._xml=b;return c}catch(d){return console.log(d),null}};return a}();
m.aio.devicemanager.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};m.aio.devicemanager.DMError.prototype=Error();m.aio.devicemanager.DMError.prototype.name="DeviceManagerError";m.aio.devicemanager.DMError.prototype.code=0;m.aio.devicemanager.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,NAME_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,NOT_PERMITTED:6};m.aio.devicemanager.Filter=function(a){this.type=a};
m.aio.devicemanager.Filter.build=function(a){switch(a.filter){case "ui":return m.aio.devicemanager.UIFilter.build(a);case "prop":return m.aio.devicemanager.PropertyFilter.build(a);case "ipevt":return m.aio.devicemanager.IPEventFilter.build(a);case "neoserver":return m.aio.devicemanager.NeoServerFilter.build(a);default:return null}};m.aio.devicemanager.PropertyFilter=function(a){m.aio.devicemanager.Filter.call(this,"prop");this.properties=a;delete this.properties.filter};
m.aio.devicemanager.PropertyFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.PropertyFilter.prototype.constructor=m.aio.devicemanager.PropertyFilter;m.aio.devicemanager.PropertyFilter.prototype.match=function(a){var b=!0,c=this.properties,d;for(d in c){if(c.hasOwnProperty(d))for(var e=a,g=d.split("."),h=0;h<g.length;h++){var f=g[h];if(!e.hasOwnProperty(f)){b=b&&!1;break}e=e[f];if(!e&&h<g.length-1){b=b&&!1;break}if(h==g.length-1){b=e==c[d]?b&&!0:b&&!1;break}}if(!b)break}return b};
m.aio.devicemanager.PropertyFilter.build=function(a){return new m.aio.devicemanager.PropertyFilter(a)};m.aio.devicemanager.UIFilter=function(a,b){m.aio.devicemanager.Filter.call(this,"ui");this.catagory=a;this.elems=b};m.aio.devicemanager.UIFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.UIFilter.prototype.constructor=m.aio.devicemanager.UIFilter;
m.aio.devicemanager.UIFilter.build=function(a){if(!a.f_ui_type||!a.f_ui_elem)return null;var b=a.f_ui_elem.split(",");return new m.aio.devicemanager.UIFilter(a.f_ui_type,b)};m.aio.devicemanager.IPEventFilter=function(){m.aio.devicemanager.Filter.call(this,"ipevt")};m.aio.devicemanager.IPEventFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.IPEventFilter.prototype.constructor=m.aio.devicemanager.IPEventFilter;
m.aio.devicemanager.IPEventFilter.build=function(a){return"ipevt"!=a.filter?null:new m.aio.devicemanager.IPEventFilter};m.aio.devicemanager.NeoServerFilter=function(a,b){m.aio.devicemanager.Filter.call(this,"neoserver");this.catagory=a;this.elems=b};m.aio.devicemanager.NeoServerFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.NeoServerFilter.prototype.constructor=m.aio.devicemanager.NeoServerFilter;
m.aio.devicemanager.NeoServerFilter.build=function(a){if(!a.f_ui_type||!a.f_ui_elem)return null;var b=a.f_ui_elem.split(",");return new m.aio.devicemanager.NeoServerFilter(a.f_ui_type,b)};m.aio.devicemanager.IntHandler=function(a,b,c){this.dm=a;this.tenant=b;this.data=c;this.deviceinfo=null};m.aio.devicemanager.IntHandler.prototype.setDeviceInfo=function(a){this.deviceinfo=m.aio.devicemanager.DeviceInfo.parse(a)};m.aio.devicemanager.IntHandler.prototype.getDeviceInfo=function(){return this.deviceinfo};
m.aio.devicemanager.IntHandler.prototype.findDevice=function(a,b){return this._findDevice(a,b,!1)};m.aio.devicemanager.IntHandler.prototype.findDeviceIgnoreLicense=function(a,b){return this._findDevice(a,b,!0)};
m.aio.devicemanager.IntHandler.prototype._findDevice=function(a,b,c){var d=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:a});d=m.aio.devicemanager._RoomHandler._readSync(d,this);if(!d||!d[0]||!d[0].index)return null;a="read";c&&(a="readWithoutLicense");d=m.aio.devicemanager.PropertyFilter.build({filter:"prop",room:d[0].index,name:b});return(b=this.executeSync(a,"device",d))&&b[0]?b[0]:null};
m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndex=function(a){return this._findDeviceWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndexIngnoreLicense=function(a){return this._findDeviceWithIndex(a,!0)};m.aio.devicemanager.IntHandler.prototype._findDeviceWithIndex=function(a,b){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var c="read";b&&(c="readWithoutLicense");return(b=this.executeSync(c,"device",a))&&b[0]?b[0]:null};
m.aio.devicemanager.IntHandler.prototype.findGateway=function(a){return this._findGateway(a,!1)};m.aio.devicemanager.IntHandler.prototype.findGatewayIgnoreLicense=function(a){return this._findGateway(a,!0)};m.aio.devicemanager.IntHandler.prototype._findGateway=function(a,b){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:a});var c="read";b&&(c="readWithoutLicense");return(b=this.executeSync(c,"gateway",a))&&b[0]?b[0]:null};
m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndex=function(a){return this._findGatewayWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndexIngnoreLicense=function(a){return this._findGatewayWithIndex(a,!0)};m.aio.devicemanager.IntHandler.prototype._findGatewayWithIndex=function(a,b){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var c="read";b&&(c="readWithoutLicense");return(b=this.executeSync(c,"gateway",a))&&b[0]?b[0]:null};
m.aio.devicemanager.IntHandler.prototype.findRoomWithIndex=function(a){return this._findRoomWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype._findRoomWithIndex=function(a,b){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var c="read";b&&(c="readWithoutLicense");return(b=this.executeSync(c,"room",a))&&b[0]?b[0]:null};
m.aio.devicemanager.IntHandler.prototype.execute=function(a,b,c,d,e){var g=m.aio.devicemanager.DMError,h=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"==a||this.tenant.license)if("readWithoutLicense"==a||this._permit(this.tenant)){switch(a){case "create":a="_create";break;case "read":a="_read";c&&c.filter&&(c=m.aio.devicemanager.Filter.build(c));break;case "readWithoutLicense":a="_read";c&&c.filter&&(c=m.aio.devicemanager.Filter.build(c));c||(c={});c.ignoreLicense=!0;break;case "update":a=
"_update";break;case "delete":a="_delete";break;default:d&&d(new g(h.UNKNOW,"op "+a+" unknow"));return}switch(b){case "gateway":m.aio.devicemanager._GatewayHandler[a](c,this,d,e);break;case "device":m.aio.devicemanager._DeviceHandler[a](c,this,d,e);break;case "room":m.aio.devicemanager._RoomHandler[a](c,this,d,e);break;case "gatewaytype":m.aio.devicemanager._GatewaytypeHandler[a](c,this,d);break;case "gatewaydevicetype":m.aio.devicemanager._GatewayDeviceTypeHandler[a](c,this,d);break;case "ipdevicetype":m.aio.devicemanager._IpdevicetypeHandler[a](c,
this,d);break;case "deviceinfo":m.aio.devicemanager._DeviceInfoHandler[a](c,this,d);break;default:d&&d(new g(h.UNKNOW,"type "+b+" unknow"))}}else d(Error("not permitted"));else d(new g(h.INVALID,"no license"))};
m.aio.devicemanager.IntHandler.prototype.executeSync=function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"!=a&&!this.tenant.license)throw new d(e.INVALID,"no license");if("readWithoutLicense"!=a&&!this._permit(this.tenant))throw Error("not permitted");switch(a){case "read":a="_read";c&&c.filter&&(c=m.aio.devicemanager.Filter.build(c));break;case "readWithoutLicense":a="_read";c&&c.filter&&(c=m.aio.devicemanager.Filter.build(c));c||(c={});
c.ignoreLicense=!0;break;case "create":case "update":case "delete":throw new d(e.UNKNOW,"op "+a+" do not have synchronized method");default:throw new d(e.UNKNOW,"op "+a+" unknow");}switch(b){case "gateway":return m.aio.devicemanager._GatewayHandler[a+"Sync"](c,this);case "device":return m.aio.devicemanager._DeviceHandler[a+"Sync"](c,this);case "room":return m.aio.devicemanager._RoomHandler[a+"Sync"](c,this);case "gatewaytype":case "gatewaydevicetype":case "ipdevicetype":case "deviceinfo":throw new d(e.UNKNOW,
"type "+b+" do not have synchronized method");default:throw new d(e.UNKNOW,"type "+b+" unknow");}};m.aio.devicemanager.IntHandler.prototype.deleteUnlicensed=function(a){var b=this;if(this.data){var c=null;try{c=JSON.parse(JSON.stringify(this.data))}catch(d){a&&a(d);return}c?m.aio.devicemanager._GatewayHandler._deleteUnlicensed(this,c,function(d){d?a&&a(d):m.aio.devicemanager._DeviceHandler._deleteUnlicensed(b,c,function(e){a&&a(e,c)})}):a&&a(null,{})}else a&&a(null,{})};
m.aio.devicemanager.IntHandler.prototype._permit=function(a){return a&&a.parent&&a.license&&a.license.valid?!(a.license.isTestLicense()&&a.license.isExpired()):!1};m.aio.devicemanager.IntHandler.prototype._insertIntoArray=function(a,b){for(var c=-1,d=0;d<b.length;d++)if(b[d].index>a.index){c=d;break}-1===c?b.push(a):b.splice(c,0,a)};
m.aio.devicemanager.IntHandler.prototype._save=function(a){var b=require("fs"),c=require("path"),d=this.tenant.getFolderPath()+c.sep+m.aio.devicemanager.DeviceManager.DB,e=this,g=this.data;this.dm.writeFileEncrypted(d+".enc",JSON.stringify(g),function(h){h?a(h):(h=e.dm.removeAuthDataFromJSON(g),b.writeFile(d,JSON.stringify(h),function(f){a(f)}))})};
m.aio.devicemanager.IntHandler.prototype._sort=function(a){var b=a.length-1;do{var c=!1;for(var d=0;d<b;++d)a[d].index>a[d+1].index&&(c=a[d],a[d]=a[d+1],a[d+1]=c,c=!0)}while(1==c)};m.aio.devicemanager.IntHandler.prototype._saveDeviceInfo=function(a){var b=require("fs"),c=require("path");c=this.tenant.getFolderPath()+c.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO;b.writeFile(c,this.deviceinfo._xml,function(d){a(d)})};
m.aio.devicemanager._GatewayHandler={_create:function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.info)if(a.info.sys)if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("create",a.info,b.tenant.license)){var g=b.data.gateways;g||(b.data.gateways=[],g=b.data.gateways);for(var h=
1,f=0;f<g.length;f++){var k=g[f];k.index===h&&h++;if(0<a.index&&k.index===a.index){c(new d(e.INDEX_EXISTS,"index "+a.index+" exists"));return}if(k.name===a.name){c(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=h;if(g=b.dm.getModule(a.info.sys))if(g.devicemanager){var l={index:a.index,name:a.name,info:a.info};g.devicemanager.createGateway(l.info,b,function(n,r){n?c(n):(l.info=r,b._insertIntoArray(l,b.data.gateways),b._save(function(p){c(p,l)}))})}else c(new d(e.INVALID,
"sys "+a.info.sys+" do not have device manager implementation"));else c(new d(e.UNKNOW,"sys "+a.info.sys+" unknow"))}else c(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"));else c(new d(e.INVALID,"sys "+a.info.sys+" invalid"));else c(new d(e.INVALID,"info "+a.info+" invalid"))}else c(new d(e.INVALID,"name "+a.name+" invalid"))},_read:function(a,b,c){var d=[],e=b.data.gateways;a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?e.forEach(function(f){a.match(f)&&d.push(f)}):a&&a instanceof
m.aio.devicemanager.UIFilter?e.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=b.dm.getModule(f.info.sys);k&&k.devicemanager&&k.devicemanager.applyUIFilterGateway&&(k=k.devicemanager.applyUIFilterGateway(f.info,a,b.deviceinfo))&&(f.info=k,d.push(f))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?e.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=b.dm.getModule(f.info.sys);k&&k.devicemanager&&k.devicemanager.applyNeoServerFilterGateway&&
(k=k.devicemanager.applyNeoServerFilterGateway(f.info,a,b.deviceinfo))&&(f.info=k,d.push(f))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?e.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=b.dm.getModule(f.info.sys);k&&k.devicemanager&&k.devicemanager.applyIPEventFilterGateway&&(k=k.devicemanager.applyIPEventFilterGateway(f.info,a,b.deviceinfo))&&(f.info=k,d.push(f))}}):d=e;if(a&&a.ignoreLicense)c(null,d);else{var g=[],h=m.aio.devicemanager._configmanager.LicenseManager;
d.forEach(function(f){var k=JSON.parse(JSON.stringify(f));h.permitFeature("read",f.info,b.tenant.license)||(k._no_permission=!0);g.push(k)});c(null,g)}},_readSync:function(a,b){var c=[],d=b.data.gateways;a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?d.forEach(function(h){a.match(h)&&c.push(h)}):a&&a instanceof m.aio.devicemanager.UIFilter?d.forEach(function(h){h=JSON.parse(JSON.stringify(h));if(h.info&&h.info.sys){var f=b.dm.getModule(h.info.sys);f&&f.devicemanager&&f.devicemanager.applyUIFilterGateway&&
(f=f.devicemanager.applyUIFilterGateway(h.info,a,b.deviceinfo))&&(h.info=f,c.push(h))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?d.forEach(function(h){h=JSON.parse(JSON.stringify(h));if(h.info&&h.info.sys){var f=b.dm.getModule(h.info.sys);f&&f.devicemanager&&f.devicemanager.applyNeoServerFilterGateway&&(f=f.devicemanager.applyNeoServerFilterGateway(h.info,a,b.deviceinfo))&&(h.info=f,c.push(h))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?d.forEach(function(h){h=JSON.parse(JSON.stringify(h));
if(h.info&&h.info.sys){var f=b.dm.getModule(h.info.sys);f&&f.devicemanager&&f.devicemanager.applyIPEventFilterGateway&&(f=f.devicemanager.applyIPEventFilterGateway(h.info,a,b.deviceinfo))&&(h.info=f,c.push(h))}}):c=d;if(a&&a.ignoreLicense)return c;var e=[],g=m.aio.devicemanager._configmanager.LicenseManager;c.forEach(function(h){var f=JSON.parse(JSON.stringify(h));g.permitFeature("read",h.info,b.tenant.license)||(f._no_permission=!0);e.push(f)});return e},_update:function(a,b,c){var d=m.aio.devicemanager.DMError,
e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.name)if(a.info)if(a.info.sys){var g=m.aio.devicemanager._configmanager.LicenseManager;if(g.permitFeature("update",a.info,b.tenant.license)){var h,f=b.data.gateways;for(h=0;h<f.length;h++)if(a.index==f[h].index)var k=f[h];else if(a.name==f[h].name){c(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}k?
g.permitFeature("update",k.info,b.tenant.license)?(g=b.dm.getModule(a.info.sys))?g.devicemanager?g.devicemanager.updateGateway(k.info,a.info,b,function(l,n){if(l)c(l);else{k.name=a.name;k.info=n;for(var r in a)a.hasOwnProperty(r)&&"name"!=r&&"info"!=r&&"index"!=r&&a[r]&&(k[r]=a[r]);b._save(function(p){c(p,k)})}}):c(new d(e.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):c(new d(e.UNKNOW,"sys "+a.info.sys+" unknow")):c(new d(e.NOT_PERMITTED,"sys "+k.info.sys+" not permitted")):
c(new d(e.NOT_FOUND,"no gateway has index "+a.index))}else c(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"))}else c(new d(e.INVALID,"sys "+a.info.sys+" invalid"));else c(new d(e.INVALID,"info "+a.info+" invalid"));else c(new d(e.INVALID,"name "+a.name+" invalid"))}else c(new d(e.INVALID,"index "+a.index+" invalid"))},_delete:function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{c(new d(e.INVALID,
"index "+a+" invalid"));return}for(var g=b.data.gateways,h,f,k=0;k<g.length;k++)a===g[k].index&&(h=g[k],f=k);h?m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",h.info,b.tenant.license)?(g=b.dm.getModule(h.info.sys))?g.devicemanager?g.devicemanager.deleteGateway(h.info,b,function(l){l?c(l):(b.data.gateways.splice(f,1),b.data.devices&&b.data.devices.forEach(function(n){n.info&&n.info.gateway&&n.info.gateway==a&&(n.info.gateway=0)}),b._save(function(n){c(n,h)}))}):c(new d(e.INVALID,
"sys "+h.info.sys+" do not have device manager implementation")):c(new d(e.UNKNOW,"sys "+h.info.sys+" unknow")):c(new d(e.NOT_PERMITTED,"sys "+h.info.sys+" not permitted")):c(new d(e.NOT_FOUND,"no gateway has index "+a))}else c(new d(e.INVALID,"index "+a+" invalid"))},_deleteUnlicensed:function(a,b,c){var d=[],e=b.gateways;if(e){for(var g=m.aio.devicemanager._configmanager.LicenseManager,h=0;h<e.length;h++){var f=e[h];f.info&&g.permitFeature("add",f.info,a.tenant.license)&&d.push(f)}b.gateways=d}c&&
c()}};
m.aio.devicemanager._DeviceHandler={_findGateway:function(a,b){if(!a||!a.data)return null;a=a.data.gateways;if(!a)return null;for(var c=0;c<a.length;c++){var d=a[c];if(d&&d.index==b)return d}return null},_create:function(a,b,c,d){var e=m.aio.devicemanager.DMError,g=m.aio.devicemanager.DMError.ERROR_CODE,h=b.data.devices,f=m.aio.devicemanager._configmanager.LicenseManager,k=null;a.info&&a.info.gateway&&(k=this._findGateway(b,a.info.gateway));if(f.permitFeature("create",a.info,b.tenant.license,a.index,
h,k?k.info:null))if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new e(g.INVALID,"index "+a.index+" invalid"));return}if(a.room){f=b.data.rooms;f||(b.data.rooms=[],f=b.data.rooms);k=!1;for(var l=0;l<f.length;l++)if(f[l].index==a.room){k=!0;break}if(k)if(a.info)if(a.info.sys)if(h||(b.data.devices=[],h=b.data.devices),f=require("m.aio.infomanager").getDeviceCount(a.info,b.tenant.license),0==f)c(Error("allow device count is 0"));else{if(-1!=
f){for(l=k=0;l<h.length;l++){var n=h[l];n.info&&n.info.sys==a.info.sys&&k++}if(k>=f){c(Error("reach maximum device count "+f));return}}f=1;for(k=0;k<h.length;k++){l=h[k];l.index===f&&f++;if(0<a.index&&l.index===a.index){c(new e(g.INDEX_EXISTS,"index "+a.index+" exists"));return}if(l.name===a.name&&l.room===a.room){c(new e(g.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=f;(h=b.dm.getModule(a.info.sys))?h.devicemanager?h.devicemanager.createDevice(a.info,b,function(r,
p){r?c(r):(a.info=p,b._insertIntoArray(a,b.data.devices),d?c(null,a):b._save(function(q){c(q,a)}))}):c(new e(g.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):c(new e(g.UNKNOW,"sys "+a.info.sys+" unknow"))}else c(new e(g.INVALID,"sys "+a.info.sys+" invalid"));else c(new e(g.INVALID,"info "+a.info+" invalid"));else c(new e(g.INVALID,"room "+a.room+" do not exist"))}else c(new e(g.INVALID,"room "+a.room+" invalid"))}else c(new e(g.INVALID,"name "+a.name+" invalid"));else c(new e(g.NOT_PERMITTED,
"sys "+a.info.sys+" not permitted"))},_read:function(a,b,c){var d=[],e=b.data.devices;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?e.forEach(function(k){a.match(k)&&d.push(k)}):a&&a instanceof m.aio.devicemanager.UIFilter?e.forEach(function(k){k=JSON.parse(JSON.stringify(k));if(k.info&&k.info.sys){var l=null;k.info.gateway&&b&&(l=b.findGatewayWithIndexIngnoreLicense(k.info.gateway));var n=b.dm.getModule(k.info.sys);n&&n.devicemanager&&n.devicemanager.applyUIFilter&&(l=n.devicemanager.applyUIFilter(k.info,
a,b.deviceinfo,b,l?l.info:null))&&(k.info=l,d.push(k))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?e.forEach(function(k){k=JSON.parse(JSON.stringify(k));if(k.info&&k.info.sys){var l=b.dm.getModule(k.info.sys);l&&l.devicemanager&&l.devicemanager.applyNeoServerFilter&&(l=l.devicemanager.applyNeoServerFilter(k.info,a,b.deviceinfo,b))&&(k.info=l,d.push(k))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?e.forEach(function(k){k=JSON.parse(JSON.stringify(k));if(k.info&&k.info.sys){var l=
null;k.info.gateway&&b&&(l=b.findGatewayWithIndexIngnoreLicense(k.info.gateway));var n=b.dm.getModule(k.info.sys);n&&n.devicemanager&&n.devicemanager.applyIPEventFilter&&(l=n.devicemanager.applyIPEventFilter(k.info,a,b.deviceinfo,b,l?l.info:null))&&(k.info=l,d.push(k))}}):d=e;if(a&&a.ignoreLicense)c(null,d);else{var g=[],h=m.aio.devicemanager._configmanager.LicenseManager,f=this;d.forEach(function(k){var l=null;k.info&&k.info.gateway&&(l=f._findGateway(b,k.info.gateway));var n=JSON.parse(JSON.stringify(k));
h.permitFeature("read",k.info,b.tenant.license,k.index,e,l?l.info:null)||(n._no_permission=!0);g.push(n)});c(null,g)}},_readSync:function(a,b){var c=[],d=b.data.devices;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?d.forEach(function(f){a.match(f)&&c.push(f)}):a&&a instanceof m.aio.devicemanager.UIFilter?d.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=b.dm.getModule(f.info.sys);k&&k.devicemanager&&k.devicemanager.applyUIFilter&&(k=k.devicemanager.applyUIFilter(f.info,
a,b.deviceinfo,b))&&(f.info=k,c.push(f))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?d.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=b.dm.getModule(f.info.sys);k&&k.devicemanager&&k.devicemanager.applyNeoServerFilter&&(k=k.devicemanager.applyNeoServerFilter(f.info,a,b.deviceinfo,b))&&(f.info=k,c.push(f))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?d.forEach(function(f){f=JSON.parse(JSON.stringify(f));if(f.info&&f.info.sys){var k=null;f.info.gateway&&
b&&(k=b.findGatewayWithIndexIngnoreLicense(f.info.gateway));var l=b.dm.getModule(f.info.sys);l&&l.devicemanager&&l.devicemanager.applyIPEventFilter&&(k=l.devicemanager.applyIPEventFilter(f.info,a,b.deviceinfo,b,k?k.info:null))&&(f.info=k,c.push(f))}}):c=d;if(a&&a.ignoreLicense)return c;var e=[],g=m.aio.devicemanager._configmanager.LicenseManager,h=this;c.forEach(function(f){var k=null;f.info&&f.info.gateway&&(k=h._findGateway(b,f.info.gateway));var l=JSON.parse(JSON.stringify(f));g.permitFeature("read",
f.info,b.tenant.license,f.index,d,k?k.info:null)||(l._no_permission=!0);e.push(l)});return e},_update:function(a,b,c,d){var e=m.aio.devicemanager.DMError,g=m.aio.devicemanager.DMError.ERROR_CODE,h=b.data.devices;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new e(g.INVALID,"index "+a.index+" invalid"));return}if(a.name)if(a.room)if(a.info)if(a.info.sys){var f=null;a.info&&a.info.gateway&&(f=this._findGateway(b,a.info.gateway));var k=m.aio.devicemanager._configmanager.LicenseManager;
if(k.permitFeature("update",a.info,b.tenant.license,a.index,h,f?f.info:null)){var l,n=b.data.rooms,r;for(l=0;l<n.length;l++)a.room===n[l].index&&(r=n[l]);if(r){var p=-1;for(l=0;l<h.length;l++)if(a.index===h[l].index){var q=h[l];p=l}else if(h[l].name===a.name&&h[l].room===a.room){c(new e(g.NAME_EXISTS,"name "+a.name+" exists"));return}q?(q.info&&q.info.gateway&&(f=this._findGateway(b,q.info.gateway)),k.permitFeature("update",q.info,b.tenant.license,q.index,h,f?f.info:null)?(f=b.dm.getModule(a.info.sys))?
f.devicemanager?f.devicemanager.updateDevice(a.info,b,function(t,v){t?c(t):(a.info=v,h[p]=a,d?c(null,a):b._save(function(w){c(w,a)}))}):c(new e(g.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):c(new e(g.UNKNOW,"sys "+a.info.sys+" unknow")):c(new e(g.NOT_PERMITTED,"sys "+q.info.sys+" not permitted"))):c(new e(g.NOT_FOUND,"no device has index "+a.index))}else c(new e(g.NOT_FOUND,"no room has index "+a.index))}else c(new e(g.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"))}else c(new e(g.INVALID,
"sys "+a.info.sys+" invalid"));else c(new e(g.INVALID,"info "+a.info+" invalid"));else c(new e(g.INVALID,"room "+a.room+" invalid"));else c(new e(g.INVALID,"name "+a.name+" invalid"))}else c(new e(g.INVALID,"index "+a.index+" invalid"))},_delete:function(a,b,c,d){var e=m.aio.devicemanager.DMError,g=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{c(new e(g.INVALID,"index "+a+" invalid"));return}for(var h=b.data.devices,f,k,l=0;l<h.length;l++)a===
h[l].index&&(f=h[l],k=l);f?(a=null,f.info&&f.info.gateway&&(a=this._findGateway(b,f.info.gateway)),m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",f.info,b.tenant.license,f.index,h,a?a.info:null)?(h=b.dm.getModule(f.info.sys))?h.devicemanager?h.devicemanager.deleteDevice(f.info,b,function(n){n?c(n):(b.data.devices.splice(k,1),d?c(null,f):b._save(function(r){c(r,f)}))}):c(new e(g.INVALID,"sys "+f.info.sys+" do not have device manager implementation")):c(new e(g.UNKNOW,"sys "+
f.info.sys+" unknow")):c(new e(g.NOT_PERMITTED,"sys "+f.info.sys+" not permitted"))):c(new e(g.NOT_FOUND,"no device has index "+a))}else c(new e(g.INVALID,"index "+a+" invalid"))},_deleteUnlicensed:function(a,b,c){var d=[],e=b.devices;if(e){for(var g=m.aio.devicemanager._configmanager.LicenseManager,h,f={},k=0;k<e.length;f={$jscomp$loop$prop$device$3:f.$jscomp$loop$prop$device$3,$jscomp$loop$prop$cacheKey$4:f.$jscomp$loop$prop$cacheKey$4},k++)f.$jscomp$loop$prop$device$3=e[k],h=null,f.$jscomp$loop$prop$device$3.info&&
f.$jscomp$loop$prop$device$3.info.gateway&&(h=this._findGateway(a,f.$jscomp$loop$prop$device$3.info.gateway)),(h=g.permitFeature("add",f.$jscomp$loop$prop$device$3.info,a.tenant.license,f.$jscomp$loop$prop$device$3.index,e,h?h.info:null))&&d.push(f.$jscomp$loop$prop$device$3);b.devices=d}c&&c()}};
m.aio.devicemanager._RoomHandler={_create:function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new d(e.INVALID,"index "+a.index+" invalid"));return}var g=b.data.rooms;g||(b.data.rooms=[],g=b.data.rooms);for(var h=1,f=0;f<g.length;f++){var k=g[f];k.index===h&&h++;if(0<=a.index&&k.index===a.index){c(new d(e.INDEX_EXISTS,"index "+a.index+" exists"));return}if(k.name===
a.name){c(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=h;b._insertIntoArray(a,b.data.rooms);b._save(function(l){c(l,a)})}else c(new d(e.INVALID,"name "+a.name+" invalid"))},_read:function(a,b,c){var d=[];b=b.data.rooms;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?(b.forEach(function(e){a.match(e)&&d.push(e)}),c(null,d)):c(null,b)},_readSync:function(a,b){var c=[];b=b.data.rooms;return a&&a instanceof m.aio.devicemanager.PropertyFilter&&
a.properties?(b.forEach(function(d){a.match(d)&&c.push(d)}),c):b},_update:function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{c(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.name){var g,h=b.data.rooms;for(g=0;g<h.length;g++)if(a.index===h[g].index)var f=h[g];else if(a.name===h[g].name){c(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}f?(d=
f.name!==a.name,a.info&&"object"===typeof a.info?(d=!0,f.info=a.info):f.info&&(d=!0,delete f.info),d?(f.name=a.name,b._save(function(k){c(k,f)})):c(null,f)):c(new d(e.NOT_FOUND,"no room has index "+a.index))}else c(new d(e.INVALID,"name "+a.name+" invalid"))}else c(new d(e.INVALID,"index "+a.index+" invalid"))},_delete:function(a,b,c){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{c(new d(e.INVALID,
"index "+a+" invalid"));return}var g=b.data.rooms,h=-1,f;for(f=0;f<g.length;f++)if(a===g[f].index){var k=g[f];h=f}if(k){d=b.data.devices;for(f=0;f<d.length;f++)a===d[f].room&&(d[f].room=0);0<=h&&(b.data.rooms.splice(h,1),b._save(function(l){c(l,k)}))}else c(new d(e.NOT_FOUND,"no room has index "+a))}else c(new d(e.INVALID,"index "+a+" invalid"))}};
m.aio.devicemanager._GatewaytypeHandler={_read:function(a,b,c){a=[];var d={};for(h in b.dm.modules)if(b.dm.modules.hasOwnProperty(h)){var e=b.dm.modules[h];var g=require("xnm.aio."+e+".js");e&&g&&(d[e]=g)}var h=m.aio.devicemanager._configmanager.LicenseManager;for(var f in d)d.hasOwnProperty(f)&&(g=d[f]),g.devicemanager&&"function"===typeof g.devicemanager.getGatewayType&&(e=g.devicemanager.getGatewayType({lm:h,license:b.tenant.license}))&&(a=a.concat(e));g=[];for(f=0;f<a.length;f++)h.permitFeature("read",
a[f],b.tenant.license)&&g.push(a[f]);c(null,g)}};
m.aio.devicemanager._GatewayDeviceTypeHandler={_create:function(a,b,c){if(a.sys){var d=b.dm.modules[a.sys];if(d){var e=require("xnm.aio."+d+".js");if(e)if(e.devicemanager&&"function"==typeof e.devicemanager.getGatewayDeviceType){var g=m.aio.devicemanager._configmanager.LicenseManager;"gateway"==d?e.devicemanager.getGatewayDeviceType2(a,{lm:g,license:b.tenant.license},function(h,f){c(h,f)}):(a=e.devicemanager.getGatewayDeviceType(a,{lm:g,license:b.tenant.license}),c(null,a))}else c&&c(Error("module has no gateway device"));
else c&&c(Error("no such module "+a.sys))}else c&&c(Error("do not support sys "+a.sys))}else c&&c(Error("parameter sys is null"))}};
m.aio.devicemanager._IpdevicetypeHandler={_read:function(a,b,c){a=[];var d={};for(h in b.dm.modules)if(b.dm.modules.hasOwnProperty(h)){var e=b.dm.modules[h];var g=require("xnm.aio."+e+".js");e&&g&&(d[e]=g)}var h=m.aio.devicemanager._configmanager.LicenseManager;for(var f in d)d.hasOwnProperty(f)&&(g=d[f]),g.devicemanager&&"function"===typeof g.devicemanager.getIPDeviceType&&(e=g.devicemanager.getIPDeviceType(b.deviceinfo,{lm:h,license:b.tenant.license}))&&(a=a.concat(e));g=[];for(f=0;f<a.length;f++)h.permitFeature("read",
a[f],b.tenant.license)&&g.push(a[f]);c(null,g)}};
m.aio.devicemanager._DeviceInfoHandler={_read:function(a,b,c){a&&a.ignoreLicense||m.aio.devicemanager._configmanager.LicenseManager.permitFeature("read",{sys:"ip"},b.tenant.license)?b.deviceinfo&&b.deviceinfo._xml?c(null,b.deviceinfo._xml):c&&c(null,""):c&&c(Error("do not permit to access device info"))},_update:function(a,b,c){m.aio.devicemanager._configmanager.LicenseManager.permitFeature("update",{sys:"ip"},b.tenant.license)?(a=m.aio.devicemanager.DeviceInfo.parse(a))?(b.deviceinfo=a,b._saveDeviceInfo(function(d){c&&
c(d,b.deviceinfo._xml)})):c&&c(Error("device info format invalid")):c&&c(Error("do not permit to access device info"))}};m.aio.devicemanager.DeviceManager=function(){this.handlers=[];this.modules={}};m.aio.devicemanager.DeviceManager.DB="device_db";m.aio.devicemanager.DeviceManager.DEVICE_INFO="deviceinfo.xml";m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO='<?xml version="1.0" encoding="UTF-8" ?>\r\n<deviceinfo update="1432810745">\r\n\t<device id="xbmc_frodo" name="XBMC (Frodo)" controlurl="/jsonrpc?request=%7B%22jsonrpc%22%3A%20%222.0%22%2C%20%22method%22%3A%20%22Input.ExecuteAction%22%2C%20%22params%22%3A%20%7B%20%22action%22%3A%20%22%@%22%7D%2C%20%22id%22%3A%201%7D" upnptype="generic" controlport="80" tpl="320x460:264:3378@3|1024x748:265:3382@3" icon="dmr">\r\n    <key id="volumeDown" code="volumedown"/>\r\n    <key id="volumeUp" code="volumeup"/>\r\n    <key id="mute" code="mute"/>\r\n    <key id="left" code="left"/>\r\n    <key id="right" code="right"/>\r\n    <key id="up" code="up"/>\r\n    <key id="down" code="down"/>\r\n    <key id="back" code="back"/>\r\n    <key id="select" code="select"/>\r\n    <key id="enter" code="enter"/>\r\n    <key id="return" code="backspace"/>\r\n    <key id="prevPage" code="pageup"/>\r\n    <key id="nextPage" code="pagedown"/>\r\n    <key id="play" code="play"/>\r\n    <key id="pause" code="pause"/>\r\n    <key id="play_pause" code="playpause"/>\r\n    <key id="stop" code="stop"/>\r\n    <key id="info" code="info"/>\r\n    <key id="hidesubmenu" code="hidesubmenu"/>\r\n    <key id="popupmenu" code="contextmenu"/>\r\n    <key id="exit" code="close"/>\r\n    <key id="fastForward" code="fastforward"/>\r\n    <key id="rewind" code="rewind"/>\r\n    <key id="next" code="skipnext"/>\r\n    <key id="previous" code="skipprevious"/>\r\n    <key id="stepForward" code="stepforward"/>\r\n    <key id="stepBack" code="stepback"/>\r\n    <key id="bigStepForwart" code="bigstepforward"/>\r\n    <key id="bigStepBack" code="bigstepback"/>\r\n    <key id="subtitle" code="showsubtitles"/>\r\n    <key id="nextSubtitle" code="nextsubtitle"/>\r\n    <key id="channelUp" code="channelup"/>\r\n    <key id="channelDown" code="channeldown"/>\r\n    <key id="previousPicture" code="previouspicture"/>\r\n    <key id="nextPicture" code="nextpicture"/>\r\n    <key id="scrollUp" code="scrollup"/>\r\n    <key id="scrollDown" code="scrolldown"/>\r\n    <key id="previousScene" code="previousscene"/>\r\n    <key id="nextScene" code="nextscene"/>\r\n    <key id="fullscreen" code="fullscreen"/>\r\n    <key id="videoMode" code="togglefullscreen"/>\r\n    <key id="ratio" code="aspectratio"/>\r\n    <key id="1" code="number1"/>\r\n    <key id="2" code="number2"/>\r\n    <key id="3" code="number3"/>\r\n    <key id="4" code="number4"/>\r\n    <key id="5" code="number5"/>\r\n    <key id="6" code="number6"/>\r\n    <key id="7" code="number7"/>\r\n    <key id="8" code="number8"/>\r\n    <key id="9" code="number9"/>\r\n    <key id="0" code="number0"/>\r\n    <key id="red" code="red"/>\r\n    <key id="green" code="green"/>\r\n    <key id="yellow" code="yellow"/>\r\n    <key id="blue" code="blue"/>\r\n    <key id="osd" code="osd"/>\r\n    <key id="osdLeft" code="osdleft"/>\r\n    <key id="osdrRight" code="osdright"/>\r\n    <key id="osdUp" code="osdup"/>\r\n    <key id="osdDown" code="osddown"/>\r\n    <key id="osdSelect" code="osdselect"/>\r\n    <key id="osdValuePlus" code="osdvalueplus"/>\r\n    <key id="osdValueMinus" code="osdvalueminus"/>\r\n  </device>\r\n\t<device id="denon_3808" name="Denon AVR" tpl="320x460:253:3380@3|1024x748:254:3384@3" icon="avr" controlport="23" tcptype="textnl">\r\n    <key id="volumeUp" code="MVUP"/>\r\n    <key id="volumeDown" code="MVDOWN"/>\r\n    <key id="mainZoneOn" code="ZMON"/>\r\n    <key id="mainZoneOff" code="ZMOFF"/>\r\n    <key id="muteOn" code="MUON"/>\r\n    <key id="muteOff" code="MUOFF"/>\r\n    <key id="INPUT_PHONO" code="SIPHONO"/>\r\n    <key id="INPUT_CD" code="SICD"/>\r\n    <key id="INPUT_TUNER" code="SITUNER"/>\r\n    <key id="INPUT_DVD" code="SIDVD"/>\r\n    <key id="INPUT_BD" code="SIBD"/>\r\n    <key id="INPUT_TV" code="SITV"/>\r\n    <key id="INPUT_SATCBL" code="SISAT/CBL"/>\r\n    <key id="INPUT_DVR" code="SIDVR"/>\r\n    <key id="INPUT_GAME" code="SIGAME"/>\r\n    <key id="INPUT_VAUX" code="SIV.AUX"/>\r\n    <key id="INPUT_DOCK" code="SIDOCK"/>\r\n    <key id="INPUT_NETUSB" code="SINET/USB"/>\r\n    <key id="INPUT_USB_IPOD" code="SIUSB/IPOD"/>\r\n    <key id="DIRECT" code="MSDIRECT"/>\r\n    <key id="PURE_DIRECT" code="MSPURE DIRECT"/>\r\n    <key id="STEREO" code="MSSTEREO"/>\r\n    <key id="STANDARD" code="MSSTANDARD"/>\r\n    <key id="DOLBY_DIGITAL" code="MSDOLBY DIGITAL"/>\r\n    <key id="DTS_SURROUND" code="MSDTS SURROUND"/>\r\n    <key id="SUPER_STADIUM" code="MSSUPER STADIUM"/>\r\n    <key id="ROCK_ARENA" code="MSROCK ARENA"/>\r\n    <key id="JAZZCLUB" code="MSJAZZ CLUB"/>\r\n    <key id="CLASSIC_CONCERT" code="MSCLASSIC CONCERT"/>\r\n    <key id="VIDEOGAME" code="MSVIDEO GAME"/>\r\n    <key id="zone2PowerOn" code="Z2ON"/>\r\n    <key id="zone2PowerOff" code="Z2OFF"/>\r\n    <key id="zone2VolumeUp" code="Z2UP"/>\r\n    <key id="zone2VolumeDown" code="Z2DOWN"/>\r\n    <key id="zone2MuteOn" code="Z2MUON"/>\r\n    <key id="zone2MuteOff" code="Z2MUOFF"/>\r\n    <key id="powerOn" code="PWON"/>\r\n    <key id="powerOff" code="PWSTANDBY"/>\r\n  </device>\r\n\t<device id="reelbox" name="Reelbox" udptype="textnl" controlport="2004">\r\n    <key id="channelDown" code="Channel- "/>\r\n    <key id="channelUp" code="Channel+ "/>\r\n    <key id="up" code="Up "/>\r\n    <key id="down" code="Down "/>\r\n    <key id="left" code="Left "/>\r\n    <key id="right" code="Right "/>\r\n    <key id="enter" code="Ok "/>\r\n    <key id="menu" code="Menu "/>\r\n    <key id="back" code="Back "/>\r\n    <key id="volumeDown" code="Volume- "/>\r\n    <key id="volumeUp" code="Volume+ "/>\r\n    <key id="mute" code="Mute "/>\r\n    <key id="play" code="Play "/>\r\n    <key id="pause" code="Pause "/>\r\n    <key id="stop" code="Stop "/>\r\n    <key id="record" code="Record "/>\r\n    <key id="rewind" code="FastRew "/>\r\n    <key id="fastForward" code="FastFwd "/>\r\n    <key id="eject" code="Eject "/>\r\n    <key id="DVB" code="DVB "/>\r\n    <key id="DVD" code="DVD "/>\r\n    <key id="PVR" code="PVR "/>\r\n    <key id="Reel" code="Reel "/>\r\n    <key id="teletext" code="TT "/>\r\n    <key id="pip" code="PiP "/>\r\n    <key id="aspect" code="Aspect "/>\r\n    <key id="help" code="Help "/>\r\n    <key id="info" code="Info "/>\r\n    <key id="search" code="Search "/>\r\n    <key id="audio" code="Audio "/>\r\n    <key id="setup" code="Setup "/>\r\n    <key id="timer" code="Timer "/>\r\n    <key id="greater" code="Greater "/>\r\n    <key id="1" code="1 "/>\r\n    <key id="2" code="2 "/>\r\n    <key id="3" code="3 "/>\r\n    <key id="4" code="4 "/>\r\n    <key id="5" code="5 "/>\r\n    <key id="6" code="6 "/>\r\n    <key id="7" code="7 "/>\r\n    <key id="8" code="8 "/>\r\n    <key id="9" code="9 "/>\r\n    <key id="0" code="0 "/>\r\n    <key id="red" code="Red "/>\r\n    <key id="green" code="Green "/>\r\n    <key id="yellow" code="Yellow "/>\r\n    <key id="blue" code="Blue "/>\r\n    <key id="powerOn" code="Startup "/>\r\n    <key id="powerOff" code="Poweroff "/>\r\n    <key id="standby" code="Standby "/>\r\n  </device>\r\n</deviceinfo>';
m.aio.devicemanager.DeviceManager.prototype.init=function(a,b,c){if(a&&a.children){m.aio.devicemanager._configmanager=b;var d=this;require("async").each(a.children,function(e,g){d._loadTenant(e,g)},function(e){c(e)})}else c()};m.aio.devicemanager.DeviceManager.prototype.addTenant=function(a,b){this._loadTenant(a,b)};
m.aio.devicemanager.DeviceManager.prototype.removeTenant=function(a,b){for(var c=-1,d=0;d<this.handlers.length;d++)if(this.handlers[d].tenant.index==a.index){c=d;break}-1!=c&&this.handlers.splice(c,1);b()};m.aio.devicemanager.DeviceManager.prototype.register=function(a,b){if(!a)throw Error("sys is invalid");if(!b)throw Error("module name is invalid");this.modules[a]=b};m.aio.devicemanager.DeviceManager.prototype.getModuleName=function(a){return a?this.modules[a]:null};
m.aio.devicemanager.DeviceManager.prototype.getModule=function(a){return(a=this.getModuleName(a))?require("xnm.aio."+a+".js"):null};m.aio.devicemanager.DeviceManager.prototype.getDeviceInfo=function(a){for(var b=0;b<this.handlers.length;b++){var c=this.handlers[b];if(c.tenant.index==a)return c.deviceinfo}return null};
m.aio.devicemanager.DeviceManager.prototype.reloadTenant=function(a,b){for(var c=-1,d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e&&e.tenant&&e.tenant.index==a.index){c=d;break}}-1!=c&&this.handlers.splice(c,1);this._loadTenant(a,b)};m.aio.devicemanager.DeviceManager.prototype.execute=function(a,b,c,d,e,g){for(var h=null,f=0;f<this.handlers.length;f++){var k=this.handlers[f];if(k.tenant&&k.tenant.index==b){h=k;break}}h?h.execute(a,c,d,function(l,n){e(l,n)},g):e(Error("no such tenant"))};
m.aio.devicemanager.DeviceManager.prototype.batchModeEnd=function(a,b){for(var c=null,d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e.tenant&&e.tenant.index==a){c=e;break}}c?c._save(b):callback(Error("no such tenant"))};m.aio.devicemanager.DeviceManager.prototype.executeSync=function(a,b,c,d){for(var e=null,g=0;g<this.handlers.length;g++){var h=this.handlers[g];if(h.tenant&&h.tenant.index==b){e=h;break}}if(!e)throw Error("no such tenant");return e.executeSync(a,c,d)};
m.aio.devicemanager.DeviceManager.prototype.deleteUnlicensed=function(a,b){for(var c=null,d=this,e=0;e<this.handlers.length;e++){var g=this.handlers[e];if(g.tenant&&g.tenant.index==a){c=g;break}}c?m.aio.devicemanager._configmanager.trace("config/tenants/"+a,function(h,f){if(h)b&&b(h);else if(f.isAccessible()){var k=f.getRemotes();k&&0!=k.size()?(k=k.getChildren(),c.deleteUnlicensed(function(l,n){l?b&&b(l):k&&0!=k.length?require("async").each(k,function(r,p){d.saveRemoteWithDB(r,n,function(q){p(q)})},
function(r){b&&b(r)}):b&&b()})):b&&b(null)}else b&&b(Error("not permitted"))}):b(Error("no such tenant"))};m.aio.devicemanager.DeviceManager.prototype.getDeviceDBForRemote=function(a,b){for(var c=null,d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e.tenant&&e.tenant.index==a){c=e;break}}c?m.aio.devicemanager._configmanager.trace("config/tenants/"+a,function(g,h){g?b&&b(g):h.isAccessible()?c.deleteUnlicensed(function(f,k){b&&b(f,k)}):b&&b(Error("not permitted"))}):b(Error("no such tenant"))};
m.aio.devicemanager.DeviceManager.prototype.getIntHandler=function(a){for(var b=0;b<this.handlers.length;b++){var c=this.handlers[b];if(c.tenant&&c.tenant.index==a)return c}return null};
m.aio.devicemanager.DeviceManager.prototype.saveRemote=function(a,b){if(a.parent){var c=a.parent.parent;if(c){for(var d=null,e=0;e<this.handlers.length;e++){var g=this.handlers[e];if(g.tenant&&g.tenant.index==c.index){d=g;break}}if(d){var h=this;d.deleteUnlicensed(function(f,k){f?b&&b(f):h.saveRemoteWithDB(a,k,function(l){b&&b(l)})})}else b(Error("no such tenant"))}else b&&b(Error("remote do not belong to any tenant"))}else b&&b(Error("remote is isolated"))};
m.aio.devicemanager.DeviceManager.prototype.saveRemoteWithDB=function(a,b,c){if(a.parent){var d=a.parent.parent;if(d){var e=d.getFolderPath();if(e){var g=a.getFolderPath();a=require("fs");var h=require("path"),f=this,k=e+h.sep+m.aio.devicemanager.DeviceManager.DB,l=g+h.sep+m.aio.devicemanager.DeviceManager.DB;a.writeFile(l,JSON.stringify(b),function(n){n?c&&c(n):(k=e+h.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,l=g+h.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,f._copyFile(k,l,function(r){c&&
c(r)}))})}else c&&c(Error("invalid tenant folder"))}else c&&c(Error("remote do not belong to any tenant"))}else c&&c(Error("remote is isolated"))};m.aio.devicemanager.DeviceManager.prototype.clearRemoteDB=function(a,b){var c=require("fs-extra"),d=require("path");a=a.getFolderPath()+d.sep+m.aio.devicemanager.DeviceManager.DB;c.remove(a,b)};m.aio.devicemanager.DeviceManager.prototype.prepareContentForWriting=function(a){return require("x.crypt").AES.encodeString(a,this.ml_v1_info())};
m.aio.devicemanager.DeviceManager.prototype.removeAuthDataFromJSON=function(a){var b={};Array.isArray(a)&&(b=[]);var c="accessToken password pwd refreshToken token user username".split(" "),d;for(d in a){var e=a[d];null!==e&&"object"===typeof e?b[d]=this.removeAuthDataFromJSON(e):0<=c.indexOf(d)?b[d]="":b[d]=e}return b};
m.aio.devicemanager.DeviceManager.prototype.writeFileEncrypted=function(a,b,c){var d=require("fs"),e=require("x.crypt");try{b=e.AES.encodeString(b,this.ml_v1_info()),d.writeFile(a,b,function(g){c&&c(g)})}catch(g){c&&c(g)}};m.aio.devicemanager.DeviceManager.prototype._copyFile=function(a,b,c){var d=require("fs-extra");d.exists(a,function(e){e?d.copy(a,b,function(g){c&&c(g)}):c&&c()})};
m.aio.devicemanager.DeviceManager.prototype._loadTenant=function(a,b){var c=function(p,q){require("fs").writeFile(p,m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO,function(t){q(t)})},d=function(p,q,t){var v=require("fs");v.exists(q,function(w){w?v.readFile(q,{encoding:"utf8"},function(x,u){x||0<u.length&&p.setDeviceInfo(u);t()}):c(q,function(x){x?t():v.readFile(q,{encoding:"utf8"},function(u,y){u||0<y.length&&p.setDeviceInfo(y);t()})})})},e=this,g=require("path"),h=a.getFolderPath();if(h){var f=
new m.aio.devicemanager.IntHandler(e,a,{devices:[],rooms:[],gateways:[]});this.handlers.push(f);a=h+g.sep+m.aio.devicemanager.DeviceManager.DB;var k=h+g.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,l=require("fs-extra"),n=!1;l.existsSync(a+".enc")&&(a+=".enc",n=!0);var r=function(){d(f,k,function(){b&&b()})};(function(p,q,t){var v=require("fs");v.exists(q,function(w){w?v.readFile(q,{encoding:"utf8"},function(x,u){if(!x&&0<u.length)try{String(q).endsWith(".enc")&&(u=u.replace(/[\r\n]/g,""),u=
require("x.crypt").AES.decodeString(u,e.ml_v1_info()));var y=JSON.parse(u);y&&(p.data=y,p.data.devices||(p.data.devices=[]),p._sort(p.data.devices),p.data.gateways||(p.data.gateways=[]),p._sort(p.data.gateways),p.data.rooms||(p.data.rooms=[]),p._sort(p.data.rooms))}catch(A){console.error(A)}t()}):v.writeFile(q,"",function(){t()})})})(f,a,function(){n?r():f._save(function(){var p=g.join(h,"cloud"),q=g.join(h,"automation"),t=g.join(h,"remotes");if(l.existsSync(p))try{l.remove(p)}catch(z){console.error(z)}if(l.existsSync(q))try{var v=
l.readdirSync(q);for(p=0;p<v.length;p++){var w=v[p];if(l.statSync(g.join(q,w)).isDirectory()){var x=g.join(q,w,"db");l.existsSync(x)&&l.remove(x)}}}catch(z){console.error(z)}if(l.existsSync(t))try{var u=l.readdirSync(t);for(q=0;q<u.length;q++){var y=u[q];if(l.statSync(g.join(t,y)).isDirectory()){var A=g.join(t,y,"device_db");l.existsSync(A)&&l.remove(A)}}}catch(z){console.error(z)}r()})})}else b()};
m.aio.devicemanager.DeviceManager.prototype.supportSmartWidget=function(a,b){if(!a||!a.info)return!1;var c=null;a.info.gateway&&b&&(b=this.getIntHandler(b))&&(b=b.findGatewayWithIndex(a.info.gateway))&&(c=b);return require("m.aio.smartwidget.js").supportSmartWidget(a.info,c?c.info:null)};
m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilter=function(a,b,c,d){var e=this.getIntHandler(a);if(e)if(a=e.findDeviceWithIndex(b))if(a.info){var g=e.findRoomWithIndex(a.room),h=null;g&&(h=g.name);g=null;a.info.gateway&&e&&(g=e.findGatewayWithIndex(a.info.gateway));var f=require("m.aio.smartwidget.js");e=JSON.parse(JSON.stringify(a));if(b=f.applySmartWidgetFilter(a.info,g?g.info:null,c,{index:b,name:a.name,room:h}))e.smartwidget=b;d&&d(null,e)}else d&&d(null,[]);else b=Error("can not read device with id:"+
b),b.code=500,d&&d(b);else b=Error("no such tenant with index:"+a),b.code=500,d&&d(b)};
m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilterForGateway=function(a,b,c,d){var e=this.getIntHandler(a);if(e)if(e=e.findGatewayWithIndex(b))if(e.info){var g=this.getModule(e.info.sys);if(g&&g.devicemanager&&g.devicemanager.applySmartWidgetFilterForGateway){a=JSON.parse(JSON.stringify(e));if(b=g.devicemanager.applySmartWidgetFilterForGateway(e.info,c,{index:b,name:e.name}))a.smartwidget=b;d&&d(null,a)}else d&&d(null,[])}else d&&d(null,[]);else b=Error("can not read device with id:"+
b),b.code=500,d&&d(b);else b=Error("no such tenant with index:"+a),b.code=500,d&&d(b)};m.aio.devicemanager.DeviceManager.prototype.ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3")};
m.aio.devicemanager.DeviceManager.prototype.toGeneralDevice=function(a,b,c,d){var e=this.getIntHandler(a);e?(a=c?e.findDeviceWithIndexIngnoreLicense(b):e.findDeviceWithIndex(b))?a.info?(b=this.getModule(a.info.sys))&&b.devicemanager&&b.devicemanager.toGeneralDevice?(e=b.devicemanager.toGeneralDevice(a.info,e.deviceinfo),d&&d(null,e)):d&&d(null,null):d&&d(null,null):(e=Error("can not read device with id:"+b),e.code=500,d&&d(e)):(e=Error("no such tenant with index:"+a),e.code=500,d&&d(e))};
m.aio.devicemanager.DeviceManager.prototype.Handler=m.aio.devicemanager.IntHandler;m.aio.devicemanager.DeviceManager.prototype.Filter=m.aio.devicemanager.Filter;m.aio.devicemanager.Handler=m.aio.devicemanager.DeviceManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.devicemanager.Handler);
