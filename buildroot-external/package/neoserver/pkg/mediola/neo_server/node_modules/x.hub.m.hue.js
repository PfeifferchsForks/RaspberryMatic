var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.hue=x.hub.m.hue||{};x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js");
x.hub.m.hue.Monitor=function(){var f=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor");this._running=!1;this._bridge=a;this._devices={};this._sensors={}};f.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._bridge.ip);this._running||(this._running=!0,this._getAllSensors());a&&a()};f.prototype.addStateDevice=function(a,b){a&&a.address&&(this._devices[a.address]=a);b&&b()};f.prototype._getAllSensors=function(){var a=this;this._logger.log("trace",
"get all sensors for:"+this._bridge.ip);x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(b,c){b?(a._logger.log("trace","get all sensors for:"+a._bridge.ip+" error:"+b.message),setTimeout(function(){a._getAllSensors()},1E3)):(!b&&c&&a._receiveSensors(c),a._running&&a._getAllSensors())})};f.prototype._receiveSensors=function(a){var b=function(n){for(var p={},m=0;m<n.length;m++){var q=n[m].getAddress(),r=n[m].getStates();p[q]=r}return p},c=b(this._sensors);b=b(a);this._sensors=a;for(var k=
0;k<a.length;k++){var h=a[k],g=h.getAddress();if(this._devices[g]){h=h.getType();var d=c[g],e=b[g],l=!1;if(e)switch(h){case "ZLLLightLevel":this._produceEvent(this._devices[g],"lightlevel",d?d.lightlevel:null,e.lightlevel);this._produceEvent(this._devices[g],"dark",d?d.dark:null,e.dark);this._produceEvent(this._devices[g],"daylight",d?d.daylight:null,e.daylight);this._produceEvent(this._devices[g],"battery",d?d.battery:null,e.battery);break;case "ZLLTemperature":this._produceEvent(this._devices[g],
"temperature",d?d.temperature:null,e.temperature);this._produceEvent(this._devices[g],"battery",d?d.battery:null,e.battery);break;case "ZLLPresence":this._produceEvent(this._devices[g],"motion",d?d.motion:null,e.motion);break;case "ZLLSwitch":d&&(l=!1,e.ltime!=d.ltime&&(l=!0),this._produceEvent(this._devices[g],"levent",d?d.levent:null,e.levent),e.btn1event&&this._produceEvent(this._devices[g],"btn1event",d.btn1event,e.btn1event,l),e.btn2event&&this._produceEvent(this._devices[g],"btn2event",d.btn2event,
e.btn2event,l),e.btn3event&&this._produceEvent(this._devices[g],"btn3event",d.btn3event,e.btn3event,l),e.btn4event&&this._produceEvent(this._devices[g],"btn4event",d.btn4event,e.btn4event,l),this._produceEvent(this._devices[g],"battery",d.battery,e.battery));break;case "ZGPSwitch":d&&(l=!1,e.ltime!=d.ltime&&(l=!0),this._produceEvent(this._devices[g],"levent",d?d.levent:null,e.levent,l))}}}};f.prototype._produceEvent=function(a,b,c,k,h){if(c!=k||h)this._logger.log("debug","receive new status:"+JSON.stringify({address:a.address,
key:b,value:k})),h=c,c==k&&(h=null),require("x.hub.eventbus.js").emit("status",{module:"hue",device:a,gateway:a.gateway,data:{key:b,value:k,oldvalue:h,changed:!0}})};return f}();
x.hub.m.hue.Handler=function(){var f=function(){this._monitors={}};util.inherits(f,EventEmitter);f.prototype.init=function(a){a&&a()};f.prototype.getSystems=function(){return["hue"]};f.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,k){c?b&&b({error:c}):k.addStateDevice(a,function(h){b&&b({error:h})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};f.prototype.getAllStates=function(){return[]};f.prototype.getStates=
function(a){return null};f.prototype.getState=function(a,b,c){a?a.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",a.gateway,a,{value:b},function(k,h){k?c&&c({error:k}):h?c&&c({data:{value:h.status}}):c&&c({error:Error("do status failed")})}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};f.prototype.executeCommand=function(a,b,c){x.hub.m.hue.HUE_MODULE.doCommand(a.gateway,a,b,c)};f.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&
b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.address==a.device.address:!1};f.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;this._monitors[c]?b&&b(null,this._monitors[c]):(a=x.hub.m.hue.HUE_MODULE.resolveGateway(a))?(a=new x.hub.m.hue.Monitor(a),this._monitors[c]=a,a.start(),b&&b(null,a)):b&&b(Error("hue gateway format invalid"))}else b&&b(Error("harmony hub format invalid"))};return f}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler);
