var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tado=xnm.aio.tado||{};
xnm.aio.tado.Bridge=function(){var k=function(g,d){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.Bridge");this.user=g;this.password=d};k.prototype.executeCommandCreator=function(g,d,a){if(d&&d.value){g=d.value;if("setTo"==d.value){if(null==d.ext||"undefined"==typeof d.ext){a&&a(Error("command ext format invalid"));return}g=d.value+d.ext}this.executeCommand(g,function(c){a&&a(c)})}else a&&a(Error("command format invalid"))};k.prototype.getStatesCreator=function(g,d,a){d?this.getState(function(c,
b){c=[];for(var e=0;e<d.length;e++){var l=d[e],m="?";if(l.id&&l.status&&l.status.value&&b){var f=b[l.status.value];null!=f&&"undefined"!=typeof f&&(m=f)}c.push({id:l.id,status:m})}a&&a(null,c)}):a&&a(Error("deviceList is null"))};k.prototype._doRequest=function(g,d,a){var c=g+"?";g=null;if(d)for(var b in d)d.hasOwnProperty(b)&&(c+=b+"="+encodeURIComponent(d[b])+"&");g=c;c+="username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);d={host:"my.tado.com",path:c,method:"GET",
headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","send https request to:"+(g+"username=xxxxxx&password=xxxxxx"));var e=this,l=require("https").request(d,function(m){m.setEncoding("utf-8");var f="";m.on("data",function(h){f+=h});m.on("end",function(){e._logger.log("trace","receive https response code:"+m.statusCode+" body:"+f);if(200==m.statusCode){var h=null;try{h=JSON.parse(f),a&&(a(null,h),a=null)}catch(p){a&&(a(Error("https response invalid json")),
a=null)}}else a&&(a(Error("https response code:"+m.statusCode),f),a=null)})});l.on("error",function(m){e._logger.log("trace","send https request err:"+m.message);a&&(a(m),a=null)});l.setTimeout(2E3,function(){e._logger.log("trace","send https request timeout");l.abort();a&&(a(Error("https request timeout")),a=null)});l.end()};k.prototype.executeCommand=function(g,d){var a=!0,c=null,b=null,e=this;if("auto"==g)c="/mobile/1.9/updateThermostatSettings",b={setMode:"AUTO"};else if("up"==g||"down"==g)this.getState(function(m,
f){m?d&&d(m):f&&f.mode&&f.temp?(m=parseFloat(f.temp),m="up"==g?m+.5:m-.5,5>m?m=5:25<m&&(m=25),m=m.toFixed(1),b={setMode:"MANUAL",manualTemp:m},e._doRequest("/mobile/1.9/updateThermostatSettings",b,function(h){d&&d(h)})):d&&d(m,f)}),a=!1;else if(0==g.indexOf("setTo")){g=g.replace(/setTo/g,"");g=g.replace(/%/g,"");var l=parseFloat(g);5>l?l=5:25<l&&(l=25);l=l.toFixed(1);c="/mobile/1.9/updateThermostatSettings";b={setMode:"MANUAL",manualTemp:l}}c?this._doRequest(c,b,function(m){d&&d(m)}):a&&d&&d()};k.prototype.getState=
function(g){var d={},a=this;this._doRequest("/mobile/1.9/getCurrentState",null,function(c,b){c?g(c):(b&&(d.heatingOn=b.heatingOn,d.temp=parseFloat(b.setPointTemp).toFixed(1),d.insideTemp=parseFloat(b.insideTemp).toFixed(1),d.mode=b.operation),b.homeId?a._doRequest("/api/v1/home/"+b.homeId+"/hvacState",null,function(e,l){l&&l.humidity&&(d.humidity=l.humidity.percentage);g&&g(e,d)}):g&&g(c,d))})};k.prototype.getStateValues=function(g,d){return d};k.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,
username:this.user,password:this.password}};k.prototype.equalsTo=function(g){return g&&g instanceof k?this.user==g.user&&this.password==g.password:!1};k.parseJSON=function(g){return g.username&&g.password?new k(g.username,g.password):null};return k}();
xnm.aio.tado.BridgeV2=function(){var k={},g=function(a,c){var b={temp:20,type:"MANUAL",durationInSeconds:60};return k[a+"_"+c]=b},d=function(a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.BridgeV2");this.user=a;this.password=c;this._zoneStateCBS={}};d.prototype.getZones=function(a){var c=this;this._getMe(function(b,e){if(b)a&&a(b);else{var l=[],m=e.homes,f=0,h=function(p,n){if(!p&&n){p=m[f].id;for(var r=0;r<n.length;r++){var q=n[r];l.push({name:q.name,type:"zone",homeID:p,zoneID:q.id})}}f++;
f<m.length?c._getZones(m[f].id,h):a&&a(null,l)};c._getZones(m[f].id,h)}})};d.prototype.executeCommandCreator=function(a,c,b){c&&c.value?a&&"thermo"==a.type?(new xnm.aio.tado.Bridge(this.user,this.password)).executeCommandCreator(a,c,b):this.executeCommand(a,c,function(e){b&&b(e)}):b&&b(Error("command format invalid"))};d.prototype.getStatesCreator=function(a,c,b){if(c){for(var e=[],l=[],m=[],f=0;f<c.length;f++){var h=c[f];h&&h.device&&"thermo"==h.device.type&&m.push(h);h.device&&h.device.homeID&&
h.device.zoneID&&-1==e.indexOf(h.device.homeID+"_"+h.device.zoneID)&&l.push(h.device)}var p=1,n=[];0<m.length&&(p=2,(new xnm.aio.tado.Bridge(this.user,this.password)).getStatesCreator(a,m,function(r,q){p--;!r&&q&&(n=n.concat(q));0==p&&b&&b(null,n)}));this.getState(l,function(r,q){for(var t=0;t<c.length;t++){var u=c[t];if(u&&u.id){var v="?";if(!r&&q&&u.device&&u.device.homeID&&u.device.zoneID){var w=q[u.device.homeID+"_"+u.device.zoneID];w&&u.status&&u.status.value&&(w=w[u.status.value],null!=w&&"undefined"!=
typeof w&&(v=w))}n.push({id:u.id,status:v})}}p--;0==p&&b&&b(null,n)})}else b&&b(Error("deviceList is null"))};d.prototype.executeCommand=function(a,c,b){if(a&&"zone"==a.type&&a.homeID&&a.zoneID)if(c&&c.value){var e="GET",l="/api/v2/homes/"+a.homeID+"/zones/"+a.zoneID+"/overlay",m=null;switch(c.value){case "auto":e="DELETE";break;case "off":var f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));e="PUT";m={setting:{type:"HEATING",power:"OFF"},termination:{type:f.type}};"TIMER"==f.type&&(m.termination.durationInSeconds=
f.durationInSeconds);break;case "start":f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));e="PUT";m={setting:{type:"HEATING",power:"ON",temperature:{celsius:f.temp}},termination:{type:f.type}};"TIMER"==f.type&&(m.termination.durationInSeconds=f.durationInSeconds);break;case "setManuEndMode":switch(c.ext){case "MANUAL":case "TIMER":case "TADO_MODE":f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));f.type=c.ext;b&&b();break;default:b&&b(Error("setManuEndMode ext invalid"))}return;
case "setManuEndTimer":if(!c.ext){b&&b(Error("setManuEndTimer ext invalid"));return}c=parseInt(c.ext);isNaN(c)&&(c=1);1>c&&(c=1);f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));f.durationInSeconds=60*c;b&&b();return;case "setTo":if(!c.ext){b&&b(Error("setTo ext invalid"));return}var h=parseFloat(c.ext);5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));f.temp=h;b&&b();break;case "up":case "down":e=parseFloat(c.ext);if(!e||isNaN(e))e=
1;f=a.homeID+"_"+a.zoneID;(f=k[f])||(f=g(a.homeID,a.zoneID));h=f.temp;h="up"==c.value?h+e:h-e;5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);f.temp=h;b&&b();return;default:b&&b(Error("unknown command"));return}this._doRequest(e,l,JSON.stringify(m),function(p){b&&b(p)})}else b&&b(Error("command json invalid"));else b&&b(Error("device json invalid"))};d.prototype.getState=function(a,c){for(var b={},e=a.length,l=e,m=function(){e--;0==e&&c&&c(null,b)};l--;){var f=a[l];f&&f.homeID&&f.zoneID?this.getZoneState(f.homeID,
f.zoneID,function(h,p,n,r){!h&&p&&(b[n+"_"+r]=p);m()}):m()}};d.prototype.getZoneState=function(a,c,b){var e=a+"_"+c,l=this._zoneStateCBS[e];l||(l=[],this._zoneStateCBS[e]=l);var m=l.length;b||(b=function(){});-1==l.indexOf(b)&&l.push(b);if(0==m){var f=this;this._getZoneState(a,c,function(h,p){delete f._zoneStateCBS[e];var n=l.length;if(h)for(;n--;)l[n]&&l[n](h);else for(h=f._resolveZoneState(p),n=f._getZoneManuTermination(a,c),h||(h={}),h.setManutemp=n.setManutemp,h.setManuEndMode=n.setManuEndMode,
h.setManuEndTimer=n.setManuEndTimer,n=l.length;n--;)l[n]&&l[n](null,h,a,c)})}};d.prototype._getZoneManuTermination=function(a,c){var b=k[a+"_"+c];b||(b=g(a,c));a={};a.setManutemp=b.temp;a.setManuEndMode=b.type;a.setManuEndTimer=b.durationInSeconds;a.setManuEndTimer&&(a.setManuEndTimer/=60);return a};d.prototype._resolveZoneState=function(a){var c={manuEndTimer:0,manuEndTimerRemainS:0,manuEndTimerRemain:0,manuEndTimerRemainTxt:"",manuEndAutoExpire:null};a.tadoMode&&(c.mode=a.tadoMode);a.overlayType&&
(c.mode=a.overlayType);var b=a.setting,e;b&&((e=b.temperature)&&"undefined"!=typeof e.celsius&&null!=e.celsius&&(c.temp=e.celsius),b.power&&(c.power=b.power,"OFF"==b.power&&(c.temp=0,c.mode="FROZEN_PROTECTION")));(b=a.activityDataPoints)&&(b=b.heatingPower)&&"undefined"!=typeof b.percentage&&null!=b.percentage&&(c.heatingPower=b.percentage);if(b=a.sensorDataPoints)(e=b.insideTemperature)&&"undefined"!=typeof e.celsius&&null!=e.celsius&&(c.insideTemp=e.celsius),(b=b.humidity)&&"undefined"!=typeof b.percentage&&
null!=b.percentage&&(c.humidity=b.percentage);if(a=a.overlay){if(b=a.setting)(e=b.temperature)&&"undefined"!=typeof e.celsius&&null!=e.celsius&&(c.temp=e.celsius),b.power&&(c.power=b.power,"OFF"==b.power&&(c.temp=0,c.mode="FROZEN_PROTECTION"));if(e=a.termination)e.type&&(c.manuEndMode=e.type),"TIMER"==e.type?(c.manuEndTimer=Math.round(e.durationInSeconds/60),c.manuEndTimerRemainS=e.remainingTimeInSeconds,c.manuEndTimerRemain=Math.round(e.remainingTimeInSeconds/60),a=Math.floor(e.remainingTimeInSeconds/
3600),b=Math.floor(e.remainingTimeInSeconds%3600/60),e=e.remainingTimeInSeconds%60,a=""+a,2>a.length&&(a="0"+a),b=""+b,2>b.length&&(b="0"+b),e=""+e,2>e.length&&(e="0"+e),c.manuEndTimerRemainTxt=a+":"+b+":"+e,c.manuEndAutoExpire=null):"TADO_MODE"==e.type?(c.manuEndTimer=0,c.manuEndTimerRemainS=0,c.manuEndTimerRemain=0,c.manuEndTimerRemainTxt="",c.manuEndAutoExpire=(new Date(e.projectedExpiry)).toTimeString()):(c.manuEndTimer=0,c.manuEndTimerRemainS=0,c.manuEndTimerRemain=0,c.manuEndTimerRemainTxt=
"",c.manuEndAutoExpire=null)}return c};d.prototype._getMe=function(a){this._doRequest("GET","/api/v2/me",null,function(c,b){a&&a(c,b)})};d.prototype._getZones=function(a,c){this._doRequest("GET","/api/v2/homes/"+a+"/zones",null,function(b,e){c&&c(b,e)})};d.prototype._getZoneState=function(a,c,b){this._doRequest("GET","/api/v2/homes/"+a+"/zones/"+c+"/state",null,function(e,l){b&&b(e,l)})};d.prototype._doRequest=function(a,c,b,e){var l=c;c+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);
c={host:"my.tado.com",path:c,method:a,headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","do https "+a+" request:"+(l+"?username=xxxxxx&password=xxxxxx"));b&&this._logger.log("trace","https body:"+b);var m=this,f=require("https").request(c,function(h){h.setEncoding("utf-8");var p="";h.on("data",function(n){p+=n});h.on("end",function(){m._logger.log("trace","receive https response code:"+h.statusCode+" body:"+p);if(200==h.statusCode||204==h.statusCode){var n=
null;try{if(204!=h.statusCode||p)n=JSON.parse(p);e&&(e(null,n),e=null)}catch(r){e&&(e(Error("https response invalid json")),e=null)}}else e&&(e(Error("https response code:"+h.statusCode),p),e=null)})});f.on("error",function(h){m._logger.log("trace","send https request err:"+h.message);e&&(e(h),e=null)});f.setTimeout(2E3,function(){m._logger.log("trace","send https request timeout");f.abort();e&&(e(Error("https request timeout")),e=null)});b&&f.write(b);f.end()};d.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,
username:this.user,password:this.password}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.user==a.user&&this.password==a.password:!1};d.parseJSON=function(a){return a.username&&a.password?new d(a.username,a.password):null};return d}();
xnm.aio.tado.DM=function(){var k=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};k.prototype=Error();k.prototype.name="TadoDMError";k.prototype.code=0;k.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var g={thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"float",name:"manu",ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}}],
status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE"]}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}}]},zone:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"start",ref:{value:"start"}},{type:"float",name:"set manu temperature",
ref:{value:"setTo",value_t:"temperature",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",extMeta:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"float",name:"up",ref:{value:"up",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}},{type:"float",name:"down",ref:{value:"down",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}}],status:[{type:"enum",
name:"mode",ref:{value:"mode",options:"HOME SLEEP AWAY MANUAL NO_FREEZE FROZEN_PROTECTION".split(" ")}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}},{type:"int",name:"heating power",ref:{value:"heatingPower"}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"current manu termination mode",ref:{value:"manuEndMode",
ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"current manu termination timer",ref:{value:"manuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"string",name:"current manu termination auto expire time",ref:{value:"manuEndAutoExpire",ext:"%s"}},{type:"int",name:"current manu termination timer remain (min)",ref:{value:"manuEndTimerRemain",unit:"min"}},{type:"int",name:"current manu termination timer remain (s)",ref:{value:"manuEndTimerRemainS",unit:"s"}},{type:"string",name:"current manu termination timer remain (text)",
ref:{value:"manuEndTimerRemainTxt"}},{type:"float",name:"set manu temperature",ref:{value:"setManutemp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}}]}};return{SYS:"tado",getGatewayType:function(){return[{sys:this.SYS,name:"tado\u00b0"}]},getGatewayDeviceType:function(d,a){return[{type:"thermo",
name:"Smart Thermostat",sys:this.SYS}]},createGateway:function(d,a,c){a=k.ERROR_CODE;d?d.username?d.password?c(null,d):c(new k(a.INVALID,"password is invalid")):c(new k(a.INVALID,"username is invalid")):c(new k(a.INVALID,"info is invalid"))},updateGateway:function(d,a,c,b){d=k.ERROR_CODE;a?a.username?a.password?b(null,a):b(new k(d.INVALID,"password is invalid")):b(new k(d.INVALID,"username is invalid")):b(new k(d.INVALID,"info is invalid"))},deleteGateway:function(d,a,c){c()},createDevice:function(d,
a,c){var b=k.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var l=a[e];break}l?c(null,d):c(new k(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new k(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else c(new k(b.INVALID,"type is invalid"));else c(new k(b.INVALID,"gateway is invalid"));else c(new k(b.INVALID,"info is invalid"))},updateDevice:function(d,
a,c){var b=k.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var l=a[e];break}l?c(null,d):c(new k(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new k(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else c(new k(b.INVALID,"type is invalid"));else c(new k(b.INVALID,"gateway is invalid"));else c(new k(b.INVALID,"info is invalid"))},deleteDevice:function(d,
a,c){c()},applyUIFilter:function(d,a,c){var b=this,e=function(h,p,n){var r=[];h.forEach(function(q){if("root"==q.type){q=JSON.parse(JSON.stringify(q));var t=e(q.children,p,n);t&&0<t.length&&(q.children=t,r.push(q))}else{t=n.elems;if("*"==t)t=!0;else{for(var u=!1,v=0;v<t.length;v++)if(t[v]==q.type){u=!0;break}t=u}t&&(q=JSON.parse(JSON.stringify(q)),r.push(q))}});return r},l=function(h,p){var n=[],r=b.getCommandStatusMap(h,c);if(r){var q=[];switch(p.catagory){case "command":r.command&&(q=e(r.command,
h,p));break;case "status":r.status&&(q=e(r.status,h,p))}n=n.concat(q)}return n};if(!d.sys)return null;var m=JSON.parse(JSON.stringify(d)),f=null;switch(a.catagory){case "command":f=l(d,a);m.command=f;break;case "status":f=l(d,a);m.status=f;break;default:return null}return f&&0!=f.length?m:null},getCommandStatusMap:function(d){return d&&d.type?g[d.type]:null}}}();
xnm.aio.tado.Handler=function(){var k=function(){};k.prototype.Bridge=xnm.aio.tado.Bridge;k.prototype.BridgeV2=xnm.aio.tado.BridgeV2;k.prototype.devicemanager=xnm.aio.tado.DM;k.prototype.registModule=function(g){g.register(this.devicemanager.SYS,"tado")};k.prototype.resolveGateway=function(g){return g?this.BridgeV2.parseJSON(g):null};k.prototype.getDeviceCommands=function(g,d){g=(g=this.devicemanager.applyUIFilter(g,{catagory:"command",elems:"*"}))?g.command:[];d&&d(null,g)};k.prototype.getDeviceStatus=
function(g,d){g=(g=this.devicemanager.applyUIFilter(g,{catagory:"status",elems:"*"}))?g.status:[];d&&d(null,g)};k.prototype.doCommand=function(g,d,a,c){(g=this.resolveGateway(g))?g.executeCommandCreator(d,a,function(b){c&&c(b)}):c&&c(Error("gateway json format invalid"))};k.prototype.doStatus=function(g,d,a,c,b){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:g,device:a,status:c}],function(e,l){e?b&&b(e):b&&b(null,l[0])}):b&&b(Error("gateway json format invalid"))};k.prototype.getDeviceList=
function(g,d){(g=this.resolveGateway(g))?g.getZones(function(a,c){d&&d(a,c)}):d&&d(Error("gateway json format invalid"))};k.prototype.getStateValues=function(g,d){};k.prototype.getDeviceCommandList=function(g,d,a){g=[];d&&(g.push({id:window.XC_Text.on,cmd:"on"}),g.push({id:window.XC_Text.off,cmd:"off"}));return g};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.tado.Handler);
