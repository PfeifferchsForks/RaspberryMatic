var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.lg=xnm.aio.lg||{};xnm.aio.lg.CRC_TABLE=null;
xnm.aio.lg.TV=function(){var e=function(b,a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV");this.ip=b;this.port=a;if(!this.port||0>this.port)this.port=8080;this.udpport=7070;this.authKey=c;this.controlUrl="/hdcp/api/dtv_wifirc";this.authUrl="/hdcp/api/auth"};e.AUTHKEY_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthKeyReq</type></auth>';e.AUTH_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthReq</type><value>%@</value></auth>';e.KEY_INPUT='<?xml version="1.0" encoding="utf-8"?><command><session>%@1</session><type>HandleKeyInput</type><value>%@2</value></command>';
e.prototype._executeCommand=function(b,a){if(b){this._logger.log("debug","execute command:"+b);var c=this;this._getSession(function(d,f){d?a&&a(d):"u"==b.charAt(0).toLowerCase()?(d=b.substr(1),f=c._buildUdpReq(f,d),c._doUdpCommand(f,a)):c._doHttpCommand(f,b,a)})}else a&&a(Error("code is empty"))};e.prototype._showAuthKey=function(b){this._logger.log("debug","auth key");var a=this;this._doRequest(this.authUrl,e.AUTHKEY_REQ,function(c){a._logger.log("warn","auth key "+(c?"error:"+c.message:"success"));
b&&b(c)})};e.prototype._getSession=function(b){if(this.authKey){this._logger.log("debug","get session");var a=e.AUTH_REQ.replace("%@",this.authKey),c=this;this._doRequest(this.authUrl,a,function(d,f){if(d)c._logger.log("warn","get session http error:"+d.message),b&&b(d);else{var g;if(f){d=f.indexOf("<session>");var h=f.indexOf("</session>");-1!=d&&-1!=h&&9<h-d&&(g=f.substring(d+9,h))}g?(c._logger.log("debug","get session success:"+g),b&&b(null,g)):(c._logger.log("warn","get session reponse error"),
b&&b(Error("get session reponse error")))}})}else this._logger.log("warn","no auth key"),b&&b(Error("no auth key"))};e.prototype._doHttpCommand=function(b,a,c){b=e.KEY_INPUT.replace("%@1",b);b=b.replace("%@2",a);this._logger.log("debug","do http command:"+a);this._doRequest(this.controlUrl,b,function(d){c&&c(d)})};e.prototype._buildUdpReq=function(b,a){var c=parseInt(b);b=[0,0,0,0];b.push(c&255);b.push(c>>8&255);b.push(c>>16&255);b.push(c>>24&255);for(c=0;c<a.length;c+=2){var d=a.substr(c,2);d=parseInt(d,
16);b.push(d)}a=this._crc32(b);b[0]=a&255;b[1]=a>>8&255;b[2]=a>>16&255;b[3]=a>>24&255;return b};e.prototype._doUdpCommand=function(b,a){var c=require("dgram").createSocket("udp4");b=new Buffer(b);c.send(b,0,b.length,this.udpport,this.ip,function(d){c.close();a&&a(d)})};e.prototype._doRequest=function(b,a,c){var d=this;b="http://"+this.ip+":"+this.port+b;this._logger.log("trace","send data:"+a);var f=c;$.ajax({url:b,type:"POST",timeout:3E3,data:a,dataType:"text",cache:!1,headers:{"Content-Type":"application/atom+xml",
"Content-Length":a.length},username:this.username,password:this.password,success:function(g){d._logger.log("trace","http request success:"+g);f&&(f(null,g),f=null)},error:function(g,h){g="http request error:"+(g?g.status:"0")+"-"+h;f&&(f(Error(g)),f=null)}})};e.prototype._crc32=function(b){for(var a=xnm.aio.lg.CRC_TABLE||(xnm.aio.lg.CRC_TABLE=this._makeCRCTable()),c=-1,d=0;d<b.length;d++)c=c>>>8^a[(c^b[d])&255];return(c^-1)>>>0};e.prototype._makeCRCTable=function(){for(var b,a=[],c=0;256>c;c++){b=
c;for(var d=0;8>d;d++)b=b&1?3988292384^b>>>1:b>>>1;a[c]=b}return a};return e}();xnm.aio.lg.TV2012=function(){var e=function(b,a,c){xnm.aio.lg.TV.call(this,b,a,c);this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV2012");this.controlUrl="/roap/api/command";this.authUrl="/roap/api/auth"};e.prototype=Object.create(xnm.aio.lg.TV.prototype);return e.prototype.constructor=e}();
xnm.aio.lg.BDP=function(){var e=function(a,c,d){this.bdp=a;this.code=c;this.callback=d;this._socket=null};e.prototype.run=function(){var a=this;this.bdp._connect({onError:function(c){a._finish(c)},onTimeout:function(){a._finish(Error("response timeout"))},onData:function(){a._socket.end();a._finish()},onClose:function(){a._finish()}},function(c,d){c?a._finish(c):(a._socket=d,c=a.bdp._buildReq(a.code),a.bdp._logger&&a.bdp._logger.log("trace","send lg bdp request:"+c),d.write(c,"hex"))})};e.prototype._finish=
function(a){a&&this.bdp._logger.log("warn","execute lg bdp command error:"+a.message);this.callback&&this.callback(a);this.callback=null;this.bdp._finishTask(this)};var b=function(a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.BDP");this.ip=a;this.port=c;this.port||(this.port=9740);this._tasks=[]};b.prototype._executeCommand=function(a,c){a=new e(this,a,c);this._tasks.push(a);a.run()};b.prototype._finishTask=function(a){for(var c=-1,d=0;d<this._tasks.length;d++)if(this._tasks[d]===
a){c=d;break}-1!=c&&this._tasks.splice(c,1)};b.prototype._buildReq=function(a){return 30>a.length?a+"02"+a+"01":a};b.prototype._hex2arr=function(a){for(var c=[],d=0;d<a.length;d+=2)c.push(parseInt(a.substr(d,2),16));return c};b.prototype._connect=function(a,c){var d=this,f={port:this.port,host:this.ip},g=!1,h=c,k=require("net").connect(f);a.__socket=k;k.setTimeout(1E4);k.setEncoding("hex");k.on("connect",function(){d._logger.log("trace","connect tcp to:"+d.ip);g=!0;if(h){var l=a.__socket;delete a.__socket;
h(null,l)}});k.on("data",function(l){d._logger.log("trace","receive from tcp:"+d.ip+" data:"+l);a.onData(l)});k.on("error",function(l){g?(d._logger.log("trace","tcp:"+d.ip+" error:"+l.message),k.end(),a.onError(l)):(d._logger.log("trace","tcp:"+d.ip+" connection error:"+l.message),h&&(h(l),h=null))});k.on("timeout",function(){g?(d._logger.log("trace","tcp:"+d.ip+" data timeout"),k.end(),a.onTimeout()):(d._logger.log("trace","tcp:"+d.ip+" connection timeout"),k.end(),h&&(h(Error("connection timeout")),
h=null))});k.on("close",function(){d._logger.log("trace","tcp:"+d.ip+" close socket");a.onClose()});k._doConnect&&"function"==typeof k._doConnect&&k._doConnect()};return b}();xnm.aio.lg.BDP.DM=function(){return{SYS:"lgav",getIPDeviceType:function(){return{sys:this.SYS,name:"LG BDP"}}}}();
xnm.aio.lg.DM=function(){var e=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};e.prototype=Error();e.prototype.name="LGDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{getSys:function(){var b=[],a;for(a in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(a)&&xnm.aio.lg[a]&&xnm.aio.lg[a].DM&&b.push(xnm.aio.lg[a]);return b},registModule:function(b){for(var a=this.getSys(),c=0;c<a.length;c++)a[c]&&a[c].DM&&a[c].DM.SYS&&
b.register(a[c].DM.SYS,"lg")},getIPDeviceType:function(){return[]}}}();
xnm.aio.lg.Handler=function(){var e=function(){};e.prototype.devicemanager=xnm.aio.lg.DM;e.prototype.BDP=xnm.aio.lg.BDP;e.prototype.TV=xnm.aio.lg.TV;e.prototype.TV2012=xnm.aio.lg.TV2012;e.prototype.registModule=function(b){this.devicemanager.registModule(b)};e.prototype.showAuthKey=function(b,a){if(b&&b.ip){var c=new xnm.aio.lg.TV(b.ip,b.port);"lgtv2012"==b.id&&(c=new xnm.aio.lg.TV2012(b.ip,b.port));c._showAuthKey(a)}else a&&a(Error("device json invalid format"))};return e}();
"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.lg.Handler);
