var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.eltako=xnm.aio.eltako||{};xnm.aio.eltako.Gateway=function(){var g=function(d){this._ip=d.ip;this._port=d.port;this._username=d.username;this._password=d.password;this._uuid=d.uuid;this._port||(this._port=35689)};g.parseJSON=function(d){return d&&d.ip?new g(d):null};return g}();
xnm.aio.eltako._Session=function(){var g=[135,168,230,29,180,182,102,60,255,187,209,156,101,25,89,153,140,238,246,8,102,13,208,242,93,44,238,212,67,94,59,0,224,13,248,241,214,25,87,212,250,247,223,69,97,178,170,48,22,195,217,17,52,9,111,170,59,244,41,109,131,14,154,124,32,158,12,100,151,81,122,189,90,138,157,48,107,207,103,237,145,249,230,114,91,71,88,192,34,224,177,239,66,117,191,123,108,91,252,17,212,95,144,136,185,65,245,78,177,229,155,184,188,57,160,191,18,48,127,92,79,219,112,197,129,178,63,
118,182,58,202,225,202,166,183,144,45,82,82,103,53,72,138,14,241,60,109,154,81,191,164,171,58,216,52,119,150,82,77,142,246,161,103,181,164,24,37,217,103,225,68,229,20,5,100,37,28,202,203,131,230,180,134,246,179,202,63,121,113,80,96,38,192,184,87,246,137,150,40,86,222,212,1,10,189,11,230,33,195,163,150,10,84,231,16,195,117,242,99,117,215,1,65,3,164,181,67,48,193,152,175,18,97,22,210,39,110,17,113,95,105,56,119,250,215,239,9,202,219,9,74,233,30,26,21,151],d=[63,179,44,155,115,19,77,11,46,119,80,102,
96,237,189,72,76,167,177,143,33,239,32,84,7,244,121,58,26,11,161,37,16,219,193,80,119,190,70,63,255,79,237,74,172,11,181,85,190,58,108,27,12,107,71,177,188,55,115,191,126,140,111,98,144,18,40,248,194,140,187,24,165,90,227,19,65,0,10,101,1,150,249,49,199,122,87,242,221,244,99,229,233,236,20,75,119,125,230,42,170,184,168,98,138,195,118,210,130,214,237,56,100,230,121,130,66,142,188,131,29,20,52,143,111,47,145,147,181,4,90,242,118,113,100,225,223,201,103,193,251,63,46,85,164,189,27,255,232,59,156,128,
208,82,185,133,209,130,234,10,219,42,59,115,19,211,254,20,200,72,75,30,5,37,136,185,183,210,187,210,223,1,97,153,236,208,110,21,87,205,9,21,179,53,59,187,100,224,236,55,127,208,40,55,13,249,43,82,199,137,20,40,205,198,126,182,24,75,82,61,29,178,70,195,47,99,7,132,144,240,14,248,214,71,209,72,212,121,84,81,94,35,39,207,239,152,197,130,102,75,76,15,108,196,22,89],b=function(a){if(!a)throw Error("options is null");if(!a.ip)throw Error("no ip");this._timeout=3E3;this._ip=a.ip;this._port=a.port;this._port||
(this._port=35689);this._username=a.username;this._password=a.password;this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Session.{"+this._ip+":"+this._port+"}");this._state="IDLE";this._listeners={};this._socket=null;this._sequenceID=0;this._buffer={};this._auth=this._settings=null};b.prototype.on=function(a,c){a&&c&&(this._listeners[a]||(this._listeners[a]=[]),-1==this._listeners[a].indexOf(c)&&this._listeners[a].push(c))};b.prototype.off=function(a,c){a&&c&&this._listeners[a]&&(c=this._listeners[a].indexOf(c),
-1!=c&&this._listeners[a].splice(c,1))};b.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var a=this;this._state="CONNECT";var c=new xnm.aio.eltako._Socket({ip:this._ip,port:this._port});this._logger.log("trace","start session to "+this._ip+":"+this._port);c.on("open",function(){a._logger.log("trace","_socket success connect to "+a._ip+":"+a._port);a._init()});c.on("data",function(e){a._onData(e)});c.on("error",function(e){a._logger.log("trace","_socket error: "+e.message);a._emitEvent("error",
e)});c.on("close",function(){a._logger.log("trace","_socket closed");a._onClose()});c.open();this._socket=c}};b.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.close(),this._onClose())};b.prototype.sendObject=function(a,c){"CONNECTED"!=this._state?c&&c(Error("session not connected")):this._sendObject(a,c)};b.prototype._sendObject=function(a,c){var e=this;this._sequenceID++;var f={classType:"bsc.api.transport.TransmissionObject",object:a};f.id=(new Date).getTime()+"";f.sequenceID=
this._sequenceID;this._buffer[f.id]={callback:c,timeout:setTimeout(function(){e._onTimeout(f.id)},this._timeout)};this._logger.log("trace","send object:"+JSON.stringify(f));a=this._buildData(JSON.stringify(f));this._socket.sendData(a)};b.prototype._emitEvent=function(a,c){if(a){var e=this._listeners[a];if(e&&0<e.length)for(var f=0;f<e.length;f++){var k=e[f];try{k(c)}catch(h){this._logger.log("trace","call "+a+" listener failed, error:"+h.message)}}}};b.prototype._buildData=function(a){return require("x.crypt.js").stringToUtf8ByteArray(a)};
b.prototype._parseObject=function(a){a=require("x.crypt.js").utf8ByteArrayToString(a);try{return JSON.parse(a)}catch(c){return null}};b.prototype._init=function(){var a=this;this._doConnectRequest(function(c,e){c?(a._emitEvent("error",c),a.close()):a._sendCaps(null,null,null,e.apiVersions?e.apiVersions[0]:null,e.apiExtensions,function(f,k){f?(a._emitEvent("error",f),a.close()):(a._settings=k,f=a._genKeySig(a._username,a._password),a._sendAuth(a._username,f.key,f.signature,function(h,l){h?(a._emitEvent("error",
h),a.close()):(a._auth=l,a._emitEvent("open",a._settings,a._auth))}))})})};b.prototype._genKeySig=function(a,c){var e=this._genDHKey(),f=(new Buffer(e,"hex")).toString("base64");a=this._genSignature(a,c,e);a=(new Buffer(a,"hex")).toString("base64");return{key:f,signature:a}};b.prototype._genDHKey=function(){var a=require("x.crypt.js"),c=a.bigInt(a.byteArrayToHex(g),16);a=a.bigInt.randBetween(a.bigInt("730750818665451459101842416358141509827966271488"),c.minus(2));c=require("crypto").createDiffieHellman(new Buffer(g),
null,new Buffer(d),null);c.setPrivateKey(a.toString(16),"hex");return c.generateKeys("hex")};b.prototype._genSignature=function(a,c,e){var f=require("crypto"),k=f.createHash("sha256");k.update(c);k=k.digest("hex");a+=k;k=f.createHash("sha256");k.update(e,"hex");e=k.digest("hex");k=f.createHash("sha256");k.update(a,"utf8");k=k.digest("hex");f=f.createCipher("aes-128-cbc",new Buffer(k,"hex"));e=f.update(new Buffer(e,"hex"),null,"hex");return e+=f.final("hex")};b.prototype._doConnectRequest=function(a){this._sendObject({classType:"bsc.api.transport.commands.ConnectionRequest",
metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["M2M->VID","0#2#0010F3601410"]]}},function(c,e){c?a&&a(c):e.object&&"bsc.api.transport.result.ObjectResult"==e.classType?(c=e.object)&&"bsc.api.transport.model.Caps"==c.classType?(e={protocols:[],encryptions:[],compressions:[],apiVersions:[],apiExtension:[]},c.protocols&&c.protocols.data&&(e.protocols=c.protocols.data),c.encryptions&&c.encryptions.data&&(e.encryptions=c.encryptions.data),c.compressions&&c.compressions.data&&
(e.compressions=c.compressions.data),c.apiVersions&&c.apiVersions.data&&(e.apiVersions=c.apiVersions.data),c.apiExtensions&&c.apiExtensions.data&&(e.apiExtensions=c.apiExtensions.data),a&&a(null,e)):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse.object))):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse)))})};b.prototype._sendCaps=function(a,c,e,f,k,h){a||(a={classType:"Enum",enumType:"bsc.api.Enumerations$ProtocolType",name:"JSON"});c||(c={classType:"Enum",enumType:"bsc.api.Enumerations$EncryptionType",
name:"NONE"});e||(e={classType:"Enum",enumType:"bsc.api.Enumerations$CompressionType",name:"NONE"});f||(f={classType:"Enum",enumType:"bsc.api.Enumerations$ApiVersion",name:"Ver_2_1_0"});k||(k="CORE VOICECONTROL TEACHIN TIMER M2M CAMERA CONNECTIONS USERMANAGEMENT OBJECT_TAG MESSAGE BSC ALEXA QoS HEATER USERCONFIG PARAMETER HISTORY".split(" "));this._sendObject({classType:"bsc.api.transport.model.Caps",protocols:{classType:"List",valueType:"bsc.api.Enumerations$ProtocolType",data:[a]},encryptions:{classType:"List",
valueType:"bsc.api.Enumerations$EncryptionType",data:[c]},compressions:{classType:"List",valueType:"bsc.api.Enumerations$CompressionType",data:[e]},apiVersions:{classType:"List",valueType:"bsc.api.Enumerations$ApiVersion",data:[f]},apiExtensions:{classType:"List",valueType:"String",data:k},metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["BSC->PRODUCT","10004"]]}},function(l,m){l?h&&h(l):m.object&&"bsc.api.transport.result.ObjectResult"==m.classType?(l=m.object)&&"bsc.api.transport.model.Settings"==
l.classType?(l={protocol:l.protocol,encryption:l.encryption,compression:l.compression,apiVersion:l.apiVersion,apiExtensions:l.apiExtensions},h&&h(null,l)):h&&h(Error("send Caps failed:"+JSON.stringify(reponse.object))):h&&h(Error("send Caps failed:"+JSON.stringify(reponse)))})};b.prototype._sendAuth=function(a,c,e,f){this._sendObject({classType:"bsc.api.transport.model.Auth",key:c,signature:e,user:a},function(k,h){k?f&&f(k):h.object&&"bsc.api.transport.result.ObjectResult"==h.classType?(k=h.object)&&
"bsc.api.transport.model.Auth"==k.classType?(k={user:k.user,signature:k.signature,sessionID:k.sessionID},f&&f(null,k)):f&&f(Error("send Auth failed:"+JSON.stringify(reponse.object))):f&&f(Error("send Auth failed:"+JSON.stringify(reponse)))})};b.prototype._onTimeout=function(a){var c=this._buffer[a];c&&(delete this._buffer[a],c.timeout&&clearTimeout(c.timeout),c.callback&&c.callback(Error("response timeout")))};b.prototype._onData=function(a){a=this._parseObject(a);this._logger.log("trace","receive object:"+
JSON.stringify(a));if(a&&a.id&&a.object)if(a.sequenceID&&(this._sequenceID=a.sequenceID),a.object.resultType){var c=this._buffer[a.id];c&&a.object.resultType&&"bsc.api.transport.result.Result$ResultType"==a.object.resultType.enumType?(delete this._buffer[a.id],c.timeout&&clearTimeout(c.timeout),c.callback&&c.callback(null,a.object)):this._emitEvent("object",a.object,function(e){})}else this._emitEvent("object",a.object,function(e){})};b.prototype._onClose=function(){this._state="CLOSED";this._socket=
null;this._emitEvent("close");this._listeners={};var a=this._buffer;this._buffer={};this._sequenceID=0;this._settings=null;for(var c in a){var e=a[c];e&&(e.timeout&&clearTimeout(e.timeout),e.callback&&e.callback(Error("session closed")))}};return b}();
xnm.aio.eltako._Socket=function(){var g=function(d){if(!d)throw Error("options is null");if(!d.ip)throw Error("no ip");this._ip=d.ip;this._port=d.port;this._port||(this._port=35689);this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Socket.{"+this._ip+":"+this._port+"}");this._timeout=2E3;this._listeners={};this._state="IDLE";this._encrypt=this._compress=this._buf=this._socket=null};g.prototype.on=function(d,b){d&&b&&(this._listeners[d]||(this._listeners[d]=[]),-1==this._listeners[d].indexOf(b)&&
this._listeners[d].push(b))};g.prototype.off=function(d,b){d&&b&&this._listeners[d]&&(b=this._listeners[d].indexOf(b),-1!=b&&this._listeners[d].splice(b,1))};g.prototype.setCompress=function(d){this._compress=d};g.prototype.setEncrpty=function(d){this._encrypt=d};g.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var d=this;this._state="CONNECT";this._buf="";var b=require("net").connect({port:this._port,host:this._ip});b.setTimeout(this._timeout);this._logger.log("trace","start connect to "+
this._ip+":"+this._port);b.on("connect",function(){d._logger.log("trace","success to connect "+d._ip+":"+d._port);d._state="CONNECTED";d._emitEvent("open")});b.on("data",function(a){a.readUInt8&&(a=d._bufferToArray(a));var c=require("x.crypt.js");d._logger.log("trace","receive data: "+c.byteArrayToHex(a));d._onData(a)});b.on("error",function(a){d._logger.log("trace","socket error: "+a.message);d._emitEvent("error",a)});b.on("timeout",function(){"CONNECT"==d._state&&(d._logger.log("trace","connect timeout"),
d._emitEvent("error",Error("connect timeout")),d.close())});b.on("close",function(){d._logger.log("trace","socket closed");d._onClose()});b._doConnect&&"function"==typeof b._doConnect&&b._doConnect();this._socket=b}};g.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};g.prototype.sendData=function(d,b){var a=require("x.crypt.js");this._logger.log("trace","send data:"+a.byteArrayToHex(d));"CONNECTED"!=this._state?b&&b(Error("socket not connected")):
(d=this._buildPacket(d),this._logger.log("trace","send packet:"+a.byteArrayToHex(d)),this._socket.write(new Buffer(d),"binary",function(c){b&&b(c)}))};g.prototype._buildPacket=function(d){var b=d.length;b=this._int32ToArray(2).concat(this._int32ToArray(b));var a=require("x.crypt.js"),c=a.CRC32(b);a=a.CRC32(d);c=this._int32ToArray(c).concat(this._int32ToArray(a));return[85].concat(b).concat(c).concat(d)};g.prototype._emitEvent=function(d,b){if(d){var a=this._listeners[d];if(a&&0<a.length)for(var c=
0;c<a.length;c++){var e=a[c];try{e(b)}catch(f){this._logger.log("trace","call "+d+" listener failed, error:"+f.message)}}}};g.prototype._arrayToInt32=function(d){d=((d[0]&255)<<24)+((d[1]&255)<<16)+((d[2]&255)<<8)+(d[3]&255);return 0>d?4294967296+d:d};g.prototype._int32ToArray=function(d){return[d>>24&255,d>>16&255,d>>8&255,d&255]};g.prototype._bufferToArray=function(d){for(var b=[],a=0;a<d.length;a++)b.push(d[a]);return b};g.prototype._onData=function(d){this._buf=this._buf?this._buf.concat(d):d;
d=this._buf.length;for(var b=0;b<d;){if(85==this._buf[b]){if(d<=b+17)break;var a=this._buf.slice(b+5,b+9);a=this._arrayToInt32(a);if(d<b+17+a)break;var c=this._buf.slice(b,b+17+a);(c=this._parsePacket(c))&&this._emitEvent("data",c);b+=17+a-1}b++}this._buf=b==d?null:this._buf.slice(b)};g.prototype._parsePacket=function(d){var b=require("x.crypt.js");this._logger.log("trace","receive packet:"+b.byteArrayToHex(d));var a=d.slice(1,9),c=d.slice(9,17);d=d.slice(17);var e=this._arrayToInt32(a.slice(0,4)),
f=this._arrayToInt32(a.slice(4)),k=this._arrayToInt32(c.slice(0,4));c=this._arrayToInt32(c.slice(4));a=b.CRC32(a);b=b.CRC32(d);this._logger.log("trace","parse packet t:"+e+" l:"+f+" crc_h:<"+k+","+a+"> crc_d:<"+c+","+b+">");return d};g.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};this._buf=null};return g}();
xnm.aio.eltako.BR64=function(){var g=function(b,a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.BR64");this._ip=b;this._port=a;this._port||(this._port=4443);this._mac=c;this._timeout=1E4;this._httpReqBuffer=[];"undefined"!=typeof process&&null!=process&&process.env&&(this._keepAliveAgent=new (require("https").Agent)({keepAlive:!0,maxSockets:1}))};g.prototype._getSystem=function(b){this._doRequest("GET","/system",null,function(a,c){if(a)b&&b(a);else if(c)try{var e=JSON.parse(c);
b&&b(null,e)}catch(f){b&&b(Error("invalid response"))}else b&&b(Error("invalid response"))})};g.prototype._getDevices=function(b){this._doRequest("GET","/devices",null,function(a,c){if(a)b&&b(a);else if(c)try{var e=JSON.parse(c);b&&b(null,e)}catch(f){b&&b(Error("invalid response"))}else b&&b(Error("invalid response"))})};g.prototype._getDevice=function(b,a){this._doRequest("GET","/device("+b+")",null,function(c,e){if(c)a&&a(c);else if(e)try{var f=JSON.parse(e);a&&a(null,f)}catch(k){a&&a(Error("invalid response"))}else a&&
a(Error("invalid response"))})};g.prototype._setDeviceState=function(b,a,c){this._doRequest("PATCH","/devices("+b+")",JSON.stringify(a),function(e,f){if(e)c&&c(e);else if(f)try{var k=JSON.parse(f);c&&c(null,k)}catch(h){c&&c(Error("invalid response"))}else c&&c(Error("invalid response"))})};g.prototype._doRequest=function(b,a,c,e){var f=this._httpReqBuffer.length;this._httpReqBuffer.push({method:b,path:a,data:c,callback:e});0==f&&this._doNextHttpReq()};g.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var b=
this._httpReqBuffer[0],a=this;this._doRequestHttp(b.method,b.path,b.data,function(c,e){b.callback&&b.callback(c,e);a._httpReqBuffer.splice(0,1);a._doNextHttpReq()})}};g.prototype._doRequestHttp=function(b,a,c,e){var f="https://"+this._ip+":"+this._port+a;this._logger.log("trace","send "+b+" to url: "+f+" data:"+c);b={host:this._ip,port:this._port,path:a,method:b,headers:{}};c&&(b.headers["Content-Length"]=c.length);var k=this,h=e;e=require("https");"undefined"!=typeof process&&null!=process&&process.env&&
(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",b.agent=this._keepAliveAgent);var l=e.request(b,function(m){m.setEncoding("utf-8");var n="";m.on("data",function(t){n+=t});m.on("end",function(){k._logger.log("trace",f+" response "+m.statusCode+": "+n);if(200==m.statusCode)h&&h(null,n);else{var t=Error("http response "+m.statusCode);h&&h(t)}h=null})});l.setTimeout(this._timeout,function(){k._logger.log("trace","http request "+f+" timeout");h&&(h(Error("http request timeout")),h=null);l.abort()});l.on("error",
function(m){k._logger.log("trace","http request "+f+" error:"+m.message);h&&(h(m),h=null)});c&&l.write(c);l.end()};g.prototype.toJSON=function(){return{sys:"eltako_br64",ip:this._ip,port:this._port,mac:this._mac}};g.parseJSON=function(b){if(!b||!b.ip||!b.type)return null;switch(b.type){case "fsr64":return new d(b.ip,b.port,b.mac);default:return null}};var d=function(b,a,c){g.call(this,b,a,c);this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.FSR")};d.prototype=new g;d.prototype.constructor=
d;d.prototype.executeCommandCreator=function(b,a,c){if(a&&a.value)switch(a.value){case "on":this.on(c);break;case "off":this.off(c);break;case "toggle":this.toggle(c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command value is empty"))};d.prototype.getStatesCreator=function(b,a,c){this.getStates(function(e,f){if(e)c&&c(e);else{e=[];for(var k=0;k<a.length;k++){var h=a[k];if(h&&h.id&&h.status&&h.status.value)switch(h.status.value){case "state":e.push({id:h.id,status:f?f[h.status.value]:
"?"})}}c&&c(null,e)}})};d.prototype.on=function(b){this._setDeviceState(0,{State:{relay_state:[!0]}},function(a){b&&b(a)})};d.prototype.off=function(b){this._setDeviceState(0,{State:{relay_state:[!1]}},function(a){b&&b(a)})};d.prototype.toggle=function(b){var a=this;this.getStates(function(c,e){if(c)b&&b(c);else if("on"==e.state)a.off(b);else a.on(b)})};d.prototype.getStates=function(b){this._getDevices(function(a,c){a?b&&b(a):c&&c.devices&&c.devices[0]?(a=c.devices[0],a.State&&a.State.relay_state&&
a.State.relay_state.length?(a=a.State.relay_state[0],b&&b(null,{state:1==a?"on":"off"})):b&&b(Error("invalid response"))):b&&b(Error("invalid response"))})};d.prototype.equalsTo=function(b){return b&&b instanceof d?this._ip==b._ip&&this._port==b._port:!1};d.prototype.toJSON=function(){var b=g.prototype.toJSON.call(this);b.type="fsr64";return b};g.FSR=d;return g}();
xnm.aio.eltako.DM=function(){var g=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="EltakoDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var d={fsr64:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]}};
return{SYS:"eltako_br64",getIPDeviceType:function(){return[{sys:this.SYS,name:"eltako BR64"}]},createDevice:function(b,a,c){a=g.ERROR_CODE;b?b.type?b.ip?c(null,b):c(new g(a.INVALID,"ip is invalid")):c(new g(a.INVALID,"type is invalid")):c(new g(a.INVALID,"info is invalid"))},updateDevice:function(b,a,c){a=g.ERROR_CODE;b?b.type?b.ip?c(null,b):c(new g(a.INVALID,"ip is invalid")):c(new g(a.INVALID,"type is invalid")):c(new g(a.INVALID,"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,
a,c){var e=this,f=function(n,t){if("*"==n)return!0;for(var p=!1,q=0;q<n.length;q++)if(n[q]==t){p=!0;break}return p},k=function(n,t,p){var q=[];switch(p.catagory){case "command":n.command&&n.command.forEach(function(r){f(p.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),q.push(r))});break;case "status":n.status&&n.status.forEach(function(r){f(p.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),q.push(r))})}return q},h=function(n,t){var p=[],q=e.getCommandStatusMap(n,c);q&&(n=k(q,n,t),p=p.concat(n));
return p};if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),m=null;switch(a.catagory){case "command":m=h(b,a);l.command=m;break;case "status":m=h(b,a);l.status=m;break;default:return null}return m&&0!=m.length?l:null},getCommandStatusMap:function(b){return b&&b.type?d[b.type]:null}}}();
xnm.aio.eltako.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.Handler ");this._getDeviceListTo=this._controller=null};g.prototype.Socket=xnm.aio.eltako._Socket;g.prototype.Session=xnm.aio.eltako._Session;g.prototype.Gateway=xnm.aio.eltako.Gateway;g.prototype.BR64=xnm.aio.eltako.BR64;g.prototype.devicemanager=xnm.aio.eltako.DM;g.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"eltako")};g.prototype.resolveDevice=function(d){return this.BR64.parseJSON(d)};
g.prototype.getDeviceCommands=function(d,b){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];b&&b(null,d)};g.prototype.getDeviceStatus=function(d,b){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];b&&b(null,d)};g.prototype.doCommand=function(d,b,a){var c=this.resolveDevice(d);c?c.executeCommandCreator(d,b,function(e){a&&a(e)}):a&&a(Error("device json format invalid"))};g.prototype.doStatus=function(d,b,a,c){var e=this.resolveDevice(b);
e?e.getStatesCreator(null,[{id:d,device:b,status:a}],function(f,k){f?c&&c(f):c&&c(null,k[0])}):c&&c(Error("device json format invalid"))};g.prototype.discoverDevices=function(d,b){var a=require("x.mdns.js"),c=this;a.clearRecordBuffer();a.discoverServiceWithTimeout("_hap._tcp.local",d,function(e,f){if(e)b&&b(e);else{c._logger.log("trace","find _hap._tcp.local: "+JSON.stringify(f));e=[];for(var k=0;k<f.length;k++){var h=f[k];h&&h.info&&h.info.md&&"FSR64"==h.info.md&&(h={sys:"eltako_br64",ip:h.ip[0],
port:4443,mac:h.info.id,type:h.info.md.toLowerCase(),name:h.domain.substr(0,h.domain.indexOf("."))},e.push(h))}b&&b(null,e)}})};return g}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.eltako.Handler);
