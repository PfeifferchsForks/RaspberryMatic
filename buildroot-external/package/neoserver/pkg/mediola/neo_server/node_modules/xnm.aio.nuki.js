var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.nuki=xnm.aio.nuki||{};
xnm.aio.nuki.SmartLockBridge=function(){var g={0:"uncalibrated",1:"locked",2:"unlocking",3:"unlocked",4:"locking",5:"unlatched",6:"unlocked_lock_n_go",7:"unlatching",254:"motor_blocked",255:"undefined"},c=function(a,b,d){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.nuki.SmartLock");this.ip=a;this.port=b;this.port||(this.port=8080);this.token=d;this.timeout=5E4};c.prototype.executeCommandCreator=function(a,b,d){if(a&&a.address)if(b&&
b.value){switch(b.value){case "unlock":b=1;break;case "lock":b=2;break;case "unlatch":b=3;break;case "lockGo":b=4;break;case "lockGoUnlatch":b=5;break;default:d&&d(Error("no such command"));return}this._lockAction(a.address,b,0,d)}else d&&d(Error("command json format invalid"));else d&&d(Error("device json format invalid"))};c.prototype.getStatesCreator=function(a,b,d){this.getLocalStates(function(e,f){e=[];for(var h=0;h<b.length;h++)if(b[h]&&b[h].id){var k="?";if(f&&b[h].status&&b[h].status.value&&
b[h].device&&b[h].device.address){var l=b[h].status.value,q=b[h].device.address;f[q]&&(k=f[q][l],"undefined"==typeof k||null==k)&&(k="?")}e.push({id:b[h].id,status:k})}d&&d(null,e)})};c.prototype.getLocalStates=function(a){var b=this;this._list(function(d,e){if(d)a&&a(d);else{d={};for(var f=0;f<e.length;f++){var h=e[f];if(h.nukiId&&h.lastKnownState){var k=b._toState(h.lastKnownState);k&&(d[h.nukiId]=k)}}a&&a(null,d)}})};c.prototype.getDevices=function(a){this._list(function(b,d){if(b)a&&a(b);else{b=
[];for(var e=0;e<d.length;e++){var f=d[e];f.nukiId&&f.name&&b.push({sys:"nuki",type:"smartlock",address:f.nukiId,name:f.name})}a&&a(null,b)}})};c.prototype._toState=function(a){var b={};b.state=g[a.state];b.lowbat=a.batteryCritical;b.stateCode=a.state;b.stateName=a.stateName;return b};c.prototype._lockAction=function(a,b,d,e){this._doLocalRequest("/lockAction",{token:this.token,nukiId:a,action:b,noWait:d},function(f,h,k){f?(401==parseInt(h)?(f=Error("invalid token"),f.code=1E3):400==parseInt(h)?(f=
Error("invalid action"),f.code=1003):404==parseInt(h)?(f=Error("unknown smart lock"),f.code=1001):503==parseInt(h)&&(f=Error("smart lock offline"),f.code=1002),e&&e(f)):e&&e(null,k)})};c.prototype._lockState=function(a,b){this._doLocalRequest("/lockState",{token:this.token,nukiId:a},function(d,e,f){d?(401==parseInt(e)?(d=Error("invalid token"),d.code=1E3):404==parseInt(e)?(d=Error("unknown smart lock"),d.code=1001):503==parseInt(e)&&(d=Error("smart lock offline"),d.code=1002),b&&b(d)):b&&b(null,f)})};
c.prototype._list=function(a){this._doLocalRequest("/list",{token:this.token},function(b,d,e){b?(401==parseInt(d)&&(b=Error("invalid token"),b.code=1E3),a&&a(b)):a&&a(null,e)})};c.prototype._doLocalRequest=function(a,b,d){var e=this,f=a="http://"+this.ip+":"+this.port+a;if(b){var h=[],k=[],l;for(l in b)if(b.hasOwnProperty(l)){var q=l+"=",p=b[l];"undefined"!=typeof p&&null!=p&&(q+=encodeURIComponent(p));h.push(q);"token"!=l?k.push(q):k.push("token=xxxxxx")}a+="?"+h.join("&");f+="?"+k.join("&")}this._logger.log("trace",
"send get to url:"+f);var m=d;$.ajax({url:a,type:"GET",timeout:this.timeout,dataType:"text",cache:!0,success:function(n){e._logger.log("trace","http request success:"+n);try{var r=JSON.parse(n);m&&(m(null,200,r),m=null)}catch(t){m&&(m(t,200),m=null)}},error:function(n,r){r="http request error:"+(n?n.status:"0")+"-"+r;e._logger.log("trace",r);m&&(m(Error(r),n?n.status:"0"),m=null)}})};c.prototype.equalsTo=function(a){return a&&a instanceof c?this.ip===a.ip&&this.port===a.port&&this.token===a.token:
!1};return c}();
xnm.aio.nuki.DM=function(){var g=function(c,a){this.code=c;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="NukiDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"nuki",MAP:{command:[{type:"enum",name:"unlock",ref:{value:"unlock"}},{type:"enum",name:"lock",ref:{value:"lock"}},{type:"enum",name:"unlatch",ref:{value:"unlatch"}},{type:"enum",name:"lock 'n' go",ref:{value:"lockGo"}},{type:"enum",
name:"lock 'n' go with unlatch",ref:{value:"lockGoUnlatch"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:"uncalibrated locked unlocking unlocked locking unlatched unlocked_lock_n_go unlatching motor_blocked undefined".split(" ")}},{type:"enum",name:"low battery",ref:{value:"lowbat",options:["true","false"]}}]},getGatewayType:function(){return[{sys:this.SYS,name:"NUKI Bridge",port:8080}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}]},createGateway:function(c,
a,b){a=g.ERROR_CODE;c?c.ip?c.token?b(null,c):b(new g(a.INVALID,"token is invalid")):b(new g(a.INVALID,"ip is invalid")):b(new g(a.INVALID,"info is invalid"))},updateGateway:function(c,a,b,d){c=g.ERROR_CODE;a?a.ip?a.token?d(null,a):d(new g(c.INVALID,"token is invalid")):d(new g(c.INVALID,"ip is invalid")):d(new g(c.INVALID,"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,b){var d=g.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===c.gateway){var f=a[e];break}f?b(null,c):b(new g(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new g(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new g(d.INVALID,"address is invalid"));else b(new g(d.INVALID,"gateway is invalid"));else b(new g(d.INVALID,"info is invalid"))},updateDevice:function(c,a,b){var d=g.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===c.gateway){var f=a[e];break}f?b(null,c):b(new g(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new g(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new g(d.INVALID,"address is invalid"));else b(new g(d.INVALID,"gateway is invalid"));else b(new g(d.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){b()},applyUIFilter:function(c,a){var b=this,d=function(l,q){if("*"==l)return!0;for(var p=!1,m=
0;m<l.length;m++)if(l[m]==q){p=!0;break}return p},e=function(l,q,p){var m=[];switch(p.catagory){case "command":l.command&&l.command.forEach(function(n){d(p.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),m.push(n))});break;case "status":l.status&&l.status.forEach(function(n){d(p.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),m.push(n))})}return m},f=function(l,q){var p=[],m=b.getCommandStatusMap(l);m&&(l=e(m,l,q),p=p.concat(l));return p};if(!c||null==c.type||"undefined"==typeof c.type)return null;
var h=JSON.parse(JSON.stringify(c)),k=null;switch(a.catagory){case "command":k=f(c,a);h.command=k;break;case "status":k=f(c,a);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(c){return this.MAP}}}();
xnm.aio.nuki.Handler=function(){var g=function(){};g.prototype.devicemanager=xnm.aio.nuki.DM;g.prototype.SmartLockBridge=xnm.aio.nuki.SmartLockBridge;g.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"nuki")};g.prototype.resolveGateway=function(c){return c&&c.ip?new this.SmartLockBridge(c.ip,c.port,c.token):null};g.prototype.getDeviceCommands=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];a&&a(null,c)};g.prototype.getDeviceStatus=
function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];a&&a(null,c)};g.prototype.doCommand=function(c,a,b,d){(c=this.resolveGateway(c))?c.executeCommandCreator(a,b,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};g.prototype.doStatus=function(c,a,b,d,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:c,device:b,status:d}],function(f,h){f?e&&e(f):e&&e(null,h[0])}):e&&e(Error("gateway json format invalid"))};g.prototype.getDeviceList=
function(c,a){(c=this.resolveGateway(c))?c.getDevices(function(b,d){a&&a(b,d)}):a&&a(Error("gateway json format invalid"))};return g}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.nuki.Handler);
