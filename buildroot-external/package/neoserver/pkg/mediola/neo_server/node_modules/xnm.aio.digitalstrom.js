var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(f){var d=0;return function(){return d<f.length?{done:!1,value:f[d++]}:{done:!0}}};$jscomp.arrayIterator=function(f){return{next:$jscomp.arrayIteratorImpl(f)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,d,e){if(f==Array.prototype||f==Object.prototype)return f;f[d]=e.value;return f};$jscomp.getGlobal=function(f){f=["object"==typeof globalThis&&globalThis,f,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var d=0;d<f.length;++d){var e=f[d];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(f,d){var e=$jscomp.propertyToPolyfillSymbol[d];if(null==e)return f[d];e=f[e];return void 0!==e?e:f[d]};
$jscomp.polyfill=function(f,d,e,k){d&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(f,d,e,k):$jscomp.polyfillUnisolated(f,d,e,k))};$jscomp.polyfillUnisolated=function(f,d,e,k){e=$jscomp.global;f=f.split(".");for(k=0;k<f.length-1;k++){var g=f[k];if(!(g in e))return;e=e[g]}f=f[f.length-1];k=e[f];d=d(k);d!=k&&null!=d&&$jscomp.defineProperty(e,f,{configurable:!0,writable:!0,value:d})};
$jscomp.polyfillIsolated=function(f,d,e,k){var g=f.split(".");f=1===g.length;k=g[0];k=!f&&k in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var m=0;m<g.length-1;m++){var n=g[m];if(!(n in k))return;k=k[n]}g=g[g.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?k[g]:null;d=d(e);null!=d&&(f?$jscomp.defineProperty($jscomp.polyfills,g,{configurable:!0,writable:!0,value:d}):d!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[g]&&(e=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[g]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(g):$jscomp.POLYFILL_PREFIX+e+"$"+g),$jscomp.defineProperty(k,$jscomp.propertyToPolyfillSymbol[g],{configurable:!0,writable:!0,value:d})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(f){if(f)return f;var d=function(m,n){this.$jscomp$symbol$id_=m;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:n})};d.prototype.toString=function(){return this.$jscomp$symbol$id_};var e="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",k=0,g=function(m){if(this instanceof g)throw new TypeError("Symbol is not a constructor");return new d(e+(m||"")+"_"+k++,m)};return g},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(f){if(f)return f;f=Symbol("Symbol.iterator");for(var d="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<d.length;e++){var k=$jscomp.global[d[e]];"function"===typeof k&&"function"!=typeof k.prototype[f]&&$jscomp.defineProperty(k.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return f},"es6",
"es3");$jscomp.iteratorPrototype=function(f){f={next:f};f[Symbol.iterator]=function(){return this};return f};$jscomp.iteratorFromArray=function(f,d){f instanceof String&&(f+="");var e=0,k=!1,g={next:function(){if(!k&&e<f.length){var m=e++;return{value:d(m,f[m]),done:!1}}k=!0;return{done:!0,value:void 0}}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill("Array.prototype.values",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(d,e){return e})}},"es8","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.digitalstrom=xnm.aio.digitalstrom||{};
xnm.aio.digitalstrom.Server=function(){var f={0:"Broadcast",1:"Light",2:"Shading",3:"Heating",4:"Audio",5:"Video",6:"Security",7:"Access",8:"Joker",9:"Cooling",10:"Room ventilation",11:"Window",12:"Recirculation",48:"Temperature control",64:"Apartment ventilation"},d={0:"Preset 0",1:"Area 1 Off",2:"Area 2 Off",3:"Area 3 Off",4:"Area 4 Off",5:"Preset 1",6:"Area 1 On",7:"Area 2 On",8:"Area 3 On",9:"Area 4 On",10:"Area Stepping Continue",11:"Decrement",12:"Increment",13:"Minimum",14:"Maximum",15:"Stop",
17:"Preset 2",18:"Preset 3",19:"Preset 4",20:"Preset 12",21:"Preset 13",22:"Preset 14",23:"Preset 22",24:"Preset 23",25:"Preset 24",26:"Preset 32",27:"Preset 33",28:"Preset 34",29:"Preset 42",30:"Preset 43",31:"Preset 44",32:"Preset 10",33:"Preset 11",34:"Preset 20",35:"Preset 21",36:"Preset 30",37:"Preset 31",38:"Preset 40",39:"Preset 41",40:"Auto Off",41:"Impulse",42:"Area 1 Decrement",43:"Area 1 Increment",44:"Area 2 Decrement",45:"Area 2 Increment",46:"Area 3 Decrement",47:"Area 3 Increment",
48:"Area 4 Decrement",49:"Area 4 Increment",50:"Device Off",51:"Device On",52:"Area 1 Stop",53:"Area 2 Stop",54:"Area 3 Stop",55:"Area 4 Stop",56:"Sun protection"},e={64:"Auto Standby",65:"Panic",67:"Standby",68:"Deep Off",69:"Sleeping",70:"Wakeup",71:"Present",72:"Absent",73:"Door Bell",74:"Alarm",75:"Zone Active",76:"Fire",77:"Smoke",78:"Water",79:"Gas",80:"Bell 2",81:"Bell 3",82:"Bell 4",83:"Alarm 2",84:"Alarm 3",85:"Alarm 4",86:"Wind",87:"No Wind",88:"Rain",89:"No Rain",90:"Hail",91:"No Hail"},
k=function(c){this._server=c};k.prototype._requestApplicationToken=function(c,a){this._doSystemRequest("requestApplicationToken",{applicationName:c},function(b,h){b?a&&a(b):a&&a(null,h.applicationToken)})};k.prototype._login=function(c,a,b){this._doSystemRequest("login",{user:c,password:a},function(h,q){h?b&&b(h):b&&b(null,q.token)})};k.prototype._enableToken=function(c,a,b){this._doSystemRequest("enableToken",{applicationToken:c,token:a},function(h){b&&b(h)})};k.prototype._loginApplication=function(c,
a){c?this._doSystemRequest("loginApplication",{loginToken:c},function(b,h){b?a&&a(b):a&&a(null,h.token)}):a&&a(Error("loginToken is empty"))};k.prototype._doSystemRequest=function(c,a,b){this._server._doJsonRequest("/system/"+c,a,function(h,q){h?b&&b(h):b&&b(null,q)})};var g=function(c){this._server=c};g.prototype._getName=function(c){this._doApartmentRequest("getName",null,function(a,b){a?c&&c(a):b?c&&c(null,b.name):c&&c(Error("apartment getName result invalid"))})};g.prototype._getSensorValues=
function(c){this._doApartmentRequest("getSensorValues",null,function(a,b){a?c&&c(a):b?c&&c(null,b):c&&c(Error("apartment getSensorValues result invalid"))})};g.prototype._getTemperatureControlStatus=function(c){this._doApartmentRequest("getTemperatureControlStatus",null,function(a,b){a?c&&c(a):b?c&&c(null,b):c&&c(Error("apartment getTemperatureControlStatus result invalid"))})};g.prototype._getStructure=function(c){this._doApartmentRequest("getStructure",null,function(a,b){a?c&&c(a):c&&c(null,b)})};
g.prototype._callScene=function(c,a){c?"undefined"==typeof c.sceneNumber||null==c.sceneNumber?a&&a(Error("sceneNumber invalid")):this._doApartmentRequest("callScene",c,function(b,h){b?a&&a(b):a&&a(null,h)}):a&&a(Error("params invalid"))};g.prototype._doApartmentRequest=function(c,a,b){this._server._doJsonRequest("/apartment/"+c,a,function(h,q){h?b&&b(h):b&&b(null,q)})};var m=function(c){this._server=c};m.prototype._getReachableScenes=function(c,a,b){"undefined"==typeof c||null==c?b&&b(Error("id invalid")):
"undefined"==typeof a||null==a?b&&b(Error("groupID invalid")):this._doZoneRequest("getReachableScenes",{id:c,groupID:a},b)};m.prototype._callScene=function(c,a,b){a?"undefined"==typeof a.sceneNumber||null==a.sceneNumber?b&&b(Error("sceneNumber invalid")):"undefined"==typeof c||null==c?b&&b(Error("id invalid")):(a.id=c,this._doZoneRequest("callScene",a,b)):b&&b(Error("params invalid"))};m.prototype._doZoneRequest=function(c,a,b){this._server._doJsonRequest("/zone/"+c,a,function(h,q){h?b&&b(h):b&&b(null,
q)})};var n=function(c){this._server=c};n.prototype._turnOn=function(c,a){this._doDeviceRequest("turnOn",c,a)};n.prototype._turnOff=function(c,a){this._doDeviceRequest("turnOff",c,a)};n.prototype._increaseValue=function(c,a){this._doDeviceRequest("increaseValue",c,a)};n.prototype._decreaseValue=function(c,a){this._doDeviceRequest("decreaseValue",c,a)};n.prototype._callScene=function(c,a){c?"undefined"==typeof c.sceneNumber||null==c.sceneNumber?a&&a(Error("sceneNumber invalid")):this._doDeviceRequest("callScene",
c,a):a&&a(Error("params invalid"))};n.prototype._doDeviceRequest=function(c,a,b){a?"undefined"!=typeof a.dsid&&null!=a.dsid||a.name?this._server._doJsonRequest("/device/"+c,a,function(h,q){h?b&&b(h):b&&b(null,q)}):b&&b(Error("no dsid or name")):b&&b(Error("params invalid"))};var x=function(c){this._server=c};x.prototype._getMeters=function(c){this._query("/apartment/dSMeters/*(*)",function(a,b){a?c&&c(a):(a=[],b&&b.dSMeters&&(a=b.dSMeters),c&&c(null,a))})};x.prototype._getUsrEvent=function(c){this._query("/usr/events/*(*)",
function(a,b){a?c&&c(a):(a=[],b&&b.events&&(a=b.events),c&&c(null,a))})};x.prototype._getUsrDefinedStates=function(c){this._query("/usr/addon-states/system-addon-user-defined-states/*(*)",function(a,b){a?c&&c(a):(a=[],b&&b["system-addon-user-defined-states"]&&(a=b["system-addon-user-defined-states"]),c&&c(null,a))})};x.prototype._query=function(c,a){this._doPropertyRequest("query",{query:c},function(b,h){b?a&&a(b):a&&a(null,h)})};x.prototype._query2=function(c,a){this._doPropertyRequest("query2",
{query:c},function(b,h){b?a&&a(b):a&&a(null,h)})};x.prototype._doPropertyRequest=function(c,a,b){this._server._doJsonRequest("/property/"+c,a,function(h,q){h?b&&b(h):b&&b(null,q)})};var v=function(c){this._server=c};v.prototype._raise=function(c,a){c?c.name?this._doEventRequest("raise",c,a):a&&a(Error("name invalid")):a&&a(Error("params invalid"))};v.prototype._doEventRequest=function(c,a,b){a?"undefined"!=typeof a.dsid&&null!=a.dsid||a.name?this._server._doJsonRequest("/event/"+c,a,function(h,q){h?
b&&b(h):b&&b(null,q)}):b&&b(Error("no dsid or name")):b&&b(Error("params invalid"))};var p=function(c,a,b){var h=require("x.logger.js");this._logger=h?h.getLogger("xnm.aio.digitalstrom.Server"):{log:function(){}};this.ip=c;this.port=a;a||(this.port=8080);this.applicationToken=b;this.sessionToken=null;this._getSessionTokenCBs=[];this._system=new k(this);this._apartment=new g(this);this._zone=new m(this);this._device=new n(this);this._property=new x(this);this._event=new v(this)};p.HEAT_CONTROL_MODE=
["off","pid_control","zone_follower","fixed_value","manual"];p.HEAT_OP_MODE="off comfort economy not_used night holiday cooling cooling_off".split(" ");p.prototype._doRequest=function(c,a,b){c||(c="/");a||(a={});this.sessionToken&&(a.token=this.sessionToken);if(a){c+="?";for(var h in a)c+=h+"="+encodeURI(a[h])+"&"}"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");c={host:this.ip,port:this.port,path:c,method:"GET",headers:{"Content-Type":'text/html; charset="UTF-8"',
"Content-Length":0,Connection:"close",rejectUnauthorized:!1,requestCert:!0}};var q=this;this._logger.log("trace","do https request:"+JSON.stringify(c));c=require("https").request(c,function(u){u.setEncoding("utf-8");var t="";u.on("data",function(r){t+=r});u.on("end",function(){q._logger.log("trace","receive https response:"+t+" with code:"+u.statusCode);b&&b(null,t,u.statusCode);b=null})});c.on("error",function(u){q._logger.log("warn","do https request error:"+u.message);b&&b(u);b=null});c.setTimeout(1E4,
function(){q._logger.log("warn","do https request timeout");var u=Error("timeout");u.reason="timeout";b&&b(u);b=null});c.end()};p.prototype._doJsonRequest=function(c,a,b){var h=this,q=c;q||(q="/");this._doRequest("/json"+q,a,function(u,t,r){if(u)b&&b(u);else if(403==r)h.getSessionToken(function(I){I?b&&b(I):h._doJsonRequest(c,a,b)});else try{var w=JSON.parse(t);w.ok?b&&b(null,w.result):b&&b(Error("json response error:"+w.message))}catch(I){b&&b(I)}})};p.prototype._getReachableScenes=function(c,a){var b=
null,h=0,q=this,u=function(t,r){!t&&r&&(b||(b={}),b[c[h].zoneID+"."+c[h].groupID]=r);h++;h>=c.length?a&&a(null,b):q._zone._getReachableScenes(c[h].zoneID,c[h].groupID,u)};this._zone._getReachableScenes(c[h].zoneID,c[h].groupID,u)};p.prototype.getSessionToken=function(c){if(this.applicationToken){var a=this._getSessionTokenCBs.length;c&&-1==this._getSessionTokenCBs.indexOf(c)&&this._getSessionTokenCBs.push(c);if(0==a){var b=this;this._system._loginApplication(this.applicationToken,function(h,q){if(h)c&&
c(h);else{b.sessionToken=q;h=b._getSessionTokenCBs;b._getSessionTokenCBs=[];for(var u=0;u<h.length;u++)h[u](null,q)}})}}else c&&c(Error("applicationToken is empty"))};p.prototype.getDevices=function(c){var a=this,b={apartment:null};this._apartment._getName(function(h,q){if(h)c&&c(h);else{q||(q="Apartment");b.apartment={type:"apartment",name:q,meters:[],devices:[],zones:[],events:[],uds:[]};var u=0,t=function(r){u++;r?(c&&c(r),c=null):4==u&&(c&&c(null,b),c=null)};a._apartment._getTemperatureControlStatus(function(r,
w){a._apartment._getSensorValues(function(I,E){!I&&E&&E.outdoor&&(b.apartment.outdoor=E.outdoor);a._apartment._getStructure(function(J,B){if(J)t(J);else{J=[];if(B&&B.apartment&&B.apartment.zones)for(var O=0;O<B.apartment.zones.length;O++)for(var M=B.apartment.zones[O],y=0;y<M.groups.length;y++){var K=M.groups[y];0!=K.id&&0<K.devices.length&&J.push({zoneID:M.id,groupID:K.id})}a._getReachableScenes(J,function(C,G){if(C)t(C);else{if(B&&B.apartment&&B.apartment.zones)for(C=0;C<B.apartment.zones.length;C++){var A=
B.apartment.zones[C],L={type:"zone",zoneID:A.id,name:A.name,groups:[]},l;a:{if(E&&E.zones)for(l=0;l<E.zones.length;l++){var z=E.zones[l];if(z&&z.id==A.id){l=z.values;break a}}l=null}l&&(L.sensorValues=l);a:{z=A.id;var F=w;if(F&&F.zones)for(var H=0;H<F.zones.length;H++)if((l=F.zones[H])&&l.id==z&&0!=l.IsConfigured){z=[];for(var N in l)"ControlMode"!=N&&"OperationMode"!=N&&"TemperatureValue"!=N&&"NominalValue"!=N&&"ControlValue"!=N||z.push(N);l=z;break a}l=null}l&&(L.heating=l);if(0==A.id)for(A.name||
(L.name="All Devices"),l=0;l<A.devices.length;l++)z=A.devices[l],b.apartment.devices.push({type:"device",name:z.name,dsid:z.id,zoneID:z.zoneID,groups:z.groups});for(l=0;l<A.groups.length;l++){var D=A.groups[l];if(0!=D.id&&D.applicationType&&0<D.devices.length){z=f[D.id];F=A.id;H=D.id;var T=D.applicationType;var Q=G?(Q=G[A.id+"."+D.id])?Q.reachableScenes:null:null;if(G)if((D=G[A.id+"."+D.id])&&D.userSceneNames){for(var R=null,S=0;S<D.userSceneNames.length;S++){var P=D.userSceneNames[S];P&&P.sceneNr&&
P.sceneName&&(R||(R={}),R[P.sceneNr]=P.sceneName)}D=R}else D=null;else D=null;L.groups.push({type:"group",name:z,zoneID:F,groupID:H,applicationType:T,reachableScenes:Q,sceneNames:D})}}b.apartment.zones.push(L)}t()}})}})})});a._property._getMeters(function(r,w){if(r)t(r);else{if(w)for(r=0;r<w.length;r++)w[r].dSID&&b.apartment.meters.push({type:"meter",name:w[r].name,dsid:w[r].dSID});t()}});a._property._getUsrEvent(function(r,w){if(r)t(r);else{if(w)for(r=0;r<w.length;r++)w[r].id&&b.apartment.events.push({type:"event",
name:w[r].name,id:w[r].id});t()}});a._property._getUsrDefinedStates(function(r,w){if(r)t(r);else{if(w)for(r=0;r<w.length;r++)w[r].name&&b.apartment.uds.push({type:"uds",name:w[r].displayName,id:w[r].name,setName:w[r].setName,resetName:w[r].resetName});t()}})}})};p.prototype.registApplication=function(c,a,b){var h=this;this._system._requestApplicationToken("mediola",function(q,u){q?b&&b(q):h._system._login(c,a,function(t,r){t?b&&b(t):h._system._enableToken(u,r,function(w){b&&b(w,u)})})})};p.prototype.executeCommand=
function(c,a,b){if(c&&c.type)if(a&&a.value)switch(c.type){case "apartment":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){b&&b(Error("scene number invalid"));return}this._apartment._callScene({sceneNumber:a},b);break;default:b&&b(Error("unknown command:"+a.value))}break;case "zone":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){b&&b(Error("scene number invalid"));return}this._zone._callScene(c.zoneID,{sceneNumber:a},b);break;default:b&&b(Error("unknown command:"+
a.value))}break;case "group":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){b&&b(Error("scene number invalid"));return}this._zone._callScene(c.zoneID,{groupID:c.groupID,sceneNumber:a},b);break;default:b&&b(Error("unknown command:"+a.value))}break;case "device":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){b&&b(Error("scene number invalid"));return}this._device._callScene({dsid:c.dsid,sceneNumber:a},b);break;case "turnOn":this._device._turnOn({dsid:c.dsid},
b);break;case "turnOff":this._device._turnOff({dsid:c.dsid},b);break;case "decreaseValue":this._device._decreaseValue({dsid:c.dsid},b);break;case "increaseValue":this._device._increaseValue({dsid:c.dsid},b);break;default:b&&b(Error("unknown command:"+a.value))}break;case "event":switch(a.value){case "run":if(!c.id){b&&b(Error("device id invalid"));return}this._event._raise({name:"highlevelevent",parameter:"id="+c.id},b);break;default:b&&b(Error("unknown command:"+a.value))}break;default:b&&b(Error("unknown device type:"+
c.type))}else b&&b(Error("command format invalid"));else b&&b(Error("device format invalid"))};p.prototype.executeCommandCreator=function(c,a,b){if(a&&a.value)if(c&&c.type){var h={value:"callScene",ext:0},q=null;if("turnOn"==a.value||"turnOff"==a.value||"increaseValue"==a.value||"decreaseValue"==a.value||"run"==a.value)h.value=a.value;else if("callScene"==a.value){q=parseInt(a.ext);if(isNaN(q)){b&&b(Error("callScene value invalid"));return}h.ext=q}else if("doActivity"==a.value){if(!a.ext){b&&b(Error("doActivity value invalid"));
return}var u=!1,t;for(t in d)if(a.ext==d[t]){q=parseInt(t);u=!0;break}if(!u)for(t in e)if(a.ext==e[t]){q=parseInt(t);u=!0;break}if(!u){b&&b(Error("unknown doActivity:"+a.ext));return}h.ext=q}else if("doScene"==a.value.substr(0,7)){q=parseInt(a.value.substr(7));if(isNaN(q)){b&&b(Error("doScene value invalid"));return}h.ext=q}else{b&&b(Error("unknown command:"+a.value));return}a=null;switch(c.type){case "apartment":case "zone":case "group":case "device":case "event":a=c;break;default:b&&b(Error("unknown device type:"+
c.type))}this.executeCommand(a,h,function(r){b&&b(r)})}else b&&b(Error("device json invalid"));else b&&b(Error("command json invalid"))};p.prototype.getStatesCreator=function(c,a,b){var h=function(E){return E.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")};if(a)if(0==a.length)b&&b(null,[]);else if(a){var q=[],u={},t={},r={},w={},I=this;this._property._getUsrDefinedStates(function(E,J){if(!E&&J)for(E=0;E<J.length;E++){var B=J[E];B.name&&
(w[B.name]={stateTxt:1==B.value?h(B.setName):h(B.resetName),stateF:1==B.value?parseFloat(B.setName):parseFloat(B.resetName)})}I._property._getMeters(function(O,M){if(!O&&M){var y,K;for(y=0;y<M.length;y++){var C=M[y];C.dSID&&(u[C.dSID]=C)}}I._apartment._getSensorValues(function(G,A){if(!G&&A&&(A.outdoor&&(r=A.outdoor),A.zones))for(y=0;y<A.zones.length;y++)if(G=A.zones[y],t[G.id]={},G.values)for(K=0;K<G.values.length;K++)for(var L in G.values[K])t[G.id][L]=G.values[K][L];I._apartment._getTemperatureControlStatus(function(l,
z){if(!l&&z&&z.zones)for(y=0;y<z.zones.length;y++)l=z.zones[y],t[l.id]||(t[l.id]={}),"undefined"!=typeof l.ControlMode&&null!=l.ControlMode&&(t[l.id].ControlMode=p.HEAT_CONTROL_MODE[l.ControlMode]),"undefined"!=typeof l.OperationMode&&null!=l.OperationMode&&(t[l.id].OperationMode=p.HEAT_OP_MODE[l.OperationMode]),"undefined"!=typeof l.TemperatureValue&&null!=l.TemperatureValue&&(t[l.id].TemperatureValue=l.TemperatureValue),"undefined"!=typeof l.NominalValue&&null!=l.NominalValue&&(t[l.id].NominalValue=
l.NominalValue),"undefined"!=typeof l.ControlValue&&null!=l.ControlValue&&(t[l.id].ControlValue=l.ControlValue);var F;for(y=0;y<a.length;y++)if(a[y]){z=a[y].id;l=a[y].device;var H=a[y].status;if(z&&H&&H.value&&l&&l.type){if("meter"==l.type&&l.dsid)(C=u[l.dsid])&&(F=C[H.value]);else if("uds"==l.type&&l.id)(C=w[l.id])&&(F=C[H.value]);else if("apartment"==l.type){if(C=r[H.value])F=C.value}else"zone"==l.type&&l.zoneID&&(C=t[l.zoneID])&&(F=C[H.value]);if("undefined"==typeof F||null==F)F="?";q.push({id:z,
status:F})}}b&&b(null,q)})})})})}else b&&b(Error("deviceList is null"));else b&&b(Error("deviceList is null"))};p.prototype.toJSON=function(){return{sys:"digitalstrom",ip:this.ip,port:this.port,token:this.applicationToken}};p.prototype.equalsTo=function(c){return c&&c instanceof p?this.ip==c.ip&&this.port==c.port&&this.applicationToken==c.applicationToken:!1};p.GROUP_NAMES=f;p.GROUP_SCENE=d;p.NON_GROUP_SCENE=e;p.GROUP_DEFAULT_SCENES={1:[0,5,17,18,19,40],2:[0,5,15,17,18,19],3:[0,1,2,4,5],4:[0,5,17,
18,19],5:[0,5,17,18,19],9:[6,7,8,10,11],10:[0,5,17,18,19,33,35,36,37],11:[0,5,17,18,19,33,35,36,37],12:[0,5,17,18,19,33,35,36,37],48:[0,1,2,4,5,6,7,8,10,11],64:[0,5,17,18,19,33,35,36,37]};p.GROUP_SPECIAL_SCENE_NAME={1:{0:"Off",40:"Fade Off"},2:{0:"Up",5:"Down"},3:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night"},4:{0:"Off"},5:{0:"Off"},9:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday"},
10:{0:"Off",5:"Level 1",17:"Level 2",18:"Level 3",19:"Level 4",33:"Automatic (air flow intensity)",35:"Auto (louver swing mode)",36:"Boost",37:"Noise Reduction"},48:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday",6:"Cooling Off",7:"Cooling Comfort",8:"Cooling Economy",9:"Cooling Not Used",10:"Cooling Night",11:"Cooling Holiday"}};return p}();
xnm.aio.digitalstrom.DM=function(){var f=function(d,e){this.code=d;this.message=e;this.stack=Error().stack};f.prototype=Error();f.prototype.name="DigitalStromDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"digitalstrom",getGatewayType:function(){return[{sys:this.SYS,name:"digitalSTROM"}]},getGatewayDeviceType:function(){return[]},createGateway:function(d,e,k){e=f.ERROR_CODE;d?d.ip?k(null,d):k(new f(e.INVALID,"ip is invalid")):
k(new f(e.INVALID,"info is invalid"))},updateGateway:function(d,e,k,g){d=f.ERROR_CODE;e?e.ip?e.username?e.password?g(null,e):g(new f(d.INVALID,"password is invalid")):g(new f(d.INVALID,"username is invalid")):g(new f(d.INVALID,"ip is invalid")):g(new f(d.INVALID,"update is invalid"))},deleteGateway:function(d,e,k){k()},createDevice:function(d,e,k){var g=f.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(e.data&&e.data.gateways&&0!==e.data.gateways.length){e=e.data.gateways;var m;for(m=0;m<e.length;m++)if(e[m].index===
d.gateway){var n=e[m];break}n?k(null,d):k(new f(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else k(new f(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else k(new f(g.INVALID,"type is invalid"));else k(new f(g.INVALID,"gateway is invalid"));else k(new f(g.INVALID,"info is invalid"))},updateDevice:function(d,e,k){var g=f.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(e.data&&e.data.gateways&&0!==e.data.gateways.length){e=e.data.gateways;var m;for(m=0;m<e.length;m++)if(e[m].index===
d.gateway){var n=e[m];break}n?k(null,d):k(new f(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else k(new f(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else k(new f(g.INVALID,"type is invalid"));else k(new f(g.INVALID,"gateway is invalid"));else k(new f(g.INVALID,"info is invalid"))},deleteDevice:function(d,e,k){k()},applyUIFilter:function(d,e){var k=this,g=function(p,c){if("*"==p)return!0;for(var a=!1,b=0;b<p.length;b++)if(p[b]==c){a=!0;break}return a},m=function(p,c,
a){var b=[];switch(a.catagory){case "command":p.command&&p.command.forEach(function(h){g(a.elems,h.type)&&(h=JSON.parse(JSON.stringify(h)),b.push(h))});break;case "status":p.status&&p.status.forEach(function(h){g(a.elems,h.type)&&(h=JSON.parse(JSON.stringify(h)),b.push(h))})}return b},n=function(p,c){var a=[],b=k.getCommandStatusMap(p);b&&(p=m(b,p,c),a=a.concat(p));return a};if(!d||null==d.type||"undefined"==typeof d.type)return null;var x=JSON.parse(JSON.stringify(d)),v=null;switch(e.catagory){case "command":v=
n(d,e);x.command=v;break;case "status":v=n(d,e);x.status=v;break;default:return null}return v&&0!=v.length?x:null},getCommandStatusMap:function(d){var e=function(){var a=xnm.aio.digitalstrom.Server.GROUP_SCENE,b=[],h;for(h in a)a[h]&&b.push(a[h]);return b},k=function(){var a=xnm.aio.digitalstrom.Server.NON_GROUP_SCENE,b=[],h;for(h in a)a[h]&&b.push(a[h]);return b},g={command:[],status:[]};if(!d||!d.type)return null;if("event"==d.type)return g.command=[{type:"enum",name:"run",ref:{value:"run"}}],g;
if("uds"==d.type)return g.status=[{type:"string",name:"state (string)",ref:{value:"stateTxt"}},{type:"float",name:"state (float)",ref:{value:"stateF"}}],g;switch(d.type){case "apartment":g.command=[{type:"enum",name:"Absent",ref:{value:"doScene72"}},{type:"enum",name:"Present",ref:{value:"doScene71"}},{type:"enum",name:"Door Bell",ref:{value:"doScene73"}},{type:"enum",name:"Rain",ref:{value:"doScene88"}},{type:"enum",name:"No Rain",ref:{value:"doScene89"}},{type:"enum",name:"Wind",ref:{value:"doScene86"}},
{type:"enum",name:"No Wind",ref:{value:"doScene87"}},{type:"enum",name:"Hail",ref:{value:"doScene90"}},{type:"enum",name:"No Wind",ref:{value:"doScene91"}},{type:"enum",name:"Panic",ref:{value:"doScene65"}},{type:"enum",name:"Fire",ref:{value:"doScene76"}},{type:"enum",name:"Alarm 1",ref:{value:"doScene74"}},{type:"enum",name:"Alarm 2",ref:{value:"doScene83"}},{type:"enum",name:"Alarm 3",ref:{value:"doScene84"}},{type:"enum",name:"Alarm 4",ref:{value:"doScene85"}}];break;case "zone":g.command=[{type:"enum",
name:"Standby",ref:{value:"doScene67"}},{type:"enum",name:"Deep off",ref:{value:"doScene68"}},{type:"enum",name:"Sleeping",ref:{value:"doScene69"}},{type:"enum",name:"Wake up",ref:{value:"doScene70"}}];break;case "group":var m=xnm.aio.digitalstrom.Server.GROUP_DEFAULT_SCENES[d.applicationType];m||(m=[]);if(d.reachableScenes)for(var n=0;n<d.reachableScenes.length;n++)-1==m.indexOf(d.reachableScenes[n])&&m.push(d.reachableScenes[n]);if(d.sceneNames)for(var x in d.sceneNames)-1==m.indexOf(parseInt(x))&&
m.push(parseInt(x));for(n=0;n<m.length;n++){var v=m[n],p=null;d.sceneNames&&(p=d.sceneNames[v]);if(!p){var c=xnm.aio.digitalstrom.Server.GROUP_SPECIAL_SCENE_NAME[d.applicationType];c&&(p=c[v])}p||(p=xnm.aio.digitalstrom.Server.GROUP_SCENE[v]);p&&g.command.push({type:"enum",name:p,ref:{value:"doScene"+v}})}break;case "device":if(d.groups)for(m=[],n=0;n<d.groups.length;n++){v=[];switch(d.groups[n]){case 1:v=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}},
{type:"enum",name:"up",ref:{value:"increaseValue"}},{type:"enum",name:"down",ref:{value:"decreaseValue"}}];break;case 2:v=[{type:"enum",name:"move down",ref:{value:"turnOn"}},{type:"enum",name:"move up",ref:{value:"turnOff"}},{type:"enum",name:"step down",ref:{value:"increaseValue"}},{type:"enum",name:"step up",ref:{value:"decreaseValue"}}];break;case 4:v=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}}];break;case 5:v=[{type:"enum",name:"on",ref:{value:"turnOn"}},
{type:"enum",name:"off",ref:{value:"turnOff"}}]}for(p=0;p<v.length;p++)c=v[p],-1==m.indexOf(c.ref.value)&&(g.command.push(c),m.push(c.ref.value))}}switch(d.type){case "apartment":case "zone":e=e();e=e.concat(k());g.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:e}});break;case "group":case "device":e=e(),g.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:e}})}g.command.push({type:"int",name:"call scene",ref:{value:"callScene",
ext:"%d",extMeta:"0-127"}});k=null;switch(d.type){case "apartment":if(d.outdoor)for(x in d.outdoor)switch(x){case "temperature":g.status.push({type:"float",name:"temperature",ref:{value:"temperature"}});break;case "humidity":g.status.push({type:"float",name:"humidity",ref:{value:"humidity"}});break;case "windspeed":g.status.push({type:"float",name:"wind speed",ref:{value:"windspeed"}});break;case "winddirection":g.status.push({type:"float",name:"wind direction",ref:{value:"winddirection"}});break;
case "gustspeed":g.status.push({type:"float",name:"gust speed",ref:{value:"gustspeed"}});break;case "gustdirection":g.status.push({type:"float",name:"gust direction",ref:{value:"gustdirection"}});break;case "precipitation":g.status.push({type:"float",name:"precipitation",ref:{value:"precipitation"}});break;case "airpressure":g.status.push({type:"float",name:"air pressure",ref:{value:"airpressure"}})}break;case "zone":x=!1;if(d.sensorValues)for(n=0;n<d.sensorValues.length;n++)if(k=d.sensorValues[n])"undefined"!=
typeof k.TemperatureValue&&null!=k.TemperatureValue&&(x=!0,g.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}})),"undefined"!=typeof k.HumidityValue&&null!=k.HumidityValue&&g.status.push({type:"float",name:"humidity",ref:{value:"HumidityValue"}}),"undefined"!=typeof k.CO2ConcentrationValue&&null!=k.CO2ConcentrationValue&&g.status.push({type:"float",name:"co2",ref:{value:"CO2ConcentrationValue"}}),"undefined"!=typeof k.BrightnessValue&&null!=k.BrightnessValue&&g.status.push({type:"float",
name:"brightness",ref:{value:"BrightnessValue"}});if(d.heating)for(n=0;n<d.heating.length;n++)switch(k=d.heating[n],k){case "ControlMode":g.status.push({type:"enum",name:"control mode",ref:{value:"ControlMode",options:["off","pid_control","zone_follower","fixed_value","manual"]}});break;case "OperationMode":g.status.push({type:"enum",name:"operation mode",ref:{value:"OperationMode",options:"off comfort economy not_used night holiday cooling cooling_off".split(" ")}});break;case "TemperatureValue":x||
g.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}});break;case "NominalValue":g.status.push({type:"float",name:"target temperature",ref:{value:"NominalValue"}});break;case "ControlValue":g.status.push({type:"float",name:"control value",ref:{value:"ControlValue"}})}break;case "meter":g.status.push({type:"float",name:"power",ref:{value:"powerConsumption",unit:"W"}}),g.status.push({type:"float",name:"energy meter",ref:{value:"energyMeterValue",unit:"Wh"}})}return g}}}();
xnm.aio.digitalstrom.Handler=function(){var f=function(){};f.prototype.Server=xnm.aio.digitalstrom.Server;f.prototype.devicemanager=xnm.aio.digitalstrom.DM;f.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"digitalstrom")};f.prototype.resolveGateway=function(d){return d&&d.ip&&d.token?new this.Server(d.ip,d.port,d.token):null};f.prototype.getDeviceCommands=function(d,e){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];e&&e(null,d)};f.prototype.getDeviceStatus=
function(d,e){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];e&&e(null,d)};f.prototype.doCommand=function(d,e,k,g){(d=this.resolveGateway(d))?d.executeCommandCreator(e,k,function(m){g&&g(m)}):g&&g(Error("gateway json format invalid"))};f.prototype.doStatus=function(d,e,k,g,m){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:d,device:k,status:g}],function(n,x){n?m&&m(n):m&&m(null,x[0])}):m&&m(Error("gateway json format invalid"))};f.prototype.getDeviceList=
function(d,e){(d=this.resolveGateway(d))?d.getDevices(function(k,g){e&&e(k,g)}):e&&e(Error("gateway json format invalid"))};f.prototype.discover=function(d,e){var k=require("x.mdns.js");k.clearRecordBuffer();k.discoverServiceWithTimeout("_http._tcp.local",d,function(g,m){if(g)e&&e(g);else{for(var n=[],x=0;x<m.length;x++){var v=m[x];v.target&&v.ip&&0<v.ip.length&&"dss.local"==v.target.toLowerCase()&&(v=new xnm.aio.digitalstrom.Server(v.ip[0],8080),n.push(v))}e&&e(g,n)}})};f.prototype.registApplication=
function(d,e,k,g){if(!d||!d.ip)return null;(new this.Server(d.ip,d.port)).registApplication(e,k,function(m,n){g&&g(m,n)})};return f}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.digitalstrom.Handler);
