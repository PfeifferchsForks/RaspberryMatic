var x=x||{};x.hub=x.hub||{};x.hub.password=x.hub.password||{};
x.hub.password.PasswordManager=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.password.PasswordManager");this._pinHash=this._fileManager=null;this._secureClients={}};f.MAX_SECURE_CLIENT_COUNT=5;f.prototype.init=function(a,c){this._fileManager=a;this._pinHash=localStorage.getItem("x.hub.Server.pin");c&&c()};f.prototype.setPin=function(a,c){if(!this.checkPin(a)||!c)return!1;this._pinHash=this._hashPin(c);localStorage.setItem("x.hub.Server.pin",this._pinHash);return!0};
f.prototype.checkPin=function(a){if(!a)return!1;a=this._hashPin(a);var c=this._pinHash?this._pinHash:this._hashPin("0000");return a==c};f.prototype.reset=function(){this._pinHash=null;if(this._fileManager){var a=require("fs"),c=require("fs-extra"),b=require("path"),d=this._fileManager.getUserRootDataPath();b=b.join(d,"localstorage","x.hub.Server.pin");a.existsSync(b)&&(this._logger.log("trace","remove file "+b),c.removeSync(b))}};f.prototype._hashPin=function(a){return require("x.crypt.js").MD5(a+
"_SALT!")};f.prototype.addSecureClient=function(a,c,b){if(a){var d=0,e=null,g=null,h,k;for(k in this._secureClients)k==a?delete this._secureClients[k]:(h=this._secureClients[k])&&h.lastAccess?(d++,g)?h.lastAccess<e&&(g=k,e=h.lastAccess):(g=k,e=h.lastAccess):delete this._secureClients[k];d>=f.MAX_SECURE_CLIENT_COUNT&&delete this._secureClients[g];e=require("crypto");g=require("x.crypt.js");h=e.randomBytes(32).toString("hex");d=(new Buffer(g.Curve25519.curve25519(h))).toString("hex");g=g.Curve25519.curve25519(h,
c);c=g.slice(0,16);g=g.slice(16,32);e=e.randomBytes(16).toString("hex");this._secureClients[a]={token:e,key:c,iv:g,lastAccess:null};b&&b(null,this._secureClients[a],d)}else b&&b(Error("invalid client ip"))};f.prototype.decodeSecureReq=function(a,c,b){if(a)if(this._secureClients[a])if(c.body){a=this._secureClients[a];var d=require("x.crypt.js");d.AES.setSize(128);var e=d.AES.decrypt(d.AES.h2a(c.body),a.key,a.iv,!1);d=d.AES.a2s(e);32>d.length?b&&b(Error("invalid secure request")):d.substr(0,32)!=a.token?
b&&b(Error("unknown client token")):(d=d.substr(32),a=require("url").parse(d),c.method="GET",c.url=d,a.pathname&&(c.path=a.pathname),a.query&&(d=require("querystring"),c.query=d.parse(a.query)),b&&b(null,c))}else b&&b(Error("invalid secure request"));else b&&b(Error("unknown client ip"));else b&&b(Error("invalid client ip"))};f.prototype.encodeSecureRsp=function(a,c,b){if(a)if(this._secureClients[a])if(c){var d=this._secureClients[a];a=require("x.crypt.js");a.AES.setSize(128);var e=new Buffer(c,"utf8");
Array.prototype.slice.call(e);c=a.AES.encrypt(a.AES.s2a(c),d.key,d.iv);b&&b(null,a.AES.a2h(c))}else b&&b(null,c);else b&&b(Error("unknown client ip"));else b&&b(Error("invalid client ip"))};return f}();
x.hub.password.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.password.Handler");this._passwordManager=new x.hub.password.PasswordManager};f.prototype.init=function(a,c){this._initHttpApi();this._passwordManager.init(a,function(b){b&&c(b)})};f.prototype._initHttpApi=function(){var a=this;require("x.hub.js").getServer().addRoute("/pwd",{method:"GET",source:1,lock:1},function(c,b,d){(c=c.query?c.query.pin:null)?a.checkPin(c)?b.json({XC_SUC:{}}):b.json({XC_ERR:{code:"000003",
msg:"check failed"}}):b.json({XC_ERR:{code:"000005",msg:"invalid parameter"}})})};f.prototype.checkPin=function(a){return this._passwordManager.checkPin(a)};f.prototype.setPin=function(a,c){return this._passwordManager.setPin(a,c)};f.prototype.reset=function(a){this._passwordManager.reset();a&&a()};f.prototype.registSecureClient=function(a,c,b){this._passwordManager.addSecureClient(a,c,function(d,e,g){d?b&&b(d):(d=require("x.crypt.js"),d.AES.setSize(128),e=d.AES.encrypt(d.AES.h2a(e.token),e.key,e.iv),
e=d.AES.a2h(e),b&&b(null,{key:g,token:e}))})};f.prototype.decodeSecureReq=function(a,c,b){this._passwordManager.decodeSecureReq(a,c,function(d,e){b&&b(d,e)})};f.prototype.encodeSecureRsp=function(a,c,b){this._passwordManager.encodeSecureRsp(a,c,function(d,e){b&&b(d,e)})};return f}();module.exports=new x.hub.password.Handler;
