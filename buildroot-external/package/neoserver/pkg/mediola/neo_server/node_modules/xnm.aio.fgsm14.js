var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fgsm14=xnm.aio.fgsm14||{};
xnm.aio.fgsm14.Gateway=function(){var d=function(b,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.sample.Gateway");this.ip=b;this.port=a;this.port||(this.port=80);this.CommandHandler=null};d.prototype._doRequest=function(b,a,c,e,f){b={host:this.ip,port:this.port,path:a,method:b,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(c)for(var h in c)c.hasOwnProperty(h)&&(b.headers[h]=c[h]);e&&(b.headers["Content-Length"]=
e.length);this._logger.log("trace","do request:"+JSON.stringify(b));c=require("https");var n=this,l=f,k=c.request(b,function(g){g.setEncoding("utf-8");var r="";g.on("data",function(m){r+=m});g.on("end",function(){n._logger.log("trace","receive code:"+g.statusCode+" headers:"+JSON.stringify(g.headers)+" response:"+r);l&&(l(null,r,g),l=null)})});if(k.on)k.on("error",function(g){n._logger.log("trace","do request error:"+g.message);l&&(l(g),l=null)});k.setTimeout&&k.setTimeout(2E3,function(){n._logger.log("trace",
"do request timeout");k.abort();l&&(l(Error("timeout")),l=null)});e&&(this._logger.log("trace","do request send body:"+e),k.write(e));k.end()};d.prototype.getDevices=function(b){b(null,[{sys:"fgsm14",type:"swtich",address:1},{sys:"fgsm14",type:"dimmer",address:2}])};d.prototype.executeCommandCreator=function(b,a,c){b?a?c(null):c(Error("invalid command json")):c(Error("invalid device json"))};d.prototype.getStatesCreator=function(b,a,c){if(a){b=[];for(var e=0;e<a.length;e++){var f=a[e];f&&"switch"==
f.device.type&&f.id&&f.status&&"state"==f.status.value?b.push({id:f.id,status:"on"}):f&&"dimmer"==f.device.type&&f.id&&f.status&&"level"==f.status.value&&b.push({id:f.id,level:70})}c(null,b)}else c(Error("invalid device list"))};d.prototype.toJSON=function(){return{sys:"sample",ip:this.ip,port:this.port}};d.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.sample.Gateway?this.ip==b.ip:!1};d.parseJSON=function(b){return b.ip?new d(b.ip,b.port):null};return d}();
xnm.aio.fgsm14.DM=function(){var d=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="FGSM14DMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},
dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"moveUp"}},
{type:"enum",name:"move down",ref:{value:"moveDown"}},{type:"enum",name:"stop",ref:{value:"stop"}}]}};return{SYS:"fgsm14",getGatewayType:function(){return[{sys:this.SYS,name:"Sample",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(a,c,e){c=d.ERROR_CODE;a?a.ip?a.port?
a.type?e(null,a):e(new d(c.INVALID,"type is invalid")):e(new d(c.INVALID,"port is invalid")):e(new d(c.INVALID,"ip is invalid")):e(new d(c.INVALID,"info is invalid"))},updateGateway:function(a,c,e,f){a=d.ERROR_CODE;c?c.ip?c.port?c.type?f(null,c):f(new d(a.INVALID,"type is invalid")):f(new d(a.INVALID,"port is invalid")):f(new d(a.INVALID,"ip is invalid")):f(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,c,e){e()},createDevice:function(a,c,e){var f=d.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=
c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){var n=c[h];break}n?e&&e(null,a):e(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(f.INVALID,"gateway is invalid"));else e(new d(f.INVALID,"type is invalid"));else e(new d(f.INVALID,"address is invalid"));else e(new d(f.INVALID,"info is invalid"))},updateDevice:function(a,c,e){var f=d.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===
a.gateway){var n=c[h];break}n?e(null,a):e(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(f.INVALID,"gateway is invalid"));else e(new d(f.INVALID,"type is invalid"));else e(new d(f.INVALID,"address is invalid"));else e(new d(f.INVALID,"info is invalid"))},deleteDevice:function(a,c,e){e()},applyUIFilter:function(a,c,e){var f=function(g,r){if("*"==g)return!0;for(var m=!1,p=0;p<g.length;p++)if(g[p]==r){m=!0;break}return m},h=function(g,r,m){var p=[];"command"==m.catagory?
g.command&&g.command.forEach(function(q){f(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))}):"status"==m.catagory&&g.status&&g.status.forEach(function(q){f(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});return p},n=function(g,r){var m=[],p=xnm.aio.feller.DM.getCommandStatusMap(g,e);p&&(g=h(p,g,r),m=m.concat(g));return m};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),k=null;if("command"==c.catagory)k=n(a,c),l.command=k;else if("status"==c.catagory)k=n(a,c),
l.status=k;else return null;return k&&0!=k.length?l:null},getCommandStatusMap:function(a){return a.type?b[a.type]:null}}}();
xnm.aio.fgsm14.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.fgsm14.DM;d.prototype.Gateway=xnm.aio.fgsm14.Gateway;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"fgsm14")};d.prototype.resolveGateway=function(b){return b?this.Gateway.parseJSON(b):null};d.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(b,a,c,e){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(f){e&&e(f)}):e&&e(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,a,c,e,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:e}],function(h,n){h?f&&f(h):f&&f(null,n[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(b,a){(b=this.resolveGateway(b))?b.getDevices(a):
a&&a(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fgsm14.Handler);
