var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};$jscomp.polyfill=function(a,b,c,e){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,e):$jscomp.polyfillUnisolated(a,b,c,e))};
$jscomp.polyfillUnisolated=function(a,b,c,e){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];if(!(d in c))return;c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,e){var d=a.split(".");a=1===d.length;e=d[0];e=!a&&e in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<d.length-1;g++){var f=d[g];if(!(f in e))return;e=e[f]}d=d[d.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?e[d]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+c+"$"+d),$jscomp.defineProperty(e,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:b})))};
$jscomp.getConstructImplementation=function(){function a(){function c(){}new c;Reflect.construct(c,[],function(){});return new c instanceof c}if($jscomp.TRUST_ES6_POLYFILLS&&"undefined"!=typeof Reflect&&Reflect.construct){if(a())return Reflect.construct;var b=Reflect.construct;return function(c,e,d){c=b(c,e);d&&Reflect.setPrototypeOf(c,d.prototype);return c}}return function(c,e,d){void 0===d&&(d=c);d=$jscomp.objectCreate(d.prototype||Object.prototype);return Function.prototype.apply.call(c,d,e)||
d}};$jscomp.construct={valueOf:$jscomp.getConstructImplementation}.valueOf();$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var e=Object.getOwnPropertyDescriptor(b,c);e&&Object.defineProperty(a,c,e)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.generator={};
$jscomp.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};$jscomp.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};
$jscomp.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};$jscomp.generator.Context.prototype.stop_=function(){this.isRunning_=!1};$jscomp.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};$jscomp.generator.Context.prototype.next_=function(a){this.yieldResult=a};
$jscomp.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};$jscomp.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};
$jscomp.generator.Context.prototype.yieldAll=function(a,b){a=$jscomp.makeIterator(a);var c=a.next();$jscomp.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};$jscomp.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};$jscomp.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};
$jscomp.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};$jscomp.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};$jscomp.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
$jscomp.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};$jscomp.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
$jscomp.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};$jscomp.generator.Context.prototype.forIn=function(a){return new $jscomp.generator.Context.PropertyIterator(a)};
$jscomp.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};$jscomp.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};$jscomp.generator.Engine_=function(a){this.context_=new $jscomp.generator.Context;this.program_=a};
$jscomp.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(c){return{value:c,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var e=a.call(this.context_.yieldAllIterator_,b);$jscomp.generator.ensureIteratorResultIsObject_(e);if(!e.done)return this.context_.stop_(),e;var d=e.value}catch(g){return this.context_.yieldAllIterator_=null,this.context_.throw_(g),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,d);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
$jscomp.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};this[Symbol.iterator]=function(){return this}};$jscomp.generator.createGenerator=function(a,b){b=new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(b));$jscomp.setPrototypeOf&&a.prototype&&$jscomp.setPrototypeOf(b,a.prototype);return b};
$jscomp.asyncExecutePromiseGenerator=function(a){function b(e){return a.next(e)}function c(e){return a.throw(e)}return new Promise(function(e,d){function g(f){f.done?e(f.value):Promise.resolve(f.value).then(b,c).then(g,d)}g(a.next())})};$jscomp.asyncExecutePromiseGeneratorFunction=function(a){return $jscomp.asyncExecutePromiseGenerator(a())};$jscomp.asyncExecutePromiseGeneratorProgram=function(a){return $jscomp.asyncExecutePromiseGenerator(new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(a)))};
$jscomp.polyfill("Reflect",function(a){return a?a:{}},"es6","es3");$jscomp.polyfill("Reflect.construct",function(a){return $jscomp.construct},"es6","es3");$jscomp.polyfill("Reflect.setPrototypeOf",function(a){if(a)return a;if($jscomp.setPrototypeOf){var b=$jscomp.setPrototypeOf;return function(c,e){try{return b(c,e),!0}catch(d){return!1}}}return null},"es6","es5");$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(g,f){this.$jscomp$symbol$id_=g;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:f})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",e=0,d=function(g){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new b(c+(g||"")+"_"+e++,g)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var e=$jscomp.global[b[c]];"function"===typeof e&&"function"!=typeof e.prototype[a]&&$jscomp.defineProperty(e.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(f){return f instanceof d?f:new d(function(h,k){h(f)})}if(a&&(!($jscomp.FORCE_POLYFILL_PROMISE||$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION&&"undefined"===typeof $jscomp.global.PromiseRejectionEvent)||!$jscomp.global.Promise||-1===$jscomp.global.Promise.toString().indexOf("[native code]")))return a;b.prototype.asyncExecute=function(f){if(null==this.batch_){this.batch_=[];var h=this;this.asyncExecuteFunction(function(){h.executeBatch_()})}this.batch_.push(f)};
var e=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(f){e(f,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var f=this.batch_;this.batch_=[];for(var h=0;h<f.length;++h){var k=f[h];f[h]=null;try{k()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(f){this.asyncExecuteFunction(function(){throw f;})};var d=function(f){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];this.isRejectionHandled_=!1;var h=this.createResolveAndReject_();
try{f(h.resolve,h.reject)}catch(k){h.reject(k)}};d.prototype.createResolveAndReject_=function(){function f(l){return function(n){k||(k=!0,l.call(h,n))}}var h=this,k=!1;return{resolve:f(this.resolveTo_),reject:f(this.reject_)}};d.prototype.resolveTo_=function(f){if(f===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof d)this.settleSameAsPromise_(f);else{a:switch(typeof f){case "object":var h=null!=f;break a;case "function":h=!0;break a;default:h=!1}h?this.resolveToNonPromiseObj_(f):
this.fulfill_(f)}};d.prototype.resolveToNonPromiseObj_=function(f){var h=void 0;try{h=f.then}catch(k){this.reject_(k);return}"function"==typeof h?this.settleSameAsThenable_(h,f):this.fulfill_(f)};d.prototype.reject_=function(f){this.settle_(2,f)};d.prototype.fulfill_=function(f){this.settle_(1,f)};d.prototype.settle_=function(f,h){if(0!=this.state_)throw Error("Cannot settle("+f+", "+h+"): Promise already settled in state"+this.state_);this.state_=f;this.result_=h;2===this.state_&&this.scheduleUnhandledRejectionCheck_();
this.executeOnSettledCallbacks_()};d.prototype.scheduleUnhandledRejectionCheck_=function(){var f=this;e(function(){if(f.notifyUnhandledRejection_()){var h=$jscomp.global.console;"undefined"!==typeof h&&h.error(f.result_)}},1)};d.prototype.notifyUnhandledRejection_=function(){if(this.isRejectionHandled_)return!1;var f=$jscomp.global.CustomEvent,h=$jscomp.global.Event,k=$jscomp.global.dispatchEvent;if("undefined"===typeof k)return!0;"function"===typeof f?f=new f("unhandledrejection",{cancelable:!0}):
"function"===typeof h?f=new h("unhandledrejection",{cancelable:!0}):(f=$jscomp.global.document.createEvent("CustomEvent"),f.initCustomEvent("unhandledrejection",!1,!0,f));f.promise=this;f.reason=this.result_;return k(f)};d.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var f=0;f<this.onSettledCallbacks_.length;++f)g.asyncExecute(this.onSettledCallbacks_[f]);this.onSettledCallbacks_=null}};var g=new b;d.prototype.settleSameAsPromise_=function(f){var h=this.createResolveAndReject_();
f.callWhenSettled_(h.resolve,h.reject)};d.prototype.settleSameAsThenable_=function(f,h){var k=this.createResolveAndReject_();try{f.call(h,k.resolve,k.reject)}catch(l){k.reject(l)}};d.prototype.then=function(f,h){function k(m,q){return"function"==typeof m?function(r){try{l(m(r))}catch(t){n(t)}}:q}var l,n,p=new d(function(m,q){l=m;n=q});this.callWhenSettled_(k(f,l),k(h,n));return p};d.prototype.catch=function(f){return this.then(void 0,f)};d.prototype.callWhenSettled_=function(f,h){function k(){switch(l.state_){case 1:f(l.result_);
break;case 2:h(l.result_);break;default:throw Error("Unexpected state: "+l.state_);}}var l=this;null==this.onSettledCallbacks_?g.asyncExecute(k):this.onSettledCallbacks_.push(k);this.isRejectionHandled_=!0};d.resolve=c;d.reject=function(f){return new d(function(h,k){k(f)})};d.race=function(f){return new d(function(h,k){for(var l=$jscomp.makeIterator(f),n=l.next();!n.done;n=l.next())c(n.value).callWhenSettled_(h,k)})};d.all=function(f){var h=$jscomp.makeIterator(f),k=h.next();return k.done?c([]):new d(function(l,
n){function p(r){return function(t){m[r]=t;q--;0==q&&l(m)}}var m=[],q=0;do m.push(void 0),q++,c(k.value).callWhenSettled_(p(m.length-1),n),k=h.next();while(!k.done)})};return d},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var g=a[d];if(b.call(c,g,d,a))return{i:d,v:g}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");
$jscomp.polyfill("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(b,c){var e=this;e instanceof String&&(e=String(e));var d=e.length;c=c||0;for(0>c&&(c=Math.max(c+d,0));c<d;c++){var g=e[c];if(g===b||Object.is(g,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,c||0)}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.somfylocal=xnm.aio.somfylocal||{};xnm.aio.somfylocal.getLogger=function(a){var b=require("x.logger.js").getLogger(a);require("x.logger.js").setLogToConsole(!0,a);return b};
var __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0=function(a){this.HOST="ha101-1.overkiz.com";this.API_BASE="/enduser-mobile-web/enduserAPI";this.TOKEN_LABEL="Mediola_"+a.pod;this.TEMP_TOKEN_LABEL="xnm.aio.somfylocal.tempToken."+a.pod;this.SECRET_KEY="DoNotChangeMeItIsNotSecure";this.cookie="";this.lastLogin=0;this.boxInfo=a;this.client=new xnm.aio.somfylocal.httpClient(this.HOST,null,!0);this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.TokenManager")};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.getValidBoxInfo=function(){var a=this,b,c,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){switch(g.nextAddress){case 1:return g.setCatchFinallyBlocks(2),g.yield(a.doLogin(),4);case 4:return g.yield(a._generateToken(),5);case 5:b=g.yieldResult;if(!b)throw Error("can not generate token");return g.yield(a._activateToken(),6);case 6:c=g.yieldResult;if(!c)throw Error("can not activate token");return g.yield(a.getTokenInfo(),
7);case 7:return e=g.yieldResult,a.boxInfo.expirationTime=e&&e.expirationTime?e.expirationTime:Date.now()+145152E5,a.boxInfo.discovery=!1,g.return(a.boxInfo);case 2:return d=g.enterCatchBlock(),a._logger.log("error",d),g.return(null)}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.doLogin=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return c.yield(a._login(),2);b=c.yieldResult;if(!b)throw Error("can not login");c.jumpToEnd()})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.isValid=function(a){var b=this,c,e,d,g,f,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){switch(k.nextAddress){case 1:return k.setCatchFinallyBlocks(2),k.yield(b.doLogin(),4);case 4:return b._checkCookie(),k.yield(b._listTokens(),5);case 5:c=k.yieldResult;e=b.boxInfo.tokenLabel;a&&(e=a);if(!c)return k.return("unknown");if(!e)return b._logger.log("warn","anomaly tokenLabel is not set for "+b.boxInfo.pod),k.return("unknown");
d=c.find(function(l){return l.label==e});if(!d)return g=JSON.parse(JSON.stringify(b.boxInfo)),g.username=g.username&&"*****",g.password=g.password&&"*****",g.token=g.token&&"*****",b._logger.log("warn","cannot find the token in list "+JSON.stringify(g)),k.return("invalid");if(!d.expirationTime)return b._logger.log("warn","expirationTime is not there "+JSON.stringify(d)),k.return("unknown");f=d.expirationTime-Date.now();return 2592E6>f?k.return("invalid"):k.return("ok");case 2:return h=k.enterCatchBlock(),
b._logger.log("error",h),k.return("unknown")}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.getTokenInfo=function(){var a=this,b,c,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){switch(d.nextAddress){case 1:return d.setCatchFinallyBlocks(2),d.yield(a.doLogin(),4);case 4:return a._checkCookie(),d.yield(a._listTokens(),5);case 5:b=d.yieldResult;if(!b)return d.return(null);if(!a.boxInfo.tokenLabel)return a._logger.log("warn","get token info : anomaly tokenLabel is not set for "+a.boxInfo.pod),d.return(null);
c=b.find(function(g){return g.label==a.boxInfo.tokenLabel});return c?d.return(c):(a._logger.log("warn","get token info : can not find the token in list "+JSON.stringify(a.boxInfo)),d.return(null));case 2:return e=d.enterCatchBlock(),a._logger.log("error",e),d.return(null)}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.getIP=function(a){var b=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return c.return(new Promise(function(e,d){try{var g="gateway-"+b.boxInfo.pod+".local",f=require("x.mdns.js");f.clearRecordBuffer();if("number"!==typeof a||isNaN(a))a=1E4;f.discoverServiceWithTimeout("_kizboxdev._tcp.local",a,function(h,k){if(h)d(h);else{h=null;for(var l=0;l<k.length;l++){var n=k[l];n.target.toString()==g&&n.ip&&0<n.ip.length&&
(h=n.ip[0])}h&&xnm.aio.somfylocal.Utils._isIP(h)?(b._logger.log("debug",g+" is resolved to "+h),e(h)):d(Error("can not resolve the ip"))}})}catch(h){d(h)}}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._login=function(){var a=this,b,c,e,d,g,f,h,k;return $jscomp.asyncExecutePromiseGeneratorProgram(function(l){if(1==l.nextAddress){l.setCatchFinallyBlocks(2);b=Date.now();c=b-a.lastLogin;if(a.lastLogin&&6E4>c)return a._logger.log("debug","we should still be logged in, last login at "+a.lastLogin+" - delta "+c),l.return(!0);e={"Content-Type":"application/x-www-form-urlencoded"};d=encodeURI("userId")+"="+encodeURI(a.boxInfo.username)+
"&"+encodeURI("userPassword")+"="+encodeURI(a.boxInfo.password);g=a.API_BASE+"/login";return l.yield(a.client.post(g,e,d),4)}if(2!=l.nextAddress){f=l.yieldResult;if(!f.body||!f.body.success)throw Error("login failed");h=f.headers["Set-Cookie"]||f.headers["set-cookie"];if(!h||!h[0])throw Error("can not get cookie");a.cookie=h[0];a.lastLogin=Date.now();return l.return(!0)}k=l.enterCatchBlock();a._logger.log("error",k);return l.return(!1)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._generateToken=function(){var a=this,b,c,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){if(1==g.nextAddress)return g.setCatchFinallyBlocks(2),a._checkCookie(),b=a._getHeaders(),c=a.API_BASE+"/config/"+encodeURIComponent(a.boxInfo.pod)+"/local/tokens/generate",g.yield(a.client.get(c,b),4);if(2!=g.nextAddress){e=g.yieldResult;if(!e.body||!e.body.token)throw Error("can not generate token");a.boxInfo.token=
e.body.token;return g.return(!0)}d=g.enterCatchBlock();a._logger.log("error",d);return g.return(!1)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._activateToken=function(a){var b=this,c,e,d,g,f,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress){k.setCatchFinallyBlocks(2);if(!b.boxInfo.token)throw Error("you need first generate token, no token is set");b._checkCookie();c=b._getHeaders();e=b.TOKEN_LABEL+"_"+Date.now();a&&(e=a);d={label:e,token:b.boxInfo.token,scope:"devmode"};g=b.API_BASE+"/config/"+encodeURIComponent(b.boxInfo.pod)+
"/local/tokens";return k.yield(b.client.post(g,c,JSON.stringify(d)),4)}if(2!=k.nextAddress){f=k.yieldResult;if(!f.body||!f.body.requestId)throw Error("can not activate token");b.boxInfo.tokenLabel=e;return k.return(e)}h=k.enterCatchBlock();b._logger.log("error",h);return k.return(!1)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.deleteToken=function(){var a=this,b,c,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){switch(g.nextAddress){case 1:return g.setCatchFinallyBlocks(2),g.yield(a.doLogin(),4);case 4:return a._checkCookie(),g.yield(a.getTokenInfo(),5);case 5:b=g.yieldResult;if(!b)throw Error("something is wrong in getting token info");c=a._getHeaders();e=a.API_BASE+"/config/"+encodeURIComponent(a.boxInfo.pod)+"/local/tokens/"+
b.uuid;return g.return(a.client.delete(e,c).then(function(f){a._logger.log("debug",b.uuid+" is deleted");return!0}));case 2:return d=g.enterCatchBlock(),a._logger.log("error","can not delete "+a.boxInfo.tokenLabel+" of "+a.boxInfo.pod),a._logger.log("error",d),g.return(!1)}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype.getTempBoxInfo=function(){var a=this,b,c,e,d,g,f,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){switch(k.nextAddress){case 1:return k.setCatchFinallyBlocks(2),b=a._getLocalStorage(),c=b.getItem(a.TEMP_TOKEN_LABEL),(e=a._decodeInfo(c))&&!a._isTokenExpired(e.expirationTime)?(a._logger.log("debug","reading box info from localStorage"),a.boxInfo=e,k.return(a.boxInfo)):k.yield(a.doLogin(),4);case 4:return k.yield(a._generateToken(),
5);case 5:d=k.yieldResult;if(!d)throw Error("can not generate temp token");return k.yield(a._activateToken(a.TEMP_TOKEN_LABEL),6);case 6:g=k.yieldResult;if(!g)throw Error("can not activate temp token");return k.yield(a.getTokenInfo(),7);case 7:return f=k.yieldResult,a.boxInfo.expirationTime=f&&f.expirationTime?f.expirationTime:Date.now()+145152E5,b.setItem(a.TEMP_TOKEN_LABEL,a._encodeInfo(a.boxInfo)),k.return(a.boxInfo);case 2:h=k.enterCatchBlock(),a._logger.log("error","can not get temp token"),
a._logger.log("error",h.stack?h.stack:h),k.jumpToEnd()}})};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._getLocalStorage=function(){if(XC&&XC.localStorage)return XC.localStorage;if(localStorage)return localStorage;throw Error("can not find the localStorage");};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._listTokens=function(){var a=this,b,c,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){if(1==g.nextAddress)return g.setCatchFinallyBlocks(2),b=a._getHeaders(),c=a.API_BASE+"/config/"+encodeURIComponent(a.boxInfo.pod)+"/local/tokens/devmode",g.yield(a.client.get(c,b),4);if(2!=g.nextAddress){e=g.yieldResult;if(!e.body||!Array.isArray(e.body))throw Error("list of tokens are invalid");return g.return(e.body)}d=
g.enterCatchBlock();a._logger.log("error",d);return g.return(null)})};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._checkCookie=function(){if(!this.cookie)throw Error("you need first login, no cookie is set");return!0};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._getHeaders=function(){return{Cookie:this.cookie}};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._encodeInfo=function(a){a=JSON.stringify(a);try{return require("x.crypt.js").AES.encodeString(a,this.SECRET_KEY)}catch(b){this._logger.log("error",b.stack?b.stack:b)}return a};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._decodeInfo=function(a){try{return JSON.parse(a)}catch(b){return a=require("x.crypt.js").AES.decodeString(a,this.SECRET_KEY),JSON.parse(a)}};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0.prototype._isTokenExpired=function(a){return 2592E6>a-Date.now()?!0:!1};xnm.aio.somfylocal.TokenManager=__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var0;
var __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1=function(a){this.excludeDeviceList="Pod ConfigurationComponent NetworkComponent ProtocolGateway ConsumptionSensor ElectricitySensor OnOffHeatingSystem Wifi RemoteController io:LightIOSystemDeviceSensor io:RelativeHumidityIOSystemDeviceSensor WeatherForecastSensor".split(" ");this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.Box."+a.pod);this.somfyBoxInfo=a;this.HOST=a.ip;this.API_BASE="/enduser-mobile-web/1/enduserAPI";
this.client=new xnm.aio.somfylocal.httpClient(this.HOST,null,!1,this.somfyBoxInfo.port);this.tokenHandler=new xnm.aio.somfylocal.TokenManager(this.somfyBoxInfo)};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.executeCommandCreator=function(a,b,c){var e=this,d,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){switch(f.nextAddress){case 1:f.setCatchFinallyBlocks(2);if(!e.tokenHandler._isTokenExpired(e.somfyBoxInfo.expirationTime)){f.jumpTo(4);break}return f.yield(e.tokenHandler.getTempBoxInfo(),5);case 5:d=f.yieldResult,e.somfyBoxInfo=d;case 4:return f.yield(e._executeCommand(a,b),6);case 6:c(null);f.leaveTryBlock(0);
break;case 2:g=f.enterCatchBlock(),c(g),f.jumpToEnd()}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.getStatesCreator=function(a,b,c){var e=this,d,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){switch(f.nextAddress){case 1:f.setCatchFinallyBlocks(2);if(!e.tokenHandler._isTokenExpired(e.somfyBoxInfo.expirationTime)){f.jumpTo(4);break}return f.yield(e.tokenHandler.getTempBoxInfo(),5);case 5:d=f.yieldResult,e.somfyBoxInfo=d;case 4:return f.yield(e._getStates(a,b),6);case 6:g=f.yieldResult;c(null,g);f.leaveTryBlock(0);
break;case 2:f.enterCatchBlock(),c(err,null),f.jumpToEnd()}})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._executeCommand=function(a,b){var c=this,e,d,g,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){if(1==h.nextAddress)return e=[],b.ext&&e.push(b.ext),d=b.value,"toggle"!=b.value?h.jumpTo(2):h.yield(c._getState(a.device.deviceURL,"core:OnOffState"),3);if(2!=h.nextAddress){g=h.yieldResult;if(void 0==g)throw Error("can not get the current state of "+a.address);"on"==g?d="off":"off"==g&&(d="on")}f={deviceURL:a.device.deviceURL,
commands:[{name:d,parameters:e}]};return h.return(c._execApply([f]))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getStates=function(a,b){var c=this,e,d,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return f.setCatchFinallyBlocks(2),f.yield(c._getSetup(),4);if(2!=f.nextAddress){e=f.yieldResult;d=[];if(!e||!e.devices||!e.devices.length)return b.forEach(function(h){d.push({id:h.id,status:"error"})}),f.return(d);b.forEach(function(h){var k=e.devices.find(function(l){return l.deviceURL==h.device.address});
k?k.states&&k.states.length?(k=k.states.find(function(l){return l.name==h.status.value}))?d.push({id:h.id,status:k.value}):d.push({id:h.id,status:"unknown"}):d.push({id:h.id,status:"states empty"}):d.push({id:h.id,status:"no data"})});return f.return(d)}g=f.enterCatchBlock();c._logger.log("error",g.stack?g.stack:g);throw g;})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getState=function(a,b){var c=this,e,d,g,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){if(1==h.nextAddress)return h.setCatchFinallyBlocks(2),h.yield(c._getSetup(),4);if(2!=h.nextAddress){e=h.yieldResult;d=e.devices.find(function(k){return k.deviceURL==a});if(!d)throw Error("can not find device "+a);if(!d.states)throw Error(a+" does not have states");g=d.states.find(function(k){return k.name==b});if(!g)throw Error("can not find state for "+
b+" of "+a);return h.return(g.value)}f=h.enterCatchBlock();c._logger.log("error","error in getting "+b+" of "+a);c._logger.log("error",f.stack?f.stack:f);return h.return(void 0)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.listDevices=function(){var a=this,b,c,e,d,g,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){if(1==h.nextAddress)return h.yield(a._getSetup(),2);b=h.yieldResult;if(!b||!b.devices)throw Error("get setup returns invalid format");c={devices:[]};e=b.devices;for(d=0;d<e.length;d++)g=e[d],a.excludeDeviceList.includes(g.uiClass)||a.excludeDeviceList.includes(g.widget)||a.excludeDeviceList.includes(g.controllableName)||
a.excludeDeviceList.includes(g.label)||a.excludeDeviceList.includes(g.protocol)||a.excludeDeviceList.includes(g.definition.uiClass)||a.excludeDeviceList.includes(g.definition.widgetName)?a._logger.log("warn","excluded "+JSON.stringify(g)):(f={sys:"somfylocal",name:g.label,address:g.deviceURL,placeOID:g.placeOID,type:a._uiClassToMediolaType(g.definition.uiClass),device:g},"not-supported"==f.type?a._logger.log("error","we do not support "+JSON.stringify(g)):c.devices.push(f));return h.return(c)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.isReachable=function(){var a=this,b,c,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.setCatchFinallyBlocks(2),d.yield(a._getInfos(),4);if(2!=d.nextAddress)return b=d.yieldResult,c=b.find(function(g){return g.gatewayId==a.somfyBoxInfo.pod}),d.return(c?!0:!1);e=d.enterCatchBlock();a._logger.log("error",e.stack?e.stack:e);return d.return(!1)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getInfos=function(){var a=this,b,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return b=a._getEndpointPath("/setup/gateways"),e.yield(a.client.get(b,a._getHeaders()).then(function(d){return d.body}),2);c=e.yieldResult;return Array.isArray(c)?e.return(c):(a._logger.log("error","can not get infos, "+JSON.stringify(c)),e.return([]))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._uiClassToMediolaType=function(a){switch(a){case "OnOff":return"switch";case "Awning":case "ExteriorScreen":case "Pergola":case "Screen":case "Shutter":case "SwingingShutter":case "RollerShutter":case "VenetianBlind":case "ExteriorVenetianBlind":return"blind";case "Gate":case "GarageDoor":return"door";case "AirSensor":case "ContactSensor":case "HumiditySensor":case "LightSensor":case "RainSensor":case "Siren":case "SmokeSensor":case "TemperatureSensor":return"sensor";
case "DoorLock":return"lock";case "HeatingSystem":return"heating";case "Light":return"light";case "Window":return"window";default:return"not-supported"}};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._execApply=function(a){var b=this,c,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){c=b._getEndpointPath("/exec/apply");e={actions:a};d=b.client.post(c,b._getHeaders(),JSON.stringify(e));b._checkResponseAndThrowError(d);return g.return(d.body)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getSetup=function(){var a=this,b,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return b=a._getEndpointPath("/setup"),e.yield(a.client.get(b,a._getHeaders()),2);c=e.yieldResult;a._checkResponseAndThrowError(c);return e.return(c.body)})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._checkResponseAndThrowError=function(a){if(a&&a.statusCode&&(200>a.statusCode||299<a.statusCode)){var b=a.statusMessage;if(a.body)try{b=JSON.stringify(a.body)}catch(c){b=a.body}b=Error(b);b.code=a.statusCode;throw b;}};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getEndpointPath=function(a){return this.API_BASE+a};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype._getHeaders=function(){return{Authorization:"Bearer "+this.somfyBoxInfo.token}};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.toJSON=function(){return this.somfyBoxInfo};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1.prototype.equalsTo=function(a){return a&&a instanceof __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1?this.somfyBoxInfo.username==a.somfyBoxInfo.username&&this.somfyBoxInfo.password==a.somfyBoxInfo.password&&this.somfyBoxInfo.pod==a.somfyBoxInfo.pod:!1};xnm.aio.somfylocal.Box=__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var1;
xnm.aio.somfylocal.DeviceManagerErrorCodes={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6};var __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var2=function(a,b){b=Error.call(this,b);this.message=b.message;"stack"in b&&(this.stack=b.stack);this.name="SomfyLocalDMError";this.code=a};$jscomp.inherits(__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var2,Error);xnm.aio.somfylocal.DeviceManagerError=__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var2;
xnm.aio.somfylocal.DM={Error:xnm.aio.somfylocal.DeviceManagerError,ErrorCodes:xnm.aio.somfylocal.DeviceManagerErrorCodes,Logger:xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.Dm"),SYS:"somfylocal",getGatewayType:function(){return[{sys:this.SYS,name:"Somfy"}]},createGateway:function(a,b,c){var e=this,d,g,f,h,k;return $jscomp.asyncExecutePromiseGeneratorProgram(function(l){switch(l.nextAddress){case 1:l.setCatchFinallyBlocks(2);if(a.discovery&&a.ip&&a.pod)return a.discovery=!1,c(null,a),l.return();
d=new xnm.aio.somfylocal.TokenManager(a);e._validateBoxInfo(a);if(a.token&&a.tokenLabel){l.jumpTo(4);break}return l.yield(d.getValidBoxInfo(),5);case 5:g=l.yieldResult;if(!g)throw new e.Error(e.ErrorCodes.INVALID,"can not get token");a=g;case 4:if(a.ip){if(!xnm.aio.somfylocal.Utils._isIP(a.ip))throw new e.Error("invalid ip");l.jumpTo(6);break}return l.yield(d.getIP(2E4),7);case 7:f=l.yieldResult,a.ip=f;case 6:return h=new xnm.aio.somfylocal.Box(a),l.yield(h.isReachable(),8);case 8:if(!l.yieldResult)return c(new e.Error(e.ErrorCodes.NOT_FOUND,
"gateway is not reachable")),l.return();e.Logger.log("debug","gateway is created for "+a.pod);c(null,a);l.leaveTryBlock(0);break;case 2:k=l.enterCatchBlock(),e._handleError(k,c),l.jumpToEnd()}})},updateGateway:function(a,b,c,e){var d=this,g,f,h,k,l,n,p;return $jscomp.asyncExecutePromiseGeneratorProgram(function(m){switch(m.nextAddress){case 1:m.setCatchFinallyBlocks(2);d._validateBoxInfo(b);g=new xnm.aio.somfylocal.TokenManager(b);if(a.username!=b.username||a.password!=b.password){m.jumpTo(4);break}return m.yield(g.isValid(),
5);case 5:f=m.yieldResult;if("invalid"!=f){m.jumpTo(6);break}return m.yield(d._updateTokenAndIP(b,g),6);case 6:if(b.ip){if(!xnm.aio.somfylocal.Utils._isIP(b.ip))throw new d.Error("invalid ip");m.jumpTo(8);break}return m.yield(g.getIP(2E4),9);case 9:h=m.yieldResult,b.ip=h;case 8:if(!b.tokenLabel||b.expirationTime){m.jumpTo(10);break}return m.yield(g.getTokenInfo(),11);case 11:k=m.yieldResult,b.expirationTime=k&&k.expirationTime?k.expirationTime:Date.now()+145152E5;case 10:return d.Logger.log("debug",
"gateway is updated for "+b.pod+" with the same email and pass"),l=new xnm.aio.somfylocal.Box(b),m.yield(l.isReachable(),12);case 12:if(!m.yieldResult)return e(new d.Error(d.ErrorCodes.NOT_FOUND,"gateway is not reachable")),m.return();e(null,b);return m.return();case 4:if(a.pod!=b.pod)throw new d.Error(d.ErrorCodes.INVALID,"pod should not be changed");return m.yield(d._updateTokenAndIP(b,g),13);case 13:return d.Logger.log("debug","gateway is updated for "+b.pod),n=new xnm.aio.somfylocal.Box(b),m.yield(n.isReachable(),
14);case 14:if(!m.yieldResult)return e(new d.Error(d.ErrorCodes.NOT_FOUND,"gateway is not reachable")),m.return();e(null,b);m.leaveTryBlock(0);break;case 2:p=m.enterCatchBlock(),d._handleError(p,e),m.jumpToEnd()}})},_updateTokenAndIP:function(a,b){var c=this,e,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){if(1==g.nextAddress)return g.yield(b.getValidBoxInfo(),2);if(3!=g.nextAddress){e=g.yieldResult;if(!e)throw new c.Error(c.ErrorCodes.INVALID,"can not get token during updating the info");
a=e;c.Logger.log("debug","token of "+a.pod+" is updated");return g.yield(b.getIP(2E4),3)}d=g.yieldResult;a.ip=d;g.jumpToEnd()})},deleteGateway:function(a,b,c){var e=this,d,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return f.setCatchFinallyBlocks(2),d=new xnm.aio.somfylocal.TokenManager(a),f.yield(d.deleteToken(),4);if(2!=f.nextAddress)return c(),f.leaveTryBlock(0);g=f.enterCatchBlock();e.Logger.log("error",g);c();f.jumpToEnd()})},createDevice:function(a,b,
c){c(null,a)},updateDevice:function(a,b,c){c(null,a)},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,e=function(k,l){if("*"==k)return!0;for(var n=!1,p=0;p<k.length;p++)if(k[p]==l){n=!0;break}return n},d=function(k,l,n){var p=[];switch(n.catagory){case "command":k.command&&k.command.forEach(function(m){e(n.elems,m.type)&&(m=JSON.parse(JSON.stringify(m)),p.push(m))});break;case "status":k.status&&k.status.forEach(function(m){e(n.elems,m.type)&&(m=JSON.parse(JSON.stringify(m)),
p.push(m))})}return p},g=function(k,l){var n=[],p=c.getCommandStatusMap(k);p&&(k=d(p,k,l),n=n.concat(k));return n};if(!a||null==a.type||"undefined"==typeof a.type)return null;var f=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=g(a,b);f.command=h;break;case "status":h=g(a,b);f.status=h;break;default:return null}return h&&h.length?f:null},getCommandStatusMap:function(a){try{if(!a||!a.device||!a.device.definition)return this.Logger.log("error","anomaly, invalid device "+JSON.stringify(a)),
null;var b={command:[],status:[]},c=a.device.definition,e=xnm.aio.somfylocal.Devices;switch(c.uiClass){case "Awning":case "ExteriorScreen":case "Pergola":case "Screen":case "Shutter":case "SwingingShutter":case "Window":c.uiClass="RollerShutter";break;case "Gate":c.uiClass="GarageDoor"}var d=e[c.uiClass];d&&this._insertCommandsAndStatuses(c,d,b);if(c.widgetName){var g=d[c.widgetName];g&&this._insertCommandsAndStatuses(c,g,b)}return b}catch(f){return this.Logger.log("error",f.stack?f.stack:f),null}},
_insertCommandsAndStatuses:function(a,b,c){function e(g){a.states.find(function(f){return f.name==g.ref.value})&&(c.status.find(function(f){return f.name==g.name})||c.status.push(g));g.ref.somfy_values&&Array.isArray(g.ref.somfy_values)&&g.ref.somfy_values.forEach(function(f){if(a.states.find(function(k){return k.name==f})&&!c.status.find(function(k){return k.name==g.name})){var h=JSON.parse(JSON.stringify(g));h.ref.value=f;c.status.push(h)}})}function d(g){a.commands.find(function(f){return f.commandName==
g.ref.value})&&(c.command.find(function(f){return f.name==g.name})||c.command.push(g));"toggle"==g.ref.value&&a.states.find(function(f){return"core:OnOffState"==f.name})&&c.command.push(g)}a.commands&&0<a.commands.length&&b.commands.forEach(function(g){d(g)});a.states&&0<a.states.length&&b.statuses.forEach(function(g){e(g)})},_validateBoxInfo:function(a){if(!a)throw new this.Error(this.ErrorCodes.INVALID,"info is invalid");if(!a.username)throw new this.Error(this.ErrorCodes.INVALID,"username is invalid");
if(!a.password)throw new this.Error(this.ErrorCodes.INVALID,"password is invalid");if(!a.pod)throw new this.Error(this.ErrorCodes.INVALID,"pod is invalid");a.pod=a.pod.trim()},_handleError:function(a,b){console&&console.log&&console.log(a);a.code?b(a,null):b(new this.Error(this.ErrorCodes.UNKNOWN,a.message?a.message:"unknown error"),null)},supportSmartWidget:function(a){return a&&a.type&&"not-supported"!==a.type?!0:!1},applySmartWidgetFilter:function(a,b,c,e,d){if(!b||!b.type||"not-supported"===b.type)return null;
c=this.getCommandStatusMap(b);if(!c)return null;var g={},f={},h=[b.type];"blind"===b.type?h.push("shutter"):"heating"===b.type?h.push("thermostat"):"light"===b.type&&h.push("dimmer","switch");var k={blind:{down:"moveDown",position:"moveTo",up:"moveUp"},heating:{auto:"thermoAuto"},light:{brightness:"dimTo"},switch:{"on for":"onFor"}},l={blind:{position:"blindState"},switch:{state:"switchState"}};c.command.forEach(function(n){var p,m=(null==(p=k[b.type])?void 0:p[n.name])||n.name;g["%"+m+"%"]=n.ref;
"light"===b.type&&("on"===m?g["%dimOn%"]=n.ref:"off"===m&&(g["%dimOff%"]=n.ref))});c.status.forEach(function(n){var p,m=(null==(p=l[b.type])?void 0:p[n.name])||n.name;f["%"+m+"%"]=n.ref;"blindState"===m&&(f["%shutterState%"]=n.ref)});return a._injectToSmartWidgetTemplate(e,h,d,g,f,null)}};
var __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3=function(){this.TokenManager=xnm.aio.somfylocal.TokenManager;this.Box=xnm.aio.somfylocal.Box;this.devicemanager=xnm.aio.somfylocal.DM;this.Utils=xnm.aio.somfylocal.Utils;this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.Handler")};__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"somfylocal")};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3.prototype.resolveGateway=function(a){return a&&a.username&&a.password&&a.pod&&a.token&&a.ip?new this.Box(a):(a=JSON.parse(JSON.stringify(a)),a.username=a.username&&"*****",a.password=a.password&&"*****",a.token=a.token&&"*****",this._logger.log("warn","cannot resolve gateway, return null due to invalid gateway json "+JSON.stringify(a)),null)};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3.prototype.getDeviceList=function(a,b){var c=this;(a=this.resolveGateway(a))?a.listDevices().then(function(e){b&&b(null,e)}).catch(function(e){c._logger.log("error",e.stack?e.stack:e);b&&b(e,null)}):b&&b(Error("gateway json format invalid"))};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3.prototype.discoverWithTimeout=function(a,b){var c=this,e=require("x.mdns.js");e.clearRecordBuffer();var d=[];e.discoverServiceWithTimeout("_kizboxdev._tcp.local",a,function(g,f){if(g)b(g);else{try{c._logger.log("debug","results of mdns : "+JSON.stringify(f))}catch(n){}for(g=0;g<f.length;g++){var h=f[g],k="",l="";h.ip&&0<h.ip.length&&xnm.aio.somfylocal.Utils._isIP(h.ip[0])&&(k=h.ip[0]);h.info&&h.info.gateway_pin&&(l=h.info.gateway_pin);
k&&l&&d.push({sys:"somfylocal",ip:k,port:8443,pod:l,discovery:!0,name:"pod "+l.slice(-4)})}e.stopDiscover("_kizboxdev._tcp.local",function(n){c._logger.log("error",n)});b(null,d)}})};xnm.aio.somfylocal.Handler=__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var3;xnm.aio.somfylocal.Utils={_isIP:function(a){return/^(?!0)(?!.*\.$)((1?\d?\d|25[0-5]|2[0-4]\d)(\.|$)){4}$/.test(a)}};
var __$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4=function(a,b,c,e){this.port=443;this.REQUESTS_TIMEOUT_MS=1E4;this.rejectUnauthorized=!1;this.host=a;b&&"number"==typeof b&&(this.REQUESTS_TIMEOUT_MS=b);void 0!=c&&"boolean"==typeof c&&(this.rejectUnauthorized=c);e&&"number"==typeof e&&(this.port=e);this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.httpClient");!this._logger&&console&&console.log&&(this._logger=console)};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype.get=function(a,b,c){var e=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return d.return(new Promise(function(g,f){e._doRequest("GET",a,b,c,function(h,k){h&&f(h);g(k)})}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype.post=function(a,b,c){var e=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return d.return(new Promise(function(g,f){e._doRequest("POST",a,b,c,function(h,k){h&&f(h);g(k)})}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype.put=function(a,b,c){var e=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return d.return(new Promise(function(g,f){e._doRequest("PUT",a,b,c,function(h,k){h&&f(h);g(k)})}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype.patch=function(a,b,c){var e=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return d.return(new Promise(function(g,f){e._doRequest("PATCH",a,b,c,function(h,k){h&&f(h);g(k)})}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype.delete=function(a,b,c){var e=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return d.return(new Promise(function(g,f){e._doRequest("DELETE",a,b,c,function(h,k){h&&f(h);g(k)})}))})};
__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4.prototype._doRequest=function(a,b,c,e,d){a={host:this.host,port:this.port,path:b,method:a,family:4,timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json","User-Agent":"Mediola"},rejectUnauthorized:this.rejectUnauthorized};if(c)for(var g in c)c.hasOwnProperty(g)&&(a.headers[g]=c[g]);e&&e.length&&(a.headers["Content-Length"]=e.length);this._logger.log("debug","call on "+b+" with "+JSON.stringify(a));
b=require("https");var f=this,h=d,k=b.request(a,function(l){l.setEncoding("utf-8");var n="";l.on("data",function(p){n+=p});l.on("end",function(){f._logger.log("debug","receive code:"+l.statusCode+" response:"+n);try{n=JSON.parse(n),l.body=n}catch(p){l.body=p.message}h&&(h(null,l),h=null)})});if(k.on)k.on("error",function(l){f._logger.log("error","do request error:"+l.message);h&&(h(l),h=null)});k.setTimeout&&k.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){f._logger.log("error","do request timeout");
k.abort();h&&(h(Error("timeout")),h=null)});e&&k.write(e);k.end()};xnm.aio.somfylocal.httpClient=__$__$node_modules$node_modules$xnm_aio_somfylocal$classdecl$var4;
xnm.aio.somfylocal.Devices={OnOff:{commands:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",unit:"s",extMeta:"60-600",value_t:"on_for"}}],statuses:[{type:"enum",name:"state",ref:{value:"core:OnOffState",value_t:"state",options:["on","off"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},RollerShutter:{commands:[{type:"enum",
name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"int",name:"position",ref:{value:"setClosure",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"enum",name:"identify",ref:{value:"identify"}}],
statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},AirSensor:{commands:[],statuses:[{type:"int",name:"co2",ref:{value:"core:CO2ConcentrationState",value_t:"co2"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},ContactSensor:{commands:[],
statuses:[{type:"int",name:"state",ref:{value:"core:ContactState",value_t:"state",options:["closed","open","tilt"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},DoorLock:{commands:[{type:"enum",name:"lock",ref:{value:"setLockedUnlocked",value_t:"lock",ext:"locked"}},{type:"enum",name:"unlock",ref:{value:"setLockedUnlocked",value_t:"unlock",ext:"unlocked"}}],statuses:[{type:"int",name:"state",ref:{value:"core:LockedUnlockedState",value_t:"state"}},{type:"enum",
name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},GarageDoor:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}}],statuses:[{type:"int",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",somfy_values:["core:OpenClosedPedestrianState","core:OpenClosedUnknownState","core:OpenClosedPartialState"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},HeatingSystem:{commands:[{type:"enum",
name:"auto",ref:{value:"auto"}},{type:"enum",name:"heat",ref:{value:"heat"}},{type:"enum",name:"cool",ref:{value:"cool"}},{type:"enum",name:"off",ref:{value:"off"}}],statuses:[{type:"int",name:"temperature",ref:{value:"core:TemperatureState",value_t:"temperature",somfy_values:["core:TargetTemperatureState"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},HumiditySensor:{commands:[],statuses:[{type:"int",name:"humidity",ref:{value:"core:RelativeHumidityState",
value_t:"humidity"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},Light:{commands:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",unit:"s",extMeta:"60-600",value_t:"on_for"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"int",name:"brightness",ref:{value:"setIntensity",ext:"%d",unit:"%",extMeta:"0-100",value_t:"brightness"}}],
statuses:[{type:"enum",name:"state",ref:{value:"core:OnOffState",value_t:"state",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"core:IntensityState",value_t:"brightness",somfy_values:["core:LightIntensityState"]}},{type:"enum",name:"hue",ref:{value:"core:ColorHueState",value_t:"hue"}},{type:"int",name:"saturation",ref:{value:"core:ColorSaturationState",value_t:"saturation"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},LightSensor:{commands:[],
statuses:[{type:"int",name:"lightLevel",ref:{value:"core:LuminanceState",value_t:"lightLevel"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},OccupancySensor:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:OccupancyState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},RainSensor:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:RainState",value_t:"state"}},{type:"enum",
name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},Siren:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:OnOffState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},SmokeSensor:{commands:[],statuses:[{type:"int",name:"smoke",ref:{value:"core:SmokeState",value_t:"smoke"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},TemperatureSensor:{commands:[],statuses:[{type:"int",
name:"temperature",ref:{value:"core:TemperatureState",value_t:"temperature"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},VenetianBlind:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",
ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}}],statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"int",name:"angle",ref:{value:"core:SlateOrientationState",value_t:"angle"}},{type:"enum",name:"movement",ref:{value:"core:MovingState",options:["true","false"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},
VentilationSystem:{commands:[{type:"enum",name:"mode",ref:{value:"setAirDemandMode",value_t:"mode",options:["auto","boost"]}}],statuses:[{type:"int",name:"mode",ref:{value:"io:AirDemandModeState",value_t:"mode"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},ExteriorVenetianBlind:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},
{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"int",name:"angle",ref:{value:"setOrientation",ext:"%d",value_t:"angle"}}],statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"int",name:"angle",ref:{value:"core:SlateOrientationState",
value_t:"angle"}},{type:"enum",name:"movement",ref:{value:"core:MovingState",options:["true","false"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]}};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.somfylocal.Handler);
