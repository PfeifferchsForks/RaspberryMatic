var x=x||{};x.hub=x.hub||{};x.hub.macroman=x.hub.macroman||{};
x.hub.macroman.MacroManager=function(d,f){d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.macroman.MacroManager");this._handler=this._tenant=null;this._folder=a;this._folder||(this._folder="db");this._tenantIdx=b;this._tenantIdx||(this._tenantIdx=1)};d.prototype.init=function(a,b){this._logger.log("info","init macro managaer:"+this._folder);var c=require("m.aio.configmanager.js"),e=require("m.aio.macromanager.js");a=this._generateTenantParent(a);this._tenant=new c.Tenant(a);this._tenant.index=
this._tenantIdx;this._tenant.license="dummy";this._tenant.folder=this._folder;this._handler=new e.Handler(this._tenant);var g=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){g._load(b)})};d.prototype.execute=function(a,b,c,e,g){this._handler.execute(a,b,c,e,g)};d.prototype.reload=function(a){this._load(a)};d.prototype._load=function(a){var b=this;this._handler._loadMacros(function(c){c&&b._logger.log("warn","init macro error:"+c.message);a&&a(c)})};d.prototype._generateTenantParent=
function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};d.prototype.findMacro=function(a,b,c){this._handler.findMacro(a,b,c)};d.prototype.findMacroIdx=function(a,b,c){this._handler.findMacroIdx(a,b,c)};return d}();x.hub.macroman.Handler=function(){this.macroManager=new x.hub.macroman.MacroManager("db",1);this.macroManager2=new x.hub.macroman.MacroManager("db2",2)};x.hub.macroman.Handler.prototype.MacroManager=x.hub.macroman.MacroManager;
x.hub.macroman.Handler.prototype.init=function(d,f,a){"CA"==global.HARDWARE_VERSION?this._configNew(d):this._config(d);var b=this;this.macroManager.init(f,function(){b.macroManager2.init(f,a)})};
x.hub.macroman.Handler.prototype._configNew=function(d){var f=this;require("x.hub.js").getServer().addRoute("/xhub/macromanager/",function(a,b){var c=a.method.toLowerCase();a.path.substr(19);var e=a.url,g=e.indexOf("?");-1!=g&&(e=e.substr(0,g));g=a.query;a=a.body;var h=null;switch(c){case "get":h="read";break;case "post":h="create";break;case "put":h="update";break;case "delete":h="delete"}h?f.macroManager.execute(h,e,g,a,function(l,k){l?b.send(this.error2json(l)):k.toJSON&&"function"==typeof k.toJSON?
b.send(k.toJSON()):b.send(k)}.bind(this)):(c=Error("invalid http method"),c.code=500,b.send(this.error2json(c)))}.bind(this))};
x.hub.macroman.Handler.prototype._config=function(d){var f=this;d.use("/xhub/macromanager/:tenantIdx",function(a,b){var c=a.method.toLowerCase(),e=a.url,g=e.indexOf("?");-1!=g&&(e=e.substr(0,g));g=a.query;a=a.body;var h=null;switch(c){case "get":h="read";break;case "post":h="create";break;case "put":h="update";break;case "delete":h="delete"}h?f.macroManager.execute(h,e,g,a,function(l,k){l?b.send(this.error2json(l)):k.toJSON&&"function"==typeof k.toJSON?b.send(k.toJSON()):b.send(k)}.bind(this)):(c=
Error("invalid http method"),c.code=500,b.send(this.error2json(c)))}.bind(this))};x.hub.macroman.Handler.prototype.execute=function(d,f,a,b){this.macroManager.findMacro(d,f,function(c,e){c?a&&a({error:c}):require("x.hub.commandman.js").commandHandler.executeMacro(e,function(g){a&&a(g)},b)})};x.hub.macroman.Handler.prototype.cancel=function(d,f){require("x.hub.commandman.js").commandHandler.cancelMacro(d,function(a){f&&f(a)})};
x.hub.macroman.Handler.prototype.executeWithIdx=function(d,f,a){this.macroManager.findMacroIdx(d,f,function(b,c){b?a&&a({error:b}):require("x.hub.commandman.js").commandHandler.executeMacro(c,function(e){a&&a(e)})})};x.hub.macroman.Handler.prototype.execute2=function(d,f,a){this.macroManager2.findMacro(d,f,function(b,c){b?a&&a({error:b}):require("x.hub.commandman.js").commandHandler2.executeMacro(c,function(e){a&&a(e)})})};
x.hub.macroman.Handler.prototype.executeWithIdx2=function(d,f,a){this.macroManager2.findMacroIdx(d,f,function(b,c){b?a&&a({error:b}):require("x.hub.commandman.js").commandHandler2.executeMacro(c,function(e){a&&a(e)})})};module.exports=new x.hub.macroman.Handler;
