var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.cams=x.hub.m.cams||{};x.hub.m.cams.CAMS_MODULE=require("xnm.aio.cams.js");
x.hub.m.cams.DoorBirdMonitor=function(){var e=function(a,b){this._id=this._gentId(a);this._logger=require("x.logger.js").getLogger("x.hub.m.cams.DoorBirdMonitor.["+this._id+"]");this._handler=b;this._doorbird=a;this._metaInfos=[];this._running=!1;this._monitor=null;this._stateBuffer={}};e.prototype._gentId=function(a){return a.username+"@"+a.ip};e.prototype.start=function(){this._logger.log("debug","start monitor");if(!this._running){this._running=!0;var a=this._handler.getDoorBirdHandler().addMonitor(this._doorbird);
a.addListener(this);this._monitor=a}};e.prototype.stop=function(a){this._logger.log("debug","stop monitor");this._running?0<this._metaInfos.length?a&&a(null,!1):(this._running=!1,this._monitor.removeListener(this),this._handler.getDoorBirdHandler().removeMonitor(this._doorbird),a&&a(null,!0)):a&&a(null,!0)};e.prototype.addMetaInfo=function(a){for(var b=0;b<this._metaInfos.length;b++){var c=this._metaInfos[b];if(c&&c.callback&&c.callback===a.callback)return}this._metaInfos.push(a)};e.prototype.removeMetaInfo=
function(a){for(var b=-1,c=0;c<this._metaInfos.length;c++){var d=this._metaInfos[c];if(d&&d.callback&&d.callback===a.callback){b=c;break}}-1!=b&&this._metaInfos.splice(b,1)};e.prototype.updateDoorbird=function(a){if(this._doorbirdJSON&&this._doorbirdJSON.mac&&this._doorbirdJSON.mac==a.mac&&this._doorbirdJSON.ip!=a.ip){this._logger.log("debug","doorbird has new ip:"+a.ip);this._doorbirdJSON.ip=a.ip;var b=this._gentId(this._doorbirdJSON.ip);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Monitor.["+
b+"]");this._monitor&&this._monitor.updateDoorbird(a)}};e.prototype.onEvent=function(a,b){var c=(new Date).getTime(),d=this._stateBuffer[a],f=!1,g=null;d?(g=d[0],d=d[1],b!=g?f=!0:1==b&&3E3<c-d&&(f=!0)):f=!0;this._stateBuffer[a]=[b,c];this._logger.log("debug","event:"+a+"="+b+"("+(f?"changed":"not changed")+")");f&&this._invokeCallback({module:"cams",device:this._doorbird,data:{key:a,value:b,oldvalue:g,changed:!0}})};e.prototype._invokeCallback=function(a){for(var b=a.data.key,c=0;c<this._metaInfos.length;c++){var d=
this._metaInfos[c];if(d&&d.statusKey==b&&d.callback&&d.callback.onEvent)try{d.callback.onEvent(a)}catch(f){}}};return e}();
x.hub.m.cams.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.cams.Handler");this._doorBirdMonitors={};this._doorBirdHandler=x.hub.m.cams.CAMS_MODULE.getDoorBirdHandler();this._searchTo=null;this._searchPeriod=3E5};util.inherits(e,EventEmitter);e.prototype.init=function(a){this._startPeriodicalSearch();this._doorBirdHandler.startUdpMonitor();a&&a()};e.prototype.getSystems=function(){return["cam"]};e.prototype.addStateDevice=function(a,b,c){!a||"system"!=a.type||
"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._startDoorBirdMonitor(a,function(d){b&&b({error:d})},c)};e.prototype.removeStateDevice=function(a,b,c){!a||"system"!=a.type||"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._stopDoorBirdMonitor(a,function(d){b&&b({error:d})},c)};e.prototype.getAllStates=function(){return[]};e.prototype.getStates=function(a){return null};
e.prototype.getState=function(a,b,c){require("x.hub.commandman.js").commandHandler.getStateLegacy(a,null,{value:b},c)};e.prototype.executeCommand=function(a,b,c){require("x.hub.commandman.js").commandHandler.executeCommandLegacy(a,null,b,c)};e.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.device.manufacturer==a.device.manufacturer&&b.device.model==a.device.model?b.device.ip==a.device.ip:!1};e.prototype.getDoorBirdHandler=function(){return this._doorBirdHandler};e.prototype._startDoorBirdMonitor=
function(a,b,c){if(a&&a.ip&&a.username){var d=a.username;this._doorBirdMonitors[d]?(c&&c.callback&&this._doorBirdMonitors[d].addMetaInfo(c),b&&b(null,this._doorBirdMonitors[d])):x.hub.m.cams.CAMS_MODULE.resolveDevice(a)?(a=JSON.parse(JSON.stringify(a)),a=new x.hub.m.cams.DoorBirdMonitor(a,this),this._doorBirdMonitors[d]=a,c&&c.callback&&a.addMetaInfo(c),a.start(),b&&b(null,a)):b&&b(Error("doorbird json format invalid"))}else b&&b(Error("doorbird json format invalid"))};e.prototype._stopDoorBirdMonitor=
function(a,b,c){if(a&&a.ip&&a.username){var d=this,f=a.username;(a=this._doorBirdMonitors[f])?(c&&c.callback&&a.removeMetaInfo(c),a.stop(function(g,h){!g&&h&&delete d._doorBirdMonitors[f];b&&b(g,h)})):b&&b()}else b&&b(Error("doorbird json format invalid"))};e.prototype._startPeriodicalSearch=function(){var a=this,b=function(d){for(var f=0;f<d.length;f++){var g=d[f];if(g._options){a._logger.log("trace","find doorbird:"+JSON.stringify(g._options));for(var h in a._doorBirdMonitors)a._doorBirdMonitors[h].updateDoorbird(g._options)}}},
c=function(){a._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5E3,function(d,f){!d&&f&&b(f);c()})},a._searchPeriod)};this._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5E3,function(d,f){!d&&f&&b(f);c()})},1E4)};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.cams.Handler);
