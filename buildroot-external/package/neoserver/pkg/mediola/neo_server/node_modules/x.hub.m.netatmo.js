var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.netatmo=x.hub.m.netatmo||{};x.hub.m.netatmo.MODULE=require("xnm.aio.netatmo.js");
x.hub.m.netatmo.Monitor=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.netatmo.Monitor.["+a.refreshToken.substr("6")+"...]");this._running=!1;this._gateway=a;this._devices={};this._status={}};e.prototype.start=function(a){this._logger.log("debug","start monitor");this._running||(this._running=!0,this._getAllStatus());a&&a()};e.prototype.addStateDevice=function(a,b){if(a){switch(a.type){case "NAMain":case "NHC":case "NAPlug":case "room":case "home":var c=a.address;
break;default:c=a.module}c&&(this._devices[c]=a)}b&&b()};e.prototype._getAllStatus=function(){var a=this;this._logger.log("trace","get all status");this._gateway.getAllStatus(function(b,c){b?a._logger.log("trace","get all status error:"+b.message):c&&(a._logger.log("trace","get all status response:"+JSON.stringify(c)),a._receiveStatus(c));a._running&&setTimeout(function(){a._getAllStatus()},1E4)})};e.prototype._receiveStatus=function(a){a=JSON.parse(JSON.stringify(a));for(var b in a){var c=a[b],d=
this._status[b];if(c&&d&&this._devices[b])for(var f in c){var g=c[f],h=d[f];"undefined"!=typeof h&&null!=h&&"undefined"!=typeof g&&null!=g&&h!=g&&this._produceEvent(this._devices[b],f,h,g)}}this._status=a};e.prototype._produceEvent=function(a,b,c,d){try{this._logger.log("debug","state ["+b+"] changed from '"+c+"' to '"+d+"' for device:"+JSON.stringify(a));var f=require("x.hub.eventbus.js");b={key:b,value:d,oldvalue:c,changed:!0};f.emit("status",{module:"netatmo",device:a,gateway:this._gateway.toJSON(),
data:b})}catch(g){}};return e}();
x.hub.m.netatmo.Handler=function(){var e=function(){this._clouds={};this._monitors={}};e.prototype.init=function(a){a&&a()};e.prototype.getSystems=function(){return["netatmo"]};e.prototype.addStateDevice=function(a,b){a&&a.gateway?this._startMonitor(a.gateway,function(c,d){c?b&&b({error:c}):(a=JSON.parse(JSON.stringify(a)),delete a.gateway,d.addStateDevice(a,function(f){b&&b({error:f})}))}):b&&b({error:Error("gateway is null")})};e.prototype.getState=function(a,b,c){if(a&&a.gateway){var d=x.hub.m.netatmo.MODULE.resolveGateway(a.gateway);
if(d){var f=d.refreshToken;this._clouds[f]||(this._clouds[f]=d);d=this._clouds[f];a=JSON.parse(JSON.stringify(a));delete a.gateway;d.getStatesCreator(null,[{id:"xhub",device:a,status:{value:b}}],function(g,h){var k=null;h&&h[0]&&(k=h[0].status);c&&c({error:g,data:{value:k}})})}else c&&c({error:Error("gateway invalid")})}else c&&c({error:Error("gateway is null")})};e.prototype.executeCommand=function(a,b,c){if(a&&a.gateway){var d=x.hub.m.netatmo.MODULE.resolveGateway(a.gateway);if(d){var f=d.refreshToken;
this._clouds[f]||(this._clouds[f]=d);d=this._clouds[f];a=JSON.parse(JSON.stringify(a));delete a.gateway;d.executeCommandCreator(a,b,function(g){c&&c({error:g})})}else c&&c({error:Error("gateway invalid")})}else c&&c({error:Error("gateway is null")})};e.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.device.type==a.device.type?"NAMain"==b.device.type||"NHC"==b.device.type||"NAPlug"==b.device.type||"room"==b.device.type||"home"==b.device.type?b.device.address==a.device.address:
b.device.module==a.device.module:!1};e.prototype._startMonitor=function(a,b){if(a&&a.refreshToken){var c=x.hub.m.netatmo.MODULE.resolveGateway(a);c?(a=c.refreshToken,this._clouds[a]||(this._clouds[a]=c),c=this._clouds[a],this._monitors[a]?b&&b(null,this._monitors[a]):(c=new x.hub.m.netatmo.Monitor(c),this._monitors[a]=c,c.start(),b&&b(null,c))):b&&b({error:Error("gateway invalid")})}else b&&b(Error("gateway format invalid"))};return e}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.netatmo.Handler);
