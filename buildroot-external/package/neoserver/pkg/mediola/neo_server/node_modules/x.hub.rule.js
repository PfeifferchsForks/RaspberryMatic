var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var D={getMomentNow:function(){var a=taskman.Util._getTimeZone(),b=(new Date).getTime();a=moment.tz(b,a);a.second(0);a.millisecond(0);return a},getAstro:function(a){var b=taskman.Util._getlatlong(),c=require("suncalc"),d=c.getTimes(a.toDate(),b.lat,b.long),e=taskman.Util._getTimeZone(),g=moment.tz(d.sunrise,e);d=moment.tz(d.sunset,e);if(g.date()!=a.date()||d.date()!=a.date())a.add(12,"h"),d=c.getTimes(a.toDate(),b.lat,b.long),g=moment.tz(d.sunrise,e),d=moment.tz(d.sunset,
e);g.second(0);g.millisecond(0);d.second(0);d.millisecond(0);return[g,d]},matchDate:function(a,b){if(!a)throw Error("invalid momentNow argument");if(!b)return!0;var c=a.tz(),d=a.valueOf();if(b.start&&"0000-00-00"!=b.start){var e=moment.tz(b.start,c);e.set({hour:0,minute:0,second:0,millisecond:0});if(e.valueOf()>d)return!1}return b.end&&"0000-00-00"!=b.end&&(c=moment.tz(b.end,c),c.set({hour:23,minute:59,second:59,millisecond:999}),c.valueOf()<d)||b.days&&(a=a.day(),0==a&&(a=7),"1"!=b.days.charAt(a-
1))?!1:!0},calculateAstroTarget:function(a,b,c,d){if(!(a&&b&&c&&d))return null;var e=null;if("sunrise"==d.substr(0,7)){if(e=b,"+"==d.charAt(7)||"-"==d.charAt(7))b=parseInt(d.substr(7)),e.add(b,"minutes")}else"sunset"==d.substr(0,6)&&(e=c,"+"==d.charAt(6)||"-"==d.charAt(6))&&(b=parseInt(d.substr(6)),e.add(b,"minutes"));if(!e)return null;b=moment(a);b.hour(0);b.minute(0);b.second(0);b.millisecond(0);a=moment(a);a.hour(23);a.minute(59);a.second(59);a.millisecond(999);e.isBefore(b)?e=b:e.isAfter(a)&&
(e=a);return e},calculateTimeTarget:function(a,b){if(!a||!b)return null;var c=b.split(":");if(2!=c.length)return null;b=parseInt(c[0]);c=parseInt(c[1]);if(isNaN(b)||isNaN(c)||0>b||23<b||0>c||59<c)return null;a=moment(a);a.hour(b);a.minute(c);a.second(0);a.millisecond(0);return a}},y=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};y.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace",
"start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};y.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};y.prototype.onTick=function(){this._logger.log("trace","timer tick");var a=D.getMomentNow(),b=D.getAstro(a);this._ruleManager.onTimerTick(a,b[0],b[1])};y.prototype.onLocationChange=function(){this.stop();this.start()};
y.prototype.onTimeChange=function(){this.stop();this.start()};var n=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+a);this._id=a;this._ruleManager=this._json=null;this._state=0;this._activateCallbacks=[];this._pendingTriggers={};this._delayedTriggers=[]};n.prototype.finalize=function(){for(var a in this._pendingTriggers){var b=this._pendingTriggers[a];b&&clearTimeout(b)}for(a=0;a<this._delayedTriggers.length;a++)(b=this._delayedTriggers[a])&&b.timeout&&clearTimeout(b.timeout);
this._pendingTriggers={};this._delayedTriggers=[]};n.prototype.executeCommand=function(a,b){a&&a.command?"activate"==a.command?this.setActive(!0,function(c){b&&b(c)}):"deactivate"==a.command?this.setActive(!1,function(c){b&&b(c)}):"execute"==a.command?this.doActions(function(c){b&&b(c)}):b&&b(Error("invalid command")):b&&b(Error("invalid command"))};n.prototype.getStates=function(a){a&&a(null,{active:this.isActive()})};n.prototype.isActive=function(){return this._json&&1==this._json.active};n.prototype.setActive=
function(a,b){if(this._json){var c=this.isActive();if(c&&a||!c&&!a)b&&b();else if(1!=this._state||a)if(2==this._state&&a)b&&b(Error("deactivate process is rinning"));else{if(b&&-1==this._activateCallbacks.indexOf(b)&&this._activateCallbacks.push(b),0==this._state){var d=this;this._state=a?1:2;this[a?"_doActivate":"_doDeactivate"](function(e){d._state=0;var g=d._activateCallbacks;d._activateCallbacks=[];g.forEach(function(k){try{k&&k(e)}catch(f){}})})}}else b&&b(Error("activate process is rinning"))}else b&&
b(Error("invalid rule"))};n.prototype._doActivate=function(a){this._json.active=1;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};n.prototype._doDeactivate=function(a){this._json.active=0;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};n.prototype.matchTimeRequirement=function(a){return this._json?D.matchDate(a,this._json):!1};n.prototype.getType=function(){return this._json?this._json.type:null};n.prototype.doActions=function(a){if(this._json)if(this._json.actions&&
this._json.actions.length){this._logger.log("trace","do actions");var b=this,c=actman.getActionManager(),d="executeAction";1==this._json.restart&&(d="executeActionSingelton");c[d]("rle:"+this._id,this._json.actions,function(e){b._logger.log("trace","finish do actions "+(e?"failed:"+e.message:"success"));a&&a(e)})}else a&&a();else a&&a(Error("invalid rule"))};n.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by trigger with index ["+a+"]");this.doActions()};n.prototype.onDeviceEvent=
function(a,b){if(this._json){var c=this.isActive();b=this.matchTimeRequirement(b);this._logger.log("trace","active:"+c+" | date match:"+b+" | check device event:"+JSON.stringify(a));if(c&&b){var d=this._json;if(d.trigger&&d.trigger.length){var e=this,g=0,k=[],f=function(p,l,h){!p&&l?d.trigger[g].delay?e._addDelayedTrigger(g):d.trigger[g].dur?e._addPendingTrigger(g):k.push(g):p||l||!h||d.trigger[g].dur&&e._removePendingTrigger(g);g++;if(g<d.trigger.length)e._hitDeviceTrigger(g,d.trigger[g],a,f);else if(k.length)e.onTriggered(k[0],
d.trigger[k[0]]);else e._logger.log("trace","no trigger hit")};this._hitDeviceTrigger(g,d.trigger[g],a,f)}}}};n.prototype._addDelayedTrigger=function(a){var b=this._json.trigger[a],c=this,d={triggerIdx:a,timeout:setTimeout(function(){var e=c._delayedTriggers.indexOf(d);-1!=e&&c._delayedTriggers.splice(e,1);c.onTriggered(d.triggerIdx,b)},1E3*parseFloat(b.delay))};this._delayedTriggers.push(d)};n.prototype._addPendingTrigger=function(a){var b=this._json.trigger[a];if(!this._pendingTriggers[a]){var c=
this;this._pendingTriggers[a]=setTimeout(function(){delete c._pendingTriggers[a];c.onTriggered(a,b)},1E3*parseFloat(b.dur))}};n.prototype._removePendingTrigger=function(a){if(this._pendingTriggers[a]){var b=this._pendingTriggers[a];b&&clearTimeout(b);delete this._pendingTriggers[a]}};n.prototype.onTimerTick=function(a,b,c){if(this._json){var d=this.isActive(),e=this.matchTimeRequirement(a);if(d&&e){var g=this._json;if(g.trigger&&g.trigger.length)for(var k=0;k<g.trigger.length;k++){var f=g.trigger[k];
if(this._hitTimeTrigger(f,a,b,c)){this._logger.log("trace","active:"+d+" | date match:"+e+" | time trigger hit");this.onTriggered(k,f);break}}}}};n.prototype.toJSON=function(){return this._json};n.prototype._hitDeviceTrigger=function(a,b,c,d){var e=this,g=!1,k=function(f){var p=f;18<f.length&&(f.substr(4,2),p=f.substr(18+8*parseInt(f.substr(16,2),16)));return p};a=function(f,p){if(!f)return!1;var l=p.type,h=p.value;if("event"==l){if(!f.event)return!1;h.sys||(h.sys="mediola");return f.event.sys==h.sys&&
"mediola"==h.sys&&f.event.data?"IR"==f.event.data.type&&"IR"==h.type?(p=k(f.event.data.data),l=k(h.data),e._logger.log("debug","comparing => triggerData : "+p+"  dataValue : "+l),f.event.data.type==h.type&&p==l):f.event.data.type==h.type&&f.event.data.data==h.data:!1}if("state"==l){if(!(f.state&&f.state.devices&&f.state.devices.length&&f.state.data&&f.state.data.length))return!1;l={};for(var v in h.state)h.changed&&-1!=h.changed.indexOf(v)&&(l[v]=h.state[v]);for(h=0;h<f.state.devices.length;h++)if(l=
f.state.devices[h])if(l=commandman.commandHandlerV6.resolveDeviceStates(l,p))for(g=!0,v=0;v<f.state.data.length;v++){var u=f.state.data[v];if(u&&commandman.commandHandlerV6.matchDeviceState(l,u))return!0}}return!1}(b,c);d(null,a,g)};n.prototype._hitTimeTrigger=function(a,b,c,d){if(!a)return!1;if(a.time){if(!b)return!1;var e=a.time.split(":");if(2>e.length)return!1;c=parseInt(e[0]);e=parseInt(e[1]);return c==b.hour()&&e==b.minute()}if(a.astro){if(!c||!d)return!1;d=D.calculateAstroTarget(b,c,d,a.astro);
if(!d)return!1;var g=null,k=null;a.earliest&&(e=a.earliest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),g=moment(b),g.hour(parseInt(c)),g.minute(parseInt(e)),g.second(0),g.millisecond(0)));a.latest&&(e=a.latest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),k=moment(b),k.hour(parseInt(c)),k.minute(parseInt(e)),k.second(0),k.millisecond(0)));if(g&&k&&g.isAfter(k))return!1;g&&d.isBefore(g)&&(d=g);k&&d.isAfter(k)&&(d=k);return d.hour()==b.hour()&&d.minute()==b.minute()}return!1};
n.parseJSON=function(a,b){if(!a||!b)return null;switch(b.type){case "heatingschedule":a=new m(a);break;case "link":a=new z(a);break;case "alarm":a=new q(a);break;default:a=new n(a)}a._json=b;return a};var z=function(a){n.call(this,a);this._stateBuffer=null};util.inherits(z,n);z.prototype.onDeviceEvent=function(a,b){if(this._json){var c=a.type;a=a.value;this._logger.log("trace","check link device with "+c+":"+JSON.stringify(a));if(this._json.link&&this._json.link.device){b=this._json.link;var d=b.device;
if("state"==c&&a.state&&(c=!1,d.device&&d.device.id&&d.device.id==a.sid&&(c=!0),c)){this._logger.log("trace","match link device");c=!1;d=[];if(b.value){var e=!0;a.changed&&-1==a.changed.indexOf(b.value)&&(e=!1);var g=a.state[b.value];void 0!=g&&null!=g&&e&&(c=!0,this._logger.log("trace","match link device state:"+b.value),b.command&&d.push({command:b.command,value:g}))}else if(b.values&&b.values.length)for(var k=0;k<b.values.length;k++){var f=b.values[k];if(!f)return;var p=f.value;p||(p="state");
e=!0;a.changed&&-1==a.changed.indexOf(p)&&(e=!1);g=a.state[p];if(void 0!=g&&null!=g&&e){if(f.hyst)if(g=parseFloat(g),e=this._stateBuffer?this._stateBuffer[p]:null,void 0!=e&&null!=e){if(g-e>f.hyst||e-g>f.hyst)c=!0}else c=!0;else f.states?(1==g||"true"==g?c=-1!=f.states.indexOf(!0)||-1!=f.states.indexOf("true"):0==g||"false"==g?c=-1!=f.states.indexOf(!1)||-1!=f.states.indexOf("false"):-1!=f.states.indexOf(g)&&(c=!0),g=null):c=!0;this._logger.log("trace","match link device values("+k+") state:"+p);
if(f.ranges&&f.ranges.length)for(g=parseFloat(g),e=0;e<f.ranges.length;e++){var l=f.ranges[e];if(l&&!(void 0!=l.to&&null!=l.to&&g>l.to||void 0!=l.from&&null!=l.from&&g<l.from)){var h=null;l.command?h=l.command:f.command&&(h=f.command);l=void 0!=l.value&&null!=l.value?l.value:g;void 0!=h&&null!=h&&d.push({command:h,value:l,source:p})}}else f.command?d.push({command:f.command,value:g,source:p}):d.push({command:g,source:p})}}this._stateBuffer=a.state;c&&d.length&&this._doAction(d)}}}};z.prototype._doAction=
function(a){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(a)),this._json.devices&&this._json.devices.length){for(var b=this._json.devices,c=[],d=0;d<b.length;d++){var e=b[d];if(e)for(var g=0;g<a.length;g++){var k=a[g];if(k){var f=JSON.parse(JSON.stringify(e)),p;for(p in k)f[p]=k[p];c.push(f)}}}if(c.length){this._logger.log("trace","do actions");var l=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,c,function(h){l._logger.log("trace","finish do actions "+
(h?"failed:"+h.message:"success"));callback&&callback(h)})}else this._logger.log("trace","no devices")}else this._logger.log("trace","no devices")};var q=function(a){n.call(this,a);this._triggerDelayTimeout=null};util.inherits(q,n);q.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null)};q.prototype._doDeactivate=function(a){var b=this,c=this._json;this._logger.log("trace","do ondeactivation actions");(function(d){var e=function(k,
f,p){if(f&&f.state&&f.state.ondeactivate&&f.state.devices&&f.state.devices.length)try{var l=[];f.state.devices.forEach(function(h){h=JSON.parse(JSON.stringify(h));for(var v in f.state.ondeactivate)h[v]=f.state.ondeactivate[v];l.push(h)});l.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+k+"-ondeactivate",l,function(h){p(h)}):p()}catch(h){p(h)}else b._logger.log("trace","trigger("+k+") has no ondeactivate actions"),p()},g=function(k){if(c.trigger&&c.trigger.length){var f=0,p=[],l=
function(h){b._logger.log("trace","do trigger("+f+") ondeactivation actions "+(h?"fail:"+h.message:"success"));h&&p.push(f);f++;f<c.trigger.length?(b._logger.log("trace","do trigger("+f+") ondeactivation actions"),e(f,c.trigger[f],l)):k(p.length?Error("ondeactivation actions failed for triggers ["+p.join(",")+"]"):null)};b._logger.log("trace","do trigger("+f+") ondeactivation actions");e(f,c.trigger[f],l)}else k()};b._logger.log("trace","do main ondeactivation actions");(function(k){c.ondeactivation&&
c.ondeactivation.length?actman.getActionManager().executeAction("rle:"+b._id+"@ondeactivation",c.ondeactivation,function(f){k(f)}):k()})(function(k){b._logger.log("trace","finish main ondeactivation actions "+(k?"fail:"+k.message:"success"));b._logger.log("trace","do triggers ondeactivation actions");g(function(f){b._logger.log("trace","finish triggers ondeactivation actions "+(f?"fail:"+f.message:"success"));var p=null;if(k||f)p=k?"main ondeactivation failed":"",p=Error(p+((p?", ":"")+f?"triggers ondeactivation failed":
""));d(p)})})})(function(d){b._logger.log("trace","finish ondeactivation actions "+(d?"fail:"+d.message:"success"));b._json.active=0;b._logger.log("trace","save rule deactivated");b._ruleManager.onRuleChanged(b._id,function(e){b._logger.log("trace","finish save rule deactivated "+(e?"fail:"+e.message:"success"));a&&a(e?Error("save rule deactivated failed:"+e.message):null)})})};q.prototype._doActivate=function(a){var b=this,c=this._json,d=function(l){var h=function(u,r,A){if(r&&r.state&&r.state.onactivate&&
r.state.devices&&r.state.devices.length)try{var B=[];r.state.devices.forEach(function(C){C=JSON.parse(JSON.stringify(C));for(var w in r.state.onactivate)C[w]=r.state.onactivate[w];B.push(C)});B.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+u+"-onactivate",B,function(C){A(C)}):A()}catch(C){A(C)}else b._logger.log("trace","trigger("+u+") has no onactivate actions"),A()},v=function(u){if(c.trigger&&c.trigger.length){var r=0,A=[],B=function(C){b._logger.log("trace","do trigger("+r+
") onactivation actions "+(C?"fail:"+C.message:"success"));C&&A.push(r);r++;r<c.trigger.length?(b._logger.log("trace","do trigger("+r+") onactivation actions"),h(r,c.trigger[r],B)):u(A.length?Error("onactivation actions failed for triggers ["+A.join(",")+"]"):null)};b._logger.log("trace","do trigger("+r+") onactivation actions");h(r,c.trigger[r],B)}else u()};b._logger.log("trace","do main onactivation actions");(function(u){c.onactivation&&c.onactivation.length?actman.getActionManager().executeAction("rle:"+
b._id+"@onactivation",c.onactivation,function(r){u(r)}):u()})(function(u){b._logger.log("trace","finish main onactivation actions "+(u?"fail:"+u.message:"success"));b._logger.log("trace","do triggers onactivation actions");v(function(r){b._logger.log("trace","finish triggers onactivation actions "+(r?"fail:"+r.message:"success"));var A=null;if(u||r)A=u?"main onactivation failed":"",A=Error(A+((A?",":"")+r?"triggers onactivation failed":""));l(A)})})},e=function(l){c.onchecksuccess&&c.onchecksuccess.length?
actman.getActionManager().executeAction("rle:"+b._id+"@onchecksuccess",c.onchecksuccess,function(h){l(h)}):l()},g=function(l){c.oncheckfail&&c.oncheckfail.length?actman.getActionManager().executeAction("rle:"+b._id+"@oncheckfail",c.oncheckfail,function(h){l(h)}):l()},k=function(l,h){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(l,h)},f=function(l,h,v,u,r){if(u){var A=h.state.check;h=h.state.data;var B=[],C=!0;A&&A.length?(A.forEach(function(w){w&&w.states&&w.states.length&&(w=JSON.parse(JSON.stringify(w)),
w.value||(w.value="state"),B.push(w))}),C=!0):h&&h.length&&(h.forEach(function(w){w&&w.states&&w.states.length&&(w=JSON.parse(JSON.stringify(w)),w.value||(w.value="state"),B.push(w))}),C=!1);B.length?k(u,function(w,G){if(w)b._logger.log("trace","get trigger("+l+") device("+v+") states fail:"+w.message),r(w);else if(G){for(w=0;w<B.length;w++){var E=G[B[w].value];if(void 0==E||null==E){b._logger.log("trace","check trigger("+l+") device("+v+") state "+B[w].value+" fail: value unknown");r(Error("state value unknown"));
return}b._logger.log("trace","check trigger("+l+") device("+v+") state "+B[w].value+"="+E);var F=!1;C&&-1!=B[w].states.indexOf(E)?F=!0:C||-1!=B[w].states.indexOf(E)||(F=!0);if(!F){r(null,F);return}}r(null,!0)}else b._logger.log("trace","check trigger("+l+") device("+v+") state fail: states response is null"),r(Error("states response is null"))}):(b._logger.log("trace","get trigger("+l+") device("+v+") has no states to check"),r(null,!0))}else b._logger.log("trace","get trigger("+l+") device("+v+") json is null"),
r(null,!0)},p=function(l,h,v){if(h&&h.state&&h.state.devices&&h.state.devices.length){var u=0,r=function(A,B){b._logger.log("trace","check trigger("+l+") device("+u+") "+(A?"fail:"+A.message:"success:match="+B));A||!B?v(A,B):(u++,u<h.state.devices.length?(b._logger.log("trace","check trigger("+l+") device("+u+")"),f(l,h,u,h.state.devices[u],r)):v(null,!0))};b._logger.log("trace","check trigger("+l+") device("+u+")");f(l,h,u,h.state.devices[u],r)}else b._logger.log("trace","trigger("+l+") has no checkable devices"),
v(null,!0)};this._logger.log("trace","check triggers (value="+c.checktriggers+")");(function(l){if(1!=c.checktriggers)l(null,!0);else if(c.trigger&&c.trigger.length){var h=0,v=function(u,r){b._logger.log("trace","check trigger("+h+") "+(u?"fail:"+u.message:"success:match="+r));u||!r?l(u,r):(h++,h<c.trigger.length?(b._logger.log("trace","check trigger("+h+")"),p(h,c.trigger[h],v)):l(null,!0))};b._logger.log("trace","check trigger("+h+")");p(h,c.trigger[h],v)}else l(null,!0)})(function(l,h){b._logger.log("trace",
"finish check triggers "+(l?"fail:"+l.message:"success:match="+h));l||!h?(b._logger.log("trace","do oncheckfail actions"),g(function(v){b._logger.log("trace","finish oncheckfail actions "+(v?"fail:"+v.message:"success"));var u="check triggers failed:"+(l?l.message:"device state not match");v&&(u+="; oncheckfail actions failed:"+v.message);a&&a(Error(u))})):(b._logger.log("trace","do onchecksuccess actions"),e(function(v){b._logger.log("trace","finish onchecksuccess actions "+(v?"fail:"+v.message:
"success"));v?a&&a(Error("onchecksuccess actions failed:"+v.message)):(b._logger.log("trace","do onactivation actions"),d(function(u){b._logger.log("trace","finish onactivation actions "+(u?"fail:"+u.message:"success"));b._json.active=1;b._logger.log("trace","save rule activated");b._ruleManager.onRuleChanged(b._id,function(r){b._logger.log("trace","finish save rule activated "+(r?"fail:"+r.message:"success"));a&&a(r?Error("save rule activated failed:"+r.message):null)})}))}))})};q.prototype.onTriggered=
function(a,b){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var c=this;b.delay?(this._logger.log("trace","triggered by trigger("+a+") with delay "+b.delay),this._triggerDelayTimeout=setTimeout(function(){c._logger.log("trace","do delayed action by trigger("+a+")");c.doActions()},1E3*b.delay)):(this._logger.log("trace","triggered by trigger("+a+") and do actions"),this.doActions())};q.prototype._hitDeviceTrigger=function(a,b,c,d){var e=this;n.prototype._hitDeviceTrigger.call(this,
a,b,c,function(g,k){g||!k?d(g,k):(b.state&&b.state.ontrigger&&(e._logger.log("trace","do trigger("+a+") ontrigger actions"),actman.getActionManager().executeAction("rle:"+e._id+"@t"+a+"-ontrigger",b.state.ontrigger,function(f){e._logger.log("trace","do trigger("+a+") ontrigger actions "+(f?"fail:"+f.message:"success"))})),d(null,k))})};var m=function(a){n.call(this,a)};util.inherits(m,n);m.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by periods with index ["+a+"]");a=JSON.parse(JSON.stringify(b));
a.command||(a.command="temperature");if((b=this._json)&&b.devices&&0<b.devices.length){for(var c=[],d=0;d<b.devices.length;d++){var e=b.devices[d];if(e)try{var g=JSON.parse(JSON.stringify(e)),k;for(k in a)g[k]=a[k];c.push(g)}catch(f){}}this._logger.log("trace","do actions");actman.getActionManager().executeAction("rle:"+this._id,c,function(f){callback&&callback(f)})}};m.prototype.onTimerTick=function(a){if(this._json){var b=this.isActive(),c=this.matchTimeRequirement(a);if(b&&c){var d=this._json;
if(d.periods&&0!=d.periods.length)for(var e=0;e<d.periods.length;e++){var g=d.periods[e];if(this._hitPeriodTrigger(g,a)){this._logger.log("trace","active:"+b+" | date match:"+c+" | time trigger hit");this.onTriggered(e,g);break}}}}};m.prototype.onDeviceEvent=function(a,b){};m.prototype._hitPeriodTrigger=function(a,b){if(!a||!a.start)return!1;var c=a.start.split(":");if(2>c.length)return!1;a=parseInt(c[0]);c=parseInt(c[1]);return a==b.hour()&&c==b.minute()};var t=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");
this._cronTimer=this._rules=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};t.FILE_NAME="rule.json";t.prototype.init=function(a,b){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();this._cronTimer=new y(this);var c=this;this._loadRules(function(d){d?b&&b(d):c._initRules(function(){b&&b()})})};t.prototype.getRules=function(){return this._rules};t.prototype.getRule=function(a){return this._rules?this._rules[a]:null};t.prototype.setRule=function(a,
b,c){if(a){var d=this._rules[a];if(b){this._logger.log("trace","update rule "+a);var e=n.parseJSON(a,b);if(!e){c&&c(Error("invalid rule json"));return}e._ruleManager=this;this._rules[a]=e}else this._logger.log("trace","delete rule "+a),delete this._rules[a];d&&(this._logger.log("trace","call finialize of old rule "+a),d.finalize());this._writeRules(function(g){c&&c(g,b)})}else c&&c(Error("invalid rule id"))};t.prototype.onRuleChanged=function(a,b){this._writeRules(function(c){b&&b(c)})};t.prototype.onTimerTick=
function(a,b,c){if(this._rules)for(var d in this._rules){var e=this._rules[d];if(e)e.onTimerTick(a,b,c)}};t.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));this._cronTimer.onLocationChange(a)};t.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};t.prototype.onDeviceEvent=function(a){this._logger.log("trace","receive "+a.type+" event from "+a.source+
":"+JSON.stringify(a.value));var b=D.getMomentNow(),c;for(c in this._rules){var d=this._rules[c];if(d)d.onDeviceEvent(a,b)}};t.prototype._initRules=function(a){this._cronTimer.start();a()};t.prototype._loadRules=function(a){var b=require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(e){e?a(e):d._loadFile(function(g,k){if(g)a(g);else{d._rules={};if(k)for(var f in k)if(g=n.parseJSON(f,k[f]))g._ruleManager=d,d._rules[f]=g;a()}})})};t.prototype._writeRules=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&
this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];a={};for(var c in this._rules){var d=this._rules[c];d&&d.toJSON&&(a[c]=d.toJSON())}var e=this;this._writeFile(a,function(g){e._writing=!1;b.forEach(function(k){try{k&&k(g)}catch(f){}});e._writeRules()})}};t.prototype._getFile=function(){return require("path").resolve(this._dataFolder,t.FILE_NAME)};t.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();
b.readFile(c,"utf8",function(d,e){if(d)a(d);else if(e)try{var g=JSON.parse(e);a(null,g)}catch(k){a(null,{})}else a(null,{})})};t.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(e){b&&b(e)})};t.Util=D;t.Rule=n;return t}();
x.hub.rule.Handler=function(){var D=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};D.prototype.RuleManager=x.hub.rule.RuleManager;D.prototype.init=function(y,n,z){var q=this;eventbus.on("locationchange",this._onLocationChange.bind(this));eventbus.on("timechange",this._onTimeChange.bind(this));eventbus.on("gatewayevent",function(m,t,a){q._onGatewayEvent(m,t,a)});"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(y):this._initHttpApi(y);
this._ruleManager.init(n,function(m){m&&z(m)})};D.prototype.getRuleManager=function(){return this._ruleManager};D.prototype._onLocationChange=function(y){this._logger.log("trace","receive location change event:"+JSON.stringify(y));this._ruleManager.onLocationChange(y)};D.prototype._onTimeChange=function(y){this._logger.log("trace","receive time change event:"+JSON.stringify(y));this._ruleManager.onTimeChange(y)};D.prototype._onGatewayEvent=function(y,n,z){this._logger.log("trace","receive gateway "+
z+" event:"+JSON.stringify(y)+" from:"+JSON.stringify(n));if(y){var q=this,m={source:n.address,type:"STA"==z?"state":"event",value:y};process.nextTick(function(){q._ruleManager.onDeviceEvent(m)})}};D.prototype._initHttpApiNew=function(y){var n=this;y=require("x.hub.js").getServer();y.addRoute("/api/rules",{method:"GET"},function(z,q,m){z=n._ruleManager.getRules();q.json({XC_SUC:z?z:{}})});y.addRoute("/data/rle/",{method:"GET"},function(z,q,m){z=z.path.substr(10);(z=n._ruleManager.getRule(z))?q.json({XC_SUC:z}):
q.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});y.addRoute("/data/rle/",{method:"POST",lock:1},function(z,q){var m=z.path.substr(10);try{n._ruleManager.setRule(m,z.json,function(t,a){t?q.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+t.message}}):a?q.json({XC_SUC:{bytes:z.size}}):q.json({XC_SUC:{bytes:0}})})}catch(t){q.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+t.message}})}});y.addRoute("/api/trigger",{method:"POST"},function(z,q){try{var m=z.json;m&&"time"==m.type&&
m.value?(q.json({XC_SUC:{}}),process.nextTick(function(){var t=require("moment-timezone"),a=taskman.Util._getTimeZone(),b=parseInt(m.value.split(":")[0]),c=parseInt(m.value.split(":")[1]),d=new Date;d.setHours(b);d.setMinutes(c);d=t.tz(d.getTime(),a);n._ruleManager.onTimerTick(d)})):m&&"event"==m.type&&m.value?(q.json({XC_SUC:{}}),process.nextTick(function(){n._ruleManager.onDeviceEvent({source:m.source?m.source:"ST",type:m.type,value:m.value})})):m&&"state"==m.type&&m.value?(q.json({XC_SUC:{}}),
process.nextTick(function(){n._ruleManager.onDeviceEvent({source:m.source?m.source:"ST",type:m.type,value:m.value})})):q.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(t){q.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+t.message}})}})};D.prototype._initHttpApi=function(y){var n=this,z=require("x.hub.js").getServer();y.get("/api/rules",function(q,m,t){z.auth(q)?(q=n._ruleManager.getRules(),m.json({XC_SUC:q?q:{}})):m.json({XC_ERR:{code:"000007",msg:"access denied"}})});y.get("/data/rle/:id",
function(q,m,t){z.auth(q)?(q=n._ruleManager.getRule(q.params.id))?m.json({XC_SUC:q}):m.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):m.json({XC_ERR:{code:"000007",msg:"access denied"}})});y.post("/data/rle/:id",function(q,m){if(z.auth(q)){var t=new Buffer(0);q.on("data",function(a){t=Buffer.concat([t,a])});q.on("end",function(){var a=q.params.id,b=t.toString("utf8");try{var c=null;b&&(c=JSON.parse(b));n._ruleManager.setRule(a,c,function(d,e){d?m.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+
d.message}}):e?m.json({XC_SUC:{bytes:t.length}}):m.json({XC_SUC:{bytes:0}})})}catch(d){m.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+d.message}})}})}else m.json({XC_ERR:{code:"000007",msg:"access denied"}})});y.post("/api/trigger",function(q,m){if(z.auth(q)){var t=new Buffer(0);q.on("data",function(a){t=Buffer.concat([t,a])});q.on("end",function(){var a=t.toString("utf8");try{var b=null;a&&(b=JSON.parse(a));if(b&&"time"==b.type&&b.value){var c=require("moment-timezone"),d=taskman.Util._getTimeZone(),
e=parseInt(b.value.split(":")[0]),g=parseInt(b.value.split(":")[1]),k=new Date;k.setHours(e);k.setMinutes(g);k=c.tz(k.getTime(),d);var f=x.hub.rule.RuleManager.Util.getAstro(k);n._ruleManager.onTimerTick(k,f[0],f[1]);m.json({XC_SUC:{}})}else m.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(p){m.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+p.message}})}})}else m.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return D}();module.exports=new x.hub.rule.Handler;
