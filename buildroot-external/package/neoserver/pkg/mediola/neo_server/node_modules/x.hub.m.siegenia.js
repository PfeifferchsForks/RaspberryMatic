var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.siegenia=x.hub.m.siegenia||{};x.hub.m.siegenia.SIEGENIA_MODULE=require("xnm.aio.siegenia.js");x.hub.m.siegenia.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.siegenia.Handler");this._devices={};this._on={}};x.hub.m.siegenia.Handler.prototype.init=function(a){a&&a()};x.hub.m.siegenia.Handler.prototype.getSystems=function(){return["siegenia"]};
x.hub.m.siegenia.Handler.prototype.addStateDevice=function(a,b,c){if(a){if(a.address||!a.ip)a.ip=a.address;if(a.ip){var e=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);if(e){var d=this._devices[a.ip];if(d){if(c&&d.metas.push(c),a.password!=d.dev.password||a.password!=d.obj.password)d.dev.password=a.password,d.obj.password=a.password}else{d={dev:a,obj:e,metas:[c]};this._devices[a.ip]=d;var f=this;d.obj.startMonitoring(function(g){f._checkStateChange(a,g)},function(){})}b&&b({})}else b&&b({error:Error("device json unknow device")})}else b&&
b({error:Error("device json invalid")})}else b&&b({error:Error("device json invalid")})};
x.hub.m.siegenia.Handler.prototype.removeStateDevice=function(a,b,c){if(!a)b&&b({error:Error("device json invalid")});else if(c){var e=this._devices[a.ip];if(e){var d=e.metas;if(d){for(var f=-1,g=0;g<d.length;g++){var h=d[g];if(h&&"taskman"==h.src&&"taskman"==c.src&&h.taskID==c.taskID&&h.statusKey==c.statusKey){f=g;break}}0<=f&&d.splice(f,1);if(0==d.length){delete this._devices[a.ip];x.hub.m.siegenia.SIEGENIA_MODULE.SessionManager.stopMonitorSession(e.obj,function(){b&&b()});return}}b&&b()}else b&&
b({})}};x.hub.m.siegenia.Handler.prototype.updateStates=function(a,b){var c=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);c?c.getSingleDeviceStatesCreator(null,a,null,function(e,d){b&&b({error:e,data:d})}):b&&b({error:Error("device json invalid")})};x.hub.m.siegenia.Handler.prototype.getStates=function(a){return{}};x.hub.m.siegenia.Handler.prototype.getAllStates=function(){return[]};
x.hub.m.siegenia.Handler.prototype.executeCommand=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doCommand(a,b,function(e){e?c&&c({error:e}):c&&c({})})};x.hub.m.siegenia.Handler.prototype.getState=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doStatus("xhub",a,{value:b},function(e,d){e?c&&c({error:e}):d?c&&c({data:{value:d.status}}):c&&c({error:Error("do status failed")})})};
x.hub.m.siegenia.Handler.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var c=a.device.data;return a.device.address==b.device.address&&c==b.device.data};
x.hub.m.siegenia.Handler.prototype._checkStateChange=function(a,b){this._logger.log("trace","receive status:"+JSON.stringify(b));this._logger.log("trace","for device:"+JSON.stringify(a));if(this._devices[a.ip]){var c=this._devices[a.ip],e=c.states;e||(c.states={},e={});var d=[],f;for(f in b){var g={};g.key=f;g.value=b[f];g.changed=!0;e[f]&&b[f]==e[f].value&&(g.oldvalue=e[f].value,g.changed=!1);c.states[f]={value:b[f],time:(new Date).getTime()};g.changed&&d.push({device:a,data:g});if("warnings"==f){var h=
e[f]?e[f].value:null;b[f].forEach(function(l){var k={key:"warning"};k.value=l;k.changed=!1;h&&-1==h.indexOf(l)&&(k.changed=!0);d.push({device:a,data:k})})}}d&&0<d.length&&this._generateEvent(a,d)}};
x.hub.m.siegenia.Handler.prototype._generateEvent=function(a,b){if(this._devices[a.ip]){var c=require("x.hub.eventbus.js");if((a=this._devices[a.ip].metas)&&0<a.length)for(var e=0;e<a.length;e++){var d=a[e];if(d)for(var f=0;f<b.length;f++){var g=b[f];g&&g.data&&(g.data.key==d.statusKey||"*"==g.data.key)&&c.emit("status",{module:"siegenia",device:g.device,data:g.data},d)}}}};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.siegenia.Handler);
