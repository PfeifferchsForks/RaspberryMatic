var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};$jscomp.polyfill=function(a,b,c,e){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,e):$jscomp.polyfillUnisolated(a,b,c,e))};
$jscomp.polyfillUnisolated=function(a,b,c,e){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var h=a[e];if(!(h in c))return;c=c[h]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,e){var h=a.split(".");a=1===h.length;e=h[0];e=!a&&e in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var l=0;l<h.length-1;l++){var k=h[l];if(!(k in e))return;e=e[k]}h=h[h.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?e[h]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,h,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[h]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[h]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(h):$jscomp.POLYFILL_PREFIX+c+"$"+h),$jscomp.defineProperty(e,$jscomp.propertyToPolyfillSymbol[h],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(b,c){var e=this;e instanceof String&&(e=String(e));var h=e.length;c=c||0;for(0>c&&(c=Math.max(c+h,0));c<h;c++){var l=e[c];if(l===b||Object.is(l,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,c||0)}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.homekit=xnm.aio.homekit||{};xnm.aio.homekit.XCHomeKit=function(){this._stateCallback=this._errorCallback=null;var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.homekit"):{log:function(){}}};xnm.aio.homekit.XCHomeKit.prototype.on=function(a,b){if("error"===a)this._errorCallback=b;else if("updatedState"===a){this._stateCallback=b;var c=this;XC.callHost("homekit","setStateCallback",null,function(e){e&&c._stateCallback(e)})}};
xnm.aio.homekit.XCHomeKit.prototype.getDevices=function(a){this._logger.log("trace","Calling getDevices on host.");var b=this;XC.callHost("homekit","getDevices",{},function(c){b._logger.log("debug","Received getDevices response.");a&&a(c)})};xnm.aio.homekit.XCHomeKit.prototype.getStates=function(a){this._logger.log("trace","Calling getStates on host.");var b=this;XC.callHost("homekit","getStates",{},function(c){b._logger.log("trace","Received getStates response.");a&&a(c)})};
xnm.aio.homekit.XCHomeKit.prototype.updateStates=function(a){this._logger.log("trace","Calling updateStates on host.");var b={};a&&(b.devices=a);XC.callHost("homekit","updateStates",b)};
xnm.aio.homekit.XCHomeKit.prototype.executeCommand=function(a,b,c,e){this._logger.log("trace","Calling executeCommand on host with: "+a+" | "+b+" | "+c);a={id:a,command:b};"undefined"!==typeof c&&null!==c&&(a.value=c);var h=this;XC.callHost("homekit","executeCommand",a,function(l){try{h._logger.log("debug","Command has been executed: "+JSON.stringify(l))}catch(k){h._logger.log("error","JSON error in executeCommand response: "+k.message)}e&&(l&&l.error?e(!1):e(!0))})};
xnm.aio.homekit.XCHomeKit.prototype.doScene=function(a,b){this._logger.log("trace","Calling doScene on host for ID: "+a);var c=this;XC.callHost("homekit","doScene",{id:a},function(e){try{c._logger.log("debug","Scene has been executed: "+JSON.stringify(e))}catch(h){c._logger.log("error","JSON error in doScene response: "+h.message)}b&&(e&&e.error?b(!1):b(!0))})};
xnm.aio.homekit.XCHomeKit.prototype.showCamera=function(a,b){this._logger.log("trace","Calling showCamera on host for ID: "+a);b.id=a;XC.callHost("homekit","showCamera",b)};xnm.aio.homekit.XCHomeKit.prototype.hideCamera=function(a){this._logger.log("trace","Calling hideCamera on host for ID: "+a);XC.callHost("homekit","hideCamera",{id:a})};
xnm.aio.homekit.XCHomeKit.prototype.showCameraSnapshot=function(a,b,c,e,h){this._logger.log("trace","Calling showCameraSnapshot on host for ID: "+a);a={id:a};b&&(a.left=b);c&&(a.top=c);e&&(a.width=e);h&&(a.height=h);XC.callHost("homekit","showCameraSnapshot",a)};xnm.aio.homekit.XCHomeKit.prototype.hideCameraSnapshot=function(a){this._logger.log("trace","Calling hideCameraSnapshot on host for ID: "+a);XC.callHost("homekit","hideCameraSnapshot",{id:a})};
xnm.aio.homekit.XCHomeKit.prototype.hideAllCameraViews=function(){this._logger.log("trace","Calling hideAllCameraViews on host.");XC.callHost("homekit","hideAllCameraViews",null)};
xnm.aio.homekit.DM={SYS:"homekit",applySmartWidgetFilter:function(a,b,c,e,h){c=this.applyUIFilter(b,{catagory:"command",elems:"*"});var l=this.applyUIFilter(b,{catagory:"status",elems:"*"}),k=null,m=null;c&&Array.isArray(c.command)&&0<c.command.length&&(k={},c.command.forEach(function(q){q&&q.ref&&(k[q.ref.value]=q.ref)}));l&&Array.isArray(l.status)&&0<l.status.length&&(m={},l.status.forEach(function(q){q&&q.ref&&(m[q.ref.value]=q.ref)}));if(!k&&!m)return null;k=k||{};m=m||{};c={};l={};var g=[],f=
{},d={};switch(b.type){case "airPurifier":f["%lockControls%"]="lockControls";f["%rotationSpeed%"]="rotationSpeed";f["%swingMode%"]="swingMode";f["%targetPurifierState%"]="targetPurifierState";f["%toggle%"]="toggle";f["%unlockControls%"]="unlockControls";d["%controlsLockedState%"]="controlsLocked";d["%rotationSpeedState%"]="rotationSpeed";d["%swingModeState%"]="swingMode";d["%switchState%"]="powerState";d["%targetPurifierState%"]="targetPurifierState";g.push("air_purifier");break;case "airQualitySensor":case "dioxideSensor":case "leakSensor":case "monoxideSensor":case "sensor":case "smokeSensor":b.states.dioxideLevel&&
(d["%co2State%"]="dioxideLevel",g.push("sensor_co2"));b.states.leakDetected&&(d["%leakState%"]="leakDetected",g.push("sensor_water"));b.states.monoxideLevel&&(d["%coState%"]="monoxideLevel",g.push("sensor_co"));b.states.smokeDetected&&(d["%smokeState%"]="smokeDetected",g.push("sensor_smoke","smoke"));break;case "blind":case "shutter":f["%lamellaTo%"]="targetVerticalTilt";f["%moveDown%"]="down";f["%moveTo%"]="targetPosition";f["%moveUp%"]="up";f["%stop%"]="stop";d["%blindState%"]="currentPosition";
d["%lamellaState%"]="currentVerticalTilt";d["%shutterState%"]="currentPosition";g.push("blind","shutter");break;case "contactSensor":d["%contactState%"]="contactDetected";g.push("contact","sensor_contact");break;case "door":case "window":f["%close%"]="close";f["%moveTo%"]="targetPosition";f["%open%"]="open";f["%stop%"]="stop";d["%positionState%"]="currentPosition";d["%targetPositionState%"]="targetPosition";g.push(b.type);break;case "fan":f["%lockControls%"]="lockControls";f["%rotationDirection%"]=
"rotationDirection";f["%rotationSpeed%"]="rotationSpeed";f["%swingMode%"]="swingMode";f["%toggle%"]="toggle";f["%unlockControls%"]="unlockControls";d["%controlsLockedState%"]="controlsLocked";d["%rotationDirectionState%"]="rotationDirection";d["%rotationSpeedState%"]="rotationSpeed";d["%swingModeState%"]="swingMode";d["%switchState%"]="powerState";g.push("fan");break;case "heater":case "thermostat":f["%heaterCoolingTemp%"]="coolingTemperature";f["%heaterHeatingTemp%"]="heatingTemperature";f["%lockControls%"]=
"lockControls";f["%rotationSpeed%"]="rotationSpeed";f["%swingMode%"]="swingMode";f["%targetMode%"]="targetMode";f["%thermoTempDown%"]="down";f["%thermoTempTo%"]="targetTemperature";f["%thermoTempUp%"]="up";f["%unlockControls%"]="unlockControls";d["%controlsLockedState%"]="controlsLocked";d["%heaterCoolingTempState%"]="coolingTemperature";d["%heaterHeatingTempState%"]="heatingTemperature";d["%humState%"]="currentHumidity";d["%rotationSpeedState%"]="rotationSpeed";d["%swingModeState%"]="swingMode";
d["%targetModeState%"]="targetMode";d["%tempState%"]="currentTemperature";d["%thermoCurrentTemp%"]="currentTemperature";d["%thermoSetTemp%"]="targetTemperature";g.push("climate","thermostat","weather_station");break;case "motionSensor":d["%motionState%"]="motionDetected";g.push("motion","sensor_motion");break;case "light":case "switch":f["%colorTemp%"]="colorTemperature";f["%dimTo%"]="brightness";f["%off%"]="off";f["%on%"]="on";f["%rgb%"]="color";f["%toggle%"]="toggle";d["%colorTempState%"]="colorTemperature";
d["%dimmerState%"]="brightness";d["%switchState%"]="powerState";g.push("dimmer","switch");(b.commands.color||b.commands.colorTemperature)&&g.push("rgb");break;case "occupancySensor":d["%occupancyState%"]="occupancyDetected";g.push("occupancy","sensor_occupancy");break;case "speaker":f["%mute%"]="mute";f["%toggleMute%"]="toggle";f["%unmute%"]="unmute";f["%volume%"]="volume";d["%mutedState%"]="muted";d["%volumeState%"]="volume";g.push("speaker");break;default:return null}for(var n in f)b=f[n],"string"===
typeof b?k[b]&&(c[n]=k[b]):c[n]=b;for(var p in d)n=d[p],"string"===typeof n?m[n]&&(l[p]=m[n]):l[p]=n;return a._injectToSmartWidgetTemplate(e,g,h,c,l,null)},applyUIFilter:function(a,b,c){if(!a.sys)return null;var e=function(g,f){if("*"===g||"*"===g[0])return!0;for(var d=0;d<g.length;d++)if(g[d]==f)return!0;return!1},h=function(g,f,d){var n=[];switch(d.catagory){case "command":g.command&&g.command.forEach(function(p){e(d.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))});break;case "status":g.status&&
g.status.forEach(function(p){e(d.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))})}return n},l=function(g,f){var d=[],n=xnm.aio.homekit.DM.getCommandStatusMap(g,c);n&&(g=h(n,g,f),d=d.concat(g));return d},k=JSON.parse(JSON.stringify(a)),m=null;switch(b.catagory){case "command":m=l(a,b);k.command=m;break;case "status":m=l(a,b);k.status=m;break;default:return null}return m&&0!=m.length?k:null},createDevice:function(a,b,c){b=xnm.aio.homekit.DM;a?a.type?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,
"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))},createGateway:function(a,b,c){b=xnm.aio.homekit.DM;a?c(null,a):c(new b.Error(b.ERROR.ERROR_CODE.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c&&c()},deleteGateway:function(a,b,c){c&&c()},getCommandStatusMap:function(a,b){b={command:[],status:[]};if("scene"===a.type)return b.command.push({name:"scene",type:"enum",ref:{value:"scene"}}),b;var c={command:{enum:"%e",float:"%f",int:"%d",rgb:"%rgb",rgbw:"%rgbw",
string:"%s"}};c.state=JSON.parse(JSON.stringify(c.command));c.state.rgb="%s";c.state.rgbw="%s";var e={},h=function(g,f,d){var n={name:f,type:"enum",ref:{value:f}};if(d.value&&"object"===typeof d.value){if("string"===typeof d.value.type){var p=String(d.value.type).toLowerCase();"bool"===p&&(p="enum");n.type=p;c[g][p]&&(n.ref.ext=c[g][p])}0<=["number","string"].indexOf(typeof d.value.min)&&0<=["number","string"].indexOf(typeof d.value.max)&&(n.ref.extMeta=String(d.value.min)+"-"+String(d.value.max));
"command"===g&&n.ref.extMeta&&(e[f]={},e[f].extMeta=n.ref.extMeta)}"string"===typeof d.type&&(p=String(d.type).toLowerCase(),"bool"===p&&(p="enum",n.ref.options=["true","false"]),n.type=p,c[g][p]&&(n.ref.ext=c[g][p]));Array.isArray(d.values)&&(n.ref.ext="%e","command"===g?n.ref.extMeta||(n.ref.extMeta=d.values.slice(0)):n.ref.options=d.values.slice(0));return n};if(a.commands&&"object"===typeof a.commands)for(var l in a.commands)b.command.push(h("command",l,a.commands[l]));if(a.states&&"object"===
typeof a.states)for(var k in a.states)b.status.push(h("state",k,a.states[k]));for(var m in e)for(a=e[m],l=0;l<b.status.length;l++)if(k=b.status[l],k.name===m){!k.ref.extMeta&&a.extMeta&&(k.ref.extMeta=a.extMeta);break}return b},getGatewayType:function(){return[{sys:this.SYS,name:"HomeKit"}]},supportSmartWidget:function(a){return a&&a.type&&(a.commands||a.states)?"airPurifier airQualitySensor blind contactSensor dioxideSensor door fan heater leakSensor light motionSensor occupancySensor sensor shutter smokeSensor speaker switch thermostat window".split(" ").includes(a.type):
!1},toGeneralDevice:function(a){return null},updateDevice:function(a,b,c){b=xnm.aio.homekit.DM;a?a.type?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))},updateGateway:function(a,b,c,e){a=xnm.aio.homekit.DM;b?e(null,b):e(new a.Error(a.Error.ERROR_CODE.INVALID,"update is invalid"))}};xnm.aio.homekit.DM.Error=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.homekit.DM.Error.prototype=Error();
xnm.aio.homekit.DM.Error.prototype.name="HomeKitDMError";xnm.aio.homekit.DM.Error.prototype.code=0;xnm.aio.homekit.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4};xnm.aio.homekit.Handler=xnm.aio.homekit.XCHomeKit;xnm.aio.homekit.Handler.prototype.devicemanager=xnm.aio.homekit.DM;
xnm.aio.homekit.Handler.prototype._buildRequestOptions=function(a,b){var c=require("url").parse(a.url);a={headers:{Authorization:a.basicAuth,"Content-Type":"application/json"},host:c.hostname,method:b||"GET",path:c.path,port:c.port};0!==a.headers.Authorization.indexOf("Basic ")&&(a.headers.Authorization="Basic "+a.headers.Authorization);a.port||(a.port=443);return a};
xnm.aio.homekit.Handler.prototype.deleteFromServer=function(a,b){this._logger.log("trace","deleteFromServer()");this.exportToServer(a,"",b)};xnm.aio.homekit.Handler.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){var e=this;"scene"===a.type?this.doScene(a.id,function(h){e.updateStates();c&&c(h)}):this.executeCommand(a.id,b.value,b.ext,function(h){e.updateStates([a.id]);c&&c(h)})}else c&&c(Error("Command value is empty."))};
xnm.aio.homekit.Handler.prototype.exportToServer=function(a,b,c){this._logger.log("trace","exportToServer()");var e=null;try{if("string"===typeof b&&0===b.length)e=b;else{b={encrypted:!1,data:b};if(a.password){b.encrypted=!0;e=JSON.stringify(b.data);var h=require("x.crypt");b.data=h.AES.encodeString(e,a.password);b.data=b.data.replace(/[\r\n]/g,"")}e=JSON.stringify(b)}}catch(k){this._logger.log("error",k.message);c&&c(k);return}h=require("https");a=this._buildRequestOptions(a,"POST");var l=this;a=
h.request(a,function(k){var m="";k.on("data",function(g){m+=String(g)});k.on("end",function(){var g=null;0===m.indexOf('{"XC_ERR":')?(g=Error(m),l._logger.log("error","exportToServer: "+g.message)):l._logger.log("debug","Data has been exported.");c(g,m)})});"function"===typeof a.setEncoding&&a.setEncoding("utf-8");a.on("error",function(k){l._logger.log("error",k.message);c(k,null)});a.write(e);a.end()};
xnm.aio.homekit.Handler.prototype.getStatesCreator=function(a,b,c){this.getStates(function(e){for(var h=[],l=0;l<b.length;l++){var k=b[l];if(k&&k.id&&k.status){var m=e[k.device.id];m&&(m=m[k.status.value],"undefined"!==typeof m&&null!==m&&h.push({id:k.id,status:m}))}}c&&c(null,h)})};
xnm.aio.homekit.Handler.prototype.importFromServer=function(a,b){this._logger.log("trace","importFromServer()");var c=require("https"),e=this._buildRequestOptions(a,"GET"),h=this;c=c.request(e,function(l){var k="";l.on("data",function(m){k+=String(m)});l.on("end",function(){var m=null;try{m=JSON.parse(k)}catch(n){b(n,k);return}var g=m,f=null;if(m.XC_SUC){if(m=m.XC_SUC,g=m.data,m.encrypted)if(a.password)try{var d=require("x.crypt");g=g.replace(/[\r\n]/g,"");(g=d.AES.decodeString(g,a.password))&&(g=
JSON.parse(g));g||(f=Error("Could not decrypt data, wrong password."))}catch(n){f=n}else f=Error("Data is encrypted, but no password has been provided.")}else m.XC_ERR&&(g=m.XC_ERR,f="000000"===g.code&&"internal error"===g.msg?Error("No exported data available."):Error(k));f?h._logger.log("error",f.message):h._logger.log("debug","Data has been received.");b(f,g)})});"function"===typeof c.setEncoding&&c.setEncoding("utf-8");c.on("error",function(l){h._logger.log("error",l.message);b(l,null)});c.end()};
xnm.aio.homekit.Handler.prototype.registModule=function(a){a.register(xnm.aio.homekit.DM.SYS,"homekit")};xnm.aio.homekit.Handler.prototype.resolveDevice=function(a){return this};"undefined"!==typeof exports&&"undefined"!==typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homekit.Handler);
