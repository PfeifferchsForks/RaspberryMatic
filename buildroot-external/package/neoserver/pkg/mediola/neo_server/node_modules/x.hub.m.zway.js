var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(l){var h=0;return function(){return h<l.length?{done:!1,value:l[h++]}:{done:!0}}};$jscomp.arrayIterator=function(l){return{next:$jscomp.arrayIteratorImpl(l)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(l,h,f){if(l==Array.prototype||l==Object.prototype)return l;l[h]=f.value;return l};$jscomp.getGlobal=function(l){l=["object"==typeof globalThis&&globalThis,l,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var h=0;h<l.length;++h){var f=l[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(l,h){var f=$jscomp.propertyToPolyfillSymbol[h];if(null==f)return l[h];f=l[f];return void 0!==f?f:l[h]};
$jscomp.polyfill=function(l,h,f,g){h&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(l,h,f,g):$jscomp.polyfillUnisolated(l,h,f,g))};$jscomp.polyfillUnisolated=function(l,h,f,g){f=$jscomp.global;l=l.split(".");for(g=0;g<l.length-1;g++){var m=l[g];if(!(m in f))return;f=f[m]}l=l[l.length-1];g=f[l];h=h(g);h!=g&&null!=h&&$jscomp.defineProperty(f,l,{configurable:!0,writable:!0,value:h})};
$jscomp.polyfillIsolated=function(l,h,f,g){var m=l.split(".");l=1===m.length;g=m[0];g=!l&&g in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var q=0;q<m.length-1;q++){var a=m[q];if(!(a in g))return;g=g[a]}m=m[m.length-1];f=$jscomp.IS_SYMBOL_NATIVE&&"es6"===f?g[m]:null;h=h(f);null!=h&&(l?$jscomp.defineProperty($jscomp.polyfills,m,{configurable:!0,writable:!0,value:h}):h!==f&&(void 0===$jscomp.propertyToPolyfillSymbol[m]&&(f=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[m]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(m):$jscomp.POLYFILL_PREFIX+f+"$"+m),$jscomp.defineProperty(g,$jscomp.propertyToPolyfillSymbol[m],{configurable:!0,writable:!0,value:h})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(l){if(l)return l;var h=function(q,a){this.$jscomp$symbol$id_=q;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};h.prototype.toString=function(){return this.$jscomp$symbol$id_};var f="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",g=0,m=function(q){if(this instanceof m)throw new TypeError("Symbol is not a constructor");return new h(f+(q||"")+"_"+g++,q)};return m},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(l){if(l)return l;l=Symbol("Symbol.iterator");for(var h="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),f=0;f<h.length;f++){var g=$jscomp.global[h[f]];"function"===typeof g&&"function"!=typeof g.prototype[l]&&$jscomp.defineProperty(g.prototype,l,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return l},"es6",
"es3");$jscomp.iteratorPrototype=function(l){l={next:l};l[Symbol.iterator]=function(){return this};return l};$jscomp.iteratorFromArray=function(l,h){l instanceof String&&(l+="");var f=0,g=!1,m={next:function(){if(!g&&f<l.length){var q=f++;return{value:h(q,l[q]),done:!1}}g=!0;return{done:!0,value:void 0}}};m[Symbol.iterator]=function(){return m};return m};$jscomp.polyfill("Array.prototype.keys",function(l){return l?l:function(){return $jscomp.iteratorFromArray(this,function(h){return h})}},"es6","es3");
var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),logger=require("x.logger.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zway=x.hub.m.zway||{};
x.hub.m.zway.Util={hasEvent:function(l,h,f,g){if(!l||!h||!f||0>g||255<g)return null;if("binary"==f.type&&f.value){f=f.value;var m=Math.floor(g/8);return f[m]?(f=f[m]>>g%8&1)?l._EVNETS[h]?l._EVNETS[h][g]:null:null:null}return isNaN(parseInt(f.value))?null:(f=parseInt(f.value)>>g&1)?l._EVNETS[h]?l._EVNETS[h][g]:null:null}};
x.hub.m.zway.PollManager=function(){var l="37 38 49 51 64 67".split(" "),h=function(f){this._logger=logger.getLogger("x.hub.m.zway.Poller");this._pollManager=f;this._deviceID=null;this._pollInterval=0;this._running=!1;this._pollTO=this._startPollTO=null;this._errorCount=0};h.prototype.setDeviceID=function(f){this._deviceID=f};h.prototype.setPollInterval=function(f){this._pollInterval=f};h.prototype.start=function(){this._logger.log("trace","start for device: "+this._deviceID+" with interval: "+this._pollInterval+
"s");if(!this._running){this._running=!0;var f=this;this._startPollTO=setTimeout(function(){f._pollTO=setInterval(function(){f._pollDevice()},1E3*f._pollInterval)},1E3*Math.floor(10*Math.random()+1))}};h.prototype.stop=function(){this._logger.log("trace","stop for device: "+this._deviceID);this._running&&(this._running=!1,this._pollTO&&(clearInterval(this._pollTO),this._pollTO=null),this._startPollTO&&(clearInterval(this._startPollTO),this._startPollTO=null))};h.prototype.immediatelyPoll=function(){this._pollDevice()};
h.prototype._pollDevice=function(){var f=this._pollManager.getHandler().getZway();f&&((f=f.getDevice(this._deviceID))?(this._errorCount=0,this._logger.log("trace","poll device:"+this._deviceID),(f=this._findCommandClassesToPoll(this._deviceID,f))&&0<f.length&&this._pollManager._pollCommandClass(f)):(this._logger.log("trace","no such device: "+this._deviceID),this._errorCount++,10<this._errorCount&&(this._logger.log("trace","too many error with no such device, stop poller: "+this._deviceID),this._pollManager.stopPoller(this._deviceID))))};
h.prototype._findCommandClassesToPoll=function(f,g){if(!g||!g.instances)return null;var m=[],q;for(q in g.instances){var a=g.instances[q];if(a&&a.commandClasses)for(var c in a.commandClasses)-1!=l.indexOf(c)&&m.push(f+"."+q+"."+c)}return m};return{_logger:require("x.logger.js").getLogger("x.hub.m.zway.PollManager"),_handler:null,_tasks:[],_pollers:{},_pollWait:200,_pollTO:null,init:function(f,g){this._handler=f;g&&g()},getHandler:function(){return this._handler},startPoller:function(f,g){if(f&&g&&
!(0>g)){if(!this._pollers[f]){var m=new h(this);m.setDeviceID(f);m.setPollInterval(g);this._pollers[f]=m}this._pollers[f].start()}},stopPoller:function(f){if(f){var g=this._pollers[f];g&&(g.stop(),delete this._pollers[f])}},immediatelyPoll:function(f){if(f)for(var g=0;g<f.length;g++){var m=f[g],q=this._pollers[m];q||(q=new h(this),q.setDeviceID(m));q.immediatelyPoll()}},_pollCommandClass:function(f){for(var g=this._tasks.length,m=0;m<f.length;m++){var q=f[m];-1==this._tasks.indexOf(q)&&this._tasks.push(q)}0!=
g||this._pollTO||this._doNextPollTask()},_doNextPollTask:function(){this._pollTO&&(clearTimeout(this._pollTO),this._pollTO=null);var f=this._tasks.shift();if(f){var g=this;this._doGetRequest(f,function(){g._pollTO=setTimeout(function(){g._pollTO=null;g._doNextPollTask()},g._pollWait)})}},_doGetRequest:function(f,g){this._logger.log("trace","do Get() for command class:"+f);var m=this._handler.getZway();if(m){var q=f.split(".");if(!(3>q.length)){var a=this;m._doRunRequest("devices["+q[0]+"].instances["+
q[1]+"].commandClasses["+q[2]+"].Get()",null,function(c){c&&a._logger.log("warn","do Get() for command class:"+f+" error:"+c.message);g&&g()})}}}}}();
x.hub.m.zway.SettingsManager=function(){var l=function(h,f){this._settingsManager=h;this._deviceID=f;this._autoPoll=!1;this._pollInterval=0};l.prototype.init=function(){this.start()};l.prototype.start=function(){this._autoPoll&&0<this._pollInterval&&this._settingsManager._startPoller(this)};l.prototype.stop=function(){this._settingsManager._stopPoller(this)};l.prototype.getDeviceID=function(){return this._deviceID};l.prototype.getPollInterval=function(){return this._pollInterval};l.prototype.toJSON=
function(){return{autoPoll:this._autoPoll,pollInterval:this._pollInterval}};l.prototype.fromJSON=function(h){h&&(this._autoPoll=h.autoPoll?!0:!1,this._pollInterval=h.pollInterval?h.pollInterval:0)};return{ZWAY_FILE:"zwave.json",_logger:require("x.logger.js").getLogger("x.hub.m.zway.SettingsManager"),_handler:null,_settings:{},init:function(h,f){this._logger.log("trace","init");this._handler=h;var g=this;this._loadSettings(function(m,q){m&&g._logger.log("warn","init error:"+m.message);q&&(g._settings=
q,g._initSettings());f&&f()})},setSetting:function(h,f,g){if(this._handler.getZway().getDevice(h)){var m=this._settings[h];m&&m.stop();m=new l(this,h);m.fromJSON(f);this._settings[h]=m;m.start();this._saveSettings(function(q){g&&g(q?q:null,q?null:m)})}else g&&g(Error("no such device:"+h))},getSetting:function(h,f){if(this._handler.getZway().getDevice(h)){var g=this._settings[h];g||(g=new l(this,h));f&&f(null,g)}else f&&f(Error("no such device:"+h))},deleteSetting:function(h,f){if(this._handler.getZway().getDevice(h)){var g=
this._settings[h];g||(g.stop(),delete this._settings[h]);this._saveSettings(f)}else f&&f(Error("no such device:"+h))},_startPoller:function(h){this._handler.startPoller(h.getDeviceID(),h.getPollInterval())},_stopPoller:function(h){this._handler.stopPoller(h.getDeviceID())},_initSettings:function(){for(var h in this._settings){var f=this._settings[h];f&&f.init()}},_loadSettings:function(h){var f=this;this._loadFile(function(g,m){g?h&&h(g):(g=f._jsonToSettingsMap(m),h&&h(null,g))})},_jsonToSettingsMap:function(h){if(!h)return{};
var f={},g;for(g in h){var m=h[g];if(m){var q=new l(this,g);q.fromJSON(m);f[g]=q}}return f},_loadFile:function(h){var f=this._getFilePath();fs_extra.ensureFile(f,function(g){g?h&&h(g):fs_extra.readFile(f,"utf8",function(m,q){if(m)h&&h(m);else if(q)try{var a=JSON.parse(q);h&&h(null,a)}catch(c){h&&h(c)}else h&&h(null,{})})})},_getFilePath:function(){var h=fileman.fileManager.getUserRootDataPath();return path.resolve(h,this.ZWAY_FILE)},_saveSettings:function(h){var f=this._settingsMapToJson(this._settings);
this._saveFile(f,function(g){h&&h(g)})},_settingsMapToJson:function(h){if(!h)return{};var f={},g;for(g in h){var m=h[g];m&&(m=m.toJSON(),f[g]=m)}return f},_saveFile:function(h,f){var g=this._getFilePath();fs_extra.writeFile(g,JSON.stringify(h,null,2),function(m){f&&f(m)})}}}();
x.hub.m.zway.ZWay=function(){var l={_buffer:{},updateState:function(a,c){if(!c)return!1;var b=this._buffer[a];this._buffer[a]=c;if(!b)return!0;a=!1;for(var d in c)c[d]!=b[d]&&(a=!0);return a}},h={sendSTAEvent:function(a){var c=require("x.hub.eventbus.js");c.emit("gatewayevent",a,{address:"ZWAVE"},"STA");c.emit("udpevent",a,"STA")}},f={_alarms:{},_alarmEvents:{},setAlarm:function(a,c){this._alarms[a]=c},getAlarm:function(a){return this._alarms[a]},setAlarmEvent:function(a,c){this._alarmEvents[a]=c},
getAlarmEvent:function(a){return this._alarmEvents[a]},deleteAlarmEvent:function(a){delete this._alarmEvents[a]}},g=function(a){this.INTERVIEW_TIMEOUT=2E4;this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay.LearnHandler");this._zway=a;this._inclusion=!1;this._inclusionDeviceId=this._inclusionCB=this._inclusionListener=this._inclusionTO=null;this._inclusionInterViewProgress=0;this._inclusionInterViewTO=null;this._exclusion=!1;this._exclusionDeviceId=this._exclusionCB=this._exclusionTO=
null;this._updateInterview=this._exclusionAny=!1;this._updateInterviewCommandClassID=this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;var c=this;this._dataUpdateListener=function(b){c._onDataUpdate(b)}};g.prototype.inclusion=function(a,c){if(this._inclusion){var b=Error("inclusion process running");b.code="08001";c&&c(b)}else if(this._exclusion)b=Error("exclusion process running"),
b.code="08002",c&&c(b);else if(this._updateInterview)b=Error("update interview process running"),b.code="08006",c&&c(b);else{this._logger.log("info","start inclusion");var d=this;this._inclusionListener=a;this._inclusionCB=c;this._inclusionTO=setTimeout(function(){b=Error("inclusion timeout");b.code="08003";d._inclusionFinish(b)},2E4);this._inclusionListener&&this._inclusionListener(1,0,"start inclusion");this._zway.addDataUpdateListener(this._dataUpdateListener);this._inclusion=!0;this._zway._startInclusion(function(e){e?
d._inclusionFinish(e):d._inclusionListener&&d._inclusionListener(2,0,"set device")})}};g.prototype.exclusion=function(a,c){if(this._inclusion){var b=Error("inclusion process running");b.code="08001";c&&c(b)}else if(this._exclusion)b=Error("exclusion process running"),b.code="08002",c&&c(b);else if(this._updateInterview)b=Error("update interview process running"),b.code="08006",c&&c(b);else{this._logger.log("info","start exclusion");var d=this;this._exclusionCB=c;this._exclusionTO=setTimeout(function(){b=
Error("exclusion timeout");b.code="08005";d._exclusionFinish(b)},2E4);this._zway.addDataUpdateListener(this._dataUpdateListener);this._exclusion=!0;-1==a&&(this._exclusionAny=!0);this._zway._startExclusion(function(e){e&&d._exclusionFinish(e)})}};g.prototype.updateInterview=function(a,c,b,d,e){if(this._inclusion){var k=Error("inclusion process running");k.code="08001";e&&e(k)}else if(this._exclusion)k=Error("exclusion process running"),k.code="08002",e&&e(k);else if(this._updateInterview)k=Error("update interview process running"),
k.code="08006",e&&e(k);else if(a)if(this._zway.getDevice(a)){var n=this._updateInterviewProgress=this._zway.getInterviewProgress(a);if(100==n)e&&e(null,this._zway.getSimplifiedJSON(a));else{this._logger.log("info","update interview for device:"+a);var p=this;this._updateInterviewCB=e;this._updateInterviewDeviceId=a;this._updateInterviewInstanceID=c;this._updateInterviewCommandClassID=b;this._updateInterviewListener=d;this._updateInterviewTO=setTimeout(function(){k=Error("update interview timeout");
k.code="08008";p._updateInterviewFinish(k,p._updateInterviewDeviceId)},1E4);this._zway.addDataUpdateListener(this._dataUpdateListener);this._updateInterview=!0;this._updateInterviewProgress=n;this._updateInterviewListener&&this._updateInterviewListener(1,n,"start update interview");this._zway._startUpdateInterview(a,c,b,function(r){r&&p._updateInterviewFinish(r)})}}else k=Error("update interview deviceID invalid"),k.code="08006",e&&e(k);else k=Error("update interview deviceID invalid"),k.code="08006",
e&&e(k)};g.prototype._inclusionFinish=function(a,c){a?this._logger.log("warn","inclusion finish with error:"+a.stack):this._logger.log("info","inclusion finish:"+c);this._inclusionTO&&clearTimeout(this._inclusionTO);this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO);var b=this;this._zway._stopInclusion(function(){b._zway.removeDataUpdateListener(b._dataUpdateListener);var d=b._inclusionCB;b._inclusion=!1;b._inclusionTO=null;b._inclusionListener=null;b._inclusionCB=null;b._inclusionInterViewProgress=
0;b._inclusionInterViewTO=null;b._inclusionDeviceId=null;setTimeout(function(){var e=null;c&&(e=b._zway.getSimplifiedJSON(c));e&&(e.interViewDone=!0);a&&"08004"==a.code&&e&&(a=null,e.interViewDone=!1);d&&d(a,e)},5E3)})};g.prototype._exclusionFinish=function(a,c){a?this._logger.log("warn","exclusion finish with error:"+a.stack):this._logger.log("info","exclusion finish:"+c);this._exclusionTO&&clearTimeout(this._exclusionTO);var b=this;setTimeout(function(){b._zway._stopExclusion(function(){b._zway.removeDataUpdateListener(b._dataUpdateListener);
var d=b._exclusionCB;b._exclusion=!1;b._exclusionTO=null;b._exclusionCB=null;b._exclusionDeviceId=null;b._exclusionAny=!1;d&&d(a,c)})},1E3)};g.prototype._updateInterviewFinish=function(a,c){a?this._logger.log("warn","update interview finish with error:"+a.stack):this._logger.log("info","update interview finish:"+c);var b=null;c&&(b=this._zway.getSimplifiedJSON(c));this._updateInterviewTO&&clearTimeout(this._updateInterviewTO);this._zway.removeDataUpdateListener(this._dataUpdateListener);c=this._updateInterviewCB;
this._updateInterview=!1;this._updateInterviewCommandClassID=this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;c&&c(a,b)};g.prototype._onDataUpdate=function(a){this._logger.log("debug","on data update");this._logger.log("debug",JSON.stringify(a,null,2));a&&(this._inclusion?this._onInclusionDataUpdate(a):this._exclusion?this._onExclusionDataUpdate(a):this._updateInterview&&
this._onUpdateInterviewDataUpdate(a))};g.prototype._onInclusionDataUpdate=function(a){if(!this._inclusionDeviceId&&a["controller.data.lastIncludedDevice"]){var c=a["controller.data.lastIncludedDevice"].value;c&&(this._inclusionDeviceId=c,this._inclusionTO&&(clearTimeout(this._inclusionTO),this._inclusionTO=null),this._inclusionListener&&this._inclusionListener(3,0,"run interview"))}var b=this;c=null;this._inclusionDeviceId&&(c=this._zway.getDevice(this._inclusionDeviceId),this._inclusionInterViewTO||
(this._inclusionInterViewTO=setTimeout(function(){var u=Error("interview timeout");u.code="08004";b._inclusionFinish(u,b._inclusionDeviceId)},this.INTERVIEW_TIMEOUT)));if(c&&c.instances){var d=0,e=0;for(r in c.instances){var k=c.instances[r];if(k&&k.commandClasses)for(var n in k.commandClasses){var p=k.commandClasses[n];p&&p.data&&p.data.interviewDone&&(d+=1,p.data.interviewDone.value&&(e+=1))}}var r=!1;for(var t in a)if(0==t.indexOf("devices."+this._inclusionDeviceId)){r=!0;break}a=0;if(c.data&&
c.data.interviewDone&&c.data.interviewDone.value)a=100,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._logger.log("debug","inclusion progress:"+a),this._inclusionListener&&this._inclusionListener(3,a,"run interview");else if(0!=d&&0!=e){a=Math.round(e/d*100);if(a!=this._inclusionInterViewProgress||r)this._inclusionInterViewProgress=a,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._inclusionInterViewTO=setTimeout(function(){var u=Error("interview timeout");
u.code="08004";b._inclusionFinish(u,b._inclusionDeviceId)},this.INTERVIEW_TIMEOUT);this._logger.log("debug","inclusion progress:"+a);this._inclusionListener&&this._inclusionListener(3,a,"run interview")}100==a&&this._inclusionFinish(null,this._inclusionDeviceId)}};g.prototype._onExclusionDataUpdate=function(a){a["controller.data.lastExcludedDevice"]&&(a=a["controller.data.lastExcludedDevice"].value,this._exclusionAny?"undefined"!=typeof a&&null!=a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),
this._exclusionTO=null),this._exclusionFinish(null,-1)):a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,this._exclusionDeviceId)))};g.prototype._onUpdateInterviewDataUpdate=function(a){var c=this;a=this._zway.getInterviewProgress(this._updateInterviewDeviceId);a!=this._updateInterviewProgress&&(this._updateInterviewProgress=a,this._updateInterviewTO&&clearTimeout(this._updateInterviewTO),this._updateInterviewTO=setTimeout(function(){var b=
Error("update interview timeout");b.code="08008";c._updateInterviewFinish(b,c._updateInterviewDeviceId)},1E4));this._logger.log("debug","update interview progress:"+a);this._updateInterviewListener&&this._updateInterviewListener(2,a,"run interview");"undefined"!=typeof this._updateInterviewInstanceID&&null!=this._updateInterviewInstanceID&&this._updateInterviewCommandClassID?(a=this._zway.listInterviewResults(this._updateInterviewDeviceId))&&a[this._updateInterviewInstanceID]&&a[this._updateInterviewInstanceID].commandClasses&&
a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID]&&a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID].interviewDone&&this._updateInterviewFinish(null,this._updateInterviewDeviceId):100==a&&this._updateInterviewFinish(null,this._updateInterviewDeviceId)};var m={LIST:[37,38,48,49,50,51,64,66,67,68,69,91,98,113,128,156],getCommandClassFromId:function(a){if(!a)return null;a=parseInt(a);if(isNaN(a)||-1==this.LIST.indexOf(a))return null;
switch(a){case 37:return this.SwitchBinary;case 38:return this.SwitchMultilevel;case 48:return this.SensorBinary;case 49:return this.SensorMultilevel;case 50:return this.Meter;case 51:return this.SwitchColor;case 64:return this.ThermostatMode;case 66:return this.ThermostatOperatingState;case 67:return this.ThermostatSetPoint;case 68:return this.ThermostatFanMode;case 69:return this.ThermostatFanState;case 91:return this.CentralScene;case 98:return this.DoorLock;case 113:return this.Alarm;case 128:return this.Battery;
case 156:return this.AlarmSensor}},SwitchBinary:{buildCMD:function(a,c,b){return a?"on"==a.value?"Set(true)":"off"==a.value?"Set(false)":"toggle"==a.value&&b&&b.data&&b.data.level?(a=b.data.level.value)?"Set(false)":"Set(true)":null:null},resolveState:function(a){return a&&a.data&&a.data.level?[{id:"37",state:a.data.level.value?"on":"off"}]:null},getSimplifiedJSON:function(a){return a&&a.data&&a.data.level?{37:{type:"SwitchBinary",valueType:a.data.level.type}}:null}},SwitchColor:{buildCMD:function(a,
c,b){if(!a)return null;c={whiteWarm:0,whiteCold:1,red:2,green:3,blue:4};if(0===a.value.indexOf("rgb")&&3<a.value.length)b=a.value.substr(3),a.value="rgb",a.ext=b;else for(var d in c)if(0===a.value.indexOf(d)&&a.value.length>d.length){b=a.value.substr(d.length);a.value=d;a.ext=b;break}if("rgb"===a.value){if("string"!==typeof a.ext||6>a.ext.length)return null;b=String(a.ext).split("_");a=b[0];d=255;"#"===a[0]&&(a=a.substr(1));1<b.length&&(d=parseInt(b[1],10),d=isNaN(d)?255:Math.min(254,Math.max(0,d)));
c=parseInt(a.substr(0,2),16);b=parseInt(a.substr(2,2),16);a=parseInt(a.substr(4,2),16);a="SetMultiple([0,1,2,3,4],[0,0,"+(c+","+b+","+a)+"]";255>d&&(a+=","+d);return a+")"}if("number"===typeof c[a.value]){if("undefined"===typeof a.ext)return null;b=String(a.ext).split("_");var e=parseInt(b[0],10);d=255;if(isNaN(e))return null;1<b.length&&(d=parseInt(b[1],10),d=isNaN(d)?255:Math.min(254,Math.max(0,d)));e=Math.min(100,Math.max(0,e));e=Math.round(2.55*e);c=[c[a.value]];b=[e];"whiteWarm"===a.value||"whiteCold"===
a.value?("whiteWarm"===a.value?c.push(1):c.push(0),c.push(2,3,4),b.push(0,0,0,0)):(c.push(0,1),b.push(0,0));a="SetMultiple(["+c.join(",")+"],["+b.join(",")+"]";255>d&&(a+=","+d);return a+")"}return null},resolveState:function(a){if(!a||!a.data)return null;var c=[{id:"51",state:null}],b=-1,d=-1,e=-1,k;for(k in a.data){var n=parseInt(k);if(!isNaN(n)){var p=a.data[k];p&&(2===n?b=p.level.value:3===n?d=p.level.value:4===n&&(e=p.level.value),n=Math.round(p.level.value/2.55),c=c||[],c.push({id:"51."+k,state:n}))}}-1<
b&&-1<d&&-1<e&&(b=Number(b).toString(16),d=Number(d).toString(16),e=Number(e).toString(16),2>b.length&&(b="0"+b),2>d.length&&(d="0"+d),2>e.length&&(e="0"+e),c[0].state=b+d+e);return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c={51:{name:"RGB",type:"SwitchColor",valueType:"string"}},b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.capabilityString&&d.level&&(c=c||{},c["51."+b]={name:d.capabilityString.value,type:"SwitchColor",valueType:d.level.type})}return c}},
SwitchMultilevel:{buildCMD:function(a,c,b){if(!a)return null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(c=a.value.substr(8),a.value="toggleTo",a.ext=c):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(c=a.value.substr(7),a.value="valueTo",a.ext=c);var d;switch(a.value){case "on":return"Set(255,0)";case "off":return b&&b.data&&(b.data.level={value:0}),"Set(0,0)";case "toggle":if(b&&b.data&&b.data.level){if(d=b.data.level.value)b.data.level={value:0};return d?"Set(0,0)":"Set(255,0)"}break;
case "toggleTo":if("undefined"==typeof a.ext||null==a.ext)break;if(b&&b.data&&b.data.level){if(d=b.data.level.value)return"Set(0,0)";d=Math.round(parseInt(a.ext)/100*99);99<d&&(d=99);0>d&&(d=0);b&&b.data&&(b.data.level={value:d});return"Set("+d+",0)"}break;case "stop":return"StopLevelChange()";case "up":return"Set(99)";case "down":return"Set(0)";case "stepUp":c=5;if("undefined"!=typeof a.ext||null!=a.ext)c=parseInt(a.ext);if(b&&b.data&&b.data.level)return d=b.data.level.value,d=Math.round(parseInt(d)/
99*100),d+=c,100<d&&(d=100),d=Math.round(parseInt(d)/100*99),b&&b.data&&(b.data.level={value:d}),"Set("+d+",0)";break;case "stepDown":c=5;if("undefined"!=typeof a.ext||null!=a.ext)c=parseInt(a.ext);if(b&&b.data&&b.data.level)return d=b.data.level.value,d=Math.round(parseInt(d)/99*100),d-=c,0>d&&(d=0),d=Math.round(parseInt(d)/100*99),b&&b.data&&(b.data.level={value:d}),"Set("+d+",0)";break;case "valueTo":if("undefined"!=typeof a.ext&&null!=a.ext)return d=Math.round(parseInt(a.ext)/100*99),99<d&&(d=
99),0>d&&(d=0),b&&b.data&&(b.data.level={value:d}),"Set("+d+",0)"}return null},resolveState:function(a){return a&&a.data&&a.data.level?[{id:"38",state:Math.round(parseInt(a.data.level.value)/99*100)}]:null},getSimplifiedJSON:function(a){return a&&a.data&&a.data.level?{38:{type:"SwitchMultilevel",valueType:a.data.level.type}}:null}},SensorMultilevel:{resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)){var e=a.data[b];e&&e.val&&(c||(c=[]),
c.push({id:"49."+d,state:e.val.value}))}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.sensorTypeString&&d.scaleString&&d.val&&(c||(c={}),c["49."+b]={name:d.sensorTypeString.value,unit:d.scaleString.value,valueType:d.val.type,type:"SensorMultilevel"})}return c}},SensorBinary:{resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)){var e=a.data[b];
e&&e.level&&(c||(c=[]),c.push({id:"48."+d,state:e.level.value}))}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.sensorTypeString&&d.level&&(c||(c={}),c["48."+b]={name:d.sensorTypeString.value,type:"SensorBinary"})}return c}},Meter:{buildCMD:function(a,c,b){return a?"reset"==a.value?"Reset()":null:null},resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)){var e=
a.data[b];e&&e.val&&(c||(c=[]),c.push({id:"50."+d,state:e.val.value}))}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.sensorTypeString&&d.scaleString&&d.val&&(c||(c={}),c["50."+b]={name:d.sensorTypeString.value,unit:d.scaleString.value,valueType:d.val.type,type:"Meter"})}return c}},ThermostatSetPoint:{buildCMD:function(a,c,b){if(!a)return null;if(5<a.value.length&&"setTo"==a.value.substr(0,5)){var d=a.value.substr(5);
a.value="setTo";a.ext=d}else 2<a.value.length&&"up"==a.value.substr(0,2)?(d=a.value.substr(2),a.value="up",a.ext=d):4<a.value.length&&"down"==a.value.substr(0,4)&&(d=a.value.substr(4),a.value="down",a.ext=d);c=c[c.length-1];switch(a.value){case "up":d=.5;if("undefined"!=typeof a.ext||null!=a.ext)d=parseFloat(a.ext);if(b&&b.data&&b.data[c]&&b.data[c].setVal){a=b.data[c];var e=a.setVal.value;e+=d;a.max&&e>a.max.value&&(e=a.max.value);b.data[c].setVal.value=e;return"Set("+c+","+e+")"}break;case "down":d=
.5;if("undefined"!=typeof a.ext||null!=a.ext)d=parseFloat(a.ext);if(b&&b.data&&b.data[c]&&b.data[c].setVal)return a=b.data[c],e=a.setVal.value,e-=d,a.min&&e<a.min.value&&(e=a.min.value),b.data[c].setVal.value=e,"Set("+c+","+e+")";break;case "setTo":if("undefined"!=typeof a.ext&&null!=a.ext&&(e=parseFloat(a.ext),b&&b.data&&b.data[c]&&b.data[c].setVal))return b.data[c].setVal.value=e,"Set("+c+","+e+")"}return null},resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=
parseInt(b);if(!isNaN(d)){var e=a.data[b];if(e&&e.val){var k=e.val.value;k=e.setVal?k+(":"+e.setVal.value):k+(":"+k);c||(c=[]);c.push({id:"67."+d,state:k})}}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)&&(d=a.data[b])&&d.modeName&&d.scaleString&&d.val){c||(c={});var e={name:d.modeName.value,unit:d.scaleString.value,valueType:d.val.type,type:"ThermostatSetPoint"};d.min&&(e.min=d.min.value);d.max&&(e.max=d.max.value);
c["67."+b]=e}}return c}},ThermostatMode:{_MODES:["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"],buildCMD:function(a,c,b){if(!a)return null;13<a.value.length&&"setThermoMode"==a.value.substr(0,13)&&(c=a.value.substr(13),a.value="setThermoMode",a.ext=c);switch(a.value){case "thermoModeOff":return"Set(0)";case "thermoModeHeat":return"Set(1)";case "thermoModeCool":return"Set(2)";
case "thermoModeAuto":return"Set(3)";case "setThermoMode":return"Set("+a.ext+")"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var c=[];c.push({id:"64",state:a.data.mode.value});return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.modeName&&d.modeName.value&&(c||(c={}),c[b]=d.modeName.value)}return{64:{type:"ThermostatMode",valueType:"int",modes:c}}}},ThermostatOperatingState:{_MODES:"IDLE HEATING COOLING FAN_ONLY PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" "),
resolveState:function(a){if(!a||!a.data||!a.data.state)return null;var c=[];c.push({id:"66",state:a.data.state.value});return c},getSimplifiedJSON:function(a){return a&&a.data?{66:{type:"ThermostatOperatingState",valueType:a.data.state.type}}:null}},ThermostatFanMode:{_MODES:"AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" "),buildCMD:function(a,c,b){if(!a)return null;16<a.value.length&&"setThermoFanMode"==a.value.substr(0,16)&&
(c=a.value.substr(16),a.value="setThermoFanMode",a.ext=c);c="Off"==a.ext?0:1;switch(a.value){case "thermoFanModeAutoLow":return"Set("+c+",0)";case "thermoFanModeLow":return"Set("+c+",1)";case "thermoFanModeAutoHigh":return"Set("+c+",2)";case "thermoFanModeHigh":return"Set("+c+",3)";case "setThermoFanMode":return c?"Set("+c+","+a.ext+")":"Set("+c+",1)"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var c=[],b={id:"68",state:a.data.mode.value};a.data&&a.data.on&&!a.data.on.value&&
(b={id:"68",state:"off"});c.push(b);return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.modeName&&d.modeName.value&&(c||(c={}),c[b]=d.modeName.value)}return{68:{type:"ThermostatFanMode",valueType:"int",modes:c}}}},ThermostatFanState:{resolveState:function(a){if(!a||!a.data||!a.data.state)return null;var c=[];c.push({id:"69",state:a.data.state.value?"on":"off"});return c},getSimplifiedJSON:function(a){return a&&
a.data&&"ThermostatFanState"==a.name?{69:{type:"ThermostatFanState"}}:null}},CentralScene:{resolveState:function(a,c,b){if(!(a&&a.data&&a.data.currentScene&&a.data.keyAttribute)||a.data.currentScene.value)return null},resolveUpdate:function(a,c,b){if(!(a&&a.data&&a.data.currentScene&&a.data.keyAttribute))return null;var d=a.data.currentScene.value;if(d){var e=null;switch(a.data.keyAttribute.value){case 0:e="press";break;case 1:e="release";break;case 2:e="hold"}if(!e)return null;a={};a[b+"."+c+".91."+
d]=e;h.sendSTAEvent({type:"ZWAVE2",adr:b,state:a});return null}},getSimplifiedJSON:function(a){if(!a||!a.data||!a.data.maxScenes)return null;var c={};a=a.data.maxScenes.value;for(var b=1;b<=a;b++)c["91."+b]={name:"Key "+b,type:"CentralScene"};return c}},Alarm:{_EVNETS:{1:{1:"Smoke",2:"Smoke",3:"Smoke Alarm Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance",8:"Maintenance Dust"},2:{1:"CO",2:"CO",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",
7:"Maintenance"},3:{1:"CO2",2:"CO2",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance"},4:{1:"Overheat",2:"Overheat",3:"Rapid Temperature Rise",4:"Rapid Temperature Rise",5:"Under Heat",6:"Under Heat",7:"Heat Alarm Test",8:"Replacement End-of-life",9:"Alarm Silenced",10:"Maintenance Dust",11:"Maintenance"},5:{1:"Water Leak",2:"Water Leak",3:"Water Level Dropped",4:"Water Level Dropped",5:"Replace Water Filter",6:"Water Flow Alarm",7:"Water Pressure Alarm"},
6:{1:"Manual Lock",2:"Manual Unlock",3:"RF Lock",4:"RF Unlock",5:"Keypad Lock",6:"Keypad Unlock",7:"Manual Not Fully Locked",8:"RF Not Fully Locked",9:"Auto Lock Locked",10:"Auto Lock Not Fully Locked",11:"Lock Jammed",22:"Contact Opened",23:"Contact Closed"},7:{1:"Intrusion",2:"Intrusion",3:"Tampering",4:"Tampering",5:"Glass Breakage",6:"Glass Breakage",7:"Motion Detection",8:"Motion Detection",9:"Motion Detection"},8:{1:"Power has been applied",10:"Replace battery soon",11:"Replace battery now",
14:"Charge battery soon",15:"Charge battery now"}},buildCMD:function(a,c,b){if(!a||!c)return null;c=c[c.length-1];if("on"==a.value)return"Set("+c+",255)";if("off"==a.value)return"Set("+c+",0)";if("toggle"==a.value){if(b&&b.data&&b.data[c]&&(b=b.data[c].status))return(b=b.value)?"Set("+c+",0)":"Set("+c+",255)"}else if("resetAlarm"==a.value){if(b&&b.data)for(c in b.data)if(a=parseInt(c),!isNaN(a)){var d=b.data[c];if(d&&d.status&&(f.setAlarmEvent("113."+a,0),d.event&&d.event.value&&(f.setAlarm("113."+
a+"."+d.event.value,!1),d.event.value=null),d.eventMask&&d.eventMask.value))for(var e=1;255>=e;e++)x.hub.m.zway.Util.hasEvent(this,a,d.eventMask,e)&&f.getAlarm("113."+a+"."+e,!1)}return-1}return null},resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)){var e=a.data[b];if(e&&e.status){c||(c=[]);var k={id:"113."+d,state:e.status.value?"on":"off"};c.push(k);if(e.event)if(f.setAlarmEvent("113."+d,e.event.value),k={id:"113."+d+".event",state:e.event.value},
c.push(k),e.event.value&&this._EVNETS[d]&&this._EVNETS[d][e.event.value]?c.push({id:"113."+d+".eventName",state:this._EVNETS[d][e.event.value]}):0==e.event.value&&c.push({id:"113."+d+".eventName",state:"No Alarm"}),e.event.value)f.setAlarm("113."+d+"."+e.event.value,!0);else if(0==e.event.value&&e.eventParameters&&e.eventParameters.value)if(k=e.eventParameters.value,0==k.length){if(e.eventMask&&e.eventMask.value)for(var n=1;255>=n;n++)(k=x.hub.m.zway.Util.hasEvent(this,d,e.eventMask,n))&&f.setAlarm("113."+
d+"."+n,!1)}else for(n=0;n<k.length;n++)f.setAlarm("113."+d+"."+k[n],!1);if(e.eventMask&&e.eventMask.value)for(n=1;255>=n;n++)if(k=x.hub.m.zway.Util.hasEvent(this,d,e.eventMask,n)){k={id:"113."+d+"."+n,state:!1};var p=f.getAlarm("113."+d+"."+n);p&&(k.state=p);c.push(k)}}}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);if(!isNaN(d)){var e=a.data[b];if(e&&e.typeString&&e.status&&(c||(c={}),c["113."+b]={name:e.typeString.value,subtype:b,
type:"Alarm"},e.eventMask&&e.eventMask.value))for(var k=1;255>=k;k++){var n=x.hub.m.zway.Util.hasEvent(this,d,e.eventMask,k);n&&(c["113."+b+"."+k]={name:n,eventID:k,type:"Alarm.Event"})}}}return c}},Battery:{resolveState:function(a){return a&&a.data&&a.data.last?[{id:"128",state:a.data.last.value}]:null},getSimplifiedJSON:function(a){return a&&a.data?{128:{name:"Battery",valueType:"int",type:"Battery"}}:null}},AlarmSensor:{resolveState:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=
parseInt(b);if(!isNaN(d)){var e=a.data[b];e&&e.sensorState&&(c||(c=[]),c.push({id:"156."+d,state:e.sensorState.value?"on":"off"}))}}return c},getSimplifiedJSON:function(a){if(!a||!a.data)return null;var c=null,b;for(b in a.data){var d=parseInt(b);isNaN(d)||(d=a.data[b])&&d.typeString&&(c||(c={}),c["156."+b]={name:d.typeString.value,subtype:b,type:"AlarmSensor"})}return c}},DoorLock:{_MODE:{0:"unlock",1:"unlock_with_timeout",16:"inside_handle_unlock",17:"inside_handle_unlock_with_timeout",32:"outside_handle_unlock",
33:"outside_handle_unlock_with_timeout",254:"unknown",255:"lock"},buildCMD:function(a,c,b){if(!a)return null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(c=a.value.substr(8),a.value="toggleTo",a.ext=c):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(c=a.value.substr(7),a.value="valueTo",a.ext=c);switch(a.value){case "unlock":return"Set(0)";case "unlock_with_timeout":return"Set(1)";case "inside_handle_unlock":return"Set(16)";case "inside_handle_unlock_with_timeout":return"Set(17)";case "outside_handle_unlock":return"Set(32)";
case "outside_handle_unlock_with_timeout":return"Set(33)";case "lock":return"Set(255)"}return null},resolveState:function(a){if(!a||!a.data)return null;var c=[];if(a.data.mode){var b=this._MODE[a.data.mode.value];b&&c.push({id:"98.mode",state:b})}a.data.opType&&c.push({id:"98.op_mode",state:1==a.data.opType.value?"constant":"autolock"});return 0==c.length?null:c},getSimplifiedJSON:function(a){return a&&a.data?{98:{name:"DoorLock",type:a.name}}:null}}},q=function(a,c,b,d){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay");
this._learnHandler=new g(this);this._ip=a;this._port=c;this._username=b;this._password=d;this._data=null;this._dataUpdateListeners=[];this._dataUpdateRunning=!1;this._dataUpdateCB=[];this._dataUpdatePeriod=1E3;this._dataUpdateTO=null;this._dataFullRunning=!1;this._dataFullCB=[];this._dataFullPeriod=1E4;this._running=!1};q.prototype.start=function(a){this._running||(this._running=!0,this._getDataFull());a&&a()};q.prototype.stop=function(a){this._running&&(this._running=!1);this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),
this._dataUpdateTO=null);a&&a()};q.prototype.addDataUpdateListener=function(a){a&&-1==this._dataUpdateListeners.indexOf(a)&&this._dataUpdateListeners.push(a)};q.prototype.removeDataUpdateListener=function(a){a&&(a=this._dataUpdateListeners.indexOf(a),-1!=a&&this._dataUpdateListeners.splice(a,1))};q.prototype.getData=function(){return this._data};q.prototype.getDevices=function(){return this._data&&this._data.devices?this._data.devices:null};q.prototype.getDevice=function(a){return a&&this._data&&
this._data.devices?this._data.devices[a]:null};q.prototype.getSimplifiedJSON=function(a){if(!this._data||!this._data.devices||!this._data.devices[a])return null;var c=this._data.devices[a];if(!c.data||!c.instances)return null;var b=c.data,d={};d.id=a;d.basicType=b.basicType?b.basicType.value:null;d.genericType=b.genericType?b.genericType.value:null;d.specificType=b.specificType?b.specificType.value:null;d.type=b.deviceTypeString?b.deviceTypeString.value:null;d.vendor=b.vendorString?b.vendorString.value:
null;d.name=b.givenName?b.givenName.value:null;d.interViewProgress=this.getInterviewProgress(a);b=this.listInterviewResults(a);d.instanceInterViewProgress={};for(var e in b)if(b[e]&&b[e].commandClasses){a=b[e].commandClasses;var k=0,n=0,p;for(p in a)k+=1,a[p]&&a[p].interviewDone&&(n+=1);d.instanceInterViewProgress[e]=Math.round(100*n/k)}d.instance={};c=c.instances;for(e in c)if((a=c[e])&&a.commandClasses){d.instance[e]={commandClasses:{}};a=a.commandClasses;for(var r in a)if(p=a[r])if(b=null,(k=m.getCommandClassFromId(r))&&
(b=k.getSimplifiedJSON(p)),b)for(var t in b)d.instance[e].commandClasses[t]=b[t]}return d};q.prototype.getInterviewProgress=function(a){a=this.getDevice(a);if(!a)return-1;var c=0,b=0,d;for(d in a.instances){var e=a.instances[d];if(e&&e.commandClasses)for(var k in e.commandClasses){var n=e.commandClasses[k];n&&n.data&&n.data.interviewDone&&(c+=1,n.data.interviewDone.value&&(b+=1))}}return Math.round(b/c*100)};q.prototype.listInterviewResults=function(a){a=this.getDevice(a);if(!a)return null;var c=
{},b;for(b in a.instances){var d=a.instances[b];if(d&&d.commandClasses)for(var e in d.commandClasses){var k=d.commandClasses[e];k&&k.data&&k.data.interviewDone&&(c[b]||(c[b]={commandClasses:{}}),c[b].commandClasses[e]={interviewDone:k.data.interviewDone.value})}}return c};q.prototype.executeCommand=function(a,c,b){if(a&&c){c.value||(c={value:c});var d=a.split(".");if(3>d.length)b&&b(Error("address invalid"));else if(this._data&&this._data.devices){var e=this._data.devices[d[0]];if(e)if(e.instances&&
e.instances[d[1]]){var k=e.instances[d[1]];if(k.commandClasses&&k.commandClasses[d[2]]){k=k.commandClasses[d[2]];var n=null,p=m.getCommandClassFromId(d[2]);p&&(n=p.buildCMD(c,d,k));if(n)if(-1==n)b&&b();else{var r=this;this._doRunRequest("devices["+d[0]+"].instances["+d[1]+"].commandClasses["+d[2]+"]."+n,null,function(t){t||r._postCommandExecution(e,a);b&&b(t)})}else b&&b(Error("command invalid"))}else b&&b(Error("no such command class:"+d[2]))}else b&&b(Error("no such instance:"+d[1]));else b&&b(Error("no such device with id:"+
d[0]))}else b&&b(Error("initialization not finish"))}else b&&b(Error("address or command is null"))};q.prototype._postCommandExecution=function(a,c){a&&c&&a.data&&a.data.vendorString&&"Fibaro"==a.data.vendorString.value&&(a=c.split("."),"64"!=a[2]&&"67"!=a[2]||setTimeout(function(){x.hub.m.zway.PollManager._pollCommandClass([c])},2E3))};q.prototype.getStates=function(a){var c=this._getStates();a&&a(null,c)};q.prototype._getStates=function(){if(!this._data||!this._data.devices)return{};var a={},c;
for(c in this._data.devices)if(1!=c){var b=this._getState(c);if(b)for(var d in b)a[d]=b[d]}return a};q.prototype._getState=function(a){return this._data&&this._data.devices?this._resolveDeviceState(a,this._data.devices[a]):null};q.prototype._resolveDeviceState=function(a,c){if(!c)return null;var b={};if(c&&c.instances)for(var d in c.instances){var e=c.instances[d];if(e.commandClasses)for(var k in e.commandClasses){var n=e.commandClasses[k],p=null,r=m.getCommandClassFromId(k);r&&(p=r.resolveState(n,
d,a));if(p)for(n=0;n<p.length;n++){var t=r=null;p[n].id&&(r=a+"."+d+"."+p[n].id);"undefined"!=typeof p[n].state&&null!=p[n].state&&(t=p[n].state);r&&"undefined"!=typeof t&&null!=t&&(b[a]||(b[a]={}),b[a][r]=t)}}}return b};q.prototype.inclusion=function(a,c){this._learnHandler.inclusion(a,c)};q.prototype.exclusion=function(a,c){this._learnHandler.exclusion(a,c)};q.prototype.updateInterview=function(a,c,b,d,e){this._learnHandler.updateInterview(a,c,b,d,e)};q.prototype.resetController=function(a){this._resetController(a)};
q.prototype.backup=function(a,c){this._logger.log("debug","backup zwave to folder:"+a);var b={host:this._ip,port:this._port,path:"/ZWaveAPI/Backup",method:"GET"};this._username&&(b.auth=this._username+":"+(this._password?this._password:""));this._logger.log("trace","send http request:"+JSON.stringify(b));var d=c,e=this;c=require("http").request(b,function(k){if(200!=k.statusCode)d&&d(Error("http status code:"+k.statusCode)),d=null;else{var n=require("fs"),p=require("path").join(a,"z-way-backup.zbk");
if(n.existsSync(p))try{n.unlinkSync(p)}catch(t){d&&d(t);d=null;return}var r=n.createWriteStream(p);k.pipe(r);r.on("finish",function(){r.close(function(){d&&d(null,p);d=null})});r.on("error",function(t){n.unlink(p);d&&d(t);d=null})}});c.on("error",function(k){e._logger.log("trace","http request error:"+k.stack);d&&d(k);d=null});c.setTimeout(1E4,function(){e._logger.log("trace","http request timeout");d&&d(Error("http timeout"));d=null});c.end()};q.prototype.restore=function(a,c,b){this._logger.log("debug",
"restore zwave (restoreStick="+c+") from file:"+a);var d=require("form-data"),e=require("fs");d=new d;d.append("config_backup",e.createReadStream(a));a={host:this._ip,port:this._port,path:"/ZWave.zway/Restore?restore_chip_info="+(c?1:0),method:"POST",headers:d.getHeaders()};this._username&&(a.auth=this._username+":"+(this._password?this._password:""));this._logger.log("trace","send http request:"+JSON.stringify(a));c=require("http");var k=b,n=this;b=c.request(a,function(p){var r="";p.setEncoding("utf-8");
p.on("data",function(t){r+=t});p.on("end",function(){n._logger.log("trace","http response status:"+p.statusCode);n._logger.log("trace","http response data:"+r);var t=null;200!=p.statusCode?(t=Error("http response "+p.statusCode+" data:"+r),k&&k(t,r,p.statusCode),k=null):setTimeout(function(){k&&k(null,r,p.statusCode);k=null},15E3)})});b.on("error",function(p){n._logger.log("trace","http request error:"+p.stack);k&&k(p);k=null});b.setTimeout(1E4,function(){n._logger.log("trace","http request timeout");
k&&k(Error("http timeout"));k=null});d.pipe(b)};q.prototype.pollDataUpdate=function(){this._data?this._getDataUpdate():this._getDataFull()};q.prototype._onDataUpdate=function(a){if(this._running){var c=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);this._dataUpdateTO=setTimeout(function(){c.pollDataUpdate()},this._dataUpdatePeriod);if(a){var b=Object.keys(a);1<b.length&&this._logger.log("info","get data update:"+JSON.stringify(a));var d=null;b.forEach(function(e){if("updateTime"==e)c._data[e]=
a[e];else if("devices"==e)c._data.devices=a[e];else{var k=e.split(".");if(2<k.length&&"devices"==k[0]){var n=k[1],p=c._data.devices[n];d||(d={});d[n]||(d[n]={device:p,updates:{}});d[n].updates[e]=a[e]}n=c._data;for(p=0;p<k.length-1;)n[k[p]]||(n[k[p]]={}),n=n[k[p]],p++;if(n){p=n[k[k.length-1]];var r=a[e];p&&r&&p.updateTime==r.updateTime?d&&delete d[k[1]].updates[e]:n[k[k.length-1]]=a[e]}}});d&&this._onDeviceEvent(d);this._dataUpdateListeners.forEach(function(e){e&&e(a)})}}};q.prototype._onDataFull=
function(a){if(this._running){this._logger.log("info","get data full:"+JSON.stringify(a));var c=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);var b=this._dataUpdatePeriod;a||(b=this._dataFullPeriod);this._dataUpdateTO=setTimeout(function(){c.pollDataUpdate()},b);this._data=a}};q.prototype._onDeviceEvent=function(a){if(a)for(var c in a){var b=a[c];if(b&&b.updates){var d=!1,e={},k;for(k in b.updates){var n=k.split(".");if("instances"==n[2]){var p=n[3];if(p&&"commandClasses"==n[4]){var r=
parseInt(n[5]);-1!=m.LIST.indexOf(r)&&(d=!0,e[p]||(e[p]={}),e[p][r]||(e[p][r]={data:{}}),"data"==n[6]&&(n[7]?e[p][r].data[n[7]]=b.updates[k]:e[p][r].data=b.updates[k]))}}}for(p in e)for(r in b=e[p],b){n=b[r];var t=m.getCommandClassFromId(r);t&&t.resolveUpdate&&t.resolveUpdate(n,p,c)}d&&(d=this._getState(c))&&d[c]&&l.updateState(c,d[c])&&h.sendSTAEvent({type:"ZWAVE2",adr:c,state:d[c]})}}};q.prototype._startInclusion=function(a){var c=this;this._doRunRequest("controller.AddNodeToNetwork(1)",null,function(b,
d,e){b?c._logger.log("warn","start include device error:"+b.stack):200!=e?(b=Error("start include device http response code:"+e),c._logger.log("warn","start include device  http error:"+e+" data:"+d)):c._logger.log("debug","start include device success:"+d);a&&a(b,d)})};q.prototype._stopInclusion=function(a){var c=this;this._doRunRequest("controller.AddNodeToNetwork(0)",null,function(b,d,e){b?c._logger.log("warn","stop include device error:"+b.stack):200!=e?(b=Error("stop include device http response code:"+
e),c._logger.log("warn","stop include device  http error:"+e+" data:"+d)):c._logger.log("debug","stop include device success:"+d);a&&a(b,d)})};q.prototype._startExclusion=function(a){var c=this;this._doRunRequest("controller.RemoveNodeFromNetwork(1)",null,function(b,d,e){b?c._logger.log("warn","start exclude device error:"+b.stack):200!=e?(b=Error("start exclude device http response code:"+e),c._logger.log("warn","start exclude device http error:"+e+" data:"+d)):c._logger.log("debug","start exclude device success:"+
d);a&&a(b,d)})};q.prototype._stopExclusion=function(a){var c=this;this._doRunRequest("controller.RemoveNodeFromNetwork(0)",null,function(b,d,e){b?c._logger.log("warn","stop exclude device error:"+b.stack):200!=e?(b=Error("stop exclude device http response code:"+e),c._logger.log("warn","stop exclude device http error:"+e+" data:"+d)):c._logger.log("debug","stop exclude device success:"+d);a&&a(b,d)})};q.prototype._startUpdateInterview=function(a,c,b,d){var e=this.getDevice(a);if(e){var k=[];if("undefined"!=
typeof c&&null!=c&&b)k.push({deviceID:a,instanceID:c,commandClassID:b});else for(var n in e.instances)if((c=e.instances[n])&&c.commandClasses)for(var p in c.commandClasses)(b=c.commandClasses[p])&&b.data&&b.data.interviewDone&&!b.data.interviewDone.value&&k.push({deviceID:a,instanceID:n,commandClassID:p});if(0==k.length)d&&d();else{var r=this,t=0,u=function(){t++;t==k.length?d&&d():r._startInterview(k[t].deviceID,k[t].instanceID,k[t].commandClassID,u)};this._startInterview(k[t].deviceID,k[t].instanceID,
k[t].commandClassID,u)}}else d&&d(Error("no such device:"+a))};q.prototype._startInterview=function(a,c,b,d){var e=a+"."+c+"."+b;this._logger.log("debug","start interview:"+e);var k=this;this._doRunRequest("devices["+a+"].instances["+c+"].commandClasses["+b+"].Interview()",null,function(n,p,r){n?k._logger.log("warn","start interview "+e+" error:"+n.stack):200!=r?(n=Error("start interview "+e+" http response code:"+r),k._logger.log("warn","start interview "+e+" http error:"+r+" data:"+p)):k._logger.log("debug",
"start interview "+e+" success:"+p);d&&d(n,p)})};q.prototype._resetController=function(a){var c=this;this._doRunRequest("controller.SetDefault()",null,function(b,d,e){b?c._logger.log("warn","reset controller error:"+b.stack):200!=e?(b=Error("reset controller http response code:"+e),c._logger.log("warn","reset controller http error:"+e+" data:"+d)):c._logger.log("debug","reset controller success:"+d);a&&a(b,d)})};q.prototype._getDataFull=function(a){a&&-1==this._dataFullCB.indexOf(a)&&this._dataFullCB.push(a);
if(!this._dataFullRunning){this._dataFullRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var c=this;this._logger.log("debug","get data all");this._doDataRequest(null,function(b,d,e){b?c._logger.log("warn","get data full error:"+b.stack):200!=e?(b=Error("get data http response code:"+e),c._logger.log("warn","get data full http error:"+e+" data:"+d)):c._logger.log("debug","get data full success:"+JSON.stringify(d));c._dataFullRunning=!1;e=c._dataFullCB;c._dataFullCB=
[];!b&&d?c._onDataFull(d):b&&c._onDataFull(null);e.forEach(function(k){k&&k(b,d)})})}};q.prototype._getDataUpdate=function(a){a&&-1==this._dataUpdateCB.indexOf(a)&&this._dataUpdateCB.push(a);if(!this._dataUpdateRunning){this._dataUpdateRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var c=this;(a=this._data.updateTime)||(a=Math.floor((new Date).getTime()/1E3));this._logger.log("trace","get data update with timestamp:"+a);this._doDataRequest(a,function(b,d,
e){b?c._logger.log("warn","get data update error:"+b.stack):200!=e?(b=Error("get data update http response code:"+e),c._logger.log("warn","get data update  http error:"+e+" data:"+d)):c._logger.log("debug","get data update success:"+JSON.stringify(d));c._dataUpdateRunning=!1;e=c._dataUpdateCB;c._dataUpdateCB=[];!b&&d?c._onDataUpdate(d):b&&c._onDataUpdate(null);e.forEach(function(k){k&&k(b,d)})})}};q.prototype._doDataRequest=function(a,c){var b="/ZWaveAPI/Data/";a&&(b+=a);var d=1E4;a&&(d=1E3);var e=
this;this._logger.log("trace","get data with path:"+b);this._doRequest(b,null,null,d,function(k,n,p){if(k)e._logger.log("trace","get data with path:"+b+" error:"+k.stack),c&&c(k);else{e._logger.log("trace","get data with path:"+b+" status:"+p);e._logger.log("trace","get data result:"+n);try{var r=JSON.parse(n);c&&c(null,r,p)}catch(t){c&&c(t)}}})};q.prototype._doRunRequest=function(a,c,b){var d="/ZWaveAPI/Run/"+a;c||(c=1E3);var e=this;this._logger.log("trace","do run request:"+d);this._doRequest(d,
null,null,c,function(k,n,p){k?(e._logger.log("trace","do run request with path:"+d+" error:"+k.stack),b&&b(k)):(e._logger.log("trace","do run request with path:"+d+" status:"+p),e._logger.log("trace","do run request result:"+n),b&&b(null,n,p))})};q.prototype._doRequest=function(a,c,b,d,e){a={host:this._ip,port:this._port,path:a,method:"POST"};c&&(a.headers=c);b&&(a.headers["Content-Length"]=b.length);this._username&&(a.auth=this._username+":"+(this._password?this._password:""));var k=e,n=this;this._logger.log("trace",
"send http request:"+JSON.stringify(a));this._logger.log("trace","send http data:"+b);c=require("http").request(a,function(p){var r="";p.setEncoding("utf-8");p.on("data",function(t){r+=t});p.on("end",function(){n._logger.log("trace","http response status:"+p.statusCode);n._logger.log("trace","http response data:"+r);var t=null;200!=p.statusCode&&(t=Error("http response "+p.statusCode+" data:"+r));k&&k(t,r,p.statusCode)})});c.on("error",function(p){n._logger.log("trace","http request error:"+p.stack);
k&&k(p);k=null});c.setTimeout(d,function(){n._logger.log("trace","http request timeout");k&&k(Error("http timeout"));k=null});b&&c.write(b);c.end()};return q}();
x.hub.m.zway.Handler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.Handler");this._zway=null;this._pollManager=x.hub.m.zway.PollManager;this._settingsManager=x.hub.m.zway.SettingsManager};util.inherits(l,EventEmitter);l.prototype.ZWay=x.hub.m.zway.ZWay;l.prototype.getSystems=function(){return["zway"]};l.prototype.init=function(h){this._logger.log("debug","init zway");var f=this,g=require("x.hub.eventbus.js");g.on("x.hub.peripheralman.ADD_ZWAVE",function(m){f._logger.log("debug",
"insert zwave usb stick");f._logger.log("info","connect to local zwave server");f._start()});g.on("x.hub.peripheralman.REMOVE_ZWAVE",function(m){f._logger.log("debug","eject zwave usb stick");f._logger.log("info","disconnect from local zwave server");f._stop()});global.ZWAVE2_URL&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM&&(this._logger.log("info","connect to remote zwave server"),this._start());this._pollManager.init(this,function(){f._settingsManager.init(f,function(){h&&h({})})})};l.prototype._start=
function(){this._zway||(this._zway="CA"==global.HARDWARE_VERSION?new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT,"mediola","mediola"):new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT));this._zway.start()};l.prototype._stop=function(){this._zway&&(this._zway.stop(),this._zway=null)};l.prototype.getAllStates=function(){return this._zway?this._zway._getStates():null};l.prototype.executeCommand=function(h,f,g){h&&h.address&&h.type?f&&f.value?this._ozw?this._ozw.executeCommand(h,f.value,function(m){g&&
g({error:m})}):g&&g({error:Error("zwave serial not initialized")}):g&&g({error:Error("command invalid")}):g&&g({error:Error("device invalid")})};l.prototype.learnDevice=function(h,f,g){this._zway?this._zway.inclusion(f,function(m,q){g&&g({error:m,data:q})}):g&&g({error:Error("zwave module not running")})};l.prototype.removeDevice=function(h,f){this._zway?this._zway.exclusion(h?h.address:-1,function(g,m){f&&f({error:g,data:{deviceID:m}})}):f&&f({error:Error("zwave module not running")})};l.prototype.listDevices=
function(h,f){if(this._zway){var g=this._zway.getDevices();if(g){h=[];for(var m in g)m&&(g=this._zway.getSimplifiedJSON(m))&&h.push(g);f&&f({data:h})}else f&&f({data:[]})}else f&&f({error:Error("zwave module not running")})};l.prototype.updateInterview=function(h,f,g,m,q){this._zway?this._zway.updateInterview(h,f,g,m,function(a,c){q&&q({error:a,data:c})}):q&&q({error:Error("zwave module not running")})};l.prototype.listInterviewResults=function(h,f){if(this._zway)if(h&&h.address){var g=this._zway.listInterviewResults(h.address);
f&&f({data:g})}else{var m=this._zway.getDevices();if(m){h={};for(g in m)g&&(m=this._zway.listInterviewResults(g))&&(h[g]||(h[g]={instances:{}}),h[g].instances=m);f&&f({data:h})}else f&&f({data:[]})}else f&&f({error:Error("zwave module not running")})};l.prototype.resetController=function(h){this._zway?this._zway.resetController(function(f,g){h&&h({error:f})}):h&&h({error:Error("zwave module not running")})};l.prototype.getAllStatesLegacy=function(h){var f=[],g=this.getAllStates();if(g)for(var m in g)f.push({type:"ZWAVE2",
adr:m,state:g[m]});h&&h({data:f})};l.prototype.executeCommandLegacy=function(h,f,g){this._zway?h?f?this._zway.executeCommand(h,f,function(m){g&&g({error:m})}):g&&g({error:Error("command invalid")}):g&&g({error:Error("address invalid")}):g&&g({error:Error("zwave module not running")})};l.prototype.getZway=function(){return this._zway};l.prototype.startPoller=function(h,f){this._pollManager.startPoller(h,f)};l.prototype.stopPoller=function(h){this._pollManager.stopPoller(h)};l.prototype.forcePoll=function(h,
f){this._pollManager.immediatelyPoll(h);f&&f({data:{}})};l.prototype.setDeviceSetting=function(h,f,g){this._zway?this._zway.getData()?h?f?this._settingsManager.setSetting(h,f,function(m,q){g&&g({error:m?m:null,data:q?q.toJSON():null})}):g&&g({error:Error("setting json invalid")}):g&&g({error:Error("device id invalid")}):g&&g({error:Error("zwave module initialization not finish")}):g&&g({error:Error("zwave module not running")})};l.prototype.getDeviceSetting=function(h,f){this._zway?this._zway.getData()?
h?this._settingsManager.getSetting(h,function(g,m){f&&f({error:g?g:null,data:m?m.toJSON():null})}):f&&f({error:Error("device id invalid")}):f&&f({error:Error("zwave module initialization not finish")}):f&&f({error:Error("zwave module not running")})};return l}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zway.Handler);
