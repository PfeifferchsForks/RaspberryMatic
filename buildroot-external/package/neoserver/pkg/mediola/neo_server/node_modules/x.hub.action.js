var commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.action=x.hub.action||{};
x.hub.action.ActionManager=function(){var l=function(a,b,c){this._id=a;this._number=b;this._logger=require("x.logger.js").getLogger("x.hub.action.Action.["+a+"#"+b+"]");this._actionPool=c;this._state=0;this._actions=[];this._nestedAction=this._delayTimeout=this._callback=null};l.prototype.getId=function(){return this._id};l.prototype.run=function(){var a=0,b=this;this._state=1;var c=function(d){if(d){var e=b._actions[a];try{e=JSON.stringify(e)}catch(h){}}b._logger.log(d?"error":"trace","finish item("+
a+")"+(d?" failed:"+d.message+" action:"+e:" success"));a++;if(2==b._state){if(b._state=3,b._logger.log("trace","action canceled "+e),b._actionPool._onActionFinish(b),b._callback){try{b._callback(Error("action canceled"))}catch(h){}b._callback=null}}else if(3!=b._state)if(a==b._actions.length){if(b._state=3,b._actionPool._onActionFinish(b),b._callback){try{b._callback(d)}catch(h){}b._callback=null}}else b._logger.log("trace","do item("+a+")"),b._do(a,c)};this._logger.log("trace","do item("+a+")");
this._do(a,c)};l.prototype.cancel=function(){this._logger.log("trace","cancel action");1==this._state&&(this._state=2);this._nestedAction&&(this._nestedAction.cancel(),this._nestedAction=null);if(this._delayTimeout&&(clearTimeout(this._delayTimeout),this._delayTimeout=null,this._state=3,this._logger.log("trace","action canceled"),this._actionPool._onActionFinish(this),this._callback))try{this._callback(Error("action canceled"))}catch(a){}};l.prototype._do=function(a,b){var c=this._actions[a];if(c){var d=
this;void 0!=c.delay&&null!=c.delay?this._delayTimeout=setTimeout(function(){d._delayTimeout=null;b()},c.delay):c.if?this._doStatement(a,c,b):c.action?require("x.hub.action.js").getActionManager().executeActionWithId(c.action,b):commandman.commandHandlerV6.executeCommandWithCommandInfo(c,function(e){b(e)})}else b()};l.prototype._doStatement=function(a,b,c){var d=this;this._logger.log("trace","do statement("+a+")");(function(e,h){var f=0,m=null;e.state?(d._logger.log("trace","check single state object"),
d._checkState(e,function(n,k){h(n,k)})):e.and&&e.and.length?(m=function(n,k){d._logger.log("trace","check "+f+'th item in "and" array '+(n?"failed:"+n.message:"result:"+k));n?h(null,!1):k?(f++,f<e.and.length?(d._logger.log("trace","check "+f+'th item in "and" array'),d._checkState(e.and[f],m)):h(null,!0)):h(null,!1)},d._logger.log("trace","check "+f+'th item in "and" array'),d._checkState(e.and[f],m)):e.or&&e.or.length&&(m=function(n,k){d._logger.log("trace","check "+f+'th item in "or" array '+(n?
"failed:"+n.message:"result:"+k));!n&&k?h(null,!0):(f++,f<e.or.length?(d._logger.log("trace","check "+f+'th item in "or" array'),d._checkState(e.or[f],m)):h(null,!1))},d._logger.log("trace","check "+f+'th item in "or" array'),d._checkState(e.or[f],m))})(b.if,function(e,h){d._logger.log("trace","do statement("+a+'), check "if" '+(e?"faild:"+e.message:"result: "+h));e?c(e):h?(d._logger.log("trace","do statement("+a+') "then" actions'),(e=b.then)&&e.length?d._doNestedAction(d._id+"-if:"+a+"(then)",e,
c):c()):(d._logger.log("trace","do statement("+a+') "else" actions'),(e=b.else)&&e.length?d._doNestedAction(d._id+"-if:"+a+"(else)",e,c):c())})};l.prototype._checkState=function(a,b){this._logger.log("trace","check state item: "+JSON.stringify(a));var c=this;if(a.state){var d=a.state;if(d.devices&&d.devices.length)if(d.data&&d.data.length){var e=0,h=function(q,r){c._logger.log("trace","check state of "+e+"th device "+(q?"failed:"+q.message:"result:"+JSON.stringify(r)));if(q)b(q);else if(r){q=!1;for(var t=
0;t<d.data.length&&!(q=commandman.commandHandlerV6.matchDeviceState(r,d.data[t]));t++);q?(e++,e<d.devices.length?(c._logger.log("trace","check state of "+e+"th device: "+JSON.stringify(d.devices[e])),commandman.commandHandlerV6.getDeviceStatesWithStateInfo(d.devices[e],h)):b(null,!0)):b(null,!1)}else b(null,!1)};this._logger.log("trace","check state of "+e+"th device: "+JSON.stringify(d.devices[e]));commandman.commandHandlerV6.getDeviceStatesWithStateInfo(d.devices[e],h)}else b(Error("invalid state item, no data"));
else b(Error("invalid state item, no devices"))}else if(a.time){var f=require("x.hub.rule.js").RuleManager.Util,m=f.getMomentNow();if(f.matchDate(m,a.time)){var n=!0,k=null;k=null;a.time.from&&(k=f.getAstro(m),(k="sun"==a.time.from.substr(0,3)?f.calculateAstroTarget(m,k[0],k[1],a.time.from):f.calculateTimeTarget(m,a.time.from))&&m.isBefore(k)&&(n=!1));n?(a.time.until&&(k=f.getAstro(m),(k="sun"==a.time.until.substr(0,3)?f.calculateAstroTarget(m,k[0],k[1],a.time.until):f.calculateTimeTarget(m,a.time.until))&&
m.isAfter(k)&&(n=!1)),b(null,n)):b(null,!1)}else b(null,!1)}else b(Error("invalid state item"))};l.prototype._doNestedAction=function(a,b,c){this._nestedAction=new l(a,b,{_onActionFinish:function(){}});this._nestedAction._actions=b;this._nestedAction._callback=c;this._nestedAction.run()};var p=function(){this._pool=[];this._count=0};p.prototype.runAction=function(a,b,c){b?(this._count++,65535<this._count&&(this._count=1),a=new l(a,this._count,this),Array.isArray(b)?a._actions=b:a._actions=[b],a._callback=
c,this._pool.push(a),a.run()):c&&c()};p.prototype.cancelAction=function(a){this._pool=this._pool.filter(function(b){return b&&b.getId()==a?(b.cancel(),!1):!0})};p.prototype.isActionRunning=function(a){for(var b=0;b<this._pool.length;b++){var c=this._pool[b];if(c&&c.getId()==a)return!0}return!1};p.prototype._onActionFinish=function(a){a=this._pool.indexOf(a);-1!=a&&this._pool.splice(a,1)};var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.ActionManager");this._actions=this._dataFolder=
null;this._actionPool=new p(this);this._writing=!1;this._writeCallbacks=[]};g.FILE_NAME="action.json";g.prototype.init=function(a,b){this._logger.log("info","init action manager");this._dataFolder=a.getUserRootDataPath();this._loadActions(function(c){b&&b(c)})};g.prototype.getActions=function(){return this._actions};g.prototype.getAction=function(a){return this._actions?this._actions[a]:null};g.prototype.setAction=function(a,b,c){void 0==a||null==a?c&&c(Error("invalid action id")):(b?this._actions[a]=
b:delete this._actions[a],this._writeActions(function(d){c&&c(d,b)}))};g.prototype.executeActionWithId=function(a,b){var c=this.getAction(a);c?this._actionPool.runAction("act:"+a,c,b):b&&b(Error("no such action "+a))};g.prototype.executeAction=function(a,b,c){this._actionPool.isActionRunning(a)?(this._logger.log("trace","action ("+a+") is already running"),c&&c()):this._actionPool.runAction(a,b,c)};g.prototype.executeActionSingelton=function(a,b,c){this._actionPool.cancelAction(a);this._actionPool.runAction(a,
b,c)};g.prototype._loadActions=function(a){var b=require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(e){e?a(e):d._loadFile(function(h,f){h?a(h):(d._actions=f?f:{},a())})})};g.prototype._writeActions=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];var c=this;this._writeFile(this._actions,function(d){c._writing=!1;b.forEach(function(e){try{e&&
e(d)}catch(h){}});c._writeActions()})}};g.prototype._getFile=function(){return require("path").resolve(this._dataFolder,g.FILE_NAME)};g.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(d,e){if(d)a(d);else if(e)try{var h=JSON.parse(e);a(null,h)}catch(f){a(null,{})}else a(null,{})})};g.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(e){b&&b(e)})};g.Action=l;return g}();
x.hub.action.Handler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.Handler");this._actionManager=new x.hub.action.ActionManager};l.prototype.ActionManager=x.hub.action.ActionManager;l.prototype.init=function(p,g,a){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(p);this._actionManager.init(g,function(b){b&&a(b)})};l.prototype.getActionManager=function(){return this._actionManager};l.prototype._initHttpApi=function(){var p=this,g=require("x.hub.js").getServer();
g.addRoute("/api/actions",{method:"GET"},function(a,b,c){a=p._actionManager.getActions();b.json({XC_SUC:a?a:{}})});g.addRoute("/api/action",{method:"GET"},function(a,b,c){var d=a.query?a.query.id:null;p._actionManager.executeActionWithId(d,function(e){e?b.json({XC_ERR:{code:"000101",msg:"failed to execute action "+d+":"+e.message}}):b.json({XC_SUC:{}})})});g.addRoute("/data/act/",{method:"GET"},function(a,b,c){a=a.path.substr(10);(a=p._actionManager.getAction(a))?b.json({XC_SUC:a}):b.json({XC_ERR:{code:"000101",
msg:"failed to open file"}})});g.addRoute("/data/act/",{method:"POST"},function(a,b){var c=a.path.substr(10);try{p._actionManager.setAction(c,a.json,function(d,e){d?b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+d.message}}):e?b.json({XC_SUC:{bytes:a.size}}):b.json({XC_SUC:{bytes:0}})})}catch(d){b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+d.message}})}})};return l}();module.exports=new x.hub.action.Handler;
