var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(c){var a=0;return function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}}};$jscomp.arrayIterator=function(c){return{next:$jscomp.arrayIteratorImpl(c)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){if(c==Array.prototype||c==Object.prototype)return c;c[a]=b.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<c.length;++a){var b=c[a];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,a){var b=$jscomp.propertyToPolyfillSymbol[a];if(null==b)return c[a];b=c[b];return void 0!==b?b:c[a]};
$jscomp.polyfill=function(c,a,b,d){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,a,b,d):$jscomp.polyfillUnisolated(c,a,b,d))};$jscomp.polyfillUnisolated=function(c,a,b,d){b=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var f=c[d];if(!(f in b))return;b=b[f]}c=c[c.length-1];d=b[c];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(c,a,b,d){var f=c.split(".");c=1===f.length;d=f[0];d=!c&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var e=0;e<f.length-1;e++){var g=f[e];if(!(g in d))return;d=d[g]}f=f[f.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?d[f]:null;a=a(b);null!=a&&(c?$jscomp.defineProperty($jscomp.polyfills,f,{configurable:!0,writable:!0,value:a}):a!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[f]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[f]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(f):$jscomp.POLYFILL_PREFIX+b+"$"+f),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[f],{configurable:!0,writable:!0,value:a})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(c){if(c)return c;var a=function(e,g){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",d=0,f=function(e){if(this instanceof f)throw new TypeError("Symbol is not a constructor");return new a(b+(e||"")+"_"+d++,e)};return f},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(c){if(c)return c;c=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<a.length;b++){var d=$jscomp.global[a[b]];"function"===typeof d&&"function"!=typeof d.prototype[c]&&$jscomp.defineProperty(d.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return c},"es6",
"es3");$jscomp.iteratorPrototype=function(c){c={next:c};c[Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,a){c instanceof String&&(c+="");var b=0,d=!1,f={next:function(){if(!d&&b<c.length){var e=b++;return{value:a(e,c[e]),done:!1}}d=!0;return{done:!0,value:void 0}}};f[Symbol.iterator]=function(){return f};return f};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rademacher=xnm.aio.rademacher||{};xnm.aio.rademacher.Util={clearHttpOptionForLog:function(c){try{var a=JSON.parse(JSON.stringify(c));a.auth&&(a.auth="xxxxxx:xxxxxx");if(a.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var d=headers[b];if(d){var f=d.indexOf(" ");headers[b]=-1==f?"xxxxxx":d.substr(0,f)+" xxxxxx"}}return a}catch(e){return c}}};
xnm.aio.rademacher.HomePilot=function(c,a,b,d,f){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot");this.ip=c;this.port=80;a&&(this.port=a);this._user=b;this._password=d;this._uid=f;this._inRemoteMode=!1;this.CommandHandler=null};xnm.aio.rademacher.HomePilot.prototype.enableRemoteMode=function(c){this._inRemoteMode=c};
xnm.aio.rademacher.HomePilot.prototype._doRequest=function(c,a){var b=this.ip,d=this.port,f="/rest2/Index?do="+c,e=require("http");this._inRemoteMode&&(e=require("https"),b="www.homepilot.de",d=443,f="/uid/"+this._uid+"/rest2/Index?do="+c);"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");c={host:b,port:d,path:f,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};
this._inRemoteMode&&this._user&&this._password&&(c.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));var g=this;this._logger.log("trace","send http req:"+JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(c)));var k=e.request(c,function(h){g._logger.log("trace","receive http rsp status code:"+h.statusCode);if(200==h.statusCode){h.setEncoding("utf-8");var l="";h.on("data",function(m){l+=m});h.on("end",function(){g._logger.log("trace","receive http rsp:"+
l);var m=JSON.parse(l);a&&a(m)})}else 403==h.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),a&&a(null)});k.setTimeout(6E3,function(){g._logger.log("trace","send http req timeout");k.abort()});k.on("error",function(h){g._logger.log("trace","send http req err:"+h.message);a&&a(null)});k.end()};
xnm.aio.rademacher.HomePilot.prototype.getDevices=function(c){var a={};this._doRequest("/devices",function(b){if(b&&"ok"==b.status)for(var d=0;d<b.devices.length;d++){var f=b.devices[d],e={};e.name=f.name;e.type=f.deviceGroup;e.info=f.description;e.state=f.statusesMap;a[f.did]=e}else a=null;c(a)})};
xnm.aio.rademacher.HomePilot.prototype.getMeters=function(c){var a={},b=[],d=this;this._doRequest("/meters",function(f){if(f&&"ok"==f.status&&f.meters){for(var e=0;e<f.meters.length;e++){var g=f.meters[e];g&&g.did&&b.push(g.did)}0==b.length&&c&&c(null);var k=0;for(f=0;f<b.length;f++)d.getMeter(b[f],function(h){k+=1;if(h&&h.meter&&h.data){var l=d._resolveMeterType(h.data);h.meter.did&&l&&(a[h.meter.did]={name:h.meter.name,address:h.meter.did,type:l,data:h.data})}k==b.length&&c&&c(a)})}else c&&c(null)})};
xnm.aio.rademacher.HomePilot.prototype.getMeter=function(c,a){c?this._doRequest("/meters/"+c,function(b){b&&"ok"==b.status&&b.meter&&b.data?a&&a(b):a&&a(null)}):a&&a(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterType=function(c){for(var a={},b=0;b<c.length;b++)for(var d=c[b],f=Object.keys(d),e=0;e<f.length;e++)a[f[e]]=d[f[e]];return a["Schlie\u00dfer"]?"contact":"sensor"};
xnm.aio.rademacher.HomePilot.prototype.getStates=function(c,a,b){if(a&&0!=a.length){var d=this;this.CommandHandler=c;this.getDevices(function(f){if(f&&d.CommandHandler)if(a&&d.CommandHandler.setState)for(var e=0;e<a.length;e++){var g=a[e],k;if(f[g.address]&&(k=f[g.address].state)){var h=d.getStateValues(f[g.address].type,k),l;for(l in h)"state"==l?d.CommandHandler.setState(g.id,h[l]):d.CommandHandler.setState(g.id+":"+l,h[l])}}else if(d.CommandHandler.receivedState)for(e in f)d.CommandHandler.receivedState("hp",
e,f[e].state);b&&b(null)})}else b&&b(null)};
xnm.aio.rademacher.HomePilot.prototype.executeCommand=function(c,a,b){var d=this;"on"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=10",b):"off"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=11",b):"up"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=1",b):"down"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=2",b):"stop"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=3",b):"dimUp"==a?this._doRequest("/devices/"+c.address+"?do=use&cmd=23",b):"dimDown"==a?this._doRequest("/devices/"+
c.address+"?do=use&cmd=24",b):"toggle"==a?this._doRequest("/devices/"+c.address,function(f){f&&"ok"==f.status&&f.device?0<f.device.statusesMap.Position?d._doRequest("/devices/"+c.address+"?do=use&cmd=11",b):d._doRequest("/devices/"+c.address+"?do=use&cmd=10",b):b&&b()}):("string"==typeof a&&0==a.indexOf("dimTo")&&(a=a.replace(/dimTo/g,"")),"string"==typeof a&&0==a.indexOf("moveTo")&&(a=a.replace(/moveTo/g,"")),"string"==typeof a&&(a=a.replace(/%/g,"")),this._doRequest("/devices/"+c.address+"?do=use&cmd=9&pos="+
a,b))};xnm.aio.rademacher.HomePilot.prototype.getStateValues=function(c,a){var b={};1==c?100==a.Position?b.state="on":0==a.Position&&(b.state="off"):b.state=a.Position;b.manu=a.Manuellbetrieb;return b};xnm.aio.rademacher.Kodi=function(c,a,b,d){this.ip=c;this.port=80;a&&(this.port=a);this._user=b;this._password=d;this._inRemoteMode=!1;this.CommandHandler=null};
xnm.aio.rademacher.Kodi.prototype._doRequest=function(c,a,b){c="/jsonrpc?request="+encodeURI(JSON.stringify({jsonrpc:"2.0",method:c,params:a,id:1}));c={host:this.ip,port:this.port,path:c,method:"GET",headers:{Connection:"close"}};this._inRemoteMode&&this._user&&this._password&&(c.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));var d=require("http").request(c,function(f){if(200==f.statusCode){f.setEncoding("utf-8");var e="";f.on("data",function(g){e+=
g});f.on("end",function(){var g=JSON.parse(e);b&&b(g)})}else 403==f.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),b&&b(null)});d.setTimeout(6E3,function(){d.abort()});d.on("error",function(f){b&&b(null)});d.end()};
xnm.aio.rademacher.Kodi.prototype.executeCommand=function(c,a,b){c=null;var d={};"play"==a?(c="Player.PlayPause",d={playerid:0}):"stop"==a?(c="Player.Stop",d={playerid:0}):"previous"==a?(c="Player.GoTo",d={playerid:0,to:"previous"}):"next"==a?(c="Player.GoTo",d={playerid:0,to:"next"}):"left"==a?c="Input.Left":"right"==a?c="Input.Right":"up"==a?c="Input.Up":"down"==a?c="Input.Down":"home"==a?c="Input.Home":"enter"==a?c="Input.Select":"info"==a?c="Input.Info":"back"==a?c="Input.Back":"menu"==a?c="Input.ContextMenu":
"osd"==a?c="Input.ShowOSD":"mute"==a?(c="Application.SetMute",d={mute:"toggle"}):"volumeUp"==a?(c="Application.SetVolume",d={volume:"increment"}):"volumeDown"==a?(c="Application.SetVolume",d={volume:"decrement"}):"shutdown"==a?c="System.Shutdown":"reboot"==a?c="System.Reboot":"suspend"==a?c="System.Suspend":"hibernate"==a&&(c="System.Hibernate");c?this._doRequest(c,d,b):b&&b()};
xnm.aio.rademacher.HomePilot.prototype.executeCommandCreator=function(c,a,b){if(c&&"kodi"==c.type)a&&a.value?(new xnm.aio.rademacher.Kodi(this.ip,c.port,c.username,c.password)).executeCommand(null,a.value,function(){b&&b()}):b&&b(Error("command invalid"));else if(c&&c.address)if(a){var d=a.value;switch(d){case "dimTo":case "moveTo":if(null==a.ext||"undefined"==typeof a.ext){b&&b(Error("command invalid"));return}if("number"==typeof a.ext)d=parseInt(a.ext);else if(a.ext.match(/^[-+]?[0-9]+$/))d=parseInt(a.ext);
else{b&&b(Error("command invalid"));return}break;case "tempTo":if(null==a.ext||"undefined"==typeof a.ext){b&&b(Error("command invalid"));return}d=parseFloat(a.ext);if(isNaN(d)){b&&b(Error("command invalid"));return}d=Math.round(10*d)}this.executeCommand(c,d,function(){b&&b()})}else b&&b(Error("command invalid"));else b&&b(Error("device invalid"))};
xnm.aio.rademacher.HomePilot.prototype.getStatesCreator=function(c,a,b){if(a){c=[];for(var d=[],f=0;f<a.length;f++){var e=a[f];e.device&&e.device.address&&("contact"==e.device.type||"env"==e.device.type||"smoke"==e.device.type||"sun"==e.device.type?d.push(e):c.push({id:e.id,address:e.device.address}))}var g=0,k=[];this._getMeterStates(d,function(h){g++;h&&(k=k.concat(h));2==g&&b&&(b(null,k),b=null)});this.getStates({setState:function(h,l){var m=h.lastIndexOf(":"),n="state";-1!=m&&m!=h.length-1&&(m=
h.substr(m+1))&&(n=m);for(m=0;m<a.length;m++)if(a[m].id==h&&a[m].status&&a[m].device)switch(a[m].device.type){case "thermo":if("state"==n){var p=parseInt(l);isNaN(p)||(p={id:a[m].id,status:(p/10).toFixed(1)},k.push(p))}break;default:"state"==n&&(p={id:a[m].id,status:l},k.push(p))}}},c,function(){g++;2==g&&b&&(b(null,k),b=null)})}else b&&b(Error("deviceList is null"))};
xnm.aio.rademacher.HomePilot.prototype._getMeterStates=function(c,a){if(c&&0!=c.length){var b=0,d=this,f=[],e;for(e=0;e<c.length;e++)c[e].device&&c[e].device.address&&-1==f.indexOf(c[e].device.address)&&f.push(c[e].device.address);var g={};for(e=0;e<f.length;e++)f[e]&&this.getMeter(f[e],function(k){k&&k.meter&&k.meter.did&&k.data&&(g[k.meter.did]=k.data);b++;if(b==f.length){k=[];for(var h=0;h<c.length;h++)if(c[h].id){var l="?";if(c[h].device&&c[h].device.address&&c[h].device.type&&c[h].status&&c[h].status.value&&
g[c[h].device.address]){var m=d._resolveMeterDatapointState(c[h].device.type,c[h].status.value,g[c[h].device.address]);"undefined"!=typeof m&&null!=m&&(l=m)}k.push({id:c[h].id,status:l})}a&&a(k)}})}else a&&a(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterDatapointState=function(c,a,b){return(c=this._resolveMeterStates(c,b))?c[a]:null};
xnm.aio.rademacher.HomePilot.prototype._resolveMeterStates=function(c,a){switch(c){case "contact":return this._resolveContactState(a);case "env":return this._resolveEnvState(a);case "smoke":return this._resolveSmokeState(a);case "sun":return this._resolveSunState(a)}return null};
xnm.aio.rademacher.HomePilot.prototype._resolveEnvState=function(c){var a=null,b;if(c)if(1==c.length)a={},c[0]&&(b=this._resolveKeyValue(c[0]))&&b.value&&(a.envUpdate=b.value);else if(7<=c.length){a={};c[0]&&(b=this._resolveKeyValue(c[0]))&&b.value&&(a.envLum=parseInt(b.value.replace("lx","").trim()));c[1]&&(b=this._resolveKeyValue(c[1]))&&b.value&&(a.envWindS=parseInt(b.value.replace("m/s","").trim()));c[2]&&(b=this._resolveKeyValue(c[2]))&&b.value&&(a.envTemp=parseFloat(b.value.replace("\u00b0C",
"").trim()));if(c[3]&&(b=this._resolveKeyValue(c[3]))&&b.value)switch(b.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":a.envRain="false";break;default:a.envRain="true"}c[4]&&(b=this._resolveKeyValue(c[4]))&&b.value&&(a.envSunH=parseInt(b.value.replace("\u00b0","").trim()));if(c[5]&&(b=this._resolveKeyValue(c[5]))&&b.value){var d=b.value.indexOf("("),f=b.value.indexOf(")");if(-1!=d&&f>d){var e=b.value.substr(0,d);b=b.value.substr(d+1,f-d-1);a.envSunD=parseInt(b.replace("\u00b0",
"").trim());a.envSunDS=e.trim()}}c[6]&&(b=this._resolveKeyValue(c[6]))&&b.value&&(a.envUpdate=b.value)}return a};
xnm.aio.rademacher.HomePilot.prototype._resolveContactState=function(c){var a=null,b;if(c&&3<=c.length){a={};if(c[0]&&(b=this._resolveKeyValue(c[0]))&&b.value)switch(b.value){case "Closed":case "Geschlossen":case "Ferm\u00e9":case "Gesloten":a.contactState="closed";break;default:a.contactState="open"}c[1]&&(b=this._resolveKeyValue(c[1]))&&b.value&&(a.contactBat=parseInt(b.value.replace("%","").trim()));c[2]&&(b=this._resolveKeyValue(c[2]))&&b.value&&(a.contactUpdate=b.value)}return a};
xnm.aio.rademacher.HomePilot.prototype._resolveSmokeState=function(c){var a=null,b;if(c&&3<=c.length){a={};if(c[0]&&(b=this._resolveKeyValue(c[0]))&&b.value)switch(b.value){case "Not detected":case "Nicht erkannt":case "Non d\u00e9tect\u00e9":case "Niet herkend":a.smokeState="ok";break;default:a.smokeState="alarm"}c[1]&&(b=this._resolveKeyValue(c[1]))&&b.value&&(a.smokeBat=parseInt(b.value.replace("%","").trim()));c[2]&&(b=this._resolveKeyValue(c[2]))&&b.value&&(a.smokeUpdate=b.value)}return a};
xnm.aio.rademacher.HomePilot.prototype._resolveSunState=function(c){var a=null,b;if(c&&2<=c.length){a={};if(c[0]&&(b=this._resolveKeyValue(c[0]))&&b.value)switch(b.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":a.sunState="no";break;default:a.sunState="yes"}c[1]&&(b=this._resolveKeyValue(c[1]))&&b.value&&(a.sunUpdate=b.value)}return a};
xnm.aio.rademacher.HomePilot.prototype._resolveKeyValue=function(c){for(var a in c)if(c.hasOwnProperty(a))return{key:a,value:c[a]};return null};
xnm.aio.rademacher.HomePilot.prototype.getSensorTypeFromData=function(c){var a=null;if(c&&c[0]&&(c=this._resolveKeyValue(c[0]))&&c.key&&c.value){switch(c.key){case "Closer":case "Schlie\u00dfer":case "Contact normalement ouvert":case "Sluitcontact":a="contact";break;case "Smoke":case "Rauch":case "Fum\u00e9e":case "roken":a="smoke";break;case "Sun":case "Sonne":case "Soleil":case "Zon":a="sun"}-1!=c.value.indexOf("lx")&&(a="env")}return a};
xnm.aio.rademacher.HomePilot.prototype.toJSON=function(){return{sys:"homepilot1",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot.prototype.equalsTo=function(c){return c&&c instanceof xnm.aio.rademacher.HomePilot?this.ip==c.ip&&this.port==c.port&&this._uid==c._uid:!1};xnm.aio.rademacher.HomePilot2=function(c,a,b,d,f){xnm.aio.rademacher.HomePilot.call(this,c,a,b,d,f)};xnm.aio.rademacher.HomePilot2.prototype=xnm.aio.rademacher.HomePilot.prototype;
xnm.aio.rademacher.HomePilot2.constructor=xnm.aio.rademacher.HomePilot2;xnm.aio.rademacher.HomePilot2.prototype.toJSON=function(){return{sys:"homepilot2",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot2.prototype.equalsTo=function(c){return c&&c instanceof xnm.aio.rademacher.HomePilot2?this.ip==c.ip&&this.port==c.port&&this._uid==c._uid:!1};
xnm.aio.rademacher.HomePilot2V5=function(){var c=function(a,b,d,f,e){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot2A");this.ip=a;this.port=80;b&&(this.port=b);this._user=d;this._password=f;this._uid=e;this._communication_token=null;this._loginCBs=[]};c.prototype.executeCommandCreator=function(a,b,d){if(a&&a.address&&"kodi"!=a.type)if(b){switch(b.value){case "dimTo":case "moveTo":case "tempTo":if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command invalid"));return}var f=
parseFloat(b.ext);if(isNaN(f)){d&&d(Error("command invalid"));return}}this.executeCommand(a,b,function(e){d&&d(e)})}else d&&d(Error("command invalid"));else d&&d(Error("device invalid"))};c.prototype.getStatesCreator=function(a,b,d){b?this.getStates(function(f,e){if(f)d&&d(f);else{f=[];for(var g=0;g<b.length;g++){var k=b[g];if(k.id&&k.device&&k.device.address&&k.status&&k.status.value){var h=e[k.device.address],l=null;h&&(l=h[k.status.value]);null==l&&(l="?");f.push({id:k.id,status:l})}}d&&d(null,
f)}}):d&&d(Error("deviceList is null"))};c.prototype.executeCommand=function(a,b,d){var f=this;"on"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"TURN_ON_CMD"},d):"off"==b.value?"dimmer"==a.type?this.executeCommand(a,{value:"dimTo",ext:0},d):this._doRestReq("PUT","/devices/"+a.address,{name:"TURN_OFF_CMD"},d):"toggle"==b.value?this.getStates(function(e,g){e?d&&d(e):(e=g[a.address])&&"on"==e.state?f.executeCommand(a,{value:"off"},d):e&&!isNaN(e.state)&&0!=e.state?f.executeCommand(a,{value:"off"},
d):f.executeCommand(a,{value:"on"},d)}):"up"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"POS_UP_CMD"},d):"down"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"POS_DOWN_CMD"},d):"stop"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"STOP_CMD"},d):"dimUp"==b.value||"stepUp"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"INC_CMD"},d):"dimDown"==b.value||"stepDown"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"DEC_CMD"},d):"dimTo"==b.value||
"moveTo"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"GOTO_POS_CMD",value:parseInt(b.ext)},d):"tempTo"==b.value?this._doRestReq("PUT","/devices/"+a.address,{name:"TARGET_TEMPERATURE_CFG",value:parseInt(b.ext)},d):d&&d(Error("unknown command"))};c.prototype.getStates=function(a){var b=this;this._doRestReq("GET","/devices",null,function(d,f){if(d)a&&a(d);else if(f.payload&&f.payload.devices){var e={};f.payload.devices.forEach(function(g){g&&g.capabilities&&(g=b._evalDevice(g))&&g.address&&
g.states&&(e[g.address]=g.states)});a&&a(null,e)}else a&&a(null,[])})};c.prototype.getDevices=function(a){var b=this;this._doRestReq("GET","/devices",null,function(d,f){if(d)a&&a(d);else if(f.payload&&f.payload.devices){var e=[];f.payload.devices.forEach(function(g){g&&g.capabilities&&(g=b._evalDevice(g))&&(delete g.states,e.push(g))});a&&a(null,e)}else a&&a(null,[])})};c.prototype.login=function(a){var b=this,d=this._loginCBs.length;a&&-1===this._loginCBs.indexOf(a)&&this._loginCBs.push(a);if(0===
d){var f=this,e=function(g){var k=b._loginCBs;b._loginCBs=[];k.forEach(function(h){return h&&h(g)})};f._getPasswordSalt(function(g,k){g?e(g):(g=f._encodePassword(k),f._login(g,k,function(h,l){h?e(h):(f._communication_token=l,e())}))})}else this._logger.log("debug","/login already pending. Adding callback to list.")};c.prototype.equalsTo=function(a){return a&&a instanceof c?this.ip==a.ip&&this.port==a.port&&this._user==a._user&&this._password==a._password:!1};c.prototype.toJSON=function(){return{sys:"homepilot2v5",
ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};c.prototype._evalDevice=function(a){var b={sys:"homepilot2v5",name:null,type:null,address:null,caps:[],states:{}};if(!a||!a.capabilities)return null;for(var d=[],f=0;f<a.capabilities.length;f++){var e=a.capabilities[f];if("NAME_DEVICE_LOC"==e.name)b.name=e.value;else if("ID_DEVICE_LOC"==e.name)b.address=e.value;else if("DEVICE_TYPE_LOC"==e.name)switch(e.value){case "1":b.type="switch";break;case "2":b.type="blind";
break;case "3":b.type="sensor";break;case "4":b.type="dimmer";break;case "5":b.type="thermo";break;case "8":b.type="gate"}else if("REACHABILITY_EVT"==e.name)b.states.reachable=e.value,-1!=e.timestamp&&(b.states.update=(new Date(1E3*e.timestamp)).toString());else if("CURR_SWITCH_POS_CFG"==e.name)b.states.state="false"==e.value?"off":"on";else if("CURR_POS_CFG"==e.name)b.states.state=parseInt(e.value);else if("TARGET_TEMPERATURE_CFG"==e.name)b.states.state=parseFloat(e.value),b.caps.push(e);else if("BATTERY_LVL_PCT_MEA"==
e.name)b.states.battery=parseInt(e.value);else if("BATT_VALUE_EVT"==e.name)b.states.thermoBat=parseInt(e.value);else if("SMOKE_DETECTION_MEA"==e.name)b.states.smokeState="false"==e.value?"ok":"alarm",-1!=e.timestamp&&(b.states.smokeUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("CLOSE_CONTACT_MEA"==e.name)b.states.contactState="2"==e.value?"tilted":"1"==e.value?"open":"closed",-1!=e.timestamp&&(b.states.contactUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("LIGHT_VAL_LUX_MEA"==
e.name)b.states.envLum=parseFloat(e.value),d.push(e.name);else if("WIND_SPEED_MS_MEA"==e.name)b.states.envWindS=parseFloat(e.value),d.push(e.name);else if("TEMP_CURR_DEG_MEA"==e.name)b.states.envTemp=parseFloat(e.value),d.push(e.name);else if("RAIN_DETECTION_MEA"==e.name)b.states.envRain=e.value,-1!=e.timestamp&&(b.states.envUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("SUN_DIRECTION_MEA"==e.name){var g=parseFloat(e.value);b.states.envSunD=g;var k=null;22.5>g||337.5<=g?k=
"N":22.5<=g&&67.5>g?k="NE":67.5<=g&&112.5>g?k="E":112.5<=g&&157.5>g?k="SE":157.5<=g&&202.5>g?k="S":202.5<=g&&247.5>g?k="SW":247.5<=g&&292.5>g?k="W":292.5<=g&&337.5>g&&(k="NW");b.states.envSunDS=k;d.push(e.name)}else"SUN_HEIGHT_DEG_MEA"==e.name?(b.states.envSunH=parseFloat(e.value),d.push(e.name)):"SUN_DETECTION_MEA"==e.name?(b.states.sunState="false"==e.value?"no":"yes",b.states.envSunS="false"==e.value?"no":"yes",-1!=e.timestamp&&(b.states.sunUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name)):
e.name&&d.push(e.name)}if(!b.type||!b.address)return null;"sensor"==b.type&&(-1!=d.indexOf("CLOSE_CONTACT_MEA")?(b.type="contact","undefined"!=typeof b.states.battery&&null!=b.states.battery&&(b.states.contactBat=b.states.battery)):-1!=d.indexOf("SMOKE_DETECTION_MEA")?(b.type="smoke","undefined"!=typeof b.states.battery&&null!=b.states.battery&&(b.states.smokeBat=b.states.battery),!b.states.smokeUpdate&&b.states.update&&(b.states.smokeUpdate=b.states.update)):-1!=d.indexOf("SUN_DETECTION_MEA")&&-1==
d.indexOf("RAIN_DETECTION_MEA")?b.type="sun":-1!=d.indexOf("RAIN_DETECTION_MEA")&&(b.type="env"));return b};c.prototype._encodePassword=function(a){var b=require("x.crypt.js"),d=b.SHA256(this._password);return b.SHA256(a+d)};c.prototype._getPasswordSalt=function(a){this._doRequest("POST","/authentication/password_salt",null,null,function(b,d,f){if(b)a&&a(b);else{var e=b=null;if(200!=f)if(d)try{(b=JSON.parse(d))&&b.error_description?(e=Error(b.error_description),e.code=b.error_code,a&&a(e)):a&&a(Error("get password salt failed, reponse status code:"+
f+", response:"+d))}catch(g){a&&a(Error("get password salt failed, reponse status code:"+f+", response:"+d))}else a&&a(Error("get password salt failed, reponse status code:"+f));else if(d)try{(b=JSON.parse(d))?"OK"!=b.error_description?(e=Error(b.error_description),e.code=b.error_code,a&&a(e)):b.password_salt?a&&a(null,b.password_salt):a&&a(Error("invalid get password salt response:"+d)):a&&a(Error("invalid get password salt response:"+d))}catch(g){a&&a(Error("invalid get password salt response:"+
d))}else a&&a(Error("get password salt response empty"))}})};c.prototype._login=function(a,b,d){this._doRequest("POST","/authentication/login",null,JSON.stringify({password:a,password_salt:b}),function(f,e,g,k){if(f)d&&d(f);else{var h=f=null;if(200!=g)if(e)try{(f=JSON.parse(e))&&f.error_description?(h=Error(f.error_description),h.code=f.error_code,d&&d(h)):d&&d(Error("login failed, reponse status code:"+g+", response:"+e))}catch(l){d&&d(Error("login failed, reponse status code:"+g+", response:"+e))}else d&&
d(Error("login failed, reponse status code:"+g));else k&&k["set-cookie"]?(e=k["set-cookie"],e.constructor===Array&&(e=e[0]),g=null,k=e.indexOf(";Path="),0==e.indexOf("HPSESSION=")&&0<k&&(g=e.substring(10,k)),d&&d(null,g)):d&&d(Error("login failed, no HPSESSION"))}})};c.prototype._doRestReq=function(a,b,d,f){var e=this;if(!this._communication_token&&this._password)this._logger.log("trace","No communication token, need to login again."),this.login(function(h){h?f&&f(h):e._doRestReq(a,b,d,f)});else{var g=
null;this._communication_token&&this._password&&(g={cookie:"HPSESSION="+this._communication_token});var k=null;d&&(k=JSON.stringify(d));this._doRequest(a,b,g,k,function(h,l,m){if(h)f&&f(h);else if(401==m&&e._password)e._communication_token=null,e._doRestReq(a,b,d,f);else if(200!=m)f&&f(Error("http request failed, response status code: "+m));else if(l)try{var n=JSON.parse(l);if(n)if("OK"!=n.error_description){var p=Error(n.error_description);p.code=n.error_code;f&&f(p)}else f&&f(null,n);else f&&f(Error("invalid http response:"+
l))}catch(q){f&&f(Error("invalid http response:"+l))}else f&&f(Error("http response empty"))})}};c.prototype._doRequest=function(a,b,d,f,e){"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");a={host:this.ip,port:this.port,path:b,method:a,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};if(d)for(var g in d)a.headers[g]=d[g];var k=this;this._logger.log("trace","send http req:"+
JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(a)));f&&this._logger.log("trace","with data: "+f);var h=require("http").request(a,function(l){l.setEncoding("utf-8");var m="";l.on("data",function(n){m+=n});l.on("end",function(){k._logger.log("trace","receive http rsp status code:"+l.statusCode);k._logger.log("trace","receive http rsp:"+m);e&&(e(null,m,l.statusCode,l.headers),e=null)})});h.setTimeout(6E3,function(){k._logger.log("trace","send http req timeout");e&&(e(Error("http timeout")),
e=null);h.abort()});h.on("error",function(l){k._logger.log("trace","send http req err:"+l.message);e&&(e(l),e=null)});f&&h.write(f);h.end()};return c}();xnm.aio.rademacher.Handler=function(){};xnm.aio.rademacher.Handler.prototype.HomePilot=xnm.aio.rademacher.HomePilot;xnm.aio.rademacher.Handler.prototype.Kodi=xnm.aio.rademacher.Kodi;xnm.aio.rademacher.Handler.prototype.getStateValues=function(c,a){return(new xnm.aio.rademacher.HomePilot).getStateValues(c.type,a)};
xnm.aio.rademacher.Handler.prototype.devicemanager=null;xnm.aio.rademacher.Handler.prototype.registModule=function(c){c.register("homepilot1","rademacher");c.register("homepilot2","rademacher");c.register("homepilot2v5","rademacher")};
xnm.aio.rademacher.Handler.prototype.resolveGateway=function(c){if(!c||!c.ip||!c.sys)return null;switch(c.sys){case "homepilot1":return new xnm.aio.rademacher.HomePilot(c.ip,c.port,c.username,c.password,c.uid);case "homepilot2":return new xnm.aio.rademacher.HomePilot2(c.ip,c.port,c.username,c.password,c.uid);case "homepilot2v5":return new xnm.aio.rademacher.HomePilot2V5(c.ip,c.port,c.username,c.password,c.uid);default:return null}};
xnm.aio.rademacher.Handler.prototype.getDeviceCommands=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];a&&a(null,c)};xnm.aio.rademacher.Handler.prototype.getDeviceStatus=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];a&&a(null,c)};xnm.aio.rademacher.Handler.prototype.doCommand=function(c,a,b,d){(c=this.resolveGateway(c))?c.executeCommandCreator(a,b,function(f){d&&d(f)}):d&&d(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.doStatus=function(c,a,b,d,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:c,device:b,status:d}],function(e,g){e?f&&f(e):f&&f(null,g[0])}):f&&f(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.discover=function(c,a,b){var d=require("x.mdns.js");d.clearRecordBuffer();"homepilot2v5"==c?d.discoverServiceWithTimeout("_http._tcp.local",a,function(f,e){if(f)b&&b(f);else{for(var g=[],k=0;k<e.length;k++){var h=e[k];h.domain&&h.ip&&0<h.ip.length&&-1!=h.domain.toLowerCase().indexOf("homepilot")&&(h=new xnm.aio.rademacher.HomePilot2V5(h.ip[0]),g.push(h))}b&&b(f,g)}}):d.discoverServiceWithTimeout("_workstation._tcp.local",a,function(f,e){if(f)b&&b(f);else{for(var g=
[],k=0;k<e.length;k++){var h=e[k];h.target&&h.ip&&0<h.ip.length&&-1!=h.target.toLowerCase().indexOf("homepilot")&&(h="homepilot1"==c?new xnm.aio.rademacher.HomePilot(h.ip[0]):new xnm.aio.rademacher.HomePilot2(h.ip[0]),g.push(h))}b&&b(f,g)}})};
xnm.aio.rademacher.Handler.prototype.getDeviceList=function(c,a){var b=this.resolveGateway(c);if(b)if(b instanceof xnm.aio.rademacher.HomePilot2V5)b.getDevices(function(k,h){a&&a(k,h)});else{var d=this,f=!1,e=!1,g=[];b.getDevices(function(k){f=!0;var h;if(k)for(var l in k)k.hasOwnProperty(l)&&(h=d._device2json(b,k[l],l))&&g.push(h);b instanceof xnm.aio.rademacher.HomePilot2&&g.push({sys:"homepilot2",type:"kodi",port:8080});f&&e&&a&&a(null,g)});b.getMeters(function(k){e=!0;var h="homepilot1";b instanceof
xnm.aio.rademacher.HomePilot2&&(h="homepilot2");var l;if(k)for(var m in k)if(k.hasOwnProperty(m)&&(l=k[m])){if(l.data){var n=b.getSensorTypeFromData(l.data);l.type=n?n:"";l.sys=h}g.push(l)}f&&e&&a&&a(null,g)})}else a&&a(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype._device2json=function(c,a,b){var d=a.type,f="homepilot1";c instanceof xnm.aio.rademacher.HomePilot2&&(f="homepilot2");switch(d){case 1:d="switch";break;case 3:d="sensor";break;case 2:d="blind";break;case 5:d="thermo";break;case 4:d="dimmer";break;case 8:d="gate";break;default:return null}a.sys=f;a.address=b;a.type=d;return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rademacher.Handler);
