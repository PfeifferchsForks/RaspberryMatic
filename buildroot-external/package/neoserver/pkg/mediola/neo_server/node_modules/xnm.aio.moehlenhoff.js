var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.moehlenhoff=xnm.aio.moehlenhoff||{};xnm.aio.moehlenhoff.Alpha2Device=function(){var f=function(a){this._address=a.address;this._name=a.name};f.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"}};return f}();
xnm.aio.moehlenhoff.Alpha2HeatArea=function(){var f=function(a){this._address=a.address;this._dpt=a.dpt;this._name=a.name;this._number=a.number;this._iodevice=a.iodevice};f.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice}};return f}();
xnm.aio.moehlenhoff.Alpha2=function(){var f=function(a,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.moehlenhoff.Alpha2");this._ip=a;this._port=b;if(!this._port||0>this._port)this._port=80};f.prototype.executeCommand=function(a,b,c){var d=a.address.split(":");a=2<=d.length?{id:a.id,type:a.type,address:d[0],dpt:a.data,number:d[1]}:null;this._executeCommand(a,b,c)};f.prototype.getStates=function(a,b,c){var d=function(g,h){if(!h||
!h.Devices)return null;if(h.Devices.Device)return h.Devices.Device.ID==g?h.Devices.Device:null;if(h.Devices.Devices){h=h.Devices.Devices;for(var k=0;k<h.length;k++){var m=h[k];if(m.ID==g)return m}}return null},e=this;b=function(g){for(var h=[],k=0;k<g.length;k++){var m=g[k],l=m.address.split(":");2<=l.length&&h.push({id:m.id,type:m.type,address:l[0],dpt:m.data,number:l[1]})}return h}(b);this._getInfo(function(g,h){if(g)c&&c(g);else{var k,m;if(b&&a.setState)for(g=0;g<b.length;g++){var l=b[g];if(k=
d(l.address,h))switch(l.dpt){case "HEATAREA":var n;a:{if(k&&k.HEATAREAs)for(n=0;n<k.HEATAREAs.length;n++){var p=k.HEATAREAs[n];if(p.NUMBER==l.number){n=p;break a}}n=null}if(n)for(m in k=e._getStateValues(l,n,k),k)k.hasOwnProperty(m)&&a.setState(l.id+":"+m,k[m])}}c&&c("OK")}})};f.prototype._executeCommand=function(a,b,c){if(a)if(a.address)if(b){var d='<?xml version="1.0" encoding="UTF-8"?><Devices><Device><ID>'+a.address+"</ID>%subdev</Device></Devices>";if("vac_off"==b)d=d.replace("%subdev","<VACATION><VACATION_STATE>0</VACATION_STATE><START_DATE>2000-00-00</START_DATE><END_DATE>2000-00-00</END_DATE></VACATION>");
else if("vac_on"==b.name&&b.start&&b.end){var e="<VACATION><VACATION_STATE>1</VACATION_STATE><START_DATE>"+b.start+"</START_DATE><END_DATE>"+b.end+"</END_DATE></VACATION>";d=d.replace("%subdev",e)}switch(a.dpt){case "HEATAREA":if(null==a.number||"undefined"==typeof a.number){c&&c(Error("device number invalid"));return}a='<HEATAREA nr="'+a.number+'">%cmd</HEATAREA>';d=d.replace("%subdev",a);switch(b){case "auto":e="<HEATAREA_MODE>0</HEATAREA_MODE>";break;case "day":e="<HEATAREA_MODE>1</HEATAREA_MODE>";
break;case "night":e="<HEATAREA_MODE>2</HEATAREA_MODE>";break;default:if("string"==typeof b&&b.match(/^w_p/))e="<PROGRAM_WEEK>"+b.replace("w_p","")+"</PROGRAM_WEEK>";else if("string"==typeof b&&b.match(/^we_p/))e="<PROGRAM_WEEKEND>"+b.replace("we_p","")+"</PROGRAM_WEEKEND>";else{var g;"number"==typeof b?g=b/5:b.match(/^[-+]?[0-9]*\.?[0-9]+$/)?g=parseFloat(b/5):c&&c(Error("no such command"));5>g&&(g=5);30<g&&(g=30);e="<T_TARGET>"+g+"</T_TARGET>"}}e&&(d=d.replace("%cmd",e))}this._doRequest({path:"/data/changes.xml",
method:"POST"},d,function(h){c&&c(h)})}else c&&c(Error("command invalid"));else c&&c(Error("device address invalid"));else c&&c(Error("device address format invalid"))};f.prototype._getStates=function(a){var b=this;this._getInfo(function(c,d){c?a&&a(c):(c=b._resolveInfo(d),a&&a(null,c))})};f.prototype._resolveInfo=function(a){if(!a||!a.Devices)return null;var b,c=[];a.Devices.Device&&(b=this._resolveDevice(a.Devices.Device))&&c.push(b);if(a.Devices.Devices){a=a.Devices.Devices;for(var d=0;d<a.length;d++)(b=
this._resolveDevice(a[d]))&&c.push(b)}return c};f.prototype._resolveDevice=function(a){if(!a)return null;var b=this._getStateValues(null,null,a);if(!b)return null;b.id=a.ID;b.heatAreas=[];if(a.HEATAREAs)for(var c=0;c<a.HEATAREAs.length;c++){var d=a.HEATAREAs[c],e=this._getStateValues(null,d,a);e&&(e.number=d.NUMBER,b.heatAreas.push(e))}return b};f.prototype.getDevices=function(a){this._getDevices(function(b,c){if(b)a&&a(b);else if(c){for(var d in c)if(c.hasOwnProperty(d)){b=c[d];for(var e=0;e<b.length;e++)delete b[e]._deviceName}a&&
a(null,c)}else a&&a(null,{})})};f.prototype._getDevices=function(a){this._getInfo(function(b,c){if(b)a&&a(b);else if(b={},c.Devices&&c.Devices.Devices){c=c.Devices.Devices;for(var d=0;d<c.length;d++){var e=c[d];if(e.ID){b[e.ID]=[];var g=e.NAME,h={};if(e.IODEVICEs)for(var k=0;k<e.IODEVICEs.length;k++){var m=e.IODEVICEs[k];m.HEATAREA_NR&&(h[m.HEATAREA_NR]=m)}if(e.HEATAREAs)for(k=0;k<e.HEATAREAs.length;k++)if(m=e.HEATAREAs[k],m.NUMBER){if(h[m.NUMBER]){var l=h[m.NUMBER].IODEVICE_TYPE;switch(l){case "1":case "3":case "4":l=
"analog";break;default:l="digital"}}b[e.ID].push({type:"alpha2",address:e.ID,dpt:"HEATAREA",name:m.HEATAREA_NAME,number:m.NUMBER,iodevice:l,_deviceName:g})}}}a&&a(null,b)}else a&&a(Error("info format invalid"))})};f.prototype._getStateValues=function(a,b,c,d){a={};d="\u00b0C";var e={};if(c){if(c.VACATION){switch(c.VACATION.VACATION_STATE){case "0":a.vacation="off";break;default:a.vacation="on"}c.VACATION.START_DATE&&(a.vacation_start_date=c.VACATION.START_DATE);c.VACATION.START_TIME&&(a.vacation_start_time=
c.VACATION.START_TIME);c.VACATION.END_DATE&&(a.vacation_end_date=c.VACATION.END_DATE);c.VACATION.END_TIME&&(a.vacation_end_time=c.VACATION.END_TIME)}c.TEMPERATUREUNIT&&"0"!=c.TEMPERATUREUNIT&&(d="\u00b0F");if(c.PROGRAM&&c.PROGRAM.SHIFT_PROGRAMs)for(var g=c.PROGRAM.SHIFT_PROGRAMs,h=0;h<g.length;h++){var k=g[h],m=k.NUMBER,l=k.START;k=k.END;m&&l&&k&&(a["prog_"+m]=a["prog_"+m]?a["prog_"+m]+(","+l+"-"+k):l+"-"+k)}if(c.IODEVICEs)for(g=0;g<c.IODEVICEs.length;g++)h=c.IODEVICEs[g],h.HEATAREA_NR&&(e[h.HEATAREA_NR]=
h);if(c.COOLING)switch(c.COOLING){case "0":a.cooling="off";break;case "1":a.cooling="on"}}if(b){switch(b.HEATAREA_MODE){case "0":a.mode="auto";break;case "1":a.mode="day";break;case "2":a.mode="night"}b.T_ACTUAL&&(a.actual_temp=parseFloat(b.T_ACTUAL),a.actual_temp_text=parseFloat(b.T_ACTUAL)+d);b.T_TARGET&&(a.target_temp=parseFloat(5*b.T_TARGET),a.target_temp_text=parseFloat(b.T_TARGET)+d);b.PROGRAM_WEEK&&(a.prog_week_0="inactive",a.prog_week_1="inactive",a.prog_week_2="inactive",a.prog_week_3="inactive",
a["prog_week_"+parseInt(b.PROGRAM_WEEK)]="active");b.PROGRAM_WEEKEND&&(a.prog_weekend_0="inactive",a.prog_weekend_1="inactive",a.prog_weekend_2="inactive",a.prog_weekend_3="inactive",a["prog_weekend_"+parseInt(b.PROGRAM_WEEKEND)]="active");b.PARTY&&(a.party=parseInt(b.PARTY));if(e&&e[b.NUMBER]){d=e[b.NUMBER];switch(d.IODEVICE_TYPE){case "1":case "3":case "4":a.iodevice="analog";break;default:a.iodevice="digital"}if(d.BATTERY)switch(d.BATTERY){case "0":a.battery=0;break;case "1":a.battery=50;break;
case "2":a.battery=100}if(d.SIGNALSTRENGTH)switch(d.SIGNALSTRENGTH){case "0":a.signal=0;break;case "1":a.signal=50;break;case "2":a.signal=100}}}return a};f.prototype._getInfo=function(a){var b=this;this._doRequest({path:"/data/static.xml",method:"GET"},null,function(c,d){if(c)a&&a(c);else try{var e=$($.parseXML(d)),g=b._xml2json(e);a&&a(null,g)}catch(h){a&&a(h)}})};f.prototype._xml2json=function(a){var b=a.children();if(b&&0<b.length){a={};for(var c=0;c<b.length;c++){var d=$(b[c]),e=d.prop("tagName"),
g=this._xml2json(d);if("HEATAREA"==e||"HEATCTRL"==e||"IODEVICE"==e){var h=d.attr("nr");null!=h&&"undefined"!=typeof h&&(g.NUMBER=h)}"SHIFT_PROGRAM"==e&&(h=d.attr("nr"),d=d.attr("shiftingtime"),null!=h&&"undefined"!=typeof h&&(g.NUMBER=h),null!=d&&"undefined"!=typeof d&&(g.SHIFINGTIME=d));"Device"==e||"HEATAREA"==e||"HEATCTRL"==e||"IODEVICE"==e?(a[e+"s"]||(a[e+"s"]=[]),a[e+"s"].push(g)):a[e]&&!a[e+"s"]?(a[e+"s"]=[],a[e+"s"].push(a[e]),a[e+"s"].push(g),delete a[e]):!a[e]&&a[e+"s"]?a[e+"s"].push(g):
a[e]=g}return a}return a.text()};f.prototype._doRequest=function(a,b,c){var d=c;a.host=this._ip;a.port=this._port;a.headers={"Content-Type":'text/xml; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"};"POST"==a.method&&b&&(a.headers["Content-Length"]=b.length);var e=this,g="";c=require("http").request(a,function(h){h.setEncoding("utf8");h.on("data",function(k){g+=k});h.on("end",function(){if(200!=h.statusCode){e._logger.log("warn","Failed to post request to "+e._ip+" with status code:"+
h.statusCode);var k=Error("http request failed with status code:"+h.statusCode)}d&&(d(k,g),d=null)})});c.setTimeout(5E3);c.on("timeout",function(){d&&d(Error("http timeout"));d=null});if(c.on&&"function"==typeof c.on)c.on("error",function(h){d&&d(h);d=null});"POST"==a.method&&b&&c.write(b);c.end()};f.prototype.getDevicesCreator=function(a){this._getDevices(function(b,c){if(b)a&&a(b);else{b={};var d=[];if(c){for(var e in c)if(c.hasOwnProperty(e)){var g=c[e];if(g)for(var h=0;h<g.length;h++){var k=g[h];
k&&(k.address&&!b[k.address]&&(b[k.address]=new xnm.aio.moehlenhoff.Alpha2Device(k),b[k.address]._name=k._deviceName,d.push(b[k.address])),k=new xnm.aio.moehlenhoff.Alpha2HeatArea(k),d.push(k))}}a&&a(null,d)}}})};f.prototype.executeCommandCreator=function(a,b,c){if(a)if(b){var d=b.value;if("vac_on"==b.value){d={name:"vac_on"};for(var e=0;e<b.ext.length;e++){var g=b.ext[e];if(g)switch(g.value){case "start":d.start=g.ext;break;case "end":d.end=g.ext}}}"target_temp"==d&&(d=5*b.ext);this._executeCommand(a,
d,c)}else c&&c(Error("command in null"));else c&&c(Error("device in null"))};f.prototype.getStatesCreator=function(a,b,c){var d=function(e,g,h,k){e=function(m,l){if(!l.heatAreas)return null;for(var n=0;n<l.heatAreas.length;n++)if(l.heatAreas[n]&&l.heatAreas[n].number==m)return l.heatAreas[n];return null};if(!g.address||!h||!h.value)return null;k=function(m,l){for(var n=0;n<l.length;n++)if(l[n]&&l[n].id==m)return l[n];return null}(g.address,k);if(!k)return null;switch(g.dpt){case "HEATAREA":g=e(g.number,
k);if(!g)return null;g=g[h.value];return"target_temp"==h.value?g/5:g;case "DEVICE":return k[h.value]}};this._getStates(function(e,g){if(e)c&&c(e);else{e=[];for(var h=0;h<b.length;h++){var k=b[h],m=d(k.id,k.device,k.status,g);m&&e.push({id:k.id,status:m})}c&&c(null,e)}})};f.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,ip:this._ip,port:this._port}};f.prototype.equalsTo=function(a){return a&&a instanceof f?this._ip==a._ip&&this._port==a._port:!1};f.parseJSON=function(a){return a&&
a.ip?new f(a.ip,a.port):null};return f}();
xnm.aio.moehlenhoff.Alpha2.DM=function(){var f=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};f.prototype=Error();f.prototype.name="Alpha2DMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={alpha2:{DEVICE:{command:[{type:"enum",name:"vacation off",ref:{value:"vac_off"}},{type:"multi",name:"vacation on",ref:{value:"vac_on",ext:"%multi",extMeta:[{type:"string",name:"start date",ref:{value:"start",ext:"%s"}},
{type:"string",name:"end date",ref:{value:"end",ext:"%s"}}]}}],status:[{type:"enum",name:"cooling",ref:{value:"cooling",options:["off","on"]}},{type:"enum",name:"vacation",ref:{value:"vacation",options:["off","on"]}},{type:"string",name:"vacation start date",ref:{value:"vacation_start_date"}},{type:"string",name:"vacation start time",ref:{value:"vacation_start_time"}},{type:"string",name:"vacation end date",ref:{value:"vacation_end_date"}},{type:"string",name:"vacation end time",ref:{value:"vacation_end_time"}},
{type:"string",name:"program 1",ref:{value:"prog_1"}},{type:"string",name:"program 2",ref:{value:"prog_2"}},{type:"string",name:"program 3",ref:{value:"prog_3"}},{type:"string",name:"program 4",ref:{value:"prog_4"}}]},HEATAREA:{command:[{type:"enum",name:"auto mode",ref:{value:"auto"}},{type:"enum",name:"day mode",ref:{value:"day",value_t:"dayMode"}},{type:"enum",name:"night mode",ref:{value:"night",value_t:"nightMode"}},{type:"enum",name:"week program 0",ref:{value:"w_p0"}},{type:"enum",name:"week program 1",
ref:{value:"w_p1"}},{type:"enum",name:"week program 2",ref:{value:"w_p2"}},{type:"enum",name:"week program 3",ref:{value:"w_p3"}},{type:"enum",name:"weekend program 0",ref:{value:"we_p0"}},{type:"enum",name:"weekend program 1",ref:{value:"we_p1"}},{type:"enum",name:"weekend program 2",ref:{value:"we_p2"}},{type:"enum",name:"weekend program 3",ref:{value:"we_p3"}},{type:"float",name:"target temperature",ref:{value:"target_temp",value_t:"temperature",ext:"%f",extMeta:"5-30",scale:"0.2"}}],status:[{type:"enum",
name:"mode",ref:{value:"mode",options:["auto","day","night"]}},{type:"float",name:"actual temperature",ref:{value:"actual_temp"}},{type:"string",name:"actual temperature with unit",ref:{value:"actual_temp_text"}},{type:"float",name:"target temperature",ref:{value:"target_temp",extMeta:"5-30",scale:"0.2"}},{type:"string",name:"target temperature with unit",ref:{value:"target_temp_text"}},{type:"enum",name:"week program 0",ref:{value:"prog_week_0",options:["active","inactive"]}},{type:"enum",name:"week program 1",
ref:{value:"prog_week_1",options:["active","inactive"]}},{type:"enum",name:"week program 2",ref:{value:"prog_week_2",options:["active","inactive"]}},{type:"enum",name:"week program 3",ref:{value:"prog_week_3",options:["active","inactive"]}},{type:"enum",name:"weekend program 0",ref:{value:"prog_weekend_0",options:["active","inactive"]}},{type:"enum",name:"weekend program 1",ref:{value:"prog_weekend_1",options:["active","inactive"]}},{type:"enum",name:"weekend program 2",ref:{value:"prog_weekend_2",
options:["active","inactive"]}},{type:"enum",name:"weekend program 3",ref:{value:"prog_weekend_3",options:["active","inactive"]}}]}}};return{SYS:"alpha2",NEA_SMART_SYS:"neasmart",hasSys:function(b){return b==this.SYS||b==this.NEA_SMART_SYS},registModule:function(b){b.register(this.SYS,"moehlenhoff");b.register(this.NEA_SMART_SYS,"moehlenhoff")},getGatewayType:function(){return[{sys:this.SYS,name:"M\u00f6hlenhoff Alpha2",port:80},{sys:this.NEA_SMART_SYS,name:"REHAU Nea Smart",port:80}]},createGateway:function(b,
c,d){c=f.ERROR_CODE;b?b.ip?d(null,b):d(new f(c.INVALID,"ip is invalid")):d(new f(c.INVALID,"info is invalid"))},updateGateway:function(b,c,d,e){b=f.ERROR_CODE;c?c.ip?e(null,c):e(new f(b.INVALID,"ip is invalid")):e(new f(b.INVALID,"update is invalid"))},deleteGateway:function(b,c,d){d()},createDevice:function(b,c,d){var e=f.ERROR_CODE;if(b.gateway)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){var h=c[g];break}h?d(null,
b):d(new f(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else d(new f(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else d(new f(e.INVALID,"gateway is invalid"))},updateDevice:function(b,c,d){var e=f.ERROR_CODE;if(b)if(b.gateway){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){var h=c[g];break}h?d(null,b):d(new f(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else d(new f(e.INVALID,"gateway is invalid"));else d(new f(e.INVALID,"info is invalid"))},
deleteDevice:function(b,c,d){d()},getCommandStatusMap:function(b){if(!b||!b.sys||!b.dpt)return null;var c=b.sys;c==this.NEA_SMART_SYS&&(c=this.SYS);c=a[c];if(!c)return null;c=c[b.dpt];if("analog"==b.iodevice){b={command:[],status:c.status};for(var d=0;d<c.command.length;d++){var e=c.command[d];"target_temp"!=e.ref.value&&b.command.push(e)}c=b}return c}}}();xnm.aio.rehau=xnm.aio.rehau||{};
xnm.aio.rehau.NeaSmartDevice=function(){var f=function(a){this._address=a.address;this._name=a.name};f.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"}};return f}();
xnm.aio.rehau.NeaSmartHeatArea=function(){var f=function(a){this._address=a.address;this._dpt=a.dpt;this._name=a.name;this._number=a.number;this._iodevice=a.iodevice};f.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice}};return f}();xnm.aio.rehau.NeaSmart=function(f,a){xnm.aio.moehlenhoff.Alpha2.call(this,f,a);this._logger=require("x.logger.js").getLogger("xnm.aio.rehau.NeaSmart")};
xnm.aio.rehau.NeaSmart.prototype=new xnm.aio.moehlenhoff.Alpha2;xnm.aio.rehau.NeaSmart.prototype.constructor=xnm.aio.rehau.NeaSmart;xnm.aio.rehau.NeaSmart.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,ip:this._ip,port:this._port}};xnm.aio.rehau.NeaSmart.prototype.equalsTo=function(f){return f&&f instanceof xnm.aio.rehau.NeaSmart?this._ip==f._ip&&this._port==f._port:!1};xnm.aio.rehau.NeaSmart.parseJSON=function(f){return f&&f.ip?new xnm.aio.rehau.NeaSmart(f.ip,f.port):null};
xnm.aio.rehau.NeaSmart.prototype.getDevicesCreator=function(f){this._getDevices(function(a,b){if(a)f&&f(a);else{a={};var c=[];if(b){for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if(e)for(var g=0;g<e.length;g++){var h=e[g];h&&(h.address&&!a[h.address]&&(a[h.address]=new xnm.aio.rehau.NeaSmartDevice(h),a[h.address]._name=h._deviceName,c.push(a[h.address])),h=new xnm.aio.rehau.NeaSmartHeatArea(h),c.push(h))}}f&&f(null,c)}}})};xnm.aio.rehau.NeaSmart.DM={SYS:xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS};
xnm.aio.moehlenhoff.DM=function(){var f=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};f.prototype=Error();f.prototype.name="MoehlenhoffDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{getGatewayType:function(a){var b=[],c;for(c in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(c)){var d=xnm.aio.moehlenhoff[c];d&&d.DM&&d.DM.getGatewayType&&((d=d.DM.getGatewayType(a))&&Array.isArray(d)?b=
b.concat(d):b.push(d))}return b},_getSystem:function(a){for(var b in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(b)){var c=xnm.aio.moehlenhoff[b];if(c&&c.DM&&c.DM.SYS&&c.DM.SYS==a||c&&c.DM&&c.DM.hasSys&&c.DM.hasSys(a))return c}return null},createGateway:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.sys){var e=this._getSystem(a.sys);e&&e.DM&&e.DM.createGateway?e.DM.createGateway(a,b,c):c&&c(new f(d.INVALID,"no such sys:"+a.sys))}else c&&c(new f(d.INVALID,"sys is invalid"));else c&&c(new f(d.INVALID,
"info is invalid"))},updateGateway:function(a,b,c,d){var e=f.ERROR_CODE;if(b)if(b.sys){var g=this._getSystem(b.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(a,b,c,d):d&&d(new f(e.INVALID,"no such sys:"+b.sys))}else d&&d(new f(e.INVALID,"sys is invalid"));else d&&d(new f(e.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.sys){var e=this._getSystem(a.sys);e&&e.DM&&e.DM.deleteGateway?e.DM.deleteGateway(a,b,c):c&&c(new f(d.INVALID,"no such sys:"+a.sys))}else c&&
c(new f(d.INVALID,"sys is invalid"));else c&&c()},createDevice:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.sys){var e=this._getSystem(a.sys);e&&e.DM&&e.DM.createDevice?e.DM.createDevice(a,b,c):c&&c(new f(d.INVALID,"no such sys:"+a.sys))}else c&&c(new f(d.INVALID,"sys is invalid"));else c&&c(new f(d.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.sys){var e=this._getSystem(a.sys);e&&e.DM&&e.DM.updateDevice?e.DM.updateDevice(a,b,c):c&&c(new f(d.INVALID,"no such sys:"+
a.sys))}else c&&c(new f(d.INVALID,"sys is invalid"));else c&&c(new f(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){var d=f.ERROR_CODE;if(a)if(a.sys){var e=this._getSystem(a.sys);e&&e.DM&&e.DM.deleteDevice?e.DM.deleteDevice(a,b,c):c&&c(new f(d.INVALID,"no such sys:"+a.sys))}else c&&c(new f(d.INVALID,"sys is invalid"));else c&&c()},applyUIFilter:function(a,b){var c=function(k,m){if("*"==k)return!0;for(var l=!1,n=0;n<k.length;n++)if(k[n]==m){l=!0;break}return l},d=function(k,m,l){var n=
[];switch(l.catagory){case "command":k.command&&k.command.forEach(function(p){c(l.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))});break;case "status":k.status&&k.status.forEach(function(p){c(l.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))})}return n},e=function(k,m){var l=[],n;if(k.sys){var p=this._getSystem(k.sys);p&&p.DM&&p.DM.getCommandStatusMap&&(n=p.DM.getCommandStatusMap(k))}n&&(k=d(n,k,m),l=l.concat(k));return l};if(!a.sys)return null;var g=JSON.parse(JSON.stringify(a)),
h=null;switch(b.catagory){case "command":h=e.call(this,a,b);g.command=h;break;case "status":h=e.call(this,a,b);g.status=h;break;default:return null}return h&&0!=h.length?g:null}}}();
xnm.aio.moehlenhoff.Handler=function(){var f=function(){var a=require("x.logger.js");xnm.aio.moehlenhoff.DM._logger=a?a.getLogger("xnm.aio.moehlenhoff.DM"):{log:function(){}}};f.prototype.Alpha2=xnm.aio.moehlenhoff.Alpha2;f.prototype.NeaSmart=xnm.aio.rehau.NeaSmart;f.prototype.getDeviceCommandList=function(a,b){b=[];if("analog"==a.data||"digital"==a.data)b.push({id:window.XC_Text.auto,cmd:"auto"}),b.push({id:window.XC_Text.day,cmd:"day"}),b.push({id:window.XC_Text.night,cmd:"night"}),b.push({id:window.XC_Text.w_p0,
cmd:"w_p0"}),b.push({id:window.XC_Text.w_p1,cmd:"w_p1"}),b.push({id:window.XC_Text.w_p2,cmd:"w_p2"}),b.push({id:window.XC_Text.w_p3,cmd:"w_p3"}),b.push({id:window.XC_Text.we_p0,cmd:"we_p0"}),b.push({id:window.XC_Text.we_p1,cmd:"we_p1"}),b.push({id:window.XC_Text.we_p2,cmd:"we_p2"}),b.push({id:window.XC_Text.we_p3,cmd:"we_p3"});"digital"==a.data&&(a=this.getDeviceCommandListDigital(),b.push.apply(b,a));return b};f.prototype.getDeviceCommandListDigital=function(){for(var a=[],b=4.8,c=24,d=0;126>d;d++)b+=
.2,c++,a.push({id:window.XC_Text.target_temp+b.toFixed(1),cmd:c});return a};f.prototype.devicemanager=xnm.aio.moehlenhoff.DM;f.prototype.registModule=function(a){for(var b in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(b)){var c=xnm.aio.moehlenhoff[b];c&&c.DM&&c.DM.registModule&&c.DM.registModule(a)}};f.prototype.resolveGateway=function(a){if(!a)return null;switch(a.sys){case xnm.aio.moehlenhoff.Alpha2.DM.SYS:return xnm.aio.moehlenhoff.Alpha2.parseJSON(a);case xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS:return xnm.aio.rehau.NeaSmart.parseJSON(a);
default:return null}};f.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.moehlenhoff.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};f.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.moehlenhoff.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};f.prototype.getDevices=function(a,b){a?(a=this.resolveGateway(a))?a.getDevicesCreator?a.getDevicesCreator(function(c,d){b&&b(c,d)}):b&&b(Error("gateway do not have getDevicesCreator function")):
b&&b(Error("gatewayJSON invalid")):b&&b(Error("gatewayJSON is empty"))};f.prototype.doCommand=function(a,b,c,d){a?(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){d&&d(e)}):d&&d(Error("gatewayJSON invalid")):d&&d(Error("gatewayJSON is empty"))};f.prototype.doStatus=function(a,b,c,d,e){b?(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(g,h){g?e&&e(g):e&&e(null,h[0])}):e&&e(Error("gatewayJSON invalid")):e&&e(Error("gatewayJSON is empty"))};return f}();
"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.moehlenhoff.Handler);
