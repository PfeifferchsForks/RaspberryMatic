var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(h){var d=0;return function(){return d<h.length?{done:!1,value:h[d++]}:{done:!0}}};$jscomp.arrayIterator=function(h){return{next:$jscomp.arrayIteratorImpl(h)}};$jscomp.makeIterator=function(h){var d="undefined"!=typeof Symbol&&Symbol.iterator&&h[Symbol.iterator];return d?d.call(h):$jscomp.arrayIterator(h)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(h,d,b){if(h==Array.prototype||h==Object.prototype)return h;h[d]=b.value;return h};
$jscomp.getGlobal=function(h){h=["object"==typeof globalThis&&globalThis,h,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var d=0;d<h.length;++d){var b=h[d];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(h,d){var b=$jscomp.propertyToPolyfillSymbol[d];if(null==b)return h[d];b=h[b];return void 0!==b?b:h[d]};$jscomp.polyfill=function(h,d,b,c){d&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(h,d,b,c):$jscomp.polyfillUnisolated(h,d,b,c))};
$jscomp.polyfillUnisolated=function(h,d,b,c){b=$jscomp.global;h=h.split(".");for(c=0;c<h.length-1;c++){var a=h[c];if(!(a in b))return;b=b[a]}h=h[h.length-1];c=b[h];d=d(c);d!=c&&null!=d&&$jscomp.defineProperty(b,h,{configurable:!0,writable:!0,value:d})};
$jscomp.polyfillIsolated=function(h,d,b,c){var a=h.split(".");h=1===a.length;c=a[0];c=!h&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<a.length-1;f++){var e=a[f];if(!(e in c))return;c=c[e]}a=a[a.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?c[a]:null;d=d(b);null!=d&&(h?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:d}):d!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[a]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(a):$jscomp.POLYFILL_PREFIX+b+"$"+a),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:d})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(h){if(h)return h;var d=function(f,e){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:e})};d.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",c=0,a=function(f){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new d(b+(f||"")+"_"+c++,f)};return a},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(h){if(h)return h;h=Symbol("Symbol.iterator");for(var d="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<d.length;b++){var c=$jscomp.global[d[b]];"function"===typeof c&&"function"!=typeof c.prototype[h]&&$jscomp.defineProperty(c.prototype,h,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return h},"es6",
"es3");$jscomp.iteratorPrototype=function(h){h={next:h};h[Symbol.iterator]=function(){return this};return h};$jscomp.iteratorFromArray=function(h,d){h instanceof String&&(h+="");var b=0,c=!1,a={next:function(){if(!c&&b<h.length){var f=b++;return{value:d(f,h[f]),done:!1}}c=!0;return{done:!0,value:void 0}}};a[Symbol.iterator]=function(){return a};return a};$jscomp.polyfill("Array.prototype.keys",function(h){return h?h:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6","es3");
require("x.core.js");var x=x||{};x.hub=x.hub||{};
x.hub.Dispatcher=function(){var h=function(d){this._expressApp=d;this._routes=[]};h.prototype.add=function(d,b,c){if(!d||!c)throw Error("invalid arguments");this._routes.push({path:d,opts:b,callback:c})};h.prototype.doRequest=function(d,b,c,a){var f=this,e=function(k,g,m,p){f._findRoute(k,g,function(t,n){t?t.callback(m,p,function(){e(n+1,g,m,p)}):a()})};e(0,d,b,c)};h.prototype._findRoute=function(d,b,c){for(;d<this._routes.length;d++){var a=this._routes[d];if(a&&0==a.path.indexOf(b)){c(a,d);return}}c(null,
-1)};h.prototype.init=function(){var d=this;this._expressApp.use("/",function(b,c,a){d.doRequest(b.path,b,c,a)})};return h}();
x.hub.Auth=function(){var h=function(){};h.prototype.auth=function(d,b){if(!b||!b.pwd)return!0;if(!d.query.at&&d.query.auth){var c=require("x.crypt.js");d.query.at=c.MD5(unescape(encodeURI(d.query.auth+"_SALT!")))}return d.query.at&&d.query.at==b.pwd?!0:d.headers&&d.headers.authorization?this._checkAuthHeader(d.headers.authorization,b):!1};h.prototype._checkAuthHeader=function(d,b){return d&&"Basic "==d.substr(0,6)?(d=d.substr(6).trim(),(d=(new Buffer(d,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(d+
"_SALT!")))==b.pwd:!1):!1};return h}();x.hub.Error=function(){var h=function(d,b){Error.call(this,d);this.code=b?b:"000000"};require("util").inherits(h,Error);return h}();
x.hub.Dispatcher2=function(){var h=function(d,b){this._expressApp=d;this._server=b;this._routes=[]};h.prototype.add=function(d,b,c){if(!d)throw Error("invalid arguments");b&&"function"==typeof b&&!c&&(c=b,b=null);if(!c)throw Error("invalid arguments");this._routes.push({path:d,opts:b,callback:c})};h.prototype.doRequest=function(d,b,c){var a=this,f=function(e,k,g){a._findRoute(e,k,function(m,p){if(m)try{a._doRoute(m,k,g,function(){f(p+1,k,g)})}catch(t){g.json({XC_ERR:{code:"000000",msg:t.message}})}else c()})};
f(0,d,b)};h.prototype._doRoute=function(d,b,c,a){var f=function(g,m,p,t,n,q){"cloud"==m.source?(m.hasValidAuth=!0,q()):(t=t.auth(m,n),m.hasValidAuth=t,g.opts&&0==g.opts.auth?q():t?q():p.json({XC_ERR:{code:"000007",msg:"access denied"}}))},e=this._server._auth,k={pwd:this._server._pwd};(function(g,m,p,t){if("cloud"==m.source)t();else if(g.opts&&"stream"==g.opts.body)t();else if("POST"!=m.method&&"PUT"!=m.method||"application/octet-stream"==m.header("content-type"))t();else{var n=new Buffer([]);m.on("data",
function(q){n=Buffer.concat([n,q])});m.on("end",function(){m.size=n.length;m.body=n.toString("utf8");m.json=null;if(!g.opts||!g.opts.body||"json"==g.opts.body)try{m.json=JSON.parse(n)}catch(q){}t()})}})(d,b,c,function(){f(d,b,c,e,k,function(){d.callback(b,c,function(){a()})})})};h.prototype._findRoute=function(d,b,c){for(var a=function(g,m){return"/"==m&&g!=m?!1:m.length<=g.length&&g.substr(0,m.length)==m?!0:"*"==m?!0:!1},f=function(g,m){return 0!=(("webserver"==g?1:"cloud"==g?2:3)&m)},e=b.path;d<
this._routes.length;d++){var k=this._routes[d];if(k&&k.path&&a(e,k.path)){if(k.opts){if(k.opts.method&&b.method&&b.method.toLowerCase()!=k.opts.method.toLowerCase())continue;if(k.opts.source&&!f(b.source,k.opts.source))continue}c(k,d);return}}c(null,-1)};h.prototype.init=function(){var d=this;this._expressApp.use("/",function(b,c,a){d.doRequest(b,c,a)})};return h}();
x.hub.Auth2=function(){var h=function(){};h.prototype.auth=function(d,b){if(!b||!b.pwd)return!0;var c=require("x.crypt.js");if(d.query){if(d.query.at){if(d.query.at==b.pwd)return delete d.query.at,!0;delete d.query.at}if(d.query.auth){if(c.MD5(unescape(encodeURI(d.query.auth+"_SALT!")))==b.pwd)return delete d.query.auth,!0;delete d.query.auth}}if(d.json){if(d.json.at){if(d.json.at==b.pwd)return delete d.json.at,!0;delete d.json.at}if(d.json.auth){if(c.MD5(unescape(encodeURI(d.json.auth+"_SALT!")))==
b.pwd)return delete d.json.auth,!0;delete d.json.auth}}return d.headers&&d.headers.authorization?this._checkAuthHeader(d.headers.authorization,b):!1};h.prototype._checkAuthHeader=function(d,b){return d&&"Basic "==d.substr(0,6)?(d=d.substr(6).trim(),(d=(new Buffer(d,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(d+"_SALT!")))==b.pwd:!1):!1};return h}();
x.hub.Server=function(h,d,b){this._logger=require("x.logger.js").getLogger("x.hub.Server");this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=h;this._hmPort=d;this._signalPin=b;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._dispatcher=new x.hub.Dispatcher(this._app);this._httpserver=require("http").createServer(this._app);
this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var c=require("x.logger.js");c&&(this._logger=c.getLogger("x.hub.Server"));var a=require("x.hub.eventbus.js");a&&(a.on("udpevent",this.onUdpEvt.bind(this)),a.on("status",this.onStatusEvt.bind(this)))}catch(f){}localStorage&&("EA"==global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C")),"CA"!=global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.geo.lat")||
localStorage.setItem("x.hub.Server.geo.lat","1392"),localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C")),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd")));this._auth=new x.hub.Auth};x.hub.Server.prototype.auth=function(h){return this._auth.auth(h,{pwd:this._pwd})};
x.hub.Server.prototype.getNetworkSettings=function(h){if("A20"==this.hostType)require("x.hub.v5.js").Native.getIPData(function(k){h&&h(null,k)});else{var d={},b=require("os");if(b&&b.networkInterfaces){b=b.networkInterfaces();for(var c in b){d[c]||(d[c]=[]);for(var a=b[c],f=0;f<a.length;f++)if("IPv4"==a[f].family&&!1===a[f].internal){var e=this._getIPData(a[f]);d[c].push(e)}}}h&&h(null,d)}};
x.hub.Server.prototype._getIPData=function(h){var d={};d.IP=h.address;d.PT=this._port;d.SN="255.255.255.0";h.netmask&&(d.SN=h.netmask);d.GW="0.0.0.0";var b=null;try{b=require("netroute")}catch(a){}if(b&&(b=b.getInfo())&&b.IPv4)for(var c=0;c<b.IPv4.length;c++)if("0.0.0.0"==b.IPv4[c].destination){d.GW=b.IPv4[c].gateway;break}d.DNS="0.0.0.0";(b=require("dns"))&&b.getServers&&(b=b.getServers())&&0<b.length&&(d.DNS=b[0]);d.MAC="00-00-00-00-00-00";h.mac&&(d.MAC=h.mac.replace(/:/g,"-"));return d};
x.hub.Server.prototype.addRoute=function(h,d,b){"function"==typeof d&&(b=d,d=null);return this._dispatcher.add(h,d,b)};
x.hub.Server.prototype.start=function(h){this._port=h;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var d=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(b){if(b&&b.type&&b.data)if(80==b.type&&d._onSerialEvent){b=b.data.toString();var c=null;8<b.length&&"{XC_EVT}"==b.substr(0,8)?(b=b.substr(8),c="EVT"):4<b.length&&"EVT:"==b.substr(0,4)?(b=b.substr(4),c="EVT"):4<b.length&&"STA:"==b.substr(0,4)&&(b=b.substr(4),c="STA");d._onSerialEvent(b,c)}else 82==b.type&&d._onCustomSerialEvent&&d._onCustomSerialEvent(b.data)})}};
x.hub.Server.prototype.startSTM=function(h){if(this._stmPort){var d=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,h);this._stmUSB.on("data",function(b){if(b&&b.type&&b.data)if(80==b.type&&d._onSerialEvent){b=b.data.toString();var c=null;8<b.length&&"{XC_EVT}"==b.substr(0,8)?(b=b.substr(8),c="EVT"):4<b.length&&"EVT:"==b.substr(0,4)?(b=b.substr(4),c="EVT"):4<b.length&&"STA:"==b.substr(0,4)&&(b=b.substr(4),c="STA");d._onSerialEvent(b,c)}else 82==b.type&&d._onCustomSerialEvent&&
d._onCustomSerialEvent(b.data)})}};
x.hub.Server.prototype.startWebserver=function(h,d){this._port=h;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var b=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("******* http server ("+
h+") started ********");console.log("************* ++++++++++++++++++ **************");b++;2==b&&d&&d()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("********** upd server (1901) started **********");console.log("************* ++++++++++++++++++ **************");b++;2==b&&d&&d()})};x.hub.Server.prototype.on=function(h,d){"serialevent"==h?this._onSerialEvent=d:"customserialevent"==h&&(this._onCustomSerialEvent=d)};
x.hub.Server.prototype._getServerFromReq=function(h){if(h.query.server)return h.query.server;var d=null;h.ip?d=h.ip:h.connection.remoteAddress&&(d=h.connection.remoteAddress);d&&-1<d.indexOf(":")&&d.indexOf(".")>d.indexOf(":")?d=d.substr(d.lastIndexOf(":")+1):"::1"==d&&(d="localhost");return d};x.hub.Server.prototype.enableCloudConnect=function(h){this._cloudConnect=h;h.init(this)};
x.hub.Server.prototype.restart=function(h){XC.debugf("RESTART!");var d=this;setTimeout(function(){"A20"==d.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},h)};x.hub.Server.prototype.resHasError=function(h){var d=null;try{d=JSON.parse(h)}catch(b){d=null}return d&&d.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(h,d,b){this._stmUSB&&h&&-1<h.indexOf("?")?(h=h.substr(h.indexOf("?")+1),this._stmUSB.sendCommand(16,h,function(c){c&&c.data?XC.debugf(h+" --\x3e "+c.data.toString()):c&&c.error?XC.debugf(h+" --\x3e FAIL:"+c.error):XC.debugf(h+" --\x3e FAIL");if(c&&c.data){var a="XC_SUC";c.error&&(a="XC_ERR");d?b("{"+a+"}"+c.data.toString()):b('{"'+a+'": '+c.data.toString()+"}")}else d?b("{XC_ERR}internal error"):c&&c.error?b(JSON.stringify({XC_ERR:{code:"000000",
msg:c.error}})):b('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):d?b("{XC_ERR}invalid request"):b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(h,d){this._doSTMCommandRequest("/cmd?"+h,!1,function(b){var c=null;try{c=JSON.parse(b)}catch(a){c=null}d&&d(c)})};x.hub.Server.prototype.doSTMRequest=function(h,d,b){this._stmUSB?this._stmUSB.sendCommand(h,d,function(c){c?c.error?b(null):b(c.data):b(null)}):b(null)};
x.hub.Server.prototype.setCommandFunc=function(h,d){this._commandFunctions[h.toLowerCase()]=d};x.hub.Server.prototype.setCmdFunc=function(h,d){this._cmdFunctions[h.toLowerCase()]=d};
x.hub.Server.prototype.doRequest=function(h,d,b){var c=require("os");if("/"==h){var a='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n');a=a+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");a=a+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");a+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var f=Math.round((new Date).getTime()/1E3)-this._startup,e=Math.floor(f/86400);f-=86400*e;h=Math.floor(f/3600);f-=3600*h;var k=
Math.floor(f/60);a+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+e+"d "+h+"h "+k+"m "+(f-60*k)+"s</b></td></tr>\n";c&&c.freemem&&(a+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(c.freemem()/1E3)+"</b></td></tr>\n");b(a+'<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
h){var g={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};h="8C";k="1392";var m="035C";localStorage.getItem("x.hub.Server.timezone")&&(h=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(k=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(m=localStorage.getItem("x.hub.Server.geo.long"));g.XC_SUC.loc=(h+
k+m).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(g.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?g.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(h=require("x.hub.v5.js").CloudConnect,g.XC_SUC.server=h.prototype.CLOUD_SERVER+":"+h.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(g.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));
localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(g.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(g.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(g.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));c&&c.freemem&&(g.XC_SUC.mem=Math.floor(c.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&
(f=require("x.hub.m.enocean.js"))&&(e=f.getEnoceanInfo(),g.XC_SUC.enocean=e)}catch(q){}if("A20"==this.hostType){g.XC_SUC.SAFE_MODE=global.SAFE_MODE;a=require("x.hub.v5.js");var p=function(q){return{ip:q.IP,sn:q.SN,gw:q.GW,dhcp:q.DHCP,dns:q.DNS,mac:q.MAC,ntp:q.NTP}};a.Native.getIPData(function(q){var v=null,D=null;Array.isArray(q.eth0)&&(v=p(q.eth0[0]));Array.isArray(q.wlan0)&&(D=p(q.wlan0[0]));q=v||D;for(var z in q)g.XC_SUC[z]=q[z];g.XC_SUC.primary_net=q===v?"eth0":"wlan0";g.XC_SUC.cfg&&q&&(v=parseInt(g.XC_SUC.cfg,
16),v=!0===q.dhcp?v&-129:v|128,g.XC_SUC.cfg=v.toString(16),2>g.XC_SUC.cfg.length&&(g.XC_SUC.cfg="0"+g.XC_SUC.cfg),g.XC_SUC.cfg=g.XC_SUC.cfg.toUpperCase());q!=D&&D&&(g.XC_SUC.wlan0=D);b(JSON.stringify(g))})}else if(require("dgram"),c&&c.networkInterfaces){c=c.networkInterfaces();for(a in c)if(c.hasOwnProperty(a))for(f=c[a],e=0;e<f.length;e++)"IPv4"==f[e].family&&!1===f[e].internal&&(h=this._getIPData(f[e]),k=null,d&&d.headers&&d.headers.host&&(k=d.headers.host,m=k.indexOf(":"),-1!=m&&(k=k.substr(0,
m))),!k||k!=h.IP&&"localhost"!=k&&"127.0.0.1"!=k||(g.XC_SUC.ip=h.IP,g.XC_SUC.sn=h.SN,g.XC_SUC.gw=h.GW,g.XC_SUC.dns=h.DNS,g.XC_SUC.mac=h.MAC));b(JSON.stringify(g))}}else if("/set"==h)d.query.rgb&&6==d.query.rgb.length&&(a=require("x.hub.v5.js"),a.setRGBColor(d.query.rgb)),b('{"XC_SUC": {}}');else if("/cmd"==h)if((a=d.query.XC_FNC)&&this._cmdFunctions[a.toLowerCase()]){var t=this;this._cmdFunctions[a.toLowerCase()](d,function(q){q?b(q):"POST"==d.method?t._doSTMCommandRequest(d,!1,b):t._doSTMCommandRequest(d.url,
!1,b)})}else"POST"==d.method?this._doSTMCommandRequest(d,!1,b):this._doSTMCommandRequest(d.url,!1,b);else if("/executeCommand"==h)a=require("x.logger.js").getLogger("GeneralExecuteCommand API"),a.log("trace","general execute command:"+JSON.stringify(d.query)),d.query&&d.query.data?(c=d.query.type,a=d.query.data,a.device&&!a.device.sys&&(a.device.sys=c),a.gateway&&!a.gateway.sys&&(a.gateway.sys=c),c=require("x.hub.commandman.js"),c.commandHandler.executeCommand(a.device,a.gateway,a.command,function(q){q.error?
b('{"XC_ERR":{"code":"000000","msg":"'+q.error.message+'"}}'):b('{"XC_SUC":{}}')})):b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==h)a=require("x.logger.js").getLogger("GeneralGetStates API"),a.log("trace","general get states:"+JSON.stringify(d.query)),d.query&&d.query.data?(c=d.query.type,a=d.query.data,a.device&&!a.device.sys&&(a.device.sys=c),a.gateway&&!a.gateway.sys&&(a.gateway.sys=c),c=require("x.hub.commandman.js"),a.deviceList?c.commandHandler.getMultiStatesLegacy(a.device,
a.gateway,a.deviceList,function(q){q.error?b('{"XC_ERR":{"code":"000000","msg":"'+q.error.message+'"}}'):q&&q.data?b(JSON.stringify({XC_SUC:{data:JSON.stringify(q.data)}})):b('{"XC_SUC":{}}')}):c.commandHandler.getState(a.device,a.gateway,a.status,function(q){q.error?b('{"XC_ERR":{"code":"000000","msg":"'+q.error.message+'"}}'):q&&q.data?b(JSON.stringify({XC_SUC:{data:JSON.stringify(q.data)}})):b('{"XC_SUC":{}}')})):b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else{var n=b;a={json:function(q){n&&
(n(JSON.stringify(q)),n=null)},send:function(q){n&&(n(q),n=null)},status:function(){},end:function(){n&&(n(),n=null)}};this._dispatcher.doRequest(h,d,a,function(){n&&(n('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),n=null)})}};
x.hub.Server.prototype._preHandleRequest=function(h,d,b){if("POST"==h.method&&"application/octet-stream"!=h.header("content-type"))if(h.json){if(h.query&&0<Object.keys(h.query).length&&this.auth(h)){h.query=h.json;b();return}h.query=h.json}else if("text/plain"!=h.header("content-type")&&"text/xml"!=h.header("content-type")&&"application/xml"!=h.header("content-type")){d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}this.auth(h)?b():d.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(h){this._app.set("case sensitive routing",!0);var d=this;this._app.use(function(b,c,a){c.header("Access-Control-Allow-Origin","*");c.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+b.url);if("/"==require("url").parse(b.url).pathname)d.doRequest("/",b,function(e){c.send(e)});else if("POST"==b.method&&"application/octet-stream"!=
b.header("content-type")){var f=new Buffer([]);b.on("data",function(e){f=Buffer.concat([f,e])});b.on("end",function(){b.body=f.toString("utf8");b.json=null;try{b.json=JSON.parse(f)}catch(e){}d._preHandleRequest(b,c,a)})}else d._preHandleRequest(b,c,a)});this._app.get("/info",function(b,c){try{d.doRequest("/info",b,function(a){c.send(a)})}catch(a){console.error(a)}});this._app.get("/set",function(b,c){d.doRequest("/set",b,function(a){c.send(a)})});this._app.get("/cmd",function(b,c){d.doRequest("/cmd",
b,function(a){c.send(a)})});this._app.post("/cmd",function(b,c){d.doRequest("/cmd",b,function(a){c.send(a)})});this._app.get("/command",function(b,c){XC.debugf("command: "+b.url);var a=b.query.XC_FNC;if(a&&d._commandFunctions[a.toLowerCase()])d._commandFunctions[a.toLowerCase()](b,c);else d._doSTMCommandRequest(b.url,!0,function(f){c.send(f)})});this._app.post("/executeCommand",function(b,c){d.doRequest("/executeCommand",b,function(a){c.send(a)})});this._app.post("/getStates",function(b,c){d.doRequest("/getStates",
b,function(a){c.send(a)})});this._app.get("/config",function(b,c){var a=!0,f=!1;b.query.name&&0<b.query.name.length&&(d._name=b.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",b.query.name));b.query.vid&&0<b.query.vid.length&&(d._vid=b.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",b.query.vid));if(b.query.pwd||""==b.query.pwd)f=require("x.crypt.js"),0===b.query.pwd.length?(d._pwd="",b.query.cloud=0):d._pwd=f.MD5(unescape(encodeURI(b.query.pwd+"_SALT!"))),localStorage&&
localStorage.setItem("x.hub.Server.pwd",d._pwd),f=!0;if(b.query.loc){if(2==b.query.loc.length)var e=b.query.loc;else if(8==b.query.loc.length){var k=b.query.loc.substr(0,4);var g=b.query.loc.substr(4)}else 10==b.query.loc.length&&(e=b.query.loc.substr(0,2),k=b.query.loc.substr(2,4),g=b.query.loc.substr(6));e&&localStorage&&localStorage.setItem("x.hub.Server.timezone",e);k&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",k);g&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",g);
if("A1"==d.HWV)a=!1,d._platform.setLocation(k,g,function(n){n?c.json({XC_ERR:{code:"000000",msg:"set coordinate failed: "+n.message}}):d._platform.setTZData(e,function(q){q?c.json({XC_ERR:{code:"000000",msg:"set timezone failed: "+q.message}}):c.json({XC_SUC:{}})})});else{var m=require("x.hub.eventbus.js");m.emit("locationchange",{timezone:e,lat:k,long:g})}}b.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",b.query.neoserver),m=require("x.hub.eventbus.js"),m.emit("neoserver_activation",
b.query.neoserver));b.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",b.query.ccu_init_state),m=require("x.hub.eventbus.js"),m.emit("x.hub.m.hm.CCU_INIT_STATE",b.query.ccu_init_state));b.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",b.query.disable_st_states);if("A20"==d.hostType||"CA"==d.HWV)g={},b.query.ip&&b.query.sn&&b.query.gw&&b.query.dns&&(g.IP=b.query.ip,g.SN=b.query.sn,g.GW=b.query.gw,g.DNS=b.query.dns,g.DHCP=
!1),b.query.dhcp&&1==b.query.dhcp&&(g={DHCP:!0}),b.query.ntp&&(g.NTP=b.query.ntp),b.query.mac&&(g.MAC=b.query.mac),0<Object.keys(g).length&&("EA"==d.HWV?(a=!1,k=require("x.hub.v5.js"),k.Native.setIPData(d,g,function(n){n?(c.send('{"XC_SUC":{}}'),d.restart(1E3)):c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):"CA"==d.HWV&&(a=!1,require("x.hub.v6.js").setIPData(g,function(n,q){n?c.json({XC_ERR:{code:"000000",msg:n.message}}):(c.json({XC_SUC:{}}),q&&d.restart(1E3))})));b.query.sid&&
localStorage&&(localStorage.setItem("x.hub.v5.SID",b.query.sid),f=!0);b.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",b.query.ckey),f=!0);b.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",b.query.cserver),f=!0);b.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",b.query.cport),f=!0);b.query.cloud&&localStorage&&(f=255,localStorage.getItem("x.hub.v5.config")&&(f=parseInt(localStorage.getItem("x.hub.v5.config"),16)),f=1==b.query.cloud?
f&-65:f|64,f=f.toString(16),2>f.length&&(f="0"+f),localStorage.setItem("x.hub.v5.config",f.toUpperCase()),f=!0);if("A20"==d.hostType&&b.query.year&&b.query.month&&b.query.date&&b.query.hour&&b.query.minute){a=!1;g=parseInt(b.query.year);m=parseInt(b.query.month);var p=parseInt(b.query.date),t=parseInt(b.query.hour);b=parseInt(b.query.minute);if(isNaN(g)||1970>g||9999<g){c.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(m)||1>m||12<m){c.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');
return}if(isNaN(p)||1>p||31<p){c.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(t)||0>t||23<t){c.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');return}if(isNaN(b)||0>b||59<b){c.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}k=require("x.hub.v5.js");k.Native.setDateTime(g,m,p,t,b,function(n){n?(require("x.hub.eventbus.js").emit("timechange",{}),c.send('{"XC_SUC":{}}')):c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}f&&
d._cloudConnect&&d._cloudConnect.init(d);a&&c.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(b,c){b=require("x.hub.v5.js");var a={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(a.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));b.getPublicKey(function(f){a.XC_SUC.key=f;c.end(JSON.stringify(a))})});this._app.get("/peripheral",function(b,c){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?c.end(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):
a.data?c.end(JSON.stringify({XC_SUC:a.data})):c.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):c.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});this._hmPort?this._app.get("/hmtest",function(b,c){d._doHMTestRequest(b.query,c)}):"A20"==this.hostType&&this._app.get("/hmtest",function(b,c){require("x.hub.v5.js").Native.checkHMSerial(function(a){"OK"==a?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"msg":"'+a+'"}}')})});this._app.get("/update",
function(b,c){var a=d._getServerFromReq(b),f="80",e=null;b.query.port&&(f=b.query.port);b.query.url&&(e=b.query.url);b.query.server&&(a=b.query.server);a&&f&&e?"A20"==d.hostType?require("x.hub.v5.js").Native.updateFirmware(a,f,e,function(k){c.send(k);d.resHasError(k)||d.restart(1E3)}):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(b,c){if("CA"==global.HARDWARE_VERSION)d._platform.updateSTM(null,
c,function(){});else{var a=!1,f=d._getServerFromReq(b),e="80",k=null;b.query.live&&"0"!=b.query.live&&"false"!=b.query.live&&(a=!0);b.query.port&&(e=b.query.port);b.query.url&&(k=b.query.url);b.query.server&&(f=b.query.server);f&&e&&k?"A20"==d.hostType?(b=require("x.hub.v5.js"),a?b.Native.updateSTFirmware(f,e,k,c):b.Native.updateSTFirmware(f,e,k,null,function(g){c.send(g)})):a?c.send("ERROR."):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):a?c.send("ERROR."):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}});
this._app.post("/updateST",function(b,c){"CA"==global.HARDWARE_VERSION?d._platform.updateSTM(b,c,function(){}):c.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.post("/updateV5PFW",function(b,c){require("x.hub.v5.js").Native.updateV5PFirmware(b,c,function(a){d.resHasError(a)||d.restart(1E3)})});this._app.get("/backup",function(b,c){var a=require("x.crypt.js"),f=require("x.hub.v5.js");if("A20"==d.hostType&&b.query.native&&"0"!=b.query.native&&"false"!=b.query.native)f.Native.backup(d,
c);else{var e=null;b.query.enc&&"0"!=b.query.enc&&"false"!=b.query.enc&&(b.query.at?e=b.query.at:b.query.auth&&(e=a.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))));f.backup(d,c,e)}});this._app.get("/restore",function(b,c){var a=d._getServerFromReq(b),f="80",e=null;b.query.port&&(f=b.query.port);b.query.url&&(e=b.query.url);if(a&&f&&e){var k=require("x.hub.v5.js");if("A20"==d.hostType&&b.query.native&&"0"!=b.query.native&&"false"!=b.query.native)k.Native.restore(d,"http://"+a+":"+f+e,function(m){c.send(m);
d.resHasError(m)||d.restart(1E3)});else{var g=null;b.query.key?g=b.query.key:b.query.at?g=b.query.at:b.query.auth&&(g=crypt.MD5(unescape(encodeURI(b.query.auth+"_SALT!"))));k.restore(d,"http://"+a+":"+f+e,g,function(m){c.send(m);d.resHasError(m)||d.restart(1E3)})}}else c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(b,c){b=require("x.hub.v5.js");"A20"==d.hostType?b.getLogs(c):"A1"==d.HWV?b.getNeoServerLogs(c):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});
this._app.get("/clearLogs",function(b,c){b=require("x.hub.v5.js");"A20"==d.hostType?b.clearLogs(function(){c.send('{"XC_SUC":{}}')}):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getPorts",function(b,c){require("x.hub.v5.js").getSerialPorts(function(a){c.send(a)})});this._app.get("/reset",function(b,c){c.send('{"XC_SUC":{}}');d.restart(1E3)});this._app.get("/refurbish",function(b,c){require("x.hub.v5.js").Native.setIPData(d,{DHCP:!0},function(a){a?d._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){c.status(200).json({XC_SUC:{}})})}):
c.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});this._app.get("/resetST",function(b,c){"CA"==global.HARDWARE_VERSION?d._platform._stm.reset(function(a){a?c.json({XC_ERR:{msg:a.message}}):c.json({XC_SUC:{}})}):d._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){c.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(b,c){"CA"==global.HARDWARE_VERSION?d._platform._stm.reboot(function(a){a?c.json({XC_ERR:{msg:a.message}}):c.json({XC_SUC:{}})}):
d._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){c.status(200).json({XC_SUC:{}})})})});this._app.get("/resetHM",function(b,c){require("x.hub.v5.js").Native.resetHM(function(a){a?(c.status(200).json({XC_SUC:{}}),d.restart(100)):c.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",function(b,c){require("x.hub.v5.js").Native.resetZway(function(a){a?(c.status(200).json({XC_SUC:{}}),d.restart(100)):c.status(200).json({XC_ERR:{code:"000000",
message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(b,c){require("x.hub.v5.js").Native.resetZigbee(function(a){a?(c.status(200).json({XC_SUC:{}}),d.restart(100)):c.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(b,c){require("x.hub.m.knx.js").reset(function(a){a&&!a.error?c.status(200).json({XC_SUC:{}}):c.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(b,
c){require("x.hub.v5.js").mountUSB(function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.get("/setBackupUSB",function(b,c){b.query.path?require("x.hub.v5.js").setBackupUsbPath(b.query.path,function(){c.status(200).json({XC_SUC:{}})}):c.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(b,c){b=b.body;require("x.hub.v5.js").saveDeviceXMLforBackup(b,function(a){a.error?
c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(b,c){b=b.body;require("x.hub.v5.js").saveMacrosXMLforBackup(b,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",function(b,c){b=b.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(b,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):
c.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(b,c){var a=require("x.crypt.js"),f=require("x.hub.v5.js"),e=null;b.query.key&&(e=a.MD5(unescape(encodeURI(b.query.key+"_SALT!"))));f.backupLocal(d,e,function(k){k.error?c.status(200).json({XC_ERR:{code:"000000",msg:k.error.message}}):c.status(200).json({XC_SUC:{file:k.data}})})});this._app.get("/unmountUSB",function(b,c){require("x.hub.v5.js").unmountUSB(function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):
c.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(b,c){require("x.hub.v5.js").listUsbBackups(function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:a.data})})});this._app.get("/deleteUsbBackup",function(b,c){(b=b.query.file)?require("x.hub.v5.js").deleteBackup(b,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})}):c.status(200).json({XC_ERR:{code:"000000",
msg:"file name is null"}})});this._app.get("/loadBackup",function(b,c){var a=require("x.hub.v5.js"),f=require("x.crypt.js"),e=b.query.file;if(e){var k=null;b.query.key&&(k=f.MD5(unescape(encodeURI(b.query.key+"_SALT!"))));a.loadBackup(e,k,function(g){g.error?c.status(200).json({XC_ERR:{code:"000000",msg:g.error.message}}):c.status(200).json({XC_SUC:{}})})}else c.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(b,c){require("x.hub.v5.js").loadDeviceXML(function(a){a.error?
c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});this._app.get("/loadBackupMacroXML",function(b,c){require("x.hub.v5.js").loadMacroXML(function(a){a.error?c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});this._app.get("/loadBackupIrcodesXML",function(b,c){require("x.hub.v5.js").loadIrcodesXML(function(a){a.error?c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});
this._app.get("/restoreLocal",function(b,c){require("x.hub.v5.js").restoreLocal(d,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):(c.status(200).json({XC_SUC:{}}),d.restart(1E3))})});this._app.get("/testReadOnly",function(b,c){require("x.hub.v5.js").testReadOnly(function(a){a?c.status(200).json({XC_SUC:{readonly:!0,message:a.message}}):c.status(200).json({XC_SUC:{readonly:!1}})})});this._app.get("/fixReadOnly",function(b,c){require("x.hub.v5.js").fixReadOnly(c,
function(a){a?c.status(200).json({XC_ERR:{code:"01001",message:a.message}}):c.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(b,c){require("x.hub.v5.js").Native.scanWiFi(function(a,f){if(a)c.send(a.message);else if(f){c.send('{"XC_SUC":'+JSON.stringify(f)+"}");return}c.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(b,c){b.query.ssid&&b.query.pwd?require("x.hub.v5.js").Native.connectWiFi(b.query.ssid,b.query.pwd,function(a){a?c.send('{"XC_SUC":{}}'):
c.send('{"XC_ERR":{"msg":"failed to connect"}}')}):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",function(b,c){var a={};b.query.ip&&b.query.sn&&b.query.gw&&b.query.dns&&(a.IP=b.query.ip,a.SN=b.query.sn,a.GW=b.query.gw,a.DNS=b.query.dns,a.DHCP=!1);b.query.dhcp&&1==b.query.dhcp&&(a={DHCP:!0});b.query.ntp&&(a.NTP=b.query.ntp);b.query.mac&&(a.MAC=b.query.mac);0<Object.keys(a).length?require("x.hub.v5.js").Native.setWLANData(a,function(f){f?c.send('{"XC_SUC":{}}'):
c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):c.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(b,c){var a=require("x.hub.taskman.js");if(a&&a.taskManager)a.taskManager.onHttpEvt(b.query,function(f,e){f?c.send('{"XC_ERR":{"msg":'+f.message+"}}"):e?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"msg":"no such trigger"}}')});else c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._dispatcher.init();this._app.get("*",function(b,c){XC.debugf("INVALID REQ: "+
b.url);c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(b,c,a,f){XC.debugf(b);a.send({XC_ERR:{code:"000001",msg:"exception"}})});this._httpserver.listen(this._port,function(){var b=d._httpserver.address().port;d._logger.log("info","listening on port "+b+"...");h&&h()})};
x.hub.Server.prototype.sendUDPMessage=function(h){if(this._udpSocket){var d=h.substr(0,4);if("EVT:"==d||"STA:"==d)try{var b=JSON.parse(h.substr(4));b.__srcId=this._udpSocket.__srcId;h=d+JSON.stringify(b)}catch(c){}h=new Buffer(h);this._udpSocket.send(h,0,h.length,1901,"239.255.255.250");this._udpSocket.send(h,0,h.length,1901,"255.255.255.255")}};
x.hub.Server.prototype._startUDPServer=function(h,d){var b=require("dgram"),c=this,a=require("crypto").randomBytes(4).toString("hex");try{var f=this._udpSocket=b.createSocket({reuseAddr:!0,type:"udp4"})}catch(e){f=this._udpSocket=b.createSocket("udp4")}f.__srcId=a;f.on("listening",function(){c._logger.log("info","listening on udp port "+h+"...");f.setBroadcast(!0);d&&d()});f.on("message",function(e,k){f.address();if(e&&e.length&&3<=e.length&&71==e[0]&&69==e[1]&&84==e[2]){c._logger.log("trace","receive gateway discovery request");
var g=function(p,t){var n="DHCP:"+(p.DHCP?"TRUE":"FALSE")+"\nHWV:"+c.HWV+"\nVER:"+c.VERSION+"\nVID:"+c._vid+"\nNAME:"+c._name;n+="\nIP:"+p.IP;n+="\nPT:"+p.PT;n+="\nSN:"+p.SN;n+="\nGW:"+p.GW;n+="\nDNS:"+p.DNS;n+="\nMAC:"+p.MAC;t&&(n+="\nTMP_ID:"+t);n+="\n";c._logger.log("trace","send gateway discovery response:"+n.replace(/(?:\r\n|\r|\n)/g," | "));p=new Buffer(n);f.send(p,0,p.length,k.port,k.address);f.send(p,0,p.length,1901,"239.255.255.250");f.send(p,0,p.length,1901,"255.255.255.255")};c.getNetworkSettings(function(p,
t){if(!p&&t){p=null;"A20"==c.hostType&&(p=function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)},p=p()+p());for(var n in t)for(var q=0;q<t[n].length;q++)t[n][q].PT=c._port,g(t[n][q],p)}})}else if(e&&e.length&&4<=e.length&&69==e[0]&&86==e[1]&&84==e[2]){var m=e.toString();if(4<m.length){e=null;try{e=JSON.parse(m.substr(4))}catch(p){}e&&e.__srcId!=f.__srcId&&(delete e.__srcId,m=require("x.hub.eventbus.js"),m.emit("gatewayevent",e,k,"EVT"))}}else if(e&&e.length&&4<=e.length&&83==
e[0]&&84==e[1]&&65==e[2]&&(m=e.toString(),4<m.length)){e=null;try{e=JSON.parse(m.substr(4))}catch(p){}e&&e.__srcId!=f.__srcId&&(delete e.__srcId,m=require("x.hub.eventbus.js"),m.emit("gatewayevent",e,k,"STA"))}});f.on("error",function(e){XC.debugf("udp port error");f.close()});f.on("close",function(){});f.bind(h)};x.hub.Server.prototype.onUdpEvt=function(h,d){d||(d="EVT");this._logger.log("trace","send "+d+" event:"+JSON.stringify(h));this.sendUDPMessage(d+":"+JSON.stringify(h)+"\r\n")};
x.hub.Server.prototype.onStatusEvt=function(h){};x.hub.Server.prototype.getTimeZone=function(){var h="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(h=localStorage.getItem("x.hub.Server.timezone"));return h};
x.hub.Server.prototype.setTimeZoneCompatiable=function(h,d){if(!h||isNaN(parseInt(h,16)))d&&d(Error("timezone invalid"));else{h=parseInt(h,16);h=((h>>4&1?-1:1)*(h&15)+11&31|(h>>5&1)<<7).toString(16).toUpperCase();2>h.length&&(h="0"+h);h&&localStorage&&localStorage.setItem("x.hub.Server.timezone",h);var b=localStorage.getItem("x.hub.Server.geo.lat"),c=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:h,lat:b,long:c});d&&d()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(h){var d=this.getTimeZone();d=parseInt(d,16);var b=(d&31)-11;d=((0!=(d&128)?1:0)<<5|(0>b?1:0)<<4|(0<b?b:0-b)).toString(16).toUpperCase();2>d.length&&(d="0"+d);h&&h(null,d)};
x.hub.ServerNEO=function(){var h=function(d,b,c){x.hub.Server.call(this,d,b,c);this._dispatcher=new x.hub.Dispatcher2(this._app,this);this._auth=new x.hub.Auth2;this._platform=require("x.hub.neo_server.js")};require("util").inherits(h,x.hub.Server);h.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},
{path:"/getKey",options:{method:"GET"}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/tm/http",options:{method:"GET"}},{path:"/",options:{method:"GET",auth:0}}];h.prototype.addRoute=function(d,b,c){"function"==typeof b&&(c=b,b=null);return this._dispatcher.add(d,b,c)};
h.prototype._setDefaultRoutes=function(){var d=this,b=function(c,a){var f=null;f=require("url").parse(c.url).pathname;f="/"==f?"/":"/"+f.split("/")[1];d.doRequest(f,c,a,function(e){void 0!=e&&null!=e&&("object"==typeof e?a.json(e):a.send(e))})};this._routes.forEach(function(c){d.addRoute(c.path,c.options,b)})};h.prototype._startServer=function(d){var b=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(c,a,f){a.header("Access-Control-Allow-Origin","*");
a.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var e=require("x.logger.js").getLogger("x.hub.Server.Access");e.log("debug",c.method+":"+c.url);c.source="webserver";a.on("finish",function(){e.log("debug",c.method+":"+c.url+" -> HTTP:"+a.statusCode)});f()});this._dispatcher.init();this._app.use("*",function(c,a){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","INVALID "+c.method+" REQ:"+c.url);a.json({XC_ERR:{code:"000001",
msg:"invalid request"}})});this._app.use(function(c,a,f,e){require("x.logger.js").getLogger("x.hub.Server.Access").log("warn","error: "+c.message+" stack:"+c.stack);f.json({XC_ERR:{code:"000002",msg:c.stack}})});this._httpserver.listen(this._port,function(){var c=b._httpserver.address().port;b._logger.log("info","listening on port "+c+"...");d&&d()})};h.prototype.doRequest=function(d,b,c,a){!a&&c&&"function"==typeof c&&(a=c,c=null);if("/info"==d)this._info(b,function(e,k){e?a&&a(JSON.stringify({XC_ERR:{code:"000000",
msg:e.message}})):a&&a(JSON.stringify({XC_SUC:k}))});else if("/command"==d)if((d=b.query.XC_FNC)&&this._commandFunctions[d.toLowerCase()])this._commandFunctions[d.toLowerCase()](b,c);else a&&a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/cmd"==d)if(d=b.query.XC_FNC,!d&&b.json&&b.json.XC_FNC&&(d=b.json.XC_FNC,b.query=b.json),d&&this._cmdFunctions[d.toLowerCase()])this._cmdFunctions[d.toLowerCase()](b,function(e){a&&a(e?e:'{"XC_ERR":{"code":"000002", "msg":"invalid request"}}')});
else a&&a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/config"==d)this._config(b,function(e,k){e?a&&a(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})):a&&a(JSON.stringify({XC_SUC:k?k:{}}))});else if("/executeCommand"==d)d=require("x.logger.js").getLogger("GeneralExecuteCommand API"),b.json&&(b.query=b.json),d.log("trace","general execute command:"+JSON.stringify(b.query)),b.query&&b.query.data?(d=b.query.type,b=b.query.data,b.device&&!b.device.sys&&(b.device.sys=d),b.gateway&&
!b.gateway.sys&&(b.gateway.sys=d),d=require("x.hub.commandman.js"),d.commandHandler.executeCommand(b.device,b.gateway,b.command,function(e){e.error?a('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==d)d=require("x.logger.js").getLogger("GeneralGetStates API"),d.log("trace","general get states:"+JSON.stringify(b.query)),b.json&&(b.query=b.json),b.query&&b.query.data?(d=b.query.type,b=b.query.data,
b.device&&!b.device.sys&&(b.device.sys=d),b.gateway&&!b.gateway.sys&&(b.gateway.sys=d),d=require("x.hub.commandman.js"),b.deviceList?d.commandHandler.getMultiStatesLegacy(b.device,b.gateway,b.deviceList,function(e){e.error?a('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):a('{"XC_SUC":{}}')}):d.commandHandler.getState(b.device,b.gateway,b.status,function(e){e.error?a('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+
'"}}'):e&&e.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==d){var f={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(f.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));require("x.hub.v5.js").getPublicKey(function(e){f.XC_SUC.key=e;a&&a(f)})}else if("/backup"==d)this._platform.backup(b,c,function(){a&&a()});else if("/restore"==d)this._platform.restore(b,c,function(){a&&
a()});else if("/reset"==d)d="factory",b.query&&b.query.type&&(d=b.query.type),this.reset(d,function(e){e?a&&a(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})):a&&a('{"XC_SUC":{}}')});else if("/log"==d||"/getLogs"==d)b.method&&"get"==b.method.toLowerCase()?this.getLogs(function(e,k,g){if(e)c.status(500),c.json({XC_ERR:{code:"100000",msg:e.message}}),a&&a();else{var m=require("fs-extra");c.setHeader("Content-disposition","attachment; filename="+k);c.sendFile(g,null,function(p){m.removeSync(g);
p&&(c.status(500),c.json({XC_ERR:{code:"100000",msg:p.message}}));a&&a(p)})}}):b.method&&"delete"==b.method.toLowerCase()&&this.clearLogs(function(e){e?a&&a({XC_ERR:{code:"100000",msg:e.message}}):a&&a({XC_SUC:{}})});else if("/tm"==d)if("/tm/http"==require("url").parse(b.url).pathname)require("x.hub.taskman.js").taskManager.onHttpEvt(b.query,function(e,k){e?a&&a('{"XC_ERR":{"msg":'+e.message+"}}"):k?a&&a('{"XC_SUC":{}}'):a&&a('{"XC_ERR":{"msg":"no such trigger"}}')});else a&&a(JSON.stringify({XC_ERR:{code:"000000",
msg:"invalid request"}}));else x.hub.Server.prototype.doRequest.call(this,d,b,a)};h.prototype._info=function(d,b){var c={name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)},a=this;require("async").parallel([function(f){localStorage.getItem("x.hub.v5.config")&&(c.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.SID")&&(c.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&
(c.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));var e=require("os");e&&e.freemem&&(c.mem=Math.floor(e.freemem()/1E3));f()},function(f){c.server=a.getCloudServer()+":"+a.getCloudPort();f()},function(f){a.getTZ(function(e,k){!e&&k&&(c.loc||(c.loc=""),c.loc=(k+c.loc).toUpperCase());f()})},function(f){a.getLocation(function(e,k,g){!e&&k&&g&&(c.loc||(c.loc=""),c.loc+=(k+g).toUpperCase());f()})},function(f){a._platform._network.getNetwork(function(e,k){if(!e&&k){e=null;if(d&&d.headers&&d.headers.host){e=
d.headers.host;var g=e.indexOf(":");-1!=g&&(e=e.substr(0,g))}for(var m in k)if(g=k[m],e&&(e==g.ip||"localhost"==e||"127.0.0.1"==e)){c.ip=g.ip;c.sn=g.subnet;c.gw=g.router;c.dns=g.dns?g.dns[0]:null;c.mac=g.mac;break}}f()})}],function(){b&&b(null,c)})};h.prototype._config=function(d,b){var c=this,a=!1,f;require("async").series([function(e){d.query.name&&(c._name=d.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",d.query.name));d.query.vid&&(c._vid=d.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",
d.query.vid));if(d.query.pwd||""==d.query.pwd){var k=require("x.crypt.js");0===d.query.pwd.length?(c._pwd="",d.query.cloud=0):c._pwd=k.MD5(unescape(encodeURI(d.query.pwd+"_SALT!")));localStorage&&localStorage.setItem("x.hub.Server.pwd",c._pwd);a=!0}d.query.neoserver&&(localStorage&&localStorage.setItem("x.hub.taskman.NEO_SERVER",d.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",d.query.neoserver));d.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",d.query.sid),
a=!0);e()},function(e){if(localStorage&&(d.query.ckey&&(c.setCloudKey(d.query.ckey),a=!0),d.query.cserver&&(c.setCloudServer(d.query.cserver),a=!0),d.query.cport&&(c.setCloudPort(d.query.cport),a=!0),void 0!=d.query.cloud&&null!=d.query.cloud)){var k=255;localStorage.getItem("x.hub.v5.config")&&(k=parseInt(localStorage.getItem("x.hub.v5.config"),16));k=1==d.query.cloud?k&-65:k|64;k=k.toString(16);2>k.length&&(k="0"+k);localStorage.setItem("x.hub.v5.config",k.toUpperCase());a=!0}e()},function(e){if(d.query.loc){if(2==
d.query.loc.length)var k=d.query.loc;else if(8==d.query.loc.length){var g=d.query.loc.substr(0,4);var m=d.query.loc.substr(4)}else 10==d.query.loc.length&&(k=d.query.loc.substr(0,2),g=d.query.loc.substr(2,4),m=d.query.loc.substr(6));c.setTZ(k,function(p){p&&(f=p);c.setLocation(g,m,function(t){t&&(f=t);e()})})}else e()}],function(){a&&c._cloudConnect&&c._cloudConnect.init(c);b&&b(f)})};h.prototype.setLocation=function(d,b,c){this._logger.log("debug","set location lat="+d+" long="+b);d&&b?(localStorage&&
(localStorage.setItem("x.hub.Server.geo.lat",d),localStorage.setItem("x.hub.Server.geo.long",b)),c&&c(),process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:d,long:b})})):c&&c(Error("invalid arguments"))};h.prototype.getLocation=function(d){if(localStorage){var b=localStorage.getItem("x.hub.Server.geo.lat");var c=localStorage.getItem("x.hub.Server.geo.long")}b&&c||(b="1392",c="035C");d&&d(null,b,c)};h.prototype.setTZ=function(d,b){this._platform.setTZData(d,b)};h.prototype.getTZ=
function(d){this._platform.getTZData(d)};h.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};h.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer()};h.prototype.setCloudServer=function(d){return this._cloudConnect.setCloudServer(d)};h.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};h.prototype.setCloudPort=function(d){return this._cloudConnect.setCloudPort(d)};h.prototype.setCloudKey=function(d){return this._cloudConnect.setCloudKey(d)};
h.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};h.prototype.getLogs=function(d){require("x.hub.logman.js").compressLogs(function(b,c,a){d&&d(b,c,a)})};h.prototype.clearLogs=function(d){require("x.hub.logman.js").clearLogs(function(b){d&&d(b)})};h.prototype.reset=function(d,b){var c=require("fs"),a=require("fs-extra"),f=require("path"),e=require("x.hub.fileman.js").fileManager.getUserRootDataPath();switch(d){case "passwords":d=f.join(e,"localstorage","x.hub.Server.pwd");
c.existsSync(d)&&a.removeSync(d);b&&b(null,!0);break;case "factory":c.existsSync(e)&&a.emptyDirSync(e);b&&b(null,!0);break;default:b&&b(Error("unknonw reset mode: "+d))}};return h}();
x.hub.ServerV6=function(){var h=function(){var c=function(a,f){this._expressApp=a;this._server=f;this._routes=[]};c.prototype.add=function(a,f,e){if(!a)throw Error("invalid arguments");f&&"function"==typeof f&&!e&&(e=f,f=null);if(!e)throw Error("invalid arguments");this._routes.push({path:a,opts:f,callback:e})};c.prototype.doRequest=function(a,f,e){var k=this,g=function(m,p,t){k._findRoute(m,p,function(n,q){if(n)try{k._doRoute(n,p,t,function(){g(q+1,p,t)})}catch(v){t.json({XC_ERR:{code:"000000",msg:v.message}})}else e()})};
g(0,a,f)};c.prototype._doRoute=function(a,f,e,k){var g=function(q,v,D,z,B,y){"cloud"==v.source?(v.hasValidAuth=!0,y()):(z=z.auth(v,B),v.hasValidAuth=z,q.opts&&0==q.opts.auth?y():z?y():D.json({XC_ERR:{code:"000007",msg:"access denied"}}))},m=function(q,v,D,z,B){var y=z.isLocked();v.locked=y;var l=z.getRCS();v.rcs=l;y?(y=v.query?v.query.pin:null,!y&&v.json&&v.json.pin&&(y=v.json.pin),y=z.checkPin(y),v.pinMatch=y,q.opts&&q.opts.lock?"function"==typeof q.opts.lock?q.opts.lock(y,v,z)?B():D.json({XC_ERR:{code:"000007",
msg:"access denied (locked)"}}):y?B():D.json({XC_ERR:{code:"000007",msg:"access denied (locked)"}}):B()):B()},p=this,t=this._server._auth,n={pwd:this._server._pwd};(function(q,v,D,z){if("cloud"==v.source)z();else if(q.opts&&"stream"==q.opts.body)z();else if("POST"!=v.method&&"PUT"!=v.method||"application/octet-stream"==v.header("content-type"))z();else{var B=new Buffer([]);v.on("data",function(y){B=Buffer.concat([B,y])});v.on("end",function(){v.size=B.length;v.body=B.toString("utf8");v.json=null;
if(!q.opts||!q.opts.body||"json"==q.opts.body)try{v.json=JSON.parse(B)}catch(y){}z()})}})(a,f,e,function(){g(a,f,e,t,n,function(){m(a,f,e,p._server,function(){a.callback(f,e,function(){k()})})})})};c.prototype._findRoute=function(a,f,e){for(var k=function(t,n){return t?"/"==n&&t!=n?!1:n.length<=t.length&&t.substr(0,n.length)==n?!0:"*"==n?!0:!1:!1},g=function(t,n){return 0!=(("webserver"==t?1:"cloud"==t?2:3)&n)},m=f.path;a<this._routes.length;a++){var p=this._routes[a];if(p&&p.path&&k(m,p.path)){if(p.opts){if(p.opts.method&&
f.method&&f.method.toLowerCase()!=p.opts.method.toLowerCase())continue;if(p.opts.source&&!g(f.source,p.opts.source))continue}e(p,a);return}}e(null,-1)};c.prototype.init=function(){var a=this;this._expressApp.use("/",function(f,e,k){a.doRequest(f,e,k)})};return c}(),d=function(){var c=function(){};c.prototype.auth=function(a,f){if(!f||!f.pwd)return!0;var e=require("x.crypt.js");if(a.query&&(a.query.at&&a.query.at==f.pwd||a.query.auth&&e.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))==f.pwd))return!0;
if(a.json){if(a.json.at){if(a.json.at==f.pwd)return delete a.json.at,!0;delete a.json.at}if(a.json.auth){if(e.MD5(unescape(encodeURI(a.json.auth+"_SALT!")))==f.pwd)return delete a.json.auth,!0;delete a.json.auth}}return a.headers&&a.headers.authorization?this._checkAuthHeader(a.headers.authorization,f):!1};c.prototype._checkAuthHeader=function(a,f){return a&&"Basic "==a.substr(0,6)?(a=a.substr(6).trim(),(a=(new Buffer(a,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(a+
"_SALT!")))==f.pwd:!1):!1};return c}(),b=function(c,a,f){this.PERSISTENT_DATA_PATH=this._getSrvPath()+"/XHUB_PERSISTENTDATA";this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE="PERSISTENTDATA";this.persitentData={"x.hub.Server.vid":null};x.hub.Server.call(this,c,a,f);this._dispatcher=new h(this._app,this);this._auth=new d;this._platform=require("x.hub.v6.js");var e=this;this._platform._stm.on("event",function(k,g){e._onSerialEvent(k,g)});this._locked="true"==localStorage.getItem("x.hub.Server.lock");this._rcs=
"true"==localStorage.getItem("x.hub.Server.rcs");this._restorePersistentData()};require("util").inherits(b,x.hub.Server);b.prototype._getSrvPath=function(){var c=require("path");SYSTEM_ROOT||(SYSTEM_ROOT="/");return c.join(SYSTEM_ROOT,"srv")};b.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1,lock:1}},{path:"/wifi",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},
{path:"/getStates",options:{method:"POST"}},{path:"/getKey",options:{method:"GET",lock:function(c,a,f){return!c||"cloud"==a.source&&!f.getRCS()?!1:!0}}},{path:"/peripheral",options:{method:"GET"}},{path:"/update",options:{source:1,lock:1}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET",source:1,lock:1}},{path:"/reboot",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",
source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/lock",options:{method:"GET",lock:function(c,a,f){return!c||"cloud"==a.source&&!f.getRCS()?!1:!0}}},{path:"/unlock",options:{method:"GET",lock:function(c,a,f){return!c||"cloud"==a.source&&!f.getRCS()?!1:!0}}},{path:"/tm/http",options:{method:"GET"}},{path:"/sapi",options:{method:"POST",body:"text",auth:0}},{path:"/",options:{method:"GET",auth:0}}];b.prototype.addRoute=function(c,a,f){"function"==typeof a&&(f=a,a=null);return this._dispatcher.add(c,
a,f)};b.prototype._setDefaultRoutes=function(){var c=this,a=function(f,e){var k=null;k=require("url").parse(f.url).pathname;k="/"==k?"/":"/"+k.split("/")[1];c.doRequest(k,f,e,function(g){void 0!=g&&null!=g&&("object"==typeof g?e.json(g):e.send(g))})};this._routes.forEach(function(f){c.addRoute(f.path,f.options,a)})};b.prototype._startServer=function(c){var a=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(f,e,k){e.header("Access-Control-Allow-Origin",
"*");e.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var g=require("x.logger.js").getLogger("x.hub.Server.Access");g.log("debug",f.method+":"+f.url);f.source="webserver";e.on("finish",function(){g.log("debug",f.method+":"+f.url+" -> HTTP:"+e.statusCode)});k()});this._dispatcher.init();this._app.use("*",function(f,e){XC.debugf("INVALID REQ: "+f.url);e.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.use(function(f,e,k,g){XC.debugf(f);
k.json({XC_ERR:{code:"000002",msg:f.stack}})});this._httpserver.listen(this._port,function(){var f=a._httpserver.address().port;a._logger.log("info","listening on port "+f+"...");c&&c()})};b.prototype.doRequest=function(c,a,f,e){!e&&f&&"function"==typeof f&&(e=f,f=null);var k=this;if("/"==c){var g='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setZwaveConfigRef() {var zwaveconfig = document.getElementById("zwaveconfig"); if(zwaveconfig){zwaveconfig.href = window.location.protocol + "//" + window.location.hostname + ":9000/";}}\x3c/script>\n');
g=g+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setZwaveConfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");g=g+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");g+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var m=Math.round((new Date).getTime()/1E3)-this._startup;c=Math.floor(m/86400);m-=86400*c;var p=Math.floor(m/3600);m-=3600*
p;var t=Math.floor(m/60);g+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+c+"d "+p+"h "+t+"m "+(m-60*t)+"s</b></td></tr>\n";(c=require("os"))&&c.freemem&&(g+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(c.freemem()/1E3)+"</b></td></tr>\n");e(g+'<tr style="height: 30px;"><td>&nbsp;</td><td>zwave:</td><td><b><a href=":9000/" id="zwaveconfig">Expert UI</a></b></td></tr>\n<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2020 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
c){var n={XC_SUC:{name:this._name,mhv:"XH II-"+this.hostType,msv:this.VERSION,msb:this.BUILD,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};localStorage.getItem("x.hub.v5.config")&&(n.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?n.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(c=require("x.hub.v5.js").CloudConnect,
n.XC_SUC.server=c.prototype.CLOUD_SERVER+":"+c.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(n.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(n.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(n.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(n.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));
(c=require("os"))&&c.freemem&&(n.XC_SUC.mem=Math.floor(c.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&(g=require("x.hub.m.enocean.js"))&&(m=g.getEnoceanInfo(),n.XC_SUC.enocean=m)}catch(l){}g=require("async");g.parallel([function(l){k._platform.getSTMSettings(function(r,u){!r&&u&&(n.XC_SUC.stm_settings=u);l()})},function(l){n.XC_SUC.rcs=k.getRCS();l()},function(l){n.XC_SUC.locked=k.isLocked();l()},function(l){k._platform.getExtraInfo(function(r,u){!r&&u&&(n.XC_SUC.extra=
u);l()})},function(l){k._platform._time.getNTPServers(function(r,u){!r&&u&&(n.XC_SUC.ntp=u.join(","));l()})},function(l){k._platform.getLocation(function(r,u,w){!r&&u&&w&&(n.XC_SUC.loc=(u+w).toUpperCase());k._platform._time.getTimezoneEncoded(function(A,C){!A&&C&&(n.XC_SUC.loc=n.XC_SUC.loc?C.toUpperCase()+n.XC_SUC.loc:C.toUpperCase());l()})})},function(l){n.XC_SUC.mediola_mac=k._platform._network.getMediolaMac();k._platform._network.getNetwork(function(r,u){if(!r&&u){u.en0&&(u.eth0=u.en0);var w=function(E){return E?
{ip:E.ip,sn:E.subnet,gw:E.router,dhcp:E.dhcp,dns:E.dns?E.dns.join(","):E.dns,mac:E.mac?E.mac.replace(/:/g,"-"):null}:null},A=Object.keys(u);if(0==A.length)return;r=w(u.eth0);var C=w(u.wlan0),G=null;u.eth0||u.wlan0||(G=w(u[A[0]]));u=null;r&&r.ip?(u=r,n.XC_SUC.primary_net="eth0"):C&&C.ip?(u=C,n.XC_SUC.primary_net="wlan0"):G&&G.ip&&(u=C,n.XC_SUC.primary_net=A[0]);for(var F in u)n.XC_SUC[F]=u[F];n.XC_SUC.cfg&&u&&(F=parseInt(n.XC_SUC.cfg,16),F=!0===u.dhcp?F&-129:F|128,n.XC_SUC.cfg=F.toString(16),2>n.XC_SUC.cfg.length&&
(n.XC_SUC.cfg="0"+n.XC_SUC.cfg),n.XC_SUC.cfg=n.XC_SUC.cfg.toUpperCase());n.XC_SUC.eth0=r;n.XC_SUC.wlan0=C}l()})}],function(){e(JSON.stringify(n))})}else if("/command"==c)if((g=a.query.XC_FNC)&&this._commandFunctions[g.toLowerCase()])this._commandFunctions[g.toLowerCase()](a,f);else this._doSTMCommandRequest(a,!0,function(l){f.send(l)});else if("/cmd"==c)if(g=a.query.XC_FNC,!g&&a.json&&a.json.XC_FNC&&(g=a.json.XC_FNC,a.query=a.json),g&&this._cmdFunctions[g.toLowerCase()])this._cmdFunctions[g.toLowerCase()](a,
function(l){l?e(l):k._doSTMCommandRequest(a,!1,e)});else this._doSTMCommandRequest(a,!1,e);else if("/config"==c){var q=!1,v,D=!1,z=null;!a.query||1!=a.query.poweroff&&"true"!=a.query.poweroff&&1!=a.query.poweroff||(z=!0);g=require("async");g.series([function(l){var r=a.query.enable_stm_states_buffer,u=a.query.stm_states_buffer_timeout,w=null;if("1"==r||"true"==r||1==r)w||(w={}),w.enable_stm_states_buffer=!0;else if("0"==r||"false"==r||0==r)w||(w={}),w.enable_stm_states_buffer=!1;isNaN(parseInt(u))||
(w||(w={}),w.stm_states_buffer_timeout=parseInt(u));w?k._platform._stm.setSettings(w,function(){l()}):l()},function(l){a.query.name&&(k._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&(k._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd){var r=require("x.crypt.js");0===a.query.pwd.length?(k._pwd="",a.query.cloud=0):k._pwd=r.MD5(unescape(encodeURI(a.query.pwd+"_SALT!")));localStorage&&
localStorage.setItem("x.hub.Server.pwd",k._pwd);q=!0}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",a.query.neoserver),r=require("x.hub.eventbus.js"),r.emit("neoserver_activation",a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),r=require("x.hub.eventbus.js"),r.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",
a.query.disable_st_states);a.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",a.query.sid),q=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",a.query.ckey),q=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),q=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),q=!0);a.query.cloud&&localStorage&&(r=255,localStorage.getItem("x.hub.v5.config")&&(r=parseInt(localStorage.getItem("x.hub.v5.config"),
16)),r=1==a.query.cloud?r&-65:r|64,r=r.toString(16),2>r.length&&(r="0"+r),localStorage.setItem("x.hub.v5.config",r.toUpperCase()),q=!0);l()},function(l){if(a.query.loc){if(2==a.query.loc.length)var r=a.query.loc;else if(8==a.query.loc.length){var u=a.query.loc.substr(0,4);var w=a.query.loc.substr(4)}else 10==a.query.loc.length&&(r=a.query.loc.substr(0,2),u=a.query.loc.substr(2,4),w=a.query.loc.substr(6));k.setTimeZoneCompatiable(r,function(A){A&&(v=A);k.setLocation(u,w,function(C){C&&(v=C);l()})})}else l()},
function(l){if(a.query.year&&a.query.month&&a.query.date&&a.query.hour&&a.query.minute){var r=parseInt(a.query.year),u=parseInt(a.query.month),w=parseInt(a.query.date),A=parseInt(a.query.hour),C=parseInt(a.query.minute);k.setDateTime(r,u,w,A,C,function(G){G&&(v=G);l()})}else l()},function(l){a.query.apin?k.setPin(a.query.pin,a.query.apin,function(r){r&&(v=Error("failed to config"));l(r)}):l()},function(l){if(void 0==a.query.rcs||null==a.query.rcs||""==a.query.rcs)l();else{var r=null;if("1"==a.query.rcs||
"true"==a.query.rcs||1==a.query.rcs)r=!0;else if("0"==a.query.rcs||"false"==a.query.rcs||0==a.query.rcs)r=!1;else{l();return}k.setRCS(r,function(u){u&&(v=Error("failed to config"));l(u)})}},function(l){var r={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(r.IP=a.query.ip,r.SN=a.query.sn,r.GW=a.query.gw,r.DNS=a.query.dns,r.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(r={DHCP:!0});a.query.ntp&&(r.NTP=a.query.ntp);a.query.mac&&(r.MAC=a.query.mac);0>=Object.keys(r).length?l():k._platform.setIPData(r,
function(u,w){u?v=u:D=w;l()})}],function(){q&&k._cloudConnect&&k._cloudConnect.init(k);e&&(v?e(JSON.stringify({XC_ERR:{code:"000001",msg:v.message}})):e('{"XC_SUC": {}}'));1==z?k.poweroff(1E3):D&&k.restart(1E3)})}else if("/executeCommand"==c)g=require("x.logger.js").getLogger("GeneralExecuteCommand API"),a.json&&(a.query=a.json),g.log("trace","general execute command:"+JSON.stringify(a.query)),a.query&&a.query.data?(m=a.query.type,g=a.query.data,g.device&&!g.device.sys&&(g.device.sys=m),g.gateway&&
!g.gateway.sys&&(g.gateway.sys=m),m=require("x.hub.commandman.js"),m.commandHandler.executeCommand(g.device,g.gateway,g.command,function(l){l.error?e('{"XC_ERR":{"code":"000000","msg":"'+l.error.message+'"}}'):e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==c)g=require("x.logger.js").getLogger("GeneralGetStates API"),g.log("trace","general get states:"+JSON.stringify(a.query)),a.json&&(a.query=a.json),a.query&&a.query.data?(m=a.query.type,g=a.query.data,
g.device&&!g.device.sys&&(g.device.sys=m),g.gateway&&!g.gateway.sys&&(g.gateway.sys=m),m=require("x.hub.commandman.js"),g.deviceList?m.commandHandler.getMultiStatesLegacy(g.device,g.gateway,g.deviceList,function(l){l.error?e('{"XC_ERR":{"code":"000000","msg":"'+l.error.message+'"}}'):l&&l.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(l.data)}})):e('{"XC_SUC":{}}')}):m.commandHandler.getState(g.device,g.gateway,g.status,function(l){l.error?e('{"XC_ERR":{"code":"000000","msg":"'+l.error.message+
'"}}'):l&&l.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(l.data)}})):e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==c)if(g=a.query?a.query.k:null){var B=(a.headers?a.headers["x-forwarded-for"]:null)||(a.connection?a.connection.remoteAddress:null);if(B){var y=require("x.hub.password");y.registSecureClient(B,g,function(l,r){l?e&&e({XC_ERR:{code:"000000",msg:l.message}}):e&&e({XC_SUC:r})})}else e&&e({XC_ERR:{code:"000000",msg:"can not get client ip address"}})}else n=
{XC_SUC:{}},localStorage.getItem("x.hub.v5.cloudKey")&&(n.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),require("x.hub.v5.js").getPublicKey(function(l){n.XC_SUC.key=l;e&&e(n)});else if("/peripheral"==c)require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(l){l?l.error?e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:l.error}})):l.data?e&&e(JSON.stringify({XC_SUC:l.data})):e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):e&&e(JSON.stringify({XC_ERR:{code:"000001",
msg:"get peripheral internal error"}}))});else if("/update"==c)a.method&&"post"==a.method.toLowerCase()&&a.query&&"st"==a.query.type?k._platform.updateSTM(a,f,function(){e&&e()}):a.query&&"st"==a.query.type?k._platform.updateSTM(null,f,function(){e&&e()}):k._platform.updateFirmware(a.query?a.query.url:null,function(l,r){l?f.json({XC_ERR:{code:l.code?l.code:"000000",msg:l.message}}):(f.json({XC_SUC:{}}),r&&k._platform.reboot(null,1E3));e&&e()});else if("/backup"==c)k._platform.backup(a,f,function(){e&&
e()});else if("/restore"==c)k._platform.restore(a,f,function(){e&&e()});else if("/reset"==c)a.query&&a.query.type?"st"==a.query.type?k._platform._stm.reset(function(l){l?e&&e({XC_ERR:{msg:l.message}}):e&&e({XC_SUC:{}})}):"st_reboot"==a.query.type?k._platform._stm.reboot(function(l){l?e&&e({XC_ERR:{msg:l.message}}):e&&e({XC_SUC:{}})}):"knx"==a.query.type?require("x.hub.m.knx.js").reset(function(l){l&&!l.error?e&&e({XC_SUC:{}}):e&&e({XC_ERR:{code:"000000",message:"reset knx failed"}})}):"zwave"==a.query.type&&
k._platform._zwayServer.reset(function(l){l?e&&e({XC_ERR:{msg:l.message}}):e&&e({XC_SUC:{}})}):(e&&e('{"XC_SUC":{}}'),k.restart(1E3));else if("/reboot"==c)e&&e('{"XC_SUC":{}}'),g=null,a.query&&a.query.mode&&"recovery"==a.query.mode&&(g="recovery"),k._platform.reboot(g,1E3);else if("/wifi"==c)switch(g=a.path,g=g.substr(5),g){case "/scan":k._platform._network.scanWifi(a.query,function(l,r){l?e&&e(JSON.stringify({XC_ERR:{code:l.code?l.code:"000000",msg:l.message}})):e&&e(JSON.stringify({XC_SUC:r?r:[]}))});
break;case "/connect":k._platform._network.connectWifi(a.query,function(l){l?e&&e(JSON.stringify({XC_ERR:{code:l.code?l.code:"000000",msg:l.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),k.restart(1E3))});break;case "/disconnect":k._platform._network.disconnectWifi(a.query,function(l){l?e&&e(JSON.stringify({XC_ERR:{code:l.code?l.code:"000000",msg:l.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),k.restart(1E3))});break;case "/info":k._platform._network.getWifiInfo(a.query,function(l,r){l?e&&e(JSON.stringify({XC_ERR:{code:l.code?
l.code:"000000",msg:l.message}})):e&&e(JSON.stringify({XC_SUC:r}))});break;case "/config":g={};"true"==a.query.dhcp||1==a.query.dhcp||1==a.query.dhcp?g={dhcp:!0}:a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(g.ip=a.query.ip,g.subnet=a.query.sn,g.router=a.query.gw,g.dns=a.query.dns?a.query.dns.split(","):[],g.dhcp=!1);if(0>=Object.keys(g).length){e&&e(JSON.stringify({XC_SUC:{}}));break}k._platform._network.setNetwork("wlan0",g,function(l){l?e&&e(JSON.stringify({XC_ERR:{code:l.code?l.code:"000000",
msg:l.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),k.restart(1E3))});break;default:e&&e({XC_ERR:{code:"000001",message:"invalid request"}})}else if("/log"==c||"/getLogs"==c)a.method&&"get"==a.method.toLowerCase()?k.getLogs(function(l,r,u){if(l)f.status(500),f.json({XC_ERR:{code:"100000",msg:l.message}}),e&&e();else{var w=require("fs-extra");f.setHeader("Content-disposition","attachment; filename="+r);f.sendFile(u,null,function(A){w.removeSync(u);A&&(f.status(500),f.json({XC_ERR:{code:"100000",msg:A.message}}));
e&&e(A)})}}):a.method&&"delete"==a.method.toLowerCase()&&k.clearLogs(function(l){l?e&&e({XC_ERR:{code:"100000",msg:l.message}}):e&&e({XC_SUC:{}})});else if("/tm"==c)if(g=require("url").parse(a.url).pathname,"/tm/http"==g)require("x.hub.taskman.js").taskManager.onHttpEvt(a.query,function(l,r){l?e&&e('{"XC_ERR":{"msg":'+l.message+"}}"):r?e&&e('{"XC_SUC":{}}'):e&&e('{"XC_ERR":{"msg":"no such trigger"}}')});else e&&e(JSON.stringify({XC_ERR:{code:"000000",msg:"invalid request"}}));else"/lock"==c?(g=a.query?
a.query.pin:null,k.lock(g,function(l){l?e&&e(JSON.stringify({XC_ERR:{code:l.code,msg:l.message}})):e&&e(JSON.stringify({XC_SUC:{}}))})):"/unlock"==c?(g=a.query?a.query.pin:null,k.unlock(g,function(l){l?e&&e(JSON.stringify({XC_ERR:{code:l.code,msg:l.message}})):e&&e(JSON.stringify({XC_SUC:{}}))})):"/sapi"==c?(B=(a.headers?a.headers["x-forwarded-for"]:null)||(a.connection?a.connection.remoteAddress:null))?(k=this,y=require("x.hub.password"),y.decodeSecureReq(B,a,function(l,r){if(!l){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug",
r.method+":"+r.url);var u={json:function(w){y.encodeSecureRsp(B,JSON.stringify(w),function(A,C){A?e&&e({XC_ERR:{code:"000000",msg:A.message}}):e&&e(C)})},send:function(w){y.encodeSecureRsp(B,w,function(A,C){A?e&&e({XC_ERR:{code:"000000",msg:A.message}}):e&&e(C)})}};k._dispatcher.doRequest(r,u,function(w){void 0!=w&&null!=w&&("object"==typeof w?u.json(w):u.send(w))})}})):e&&e({XC_ERR:{code:"000000",msg:"can not get client ip address"}}):e&&e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};
b.prototype._doSTMCommandRequest=function(c,a,f){if(c){var e=this._platform._stm;if(e){var k=this;if("string"==typeof c){var g=16;var m=c;-1<m.indexOf("?")&&(m=m.substr(m.indexOf("?")+1))}else"POST"==c.method?(g=17,m=c.json?JSON.stringify(c.json):c.body):(g=16,m=c.url,-1<m.indexOf("?")&&(m=m.substr(m.indexOf("?")+1))),c.locked?"cloud"==c.source?16==g?g=18:17==g&&(g=19):"webserver"!=c.source||c.pinMatch||(16==g?g=18:17==g&&(g=19)):"cloud"==c.source&&(16==g?g=20:17==g&&(g=21));e.sendCommand(g,m,function(p){p&&
p.error?k._logger.log("trace",m+" --\x3e FAIL:"+p.error):p&&p.data?k._logger.log("trace",m+" --\x3e "+p.data.toString()):k._logger.log("trace",m+" --\x3e FAIL");if(p&&p.data){var t="XC_SUC";p.error&&(t="XC_ERR");a?f("{"+t+"}"+p.data.toString()):f('{"'+t+'": '+p.data.toString()+"}")}else a?f("{XC_ERR}internal error"):p&&p.error?f(JSON.stringify({XC_ERR:{code:"000000",msg:p.error}})):f('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}else a?f("{XC_ERR}no stm"):f('{"XC_ERR":{"code":"000001", "msg":"no stm"}}')}else a?
f("{XC_ERR}invalid request"):f('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};b.prototype.setLED=function(c,a){if(c&&"string"==typeof c&&c.match(/^([a-fA-F0-9]){4}/g)){var f=this._platform._led;if(f){var e=parseInt(c.substr(0,2),16);c=parseInt(c.substr(2,2),16);var k;switch(c){case 0:var g=k=c=0;break;case 1:c=0;k=255;g=0;break;case 2:k=c=0;g=255;break;case 3:c=255;g=k=0;break;case 4:k=c=255;g=0;break;case 5:g=k=c=255;break;case 6:c=255;k=0;g=255;break;case 7:c=0;g=k=255;break;default:a&&
a(Error("invalid set led color:"+c));return}0===e?f.setColor(c,k,g,function(m){a&&a(m)}):1==e?f.saveColor(c,k,g,function(m){a&&a(m)}):a&&a(Error("invalid set led command:"+e))}else a&&a(Error("no led"))}else a&&a(Error("invalid set led data: "+c))};b.prototype.restart=function(c){this._platform.reboot(null,c)};b.prototype.poweroff=function(c){this._platform.poweroff(c)};b.prototype.reset=function(c,a){var f=require("path"),e=require("fs"),k=require("fs-extra"),g=require("x.hub.fileman.js").fileManager.getUserRootDataPath();
this._logger.log("debug","reset ("+c+")");switch(c){case "passwords":c=f.join(g,"localstorage","x.hub.Server.pwd");e.existsSync(c)&&(this._logger.log("trace","remove file "+c),k.removeSync(c));require("x.hub.password.js").reset(function(){a&&a(null,!0)});break;case "network":this._platform.reset("network",function(m,p){a&&a(m,p)});break;case "factory":this._persistData();e.existsSync(g)&&(this._logger.log("trace","clear folder "+g),k.emptyDirSync(g));this._platform.reset("factory",function(m,p){a&&
a(m,p)});break;default:a&&a(Error("unknonw reset mode: "+c))}};b.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};b.prototype.setTimeZoneCompatiable=function(c,a){this._platform.setTZData(c,function(f){f||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{timezone:c})});a&&a(f)})};b.prototype.getTimeZoneCompatiable=function(c){this._platform.getTZData(c)};b.prototype.setLocation=function(c,a,f){this._platform.setLocation(c,a,function(e){e||
process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:c,long:a})});f&&f(e)})};b.prototype.getLocation=function(c){this._platform.getLocation(function(a,f,e){c&&c(a,f,e)})};b.prototype.setDateTime=function(c,a,f,e,k,g){isNaN(c)||1970>c||9999<c?g&&g(Error("year invalid")):isNaN(a)||1>a||12<a?g&&g(Error("month invalid")):isNaN(f)||1>f||31<f?g&&g(Error("date invalid")):isNaN(e)||0>e||23<e?g&&g(Error("hour invalid")):isNaN(k)||0>k||59<k?g&&g(Error("minute invalid")):this._platform.setTime({year:c,
month:a,date:f,hour:e,minute:k},g)};b.prototype.getLogs=function(c){var a=require("x.hub.fileman.js").fileManager.getUserLogPath(),f=require("os").tmpdir(),e=require("path"),k=require("fs-extra"),g=require("archiver"),m="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",p=e.join(f,m);f=k.createWriteStream(p);g=g("zip");f.on("close",function(){c&&(c(null,m,p),c=null)});f.on("error",function(t){c&&(c(t),c=null)});g.on("error",function(t){c&&(c(t),
c=null)});g.pipe(f);g.directory(a);g.finalize()};b.prototype.clearLogs=function(c){require("x.hub.logman.js").clearLogs(function(a){c&&c(a)})};b.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer()};b.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};b.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};b.prototype.isLocked=function(){return this._locked};b.prototype.lock=function(c,a){!c||this.checkPin(c)?(localStorage.setItem("x.hub.Server.lock",
!0),this._locked=!0,a&&a(null)):(c=Error("failed to lock"),c.code="000003",a&&a(c))};b.prototype.unlock=function(c,a){c&&this.checkPin(c)?(localStorage.setItem("x.hub.Server.lock",!1),this._locked=!1,a&&a(null)):(c=Error("access denied (locked)"),c.code="000007",a&&a(c))};b.prototype.setPin=function(c,a,f){c=require("x.hub.password.js").setPin(c,a);f&&f(c?null:Error("failed"))};b.prototype.checkPin=function(c){return require("x.hub.password.js").checkPin(c)};b.prototype.getRCS=function(){return this._rcs};
b.prototype.setRCS=function(c,a){localStorage.getItem("x.hub.Server.rcs",c);this._rcs=c;a&&a()};b.prototype._persistData=function(){var c=require("fs"),a=require("node-localstorage").LocalStorage;this._logger.log("debug","vid is "+this._vid);this.persitentData["x.hub.Server.vid"]=this._vid;var f=JSON.stringify(this.persitentData);c.existsSync(this._getSrvPath())||c.mkdirSync(this._getSrvPath());(new a(this.PERSISTENT_DATA_PATH)).setItem(this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE,f);this._logger.log("trace",
"data is persisted : "+f)};b.prototype._restorePersistentData=function(){var c=this,a=require("fs"),f=require("node-localstorage").LocalStorage;require("path");this._logger.log("debug","try to load data from persistent data");a.existsSync(this._getSrvPath())||a.mkdirSync(this._getSrvPath());if(a=(new f(this.PERSISTENT_DATA_PATH)).getItem(this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE))try{var e=JSON.parse(a);if(localStorage)for(var k=Object.keys(e),g=$jscomp.makeIterator(k),m=g.next();!m.done;m=g.next())key=
m.value,localStorage.setItem(key,e[key]),this._logger.log("debug",key+" is set by "+e[key]+" from persitent data");else this._logger.log("error","something is wrong, we do not have global localstorage")}catch(p){this._logger.log("error","error in parsing the persitente data and restoring"),this._logger.log("error",p)}else this._logger.log("debug","persist data after 30 secs"),setTimeout(function(){c._persistData()},3E4)};return b}();x.hub.Handler=function(){this.server=null};
x.hub.Handler.prototype.Server=x.hub.Server;x.hub.Handler.prototype.ServerNEO=x.hub.ServerNEO;x.hub.Handler.prototype.ServerV6=x.hub.ServerV6;x.hub.Handler.prototype.getServer=function(){return this.server};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
