var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var h=e[f];if(!(h in d))return;d=d[h]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+c+"$"+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(f,h){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:h})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",d=0,e=function(f){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new b(c+(f||"")+"_"+d++,f)};return e},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=$jscomp.global[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&$jscomp.defineProperty(d.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
var x=x||{};x.hub=x.hub||{};x.hub.v5=x.hub.v5||{};x.hub.v5.LocalSPIBus=function(a,b){this._device=b;this._openspi=null;this._timeout=2E3;this._callback=null};x.hub.v5.LocalSPIBus.prototype._transferChunked=function(a,b,c,d){var e=a;a.length>c&&(e=a.slice(0,c));var f=new Buffer(e.length),h=this;this._openspi.transfer(e,f,function(g,k){b=Buffer.concat([b,k]);a.length>c?h._transferChunked(a.slice(c),b,c,d):d(b)})};
x.hub.v5.LocalSPIBus.prototype._openDevice=function(a){var b=require("spi"),c=this,d=this._device;null==this._openspi&&(this._openspi=new b.Spi(d,{mode:b.MODE.MODE_0,chipSelect:b.CS.low,bitOrder:b.ORDER.msb}),this._openspi.maxSpeed(1E6),this._openspi.open());this._transferChunked(new Buffer(a),new Buffer([]),63,function(e){for(var f=0;f<e.length;f++);c._callback&&c._callback({error:null,data:e})})};x.hub.v5.LocalSPIBus.prototype.send=function(a,b,c){this._callback=c;this._openDevice(a)};
x.hub.v5.LocalSPIBus.prototype.receive=function(a,b,c){b=[];for(var d=0;d<a;d++)b.push(0);this.send(b,null,function(e){c&&c(e)})};x.hub.v5.LocalSPIBus.prototype.end=function(){};x.hub.v5.STMSPISerial=function(){this._onTimeout=this._onData=this._onError=this._timeoutTimer=this._spiPort=this._pin=this._port=null};x.hub.v5.STMSPISerial.prototype.on=function(a,b){"error"==a?this._onError=b:"data"==a?this._onData=b:"timeout"==a&&(this._onTimeout=b)};
x.hub.v5.STMSPISerial.prototype.open=function(a,b,c,d){c||(c=1E6);this._port=a;this._pin=d;this._baudrate=c;try{var e=require("spi")}catch(f){}e?(this._spiPort=new e.Spi(this._port,{mode:e.MODE.MODE_0,chipSelect:e.CS.low,bitOrder:e.ORDER.msb}),this._spiPort.maxSpeed(this._baudrate),this._spiPort.open(),b&&b(),this._read()):this._onError&&this._onError()};
x.hub.v5.STMSPISerial.prototype._writeChunked=function(a,b,c,d){var e=a;a.length>c&&(e=a.slice(0,c));new Buffer(e.length);var f=this;this._spiPort.write(e,function(h,g){a.length>c?f._writeChunked(a.slice(c),b,c,d):d()})};
x.hub.v5.STMSPISerial.prototype.write=function(a,b){if(this._spiPort){var c=this;XC.debugf("WRITE SPI:");XC.debugf(a);c._writeChunked(new Buffer(a),new Buffer([]),63,function(d){b&&(c._timeoutTimer&&clearTimeout(c._timeoutTimer),c._timeoutTimer=setTimeout(function(){c._spiPort=null;c._onTimeout&&c._onTimeout()},b))})}};x.hub.v5.STMSPISerial.prototype.flush=function(){};
x.hub.v5.STMSPISerial.prototype.close=function(){this._spiPort&&this._spiPort.close();this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null);this._onTimeout=this._onData=this._onError=null};x.hub.v5.STMSPISerial.prototype.generateCommandMessage=function(a,b){var c=a;if(b){c=[31];c.push(b);for(b=0;b<a.length;b++)if("string"==typeof a)c.push(a.charCodeAt(b));else{var d=a[b];31!=d&&4!=d&&27!=d||c.push(27);c.push(d)}c.push(0);c.push(4)}return c};
x.hub.v5.STMSPISerial.prototype._read=function(){if(this._spiPort){var a=this,b=require("child_process").exec;b=b("cat /sys/class/gpio/"+this._pin+"/value");b.stdout.on("data",function(c){if(1==c.trim()&&a._spiPort){var d=new Buffer(63);for(c=0;63>c;c++)d[c]="0x00";var e=new Buffer(d.length);setTimeout(function(){a._spiPort.transfer(d,e,function(f,h){f=!1;for(var g=0;63>g;g++)if(4!=h[g]){f=!0;break}f&&a._timeoutTimer&&(clearTimeout(a._timeoutTimer),a._timeoutTimer=null);f&&a._onData&&a._onData(h)})},
50)}});b.on("error",function(c){});b.on("close",function(c){a._readTimeout=setTimeout(function(){a._read()},50)})}};x.hub.v5.USBSerial=function(a,b,c){this._logger=require("x.logger.js").getLogger("x.hub.v5.USBSerial");this._port=a;this._pin=b;this._pin||(this._pin="gpio228");this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=10;this.ACK_TO=200;this.RSP_TO=1E4;this.MAX_RSP_TO=3E4;this.RSP_END_TO=2E3;this._openSTMUSB(c)};
x.hub.v5.USBSerial.prototype.on=function(a,b){"data"==a&&(this._onData=b)};x.hub.v5.USBSerial.prototype.reset=function(a){this._logger.log("info","reset st fifo");var b=this._reqFifo;this._reqFifo=[];for(var c=0;c<b.length;c++)this._onRequestCancel(b[c]);a&&a()};
x.hub.v5.USBSerial.prototype._getNextDataPackage=function(){for(var a=!1,b=!1,c=!1,d,e=0,f=[],h=0;h<this._receiveBuffer.length;h++){d=!1;if(27==this._receiveBuffer[h]||4==this._receiveBuffer[h]||31==this._receiveBuffer[h])if(a)d=!0;else if(27==this._receiveBuffer[h])a=!0;else if(4==this._receiveBuffer[h]){var g=!1;b&&(g=!0);b=!1;c=!0;if(g){this._receiveBuffer=this._receiveBuffer.slice(h+1);break}else c=!1}else 31==this._receiveBuffer[h]&&(b=!0,e=0);else b&&(d=!0);d&&(f[e++]=this._receiveBuffer[h],
a=!1)}a=null;c&&2<=e&&(a=new Buffer(f.slice(0,e)));return a};
x.hub.v5.USBSerial.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&a(!0);else{var b=this,c=a,d=require("xnm.aio.m10T.js"),e=null,f=!1;-1!=this._port.indexOf("spi")?(f=!0,e=new x.hub.v5.STMSPISerial,d=1E6):(e=new d.STMUSBSerial,d=115200);e.on("error",function(){b._logger.log("trace","st port error");try{b._stmUSBSerial.close()}catch(h){}b._stmUSBSerial=null;c&&c(!1);c=null});e.on("timeout",function(){b._logger.log("trace","st port timeout");if(f){try{b._stmUSBSerial.close()}catch(h){}b._stmUSBSerial=
null;setTimeout(function(){b._openSTMUSB(a)},500)}});e.on("data",function(h){b._logger.log("trace","st data:"+h.toString("hex"));b._receiveBuffer=Buffer.concat([b._receiveBuffer,h]);for(h=b._getNextDataPackage();h;){b._logger.log("trace","st package:"+h.toString("hex"));var g=h.slice(1,h.length-1);switch(h[0]){case 80:b._logger.log("info","receive st event:"+g.toString());b._sendAck();break;case 0:b._onNak();break;case 1:b._onAck();break;case 34:b._sendAck();b._onRspError(g);break;case 32:b._sendAck();
b._onRsp(g);break;case 33:b._sendAck();b._onRspEnd(g);break;default:b._sendAck()}b._onData&&b._onData({type:h[0],data:g});h=b._getNextDataPackage()}});e.open(this._port,function(){b._logger.log("trace","st connected");b._stmUSBSerial=e;c&&c(!0);c=null},d,this._pin)}};
x.hub.v5.USBSerial.prototype.sendCommand=function(a,b,c,d){if(144==a){this._logger.log("info","send st (0x"+a.toString(16)+") request directly:"+(b?b.toString("hex"):b));var e=this;this._openSTMUSB(function(h){h?(h=e._stmUSBSerial.generateCommandMessage(b,a),e._stmUSBSerial.write(h,0,function(){c&&c({})})):(e._logger.log("debug","open st failed"),e._onRequestFinish("st not open"))})}else{this._logger.log("info","add st (0x"+a.toString(16)+") request:"+(b&&b instanceof Buffer?b.toString("hex"):b));
d=this._reqFifo.length;var f={type:a,req:b,ackTo:null,ackToRetry:0,rspTo:null,state:0,callback:c,responseBuffer:null};this._reqFifo.length==this.REQ_FIFO_MAX_LEN&&(this._onRequestCancel(this._reqFifo[1]),this._reqFifo.splice(1,1));this._reqFifo.push(f);0==d&&this._sendNextReq()}};
x.hub.v5.USBSerial.prototype._sendNextReq=function(){var a=this._reqFifo[0];if(a){var b=this;a.state=!this._useAck||16!=a.type&&17!=a.type&&18!=a.type&&19!=a.type&&20!=a.type&&21!=a.type&&32!=a.type&&33!=a.type?53==a.type?0:2:1;2==a.state&&(a.rspTo=setTimeout(function(){b._onRspTimeout()},this.RSP_TO));this._logger.log("debug","send st (0x"+a.type.toString(16)+") request:"+(a.req&&a.req instanceof Buffer?a.req.toString("hex"):a.req));this._openSTMUSB(function(c){c?(c=b._stmUSBSerial.generateCommandMessage(a.req,
a.type),b._stmUSBSerial.write(c,0,function(){1==a.state?a.ackTo=setTimeout(function(){b._onAckTimeout()},b.ACK_TO):0==a.state&&b._onRequestFinish(null)})):(b._logger.log("debug","open st failed"),b._onRequestFinish("st not open"))})}};x.hub.v5.USBSerial.prototype._sendAck=function(){if(this._useAck){this._logger.log("debug","send ack to st");var a=this._stmUSBSerial.generateCommandMessage("",1);this._stmUSBSerial.write(a)}};
x.hub.v5.USBSerial.prototype._onAckTimeout=function(){var a=this._reqFifo[0];if(a)if(a.ackToRetry+=1,3<a.ackToRetry)this._onRequestFinish("response ack timeout 3 times");else{this._logger.log("debug","st ack timeout, re-send "+a.ackToRetry+". request:"+this._reqToString(a));var b=this;a.state=1;a.ackTo=setTimeout(function(){b._onAckTimeout()},this.ACK_TO*a.ackToRetry);this._logger.log("debug","re-send st (0x"+a.type.toString(16)+") request:"+this._reqToString(a));a=this._stmUSBSerial.generateCommandMessage(a.req,
a.type);this._stmUSBSerial.write(a)}};x.hub.v5.USBSerial.prototype._onNak=function(){var a=this._reqFifo[0];a&&(this._logger.log("debug","receive st nak:"+this._reqToString(a)),this._onRequestFinish("response nak"))};
x.hub.v5.USBSerial.prototype._onAck=function(){var a=this._reqFifo[0];if(a&&(1==a.state||2==a.state)){var b=this;if(2==a.state){this._logger.log("debug","receive st ack");var c=(new Date).getTime(),d=c+this.RSP_TO-a.startTS;d<this.MAX_RSP_TO?(a.rspTo&&(clearTimeout(a.rspTo),a.rspTo=null),a.rspTo=setTimeout(function(){b._onRspTimeout()},this.RSP_TO)):1!=a.useMaxRspTo&&(d=this.MAX_RSP_TO+a.startTS-c,a.useMaxRspTo=!0,a.rspTo=setTimeout(function(){b._onRspTimeout()},d))}else this._logger.log("debug",
"receive st ack:"+this._reqToString(a)),a.state=2,a.ackTo&&(clearTimeout(a.ackTo),a.ackTo=null),a.rspTo&&(clearTimeout(a.rspTo),a.rspTo=null),a.startTS=(new Date).getTime(),a.rspTo=setTimeout(function(){b._onRspTimeout()},this.RSP_TO)}};x.hub.v5.USBSerial.prototype._onRspTimeout=function(){var a=this._reqFifo[0];a&&(this._logger.log("debug","receive st ack:"+this._reqToString(a)),1==a.state?this._onRequestFinish("no ack"):2==a.state?this._onRequestFinish("response timeout"):3==a.state&&this._onRequestFinish("response end timeout"))};
x.hub.v5.USBSerial.prototype._onRspError=function(a){var b=this._reqFifo[0];b&&0!=b.state&&1!=b.state&&(this._logger.log("debug","receive st response_error:"+this._reqToString(b)+" --\x3e "+(a?a.toString():"")),b.responseBuffer=a,this._onRequestFinish("response error:"+(a?a.toString():"")))};
x.hub.v5.USBSerial.prototype._onRsp=function(a){var b=this._reqFifo[0];if(b&&0!=b.state&&1!=b.state){this._logger.log("debug","receive st response:"+this._reqToString(b)+" --\x3e "+a.toString());var c=this;b.state=3;b.rspTo&&clearTimeout(b.rspTo);b.rspTo=setTimeout(function(){c._onRspTimeout()},this.RSP_END_TO);b.responseBuffer=b.responseBuffer?Buffer.concat([b.responseBuffer,a]):a}};
x.hub.v5.USBSerial.prototype._onRspEnd=function(a){var b=this._reqFifo[0];b&&0!=b.state&&1!=b.state&&(16==b.type||17==b.type||18==b.type||19==b.type||20==b.type||21==b.type?this._logger.log("debug","receive st response_end:"+this._reqToString(b)+" --\x3e "+a.toString()):this._logger.log("debug","receive st response_end:"+this._reqToString(b)+" --\x3e "+a.toString("hex")),b.state=0,b.rspTo&&(clearTimeout(b.rspTo),b.rspTo=null),b.responseBuffer=b.responseBuffer?Buffer.concat([b.responseBuffer,a]):a,
this._onRequestFinish(null))};
x.hub.v5.USBSerial.prototype._onRequestFinish=function(a){var b=this._reqFifo[0];if(b){b.ackTo&&(clearTimeout(b.ackTo),b.ackTo=null);b.rspTo&&(clearTimeout(b.rspTo),b.rspTo=null);var c="request finish:";c=16==b.type||17==b.type||18==b.type||19==b.type||20==b.type||21==b.type?c+(b.req+" --\x3e "):c+(b.req.toString("hex")+" --\x3e ");a?this._logger.log("warn",c+a):(b.responseBuffer&&(c+=b.responseBuffer.toString()),this._logger.log("info",c));try{b.callback&&b.callback({error:a,data:b.responseBuffer})}catch(d){}this._reqFifo.splice(0,
1);this._sendNextReq()}};x.hub.v5.USBSerial.prototype._onRequestCancel=function(a){if(a){a.ackTo&&(clearTimeout(a.ackTo),a.ackTo=null);a.rspTo&&(clearTimeout(a.rspTo),a.rspTo=null);var b="request cancelled:"+this._reqToString(a);this._logger.log("warn",b);a.callback&&a.callback({error:"request cancelled"})}};x.hub.v5.USBSerial.prototype._reqToString=function(a){return a.req&&a.req instanceof Buffer?a.req.toString("hex"):a.req};x.hub.v5.PK=null;
x.hub.v5.getHWSerial=function(a){var b=require("child_process").exec;b=b("cat /proc/cpuinfo | grep Serial | cut -d ':' -f 2");b.stdout.on("data",function(c){a(c.trim());a=null});b.on("error",function(c){a&&a("");a=null});b.on("close",function(c){a&&a("");a=null})};
x.hub.v5.getPrivateKey=function(a){x.hub.v5.PK?a(x.hub.v5.PK):x.hub.v5.getHWSerial(function(b){var c="";if(!localStorage.getItem("x.hub.v5.PK")){for(var d=0;64>d;d++)c+=Math.floor(15*Math.random()).toString(16);localStorage.setItem("x.hub.v5.PK",c)}c=localStorage.getItem("x.hub.v5.PK");d=require("x.crypt.js");x.hub.v5.PK=d.SHA256(c+b);a(x.hub.v5.PK)})};
x.hub.v5.CloudConnect=function(){var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect");this._cloudKey=this._at=this._sid=this._cloudPort=this._cloudServer=null;this._cloudEnabled=!1;this._client=null};a.prototype.CLOUD_SERVER="v5ws.mediola.com";a.prototype.CLOUD_SERVER_PORT=443;a.prototype.init=function(b){this._client&&(this._client.stop(),this._client=null);var c=this;this._cloudServer=localStorage.getItem("x.hub.v5.cloudServer");this._cloudServer||(this._cloudServer=
this.CLOUD_SERVER);this._cloudPort=localStorage.getItem("x.hub.v5.cloudPort");this._cloudPort||(this._cloudPort=this.CLOUD_SERVER_PORT);this._sid=localStorage.getItem("x.hub.v5.SID");this._at=localStorage.getItem("x.hub.Server.pwd");this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");var d=localStorage.getItem("x.hub.v5.config");d=d?parseInt(d,16):255;(this._cloudEnabled=0==(d&64))&&this._at&&this._buildClient(function(e){c._client=e;c._client.init(b)})};a.prototype.getCloudServer=function(){return this._cloudServer};
a.prototype.setCloudServer=function(b){localStorage.setItem("x.hub.v5.cloudServer",b);this._cloudServer=b?b:this.CLOUD_SERVER};a.prototype.getCloudPort=function(){return this._cloudPort};a.prototype.setCloudPort=function(b){localStorage.setItem("x.hub.v5.cloudPort",b);this._cloudPort=b?b:this.CLOUD_SERVER_PORT};a.prototype.setCloudKey=function(b){localStorage.setItem("x.hub.v5.cloudKey",b);this._cloudKey=b};a.prototype.isCloudEnabled=function(){return this._cloudEnabled};a.prototype.isConnected=function(){return!this._client||
this._client instanceof x.hub.v5.CloudConnectHTTP?!1:this._client.isConnected()};a.prototype.sendMessage=function(b,c){this._client&&this._client.sendMessage(b,c)};a.prototype.sendMessageActive=function(b,c){this._client?this._client.sendMessageActive(b,c):c&&c(Error("no cloud connection client"))};a.prototype.sendMessageWithType=function(b,c,d){this._client?this._client.sendMessageWithType(b,c,d):d&&d(Error("no cloud connection client"))};a.prototype._buildClient=function(b){if("CA"==global.HARDWARE_VERSION||
"A1"==global.HARDWARE_VERSION)b(new x.hub.v5.CloudConnectWS(this._cloudServer,this._cloudPort,this._sid,this._at,this._cloudKey,this._cloudEnabled));else if("v5ws.mediola.com"==this._cloudServer)b(new x.hub.v5.CloudConnectWS(this._cloudServer,this._cloudPort,this._sid,this._at,this._cloudKey,this._cloudEnabled));else{var c=this._cloudServer,d=this._cloudPort,e=this._sid;443==d&&(d=80);var f=new (require("ws"))("ws://"+c+":"+d+"/ws/"+e),h=this;f.on("upgrade",function(g){b&&(h._logger.log("trace","support ws"),
b(new x.hub.v5.CloudConnectWS(h._cloudServer,h._cloudPort,h._sid,h._at,h._cloudKey,h._cloudEnabled)),b=null,f.close())});f.on("error",function(g){b&&(h._logger.log("trace","not support ws"),b(new x.hub.v5.CloudConnectHTTP),b=null,f.close())});f.on("close",function(g,k){b&&(h._logger.log("trace","not support ws"),b(new x.hub.v5.CloudConnectHTTP),b=null,f.close())})}};return a}();
x.hub.v5.CloudConnectHTTP=function(){var a=function(){};a.prototype.check=function(){if("EA"==global.HARDWARE_VERSION){var c=require("dns").getServers();require("fs").readFile("/etc/resolv.conf",{encoding:"utf8"},function(d,e){if(!d){d=e.split("\n");e=!1;if(d&&0<d.length)for(var f=0;f<d.length;f++){var h=d[f].trim();if("#"!=h.charAt(0)&&"nameserver"==h.substr(0,10)&&(h=h.replace("nameserver","").trim())&&-1==c.indexOf(h)){e=!0;break}}e&&(d=require("child_process").exec,d("/etc/init.d/S60_v5plus_daemon restart"))}})}};
var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.HTTP");this._request=null;this._timeout=3E5;this._error_count=0;this._run=!1;this._dns_error_count=0};b.prototype.CLOUD_SERVER="v5ws.mediola.com";b.prototype.CLOUD_SERVER_PORT=443;b.prototype.init=function(c){c&&(this._server=c);this._run=!0;this._liveResponse=null;this._messages=[];this._challenge=[];this._cloudToken=[0,0,0,0,0,0,0,0];c=require("x.crypt.js");this._cloudServer=localStorage.getItem("x.hub.v5.cloudServer");
this._cloudServer||(this._cloudServer=this.CLOUD_SERVER);this._cloudPort=localStorage.getItem("x.hub.v5.cloudPort");this._cloudPort||(this._cloudPort=this.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(this._SID=c.AES.h2a(localStorage.getItem("x.hub.v5.SID")));this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");var d=this;this._computeKeys(function(){d._request?d._disconnect(!0):d.checkConnection()})};b.prototype.stop=function(){this._run=!1;this._disconnect(!0)};b.prototype.checkConnection=
function(){if(this._run&&localStorage&&localStorage.getItem("x.hub.v5.config")){var c=parseInt(localStorage.getItem("x.hub.v5.config"),16);0==(c&64)&&this._cloudServer&&localStorage.getItem("x.hub.v5.SID")?this._connect():this._disconnect()}};b.prototype.sendMessage=function(c,d){d?this._messages.push(c):this._messages.unshift(c)};b.prototype.sendMessageActive=function(c,d){this._messages.unshift(c);this._request&&this._request.abort();d&&d()};b.prototype._computeKeys=function(c){var d=this;this._iv&&
this._key?c():x.hub.v5.getPrivateKey(function(e){var f=require("x.crypt.js");e=f.Curve25519.curve25519(e,d._cloudKey);for(var h="",g=0;g<e.length;g++)h+=XC.getHexVal(e[g],2);d._key=f.AES.h2a(h.substr(0,32));d._iv=f.AES.h2a(h.substr(32));c()})};b.prototype._handleServerResponse=function(c){var d=this,e=[],f=null;if(4<=c.length)if(4<=c.length&&240==c[1])c.splice(0,4);else if(4<=c.length&&255==c[1])c.splice(0,4),this._request&&this._request.abort();else{var h=(c[2]<<8)+c[3];c.length>=h+4&&(f=c[1],e=
c.slice(4,h+4),c.splice(0,h+4))}if(0<e.length){c=[];for(h=0;h<e.length;h++)c.push(e[h]);e=require("x.crypt.js");e.AES.setSize(128);e=e.AES.a2a(e.AES.decrypt(c,this._key,this._iv,!1));if(16<=e.length)if(e.slice(8,16).toString()==this._challenge.toString()){this._cloudToken=e.slice(0,8);for(c=e.length-1;16<c&&0!=e[c];)c--;e=(new Buffer(e.slice(16,c))).toString("utf8");0!=f&&(this._liveResponse?this._liveResponse=null:0<this._messages.length&&this._messages.pop());if(0==f||1==f){var g=null;localStorage&&
localStorage.getItem("x.hub.Server.pwd")&&(g=localStorage.getItem("x.hub.Server.pwd"));null==g&&(g="null");e!=g?(this.sendMessage("0101"+g,!0),this._request&&this._request.abort()):0==f?this._request&&this._request.abort():0<this._messages.length&&this._request&&this._request.abort()}else if((5==f||3==f)&&8<e.length){var k=null;5==f&&(k=e.substr(0,8),e=e.substr(8));f=d._parseTunnelUrl(e);d=this;if("/"==f.pathname||"/info"==f.pathname||"/set"==f.pathname||"/cmd"==f.pathname||"/executeCommand"==f.pathname||
"/getStates"==f.pathname){if(f.query&&f.query.json)try{JSON.parse(f.query.json)}catch(l){e=e.replace(f.pathname,""),"?json="==e.substr(0,6)&&(e=e.substr(6),f.query={json:e})}this._logger.log("trace","Remote Request Query:"+JSON.stringify(f.query));if(f.query&&f.query.json&&1==Object.keys(f.query).length)try{f.query=JSON.parse(f.query.json);f.path="";for(g in f.query)f.path+="&"+g+"="+f.query[g];f.path=f.pathname+"?"+f.path.substr(1)}catch(l){}this._server.doRequest(f.pathname,{query:f.query,url:f.path},
function(l){k&&(d._liveResponse=k+l);d._request&&d._request.abort()})}else{if(f.query&&f.query.json)try{JSON.parse(f.query.json)}catch(l){e=e.replace(f.pathname,""),"?json="==e.substr(0,6)&&(e=e.substr(6),f.query={json:e})}this._logger.log("trace","Remote Request Query:"+JSON.stringify(f.query));if(f.query&&f.query.json&&1==Object.keys(f.query).length)try{f.query=JSON.parse(f.query.json);f.path="";for(g in f.query)f.path+="&"+g+"="+f.query[g];f.path=f.pathname+"?"+f.path.substr(1)}catch(l){}this._server.doRequest(f.pathname,
{query:f.query,url:f.path,pathname:f.pathname},function(l){k&&(d._liveResponse=k+l);d._request&&d._request.abort()})}}}else return 1}return 0};b.prototype._disconnect=function(c){this._request&&(this._request.abort(),c&&(this._request=null))};b.prototype._connect=function(){var c=225,d="";this._liveResponse?(d=this._liveResponse,c=226):0<this._messages.length&&(d=this._messages[this._messages.length-1]);var e=require("x.crypt.js");e.AES.setSize(128);d=e.AES.s2a(d);var f=[];f=f.concat(this._cloudToken);
this._challenge=[];for(var h=0;8>h;h++)this._challenge.push(Math.floor(255*Math.random()));f=f.concat(this._challenge);f=f.concat(d);d=e.AES.encrypt(f,this._key,this._iv);d=e.AES.a2a(d);e.AES.a2a(e.AES.decrypt(d,this._key,this._iv,!1));c=[0,c];c=c.concat(this._SID);c=c.concat(d);c=new Buffer(c);e=this._cloudPort;80==e&&(e=443);d=require("x.hub.v5.js");f="";d.server&&(f="CCU3"==d.server.hostType?f+(d.server.HWV+"-CCU3/"+d.server.VERSION+"/"+d.server._vid):f+(d.server.HWV+"/"+d.server.VERSION+"/"+d.server._vid));
e={host:this._cloudServer,port:e,path:"/msmt",method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":c.length,Connection:"keep-alive","X-MG-Info":f}};d=require("https");var g=this;g._logger.log("trace","Remote Access Start: "+JSON.stringify(e));this._request=d.request(e,function(k){g._logger.log("trace","Remote Access Response:"+k.statusCode);g._dns_error_count=0;if(200==k.statusCode){k.setEncoding("binary");var l=[],m=0;k.on("data",function(n){n=new Buffer(n,"binary");
for(var p=0;p<n.length;p++)l.push(n[p]);m=g._handleServerResponse(l)});k.on("end",function(){g._logger.log("trace","Remote Access End");g._error_count=0;g._disconnect();1==m?setTimeout(function(){g._iv=null;g._key=null;g._request=null;g.init()},1E3):g.checkConnection()})}else XC.debugf("Failed to post request to "+g.ip)});this._request.setTimeout(this._timeout,function(){g._logger.log("warn","Remote Access Timeout");g._request.abort()});this._request.on("close",function(k){XC.debugf("close")});this._request.on("error",
function(k){g._logger.log("warn","Remote Access ERROR: "+k);"EAI_AGAIN"==k.code&&(g._dns_error_count++,5<g._dns_error_count&&(g._dns_error_count=0,(new a).check()));g._error_count++;g._disconnect();k=g._error_count*g._error_count*100;2E3<k&&(k=2E3);setTimeout(function(){g.checkConnection()},k)});c&&this._request.write(c);this._request.end()};b.prototype._parseTunnelUrl=function(c){for(var d,e=-1;e<c.length&&(e++,"?"!=c.charAt(e)););if(-1==e)return{pathname:c};d=0==e?"/":c.substr(0,e);return"json="==
c.substr(e+1,5)?{pathname:d,query:{json:c.substr(e+6)}}:require("url").parse(c,!0)};return b}();
x.hub.v5.CloudConnectWS=function(){var a=require("util"),b=require("events"),c=function(d,e,f,h,g,k,l,m){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS.Socket");this._host=d;this._port=e;this._sid=f;this._token=h;this._hwv=g;this._server=k;this._ckey=l;this._civ=m;this._ws=this._hmac_key=this._communication_key=this._server_key=this._client_key=null;this._state=0;this._reqBuf="";this._pongTO=this._pingInterval=null;this._pongTOCount=0};a.inherits(c,b);c.prototype.open=function(){var d=
require("x.hub.v5.js"),e="";d.server&&(e="CCU3"==d.server.hostType?e+(d.server.HWV+"-CCU3/"+d.server.VERSION+"/"+d.server._vid):e+(d.server.HWV+"/"+d.server.VERSION+"/"+d.server._vid));var f=require("x.crypt.js"),h=require("crypto");d=new (require("ws"))("ws://"+this._host+":"+this._port+"/ws/"+this._sid,null,{headers:{"X-MG-Info":e}});d._req&&d._req._headers&&d._req._headers["sec-websocket-key"]&&(this._logger.log("trace","Sec-WebSocket-Key: "+d._req._headers["sec-websocket-key"]),e=new Buffer(d._req._headers["sec-websocket-key"],
"base64"),this._client_key=f.AES.a2a(f.AES.decrypt(e,this._ckey,this._civ,!1)),this._logger.log("trace","client_key: "+this._client_key));var g=this;this._state=1;d.on("upgrade",function(k){g._logger.log("trace","upgrade");g._state=2;var l=!1;if(k&&k.headers&&k.headers["x-sec-websocket-token"]&&(g._logger.log("trace","X-Sec-WebSocket-Token: "+k.headers["x-sec-websocket-token"]),104==k.headers["x-sec-websocket-token"].length)){var m=k.headers["x-sec-websocket-token"].substr(0,64);k=k.headers["x-sec-websocket-token"].substr(64);
g._logger.log("trace","hmac: "+k);g._server_key=f.AES.a2a(f.AES.decrypt(f.AES.h2a(m),g._ckey,g._civ,!1));g._logger.log("trace","server_key: "+g._server_key);g._communication_key=g._client_key.slice(0,16).concat(g._server_key.slice(0,16));g._logger.log("trace","communication_key: "+g._communication_key);g._hmac_key=g._server_key.slice(16,32);g._logger.log("trace","hmac_key: "+g._hmac_key);m="";for(var n=0;n<g._communication_key.length;n++)m+=XC.getHexVal(g._communication_key[n],2);n="";for(var p=0;p<
g._hmac_key.length;p++)n+=XC.getHexVal(g._hmac_key[p],2);n=h.createHmac("sha1",n);n.update(m);m=n.digest("hex").toUpperCase();g._logger.log("trace","hmac_check: "+m+" hmac:"+k);m==k&&(l=!0)}l||(g._state=5)});d.on("open",function(){g._logger.log("trace","open");2==g._state?(g._state=3,g._logger.log("trace","connected"),g._sendMessage({token:g._token,server:g._server,hwv:g._hwv},1),g._startPeriodicPing(),g.emit("open")):5==g._state&&(g._logger.log("trace","key exchange failed"),g.emit("error",Error("key exchange failed")),
g.close())});d.on("message",function(k){g._logger.log("trace","message ("+k.length+"):"+k.toString("hex"));var l=g._communication_key.slice(0,16),m=g._communication_key.slice(16,32);k=f.AES.a2a(f.AES.decrypt(k,l,m,!1));if(8<k.length){l=k.slice(0,8);g._logger.log("trace","head: "+l);m=!0;l[0]&128&&(m=!1,l[0]-=128);k=f.AES.a2s([k.splice(8)]);g._logger.log("trace","data:"+k);g._reqBuf+=k;k=null;if(5==l[0]){k="";for(var n=4;8>n;n++)k+=XC.getHexVal(l[n],2);g._logger.log("trace","liveID: "+k)}m&&(m=g._reqBuf,
g._reqBuf="",g._onReq(m,l,k))}});d.on("close",function(k,l){g._logger.log("trace","socket closed #"+k+":"+l);g._onClose("close")});d.on("error",function(k){g._logger.log("warn","socket error:"+k.message);g._onError(k)});d.on("pong",function(){g._logger.log("trace","PONG!");g._pongTO&&clearTimeout(g._pongTO);g._pongTO=null;g._pongTOCount=0});this._ws=d};c.prototype.abort=function(){this._state=4;this.removeAllListeners("open");this.removeAllListeners("error");this.removeAllListeners("close");this.removeAllListeners("message");
this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this._ws&&this._ws.terminate();this._ws=null};c.prototype.close=function(){this._state=4;this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this._ws&&this._ws.close();this._ws=null};c.prototype.send=function(d,e,f,h){3!=this._state?h&&h(Error("scoket not connected")):this._sendMessage(d,
e,f,null,h)};c.prototype._sendMessage=function(d,e,f,h,g){var k=require("x.crypt.js");d="string"==typeof d?d:JSON.stringify(d);this._logger.log("trace","send message:"+d+" type:"+e+" messageId:"+f);var l=this._communication_key.slice(0,16),m=this._communication_key.slice(16,32);e=[e&255,0,0,0];e=f?e.concat(k.AES.h2a(f)):e.concat([0,0,0,0]);e=e.concat(k.AES.s2a(d));h&&(e[0]|=128);f=k.AES.a2a(k.AES.encrypt(e,l,m));this._ws.send(f,{binary:!0,mask:!0},function(n){g&&g(n)})};c.prototype._onError=function(d){this.emit("error",
d)};c.prototype._onClose=function(){this._state=4;this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this.emit("close")};c.prototype._onReq=function(d,e,f){this.emit("message",d,e,f)};c.prototype._startPeriodicPing=function(){var d=this;this._pingInterval=setInterval(function(){d._logger.log("trace","PING WS");d._ws.ping();d._pongTO&&clearTimeout(d._pongTO);d._pongTO=setTimeout(function(){d._pongTOCount++;3<=d._pongTOCount&&
d._onPingPongFailed()},5E3)},2E4)};c.prototype._onPingPongFailed=function(){this.emit("error",Error("ping-pong failed"));this.close()};a=function(d,e,f,h,g,k){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS");this._server=null;this._host=d;if(!d)throw Error("host invalid");this._port=e;if(!e)throw Error("port invalid");443==this._port&&(this._port=80);this._sid=f;this._at=h;this._cloudKey=g;this._enabled=k;this._socket=this._ckey=this._civ=this._localIP=this._hwv=null;this._state=
0;this._reconnTO=null};a.prototype.isConnected=function(){return 2==this._state};a.prototype.init=function(d){d&&(this._server=d);this._hwv=d.HWV;this._abort();this._state=1;if(this._sid&&this._at&&this._cloudKey&&this._enabled){var e=this;this._civ=this._ckey=null;this._computeKeys(function(){e._connect()})}};a.prototype.stop=function(){this._abort()};a.prototype.sendMessageWithType=function(d,e,f){this._socket.send(d,e,null,function(){f&&f()})};a.prototype.sendMessage=function(d,e){this._socket.send(d,
2,null,function(){e&&e()})};a.prototype.sendMessageActive=function(d,e){this.sendMessage(d,e)};a.prototype._connect=function(){this._logger.log("info","connect socket");var d=this,e=new c(this._host,this._port,this._sid,this._at,this._hwv,this._localIP,this._ckey,this._civ);e.on("open",function(){d._logger.log("trace","socket open");d._onSocketOpen()});e.on("error",function(f){d._logger.log("trace","socket error:"+f.message);d._onSocketError(f)});e.on("close",function(){d._logger.log("trace","socket close");
d._onSocketClose()});e.on("message",function(f,h,g){d._logger.log("trace","socket message type:"+h[0]);g&&d._logger.log("trace","socket message liveID:"+g);d._logger.log("trace","socket message:"+f);d._onSocketMessage(f,h,g)});e.open();this._socket=e};a.prototype._abort=function(){0!=this._state&&this._socket&&this._socket.abort();this._reconnTO&&clearTimeout(this._reconnTO);this._socket=this._reconnTO=null;this._state=0};a.prototype._onSocketOpen=function(){this._logger.log("info","successfully connect to cloud:");
this._state=2};a.prototype._onSocketError=function(d){var e=this;switch(this._state){case 1:this._logger.log("warn","failed to connect to cloud:"+d.message);this._logger.log("trace","re-connect after 30 seconds");this._state=1;this._socket.abort();this._reconnTO=setTimeout(function(){e._logger.log("trace","re-try connect to cloud after connection failed");e._reconnTO=null;e._connect()},3E4);break;case 2:this._logger.log("warn","cloud connection err:"+d.message),this._logger.log("trace","re-connect after 30 seconds"),
this._state=1,this._socket.abort(),this._reconnTO=setTimeout(function(){e._logger.log("trace","re-try connect to cloud after connection error");e._reconnTO=null;e._connect()},3E4)}};a.prototype._onSocketClose=function(){this._logger.log("trace","cloud connection closed");if(2==this._state&&(this._state=1,!this._reconnTO)){var d=this;this._logger.log("trace","re-connect after 30 seconds");this._reconnTO=setTimeout(function(){d._logger.log("trace","re-try connect to cloud after connection closed");
d._reconnTO=null;d._connect()},3E4)}};a.prototype._onSocketMessage=function(d,e,f){var h=this;if("CA"==global.HARDWARE_VERSION||"A1"==global.HARDWARE_VERSION){var g=this._parseTunnelUrl2(d);g.source="cloud";this._server._dispatcher.doRequest(g,{send:function(m){h._logger.log("trace","Remote Request Response:"+m);f&&m&&h._socket.send(m,e[0],f)},json:function(m){h._logger.log("trace","Remote Request Response:"+JSON.stringify(m));f&&m&&h._socket.send(m,e[0],f)},end:function(){}},function(){var m={XC_ERR:{code:"000000",
msg:"invalid request"}};h._logger.log("trace","Remote Request Response:"+JSON.stringify(m));f&&m&&h._socket.send(m,e[0],f)})}else{g=this._parseTunnelUrl(d);if(g.query&&g.query.json)try{var k=decodeURIComponent(g.query.json);JSON.parse(k)}catch(m){d=d.replace(g.pathname,""),"?json="==d.substr(0,6)&&(d=d.substr(6),g.query={json:d})}this._logger.log("trace","Remote Request Path:"+JSON.stringify(g.pathname));this._logger.log("trace","Remote Request Query:"+JSON.stringify(g.query));if(g.query&&g.query.json&&
1==Object.keys(g.query).length)try{k=decodeURIComponent(g.query.json);g.query=JSON.parse(k);g.path="";for(var l in g.query)g.path+="&"+l+"="+g.query[l];g.path=g.pathname+"?"+g.path.substr(1)}catch(m){}h=this;this._server.doRequest(g.pathname,{query:g.query,url:g.path,pathname:g.pathname,source:"cloud"},function(m){h._logger.log("trace","Remote Request Response:"+m);f&&m&&h._socket.send(JSON.parse(m),e[0],f)})}};a.prototype._computeKeys=function(d){if(this._ckey&&this._civ)d();else{var e=this;x.hub.v5.getPrivateKey(function(f){f=
require("x.crypt.js").Curve25519.curve25519(f,e._cloudKey);for(var h="",g=0;g<f.length;g++)h+=XC.getHexVal(f[g],2);e._ckey=f.slice(0,16);e._civ=f.slice(16,32);d()})}};a.prototype._parseTunnelUrl=function(d){for(var e,f=-1;f<d.length&&(f++,"?"!=d.charAt(f)););if(-1==f)return{pathname:d};e=0==f?"/":d.substr(0,f);return"json="==d.substr(f+1,5)?{pathname:e,query:{json:d.substr(f+6)}}:require("url").parse(d,!0)};a.prototype._parseTunnelUrl2=function(d){for(var e,f=-1;f<d.length&&(f++,"?"!=d.charAt(f)););
if(-1==f)return{method:"GET",url:d,path:d,hasValidAuth:!0};e=0==f?"/":d.substr(0,f);d=d.substr(f+1);d=require("querystring").parse(d);f="GET";var h=null,g=null,k=null;if(void 0!=d.json&&null!=d.json){f="POST";h=d.json;k=(new Buffer(h,"utf8")).length;delete d.json;try{g=JSON.parse(h)}catch(m){}}var l=e;d&&(l+="?"+require("querystring").stringify(d));return{method:f,url:l,path:e,query:d,body:h,json:g,size:k,hasValidAuth:!0}};a.prototype._getLocalIP=function(){var d=require("os").networkInterfaces(),
e;for(e in d)for(var f=d[e],h=0;h<f.length;h++){var g=f[h];if(g&&!g.internal&&"IPv4"==g.family&&g.address)return g.address}return null};return a}();x.hub.v5.DownloadFile=function(a,b,c){var d=require("http"),e=require("fs");e.existsSync(a)&&e.unlinkSync(a);var f=e.createWriteStream(a);d.get(b,function(h){h&&200==h.statusCode?(h.pipe(f),f.on("finish",function(){f.close(function(){c&&c(!0)})}),f.on("error",function(g){e.unlink(a);c&&c(!1)})):c&&c(!1)}).on("error",function(h){e.unlink(a);c&&c(!1)})};
x.hub.v5.BackupSTData=function(a,b,c){if(a._stmPort){var d=function(e,f,h){a.doSTMCommand(e,function(g){g&&g.XC_SUC?require("fs").writeFile(f,JSON.stringify(g.XC_SUC),function(k){k?h(!1):h(!0)}):h(!1)})};d("XC_FNC=GetStates&config=1",b+"/states.json",function(e){e?d("XC_FNC=GetSI",b+"/si.json",function(f){f&&c?c(!0):c&&c(!1)}):c&&c(!1)})}else c&&c(!0)};x.hub.v5.ResetSTData=function(a,b){a.doSTMRequest(53,[],function(c){b&&b()})};
x.hub.v5.RestoreSTData=function(a,b,c){var d=require("fs-extra"),e=require("querystring"),f=function(h){var g=function(k){if(0<k.length){var l=k.pop();l.type&&l.adr?(l=e.stringify(l),a.doSTMCommand("XC_FNC=AddSensor&"+l,function(m){g(k)})):g(k)}else h(!0)};d.existsSync(b+"/states.json")?d.readFile(b+"/states.json",function(k,l){if(k)h(!1);else{k=null;try{k=JSON.parse(l.toString())}catch(m){}k?0<k.length?g(k):h(!0):h(!1)}}):h(!0)};a._stmPort?f(function(h){h?c&&c(!0):c&&c(!1)}):c&&c(!0)};
x.hub.v5.NativeWrapper=function(){this._mconfigPath="../../sbin/mconfig";this._stserPath="../../bin/stser";this._resetPin=236;this._hmPort="/dev/hmip-uart";this._usbMountPath="/media/usb0";this._resetPinState="1";this._getIpCbs=[];this._getIpTiemout=null};
x.hub.v5.NativeWrapper.prototype._execMConfig=function(a,b){var c=require("child_process").exec;a=c(this._mconfigPath+" "+a);var d="";a.stdout.on("data",function(e){e=String(e).trim();e=e.replace(/[\n\r]/g,"");e=e.replace(/\\x00/g,"");d+=e});a.on("error",function(e){b&&b({XC_ERR:{code:"000001",msg:"Error when executing mconfig."}})});a.on("close",function(e){e=null;if(0<d.length)try{e=JSON.parse(d)}catch(f){e={XC_ERR:{code:"000001",msg:f.message},res:String(d)}}b&&b(e)})};
x.hub.v5.NativeWrapper.prototype._exec=function(a,b,c){var d=require("child_process").exec;a=d(a);a.stdout.on("data",function(e){e=String(e).trim();b&&b(e)});a.on("error",function(e){c&&c(e)});a.on("close",function(e){c&&c()})};
x.hub.v5.NativeWrapper.prototype.checkHMSerial=function(a){var b=require("child_process").exec;b=b("eq3configcmd update-coprocessor -p "+this._hmPort+" -c -v -d /srv/hm-root/opt/hm/firmware/");var c="";b.stdout.on("data",function(d){c+=d.trim().replace(/[\n\r]/g,"")});b.stderr.on("data",function(d){c+=d.trim().replace(/[\n\r]/g,"")});b.on("error",function(d){});b.on("close",function(d){-1<c.indexOf("<Info> Version:")&&(c="OK");a&&a(c)})};
x.hub.v5.NativeWrapper.prototype.getIPData=function(a){var b=this._getIpCbs.length;a&&-1==this._getIpCbs.indexOf(a)&&this._getIpCbs.push(a);if(0==b){var c=this;this._getIpTiemout=setTimeout(function(){c._getIpTiemout=null;var d=c._getIpCbs;if(d.length){d=c._getIpCbs;c._getIpCbs=[];for(var e=0;e<d.length;e++)try{d[e]&&d[e]({})}catch(f){}}},5E3);this._execMConfig("config network show",function(d){c._getIpTiemout&&(clearTimeout(c._getIpTiemout),c._getIpTiemout=null);var e=c._getIpCbs;c._getIpCbs=[];
var f={};if(d){for(var h in d){var g=d[h];f[h]=[];for(l=0;l<g.length;l++){var k=g[l];"object"===typeof g[l]&&null!==g[l]&&(k.IPV4&&(k.IP=k.IPV4,delete k.IPV4),k.MAC&&(k.MAC=k.MAC.replace(/:/g,"-")),k.DNS&&Array.isArray(k.DNS)&&k.DNS[0]&&(k.DNS=k.DNS[0]),k.DHCP=k.DHCP&&"TRUE"==k.DHCP,f[h].push(k))}}for(l=0;l<e.length;l++)try{e[l]&&e[l](f)}catch(m){}}else for(var l=0;l<e.length;l++)try{e[l]&&e[l](f)}catch(m){}})}};
x.hub.v5.NativeWrapper.prototype._setNTP=function(a,b){a?this._execMConfig("config network ntp server "+a,function(c){b&&b(!0)}):b&&b(!1)};x.hub.v5.NativeWrapper.prototype.scanWiFi=function(a){this._execMConfig("config network wlan scan",function(b){var c=null,d=[];if(Array.isArray(b))for(var e=0;e<b.length;e++)"string"===typeof b[e].ssid&&0<b[e].ssid.length&&d.push(b[e]);else"string"===typeof b?c=Error(JSON.stringify({XC_ERR:{msg:b}})):b.XC_ERR&&(c=Error(JSON.stringify(b)));a&&a(c,d)})};
x.hub.v5.NativeWrapper.prototype.connectWiFi=function(a,b,c){a='config network wlan connect "'+(String(a).replace(/"/g,'\\"')+'"');a+='"'+String(b).replace(/"/g,'\\"')+'"';var d=this;this._execMConfig(a,function(e){e=e&&"done"==e.status;c&&c(e);setTimeout(function(){d.reboot()},1E3)})};x.hub.v5.NativeWrapper.prototype.resetNetwork=function(a){this._execMConfig("config network reset",function(b){var c=!1;b&&"done"==b.status&&(c=!0);a&&a(c)})};
x.hub.v5.NativeWrapper.prototype.resetHM=function(a){this._execMConfig("system resetHM",function(b){var c=!1;b&&"done"==b.status&&(c=!0);a&&a(c)})};x.hub.v5.NativeWrapper.prototype.resetZway=function(a){this._execMConfig("system resetZWAY",function(b){var c=!1;b&&"done"==b.status&&(c=!0);a&&a(c)})};x.hub.v5.NativeWrapper.prototype.resetZigbee=function(a){this._execMConfig("system resetZigbee",function(b){var c=!1;b&&"done"==b.status&&(c=!0);a&&a(c)})};
x.hub.v5.NativeWrapper.prototype._setIPData=function(a,b){var c=null;1==a.DHCP?c="config network lan dhcp":a.IP&&a.SN&&a.GW&&a.DNS&&(c="config network lan static "+a.IP+" "+a.SN+" "+a.GW+" "+a.DNS);var d=this;this._setNTP(a.NTP,function(){b&&b(!0);c&&d._execMConfig(c,function(e){XC.debugf("setIPData:");XC.debugf(e);setTimeout(function(){d._execMConfig("config network restart eth0",function(f){XC.debugf(f)})},1500)})})};
x.hub.v5.NativeWrapper.prototype._setMAC=function(a,b,c){b.MAC?a.doSTMRequest(57,XC.getBytes(b.MAC,!0),function(d){d||XC.debugf("set st mac error");a.doSTMRequest(58,[],function(e){e&&XC.debugf("new mac: "+e.toString("hex"));c&&(e&&e.toString("hex")==b.MAC.toLowerCase()?c(!0):c(!1))})}):c&&c(!0)};x.hub.v5.NativeWrapper.prototype.setIPData=function(a,b,c){var d=this;this._setMAC(a,b,function(e){e?d._setIPData(b,c):c&&c(!1)})};
x.hub.v5.NativeWrapper.prototype.setWLANData=function(a,b){var c=null;!0===a.DHCP?c="config network wlan dhcp":a.IP&&a.SN&&a.GW&&a.DNS&&(c="config network wlan static ",c+='"'+a.IP+'" "'+a.SN+'" "'+a.GW+'" "'+a.DNS+'"');var d=this;this._setNTP(a.NTP,function(){c?d._execMConfig(c,function(e){b&&b(!0);setTimeout(function(){d._execMConfig("config network restart wlan0",function(f){XC.debugf(f)})},1500)}):b&&b(!0)})};
x.hub.v5.NativeWrapper.prototype.updateFirmware=function(a,b,c,d){var e=require("http"),f=require("fs");f.existsSync("/tmp/firmware_update.iopk")&&f.unlinkSync("/tmp/firmware_update.iopk");var h=f.createWriteStream("/tmp/firmware_update.iopk"),g=this;e.get("http://"+a+":"+b+c,function(k){k&&200==k.statusCode?(k.pipe(h),h.on("finish",function(){h.close(function(){g._execMConfig("system update",function(l){XC.debugf(l);d&&d('{"XC_SUC":{}}')})})}),h.on("error",function(l){f.unlink("/tmp/firmware_update.iopk");
d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):d&&d('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}).on("error",function(k){f.unlink("/tmp/firmware_update.iopk");d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};
x.hub.v5.NativeWrapper.prototype.updateSTFirmware=function(a,b,c,d,e){var f=require("http"),h=require("fs");h.existsSync("/tmp/st.bin")&&h.unlinkSync("/tmp/st.bin");var g=h.createWriteStream("/tmp/st.bin");f.get("http://"+a+":"+b+c,function(k){k&&200==k.statusCode?(k.pipe(g),g.on("finish",function(){g.close(function(){var l=new (require("xnm.aio.m10T.js").STMUpdater)("/tmp/st.bin");l.hostType="A20";var m=0;l.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(n){n.error?(XC.debugf("\r\nfailed to flash ST ("+
n.error+")"),l.resetST(!1),e?e('{"XC_SUC":{}}'):d&&d.send("ERROR.")):100==n.state?(XC.debugf("\r\nflashed ST!"),l.resetST(!1),e?e('{"XC_SUC":{}}'):d&&d.end("100.")):d&&m!=n.state&&(d.write(n.state+"."),m=n.state)})})}),g.on("error",function(l){h.unlink("/tmp/st.bin");e?e('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):d&&d.send("ERROR.")})):e?e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):d&&d.send("ERROR.")}).on("error",function(k){h.unlink("/tmp/st.bin");e?e('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):
d&&d.send("ERROR.")})};
x.hub.v5.NativeWrapper.prototype.updateV5PFirmware=function(a,b,c){var d=this;this._saveFirmware(a,function(e,f){e?(b.end("ERROR.["+e.message+"]"),c&&c(e)):d._splitFirmwareV5PlusFile(f,"/tmp",a.query.filename,function(h,g,k){h?(b.end("ERROR.["+h.message+"]"),c&&c(h)):g&&k?d._updateSTFirmware(k,b,function(l){l?(b.end("ERROR.["+l.message+"]"),c&&c(l)):d._updateA20Firmware(g,function(m){m?(b.end("ERROR.["+m.message+"]"),c&&c(m)):(b.end('{"XC_SUC":{}}',function(){c&&(c(),c=null)}),setTimeout(function(){c&&
(c(),c=null)},5E3))})}):k?d._updateSTFirmware(k,b,function(l){l?(b.end("ERROR.["+l.message+"]"),c&&c(l)):(b.end('{"XC_SUC":{}}',function(){c&&(c(),c=null)}),setTimeout(function(){c&&(c(),c=null)},5E3))}):g&&d._updateA20Firmware(g,function(l){if(l)b.end("ERROR.["+l.message+"]"),c&&c(l);else var m=0,n=setInterval(function(){m++;100>=m?b.write(m+"."):(clearInterval(n),b.end('{"XC_SUC":{}}',function(){c&&(c(),c=null)}),setTimeout(function(){c&&(c(),c=null)},5E3))},10)})})})};
x.hub.v5.NativeWrapper.prototype._saveFirmware=function(a,b){var c=require("fs");require("os");var d=require("path"),e=d.join("/tmp","/firmware_update.v5pfw");c.existsSync(d)&&c.unlinkSync(d);var f=c.createWriteStream(e);a.pipe(f);f.on("finish",function(){f.close(function(){b&&b(null,e)})});f.on("error",function(h){c.unlink(e);b&&b(h)})};
x.hub.v5.NativeWrapper.prototype._splitFirmwareV5PlusFile=function(a,b,c,d){var e=require("fs"),f=require("os"),h=require("path");b=b||f.tmpdir();var g=function(k,l,m,n){k=e.createWriteStream(k);k.on("finish",function(){n&&n(null)});var p=e.createReadStream(a,{flags:"r",start:l,end:m});p.on("error",function(q){n&&n(q);n=null;p.end()});p.pipe(k)};e.readFileLine(a,1,function(k,l){if(k)"string"==typeof k&&(k=Error(k)),d&&d(k,null,null);else{var m=(new (require("xnm.aio.m10T.js").V5Updater)).parseHeader(l);
l=k=!1;if(!m&&(c&&-1!=c.indexOf(".iopk")?k=!0:c&&-1!=c.indexOf(".bin")&&(l=!0),!k&&!l)){k=Error("Could not parse header section of file.");d&&d(k,null,null);return}Date.now();var n=h.join(b,"firmware_update.iopk"),p=h.join(b,"st.bin");if(m){var q=m.offset+m.esp[3],t=q+m.esp[4];g(n,q,t,function(r){q=m.offset+m.st[3];t=q+m.st[4];var u=m.st[2].split(".");r=parseInt(u[0]);u=parseInt(u[1]);1<r||1==r&&1<=u?d&&d(null,n,null):g(p,q,t,function(v){d&&d(null,n,p)})})}else k?d&&d(null,a,null):l?d&&d(null,null,
a):d&&d(Error("invalid firmware data"),null,null)}})};x.hub.v5.NativeWrapper.prototype._updateA20Firmware=function(a,b){var c=global.FIRMWARE_VERSION;console.log("update system "+c);"1.0"!=c.substr(0,3)&&b&&b();var d=this;setTimeout(function(){d._execMConfig("system update",function(e){console.log("update system finish "+c.substr(0,3));"1.0"==c.substr(0,3)&&b&&b()})},1500)};
x.hub.v5.NativeWrapper.prototype._updateSTFirmware=function(a,b,c){var d=new (require("xnm.aio.m10T.js").STMUpdater)(a);d.hostType="A20";var e=0;d.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(f){console.log("!!!!!!!",f?JSON.stringify(f):"null");f.error?(XC.debugf("\r\nfailed to flash ST ("+f.error+")"),d.resetST(!1),b&&b.write("ERROR.["+f.error+"]"),c&&c(Error(f.error))):100==f.state?(XC.debugf("\r\nflashed ST!"),d.resetST(!1),b&&b.write("100."),c&&c()):b&&e!=f.state&&
(b.write(f.state+"."),e=f.state)})};
x.hub.v5.NativeWrapper.prototype.backup=function(a,b){var c=require("fs-extra");c.existsSync("/tmp/firmware_backup.iopk")&&c.removeSync("/tmp/firmware_backup.iopk");var d=this;x.hub.v5.BackupSTData(a,"./data",function(e){e?d._execMConfig("system backup "+(Math.floor(49*Math.random())+1),function(f){f&&"done"==f.status&&c.existsSync("/tmp/firmware_backup.iopk")?(f=(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,""),b.setHeader("Content-disposition","attachment; filename=backup_"+
f+".iopk"),b.sendFile("/tmp/firmware_backup.iopk",null,function(h){c.removeSync("./data/states.json");c.removeSync("./data/si.json");c.removeSync("/tmp/firmware_backup.iopk");h&&b.status(500).end()})):b.status(500).end()}):b.status(500).end()})};
x.hub.v5.NativeWrapper.prototype.restore=function(a,b,c){var d=require("fs-extra");d.existsSync("/tmp/firmware_backup.iopk")&&d.removeSync("/tmp/firmware_backup.iopk");var e=this;x.hub.v5.DownloadFile("/tmp/firmware_backup.iopk",b,function(f){f&&d.existsSync("/tmp/firmware_backup.iopk")?e._execMConfig("system restore",function(h){h&&"done"==h.status?x.hub.v5.RestoreSTData(a,"./data",function(g){g?(d.removeSync("/tmp/firmware_backup.iopk"),c&&c('{"XC_SUC":{}}')):c&&c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):
c&&c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):c&&c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};x.hub.v5.NativeWrapper.prototype.reboot=function(){this._execMConfig("system reboot",function(a){})};
x.hub.v5.NativeWrapper.prototype._checkResetPin=function(a,b,c){0==a.readSync()&&(a=Date.now()-this._resetPinPressBegin,8E3<a?(this._resetPinPressBegin=Date.now(),this._resetMode="reboot",b&&b.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000")):6E3<a?(this._resetMode="factory",b&&b.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0003")):4E3<a?(this._resetMode="passwords",b&&b.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0004")):2E3<a&&(this._resetMode="network",b&&b.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0001")))};
x.hub.v5.NativeWrapper.prototype.watchResetPin=function(a,b){var c=require("onoff").Gpio,d=new c(this._resetPin,"in","both");d.unexport();d=new c(this._resetPin,"in","both");var e=this,f=null;d.watch(function(h,g){f&&(clearInterval(f),f=null);a&&a.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000");0==g?(e._resetPinPressBegin=Date.now(),e._resetMode=null,f=setInterval(function(){e._checkResetPin(d,a,b)},200)):b&&b(e._resetMode)})};
x.hub.v5.NativeWrapper.prototype.checkResetPin=function(){return(new (require("onoff").Gpio)(this._resetPin,"in","both")).readSync()};
x.hub.v5.NativeWrapper.prototype.mountUSB=function(a){var b=a,c=setTimeout(function(){b&&b(Error("execute setUSBmount start timeout"));b=null},2E4),d=this;a=require("child_process").exec;a=a("../../sbin/setUSBmount start");var e="",f="";a.stdout.on("data",function(h){e+=h;XC.debugf("setUSBmount start: "+e)});a.stderr.on("data",function(h){f+=h;XC.debugf("setUSBmount start error: "+f)});a.on("error",function(h){c&&(clearTimeout(c),c=null);b&&b(Error("execute setUSBmount start error"));b=null});a.on("close",
function(h){XC.debugf("exec close");XC.debugf("setUSBmount start: "+e);c&&(clearTimeout(c),c=null);if(f){f=f.replace("/dev/sda","");f=f.replace("on","");f=f.replace("/media/usb0","");var g=Error(f)}b&&b(g,d._usbMountPath);b=null})};
x.hub.v5.NativeWrapper.prototype.unmountUSB=function(a){var b=a,c=setTimeout(function(){b&&b(Error("execute setUSBmount stop timeout"));b=null},2E4);a=require("child_process").exec;a=a("../../sbin/setUSBmount stop");var d="";a.stdout.on("data",function(e){});a.stderr.on("data",function(e){d+=e;XC.debugf("setUSBmount stop error: "+d)});a.on("error",function(e){c&&(clearTimeout(c),c=null);b&&b(Error("execute setUSBmount stop error"));b=null});a.on("close",function(e){if(d){d=d.replace("/dev/sda","");
d=d.replace("on","");d=d.replace("/media/usb0","");var f=Error(d)}b&&b(f);b=null})};x.hub.v5.NativeWrapper.prototype.setDateTime=function(a,b,c,d,e,f){b+="";2>b.length&&(b="0"+b);c+="";2>c.length&&(c="0"+c);d+="";2>d.length&&(d="0"+d);e+="";2>e.length&&(e="0"+e);a=b+c+d+e+a;console.log("set system time:"+a);this._execMConfig("system set time "+a,function(h){console.log("set system time finish",h);f&&f(!0)})};x.hub.v5.NativeWrapper.prototype.runMdev=function(a){this._exec("mdev -s",null,a)};
x.hub.v5.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.Handler");this._usbPath=this._pk=this._serial=this.server=null};
x.hub.v5.Handler.prototype.setRGBColor=function(a){if(this.server&&"A20"==this.server.hostType)this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=00"+a);else{var b=parseInt(a,16);b&16711680&&(b|=1048576);b&65280&&(b|=4096);b&255&&(b|=16);try{var c=require("rpi-ws281x-native/lib/ws281x-native");c&&(c.init(1),c.render([b]),setTimeout(function(){c.render([b])},100))}catch(d){}}};
x.hub.v5.Handler.prototype.getPublicKey=function(a){x.hub.v5.getPrivateKey(function(b){b=require("x.crypt.js").Curve25519.curve25519(b);for(var c="",d=0;d<b.length;d++)c+=XC.getHexVal(b[d],2);c=c.toLowerCase();a(c)})};
x.hub.v5.Handler.prototype.backup=function(a,b,c){var d=require("fs"),e=require("fs-extra");d.existsSync("/tmp/backup")&&d.rmdirRecursiveSync("/tmp/backup");d.mkdirSync("/tmp/backup");this._backup(a,"/tmp/backup",c,function(f,h,g){f?b.status(500).end():(b.setHeader("Content-disposition","attachment; filename="+g),b.sendFile(h,null,function(k){e.removeSync("/tmp/backup");e.removeSync(h);k&&b.status(500).end()}))})};
x.hub.v5.Handler.prototype.restore=function(a,b,c,d){var e=require("fs");require("fs-extra");var f=this;x.hub.v5.DownloadFile("/tmp/restore.zip",b,function(h){h?(e.existsSync("/tmp/restore/")&&e.rmdirRecursiveSync("/tmp/restore/"),f._extractBackupZip("/tmp/restore.zip","/tmp/restore/",c,function(g){g?d&&d('{"XC_ERR":{"msg":"'+g.message+'"}}'):e.existsSync("/tmp/restore/backup")?f._restore(a,"/tmp/restore/","backup",function(k){k?d&&d('{"XC_ERR":{"code":"000000", "msg":"'+k.message+'"}}'):d('{"XC_SUC":{}}')}):
d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};x.hub.v5.Handler.prototype.mountUSB=function(a){var b=this;this.Native.mountUSB(function(c,d){c?a&&a({error:c}):b.setBackupUsbPath(d,a)})};x.hub.v5.Handler.prototype.unmountUSB=function(a){try{require("fs-extra").remove("./backup_local")}catch(b){}this._usbPath=null;this.Native.unmountUSB(function(b){a&&a({error:b})})};
x.hub.v5.Handler.prototype.setBackupUsbPath=function(a,b){this._usbPath=a;var c=require("fs-extra");c.existsSync("./backup_local")?c.emptyDirSync("./backup_local"):c.ensureDirSync("./backup_local");c.existsSync(a)||c.ensureDirSync(a);b&&b({})};x.hub.v5.Handler.prototype.saveDeviceXMLforBackup=function(a,b){require("fs-extra").writeFile("./backup_local/devices.xml",a,function(c){b&&b({error:c})})};
x.hub.v5.Handler.prototype.saveMacrosXMLforBackup=function(a,b){require("fs-extra").writeFile("./backup_local/macros.xml",a,function(c){b&&b({error:c})})};x.hub.v5.Handler.prototype.saveIrcodesXMLforBackup=function(a,b){require("fs-extra").writeFile("./backup_local/ircodes.xml",a,function(c){b&&b({error:c})})};
x.hub.v5.Handler.prototype.backupLocal=function(a,b,c){if(this._usbPath){var d=require("fs-extra"),e=this;this._backup(a,"./backup_local",b,function(f,h,g){d.emptyDir("./backup_local");f?c&&c({error:f}):d.move(h,e._usbPath+"/"+g,{overwrite:!0},function(k){c&&c({error:k,data:g})})})}else c&&c({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.listUsbBackups=function(a){this._usbPath?require("fs-extra").readdir(this._usbPath,function(b,c){if(b)a&&a({error:b});else{b=[];for(var d=0;d<c.length;d++){var e=c[d],f=e.indexOf(".xbp");if(-1!=f){var h={filename:c[d],time:null},g=e.substr(0,f);"backup_"==g.substr(0,7)&&(g=g.substr(7));e=g.substr(0,4);f=g.substr(4,2);var k=g.substr(6,2),l=g.substr(8,2),m=g.substr(10,2);g=g.substr(12,2);h.time=e+"-"+f+"-"+k+" "+l+":"+m+":"+g;b.push(h)}}a&&a({data:b})}}):a&&a({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.deleteBackup=function(a,b){this._usbPath?require("fs-extra").remove(this._usbPath+"/"+a,function(c){b&&b({error:c})}):b&&b({error:Error("please mount the usb storage")})};
x.hub.v5.Handler.prototype.loadBackup=function(a,b,c){if(this._usbPath){var d=require("fs-extra"),e=this;d.ensureDirSync("./restore_local/");d.emptyDirSync("./restore_local/");d.copy(this._usbPath+"/"+a,"./"+a,function(f){f?c&&c({error:f}):e._extractBackupZip("./"+a,"./restore_local/",b,function(h){c&&c({error:h})})})}else c&&c({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.loadDeviceXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/devices.xml",{encoding:"utf8"},function(b,c){a&&a({error:b,data:c})})};x.hub.v5.Handler.prototype.loadMacroXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/macros.xml",{encoding:"utf8"},function(b,c){a&&a({error:b,data:c})})};
x.hub.v5.Handler.prototype.loadIrcodesXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/ircodes.xml",{encoding:"utf8"},function(b,c){a&&a({error:b,data:c})})};x.hub.v5.Handler.prototype.restoreLocal=function(a,b){this._restore(a,"./restore_local/","backup_local",function(c){b&&b({error:c})})};
x.hub.v5.Handler.prototype.testReadOnly=function(a){var b=require("fs-extra"),c="./read_only_test_"+(new Date).getTime();b.ensureFile(c,function(d){d?a&&a(d):b.remove(c,function(e){a&&a(e)})})};x.hub.v5.Handler.prototype.fixReadOnly=function(a,b){a.writeHead(200,{"Content-Type":"text/plain"});this.Native._exec("/etc/init.d/S99_checkfs manual",function(c){a.write(c)},function(c){c?a.write('{"XC_ERR":{"code":"01001", "message":"'+c.message+'"}}'):a.write('{"XC_SUC":{}}');a.end()})};
x.hub.v5.Handler.prototype._backup=function(a,b,c,d){var e=this;x.hub.v5.BackupSTData(a,b,function(f){if(f){var h=require("fs-extra");h.copySync("./data",b+"/data");h.existsSync(b+"/data/localstorage/x.hub.Server.pwd")&&h.removeSync(b+"/data/localstorage/x.hub.Server.pwd");h.existsSync("/srv/hm-root/opt/hm/etc/config")&&h.copySync("/srv/hm-root/opt/hm/etc/config",b+"/config");h.existsSync("/srv/z-way-server/config")&&h.copySync("/srv/z-way-server/config",b+"/zway/config");h.existsSync("/srv/z-way-server/automation/storage")&&
h.copySync("/srv/z-way-server/automation/storage",b+"/zway/automation/storage");h.existsSync("/srv/Apps/zigbee/SYSTEM/data")&&h.copySync("/srv/Apps/zigbee/SYSTEM/data",b+"/zigbee/data");f=require("archiver");var g=new Date,k=g.getFullYear()+"",l=g.getMonth()+1+"";1==l.length&&(l="0"+l);var m=g.getDate()+"";1==m.length&&(m="0"+m);var n=g.getHours()+"";1==n.length&&(n="0"+n);var p=g.getMinutes()+"";1==p.length&&(p="0"+p);g=g.getSeconds()+"";1==g.length&&(g="0"+g);var q="backup_"+(k+l+m+n+p+g)+".xbp",
t="/tmp/"+q;k=h.createWriteStream(t);f=f("zip");k.on("close",function(){if(c){var r=require("crypto").createCipher("aes-256-cbc",c),u=h.createReadStream(t),v=h.createWriteStream(t+".enc");v.on("finish",function(){h.removeSync(t);d&&d(null,t+".enc",q)});u.pipe(r).pipe(v)}else d&&d(null,t,q)});k.on("error",function(r){e._logger.log("warn","write backup zip file failed:"+r.message);d&&d(r);d=null});f.on("error",function(r){e._logger.log("warn","zip backup data failed:"+r.message);d&&d(r);d=null});f.pipe(k);
f.directory(b+"/","backup");f.finalize()}else e._logger.log("warn","backup st data failed"),d&&d(Error("backup st data failed")),d=null})};
x.hub.v5.Handler.prototype._extractBackupZip=function(a,b,c,d){var e=require("fs"),f=require("fs-extra"),h=require("adm-zip"),g=null;try{(new h(a)).extractAllTo(b,!0)}catch(l){g="invalid backup file/password"}if(g)if(c){c=require("crypto").createDecipher("aes-256-cbc",c);var k=e.createReadStream(a);e=e.createWriteStream(a+".dec.zip");c.on("error",function(){f.removeSync(a);f.removeSync(a+".dec.zip");d&&d(Error(g))});e.on("finish",function(){g=null;try{(new h(a+".dec.zip")).extractAllTo(b,!0)}catch(l){g=
"invalid backup file/password"}f.removeSync(a);f.removeSync(a+".dec.zip");d&&d(g?Error(g):null)});k.pipe(c).pipe(e)}else f.removeSync(a),d&&d(Error(g)),d=null;else f.removeSync(a),d&&d(),d=null};
x.hub.v5.Handler.prototype._restore=function(a,b,c,d){var e=require("fs"),f=require("fs-extra"),h=b+c;if(e.existsSync(h+"/zigbee/data"))try{f.ensureDirSync("/srv/Apps/zigbee/SYSTEM"),f.copySync(h+"/zigbee/data","/srv/Apps/zigbee/SYSTEM/data")}catch(g){}if(e.existsSync(h+"/zway/config")&&e.existsSync("/srv/z-way-server"))try{f.copySync(h+"/zway/config","/srv/z-way-server/config")}catch(g){}if(e.existsSync(h+"/zway/automation/storage")&&e.existsSync("/srv/z-way-server/automation"))try{f.copySync(h+
"/zway/automation/storage","/srv/z-way-server/automation/storage")}catch(g){}this._restoreHM(h,function(){x.hub.v5.RestoreSTData(a,h,function(g){g?f.copy(h+"/data","./data",function(k){f.removeSync(b);k&&d?d(Error("internal error")):d&&d()}):d&&d(Error("internal error"))})})};
x.hub.v5.Handler.prototype._restoreHM=function(a,b){function c(h){h=f.extname(h);return".ap"===h||".apkx"===h}var d=require("fs"),e=require("fs-extra"),f=require("path");d.existsSync(a+"/config")&&d.existsSync("/srv/hm-root/opt/hm/etc")?this.Native.resetHM(function(h){XC.debugf("reset HM:"+h);try{e.copySync(a+"/config","/srv/hm-root/opt/hm/etc/config");var g=[];d.readdirSync("/srv/hm-root/opt/hm/etc/config/crRFD/data").filter(c).forEach(function(k){g.push(k)});for(h=0;h<g.length;h++);}catch(k){console.error(k)}b&&
b()}):b&&b()};x.hub.v5.Handler.prototype.getSerialPorts=function(a){var b=null;try{b=require("serialport")}catch(c){b=null}b?this.Native.runMdev(function(c){console.log("run mdev finish",c);c?a(JSON.stringify({XC_ERR:{code:"00000",msg:"run mdev error:"+c.message}})):b.list(function(d,e){console.log("list serial port finish",d,JSON.stringify(e));void 0==e&&(e=[]);d=[];for(var f=0;f<e.length;f++)e[f]&&d.push(e[f].comName);a('{"XC_SUC":'+JSON.stringify(d)+"}")})}):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')};
x.hub.v5.Handler.prototype.getLogs=function(a){var b=require("fs-extra"),c=require("archiver"),d="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",e="/tmp/"+d,f=b.createWriteStream(e);c=c("zip");f.on("close",function(){a.setHeader("Content-disposition","attachment; filename="+d);a.sendFile(e,null,function(h){b.removeSync(e);h&&a.status(500).end()})});f.on("error",function(h){a.status(500).end()});c.on("error",function(h){a.status(500).end()});
c.pipe(f);c.directory("/var/log");c.finalize()};
x.hub.v5.Handler.prototype.getNeoServerLogs=function(a){var b=require("path"),c=require("x.hub.fileman.js").fileManager,d=c.getUserRootDataPath(),e=b.dirname(c.getLogFile()),f=c.getTmpDir(),h=require("fs-extra");c=require("archiver");var g="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",k=f+b.sep+g;b=h.createWriteStream(k);c=c("zip");b.on("close",function(){a.setHeader("Content-disposition","attachment; filename="+g);a.sendFile(k,null,function(l){h.removeSync(k);
l&&a.status(500).end()})});b.on("error",function(l){a.status(500).end()});c.on("error",function(l){a.status(500).end()});c.pipe(b);c.directory(d);c.directory(e);c.finalize()};x.hub.v5.Handler.prototype.clearLogs=function(a){require("fs-extra").emptyDir("/var/log",function(b){a&&a()})};
x.hub.v5.Handler.prototype.reset=function(a,b,c){var d=require("fs"),e=require("fs-extra");"passwords"==b?(d.existsSync("./data/localstorage/x.hub.Server.pwd")&&e.removeSync("./data/localstorage/x.hub.Server.pwd"),c&&c()):"factory"==b?(d.existsSync("./data")&&e.emptyDirSync("./data"),x.hub.v5.ResetSTData(a,function(){c&&c()})):c&&c()};
x.hub.v5.Handler.prototype.resetST=function(a){this._logger.log("info","reset st");this._logger.log("trace","set st led to permant white");var b=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(c){c&&c.XC_SUC?(b._logger.log("trace","reset st data"),x.hub.v5.ResetSTData(b.server,function(){b._logger.log("trace","reboot st");var d=new (require("xnm.aio.m10T.js").STMUpdater);d.hostType=b.server.hostType;d.resetST();b._logger.log("info","reset st finish");a&&a()})):(c=c&&c.XC_ERR?
Error(c.XC_ERR):Error("set led white failed"),b._logger.log("trace","set led white error:"+c.message),a&&a(c))})};
x.hub.v5.Handler.prototype.rebootST=function(a){this._logger.log("info","reboot st");this._logger.log("trace","set st led to permant white");var b=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(c){c&&c.XC_SUC?(b._logger.log("trace","now reboot st"),c=new (require("xnm.aio.m10T.js").STMUpdater),c.hostType=b.server.hostType,c.resetST(),b._logger.log("info","reboot st finish"),a&&a()):(c=c&&c.XC_ERR?Error(c.XC_ERR):Error("set led white failed"),b._logger.log("trace","set led white error:"+
c.message),a&&a(c))})};x.hub.v5.Handler.prototype.USBSerial=x.hub.v5.USBSerial;x.hub.v5.Handler.prototype.CloudConnect=x.hub.v5.CloudConnect;x.hub.v5.Handler.prototype.LocalSPIBus=x.hub.v5.LocalSPIBus;x.hub.v5.Handler.prototype.Native=new x.hub.v5.NativeWrapper;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v5.Handler);
