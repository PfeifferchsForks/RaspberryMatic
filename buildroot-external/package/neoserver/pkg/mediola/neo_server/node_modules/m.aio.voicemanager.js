var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.atMethod=function(l){l=Math.trunc(l)||0;0>l&&(l+=this.length);if(!(0>l||l>=this.length))return this[l]};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(l,c,b){if(l==Array.prototype||l==Object.prototype)return l;l[c]=b.value;return l};$jscomp.getGlobal=function(l){l=["object"==typeof globalThis&&globalThis,l,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<l.length;++c){var b=l[c];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(l,c){var b=$jscomp.propertyToPolyfillSymbol[c];if(null==b)return l[c];b=l[b];return void 0!==b?b:l[c]};
$jscomp.polyfill=function(l,c,b,a){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(l,c,b,a):$jscomp.polyfillUnisolated(l,c,b,a))};$jscomp.polyfillUnisolated=function(l,c,b,a){b=$jscomp.global;l=l.split(".");for(a=0;a<l.length-1;a++){var e=l[a];if(!(e in b))return;b=b[e]}l=l[l.length-1];a=b[l];c=c(a);c!=a&&null!=c&&$jscomp.defineProperty(b,l,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(l,c,b,a){var e=l.split(".");l=1===e.length;a=e[0];a=!l&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var d=0;d<e.length-1;d++){var g=e[d];if(!(g in a))return;a=a[g]}e=e[e.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?a[e]:null;c=c(b);null!=c&&(l?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:c}):c!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+b+"$"+e),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("Array.prototype.at",function(l){return l?l:$jscomp.atMethod},"es_next","es5");$jscomp.typedArrayAt=function(l){return l?l:$jscomp.atMethod};$jscomp.polyfill("Int8Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Uint8Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");
$jscomp.polyfill("Uint8ClampedArray.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Int16Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Uint16Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Int32Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Uint32Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("Float32Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");
$jscomp.polyfill("Float64Array.prototype.at",$jscomp.typedArrayAt,"es_next","es5");$jscomp.polyfill("String.prototype.at",function(l){return l?l:$jscomp.atMethod},"es_next","es5");$jscomp.arrayIteratorImpl=function(l){var c=0;return function(){return c<l.length?{done:!1,value:l[c++]}:{done:!0}}};$jscomp.arrayIterator=function(l){return{next:$jscomp.arrayIteratorImpl(l)}};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(l){if(l)return l;var c=function(d,g){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};c.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",a=0,e=function(d){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new c(b+(d||"")+"_"+a++,d)};return e},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(l){if(l)return l;l=Symbol("Symbol.iterator");for(var c="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<c.length;b++){var a=$jscomp.global[c[b]];"function"===typeof a&&"function"!=typeof a.prototype[l]&&$jscomp.defineProperty(a.prototype,l,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return l},"es6",
"es3");$jscomp.iteratorPrototype=function(l){l={next:l};l[Symbol.iterator]=function(){return this};return l};$jscomp.iteratorFromArray=function(l,c){l instanceof String&&(l+="");var b=0,a=!1,e={next:function(){if(!a&&b<l.length){var d=b++;return{value:c(d,l[d]),done:!1}}a=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(l){return l?l:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");
$jscomp.owns=function(l,c){return Object.prototype.hasOwnProperty.call(l,c)};$jscomp.polyfill("Object.values",function(l){return l?l:function(c){var b=[],a;for(a in c)$jscomp.owns(c,a)&&b.push(c[a]);return b}},"es8","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.Util={clearHttpOptionForLog:function(l){try{var c=JSON.parse(JSON.stringify(l));c.auth&&(c.auth="xxxxxx:xxxxxx");if(c.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var a=headers[b];if(a){var e=a.indexOf(" ");headers[b]=-1==e?"xxxxxx":a.substr(0,e)+" xxxxxx"}}return c}catch(d){return l}}};
m.aio.voicemanager.CloudConfigHandler=function(){var l=function(b,a){this._devicemanager=b;this._macromanager=a};l.prototype._getCloudDeviceConfig=function(b,a,e){var d=null;if(a){var g=require("xnm.aio.cloudservice.js").resolveGateway(a);g?this._getCloudDevicesFromDB(b,g,function(k,h){k?e&&e(k):h&&0!=h.length?(k=h.map(function(f){f=f.info;delete f.gateway;delete f.commands;delete f.states;return f}),g.toCloudDevice(k,function(f,n){if(f)f.code=40003,e&&e(f);else if(n&&0!=n.length){f={};for(var q=
0;q<h.length;q++){var p=h[q];if(p)for(var r=0;r<n.length;r++){var t=n[r];t&&(t.data&&p.info.module==t.data.mod&&p.info.connection==t.data.connection&&p.info.id==t.data.id?(t.name=p.__cloudref,f[p.__cloudref]=t):p.info.module==t.mod&&p.info.connection==t.connection&&p.info.id==t.id&&(t.name=p.__cloudref,t.data={mod:t.mod,connection:t.connection,id:t.id},delete t.mod,delete t.connection,delete t.id,f[p.__cloudref]=t))}}e&&e(null,f)}else e&&e(null,{})})):e&&e(null,{})}):(d=Error("cloud json invalid"),
d.code=4E4,e&&e(d))}else d=Error("cloud json invalid"),d.code=4E4,e&&e(d)};l.prototype._mergeConfig=function(b,a){var e={},d;if(b)for(d in b)e[d]=b[d];if(a)for(d in a)e[d]=a[d];return e};l.prototype._getCloudDevicesFromDB=function(b,a,e){var d=function(f,n){for(var q=0;q<n.length;q++){var p=n[q];if(p&&p.index==f)return p}return null},g=this,k=require("xnm.aio.cloudservice.js"),h={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",b,"device",h,function(f,
n){f?(f.code=40001,e&&e(f)):n&&0!=n.length?(h={filter:"prop","info.sys":"cloudservice"},g._devicemanager.execute("read",b,"gateway",h,function(q,p){q?(q.code=40001,e&&e(q)):p&&0!=p.length?g._devicemanager.execute("read",b,"room",null,function(r,t){if(r)r.code=40001,e&&e(r);else if(t&&0!=t.length){r=[];for(var u=0;u<n.length;u++){var v=n[u];if(v&&v.info&&v.info.gateway){var w=d(v.info.gateway,p);if(w&&w.info&&(w=k.resolveGateway(w.info))){if(!w.equalsTo(a)){r=Error("cloud device "+v.index+" belongs to another account");
r.code=40002;e&&e(r);return}var y=d(v.room,t);y&&(w=v.name,y=y.name,w=(y?y+" ":"")+(w?w:""),v.cloud.alias&&(w=v.cloud.alias),v=JSON.parse(JSON.stringify(v)),v.__cloudref=w,r.push(v))}}}e&&e(null,r)}else e&&e(null,[])}):e&&e(null,[])})):e&&e(null,[])})};l.prototype._getCloudEnabledDevices=function(b,a){this._devicemanager.execute("read",b,"device",{filter:"prop","cloud.enabled":!0},function(e,d){a&&a(e,d)})};l.prototype._getGateways=function(b,a){this._devicemanager.execute("read",b,"gateway",null,
function(e,d){a&&a(e,d)})};l.prototype._getRooms=function(b,a){this._devicemanager.execute("read",b,"room",null,function(e,d){a&&a(e,d)})};l.prototype._getGatewayInfo=function(b,a){if(b)if("aio"!=b.sys&&"neoserver"!=b.sys)a&&a(Error("gateway type invalid"));else{var e=this,d=require("xnm.aio.gateway.js");if("neoserver"==b.sys){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.version="EA";var g=d.resolveGateway(b,!0)}else g=d.resolveGateway(b);g?d.Admin.getGatewaySID(g,function(k,h){k?(e._logger.log("warn",
"get gateway sid error:"+k.message),k.code="50001",k.message="get gateway sid error:"+k.message,a&&a(k)):h?b.password?d.Admin.V5.getInfo(g,function(f,n){f?(e._logger.log("warn","get gateway info error:"+f.message),f.message="get gateway info error:"+f.message,f.code="50101",a&&a(f)):n&&n.server?!n.cfg||parseInt(n.cfg,16)&64?(e._logger.log("warn","gateway cloud server is deactivated"),f=Error("gateway cloud server is deactivated"),f.code="50103",a&&a(f)):e._getAccessToken(n.server,h,b.password,!1,
function(q,p){q?(q=Error("get accesss token error:"+q.message),q.code="50003",a&&a(q)):p?a&&a(null,p,n.server,h):e._getAccessToken(n.server,h,b.password,!0,function(r,t){r?(r=Error("generate accesss token error:"+r.message),r.code="50004",a&&a(r)):t?a&&a(null,t,n.server,h):a&&a(Error("access token empty"))})}):(e._logger.log("warn","gateway has no cloud server"),f=Error("gateway has no cloud server"),f.code="50102",a&&a(f))}):(k=Error("gateway has no password"),k.code="50002",a&&a(k)):(k=Error("gateway has no sid"),
k.code="50002",a&&a(k))}):a&&a(Error("gateway json invalid"))}else a&&a(Error("gateway json is null"))};l.prototype._getAccessToken=function(b,a,e,d,g){b=this._parseCCS(b);var k=b.port;"https"==b.protocol&&80==k&&(k=443);a={host:b.host,port:k,path:"/getAccessToken?sid="+a,method:"GET",timeout:3E4,auth:"user:"+e,user:"user",password:e,headers:{Authorization:"Basic "+(new Buffer("user:"+e)).toString("base64")}};d&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(a)));
var h=this,f=require(b.protocol).request(a,function(n){n.setEncoding("utf8");var q="";n.on("data",function(p){q+=p});n.on("end",function(){if(200==n.statusCode){h._logger.log("trace","get access token reponse:"+q);try{var p=JSON.parse(q);p.XC_ERR?g&&g(Error(p.XC_ERR.msg)):p.XC_SUC?g&&g(null,p.XC_SUC.at):g&&g(Error("invalid response"))}catch(r){g&&g(r)}}else h._logger.log("warn","get access token error +"+n.statusCode+":"+q),g&&g(Error("http response:"+n.statusCode))})});if(f.on)f.on("error",function(n){h._logger.log("warn",
"get access token error:"+n.message);g&&g(n);g=null});f.setTimeout&&f.setTimeout(5E3,function(){f.abort();h._logger.log("warn","get access token timeout");g&&g(Error("http timeout"));g=null});f.end()};l.prototype._parseCCS=function(b){var a=b.indexOf(":");if(-1==a)return{protocol:"https",host:b,port:443};var e=b.substr(0,a);b=b.substr(a+1);8080==b?b=8443:80==b&&(b=443);return{protocol:"https",host:e,port:b}};var c=function(b,a){l.call(this,b,a);this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler");
this._targetGatewayJSON=null;this._gatewayDetail={};this._currentMacroGatewayIndex=this._tenantIdx=null};c.prototype=new l;c.prototype.constructor=c;c.prototype.setTargetGateway=function(b){this._targetGatewayJSON=b};c.prototype.exportConfig=function(b,a,e){var d=this;this._gatewayDetail={};this._tenantIdx=b;this._currentMacroGatewayIndex=null;this._getCloudDeviceConfig(b,a,function(g,k){g?e&&e(g):d._getGatewayDeviceConfig(b,function(h,f){h?e&&e(h):d._getMacrosConfig(b,function(n,q){n?e&&e(n):(n=
d._mergeConfig(k,f),n=d._mergeConfig(q,n),e&&e(null,n))})})})};c.prototype._isSameAsTargetGateway=function(b){return this._targetGatewayJSON?b.ip==this._targetGatewayJSON.ip&&b.sid==this._targetGatewayJSON.sid:!1};c.prototype._getGatewayDeviceConfig=function(b,a){var e=function(g,k){if(!k||0==k.length)return null;for(var h=k.length;h--;){var f=k[h];if(f&&f.index==g)return f}return null},d=this;this._getDevicesDetail(b,function(g,k){if(g)a&&a(g);else{var h=k.devices,f=k.gateways,n=k.rooms,q={};for(g=
0;g<f.length;g++)(k=f[g])&&k.info&&"aio"==k.info.sys&&k.info.version&&!("C"!=k.info.version.charAt(0)&&"E"!=k.info.version.charAt(0)||"EA"==k.info.version||d._targetGatewayJSON&&!d._isSameAsTargetGateway(k.info))&&(q[k.index]=k);0==Object.keys(q)?a&&a(null,{}):d._getGatewaysDetail(Object.values(q),function(p){if(p)a&&a(p);else if(h&&0!=h.length){for(var r=[],t=0;t<h.length;t++)if((p=h[t])&&p.info&&"aio"==p.info.sys&&p.info.gateway){var u=e(p.info.gateway,f);if(u&&q[p.info.gateway]){var v=e(p.room,
n);r.push({device:p,gateway:u,room:v})}}if(0==r.length)a&&a(null,{});else{var w={};t=0;var y=function(z,x){!z&&x&&(w=d._mergeConfig(w,x));t++;t<r.length?d._genDeviceConfig(r[t].device,r[t].gateway,r[t].room,y):a&&a(null,w)};d._genDeviceConfig(r[t].device,r[t].gateway,r[t].room,y)}}else a&&a(null,{})})}})};c.prototype._genDeviceConfig=function(b,a,e,d){if(b&&b.info&&b.info.sys)if(a&&a.index){var g=this._gatewayDetail[a.index];if(g){var k=b.info.sys,h=this._devicemanager.getModule(k);h&&h.devicemanager&&
h.devicemanager.toGeneralDevice?(k=h.devicemanager.toGeneralDevice(b.info,null,"v5"))?(k.name=this._genDeviceName(b,e),k.local="http://"+a.info.ip+(a.info.port?":"+a.info.port:""),k.baseurl=this._genBaseUrl(g),k.data||(k.data={}),k.data.sid=g.sid,b={},b[k.name]=k,d&&d(null,b)):d&&d(null,null):d&&d(Error("sys "+k+" can not be convert to general device"))}else d&&d(Error("no gateway detail info"))}else d&&d(Error("invalid gateway json"));else d&&d(Error("invalid device json"))};c.prototype._genDeviceName=
function(b,a){if(b.cloud&&b.cloud.alias)return b.cloud.alias;b=b.name;a=a.name;return b?a?a+" "+b:b:a};c.prototype._genBaseUrl=function(b){var a=this._parseCCS(b.ccs);return a.protocol+"://"+a.host+"/rapi/"+b.token};c.prototype._getDevicesDetail=function(b,a){var e=this;this._getCloudEnabledDevices(b,function(d,g){d?a&&a(d):e._getGateways(b,function(k,h){k?a&&a(k):e._getRooms(b,function(f,n){a&&a(f,{devices:g,gateways:h,rooms:n})})})})};c.prototype._getGatewaysDetail=function(b,a){var e=this,d=0,
g=function(k,h,f,n){k?a&&a(k):(e._gatewayDetail[b[d].index]={sid:n,ccs:f,token:h},d++,d<b.length?e._getGatewayInfo(b[d].info,g):a&&a())};e._getGatewayInfo(b[d].info,g)};c.prototype._getMacrosConfig=function(b,a){var e=this;this._macromanager.execute(b,"read",null,null,null,function(d,g){if(d)a&&a(d);else if(g&&g.groups&&0!=g.groups.length){var k={};for(d=0;d<g.groups.length;d++){var h=g.groups[d];if(h&&h.macros&&0<h.macros.length){var f=0,n=function(q,p,r){!q&&p&&r&&(k[p]=r);f++;f<h.macros.length&&
e._getMacroConfig(h,h.macros[f],n)};e._getMacroConfig(h,h.macros[f],n)}}a&&a(null,k)}else a&&a(null,{})})};c.prototype._getMacroConfig=function(b,a,e){if(a&&a.cloud&&a.cloud.enabled){var d=b.name+" "+a.name;a.cloud.alias&&(d=a.cloud.alias);var g={name:d,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var k=this;if(a.commands&&0<a.commands.length){var h=0,f=function(n,q,p){!n&&q&&g.commands.on.data.push(q);h++;h<a.commands.length?k._convertMacroCommand(a.commands[h],
f):(n=k._gatewayDetail[k._currentMacroGatewayIndex])?(g.commands.on.url=k._genBaseUrl(n)+"/macro",e&&e(null,d,g)):e&&e(Error("no main gateway"))};this._convertMacroCommand(a.commands[h],f)}}else e&&e(null,null,null)};c.prototype._convertMacroCommand=function(b,a){if(b&&b.classid)switch(b.classid){case "sleep":a(null,{P:b.time});break;case "command":if(!b.action||!b.action.device){a(Error("invalid macro device command"));break}this._convertMacroDeviceCommand(b,a);break;default:a(Error("unknown macro command"))}else a(Error("invalid macro command"))};
c.prototype._convertMacroDeviceCommand=function(b,a){var e=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:b.action.device.index},function(d,g){if(d)a(d);else if(g&&0!=g.length){var k=g[0];k&&k.info&&k.info.sys?"aio"==k.info.sys?e._devicemanager.execute("read",e._tenantIdx,"gateway",{filter:"prop",index:k.info.gateway},function(h,f){if(h)a(h);else if(f&&0!=f.length)if((h=f[0])&&h.info&&h.index)if(e._gatewayDetail[h.index]&&!e._currentMacroGatewayIndex&&(e._currentMacroGatewayIndex=
h.index),f=require("xnm.aio.gateway.js").devicemanager.getSystem(k.info,h.info)){var n={value:b.action.value,ext:b.action.ext};if(f.buildQuery)if(f=f.buildQuery(h.info,k.info,n)){n={};if("SendGenericCmd"==f.XC_FNC){var q="/cmd?XC_FNC=SendGenericCmd&id="+f.id;if(f.data)for(var p in f.data)q+="&"+p+"="+(null==f.data[p]||void 0==f.data[p]?"":encodeURIComponent(f.data[p]))}else if("/api/command"==f.fnc)q="/api/command?json=",f.data&&(q+=encodeURIComponent(JSON.stringify(f.data)));else for(p in q="/cmd?",
f)q+="&"+p+"="+(null==f[p]||void 0==f[p]?"":encodeURIComponent(f[p]));h.index==e._currentMacroGatewayIndex?n.C=q:n.A={host:h.info.ip,cmd:q};a(null,n)}else a(Error("invalid device command"));else a(Error("system do not support command"))}else a(Error("unknown device type"));else a(Error("invalid gateway json"));else a(Error("no such gateway"))}):a(null,null):a(Error("invalid device json"))}else a(Error("no such device"))})};return{V5:c}}();
m.aio.voicemanager.AlexaHandler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};l.LANG=["en","de"];l.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"set point":["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu",
"manu"],"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};l.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set manu mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort",
"komfort"],"lamella up":["lamella up","lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};l.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off",
"off"],Auf:["up","up"],Ab:["down","down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],
"temperature up":["up","up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off",
"led aus"],"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};l.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};l.HUE_MAP={"color temperature":["color temperature","color temperatur"]};l.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};l.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};l.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};l.AV_MAP={stop:["stop","stop"]};l.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};l.NETATMO_MAP={manu:["value","value"]};l.FIBAROHC_MAP={"set value":["value","value"]};l.REMOTE_SERVER="https://cloud.mediola.com";l.prototype._getAccessToken=
function(c,b,a,e,d){c={host:require("url").parse("https://"+c).hostname,port:443,path:"/getAccessToken?sid="+b,method:"GET",timeout:3E4,auth:"user:"+a,user:"user",password:a,headers:{Authorization:"Basic "+(new Buffer("user:"+a)).toString("base64")}};e&&(c.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(c)));var g=this,k=require("https").request(c,function(h){h.setEncoding("utf8");var f="";h.on("data",function(n){f+=
n});h.on("end",function(){if(200==h.statusCode){g._logger.log("trace","get access token reponse:"+f);try{var n=JSON.parse(f);n.XC_ERR?d&&d(Error(n.XC_ERR.msg)):n.XC_SUC?d&&d(null,n.XC_SUC.at):d&&d(Error("invalid response"))}catch(q){d&&d(q)}}else g._logger.log("warn","get access token error +"+h.statusCode+":"+f),d&&d(Error("http response:"+h.statusCode))})});if(k.on)k.on("error",function(h){g._logger.log("warn","get access token error:"+h.message);d&&d(h);d=null});k.setTimeout&&k.setTimeout(5E3,
function(){k.abort();g._logger.log("warn","get access token timeout");d&&d(Error("http timeout"));d=null});k.end()};l.prototype._processHMCommands=function(c,b,a){return this._processCommandsFromMap(l.HM_MAP,c,b,a)};l.prototype._processAIOCommands=function(c,b,a){return this._processCommandsFromMap(l.AIO_MAP,c,b,a)};l.prototype._processSonosCommands=function(c,b,a){return this._processCommandsFromMap(l.SONOS_MAP,c,b,a)};l.prototype._processHueCommands=function(c,b,a){return this._processCommandsFromMap(l.HUE_MAP,
c,b,a)};l.prototype._processMilightCommands=function(c,b,a,e){return this._processCommandsFromMap(l.MILIGHT_MAP,c,b,a,e)};l.prototype._processOsramCommands=function(c,b,a){return this._processCommandsFromMap(l.OSRAM_MAP,c,b,a)};l.prototype._processHarmonyCommands=function(c,b,a,e){return this._processCommandsFromMap(l.HARMONY_MAP,c,b,a,e)};l.prototype._processMcontrolCommands=function(c,b,a){if(c&&c.info&&c.info.command){var e=JSON.parse(JSON.stringify(c.info.command));c.info.command=e;c.info.command.push({type:"enum",
name:"on",ref:{value:"do",ext:"on"}});c.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});c.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});c.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});c.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,c,b,a)};l.prototype._processFibaroHCCommands=function(c,b,a){if(a&&"blind"==a.type&&c&&c.info&&c.info.command){for(var e=JSON.parse(JSON.stringify(c.info.command)),
d=0;d<e.length;d++){var g=e[d];switch(g.name){case "open":g.name="up";break;case "close":g.name="down";break;case "up":g.name="step up";break;case "down":g.name="step down";break;case "stop":g.name="off"}}c.info.command=e}return this._processCommandsFromMap(l.FIBAROHC_MAP,c,b,a)};l.prototype._processAVCommands=function(c,b,a,e){return this._processCommandsFromMap(l.AV_MAP,c,b,a,e)};l.prototype._processTadoCommands=function(c,b,a){return this._processCommandsFromMap(l.TADO_MAP,c,b,a)};l.prototype._processNetatmoCommands=
function(c,b,a){return this._processCommandsFromMap(l.NETATMO_MAP,c,b,a)};l.prototype._processCommandsFromMap=function(c,b,a,e,d){a=a?String(a).toLowerCase():"de";for(var g={},k=l.LANG.indexOf(a),h=0;h<b.info.command.length;h++){var f=b.info.command[h];if("string"!==f.type||"aio"===b.info.sys&&"STRING"===b.info.type)if("root"===f.type)this._processRootCommandsFromMap(g,f,c,b,a,e,d);else{var n={type:"POST",url:"/cmd",original:f.name,data:{XC_FNC:"SendRM",device:b.index,command:JSON.parse(JSON.stringify(f.ref))}},
q=f.name.toLowerCase(),p=l.MAP[q]?l.MAP[q][k]:null;(q=c&&c[q]?c[q][k]:null)&&(p=q);var r=null;q=b.info.sys;if(this._customMap&&q&&this._customMap[q]){var t=this._customMap[q];r=t[f.name]?t[f.name][k]:null}r&&(p=r);if("%d"===f.ref.ext||"%f"===f.ref.ext||"%s"===f.ref.ext)n.data.command.ext="{val}","%f"===f.ref.ext&&(n["float"]=1),f.ref.extMeta&&(r=f.ref.extMeta.indexOf("-",1),-1!=r&&(q=parseFloat(f.ref.extMeta.substr(0,r)),r=parseFloat(f.ref.extMeta.substr(r+1)),n.min=q,n.max=r)),f.ref.scale&&(n.step=
parseFloat(f.ref.scale)),p||(p=f.name),"value"===p?g[p]=n:(e&&!e.values&&(e.values={}),e&&e.values&&(e.values[p]=n));else if("%e"===f.ref.ext){if(p||(p=f.name),f.ref.extMeta&&0<f.ref.extMeta.length)for(r=0;r<f.ref.extMeta.length;r++){var u=JSON.parse(JSON.stringify(n));u.data.command.ext=f.ref.extMeta[r];u.original+=" "+f.ref.extMeta[r];var v=p+" "+f.ref.extMeta[r];this._customMap&&q&&this._customMap[q]&&(t=this._customMap[q],(t=t[u.original]?t[u.original][k]:null)&&(v=t));g[v]=u}}else"rgb"===f.type||
"rgbw"===f.type?(n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FF0000",g[l.MAP.red[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FF00FF",g[l.MAP.purple[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="0000FF",g[l.MAP.blue[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="00FFFF",g[l.MAP.cyan[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="00FF00",g[l.MAP.green[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FFFF00",g[l.MAP.yellow[k]]=n,n=JSON.parse(JSON.stringify(n)),
n.data.command.ext="FF8C00",g[l.MAP.orange[k]]=n,"rgbw"===f.type&&(n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FFFFFF",g[l.MAP.white[k]]=n)):(p||(p=f.name),g[p]=n,r&&(n.mappedCustom=!0))}}return g};l.prototype._processRootCommandsFromMap=function(c,b,a,e,d,g,k){d||(d="de");d=d.toLowerCase();d=l.LANG.indexOf(d);if(b&&b.value&&b.children&&0!=b.children.length){if("mainzone"!=b.value&&"global"!=b.value){c=g.name+" "+b.name;var h={name:c,type:g.type,sys:g.sys,baseurl:g.baseurl,commands:{}};k[c]=
h;c=h.commands}for(k=0;k<b.children.length;k++)if(h=b.children[k],("string"!=h.type||"aio"==e.info.sys&&"STRING"==e.info.type)&&"root"!=h.type){var f={type:"POST",url:"/cmd",original:h.name,data:{XC_FNC:"SendRM",device:e.index,command:JSON.parse(JSON.stringify(h.ref))}};f.data.command.path=[b.value];var n=h.name.toLowerCase(),q=l.MAP[n]?l.MAP[n][d]:null;(n=a&&a[n]?a[n][d]:null)&&(q=n);var p=null;n=e.info.sys;if(this._customMap&&n&&this._customMap[n]){var r=this._customMap[n];p=r[h.name]?r[h.name][d]:
null}p&&(q=p);if("%d"==h.ref.ext||"%f"==h.ref.ext||"%s"==h.ref.ext)f.data.command.ext="{val}","%f"==h.ref.ext&&(f["float"]=1),h.ref.extMeta&&(p=h.ref.extMeta.indexOf("-",1),-1!=p&&(n=parseFloat(h.ref.extMeta.substr(0,p)),p=parseFloat(h.ref.extMeta.substr(p+1)),f.min=n,f.max=p)),h.ref.scale&&(f.step=parseFloat(h.ref.scale)),q||(q=h.name),"value"!=q&&(g&&!g.values&&(g.values={}),g&&g.values&&(g.values[q]=f));else if("%e"==h.ref.ext){if(q||(q=h.name),h.ref.extMeta&&0<h.ref.extMeta.length)for(p=0;p<h.ref.extMeta.length;p++){var t=
JSON.parse(JSON.stringify(f));t.data.command.ext=h.ref.extMeta[p];t.original+=" "+h.ref.extMeta[p];var u=q+" "+h.ref.extMeta[p];this._customMap&&n&&this._customMap[n]&&(r=this._customMap[n],(r=r[t.original]?r[t.original][d]:null)&&(u=r));c[u]=t}}else"rgb"==h.type||"rgbw"==h.type?(f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF0000",c[l.MAP.red[d]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF00FF",c[l.MAP.purple[d]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="0000FF",c[l.MAP.blue[d]]=
f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="00FFFF",c[l.MAP.cyan[d]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="00FF00",c[l.MAP.green[d]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FFFF00",c[l.MAP.yellow[d]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF8C00",c[l.MAP.orange[d]]=f,"rgbw"==h.type&&(f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FFFFFF",c[l.MAP.white[d]]=f)):(q||(q=h.name),c[q]=f,p&&(f.mappedCustom=!0))}return c}};l.prototype._isDeviceHeater=
function(c){var b="hm-cc-rt-dn;hm-cc-rt-dn-bom;hm-cc-tc;hm-cc-vg-1;hm-tc-it-wm-w-eu;hmip-bwth;hmip-bwth24;hmip-etrv;hmip-etrv-2;hmip-etrv-b;hmip-etrv-b1;hmip-etrv-c;hmip-heating;hmip-sth;hmip-sthd;hmip-wth;hmip-wth-2;hmip-wth-b;hmipw-sth;hmipw-sthd;hmipw-wth;zel stg rm fwt".split(";"),a="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!c||!c.info)return!1;c=c.info;if("hm"==c.sys)return a=String(c.type).toLowerCase(),0<=b.indexOf(a);if("aio"==c.sys)if("HM"==
c.type){if(-1!=a.indexOf(c.data))return!0}else{if("FHT80b"==c.type)return!0}else if("max"==c.sys){if(1==c.type||2==c.type||3==c.type)return!0}else{if("tado"==c.sys)return!0;if("netatmo"==c.sys){if("NATherm1"==c.type)return!0}else if("gira"===c.sys&&"heater"===c.type)return!0}return!1};l.prototype._isDeviceScene=function(c){return c&&c.info&&"hm"==c.info.sys?"Prog"==c.info.type:!1};l.prototype._isDeviceBlind=function(c){return c&&c.info?"NY"===c.info.type&&"shutter"===c.info.data?!0:!1:!1};l.prototype._getDeviceCatagory=
function(c){if(!c||!c.info)return null;if(this._isDeviceHeater(c))return"heater";if(this._isDeviceScene(c))return"scene";if(this._isDeviceBlind(c))return"blind";if(!c.info.command)return null;if("fibaro"==c.info.sys)return this._getFibaroHCDeviceCatagory(c);for(var b=c.info.command,a=!1,e=0;e<b.length;e++){var d=b[e];if(d&&d.name){d=d.name.toLowerCase();if(("hue"==c.info.sys||"osram"==c.info.sys)&&"brightness"==d)return"light";if("moveto"==d||"move to"==d||"position to"==d||"positionto"==d)return"blind";
if("dimto"==d||"dim to"==d||"levelto"==d||"level to"==d)return"light";"on"==d&&(a=!0)}}return a||a?"switch":null};l.prototype._getFibaroHCDeviceCatagory=function(c){c=c.info.command;for(var b=[],a=0;a<c.length;a++){var e=c[a];e&&e.name&&(e=e.name.toLowerCase(),-1==b.indexOf(e)&&b.push(e))}return-1!=b.indexOf("open")&&-1!=b.indexOf("close")?"blind":-1!=b.indexOf("up")&&-1!=b.indexOf("down")&&-1!=b.indexOf("set value")?"light":-1!=b.indexOf("on")&&-1!=b.indexOf("off")?"switch":null};l.prototype._convertDeviceToCloudFormat=
function(c,b,a,e,d){var g=c.info.sys,k=c.info.type,h=this._getDeviceCatagory(c);h&&(k=h);k={name:b,type:k,module:g,sys:g,baseurl:a,commands:{},states:{}};if("aio"==g&&"TASK"==c.info.type)return{name:b,type:"scene",module:g,sys:g,baseurl:a,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:c.index,command:{value:"run"}}}}};if("hm"==g&&"Prog"==c.info.type)return k={name:b,type:"scene",module:g,sys:g,baseurl:a,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",
device:c.index,command:{value:"progExec"}}}}};if(c.info.command&&0<c.info.command.length){switch(g){case "hm":b=this._processHMCommands(c,e,k,d);break;case "aio":b=this._processAIOCommands(c,e,k,d);break;case "sonos":b=this._processSonosCommands(c,e,k,d);break;case "hue":b=this._processHueCommands(c,e,k,d);break;case "easyled":case "milight":case "milightv6":b=this._processMilightCommands(c,e,k,d);break;case "lightify":b=this._processOsramCommands(c,e,k,d);break;case "harmony":b=this._processHarmonyCommands(c,
e,k,d);break;case "pioneer":case "onkyo":case "denon":case "yamaha":b=this._processHarmonyCommands(c,e,k,d);break;case "mcontrol":b=this._processMcontrolCommands(c,e,k,d);break;case "fibaro":b=this._processFibaroHCCommands(c,e,k,d);break;case "tado":b=this._processTadoCommands(c,e,k,d);break;case "netatmo":b=this._processNetatmoCommands(c,e,k,d);break;default:b=this._processCommandsFromMap(null,c,e,k,d)}k.commands=b}c.info.status&&0<Object.keys(c.info.status).length&&(k.states=c.info.status);return k};
l.prototype._resovleDeviceID=function(c,b,a){var e=c.name;a=a[c.room];if("_cameras"==e.substr(0,8)){a=null;var d=e.indexOf(":");e=e.substr(d+1)}"_progs&sysvars"==a&&(a=b[c.info.gateway],"gw"==e.substr(0,2)&&(d=e.indexOf("_"),e=e.substr(d+1)));b=(a?a+" ":"")+(e?e:"");c.cloud.alias&&(b=c.cloud.alias);return b};l.prototype._resovleBaseUrl=function(c,b){var a=c,e=c.indexOf(":");-1!=e&&(a=c.substr(0,e));return"https://"+a+"/rapi/"+b};l.prototype.getAccessToken=function(c,b){if(c)if("aio"!=c.sys&&"neoserver"!=
c.sys)b&&b(Error("gateway type invalid"));else{var a=this,e=require("xnm.aio.gateway.js");if("neoserver"==c.sys){c=JSON.parse(JSON.stringify(c));c.sys="aio";c.version="EA";var d=e.resolveGateway(c,!0)}else d=e.resolveGateway(c);d?e.Admin.getGatewaySID(d,function(g,k){g?(a._logger.log("warn","get gateway sid error:"+g.message),g.code="50001",g.message="get gateway sid error:"+g.message,b&&b(g)):k?c.password?e.Admin.V5.getInfo(d,function(h,f){h?(a._logger.log("warn","get gateway info error:"+h.message),
h.message="get gateway info error:"+h.message,h.code="50101",b&&b(h)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(a._logger.log("warn","gateway cloud server is deactivated"),h=Error("gateway cloud server is deactivated"),h.code="50103",b&&b(h)):a._getAccessToken(f.server,k,c.password,!1,function(n,q){n?(n=Error("get accesss token error:"+n.message),n.code="50003",b&&b(n)):q?b&&b(null,q,f.server,k):a._getAccessToken(f.server,k,c.password,!0,function(p,r){p?(p=Error("generate accesss token error:"+p.message),
p.code="50004",b&&b(p)):r?b&&b(null,r,f.server,k):b&&b(Error("access token empty"))})}):(a._logger.log("warn","gateway has no cloud server"),h=Error("gateway has no cloud server"),h.code="50102",b&&b(h))}):(g=Error("gateway has no password"),g.code="50002",b&&b(g)):(g=Error("gateway has no sid"),g.code="50002",b&&b(g))}):b&&b(Error("gateway json invalid"))}else b&&b(Error("gateway json is null"))};l.prototype.generateConfig=function(c,b,a,e,d,g,k,h,f,n){var q=require("url").parse("https://"+h),p=
function(z){for(var x=z.length,A={};x--;){var B=z[x];A[B.index]=B.name}return A}(b),r=function(z){for(var x=z.length,A={};x--;){var B=z[x];A[B.index]=B.name}return A}(a);a={};h=this._resovleBaseUrl(h,g);b=f=null;for(var t=0;t<c.length;t++){var u=c[t];!u||!u.info||"cloudservice"==u.info.sys&&u.info.module||"_webpages"==u.name.substr(0,9)||(f=this._resovleDeviceID(u,r,p),b=this._convertDeviceToCloudFormat(u,f,h,d,a),b.data={mod:"mediola",ccs:q.hostname,accessToken:g,deviceID:u.index},a[f]=b)}c={};d=
null;if(e&&e.groups)for(g=0;g<e.groups.length;g++)if((q=e.groups[g])&&q.macros&&0!=q.macros.length)for(p=q.name,r=0;r<q.macros.length;r++)if(b=q.macros[r],f=b.name,b.cloud&&b.cloud.enabled){f=(p?p+" ":"")+(f?f:"");b.cloud.alias&&(f=b.cloud.alias);d="";t=f.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");for(var v=0;v<u.length;v++){var w=u[v],y=t.substr(t.length-w.length);t.length>w.length&&y==w&&(d=f.substr(0,t.length-w.length).trim(),c[d]||(c[d]=[]),c[d].push({original_id:f,
command:w}))}b={name:f,type:"scene",baseurl:h,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:q.index,macroIdx:b.index}}}};a[f]=b}for(d in c){e=c[d];b={name:d,type:"scene",baseurl:h,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{}};g=f=!1;for(q=0;q<e.length;q++)if((p=e[q])&&p.original_id&&p.command&&(r=p.original_id,t=a[r],delete a[r],t)){r=t.commands.on;t=p.command;switch(p.command){case "on":case "an":case "ein":f=!0;t="on";
break;case "off":case "aus":f=!0;t="off";break;case "up":case "auf":case "hoch":g=!0;t="up";break;case "down":case "ab":case "runter":g=!0,t="down"}b.commands[t]=r}f?b.type="switch":g&&(b.type="blind");a[d]=b}n&&n(null,a)};l.prototype.uploadConfig=function(c,b,a){b={type:"mediola",configuration:b};var e=c.ip;e||(e=require("url").parse(l.REMOTE_SERVER).host);var d=c.port;d||(d=443);var g=c.username?c.username:"";c=c.password?c.password:"";c={host:e,port:d,path:"/alexa/setConfiguration",method:"POST",
timeout:3E4,auth:g+":"+c,user:g,password:c,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(g+":"+c)).toString("base64"),Connection:"close"}};var k=this;this._logger.log("trace","upload config to:"+JSON.stringify(c));c=require("https").request(c,function(h){h.setEncoding("utf8");var f="";h.on("data",function(n){f+=n});h.on("end",function(){if(200==h.statusCode){k._logger.log("trace","upload config reponse:"+f);try{var n=JSON.parse(f);if(n.XC_ERR){var q=Error(n.XC_ERR.msg);
q.code=n.XC_ERR.code;a&&a(q)}else n.XC_SUC&&a&&a()}catch(p){a&&a(p)}}else k._logger.log("warn","upload config error +"+h.statusCode+":"+f),a&&a(Error("http response:"+h.statusCode))})});if(c.on)c.on("error",function(h){k._logger.log("warn","upload config error:"+h.message);a&&a(h);a=null});c.write(JSON.stringify(b));c.end()};l.prototype.setCustomCommandMap=function(c){this._customMap=c};l.prototype.loadCustomComamndMap=function(c,b){var a=require("fs-extra");a.ensureFile(c,function(e){e?b&&b(null,
{}):a.readFile(c,"utf8",function(d,g){if(d)b&&b(d);else if(g)try{var k=JSON.parse(g);b&&b(null,k)}catch(h){b&&b(null,{})}else b&&b(null,{})})})};l.prototype.saveCustomCommandMap=function(c,b,a){var e=require("fs-extra");e.ensureFile(c,function(d){if(d)a&&a(null,{});else try{var g=JSON.stringify(b,null,2);e.writeFile(c,g,function(k){a&&a(k)})}catch(k){a&&a(k)}})};return l}();
m.aio.voicemanager.Handler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};l.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";l.prototype.init=function(c,b,a,e){this._configmanager=c;this._devicemanager=b;this._macromanager=
a;e&&e()};l.prototype.loadCustomComamndMap=function(c,b){var a=this;this._configmanager.trace("/config/tenants/"+c,function(e,d){e?(e.code="50100",b&&b(e)):(e=require("path"),(d=d.getFolderPath())?(d=e.join(d,a.CUSTOM_CMD_MAP_FILE),a._alexaHandler.loadCustomComamndMap(d,function(g,k){b&&b(g,k)})):(e=Error("tenant folder is null"),e.code="50100",b&&b(e)))})};l.prototype.saveCustomComamndMap=function(c,b,a){var e=this;this._configmanager.trace("/config/tenants/"+c,function(d,g){d?(d.code="50100",a&&
a(d)):(d=require("path"),g=g.getFolderPath(),g=d.join(g,e.CUSTOM_CMD_MAP_FILE),e._alexaHandler.saveCustomCommandMap(g,b,function(k){a&&a(k)}))})};l.prototype.getLocalDeviceConfig=function(c,b,a,e){if(b){var d=this;this._alexaHandler.getAccessToken(b,function(g,k,h,f){g?e&&e(g):d._getDeviceWithCommandAndStatus(c,function(n,q){n?(n.code="50005",e&&e(n)):d._devicemanager.execute("read",c,"gateway",null,function(p,r){p?(p.code="50007",e&&e(p)):d._devicemanager.execute("read",c,"room",null,function(t,
u){t?(t.code="50008",e&&e(t)):d._macromanager.execute(c,"read",null,null,null,function(v,w){v?(v.code="50009",e&&e(v)):d.loadCustomComamndMap(c,function(y,z){if(y||!z)z=null;d._alexaHandler.setCustomCommandMap(z);d._alexaHandler.generateConfig(q,u,r,w,a,k,b,h,f,function(x,A){x?(d._logger.log("warn","generate configuration error:"+x.message),x.code="50010",e&&e(x)):e&&e(null,A)})})})})})})})}else e&&e(null,null)};l.prototype.getCloudDeviceConfig=function(c,b,a){var e=null;if(b){var d=require("xnm.aio.cloudservice.js").resolveGateway(b);
d?this._getCloudDevicesFromDB(c,d,function(g,k){g?a&&a(g):k&&0!=k.length?(g=k.map(function(h){h=h.info;delete h.gateway;delete h.commands;delete h.states;return h}),d.toCloudDevice(g,function(h,f){if(h)h.code=40003,a&&a(h);else if(f&&0!=f.length){h={};for(var n=0;n<k.length;n++){var q=k[n];if(q)for(var p=0;p<f.length;p++){var r=f[p];r&&(r.data&&q.info.module==r.data.mod&&q.info.connection==r.data.connection&&q.info.id==r.data.id?(r.name=q.__cloudref,h[q.__cloudref]=r):q.info.module==r.mod&&q.info.connection==
r.connection&&q.info.id==r.id&&(r.name=q.__cloudref,r.data={mod:r.mod,connection:r.connection,id:r.id},delete r.mod,delete r.connection,delete r.id,h[q.__cloudref]=r))}}a&&a(null,h)}else a&&a(null,{})})):a&&a(null,{})}):(e=Error("cloud json invalid"),e.code=4E4,a&&a(e))}else e=Error("cloud json invalid"),e.code=4E4,a&&a(e)};l.prototype._getCloudDevicesFromDB=function(c,b,a){var e=function(h,f){for(var n=0;n<f.length;n++){var q=f[n];if(q&&q.index==h)return q}return null},d=this,g=require("xnm.aio.cloudservice.js"),
k={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",c,"device",k,function(h,f){h?(h.code=40001,a&&a(h)):f&&0!=f.length?(k={filter:"prop","info.sys":"cloudservice"},d._devicemanager.execute("read",c,"gateway",k,function(n,q){n?(n.code=40001,a&&a(n)):q&&0!=q.length?d._devicemanager.execute("read",c,"room",null,function(p,r){if(p)p.code=40001,a&&a(p);else if(r&&0!=r.length){p=[];for(var t=0;t<f.length;t++){var u=f[t];if(u&&u.info&&u.info.gateway){var v=e(u.info.gateway,
q);if(v&&v.info&&(v=g.resolveGateway(v.info))){if(!v.equalsTo(b)){p=Error("cloud device "+u.index+" belongs to another account");p.code=40002;a&&a(p);return}var w=e(u.room,r);w&&(v=u.name,w=w.name,v=(w?w+" ":"")+(v?v:""),u.cloud.alias&&(v=u.cloud.alias),u=JSON.parse(JSON.stringify(u)),u.__cloudref=v,p.push(u))}}}a&&a(null,p)}else a&&a(null,[])}):a&&a(null,[])})):a&&a(null,[])})};l.prototype.previewAlexaConfig=function(c,b,a,e,d){if(a&&a.username)if(e&&e.version&&"C"==e.version.charAt(0)&&"CA"!=e.version.toUpperCase()){var g=
new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager);g.setTargetGateway(e);g.exportConfig(c,a,function(h,f){d&&d(h,f)})}else{var k=this;this.getCloudDeviceConfig(c,a,function(h,f){h?d&&d(h):k.getLocalDeviceConfig(c,e,b,function(n,q){if(n)d&&d(n);else{n={};var p;if(f)for(p in f)n[p]=f[p];if(q)for(p in q)n[p]=q[p];(q=Object.keys(n))&&0!=q.length?d&&d(null,n):(k._logger.log("warn","generate empty configuration"),n=Error("empty configuration"),n.code="50011",d&&d(n))}})})}else d&&
d(Error("username is null"))};l.prototype.exportAlexaConfig=function(c,b,a,e,d){if(a&&a.username)if(e){var g=this;this.previewAlexaConfig(c,b,a,e,function(k,h){if(k)d&&d(k);else{var f={};if(h)for(var n in h)k=h[n],delete k.sys,delete k.module,f[n]=k;g._configmanager.execute("read","/config/tenants/"+c,null,function(q,p){if(q)q.code="50013",d&&d(q);else{var r=null;p.license&&"normal"==p.license.type&&p.license.valid&&p.license.license&&(r=p.license.license);g._alexaHandler.uploadConfig(a,f,function(t){t?
(g._logger.log("warn","upload configuration error:"+t.message),t.code="000009"==t.code?"50014":"50012",d&&d(t)):r?g.bindLicense(a.username,a.password,r,function(u){u&&g._logger.log("warn","bind user license error:"+u.message);d&&d(null,f)}):d&&d(null,f)})}})}})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};l.prototype._getDeviceWithCommandAndStatus=function(c,b){var a={filter:"prop","cloud.enabled":!0},e=this,d={};this._devicemanager.execute("read",c,"device",{filter:"ui",
f_ui_elem:"*",f_ui_type:"command"},function(g,k){if(g)b(g);else{if(k&&0<k.length)for(g=0;g<k.length;g++){var h=k[g];h&&h.cloud&&h.cloud.enabled&&h.info&&h.info.command&&0!=h.info.command.length&&(d[h.index]=h)}e._devicemanager.execute("read",c,"device",a,function(f,n){if(f)b(f);else if(n&&0!=n.length){var q=0,p=function(r,t){!r&&t&&(d[n[q].index]?d[n[q].index].info.status=t.states:(d[n[q].index]=n[q],n[q].info.status=t.states));q++;q<n.length?e._devicemanager.toGeneralDevice(c,n[q].index,!1,p):(r=
Object.values(d),b(null,r))};e._devicemanager.toGeneralDevice(c,n[q].index,!1,p)}else f=Object.values(d),b(null,f)})}})};l.prototype.bindLicense=function(c,b,a,e){b={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+a,method:"GET",timeout:3E4,auth:c+":"+b,user:c,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(c+":"+b)).toString("base64"),Connection:"close"}};var d=this;this._logger.log("trace","bind license "+a+" to:"+c);c=
require(this.CLOUD_PROTOCOL).request(b,function(g){g.setEncoding("utf8");var k="";g.on("data",function(h){k+=h});g.on("end",function(){200==g.statusCode?(d._logger.log("trace","bind license success"),e&&e()):(d._logger.log("warn","bind license success +"+g.statusCode+":"+k),e&&e(Error("http response:"+g.statusCode)));e=null})});if(c.on)c.on("error",function(g){d._logger.log("warn","upload config error:"+g.message);e&&e(g);e=null});c.setTimeout(3E4,function(){e&&e(Error("timeout"));e=null});c.end()};
l.prototype.uploadDeviceDB=function(c,b,a,e){this._uploadFile(c,b,"device_db",a,e)};l.prototype.uploadMacroDB=function(c,b,a,e){this._uploadFile(c,b,"macros_db",a,e)};l.prototype._uploadFile=function(c,b,a,e,d){c="/xhub/xhubsync/upload2?gatewayid="+c+"&fileName="+a+"&auth=";b.password&&(c+=b.password);b={host:b.ip,port:b.port,path:c,method:"POST",timeout:3E4,headers:{"Content-Type":"text/plain",Connection:"close"}};var g=this;this._logger.log("trace","upload "+a+" to:"+JSON.stringify(b));b=require("http").request(b,
function(k){k.setEncoding("utf8");var h="";k.on("data",function(f){h+=f});k.on("end",function(){if(200==k.statusCode){g._logger.log("trace","upload "+a+" reponse:"+h);try{"success"==JSON.parse(h).status?d&&d():d&&d(Error("failed to upload "+a))}catch(f){d&&d(f)}}else g._logger.log("warn","upload "+a+" error +"+k.statusCode+":"+h),d&&d(Error("http response:"+k.statusCode))})});if(b.on)b.on("error",function(k){g._logger.log("warn","upload "+a+" error:"+k.message);d&&d(k);d=null});b.write(JSON.stringify(e));
b.end()};l.prototype.exportV5Config=function(c,b,a,e,d){if(a&&a.username)if(e){var g=this;(new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager)).exportConfig(c,a,function(k,h){k?(g._logger.log("error","generate configuration error:"+k.message),k.code="50012",d&&d(k)):g._configmanager.execute("read","/config/tenants/"+c,null,function(f,n){if(f)f.code="50013",d&&d(f);else{var q=null;n.license&&"normal"==n.license.type&&n.license.valid&&n.license.license&&(q=n.license.license);
g._alexaHandler.uploadConfig(a,h,function(p){p?(g._logger.log("warn","upload configuration error:"+p.message),p.code="000009"==p.code?"50014":"50012",d&&d(p)):q?g.bindLicense(a.username,a.password,q,function(r){r&&g._logger.log("warn","bind user license error:"+r.message);d&&d(null,h)}):d&&d(null,h)})}})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};return l}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
