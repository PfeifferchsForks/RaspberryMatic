var x=x||{};x.mdns=x.mdns||{};
x.mdns.DNS_SD=function(){var D=function(){this.data=this.length=this.ttl=this.class=this.type=this.name=null};D.prototype.resolveData=function(a){this.data=a};D.prototype.toJSON=function(){return this};var E=function(){this._info={}};E.prototype.resolveData=function(a,b,c,d){for(b=0;b<a.length-1;){c=2*parseInt(a.substr(b,2),16);var g;if(g=b+2+c>a.length?a.substr(b+2,a.length-b-2):a.substr(b+2,c)){g=e._hex2a(g);var r=g.indexOf("=");-1!=r&&r!=g.length-1&&(d=g.substr(0,r),g=g.substr(r+1),this._info[d]=
g)}b+=2+c}};E.prototype.toJSON=function(){};var y=function(){};y.prototype.resolveData=function(a,b,c,d){this.domain=e._parseName(b,c,d).name};y.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};y.prototype.getDomainTxt=function(){return this.domain?e._hex2name(this.domain):null};y.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,domain:this.getDomainTxt()}};var h=function(){};h.prototype.resolveData=
function(a,b,c,d){this.priority=parseInt(a.substr(0,4),16);this.weight=parseInt(a.substr(4,4),16);this.port=parseInt(a.substr(8,4),16);this.target=e._parseName(b+12,c,d).name};h.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};h.prototype.getTargetTxt=function(){return this.target?e._hex2name(this.target):null};h.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,
port:this.port,target:this.getTargetTxt()}};var k=function(){};k.prototype.resolveData=function(a){this.addr=a};k.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};k.prototype.getAddrTxt=function(){return k._hex2ipv4(this.addr)};k.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};k._hex2ipv4=function(a){if(!a||8>a.length)return null;var b=parseInt(a.substr(0,2),16)+".";b+=parseInt(a.substr(2,
2),16)+".";b+=parseInt(a.substr(4,2),16)+".";return b+=parseInt(a.substr(6,2),16)};var f=function(){};f.prototype.resolveData=function(a){this.addr=a};f.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};f.prototype.getAddrTxt=function(){if(!this.addr||32>this.addr.length)return null;var a=this.addr.substr(0,4)+":";a+=this.addr.substr(4,4)+":";a+=this.addr.substr(8,4)+":";a+=this.addr.substr(12,4)+":";a+=this.addr.substr(16,4)+":";a+=this.addr.substr(20,4)+":";a+=this.addr.substr(24,
4)+":";return a+=this.addr.substr(28,4)};f.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};var l=function(a,b){this.name=a;this.type=b};l.prototype._name2Array=function(){if(!this.name)return null;for(var a=[],b=0;b<this.name.length-1;b+=2){var c=this.name.substr(b,2);a.push(parseInt(c,16))}return a};l.prototype.toArray=function(){var a=[];a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(1);
a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);var b=this._name2Array(this.name);if(!b)return null;for(var c=0;c<b.length;c++)a.push(b[c]);a.push(0);switch(this.type){case 12:a.push(0);a.push(12);break;case 33:a.push(0);a.push(33);break;case 1:a.push(0);a.push(1);break;default:return null}a.push(0);a.push(1);return a};var e=function(){this.arCount=this.nsCount=this.anCount=this.qdCount=this.flag=this.id=0;this.querys=[];this.answers=[];this.authorities=[];this.additionals=[]};e.prototype.isResponse=
function(){return 1==this.flag>>15};e.prototype.toJSON=function(){var a={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]},b;for(b=0;b<this.querys.length;b++)a.querys.push(this.querys[b].toJSON());for(b=0;b<this.answers.length;b++)a.answers.push(this.answers[b].toJSON());for(b=0;b<this.additionals.length;b++)a.additionals.push(this.additionals[b].toJSON());return a};e.parse=function(a){var b=
new e;4<a.length&&(b.id=parseInt(a.substr(0,4),16));8<a.length&&(b.flag=parseInt(a.substr(4,4),16));12<a.length&&(b.qdCount=parseInt(a.substr(8,4),16));16<a.length&&(b.anCount=parseInt(a.substr(12,4),16));20<a.length&&(b.nsCount=parseInt(a.substr(16,4),16));24<a.length&&(b.arCount=parseInt(a.substr(20,4),16));var c=24,d;if(0<b.qdCount)for(d=0;d<b.qdCount;d++){var g=e._parseQuery(c,a);c=g.queryEnd;b.querys.push(g.query)}if(0<b.anCount)for(d=0;d<b.anCount;d++)g=e._parseAnswer(c,a),c=g.answerEnd,b.answers.push(g.answer);
if(0<b.nsCount)for(d=0;d<b.arCount;d++)g=e._parseAuthority(c,a),c=g.nsEnd,b.authorities.push(g.ns);if(0<b.arCount)for(d=0;d<b.arCount;d++)g=e._parseAdditional(c,a),c=g.addiEnd,b.additionals.push(g.addi);return b};e._parseName=function(a,b,c,d){d=d?d+1:1;if(10<d)return{index:a,name:""};for(var g=a,r=!1,t;c.length>g+2&&"00"!=c.substr(g,2)&&!(b&&g-a>=2*b);)if(1==parseInt(c.substr(g,2),16)>>7){t=parseInt(c.substr(g,4),16)&16383;t=e._parseName(2*t,null,c,d).name;r=!0;g+=4;break}else{var p=parseInt(c.substr(g,
2),16);g+=2+2*p}r?(a=c.substr(a,g-a-4),a+=t):(a=c.substr(a,g-a),g+=2);return{index:g,name:a}};e._name2hex=function(a){var b="";a=a.split(".");for(var c=0;c<a.length;c++){for(var d=a[c].length.toString(16);2>d.length;)d="0"+d;b+=d;for(d=0;d<a[c].length;d++){for(var g=a[c].charCodeAt(d).toString(16);2>g.length;)g="0"+g;b+=g}}return b};e._hex2name=function(a){for(var b="",c=0;c<a.length;){var d=parseInt(a.substr(c,2),16),g=a.substr(c+2,2*d);g=e._hex2a(g);b&&(b+=".");b+=g;c+=2+2*d}return b};e._hex2a=
function(a){a=a.toString();for(var b="",c=0;c<a.length;c+=2)b+=String.fromCharCode(parseInt(a.substr(c,2),16));return b};e._parseRR=function(a,b){var c=e._parseName(a,null,b);var d=a=c.index;c=c.name;if(b.length>a+4){d=a+4;var g=parseInt(b.substr(a,4),16)}if(b.length>a+4+4){d=a+8;var r=parseInt(b.substr(a+4,4),16)}if(b.length>a+8+8){d=a+16;var t=parseInt(b.substr(a+8,8),16)}if(b.length>a+16+4){d=a+20;var p=parseInt(b.substr(a+16,4),16)}if(0<p&&b.length>=a+20+2*p){d=a+20+2*p;var z=b.substr(a+20,2*
p)}switch(g){case 12:var n=new y;break;case 16:n=new E;break;case 33:n=new h;break;case 1:n=new k;break;case 28:n=new f;break;default:n=new D}n&&(n.name=c,n.type=g,n.class=r,n.ttl=t,n.length=p,(n.dataRaw=z)&&n.resolveData(z,a+20,p,b));return{end:d,rr:n}};e._parseQuery=function(a,b){var c=new l;a=e._parseName(a,null,b);var d=a.index;c.name=a.name;b.length>d+4&&(c.type=parseInt(b.substr(d,4),16));b.length>=d+4+4&&(c.class=parseInt(b.substr(d+4,4),16));return{queryEnd:d+8,query:c}};e._parseAnswer=function(a,
b){a=e._parseRR(a,b);return{answerEnd:a.end,answer:a.rr}};e._parseAuthority=function(a,b){a=e._parseRR(a,b);return{nsEnd:a.end,ns:a.rr}};e._parseAdditional=function(a,b){a=e._parseRR(a,b);return{addiEnd:a.end,addi:a.rr}};var m=function(){this._sockets=[];this._searchCallbacks={};this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};m.prototype.startListener=function(a){function b(v,u,B){var C=this,q=B;B=require("dgram");try{var w=B.createSocket({type:"udp4",reuseAddr:!0})}catch(A){w=
B.createSocket("udp4")}w.on("message",function(A,F){C._onReceiveDNSPacket(A,F)});w.on("listening",function(){try{w.setBroadcast(!0),w.addMembership("224.0.0.251"),q&&(q(null,w),q=null)}catch(A){c&&console.error("Caught error:",A),c&&console.error("Address causing the error: "+u,v),q&&(q(A),q=null)}});w.on("error",function(A){c&&console.error("Socket on error:",A);q&&(q(A),q=null)});w.bind(v,u)}var c="undefined"!==typeof console&&"function"===typeof console.error,d=function(v,u){var B=this,C=u;u=require("dgram");
try{var q=u.createSocket({type:"udp4",reuseAddr:!0})}catch(w){q=u.createSocket("udp4")}q.on("message",function(w,A){B._onReceiveDNSPacket(w,A)});q.on("listening",function(){var w=null;try{q.setBroadcast(!0);for(var A=0;A<v.length;A++)w=v[A],q.addMembership("224.0.0.251",w);C&&(C(null,q),C=null)}catch(F){c&&console.error("Caught error:",F),c&&console.error("Address causing the error: "+w,"| All: "+v.join(", ")),C&&(C(F),C=null)}});q.on("error",function(w){c&&console.error("Socket on error:",w);C&&
(C(w),C=null)});q.bind(5353)},g=this,r=require("os");if(r&&r.networkInterfaces){r=r.networkInterfaces();var t=[],p;for(p in r)if(r.hasOwnProperty(p))for(var z=r[p],n=0;n<z.length;n++)"IPv4"==z[n].family&&0==z[n].internal&&t.push(z[n].address);d.call(this,t,function(v,u){if(v)a&&a(v);else{u&&g._sockets.push(u);var B=0;for(v=0;v<t.length;v++)b.call(g,5353,t[v],function(C,q){B++;!C&&q&&(q._isSendSocket=!0,g._sockets.push(q));B==t.length&&a&&a()})}})}else b.call(this,5353,null,function(v,u){v?a&&a(v):
(u&&(u._isSendSocket=!0,g._sockets.push(u)),a&&a())})};m.prototype.stopListener=function(a){if(this._sockets)for(var b=0;b<this._sockets.length;b++){var c=this._sockets[b];c&&c.close()}a&&a()};m.prototype.removeDiscoverServiceCallback=function(a,b){if(a&&b&&(a=this._searchCallbacks[a])){for(var c=-1,d=0;d<a.length;d++)if(a[d]===b){c=d;break}-1!=c&&a.splice(c,1)}};m.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};m.prototype.discoverService=
function(a,b){if(a){var c=this._searchCallbacks[a];c||(this._searchCallbacks[a]=[],c=this._searchCallbacks[a]);b&&-1==c.indexOf(b)&&c.push(b);b._targets=[];b._domains=[];a=e._name2hex(a);(a=(new l(a,12)).toArray())&&this._sendQuery(new Buffer(a))}else b&&b(Error("serviceType is empty"))};m.prototype._sendQuery=function(a){for(var b=0;b<this._sockets.length;b++){var c=this._sockets[b];c._isSendSocket&&c.send(a,0,a.length,5353,"224.0.0.251")}};m.prototype._searchRecords=function(){var a;for(a in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(a)){var b=
e._name2hex(a);if(this._rrBuffer._ptrRecords[b])for(var c=0;c<this._rrBuffer._ptrRecords[b].length;c++){var d=this._rrBuffer._ptrRecords[b][c],g=this._rrBuffer._txtRecords[d];if(this._rrBuffer._srvRecords[d])for(var r=0;r<this._rrBuffer._srvRecords[d].length;r++){var t=this._rrBuffer._srvRecords[d][r];if(!this._rrBuffer._aRecords[t]){var p=new l(t,1);(p=p.toArray())&&this._sendQuery(new Buffer(p))}else if(0<this._rrBuffer._aRecords[t].length){p=[];for(var z=0;z<this._rrBuffer._aRecords[t].length;z++){var n=
k._hex2ipv4(this._rrBuffer._aRecords[t][z]);n&&p.push(n)}if(0<p.length&&(z=this._searchCallbacks[a])){t=e._hex2name(t);n=e._hex2name(d);for(var v=0;v<z.length;v++){var u=z[v];if(u){var B=u._domains;B||(u._domains=[],B=u._domains);-1==B.indexOf(n)&&(u._domains.push(n),u(null,{target:t,domain:n,ip:p,info:g}))}}}}}else p=new l(d,33),(p=p.toArray())&&this._sendQuery(new Buffer(p))}}};m.prototype._handleRR=function(a){switch(a.type){case 12:var b=a.name;var c=a.domain;var d=this._rrBuffer._ptrRecords[b];
d||(this._rrBuffer._ptrRecords[b]=[],d=this._rrBuffer._ptrRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 16:b=a.name;this._rrBuffer._txtRecords[b]=a._info;break;case 33:b=a.name;c=a.target;d=this._rrBuffer._srvRecords[b];d||(this._rrBuffer._srvRecords[b]=[],d=this._rrBuffer._srvRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 1:b=a.name;c=a.addr;d=this._rrBuffer._aRecords[b];d||(this._rrBuffer._aRecords[b]=[],d=this._rrBuffer._aRecords[b]);
b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 28:b=a.name;c=a.addr;d=this._rrBuffer._aaaaRecords[b];d||(this._rrBuffer._aaaaRecords[b]=[],d=this._rrBuffer._aaaaRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c)}};m.prototype._onReceiveDNSPacket=function(a,b){a=a.toString("hex");if((a=e.parse(a))&&a.isResponse()){var c;if(a.answers)for(b=0;b<a.answers.length;b++)(c=a.answers[b])&&this._handleRR(c);if(a.authorities)for(b=0;b<a.authorities.length;b++)(c=
a.authorities[b])&&this._handleRR(c);if(a.additionals)for(b=0;b<a.additionals.length;b++)(c=a.additionals[b])&&this._handleRR(c);this._searchRecords()}};return m}();
x.mdns.Handler=function(){var D=function(){this._mDns=null};D.prototype.start=function(h){if(this._mDns)h&&h();else{var k=this,f=new x.mdns.DNS_SD;f.startListener(function(l){l||(k._mDns=f);h&&h(l)})}};D.prototype.stop=function(h){if(this._mDns){var k=this;this._mDns.stopListener(function(){k._mDns=null;h&&h()})}else h&&h(Error("mDns not started"))};D.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer()};D.prototype.discoverServiceWithTimeout=function(h,k,f){var l=this,
e=[];this.discoverService(h,function(m,a){!m&&a&&e.push(a)});setTimeout(function(){l._mDns&&l._mDns.removeDiscoverServiceCallback(h,f);f&&f(null,e)},k)};D.prototype.discoverService=function(h,k){if(h){-1==h.indexOf(".local")&&(h+=".local");var f=this;this._mDns?this._mDns.discoverService(h,k):this.start(function(l){l?k&&k(l):f._mDns.discoverService(h,k)})}else k&&k(Error("serviceType is empty"))};D.prototype.stopDiscover=function(h,k){this._mDns?this._mDns.removeDiscoverServiceCallback(h,k):k&&k()};
var E=function(){var h=function(f,l,e){this._serviceType=f;this._domain=l;this._ios=e;this._running=!1;this._callbacks=[];this._services=[]};h.prototype.discover=function(f){f&&-1==this._callbacks.indexOf(f)&&this._callbacks.push(f);if(this._running)for(var l=0;l<this._services.length;l++)f&&f(null,this._services[l]);else if(!this._running){this._running=!0;var e=this;XC.callHost("mdns","search",{service:this._serviceType},function(m){if(m.error){for(var a=0;a<e._callbacks.length;a++)e._callbacks[a](Error(m.error));
e._callbacks=[];e._stop()}else for(m.target&&"."==m.target.charAt(m.target.length-1)&&(m.target=m.target.substr(0,m.target.length-1)),m.domain&&"."==m.domain.charAt(m.domain.length-1)&&(m.domain=m.domain.substr(0,m.domain.length-1)),e._services.push(m),a=0;a<e._callbacks.length;a++)e._callbacks[a](null,m)})}};h.prototype.removeCallback=function(f){var l=!1;f&&0<this._callbacks.length&&(f=this._callbacks.indexOf(f),-1!=f&&this._callbacks.splice(f,1));0==this._callbacks.length&&(this._stop(),l=!0);
return l};h.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(f){})};var k=function(){this._serviceHandlers={}};k.prototype.start=function(f){f&&f()};k.prototype.stop=function(f){f&&f()};k.prototype.clearRecordBuffer=function(){};k.prototype.discoverServiceWithTimeout=function(f,l,e){var m=this,a=[],b=function(c,d){!c&&d&&a.push(d)};this.discoverService(f,b);setTimeout(function(){m._removeDiscoverServiceCallback(f,b);e&&e(null,a)},l)};k.prototype.discoverService=
function(f,l){if(f){-1!=f.indexOf(".local")&&(f=f.replace(".local",""));var e=this._serviceHandlers[f];e||(e=new h(f,"local",this),this._serviceHandlers[f]=e);e.discover(l)}else l&&l(Error("serviceType is empty"))};k.prototype.stopDiscover=function(f,l){if(f){-1!=f.indexOf(".local")&&(f=f.replace(".local",""));var e=this._serviceHandlers[f];e?e.removeCallback(l)&&delete this._serviceHandlers[f]:l&&l()}else l&&l(Error("serviceType is empty"))};k.prototype._removeDiscoverServiceCallback=function(f,
l){-1!=f.indexOf(".local")&&(f=f.replace(".local",""));var e=this._serviceHandlers[f];e&&e.removeCallback(l)&&delete this._serviceHandlers[f]};return k}(),y=function(){this._nativeHandler=null};y.prototype.start=function(h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.start(h)};y.prototype.stop=function(h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.stop(h)};y.prototype.clearRecordBuffer=function(){this._nativeHandler||
(this._nativeHandler=this._getNativeHandler());this._nativeHandler.clearRecordBuffer()};y.prototype.discoverServiceWithTimeout=function(h,k,f){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverServiceWithTimeout(h,k,f)};y.prototype.discoverService=function(h,k){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverService(h,k)};y.prototype.stopDiscover=function(h,k){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());
this._nativeHandler.stopDiscover(h,k)};y.prototype._getNativeHandler=function(){var h=null;"undefined"!=typeof window&&null!=window&&window.XCHost||(h="node-webkit");"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(h=window.XCHost.getType());return"Android"==h?new E:"node-webkit"==h||"undefined"!=typeof process&&null!=process&&"node"==process.title?new D:new E};return y}();"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler);
