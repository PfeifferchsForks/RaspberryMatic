var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var a=0;return function(){return a<e.length?{done:!1,value:e[a++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,a,b){if(e==Array.prototype||e==Object.prototype)return e;e[a]=b.value;return e};$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<e.length;++a){var b=e[a];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,a){var b=$jscomp.propertyToPolyfillSymbol[a];if(null==b)return e[a];b=e[b];return void 0!==b?b:e[a]};
$jscomp.polyfill=function(e,a,b,d){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,a,b,d):$jscomp.polyfillUnisolated(e,a,b,d))};$jscomp.polyfillUnisolated=function(e,a,b,d){b=$jscomp.global;e=e.split(".");for(d=0;d<e.length-1;d++){var c=e[d];if(!(c in b))return;b=b[c]}e=e[e.length-1];d=b[e];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(e,a,b,d){var c=e.split(".");e=1===c.length;d=c[0];d=!e&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<c.length-1;f++){var k=c[f];if(!(k in d))return;d=d[k]}c=c[c.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?d[c]:null;a=a(b);null!=a&&(e?$jscomp.defineProperty($jscomp.polyfills,c,{configurable:!0,writable:!0,value:a}):a!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[c]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[c]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(c):$jscomp.POLYFILL_PREFIX+b+"$"+c),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[c],{configurable:!0,writable:!0,value:a})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(e){if(e)return e;var a=function(f,k){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:k})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",d=0,c=function(f){if(this instanceof c)throw new TypeError("Symbol is not a constructor");return new a(b+(f||"")+"_"+d++,f)};return c},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<a.length;b++){var d=$jscomp.global[a[b]];"function"===typeof d&&"function"!=typeof d.prototype[e]&&$jscomp.defineProperty(d.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return e},"es6",
"es3");$jscomp.iteratorPrototype=function(e){e={next:e};e[Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,a){e instanceof String&&(e+="");var b=0,d=!1,c={next:function(){if(!d&&b<e.length){var f=b++;return{value:a(f,e[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};c[Symbol.iterator]=function(){return c};return c};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(b,d){a._onGatewayEvent(b,d)};this._eventCallback.onError=function(b){a._restartEventListener()};this._restartTO=null};e.prototype.init=function(a){var b=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(d){d?b._restartEventListener():b._restartTO&&(clearTimeout(b._restartTO),b._restartTO=null);a&&a()})};
e.prototype._onGatewayEvent=function(a,b){require("x.hub.eventbus.js").emit("gatewayevent",a,b,"EVT")};e.prototype._onEventListenerError=function(a){};e.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return e}();
x.hub.m.gateway.GatewayInternalHandler=function(){var e=function(){this._devices={};this._meta={};this._states={}};e.prototype.addStateDevice=function(a,b,d){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var c=this._getDeviceID(a);this._devices[c]||(this._devices[c]=a);this._meta[c]||(this._meta[c]=[]);this._states[c]||(this._states[c]={});if(d){a=!1;for(var f=0;f<this._meta[c].length;f++){var k=this._meta[c][f];if(k&&k.statusKey==d.statusKey&&k.src==d.src&&k.taskID==d.taskID){a=
!0;break}}a||this._meta[c].push(d)}b&&b()}else b&&b(Error("device json invalid"))};e.prototype.removeStateDevice=function(a,b,d){if(!a||!a.type||!a.address)b&&b(Error("device json invalid"));else if(d){a=JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var c=this._meta[a];if(c){for(var f=-1,k=0;k<c.length;k++){var h=c[k];if(h&&h.src==d.src&&h.taskID==d.taskID&&h.statusKey==d.statusKey){f=k;break}}0<=f&&c.splice(f,1);0==c.length&&(delete this._devices[a],delete this._meta[a],delete this._states[a])}b&&
b()}};e.prototype.onEvent=function(a,b,d){if(a){var c,f=null,k=!1;if(a.sid)for(c in this._devices){var h=this._devices[c];if(h.sid==a.sid){var m=JSON.parse(JSON.stringify(a));h.type&&!m.type&&(m.type=h.type);h.address&&!m.address&&(m.address=h.address);h.address&&!m.adr&&(m.adr=h.address);h.data&&!m.data&&(m.data=h.data);if(b=this._getSystem(m)){if(a.changed&&a.changed.length){m.state={};a.changed.forEach(function(n){m.state[n]=a.state[n]});var g=b._handleState(h,m)}if(g&&0<Object.keys(g).length){var l=
h;this._getDeviceID(l);f=g;k=!0;break}}}}if(!k){if(!a.type)return;b=this._getSystem(a);if(!b)return;for(c in this._devices)if(this._devices.hasOwnProperty(c))if(h=this._devices[c],"EVT"==d&&b._handleUdpState){if((g=b._handleUdpState(h,a))&&0<Object.keys(g).length){l=h;this._getDeviceID(l);f=g;break}}else if("STA"==d&&b._handleState){if((g=b._handleState(h,a))&&0<Object.keys(g).length){l=h;this._getDeviceID(l);f=g;break}}else if("BTN"==d&&c==a.type+"@"+a.adr){l=h;f=a.state;break}}f&&this._updateState(l,
f,a)}};e.prototype._getDeviceID=function(a){if(a&&a.sid){var b="sid@"+a.sid;a.type&&a.address&&(b+="@"+a.type+"@"+a.address);return b}return a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};e.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};e.prototype._updateState=function(a,b,d){var c=this._getDeviceID(a),f=this._meta[c],k=this._states[c]?this._states[c]:{};this._states[c]=b;if(f&&0<f.length)for(var h in b)if(b.hasOwnProperty(h)){c=
b[h];var m=k[h];c={key:h,value:c,changed:m!=c,oldValue:m};d&&d.sid&&d.changed&&d.changed.length&&(c.changed=!0,delete c.oldValue);if("aio"==a.sys&&"MBUS"==a.type)if("undefined"==typeof m||null==m)continue;else if(!c.changed)continue;m=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var g=0;g<f.length;g++){var l=f[g];!l||l.statusKey!=h&&"*"!=l.statusKey||m.emit("status",{module:"aio",device:a,gateway:null,data:c},l)}}};return e}();
x.hub.m.gateway.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};e.prototype.on=function(a,b){this._on[a]=b};e.prototype._checkStateChange=function(a,b){};e.prototype.updateGatewayStates=function(a,b){b({})};e.prototype.updateStates=
function(a,b){b({})};e.prototype.getStates=function(a){return{}};e.prototype.getAllStates=function(){return[]};e.prototype.init=function(a){var b=this;require("x.hub.eventbus.js").on("gatewayevent",function(d,c,f){b._onEvent(d,c,f)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){b._updateLocalIPBuffer()},
18E5);this._monitor.init()};e.prototype.getSystems=function(){return["aio"]};e.prototype.addStateDevice=function(a,b,d){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(c){b&&b({error:c})},d):b&&b({error:Error("device json invalid")})};e.prototype.removeStateDevice=function(a,b,d){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(c){b&&b({error:c})},d):b&&b({error:Error("device json invalid")})};e.prototype.getState=function(a,b,d){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var c=a.gateway;c=this._processPassword(c);c.__isself?this._getStateLocal(c,a,b,d):x.hub.m.gateway.AIOMODULE.doStatus("hub",c,a,{value:b},function(f,k){var h=null;k&&(h={value:k.status,time:(new Date).getTime()});d&&d({error:f,data:h})})}else d&&d({error:Error("gateway json invalid")});else this._getStateIQ(a,b,d)};e.prototype.executeCommand=function(a,b,d){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var c=a.gateway;c.ip?((c=this._processPassword(c))&&!a.type&&(a=c),c.__isself?this._executeCommandLocal(c,
a,b,d):x.hub.m.gateway.AIOMODULE.doCommand(c,a,b,function(f){d&&d({error:f})})):d&&d({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,b,d);else d&&d({error:Error("device is null")})};e.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var d=a.device.address;d&&"string"==typeof d&&(d=d.toUpperCase());var c=b.device.address;c&&"string"==typeof c&&(c=c.toUpperCase());a=a.device.type;return d==c&&a==b.device.type};e.prototype.updateGatewayNeoIndex=function(){localStorage&&
(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};e.prototype._onEvent=function(a,b,d){if(!(a.module||a.sys||(this._logger.log("trace","from "+(b?b.address:null)+" receive "+d+" event:"+JSON.stringify(a)),this._localIpBuffer&&b&&b.address&&"STA"==d&&-1!=this._localIpBuffer.indexOf(b.address)||b&&"Sysvar"!=b.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var c=require("x.hub.eventbus.js");
if(a.type&&"IR"==a.type&&a.data)c.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,b,d)}};e.prototype._executeCommandIQ=function(a,b,d){if(a.type){var c;if("HM"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)"ip_siren"==a.data&&(b.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,b)),(c=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?c.executeCommand(a,b,d):d&&d({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)(c=
require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?c.executeCommand(a,b,d):d&&d({error:Error("no module for type ENOCEAN")});else{var f=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(f){if("CODE"==a.type){var k=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(b,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,k)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,
a,b):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,b.value);f="http://localhost/command?XC_FNC="+f;if(a)for(c in a)f+="&"+c+"="+encodeURIComponent(a[c]);try{var h=require("x.hub.js").server;h?h._doSTMCommandRequest(f,!1,function(m){d&&d({error:m})}):d&&d({error:Error("server not initialized")})}catch(m){d&&d({error:m})}}else d&&d({error:Error("unknow device type")})}}else d&&d({error:Error("device type is null")})};e.prototype._executeCommandLocal=function(a,b,d,c){var f=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(b,
a);if(f&&f.buildQuery){var k=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(f=f.buildQuery(k?k:a,b,d)){try{var h=require("x.hub.js").server;if(!h){c&&c({error:Error("server not initialized")});return}var m=require("querystring"),g,l;if(f.fnc&&0==f.fnc.indexOf("/api")){(l=g=f.fnc)&&delete f.fnc;if(f.data)f=f.data;else{var n=m.stringify(f);f=m.parse(n);l=g+"?"+n}var r={url:l,query:f}}else"SendGenericCmd"==f.XC_FNC?(g="/cmd",r={method:"POST",url:l,query:f,json:f}):(g="/cmd",n=m.stringify(f),f=m.parse(n),
l=g+"?"+n,r={url:l,query:f});this._logger.log("trace","execute command local directly "+l);var t=this;h.doRequest(g,r,function(p){t._logger.log("trace","execute command local directly return:"+JSON.stringify(p));var q=null;if(p)try{(q=JSON.parse(p))&&q.XC_SUC?c&&c({data:q}):q&&q.XC_ERR?c&&c({error:Error(p)}):c&&c({error:Error("/cmd request return invalid format")})}catch(u){c&&c({error:u})}else c&&c({error:Error("/cmd request return null")})})}catch(p){c&&c({error:p})}return}}this._logger.log("trace",
"execute command via localhost:"+JSON.stringify(b)+" command:"+JSON.stringify(d));x.hub.m.gateway.AIOMODULE.doCommand(a,b,d,function(p){c&&c({error:p})})};e.prototype._getStateIQ=function(a,b,d){var c={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};c=this._processPassword(c);this._getStateLocal(c,a,b,d)};e.prototype._getStateLocal=function(a,b,d,c){var f=function(g,l,n){if(g.error)return{error:g.error};g=n._handleGeneralStatesRsp(g.data,l);l=null;g&&g[0]&&(l={value:g[0].status,
time:(new Date).getTime()});return{error:null,data:l}},k=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(k){var h=[{id:"hub",device:b,status:{value:d}}],m=this;b&&"dev"==b.common_type?b.id?require("x.hub.commandman.js").commandHandlerV6.getDeviceStatesWithId(b.id,function(g,l){g?c&&c({error:g}):(g={value:l?l[d]:null,time:(new Date).getTime()},c&&c({error:null,data:g}))}):c&&c({error:Error("device json invalid")}):b&&b.type?"HM"==b.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.hm.js").getAllStatesLegacy(function(g){g=
f(g,h,k);c&&c(g)}):"ENOCEAN"==b.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").getAllStatesLegacy(function(g){g=f(g,h,k);c&&c(g)}):"ZWAVE2"==b.type?require("x.hub.m.zway.js").getAllStatesLegacy(function(g){g=f(g,h,k);c&&c(g)}):"KNX"==b.type?require("x.hub.m.knx.js").getAllStatesLegacy(function(g){g=f(g,h,k);c&&c(g)}):"ZIGBEE"==b.type?require("x.hub.m.zigbee.js").getAllStatesLegacy(function(g){g=f(g,h,k);c&&c(g)}):"ONOFF"==b.type||"FLOAT"==b.type||"INT"==b.type||"STRING"==b.type?
require("x.hub.sysvarman.js").getSysvarStates(function(g){g=f(g,h,k);c&&c(g)}):"TASK"==b.type?require("x.hub.taskman.js").readAllTasks(function(g){if(g.error)g=f(g,h,k);else{var l=[];g.data.forEach(function(n){n&&l.push({type:"TASK",id:n.id,active:n.active})});g=f({data:l},h,k)}c&&c(g)}):(a=require("x.hub.js").server)?(this._logger.log("trace","get states from ST directly"),a.doSTMCommand("XC_FNC=getStates",function(g){m._logger.log("trace","get states from ST return:"+JSON.stringify(g));if(g)if(g.XC_SUC){var l=
{data:null};Array.isArray(g.XC_SUC)?l.data=g.XC_SUC:0<Object.keys(g.XC_SUC).length&&(l.data=[g.XC_SUC]);g=f(l,h,k);c&&c(g)}else c&&c({error:Error("ST get states return error:"+JSON.stringify(g))});else c&&c({error:Error("ST get states return null")})})):c&&c({error:Error("server not initialized")}):x.hub.m.gateway.AIOMODULE.doStatus("hub",a,b,{value:d},function(g,l){var n=null;l&&(n={value:l.status,time:(new Date).getTime()});c&&c({error:g,data:n})})}else c&&c({error:Error("gateway json format invalid")})};
e.prototype._processPassword=function(a){var b=this._localIpBuffer,d="";localStorage&&(d=localStorage.getItem("x.hub.Server.pwd"));"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=b.indexOf(a.ip)?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)):2==a.__neoInfo.db&&a.__neoInfo.index==this._db2GatewayNeoIndex&&
(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)));return a};e.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],b=require("os").networkInterfaces(),d;for(d in b)for(var c=b[d],f=0;f<c.length;f++)a.push(c[f].address);this._localIpBuffer=a};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
