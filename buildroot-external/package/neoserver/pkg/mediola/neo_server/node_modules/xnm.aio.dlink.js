var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(g,a,c){g instanceof String&&(g=String(g));for(var b=g.length,d=0;d<b;d++){var e=g[d];if(a.call(c,e,d,g))return{i:d,v:e}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,a,c){if(g==Array.prototype||g==Object.prototype)return g;g[a]=c.value;return g};$jscomp.getGlobal=function(g){g=["object"==typeof globalThis&&globalThis,g,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<g.length;++a){var c=g[a];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(g,a){var c=$jscomp.propertyToPolyfillSymbol[a];if(null==c)return g[a];c=g[c];return void 0!==c?c:g[a]};
$jscomp.polyfill=function(g,a,c,b){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(g,a,c,b):$jscomp.polyfillUnisolated(g,a,c,b))};$jscomp.polyfillUnisolated=function(g,a,c,b){c=$jscomp.global;g=g.split(".");for(b=0;b<g.length-1;b++){var d=g[b];if(!(d in c))return;c=c[d]}g=g[g.length-1];b=c[g];a=a(b);a!=b&&null!=a&&$jscomp.defineProperty(c,g,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(g,a,c,b){var d=g.split(".");g=1===d.length;b=d[0];b=!g&&b in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var e=0;e<d.length-1;e++){var f=d[e];if(!(f in b))return;b=b[f]}d=d[d.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?b[d]:null;a=a(c);null!=a&&(g?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:a}):a!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+c+"$"+d),$jscomp.defineProperty(b,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:a})))};$jscomp.polyfill("Array.prototype.find",function(g){return g?g:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.dlink=xnm.aio.dlink||{};
xnm.aio.dlink.WifiDevice=function(){var g=function(a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiDevice");a&&(this.ip=a.ip,this.port=a.port,this.port||(this.port=80),this.username=a.username,this.username||(this.username="admin"),this.password=a.password,this.model=a.model,this.mac=a.mac);this._logginTime=this._cookie=this._privateKey=this._challenge=null;this._loginRunning=!1;this._loginCallbacks=[]};g.prototype.HNAP_PATH=
"/HNAP1";g.prototype.HNAP_METHOD="POST";g.prototype.HNAP1_XMLNS="http://purenetworks.com/HNAP1/";g.prototype.HNAP_LOGIN_ACTION="Login";g.prototype.toJSON=function(){return{sys:"dlink",type:"wifi",model:this.model,mac:this.mac,ip:this.ip,port:this.port,username:this.username,password:this.password}};g.prototype.equalsTo=function(a){return a&&a instanceof g?this.type==a.type&&this.data==a.data&&this.ip==a.ip&&this.port==a.port&&this.username==a.username&&this.password==a.password:!1};g.prototype.getStatesCreator=
function(a,c,b){a=[];for(var d=0;d<c.length;d++)if(c[d]&&c[d].id&&c[d].status&&c[d].status.value){var e=c[d].status.value;-1==a.indexOf(e)&&a.push(e)}this._getStates(a,function(f,h){f=[];for(var k=0;k<c.length;k++)if(c[k]&&c[k].id){var l="?";if(h&&c[k].status&&c[k].status.value){var m=c[k].status.value;null!=h[m]&&"undefined"!=typeof h[m]&&(l=h[m])}f.push({id:c[k].id,status:l})}b&&b(null,f)})};g.prototype._getModuleProfile=function(a,c){this._doAction("GetModuleProfile",this._requestBody("GetModuleProfile",
this._moduleParameters(a)),"GetModuleProfileResponse",function(b,d){b?c&&c(b):d?(b=d.find("GetModuleProfileResult"))&&0!=b.length?"OK"!=$(b[0]).text()?c&&c(Error("get module profile fail")):c&&c(null,d):c&&c(Error("get module profile without GetModuleProfileResult")):c&&c(Error("get module profile format error"))})};g.prototype._moduleParameters=function(a){return"<ModuleID>"+a+"</ModuleID>"};g.prototype._doAction=function(a,c,b,d){if(this._logginTime){var e=(new Date).getTime()-this._logginTime;
if(0>e||3E5<e)this._logginTime=this._cookie=this._privateKey=this._challenge=null}if(this._challenge&&this._privateKey&&this._cookie)this._soapAction(a,c,b,d);else{var f=this;this._login(function(h){h?d&&d(h):f._doAction(a,c,b,d)})}};g.prototype._loginRequest=function(){return"<Action>request</Action><Username>"+this.username+"</Username><LoginPassword></LoginPassword><Captcha></Captcha>"};g.prototype._loginParameters=function(){var a=require("x.crypt.js").HMAC_MD5(this._privateKey,this._challenge);
return"<Action>login</Action><Username>"+this.username+"</Username><LoginPassword>"+a.toUpperCase()+"</LoginPassword><Captcha></Captcha>"};g.prototype._handleLoginResult=function(a){var c=a.find("Challenge")[0];if(!c)return!1;this._challenge=c=$(c).text();var b=a.find("PublicKey")[0];if(!b)return!1;b=$(b).text();a=a.find("Cookie")[0];if(!a)return!1;this._cookie=a=$(a).text();this._privateKey=require("x.crypt.js").HMAC_MD5(b+this.password,c).toUpperCase();return!0};g.prototype._login=function(a){a&&
-1==this._loginCallbacks.indexOf(a)&&this._loginCallbacks.push(a);if(!this._loginRunning){this._loginRunning=!0;var c=this;this._soapAction(this.HNAP_LOGIN_ACTION,this._requestBody(this.HNAP_LOGIN_ACTION,this._loginRequest()),"LoginResponse",function(b,d){b?(c._loginRunning=!1,d=c._loginCallbacks,c._loginCallbacks=[],d.forEach(function(e){e&&e(b)})):c._handleLoginResult(d)?(c._logginTime=(new Date).getTime(),c._soapAction(c.HNAP_LOGIN_ACTION,c._requestBody(c.HNAP_LOGIN_ACTION,c._loginParameters()),
"LoginResult",function(e,f){!e&&f&&"success"!=f.text()&&(e=Error("login failed"));c._loginRunning=!1;f=c._loginCallbacks;c._loginCallbacks=[];f.forEach(function(h){h&&h(e)})})):(b=Error("LoginResponse format error"),c._loginRunning=!1,d=c._loginCallbacks,c._loginCallbacks=[],d.forEach(function(e){e&&e(b)}))})}};g.prototype._requestBody=function(a,c){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+
a+' xmlns="'+this.HNAP1_XMLNS+'">'+c+"</"+a+"></soap:Body></soap:Envelope>"};g.prototype._getHnapAuth=function(a,c){var b=Math.round((new Date).getTime()/1E3);return require("x.crypt.js").HMAC_MD5(c,b+a).toUpperCase()+" "+b};g.prototype._soapAction=function(a,c,b,d){var e={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"'+this.HNAP1_XMLNS+a+'"'};this._privateKey&&(e.HNAP_AUTH=this._getHnapAuth('"'+this.HNAP1_XMLNS+a+'"',this._privateKey));this._cookie&&(e.Cookie="uid="+this._cookie);var f=this;
this._doRequest(this.HNAP_METHOD,this.HNAP_PATH,e,c,function(h,k,l){if(h)d&&d(h);else if(401==l)f._logger.log("warn","unauthorized soap action"),f._challenge=null,f._privateKey=null,f._cookie=null,f._login(function(n){n?d&&d(n):f._soapAction(a,c,b,d)});else if(200!=l)f._logger.log("warn","http request error with status code:"+l),d&&d(Error("http request error with status code:"+l));else try{var m=null;$($($.parseXML(k)).children()[0]).find(b).each(function(){m=$(this)});m?d&&d(null,m):d&&d(Error("no response element:"+
b))}catch(n){d&&d(n)}})};g.prototype._doRequest=function(a,c,b,d,e){this._reqBuffer||(this._reqBuffer=[],this._totalReqNo=0);for(var f=0,h=0;h<this._reqBuffer.length;h++)this._reqBuffer[h].running&&f++;a={method:a,path:c,headers:b,data:d,callback:e,running:!1,no:this._totalReqNo++};this._reqBuffer.push(a);10>f&&this._doNextReq()};g.prototype._doNextReq=function(){for(var a=this,c=null,b=0;b<this._reqBuffer.length;b++)if(!this._reqBuffer[b].running){c=this._reqBuffer[b];break}if(c){c.running=!0;var d=
function(e,f,h){c.callback&&c.callback(e,f,h);e=a._reqBuffer.indexOf(d.__req);a._reqBuffer.splice(e,1);a._doNextReq()};d.__req=c;this._doRequest_(c.method,c.path,c.headers,c.data,d)}};g.prototype._doRequest_=function(a,c,b,d,e){var f=this;this._logger.log("trace","send "+a+" to url:http://"+(this.ip+":"+this.port+c));this._logger.log("trace","with headers:"+JSON.stringify(b));this._logger.log("trace","with data:"+d);var h=e;a={host:this.ip,port:this.port,path:c,method:a,headers:b};a.headers||(a.headers=
{});a.headers["Content-Type"]="text/xml";a.headers["Content-Length"]=d.length;a.headers["User-Agent"]="mediola";a.headers.Connection="close";var k="",l=require("http").request(a,function(m){m.on("data",function(n){k+=n});m.on("end",function(){f._logger.log("trace","http reponse status code:"+m.statusCode);f._logger.log("trace","http reponse:"+k);h&&h(null,k,m.statusCode);h=null})});l.setTimeout&&l.setTimeout(2E4,function(){l.abort()});if(l.on&&"function"==typeof l.on)l.on("error",function(m){m||(m=
Error("http request error"));h&&h(m);h=null});l.write(d);l.end()};g.parseJSON=function(a){if(!(a&&"wifi"==a.type&&a.data&&a.ip&&a.password))return null;switch(a.data){case "switch":return new xnm.aio.dlink.WifiPlug(a);case "motion":return new xnm.aio.dlink.WifiMotion(a);case "siren":return new xnm.aio.dlink.WifiSiren(a);case "water":return new xnm.aio.dlink.WifiWater(a);case "hub":return new xnm.aio.dlink.WifiHub(a);default:return null}};return g}();
xnm.aio.dlink.WifiPlug=function(){var g=function(a){xnm.aio.dlink.WifiDevice.call(this,a);this._getSettingsCbs=[];this._getReadyCbs=[];this._getTempCbs=[];this._getPowerCbs=[];this._getTotalPCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiPlug")};g.prototype=new xnm.aio.dlink.WifiDevice;g.prototype.constructor=g;g.prototype.toJSON=function(){var a=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);a.data="switch";
return a};g.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var d=this;switch(c.value){case "on":case "off":xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0)?"on"==c.value?this._on(b):this._off(b):this._getSocketSettings(function(e){e?b&&b(e):d.executeCommandCreator(a,c,b)});break;case "toggle":this._getOnOffState(function(e,f){e?b&&b(e):d.executeCommandCreator(a,{value:"off"==f?"on":"off"},b)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};
g.prototype._controlParameters=function(a,c,b,d){return this._moduleParameters(a)+"<NickName>"+c+"</NickName><Description>"+b+"</Description><OPStatus>"+d+"</OPStatus><Controller>1</Controller>"};g.prototype._on=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),b=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,c.nickName,c.description,!0)),"SetSocketSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("turn plug on failed"));
d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{opStatus:"true"});a&&a(d)})};g.prototype._off=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),b=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,c.nickName,c.description,!1)),"SetSocketSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("turn plug off failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{opStatus:"false"});a&&a(d)})};g.prototype._getStates=
function(a,c){if(a&&0!=a.length)for(var b={},d=0,e=function(){d++;d==a.length&&c&&c(null,b)},f=0;f<a.length;f++)switch(a[f]){case "ready":this._getDeviceReadyState(function(h,k){!h&&k&&(b.ready=k);e()});break;case "state":this._getOnOffState(function(h,k){!h&&k&&(b.state=k);e()});break;case "temp":this._getTempState(function(h,k){!h&&k&&(b.temp=k);e()});break;case "power":this._getCurrentPowerState(function(h,k){!h&&k&&(b.power=k);e()});break;case "totalPower":this._getTotalPowerState(function(h,
k){!h&&k&&(b.totalPower=k);e()});break;default:e()}else c&&c(null,{})};g.prototype._getSocketSettings=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(c&&c.opStatus&&c.nickName&&c.description)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==c){var b=this;this._doAction("GetSocketSettings",this._requestBody("GetSocketSettings",this._moduleParameters(1)),"GetSocketSettingsResponse",function(d,e){var f=
b._getSettingsCbs;b._getSettingsCbs=[];if(d)f.forEach(function(q){q&&q(d)});else if(e){var h=e.find("GetSocketSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k=null,l=null,m=null;e.find("NickName").each(function(){l||(l=$(this).text())});e.find("Description").each(function(){m||(m=$(this).text())});e.find("OPStatus").each(function(){k||(k=$(this).text())});var n={nickName:l,description:m,opStatus:k};xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,n);f.forEach(function(q){q&&q(null,n)})}else d=
Error("get socket settings failed"),f.forEach(function(q){q&&q(d)})}else d=Error("get switch on/off state result format error"),f.forEach(function(q){q&&q(d)})})}};g.prototype._getDeviceReadyState=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(c&&"undefined"!=typeof c.ready&&null!=c.ready)a&&a(null,c.ready);else if(c=this._getReadyCbs.length,a&&-1==this._getReadyCbs.indexOf(a)&&this._getReadyCbs.push(a),0==c){var b=this;this._doAction("IsDeviceReady",this._requestBody("IsDeviceReady",
""),"IsDeviceReadyResult",function(d,e){var f=b._getReadyCbs;b._getReadyCbs=[];if(d)f.forEach(function(k){k&&k(d)});else if(e){var h="OK"==e.text()?"true":"false";xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{ready:h});f.forEach(function(k){k&&k(null,h)})}else d=Error("get device ready state result format error"),f.forEach(function(k){k&&k(d)})})}};g.prototype._getOnOffState=function(a){this._getSocketSettings(function(c,b){c?a&&a(c):(c=b.opStatus,a&&a(null,"true"==c?"on":"false"==c?"off":"?"))})};
g.prototype._getTempState=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(c&&"undefined"!=typeof c.temp&&null!=c.temp)a&&a(null,c.temp);else if(c=this._getTempCbs.length,a&&-1==this._getTempCbs.indexOf(a)&&this._getTempCbs.push(a),0==c){var b=this;this._doAction("GetCurrentTemperature",this._requestBody("GetCurrentTemperature",this._moduleParameters(3)),"CurrentTemperature",function(d,e){var f=b._getTempCbs;b._getTempCbs=[];d?f.forEach(function(h){h&&h(d)}):e?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,
0,{temp:e.text()}),f.forEach(function(h){h&&h(null,e.text())})):(d=Error("get temperature state result format error"),f.forEach(function(h){h&&h(d)}))})}};g.prototype._getCurrentPowerState=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(c&&"undefined"!=typeof c.power&&null!=c.power)a&&a(null,c.power);else if(c=this._getPowerCbs.length,a&&-1==this._getPowerCbs.indexOf(a)&&this._getPowerCbs.push(a),0==c){var b=this;this._doAction("GetCurrentPowerConsumption",this._requestBody("GetCurrentPowerConsumption",
this._moduleParameters(2)),"CurrentConsumption",function(d,e){var f=b._getPowerCbs;b._getPowerCbs=[];d?f.forEach(function(h){h&&h(d)}):e?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{power:e.text()}),f.forEach(function(h){h&&h(null,e.text())})):(d=Error("get current power state result format error"),f.forEach(function(h){h&&h(d)}))})}};g.prototype._getTotalPowerState=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(c&&"undefined"!=typeof c.totalPower&&null!=c.totalPower)a&&
a(null,c.totalPower);else if(c=this._getTotalPCbs.length,a&&-1==this._getTotalPCbs.indexOf(a)&&this._getTotalPCbs.push(a),0==c){var b=this;this._doAction("GetPMWarningThreshold",this._requestBody("GetPMWarningThreshold",this._moduleParameters(2)),"TotalConsumption",function(d,e){var f=b._getTotalPCbs;b._getTotalPCbs=[];d?f.forEach(function(h){h&&h(d)}):e?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{totalPower:e.text()}),f.forEach(function(h){h&&h(null,e.text())})):(d=Error("get total power state result format error"),
f.forEach(function(h){h&&h(d)}))})}};return g}();
xnm.aio.dlink.WifiMotion=function(){var g=function(a){xnm.aio.dlink.WifiDevice.call(this,a);this._getSettingsCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiMotion")};g.prototype=new xnm.aio.dlink.WifiDevice;g.prototype.constructor=g;g.prototype.toJSON=function(){var a=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);a.data="motion";return a};g.prototype.executeCommandCreator=function(a,
c,b){if(c&&c.value){var d=this;switch(c.value){case "activate":case "deactivate":case "actToggle":case "sensTo":case "sensUp":case "sensDown":this._getMotionDetectorSettings(function(e,f){if(e)b&&b(e);else switch(c.value){case "activate":case "deactivate":d._setDetectorActive("activate"==c.value,b);break;case "actToggle":d._setDetectorActive("true"!=f.opStatus,b);break;case "sensTo":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}e=parseInt(c.ext);0>=e&&(e=1);100<
e&&(e=100);d._setDetectorSensitivity(e,b);break;case "sensUp":case "sensDown":e=parseInt(f.sensitivity),e="sensUp"==c.value?e+5:e-5,0>=e&&(e=1),100<e&&(e=100),d._setDetectorSensitivity(e,b)}});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};g.prototype._controlParameters=function(a,c){return this._moduleParameters(a)+"<NickName>"+c.nickName+"</NickName><Description>"+c.description+"</Description><OPStatus>"+c.opStatus+"</OPStatus><Sensitivity>"+c.sensitivity+
"</Sensitivity><Backoff>"+c.backoff+"</Backoff>"};g.prototype._getStates=function(a,c){if(a&&0!=a.length)for(var b={},d=0,e=function(){d++;d==a.length&&c&&c(null,b)},f=0;f<a.length;f++)switch(a[f]){case "active":this._getActiveState(function(h,k){!h&&k&&(b.active=k);e()});break;case "sens":this._getSensitivityState(function(h,k){!h&&k&&(b.sens=k);e()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(h,k){!h&&k&&(b.dectTime=k,b.dectTimeStr=(new Date(1E3*k)).toLocaleString());
e()});break;default:e()}else c&&c(null,{})};g.prototype._setDetectorActive=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=a+"";this._setMotionDetectorSettings(b,c)};g.prototype._setDetectorSensitivity=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.sensitivity=a+"";this._setMotionDetectorSettings(b,c)};g.prototype._setMotionDetectorSettings=function(a,c){var b=this;this._doAction("SetMotionDetectorSettings",this._requestBody("SetMotionDetectorSettings",
this._controlParameters(1,a)),"SetMotionDetectorSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("turn plug on failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,a);c&&c(d)})};g.prototype._getActiveState=function(a){this._getMotionDetectorSettings(function(c,b){c?a&&a(c):(c=b.opStatus,a&&a(null,c))})};g.prototype._getSensitivityState=function(a){this._getMotionDetectorSettings(function(c,b){c?a&&a(c):(c=b.sensitivity,a&&a(null,c))})};g.prototype._getMotionDetectorSettings=function(a){var c=
xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.backoff&&c.sensitivity&&c.opStatus&&c.nickName&&c.description)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==c){var b=this;this._doAction("GetMotionDetectorSettings",this._requestBody("GetMotionDetectorSettings",this._moduleParameters(1)),"GetMotionDetectorSettingsResponse",function(d,e){var f=b._getSettingsCbs;b._getSettingsCbs=[];if(d)f.forEach(function(l){l&&
l(d)});else if(e){var h=e.find("GetMotionDetectorSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k={nickName:null,description:null,opStatus:null,sensitivity:null,backoff:null};e.find("NickName").each(function(){k.nickName=$(this).text()});e.find("Description").each(function(){k.description=$(this).text()});e.find("OPStatus").each(function(){k.opStatus=$(this).text()});e.find("Sensitivity").each(function(){k.sensitivity=$(this).text()});e.find("Backoff").each(function(){k.backoff=$(this).text()});
xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);f.forEach(function(l){l&&l(null,k)})}else d=Error("get socket settings failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get motion detector settings result format error"),f.forEach(function(l){l&&l(d)})})}};g.prototype._getDetectTime=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.lastDetect)a&&a(null,c.lastDetect);else if(c=this._getLastDetectCbs.length,a&&-1==this._getLastDetectCbs.indexOf(a)&&this._getLastDetectCbs.push(a),
0==c){var b=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(d,e){var f=b._getLastDetectCbs;b._getLastDetectCbs=[];if(d)f.forEach(function(l){l&&l(d)});else if(e){var h=e.find("GetLatestDetectionResult");if(h&&h[0]&&"OK"==$(h[0]).text())if((e=e.find("LatestDetectTime"))&&e[0]){var k=$(e[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{lastDetect:k});f.forEach(function(l){l&&l(null,k)})}else d=
Error("get motion detector no LatestDetectTime parameter"),f.forEach(function(l){l&&l(d)});else d=Error("get motion detector last detection failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get motion detector last detection result format error"),f.forEach(function(l){l&&l(d)})})}};return g}();
xnm.aio.dlink.WifiSiren=function(){var g=function(a){xnm.aio.dlink.WifiDevice.call(this,a);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiSiren")};g.prototype=new xnm.aio.dlink.WifiDevice;g.prototype.constructor=g;g.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");g.prototype.toJSON=function(){var a=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);a.data=
"siren";return a};g.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var d=this,e;switch(c.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(function(f,h){if(f)b&&b(f);else switch(c.value){case "activate":case "deactivate":d._setSirenActive("activate"==c.value,function(k){b&&b(k)});break;case "actToggle":d._setSirenActive("true"!=h.opStatus,
function(k){b&&b(k)});break;case "setVolume":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}e=parseInt(c.ext);0>e&&(e=0);100<e&&(e=100);d._setSirenVolumn(e,function(k){b&&b(k)});break;case "volumeUp":case "volumeDown":e=parseInt(h.volume);100<e&&(e=100);e="volumeUp"==c.value?e+5:e-5;0>e&&(e=0);100<e&&(e=100);d._setSirenVolumn(e,function(k){b&&b(k)});break;case "setDuration":case "setDurationP":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));
break}d._setSirenDuration(c.ext,function(k){b&&b(k)});break;case "setTone":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}d._setSirenTone(c.ext,function(k){b&&b(k)});break;case "play":d._doAlarm(function(k){b&&b(k)})}});break;case "stop":this._stopAlarm(function(f){b&&b(f)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};g.prototype._controlParameters=function(a,c,b,d,e,f,h){return this._moduleParameters(a)+"<NickName>"+c+"</NickName><Description>"+
b+"</Description><DefaultSound>"+d+"</DefaultSound><OPStatus>"+f+"</OPStatus><Volume>"+e+"</Volume><Duration>"+h+"</Duration>"};g.prototype._soundPlayParameters=function(a,c,b,d){return this._moduleParameters(a)+"<SoundType>"+c+"</SoundType><Volume>"+b+"</Volume><Duration>"+d+"</Duration><Controller>1</Controller>"};g.prototype._dissmissParameters=function(a){return this._moduleParameters(a)+"<Controller>1</Controller>"};g.prototype._doAlarm=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,
1),b=this;this._doAction("SetSoundPlay",this._requestBody("SetSoundPlay",this._soundPlayParameters(1,c.defaultSound,c.volume,c.duration)),"SetSoundPlayResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("play siren failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{alarm:"true"});a&&a(d)})};g.prototype._stopAlarm=function(a){var c=this;this._doAction("SetAlarmDismissed",this._requestBody("SetAlarmDismissed",this._dissmissParameters(1)),"SetAlarmDismissedResult",function(b,d){b||d&&"OK"==
d.text()||(b=Error("stop siren failed"));b||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,{alarm:"false"});a&&a(b)})};g.prototype._setSirenActive=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=a+"";this._setSirenAlarmSettings(b,c)};g.prototype._setSirenVolumn=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.volume=a+"";this._setSirenAlarmSettings(b,c)};g.prototype._setSirenDuration=function(a,c){switch(a){case "3s":a=3;break;case "10s":a=
10;break;case "30s":a=30;break;case "1min":a=60;break;case "repeat":a=88888;break;default:a=parseInt(a);if(isNaN(a)){c&&c(Error("invalid duration"));return}0>=a&&(a=1);86400<a&&(a=86400)}var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.duration=a+"";this._setSirenAlarmSettings(b,c)};g.prototype._setSirenTone=function(a,c){if(a=this.TONE.indexOf(a)+1){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.defaultSound=a+"";this._setSirenAlarmSettings(b,c)}else c&&c(Error("no such tone"))};
g.prototype._setSirenAlarmSettings=function(a,c){var b=this;this._doAction("SetSirenAlarmSettings",this._requestBody("SetSirenAlarmSettings",this._controlParameters(1,a.nickName,a.description,a.defaultSound,a.volume,a.opStatus,a.duration)),"SetSirenAlarmSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("set siren settings failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,a);c&&c(d)})};g.prototype._getStates=function(a,c){if(a&&0!=a.length)for(var b={},d=0,e=function(){d++;d==
a.length&&c&&c(null,b)},f=this,h=!1,k=0;k<a.length;k++)switch(a[k]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":h?e():(h=!0,this._getSirenAlarmSettings(function(l,m){!l&&m&&(b.active=m.opStatus,b.tone=f.TONE[parseInt(m.defaultSound)-1],b.volume=parseInt(m.volume),999==b.volume&&(b.volume=100),b.alarm=m.alarm,b.duration=parseInt(m.duration),60>b.duration?b.durationStr=b.duration+"s":88888==b.duration||9999==b.duration?b.durationStr="repeat":(l=Math.floor(b.duration/
60),m=b.duration-60*l,b.durationStr=(l?l+"m":"")+(m?m+"s":"")));e()}));break;default:e()}else c&&c(null,{})};g.prototype._getSirenAlarmSettings=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.defaultSound&&c.opStatus&&c.nickName&&c.description&&c.volume&&c.duration&&c.alarm)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==c){var b=this;this._doAction("GetSirenAlarmSettings",this._requestBody("GetSirenAlarmSettings",
this._moduleParameters(1)),"GetSirenAlarmSettingsResponse",function(d,e){var f=b._getSettingsCbs;b._getSettingsCbs=[];if(d)f.forEach(function(l){l&&l(d)});else if(e){var h=e.find("GetSirenAlarmSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};e.find("NickName").each(function(){k.nickName=$(this).text()});e.find("Description").each(function(){k.description=$(this).text()});e.find("OPStatus").each(function(){k.opStatus=
$(this).text()});e.find("Volume").each(function(){k.volume=$(this).text()});e.find("Duration").each(function(){k.duration=$(this).text()});e.find("DefaultSound").each(function(){k.defaultSound=$(this).text()});e.find("IsSounding").each(function(){k.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);f.forEach(function(l){l&&l(null,k)})}else d=Error("get siren settings failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get siren settings result format error"),f.forEach(function(l){l&&
l(d)})})}};return g}();
xnm.aio.dlink.WifiWater=function(){var g=function(a){xnm.aio.dlink.WifiDevice.call(this,a);this._getSettingsCbs=[];this._getStateCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiWater")};g.prototype=new xnm.aio.dlink.WifiDevice;g.prototype.constructor=g;g.prototype.toJSON=function(){var a=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);a.data="water";return a};g.prototype.executeCommandCreator=
function(a,c,b){if(c&&c.value){var d=this;switch(c.value){case "activate":case "deactivate":case "actToggle":this._getWaterDetectorSettings(function(e,f){if(e)b&&b(e);else switch(c.value){case "activate":case "deactivate":d._setDetectorActive("activate"==c.value,b);break;case "actToggle":d._setDetectorActive("true"!=f.opStatus,b)}});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};g.prototype._controlParameters=function(a,c){return this._moduleParameters(a)+
"<NickName>"+c.nickName+"</NickName><Description>"+c.description+"</Description><OPStatus>"+c.opStatus+"</OPStatus>"};g.prototype._setDetectorActive=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=a+"";this._setWaterDetectorSettings(b,c)};g.prototype._setWaterDetectorSettings=function(a,c){var b=this;this._doAction("SetWaterDetectorSettings",this._requestBody("SetWaterDetectorSettings",this._controlParameters(1,a)),"SetWaterDetectorSettingsResult",function(d,e){d||
e&&"OK"==e.text()||(d=Error("turn plug on failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,a);c&&c(d)})};g.prototype._getStates=function(a,c){if(a&&0!=a.length)for(var b={},d=0,e=function(){d++;d==a.length&&c&&c(null,b)},f=0;f<a.length;f++)switch(a[f]){case "active":this._getActiveState(function(h,k){!h&&k&&(b.active=k);e()});break;case "state":this._getWaterDetectorState(function(h,k){!h&&k&&(b.state="true"==k?"water":"dry");e()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(h,
k){!h&&k&&(b.dectTime=k,b.dectTimeStr=(new Date(1E3*k)).toLocaleString());e()});break;default:e()}else c&&c(null,{})};g.prototype._getActiveState=function(a){this._getWaterDetectorSettings(function(c,b){c?a&&a(c):(c=b.opStatus,a&&a(null,c))})};g.prototype._getDetectTime=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.lastDetect)a&&a(null,c.lastDetect);else if(c=this._getLastDetectCbs.length,a&&-1==this._getLastDetectCbs.indexOf(a)&&this._getLastDetectCbs.push(a),0==
c){var b=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(d,e){var f=b._getLastDetectCbs;b._getLastDetectCbs=[];if(d)f.forEach(function(l){l&&l(d)});else if(e){var h=e.find("GetLatestDetectionResult");if(h&&h[0]&&"OK"==$(h[0]).text())if((e=e.find("LatestDetectTime"))&&e[0]){var k=$(e[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{lastDetect:k});f.forEach(function(l){l&&l(null,k)})}else d=
Error("get water detector no LatestDetectTime parameter"),f.forEach(function(l){l&&l(d)});else d=Error("get water detector detection time failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get water detector detection time result format error"),f.forEach(function(l){l&&l(d)})})}};g.prototype._getWaterDetectorState=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.watering)a&&a(null,c.watering);else if(c=this._getStateCbs.length,a&&-1==this._getStateCbs.indexOf(a)&&
this._getStateCbs.push(a),0==c){var b=this;this._doAction("GetWaterDetectorState",this._requestBody("GetWaterDetectorState",this._moduleParameters(1)),"GetWaterDetectorStateResponse",function(d,e){var f=b._getStateCbs;b._getStateCbs=[];if(d)f.forEach(function(l){l&&l(d)});else if(e){var h=e.find("GetWaterDetectorStateResult");if(h&&h[0]&&"OK"==$(h[0]).text())if((e=e.find("IsWater"))&&e[0]){var k=$(e[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{watering:k});f.forEach(function(l){l&&
l(null,k)})}else d=Error("get water detector no IsWater parameter"),f.forEach(function(l){l&&l(d)});else d=Error("get water detector state failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get water detector state result format error"),f.forEach(function(l){l&&l(d)})})}};g.prototype._getWaterDetectorSettings=function(a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(c&&c.opStatus&&c.nickName&&c.description)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&
this._getSettingsCbs.push(a),0==c){var b=this;this._doAction("GetWaterDetectorSettings",this._requestBody("GetWaterDetectorSettings",this._moduleParameters(1)),"GetWaterDetectorSettingsResponse",function(d,e){var f=b._getSettingsCbs;b._getSettingsCbs=[];if(d)f.forEach(function(l){l&&l(d)});else if(e){var h=e.find("GetWaterDetectorSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k={nickName:null,description:null,opStatus:null};e.find("NickName").each(function(){k.nickName=$(this).text()});e.find("Description").each(function(){k.description=
$(this).text()});e.find("OPStatus").each(function(){k.opStatus=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);f.forEach(function(l){l&&l(null,k)})}else d=Error("get water detector settings failed"),f.forEach(function(l){l&&l(d)})}else d=Error("get water detector settings result format error"),f.forEach(function(l){l&&l(d)})})}};return g}();
xnm.aio.dlink.WifiHub=function(){var g=function(a){xnm.aio.dlink.WifiDevice.call(this,a);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiHub")};g.prototype=new xnm.aio.dlink.WifiDevice;g.prototype.constructor=g;g.prototype.toJSON=function(){var a=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);a.data="hub";return a};g.prototype.listZwaveDevice=function(a){this._getModuleProfile(0,function(c,b){if(c)a&&a(c);else{var d=
[];b.find("ModuleProfile").each(function(){var e=$(this),f=e.find("ModuleID");f&&f[0]&&(f=$(f[0]).text());(e=e.find("ModuleSubType"))&&e[0]&&(e=$(e[0]).text());switch(e){case "Contact Sensor":d.push({sys:"dlink",type:"zwave",data:"contact",model:"DCH-Z110",node_id:f.substr(0,f.length-2)});break;case "Motion Detector":d.push({sys:"dlink",type:"zwave",data:"motion",model:"DCH-Z120",node_id:f.substr(0,f.length-2)});break;case "Siren Alarm":d.push({sys:"dlink",type:"zwave",data:"siren",model:"DCH-Z510",
node_id:f.substr(0,f.length-2)})}});a&&a(null,d)}})};g.prototype.executeCommandCreator=function(a,c,b){a?(a=xnm.aio.dlink.ZwaveDevice.parseJSON(a))?a.executeCommand(this,c,b):b&&b(Error("deviceJSON invalid")):b&&b(Error("gateway command not suppoort"))};g.prototype.getStatesCreator=function(a,c,b){for(var d={querys:[],dpts:[]},e={},f,h=0;h<c.length;h++)if(c[h]&&c[h].id&&c[h].device&&c[h].status)if(f=c[h].device,"wifi"==f.type&&"hub"==f.data)d.querys.push(c[h]),(f=c[h].status.value)&&-1==d.dpts.indexOf(f)&&
d.dpts.push(f);else if("zwave"==f.type&&f.data&&f.node_id){var k=f.node_id+"@"+f.data,l=e[k];l||(e[k]={device:f,querys:[]},l=e[k]);l.querys.push(c[h])}var m=this;this._getWifiStatesCreator(a,d,function(n,q){if(n)b&&b(n);else{var r=[];q&&(r=r.concat(q));m._getZwaveStatesCreator(a,e,function(t,p){!t&&p&&(r=r.concat(p));b&&b(null,r)})}})};g.prototype._getWifiStatesCreator=function(a,c,b){if(c&&c.querys&&0!=c.querys.length){var d=c.querys;this._getStates(c.dpts,function(e,f){e=[];for(var h=0;h<d.length;h++)if(d[h]&&
d[h].id){var k="?";if(f&&d[h].status&&d[h].status.value){var l=d[h].status.value;null!=f[l]&&"undefined"!=typeof f[l]&&(k=f[l])}e.push({id:d[h].id,status:k})}b&&b(null,e)})}else b&&b(null,[])};g.prototype._getZwaveStatesCreator=function(a,c,b){var d=[],e=0,f=0,h;for(h in c)c.hasOwnProperty(h)&&c[h]&&(d.push(c[h]),f++);if(0==f)b&&b(null,[]);else{var k=[],l=this,m=function(){e++;e==f&&(b&&b(null,k),b=null)};d.forEach(function(n){if(n.device&&n.querys&&0!=n.querys.length){var q=xnm.aio.dlink.ZwaveDevice.parseJSON(n.device);
q?q.getStatesCreator(l,a,n.querys,function(r,t){!r&&t&&(k=k.concat(t));m()}):m()}else m()})}};g.prototype._getStates=function(a,c){a&&0!=a.length||c&&c(null,{})};return g}();
xnm.aio.dlink._SettingsBuffer={_buffer:{},getSettings:function(g,a){if(!this._buffer[g]||!this._buffer[g][a])return null;g=this._buffer[g][a];a={};var c=Math.round((new Date).getTime()/1E3),b=0,d;for(d in g)if(g.hasOwnProperty(d)){var e=g[d];!e||!e.time||5<c-e.time||(b++,a[d]=e.value)}return b?a:null},setSettings:function(g,a,c){this._buffer[g]||(this._buffer[g]={});this._buffer[g][a]||(this._buffer[g][a]={});var b=Math.round((new Date).getTime()/1E3),d;for(d in c)c.hasOwnProperty(d)&&(this._buffer[g][a][d]||
(this._buffer[g][a][d]={}),this._buffer[g][a][d].value=c[d],this._buffer[g][a][d].time=b)}};
xnm.aio.dlink.ZwaveDevice=function(){var g=function(a){a&&(this.node_id=a.node_id);this._getTempCbs=[];this._getBriCbs=[];this._getBatCbs=[];this._getSabCbs=[]};g.prototype.getStatesCreator=function(a,c,b,d){c=[];for(var e=0;e<b.length;e++)if(b[e]&&b[e].id&&b[e].status&&b[e].status.value){var f=b[e].status.value;-1==c.indexOf(f)&&c.push(f)}this._getStates(a,c,function(h,k){h=[];for(var l=0;l<b.length;l++)if(b[l]&&b[l].id){var m="?";if(k&&b[l].status&&b[l].status.value){var n=b[l].status.value;null!=
k[n]&&"undefined"!=typeof k[n]&&(m=k[n])}h.push({id:b[l].id,status:m})}d&&d(null,h)})};g.prototype._moduleParameters=function(a){return"<ModuleID>"+a+"</ModuleID>"};g.prototype._getTempState=function(a,c,b){this._logger.log("debug","get zwave "+c+" temperature");var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(d&&"undefined"!=typeof d.temp&&null!=d.temp)b&&b(null,d.temp);else{var e=this._getTempCbs.length;b&&-1==this._getTempCbs.indexOf(b)&&this._getTempCbs.push(b);if(0==e){var f=
this;a._doAction("GetCurrentTemperature",a._requestBody("GetCurrentTemperature",this._moduleParameters(c)),"CurrentTemperature",function(h,k){var l=f._getTempCbs;f._getTempCbs=[];h?(f._logger.log("warn","get zwave "+c+" temperature error:"+h.stack),l.forEach(function(m){m&&m(h)})):k?(d||(d={}),d.temp=k.text(),xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,f.node_id,d),l.forEach(function(m){m&&m(null,k.text())})):(f._logger.log("warn","get zwave "+c+" temperature result format error"),h=Error("get contact temperature state result format error"),
l.forEach(function(m){m&&m(h)}))})}}};g.prototype._getBriState=function(a,c,b){this._logger.log("debug","get zwave "+c+" brightness");var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(d&&"undefined"!=typeof d.bri&&null!=d.bri)b&&b(null,d.bri);else{var e=this._getBriCbs.length;b&&-1==this._getBriCbs.indexOf(b)&&this._getBriCbs.push(b);if(0==e){var f=this;a._doAction("GetIllumination",a._requestBody("GetIllumination",this._moduleParameters(c)),"Illumination",function(h,k){var l=
f._getTempCbs;f._getTempCbs=[];h?(f._logger.log("warn","get zwave "+c+" brightness error:"+h.stack),l.forEach(function(m){m&&m(h)})):k?(d||(d={}),d.bri=k.text(),xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,f.node_id,d),l.forEach(function(m){m&&m(null,k.text())})):(f._logger.log("warn","get zwave "+c+" brightness result format error"),h=Error("get contact brightness state result format error"),l.forEach(function(m){m&&m(h)}))})}}};g.prototype._getBatteryState=function(a,c,b){this._logger.log("debug",
"get zwave "+c+" battery");var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(d&&"undefined"!=typeof d.bat&&null!=d.bat)b&&b(null,d.bat);else{var e=this._getBatCbs.length;b&&-1==this._getBatCbs.indexOf(b)&&this._getBatCbs.push(b);if(0==e){var f=this;a._doAction("GetBatteryLevel",a._requestBody("GetBatteryLevel",this._moduleParameters(c)),"BatteryLevel",function(h,k){var l=f._getBatCbs;f._getBatCbs=[];h?(f._logger.log("warn","get zwave "+c+" battery error:"+h.stack),l.forEach(function(m){m&&
m(h)})):k?(d||(d={}),d.bat=k.text(),xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,f.node_id,d),l.forEach(function(m){m&&m(null,k.text())})):(f._logger.log("warn","get zwave "+c+" battery result format error"),h=Error("get contact battery state result format error"),l.forEach(function(m){m&&m(h)}))})}}};g.prototype._getSaboState=function(a,c,b){this._logger.log("debug","get zwave "+c+" sabotage");var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(d&&"undefined"!=typeof d.sabo&&
null!=d.sabo)b&&b(null,d.sabo);else{var e=this._getSabCbs.length;b&&-1==this._getSabCbs.indexOf(b)&&this._getSabCbs.push(b);if(0==e){var f=this;a._doAction("GetTamperSensorState",a._requestBody("GetTamperSensorState",this._moduleParameters(c)),"TamperState",function(h,k){var l=f._getSabCbs;f._getSabCbs=[];h?(f._logger.log("warn","get zwave "+c+" sabotage error:"+h.stack),l.forEach(function(m){m&&m(h)})):k?(d||(d={}),d.sabo=k.text(),xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,f.node_id,d),l.forEach(function(m){m&&
m(null,k.text())})):(f._logger.log("warn","get zwave "+c+" sabotage result format error"),h=Error("get contact sabotage state result format error"),l.forEach(function(m){m&&m(h)}))})}}};g.parseJSON=function(a){if(!a||"zwave"!=a.type||!a.data||!a.node_id)return null;switch(a.data){case "contact":return new xnm.aio.dlink.ZwaveContact(a);case "motion":return new xnm.aio.dlink.ZwaveMotion(a);case "siren":return new xnm.aio.dlink.ZwaveSiren(a);default:return null}};return g}();
xnm.aio.dlink.ZwaveContact=function(){var g=function(a){xnm.aio.dlink.ZwaveDevice.call(this,a);this._getActivCbs=[];this._getOpenCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveContact ")};g.prototype=new xnm.aio.dlink.ZwaveDevice;g.prototype.constructor=g;g.prototype.executeCommand=function(a,c,b){if(c&&c.value){var d=this;switch(c.value){case "activate":case "deactivate":this._setActive(a,"activate"==c.value,
b);break;case "actToggle":this._getActiveState(a,function(e,f){e?b&&b(e):d.executeCommand(a,{value:"true"==f?"deactivate":"activate"},b)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};g.prototype._getStates=function(a,c,b){if(c&&0!=c.length)for(var d={},e=0,f=function(){e++;e==c.length&&b&&b(null,d)},h=0;h<c.length;h++)switch(c[h]){case "active":this._getActiveState(a,function(k,l){!k&&l&&(d.active=l);f()});break;case "state":this._getOpenState(a,function(k,l){!k&&
l&&(d.state=l);f()});break;case "temp":this._getTempState(a,this.node_id+"03",function(k,l){!k&&l&&(d.temp=l);f()});break;case "bri":this._getBriState(a,this.node_id+"04",function(k,l){!k&&l&&(d.bri=l);f()});break;case "bat":this._getBatteryState(a,this.node_id+"05",function(k,l){!k&&l&&(d.bat=l);f()});break;case "sabo":this._getSaboState(a,this.node_id+"02",function(k,l){!k&&l&&(d.sabo=l);f()});break;default:f()}else b&&b(null,{})};g.prototype._controlParameters=function(a,c){return this._moduleParameters(a)+
"<OPStatus>"+c+"</OPStatus>"};g.prototype._setActive=function(a,c,b){var d=this;a._doAction("SetContactSensorSettings",a._requestBody("SetContactSensorSettings",this._controlParameters(this.node_id+"01",c)),"SetContactSensorSettingsResult",function(e,f){e||f&&"OK"==f.text()||(e=Error("activate contact failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,d.node_id,{active:c+""});b&&b(e)})};g.prototype._getActiveState=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);
if(b&&"undefined"!=typeof b.active&&null!=b.active)c&&c(null,b.active);else{var d=this._getActivCbs.length;c&&-1==this._getActivCbs.indexOf(c)&&this._getActivCbs.push(c);if(0==d){var e=this;a._doAction("GetContactSensorSettings",a._requestBody("GetContactSensorSettings",this._moduleParameters(this.node_id+"01")),"OPStatus",function(f,h){var k=e._getActivCbs;e._getActivCbs=[];f?k.forEach(function(l){l&&l(f)}):h?(b||(b={}),b.active=h.text(),xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,e.node_id,b),
c&&c(null,h.text())):(f=Error("get contact active state result format error"),k.forEach(function(l){l&&l(f)}))})}}};g.prototype._getOpenState=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(b&&"undefined"!=typeof b.state&&null!=b.state)c&&c(null,b.state);else{var d=this._getOpenCbs.length;c&&-1==this._getOpenCbs.indexOf(c)&&this._getOpenCbs.push(c);if(0==d){var e=this;a._doAction("GetContactSensorState",a._requestBody("GetContactSensorState",this._moduleParameters(this.node_id+
"01")),"ContactState",function(f,h){var k=e._getOpenCbs;e._getOpenCbs=[];f?k.forEach(function(l){l&&l(f)}):h?(h=h.text(),"true"==h?h="closed":"false"==h&&(h="open"),b||(b={}),b.state=h,xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,e.node_id,b),c&&c(null,h)):(f=Error("get contact open state result format error"),k.forEach(function(l){l&&l(f)}))})}}};return g}();
xnm.aio.dlink.ZwaveMotion=function(){var g=function(a){xnm.aio.dlink.ZwaveDevice.call(this,a);this._getSettingsCbs=[];this._getDetecCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveMotion")};g.prototype=new xnm.aio.dlink.ZwaveDevice;g.prototype.constructor=g;g.prototype.executeCommand=function(a,c,b){if(c&&c.value){var d=this,e;switch(c.value){case "activate":case "deactivate":(e=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,
this.node_id))?this._setMotionDetectorActive(a,"activate"==c.value,function(h){b&&b(h)}):this._getMotionDetectorSettings(a,function(h){h?b&&b(h):d.executeCommand(a,c,b)});break;case "actToggle":this._getMotionDetectorSettings(a,function(h,k){h?b&&b(h):d.executeCommand(a,{value:"true"==k.opStatus?"deactivate":"activate"},b)});break;case "sensTo":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}var f=parseInt(c.ext);1>f&&(f=1);100<f&&(f=100);(e=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,
this.node_id))?this._setMotionDetectorSensitivity(a,f,function(h){b&&b(h)}):this._getMotionDetectorSettings(a,function(h){h?b&&b(h):d.executeCommand(a,c,b)});break;case "sensUp":case "sensDown":this._getMotionDetectorSettings(a,function(h,k){h?b&&b(h):(h=parseInt(k.sensitivity),1==h||100==h?b&&b():("sensUp"==c.value?h+=5:"sensDown"==c.value&&(h-=5),d.executeCommand(a,{value:"sensTo",ext:h},b)))});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};g.prototype._getStates=
function(a,c,b){if(c&&0!=c.length)for(var d={},e=0,f=function(){e++;e==c.length&&b&&b(null,d)},h=!1,k=!1,l=0;l<c.length;l++)switch(c[l]){case "active":case "sens":h?f():(h=!0,this._getMotionDetectorSettings(a,function(m,n){!m&&n&&(d.active=n.opStatus,d.sens=n.sensitivity);f()}));break;case "dectTime":case "dectTimeStr":k?f():(k=!0,this._getLastDetectionState(a,function(m,n){!m&&n&&(d.dectTime=n,n=parseInt(n),d.dectTimeStr=(new Date(1E3*n)).toLocaleString());f()}));break;case "temp":this._getTempState(a,
this.node_id+"03",function(m,n){!m&&n&&(d.temp=n);f()});break;case "bri":this._getBriState(a,this.node_id+"04",function(m,n){!m&&n&&(d.bri=n);f()});break;case "bat":this._getBatteryState(a,this.node_id+"05",function(m,n){!m&&n&&(d.bat=n);f()});break;case "sabo":this._getSaboState(a,this.node_id+"02",function(m,n){!m&&n&&(d.sabo=n);f()});break;default:f()}else b&&b(null,{})};g.prototype._controlParameters=function(a,c,b,d,e,f){return this._moduleParameters(a)+"<NickName>"+c+"</NickName><Description>"+
b+"</Description><Sensitivity>"+d+"</Sensitivity><OPStatus>"+e+"</OPStatus><Backoff>"+f+"</Backoff>"};g.prototype._setMotionDetectorActive=function(a,c,b){var d=this.node_id+"01",e=this,f=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);a._doAction("SetMotionDetectorSettings",a._requestBody("SetMotionDetectorSettings",this._controlParameters(d,f.nickName,f.description,f.sensitivity,c,f.backoff)),"SetMotionDetectorSettingsResult",function(h,k){h||k&&"OK"==k.text()||(h=Error("activate contact failed"));
h||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,e.node_id,{opStatus:c+""});b&&b(h)})};g.prototype._setMotionDetectorSensitivity=function(a,c,b){var d=this.node_id+"01",e=this,f=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);a._doAction("SetMotionDetectorSettings",a._requestBody("SetMotionDetectorSettings",this._controlParameters(d,f.nickName,f.description,c,f.opStatus,f.backoff)),"SetMotionDetectorSettingsResult",function(h,k){h||k&&"OK"==k.text()||(h=Error("activate contact failed"));
h||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,e.node_id,{sensitivity:c+""});b&&b(h)})};g.prototype._getMotionDetectorSettings=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);if(b&&b.sensitivity&&b.opStatus&&b.nickName&&b.description&&b.backoff)c&&c(null,b);else if(b=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&this._getSettingsCbs.push(c),0==b){var d=this;a._doAction("GetMotionDetectorSettings",a._requestBody("GetMotionDetectorSettings",
this._moduleParameters(this.node_id+"01")),"GetMotionDetectorSettingsResponse",function(e,f){var h=d._getSettingsCbs;d._getSettingsCbs=[];if(e)h.forEach(function(p){p&&p(e)});else if(f){var k=f.find("GetMotionDetectorSettingsResult");if(k&&k[0]&&"OK"==$(k[0]).text()){var l=null,m=null,n=null,q=null,r=null;f.find("NickName").each(function(){n||(n=$(this).text())});f.find("Description").each(function(){q||(q=$(this).text())});f.find("OPStatus").each(function(){l||(l=$(this).text())});f.find("Sensitivity").each(function(){m||
(m=$(this).text())});f.find("Backoff").each(function(){r||(r=$(this).text())});var t={nickName:n,description:q,opStatus:l,sensitivity:m,backoff:r};xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,d.node_id,t);h.forEach(function(p){p&&p(null,t)})}else e=Error("get contact settings failed"),h.forEach(function(p){p&&p(e)})}else e=Error("get contact settings result format error"),h.forEach(function(p){p&&p(e)})})}};g.prototype._getLastDetectionState=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,
this.node_id);if(b&&b.dectTime)c&&c(null,b.dectTime);else if(b=this._getDetecCbs.length,c&&-1==this._getDetecCbs.indexOf(c)&&this._getDetecCbs.push(c),0==b){var d=this;a._doAction("GetLatestDetection",a._requestBody("GetLatestDetection",this._moduleParameters(this.node_id+"01")),"LatestDetectTime",function(e,f){var h=d._getDetecCbs;d._getDetecCbs=[];e?h.forEach(function(k){k&&k(e)}):f?(xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,d.node_id,{dectTime:f.text()}),h.forEach(function(k){k&&k(null,f.text())})):
(e=Error("get contact open state result format error"),h.forEach(function(k){k&&k(e)}))})}};return g}();
xnm.aio.dlink.ZwaveSiren=function(){var g=function(a){xnm.aio.dlink.ZwaveDevice.call(this,a);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveSiren")};g.prototype=new xnm.aio.dlink.ZwaveDevice;g.prototype.constructor=g;g.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");g.prototype.executeCommand=function(a,c,b){if(c&&c.value){var d=this,e;switch(c.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(a,
function(f,h){if(f)b&&b(f);else switch(c.value){case "activate":case "deactivate":d._setSirenActive(a,"activate"==c.value,function(k){b&&b(k)});break;case "actToggle":d._setSirenActive(a,"true"!=h.opStatus,function(k){b&&b(k)});break;case "setVolume":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}e=parseInt(c.ext);0>e&&(e=0);100<e&&(e=100);d._setSirenVolumn(a,e,function(k){b&&b(k)});break;case "volumeUp":case "volumeDown":e=parseInt(h.volume);100<e&&(e=100);e=
"volumeUp"==c.value?e+5:e-5;0>e&&(e=0);100<e&&(e=100);d._setSirenVolumn(a,e,function(k){b&&b(k)});break;case "setDuration":case "setDurationP":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}d._setSirenDuration(a,c.ext,function(k){b&&b(k)});break;case "setTone":if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command ext invalid"));break}d._setSirenTone(a,c.ext,function(k){b&&b(k)});break;case "play":d._doAlarm(a,function(k){b&&b(k)})}});break;case "stop":this._stopAlarm(a,
function(f){b&&b(f)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};g.prototype._controlParameters=function(a,c,b,d,e,f,h){return this._moduleParameters(a)+"<NickName>"+c+"</NickName><Description>"+b+"</Description><DefaultSound>"+d+"</DefaultSound><OPStatus>"+f+"</OPStatus><Volume>"+e+"</Volume><Duration>"+h+"</Duration>"};g.prototype._soundPlayParameters=function(a,c,b,d){return this._moduleParameters(a)+"<SoundType>"+c+"</SoundType><Volume>"+b+"</Volume><Duration>"+
d+"</Duration><Controller>1</Controller>"};g.prototype._dissmissParameters=function(a){return this._moduleParameters(a)+"<Controller>1</Controller>"};g.prototype._doAlarm=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id),d=this;a._doAction("SetSoundPlay",a._requestBody("SetSoundPlay",this._soundPlayParameters(this.node_id+"09",b.defaultSound,b.volume,b.duration)),"SetSoundPlayResult",function(e,f){e||f&&"OK"==f.text()||(e=Error("play siren failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,
d.node_id,{alarm:"true"});c&&c(e)})};g.prototype._stopAlarm=function(a,c){var b=this;a._doAction("SetAlarmDismissed",a._requestBody("SetAlarmDismissed",this._dissmissParameters(this.node_id+"09")),"SetAlarmDismissedResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("stop siren failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,b.node_id,{alarm:"false"});c&&c(d)})};g.prototype._setSirenActive=function(a,c,b){var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);d.opStatus=c+
"";this._setSirenAlarmSettings(a,d,b)};g.prototype._setSirenVolumn=function(a,c,b){var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);d.volume=c+"";this._setSirenAlarmSettings(a,d,b)};g.prototype._setSirenDuration=function(a,c,b){switch(c){case "30s":c=30;break;case "60s":c=60;break;case "90s":c=90;break;case "3min":c=180;break;case "repeat":c=88888;break;default:c=parseInt(c);if(isNaN(c)){b&&b(Error("invalid duration"));return}0>=c&&(c=1);86400<c&&(c=86400)}var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,
this.node_id);d.duration=c+"";this._setSirenAlarmSettings(a,d,b)};g.prototype._setSirenTone=function(a,c,b){if(c=this.TONE.indexOf(c)+1){var d=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,this.node_id);d.defaultSound=c+"";this._setSirenAlarmSettings(a,d,b)}else b&&b(Error("no such tone"))};g.prototype._setSirenAlarmSettings=function(a,c,b){var d=this;a._doAction("SetSirenAlarmSettings",a._requestBody("SetSirenAlarmSettings",this._controlParameters(this.node_id+"09",c.nickName,c.description,c.defaultSound,
c.volume,c.opStatus,c.duration)),"SetSirenAlarmSettingsResult",function(e,f){e||f&&"OK"==f.text()||(e=Error("set siren settings failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,d.node_id,c);b&&b(e)})};g.prototype._getStates=function(a,c,b){if(c&&0!=c.length)for(var d={},e=0,f=function(){e++;e==c.length&&b&&b(null,d)},h=this,k=!1,l=0;l<c.length;l++)switch(c[l]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":k?f():(k=!0,this._getSirenAlarmSettings(a,
function(m,n){!m&&n&&(d.active=n.opStatus,d.tone=h.TONE[parseInt(n.defaultSound)-1],d.volume=parseInt(n.volume),999==d.volume&&(d.volume=100),d.alarm=n.alarm,d.duration=parseInt(n.duration),180>d.duration?d.durationStr=d.duration+"s":88888==d.duration||9999==d.duration?d.durationStr="repeat":(m=Math.floor(d.duration/60),n=d.duration-60*m,d.durationStr=(m?m+"m":"")+(n?n+"s":"")));f()}));break;default:f()}else b&&b(null,{})};g.prototype._getSirenAlarmSettings=function(a,c){var b=xnm.aio.dlink._SettingsBuffer.getSettings(a.ip,
this.node_id);if(b&&b.defaultSound&&b.opStatus&&b.nickName&&b.description&&b.volume&&b.duration&&b.alarm)c&&c(null,b);else if(b=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&this._getSettingsCbs.push(c),0==b){var d=this;a._doAction("GetSirenAlarmSettings",a._requestBody("GetSirenAlarmSettings",this._moduleParameters(this.node_id+"09")),"GetSirenAlarmSettingsResponse",function(e,f){var h=d._getSettingsCbs;d._getSettingsCbs=[];if(e)h.forEach(function(m){m&&m(e)});else if(f){var k=
f.find("GetSirenAlarmSettingsResult");if(k&&k[0]&&"OK"==$(k[0]).text()){var l={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};f.find("NickName").each(function(){l.nickName=$(this).text()});f.find("Description").each(function(){l.description=$(this).text()});f.find("OPStatus").each(function(){l.opStatus=$(this).text()});f.find("Volume").each(function(){l.volume=$(this).text()});f.find("Duration").each(function(){l.duration=$(this).text()});f.find("DefaultSound").each(function(){l.defaultSound=
$(this).text()});f.find("IsSounding").each(function(){l.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,d.node_id,l);h.forEach(function(m){m&&m(null,l)})}else e=Error("get siren settings failed"),h.forEach(function(m){m&&m(e)})}else e=Error("get contact settings result format error"),h.forEach(function(m){m&&m(e)})})}};return g}();
xnm.aio.dlink.DM=function(){var g=function(b,d){this.code=b;this.message=d;this.stack=Error().stack};g.prototype=Error();g.prototype.name="DlinkDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"device ready",ref:{value:"ready",options:["true",
"false"]}},{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"float",name:"current consumption",ref:{value:"power"}},{type:"float",name:"total consumption",ref:{value:"totalPower"}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",
ext:"%d",extMeta:"1-100"}},{type:"enum",name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",
ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["3s","10s","30s","1min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",
ext:"%d",extMeta:"1-86400",unit:"s"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]},water:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["water",
"dry"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}}]}},c={contact:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},
{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",ext:"%d",extMeta:"1-100"}},{type:"enum",
name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}},{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",
ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["30s","60s","90s","3min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",extMeta:"1-86400",unit:"s"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]}};return{SYS:"dlink",getIPDeviceType:function(){return[{sys:this.SYS,name:"mydlink Connected Home",port:80}]},getGatewayType:function(){return{sys:this.SYS,name:"mydlink Connected Home Hub",port:80}},getGatewayDeviceType:function(b){return[{sys:this.SYS,data:"contact",name:"Home Door/Window Sensor"},{sys:this.SYS,data:"motion",name:"Battery Motion Sensor"},{sys:this.SYS,data:"siren",
name:"Siren"}]},createGateway:function(b,d,e){d=g.ERROR_CODE;b?b.ip?b.password?e(null,b):e(new g(d.INVALID,"password is invalid")):e(new g(d.INVALID,"ip is invalid")):e(new g(d.INVALID,"info is invalid"))},updateGateway:function(b,d,e,f){b=g.ERROR_CODE;d?d.ip?d.password?f(null,d):f(new g(b.INVALID,"password is invalid")):f(new g(b.INVALID,"ip is invalid")):f(new g(b.INVALID,"update is invalid"))},deleteGateway:function(b,d,e){e()},createDevice:function(b,d,e){var f=g.ERROR_CODE;if(b)if(b.type)if(b.data){if("wifi"==
b.type){if(!b.ip){e(new g(f.INVALID,"ip is invalid"));return}if(!b.password){e(new g(f.INVALID,"password is invalid"));return}}else if("zwave"==b.type){if(!b.gateway){e(new g(f.INVALID,"gateway is invalid"));return}if(!b.node_id){e(new g(f.INVALID,"node_id is invalid"));return}if(!d.data||!d.data.gateways||0===d.data.gateways.length){e(new g(f.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));return}d=d.data.gateways;var h;for(h=0;h<d.length;h++)if(d[h].index===b.gateway){var k=d[h];break}if(!k){e(new g(f.NOT_FOUND,
"gateway with index "+b.gateway+" not exists"));return}}e(null,b)}else e(new g(f.INVALID,"data is invalid"));else e(new g(f.INVALID,"type is invalid"));else e(new g(f.INVALID,"info is invalid"))},updateDevice:function(b,d,e){var f=g.ERROR_CODE;if(b)if(b.type)if(b.data){if("wifi"==b.type){if(!b.ip){e(new g(f.INVALID,"ip is invalid"));return}if(!b.password){e(new g(f.INVALID,"password is invalid"));return}}else if("zwave"==b.type){if(!b.gateway){e(new g(f.INVALID,"gateway is invalid"));return}if(!b.node_id){e(new g(f.INVALID,
"node_id is invalid"));return}if(!d.data||!d.data.gateways||0===d.data.gateways.length){e(new g(f.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));return}d=d.data.gateways;var h;for(h=0;h<d.length;h++)if(d[h].index===b.gateway){var k=d[h];break}if(!k){e(new g(f.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));return}}e(null,b)}else e(new g(f.INVALID,"data is invalid"));else e(new g(f.INVALID,"type is invalid"));else e(new g(f.INVALID,"info is invalid"))},deleteDevice:function(b,
d,e){e()},applyUIFilter:function(b,d,e){var f=this,h=function(n,q,r){var t=[];n.forEach(function(p){if("root"==p.type){p=JSON.parse(JSON.stringify(p));var u=h(p.children,q,r);u&&0<u.length&&(p.children=u,t.push(p))}else{u=r.elems;if("*"==u)u=!0;else{for(var w=!1,v=0;v<u.length;v++)if(u[v]==p.type){w=!0;break}u=w}u&&(p=JSON.parse(JSON.stringify(p)),t.push(p))}});return t},k=function(n,q){var r=[],t=f.getCommandStatusMap(n,e);if(t){var p=[];switch(q.catagory){case "command":t.command&&(p=h(t.command,
n,q));break;case "status":t.status&&(p=h(t.status,n,q))}r=r.concat(p)}return r};if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),m=null;switch(d.catagory){case "command":m=k(b,d);l.command=m;break;case "status":m=k(b,d);l.status=m;break;default:return null}return m&&0!=m.length?l:null},getCommandStatusMap:function(b){return b&&b.type&&b.data?"wifi"==b.type?a[b.data]:"zwave"==b.type?c[b.data]:null:null}}}();
xnm.aio.dlink.Handler=function(){var g=function(){};g.prototype.WifiPlug=xnm.aio.dlink.WifiPlug;g.prototype.WifiMotion=xnm.aio.dlink.WifiMotion;g.prototype.WifiSiren=xnm.aio.dlink.WifiSiren;g.prototype.WifiWater=xnm.aio.dlink.WifiWater;g.prototype.WifiHub=xnm.aio.dlink.WifiHub;g.prototype.devicemanager=xnm.aio.dlink.DM;g.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"dlink")};g.prototype.resolveGateway=function(a){return a?"wifi"==a.type&&"hub"==a.data?xnm.aio.dlink.WifiDevice.parseJSON(a):
null:null};g.prototype.resolveDevice=function(a){if(!a)return null;switch(a.type){case "wifi":return xnm.aio.dlink.WifiDevice.parseJSON(a);default:return null}};g.prototype.getDeviceCommands=function(a,c){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];c&&c(null,a)};g.prototype.getDeviceStatus=function(a,c){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];c&&c(null,a)};g.prototype.doCommand=function(a,c,b,d){(a=a?this.resolveGateway(a):
this.resolveDevice(c))?a.executeCommandCreator(c,b,function(e){d&&d(e)}):d&&d(Error("gateway/device json format invalid"))};g.prototype.doStatus=function(a,c,b,d,e){(c=c?this.resolveGateway(c):this.resolveDevice(b))?c.getStatesCreator(null,[{id:a,device:b,status:d}],function(f,h){f?e&&e(f):e&&e(null,h[0])}):e&&e(Error("device json format invalid"))};g.prototype.discoverWifiDevice=function(a,c){var b=require("x.mdns.js");b.clearRecordBuffer();b.discoverServiceWithTimeout("_dhnap._tcp.local",a,function(d,
e){if(d)c&&c(d);else{for(var f=[],h=0;h<e.length;h++){var k=e[h],l=null;if(k.info&&k.ip&&0<k.ip.length){var m={ip:k.ip[0],mac:k.info.mac,model:k.info.model_number};switch(k.info.model_number){case "DSP-W215":l=new xnm.aio.dlink.WifiPlug(m);break;case "DCH-G020":l=new xnm.aio.dlink.WifiHub(m);break;case "DCH-S150":l=new xnm.aio.dlink.WifiMotion(m);break;case "DCH-S220":l=new xnm.aio.dlink.WifiSiren(m);break;case "DCH-S160":l=new xnm.aio.dlink.WifiWater(m)}l&&f.push(l)}}c&&c(d,f)}})};g.prototype.listZwaveDevice=
function(a,c){(a=this.resolveGateway(a))?a.listZwaveDevice(c):c&&c(Error("gateway json format invalid"))};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.dlink.Handler);
