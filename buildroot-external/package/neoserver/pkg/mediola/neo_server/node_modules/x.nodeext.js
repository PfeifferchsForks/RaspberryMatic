var http=require("http"),fs=require("fs");
http._getFileFallback=function(e,b,a){var d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,c=d+Math.random().toString(36).substring(2);fs.existsSync(d)||fs.mkdirSync(d);d=require("url").parse(e);var f=80,l=!1;if(d.port){f=parseInt(d.port);if(0===f||isNaN(f))f=80;if(!(0<f&&65536>f)){a&&a(null);return}l=!0}var n=d.hostname,g=d.path,m;"https"==e.substring(0,5).toLowerCase()&&(l||(f=443));b&&b.user&&(m=b.user+":"+b.password);null==f&&(f=80);var k="",h=0,q=!1,r=require("net").connect({port:f,
host:n},function(){var p="GET "+g+" HTTP/1.1\r\n";p+="Host: "+n+"\r\n";m&&(p+="Authorization: Basic "+(new Buffer(m)).toString("base64")+"\r\n");r.write(p+"Connection: close\r\n\r\n")});r.on("data",function(p){if(q)fs.appendFileSync(c,p);else{h=k.length;k+=p.toString();var t=k.indexOf("\n\r\n");-1==t&&(t=k.indexOf("\n\n"));if(-1!=t){var u=k.indexOf("\n",t+1);q=!0;fs.writeFileSync(c,p.slice(u-h+1));k=k.substr(0,t)}}});r.on("end",function(){fs.existsSync(c)?a(c):a(null)});r.on("error",function(){a(null)})};
http.getFile=function(e,b,a,d,c){"undefined"==typeof c&&(c={});"undefined"==typeof c.encodeURL&&(c.encodeURL=!0);var f=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,l=f+Math.random().toString(36).substring(2);try{fs.existsSync(f)||fs.mkdirSync(f)}catch(h){a&&a(h);return}var n=require("url").parse(e),g=80;f=!1;if(n.port){g=parseInt(n.port);if(0===g||isNaN(g))g=80;if(!(0<g&&65536>g)){a&&a(null);return}f=!0}var m={host:n.hostname,port:g,path:c.encodeURL?encodeURI(decodeURI(n.path)):
n.path,method:"GET",headers:{}};b&&b.headers&&(m.headers=b.headers);b&&b.user&&(m.auth=b.user+":"+b.password);d&&(m.headers.Authorization=d);var k=require("http");c=k;"https"==e.substring(0,5).toLowerCase()&&(c=require("https"),f||(m.port=443));c=c.request(m,function(h){if(200==h.statusCode){var q=fs.createWriteStream(l);h.pipe(q);q.on("finish",function(){q.end();a(l)});q.on("error",function(){q.end()})}else 301==h.statusCode||302==h.statusCode?h.headers.location?(k.getFile(h.headers.location,b,a,
null,{encodeURL:!1}),h.destroy()):a&&a(null,h):401!=h.statusCode||d?a(null,h):(d=null,h.headers&&h.headers["www-authenticate"]&&"Digest "==h.headers["www-authenticate"].substr(0,7)?(d=require("x.crypt.js").DigestAuth(h.headers["www-authenticate"],m.path,b.user,b.password))?k.getFile(e,b,a,d):a&&a(null,h):a&&a(null,h))});c.on("error",function(h){XC.debugf(h);k._getFileFallback(e,b,a)});c.end()};
http.postFile=function(e,b,a,d){var c=require("url").parse(b),f=80,l=!1;if(c.port){f=parseInt(c.port);if(0===f||isNaN(f))f=80;if(!(0<f&&65536>f)){d&&d(null);return}l=!0}c={host:c.hostname,port:f,path:c.path,method:"POST",headers:{Connection:"close","Content-Type":"application/octet-stream"}};a&&a.user&&(c.auth=a.user+":"+a.password);if(a&&a.headers)for(var n in a.headers)c.headers[n]=a.headers[n];a=require("http");"https"==b.substring(0,5).toLowerCase()&&(a=require("https"),l||(c.port=443));var g=
a.request(c,function(k){d&&d(k)});try{var m=fs.createReadStream(e);m.pipe(g);m.on("finish",function(){m.close()});m.on("error",function(k){m.close();g.emit("error",k)})}catch(k){g.emit("error",k)}return g};
http.getFileAIOCloud=function(e,b,a,d,c){"undefined"==typeof c&&(c={});c=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep;var f=c+Math.random().toString(36).substring(2);try{fs.existsSync(c)||fs.mkdirSync(c)}catch(r){a&&a(r);return}var l=require("url").parse(e),n=80;c=!1;if(l.port){n=parseInt(l.port);if(0===n||isNaN(n))n=80;if(!(0<n&&65536>n)){a&&a(null);return}c=!0}var g={host:l.hostname,port:n,path:l.path,method:"GET",headers:{}};if(b&&b.url){"?"==g.path[g.path.length-1]&&(g.path=
g.path.substring(0,g.path.length-1));l=!0;for(var m in b.url)g.path+=l?"?":"&",g.path+=m+"="+encodeURIComponent(b.url[m]),l=!1}b&&b.user&&(g.auth=b.user+":"+b.password);d&&(g.headers.Authorization=d);var k=require("http"),h=k;"https"==e.substring(0,5).toLowerCase()&&(h=require("https"),c||(g.port=443));var q=fs.createWriteStream(f);q.on("error",function(r){XC.debugf(r.message,"error");q.end()});q.on("finish",function(){q.end();a(f)});q.on("open",function(){var r=h.request(g,function(p){200==p.statusCode?
p.pipe(q):302==p.statusCode?p.headers.location?(delete b.url,k.getFile(p.headers.location,b,a,null,{encodeURL:!1}),p.destroy()):a&&a(null):401!=p.statusCode||d?a(null):(d=null,p.headers&&p.headers["www-authenticate"]&&"Digest "==p.headers["www-authenticate"].substr(0,7)?(d=require("x.crypt.js").DigestAuth(p.headers["www-authenticate"],g.path,b.user,b.password))?k.getFile(e,b,a,d):a&&a(null):a&&a(null))});r.on("error",function(p){XC.debugf(p,"error");k._getFileFallback(e,b,a)});r.end()})};
fs.readFileLine=function(e,b,a){fs.readFile(e,function(d,c){d=!1;c=c.toString("utf-8").split("\n");c[b-1]&&(a(null,c[b-1]),d=!0);d||a("failed",null)})};fs.readFileBinary=function(e,b,a,d){fs.open(e,"r",function(c,f){fs.fstat(f,function(l,n){l=n.size;b>=l?(fs.closeSync?fs.closeSync(f):fs.close(f),d(null,"")):(b+a>l&&(a=l-b),1024<a&&(a=1024),l=new Buffer(a),fs.read(f,l,0,a,b,function(g,m,k){m=k.toString("hex");fs.closeSync?fs.closeSync(f):fs.close(f);g?d("failed",null):d(null,m)}))})})};
fs.rmdirRecursiveSync=function(e){var b=[];fs.existsSync(e)&&(b=fs.readdirSync(e),b.forEach(function(a,d){a=e+"/"+a;fs.lstatSync(a).isDirectory()?fs.rmdirRecursiveSync(a):fs.unlinkSync(a)}),fs.rmdirSync(e))};fs.mkdirRecursiveSync=function(e){var b=require("path");fs.existsSync(b.dirname(e))||fs.mkdirRecursiveSync(b.dirname(e));fs.existsSync(e)||fs.mkdirSync(e)};fs.copyFileSync=function(e,b){var a=b.substring(0,b.lastIndexOf("/"));fs.mkdirRecursiveSync(a);fs.writeFileSync(b,fs.readFileSync(e))};
fs.dataPath=function(){var e=null;try{e=require("nw.gui")}catch(b){}return"object"==typeof nw&&null!==nw&&nw.App?nw.App.dataPath+require("path").sep+"..":e?e.App.dataPath:process.cwd()};if("undefined"===typeof localStorage||null===localStorage){localStorage=null;try{var ls=require("node-localstorage").LocalStorage;localStorage=new ls("./localstorage")}catch(e){}};
