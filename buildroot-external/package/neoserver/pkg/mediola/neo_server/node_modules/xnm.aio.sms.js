var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sms=xnm.aio.sms||{};
xnm.aio.sms.Handler=function(){var n="http://webservice.aio-control.com/smsservice",t="https://webservice.mediola.com/cloudservice",r={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c=0;for(a=r._utf8_encode(a);c<a.length;){var d=a.charCodeAt(c++);var e=a.charCodeAt(c++);var f=a.charCodeAt(c++);var g=d>>2;d=(d&3)<<4|e>>4;var k=(e&15)<<2|f>>6;var l=f&63;isNaN(e)?k=l=64:isNaN(f)&&(l=64);b=b+this._keyStr.charAt(g)+this._keyStr.charAt(d)+this._keyStr.charAt(k)+
this._keyStr.charAt(l)}return b},decode:function(a){var b="",c=0;for(a=a.replace(/[^A-Za-z0-9\+\/=]/g,"");c<a.length;){var d=this._keyStr.indexOf(a.charAt(c++));var e=this._keyStr.indexOf(a.charAt(c++));var f=this._keyStr.indexOf(a.charAt(c++));var g=this._keyStr.indexOf(a.charAt(c++));d=d<<2|e>>4;e=(e&15)<<4|f>>2;var k=(f&3)<<6|g;b+=String.fromCharCode(d);64!=f&&(b+=String.fromCharCode(e));64!=g&&(b+=String.fromCharCode(k))}return b=r._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,
"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0;for(c1=c2=0;c<a.length;){var d=a.charCodeAt(c);128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+
2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3)}return b}},h=function(){};h.prototype.setURL=function(a){n=a};h.prototype.setCloudServiceURL=function(a){t=a};h.prototype.registAllUndeliveredPurchase=function(a,b){var c=this;this._getUndeliveredPurchase(function(d,e){XC.debugf("deliver unregest ps");XC.debugf(d);XC.debugf(e);if(d)b&&b(d);else if(e&&0!=e.length){XC.debugf("registAllSmsPurchase purchases:"+JSON.stringify(e));d=[];for(var f=[],g=0;g<e.length;g++){var k=e[g];if(c._isSmsPurchase(k)){var l=
c._getSmsCount(k);l&&(k.smsTotalCount=l,k.sid=a,d.push(k))}else c._isCloudServicePurchase(k)&&(l=c._getCloudServiceDuration(k))&&(k.duration=l,f.push(k))}var p=2,q=null;c._handleSms(d,function(m){p--;m&&(q=m);0==p&&b&&b(q)});c._handleCloudService(f,function(m){p--;m&&(q=m);0==p&&b&&b(q)})}else b&&b()})};h.prototype._handleSms=function(a,b){if(!a||0>=a.length)b&&b();else{var c=this;this._registSmsPurchases(a,function(d){d?b&&b(d):c._purchasesDelivered(a,function(e){b&&b(e)})})}};h.prototype._handleCloudService=
function(a,b){if(!a||0>=a.length)b&&b();else{var c=this;this._registCloudServicePurchases(a,function(d){d?b&&b(d):c._purchasesDelivered(a,function(e){b&&b(e)})})}};h.prototype.getSmsInfo=function(a,b){var c=require("url").parse(n);a={host:c.hostname,port:c.port,path:c.path+"/gatewaysmsinfo?sid="+a,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a=require("http").request(a,function(d){d.setEncoding("utf-8");var e="";d.on("data",function(f){e+=f});d.on("end",
function(){if(200!=d.statusCode){var f=Error("http response:"+d.statusCode);b&&b(f)}else if(e)try{f=JSON.parse(e),b&&b(null,f)}catch(g){b&&b(g)}else f=Error("server response is empty"),b&&b(f)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(d){b&&b(d?d:Error("http error"))});a.end()};h.prototype.setSmsActive=function(a,b,c){var d=require("url").parse(n);a={host:d.hostname,port:d.port,path:d.path+"/activatesms?sid="+a+"&active="+b,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',
Connection:"close"}};a=require("http").request(a,function(e){e.setEncoding("utf-8");var f="";e.on("data",function(g){f+=g});e.on("end",function(){var g;200!=e.statusCode&&(g=Error("http response:"+e.statusCode));c&&c(g,f)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(e){c&&c(e?e:Error("http error"))});a.end()};h.prototype._getUndeliveredPurchase=function(a){XC.callHost("inapppurchase","getUndeliveredPurchase",null,function(b){b?b.error?a&&a(Error(b.error)):b.value?a&&a(null,b.value):
a&&a(null,[]):a&&a(Error("result is null"))})};h.prototype._registSmsPurchases=function(a,b){a=this._encrypt2base64(JSON.stringify(a));var c=require("url").parse(n);XC.debugf("registAllSmsPurchase ud:"+JSON.stringify(c));c={host:c.hostname,port:c.port,path:c.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};c=require("http").request(c,function(d){d.setEncoding("utf-8");var e="";d.on("data",function(f){e+=f});d.on("end",function(){var f;200!=d.statusCode&&
(f=Error("http response:"+d.statusCode));b&&b(f,e)})});c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(d){b&&b(d?d:Error("http error"))});c.write(a);c.end()};h.prototype._registCloudServicePurchases=function(a,b){a=this._encrypt2base64(JSON.stringify(a));var c=require("url").parse(t),d=c.port;-1!=c.protocol.indexOf("https")&&80==d&&(d=443);XC.debugf("regist cloud service purchase ud:"+JSON.stringify(c));c={host:c.hostname,port:d,path:c.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',
Connection:"close"}};c=require("https").request(c,function(e){e.setEncoding("utf-8");var f="";e.on("data",function(g){f+=g});e.on("end",function(){var g;200!=e.statusCode&&(g=Error("http response:"+e.statusCode));b&&b(g,f)})});c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(e){b&&b(e?e:Error("http error"))});c.write(a);c.end()};h.prototype._encrypt2base64=function(a){var b=require("x.crypt.js");a=r.encode(a);for(var c="",d=0,e=a.length,f;d<e;d+=1)f=a.charCodeAt(d),c+=f.toString(16);
a=b.AES.h2a(c);b.AES.setSize(128);c=b.AES.h2a("CB1CC15198F09B7D9EA80892A870399E");d=b.AES.h2a("D0648681F88076B43CE216E0686A02DD");a=b.AES.encrypt(a,c,d);return b.AES.a2h(a)};h.prototype._purchasesDelivered=function(a,b){var c=a.length;if(c)for(var d=null,e=0;e<a.length;e++)this._purchaseDelivered(a[e].orderId,function(f){c--;d||(d=f);0==c&&b&&b(d)});else b&&b()};h.prototype._purchaseDelivered=function(a,b){a?XC.callHost("inapppurchase","purchaseDelivered",{orderId:a},function(c){c?c.error?b&&b(Error(c.error)):
b&&b(null,c.value):b&&b(Error("result is null"))}):b&&b(Error("order id is empty"))};h.prototype._isSmsPurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".sms."):!1};h.prototype._isCloudServicePurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".cloudservice"):!1};h.prototype._getSmsCount=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==a.productId)return 50;a=a.productId;
var b=a.indexOf(".sms.");if(0>b||b+5>=a.length)return 0;a=a.substr(b+5);return parseInt(a)};h.prototype._getCloudServiceDuration=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==a.productId)return 50;a=a.productId;var b=a.indexOf(".cloudservice.");if(0>b||b+14>=a.length)return 0;a=a.substr(b+14);return parseInt(a)};return h}();"undefined"!=typeof module&&module&&module.exports&&(module.exports=new xnm.aio.sms.Handler);
