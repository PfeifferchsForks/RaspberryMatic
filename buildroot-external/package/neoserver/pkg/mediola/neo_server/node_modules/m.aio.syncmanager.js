var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var c=0;return function(){return c<e.length?{done:!1,value:e[c++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,c,b){if(e==Array.prototype||e==Object.prototype)return e;e[c]=b.value;return e};$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<e.length;++c){var b=e[c];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,c){var b=$jscomp.propertyToPolyfillSymbol[c];if(null==b)return e[c];b=e[b];return void 0!==b?b:e[c]};
$jscomp.polyfill=function(e,c,b,a){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,c,b,a):$jscomp.polyfillUnisolated(e,c,b,a))};$jscomp.polyfillUnisolated=function(e,c,b,a){b=$jscomp.global;e=e.split(".");for(a=0;a<e.length-1;a++){var d=e[a];if(!(d in b))return;b=b[d]}e=e[e.length-1];a=b[e];c=c(a);c!=a&&null!=c&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(e,c,b,a){var d=e.split(".");e=1===d.length;a=d[0];a=!e&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<d.length-1;f++){var g=d[f];if(!(g in a))return;a=a[g]}d=d[d.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?a[d]:null;c=c(b);null!=c&&(e?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:c}):c!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+b+"$"+d),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:c})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(e){if(e)return e;var c=function(f,g){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};c.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",a=0,d=function(f){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new c(b+(f||"")+"_"+a++,f)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var c="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<c.length;b++){var a=$jscomp.global[c[b]];"function"===typeof a&&"function"!=typeof a.prototype[e]&&$jscomp.defineProperty(a.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return e},"es6",
"es3");$jscomp.iteratorPrototype=function(e){e={next:e};e[Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,c){e instanceof String&&(e+="");var b=0,a=!1,d={next:function(){if(!a&&b<e.length){var f=b++;return{value:c(f,e[f]),done:!1}}a=!0;return{done:!0,value:void 0}}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");
$jscomp.findInternal=function(e,c,b){e instanceof String&&(e=String(e));for(var a=e.length,d=0;d<a;d++){var f=e[d];if(c.call(b,f,d,e))return{i:d,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(e){return e?e:function(c,b){return $jscomp.findInternal(this,c,b).v}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.syncmanager=m.aio.syncmanager||{};var async=require("async"),crypto=require("crypto"),fs=require("fs"),path=require("path"),unorm=require("unorm");
m.aio.syncmanager.PROTOCOL="https";m.aio.syncmanager.HOST="127.0.0.1";m.aio.syncmanager.PORT=8080;m.aio.syncmanager.PATH="";m.aio.syncmanager.HEADERS={"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"};m.aio.syncmanager.RemotesDownloader=function(e,c,b,a){this._logger=require("x.logger.js").getLogger("RemotesDownloader");this._host=e;this._port=c;this._username=b?b:"";this._password=a?a:""};m.aio.syncmanager.RemotesDownloader.PROTOCOL="https";
m.aio.syncmanager.RemotesDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemotesDownloader.prototype.downloadRemoteList=function(e){this._logger.log("debug","download remotes list from account:"+this._username);this._doRemoteDownloadReq(function(c,b){if(c)e&&e(c);else if(b.infos){c={remotes:[],info:b};if(0!=b.infos.length)for(var a=0;a<b.infos.length;a++)b.infos[a].name&&c.remotes.push({name:b.infos[a].name,encrypt:b.infos[a].encrypt?!0:!1});e&&e(null,c)}else e&&e(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype.download=function(e,c){this._logger.log("debug","download remotes from account:"+this._username);var b=this;this._doRemoteDownloadReq(function(a,d){a?c&&c(a):d.infos?0==d.infos.length?c&&c():b._doDownloadRemotes(e,d.credential,d.infos,function(f){c&&c(f)}):c&&c(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype._doRemoteDownloadReq=function(e){this._doGetRequest("/creatorneo/remote/requestDownload",null,function(c,b){if(c)e&&e(c);else try{var a=JSON.parse(b);e&&e(null,a)}catch(d){e&&e(d)}})};
m.aio.syncmanager.RemotesDownloader.prototype._doDownloadRemotes=function(e,c,b,a){var d=new m.aio.syncmanager.RemoteDownloader({host:this._host,port:this._port,username:this._username,password:this._password,credential:c}),f=0,g=function(h){h?a&&a(h):(f++,f<b.length?d.download(e,b[f],g):a&&a())};d.download(e,b[f],g)};
m.aio.syncmanager.RemotesDownloader.prototype._doGetRequest=function(e,c,b){var a=b,d=JSON.parse(JSON.stringify(m.aio.syncmanager.RemotesDownloader.OPTIONS));d.host=this._host?this._host:d.host;d.port=this._port?this._port:d.port;d.path+=e;d.method="GET";this._username&&this._password&&(d.auth=this._username+":"+this._password);c&&Object.keys(c).forEach(function(g){d.headers[g]=c[g]});var f="";e=require(m.aio.syncmanager.RemotesDownloader.PROTOCOL).request(d,function(g){g.setEncoding("utf8");g.on("data",
function(h){f+=h});g.on("end",function(){200==g.statusCode?a&&a(null,f):a&&a(Error("http error with status code:"+g.statusCode),f);a=null})});e.on("error",function(g){a&&(a(g),a=null)});e.end()};m.aio.syncmanager.RemotesDownloader.prototype._decrypt=function(e,c){try{return require("x.crypt.js").AES.decodeString(e,c).trim()}catch(b){return console.log(b),null}};
m.aio.syncmanager.RemotesDownloader.prototype._findRemote=function(e,c){if(!e||!c||!c.infos||0==c.infos.length)return null;for(var b=0;b<c.infos.length;b++)if(c.infos[b].name==e)return c.infos[b];return null};
m.aio.syncmanager.RemoteDownloader=function(e,c){var b=require("x.logger.js");this._logger=b?b.getLogger("RemoteDownloader"):{log:function(){}};this._listener=c;this._host=e.host;this._port=e.port;this._username=e.username?e.username:"";this._password=e.password?e.password:"";this._override="true"==e.override;this._s3cred=e.credential;this._remotePassword=e.remotePassword;this._encrypted=!1;this._s3cred&&(this._s3Client=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:e.credential.accessKeyId,
secretAccessKey:e.credential.secretAccessKey,sessionToken:e.credential.sessionToken}))};m.aio.syncmanager.RemoteDownloader.PROTOCOL="https";m.aio.syncmanager.RemoteDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteDownloader.prototype.download=function(e,c,b){this._logger.log("trace","download remote:"+c.name);var a=this,d=require("path");if(c.name){if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(0,"start download");if(c.resources&&0!=c.resources.length){if(c.encrypt){this._encrypted=!0;if(!this._remotePassword){if(b){var f=Error("no remote password");f.code=1;b(f)}return}if(this._decrypt(c.encrypt,this._remotePassword)!=c.name){b&&(f=Error("remote password error"),
f.code=2,b(f));return}}var g=require("fs"),h=e+d.sep+c.name;try{var k=g.existsSync(h);if(k&&!this._override){b&&(f=Error("remote:"+c.name+" already exists"),f.code=3,b(f));return}if(k&&this._override){var l=(new Date).getTime();g.renameSync(h,h+"_"+l);this._deldir(h+"_"+l)}}catch(n){b&&b(n);return}if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(1,"start to download files",{filesCount:c.resources.length});this._mkdir(e+d.sep+c.name,function(){var n=b,p=0,q=function(r){if(n&&
a._listener&&a._listener.onProgress)a._listener.onDownloadProgress(2,"one file download finish");p+=1;r?n&&(n(r),n=null):p==c.resources.length?n&&(n(),n=null):a._downloadFile(e+d.sep+c.name,c.resources[p],q)};a._downloadFile(e+d.sep+c.name,c.resources[p],q)})}else b&&b()}else b&&b(Error("remote info has no remote name"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFile=function(e,c,b){var a=this;this._logger.log("trace","download file:"+c.file);c.file?"device_db"===c.file?b&&b():c.file.match(/^resources.*/)&&this._s3cred?this._downloadFileFromS3(e,c,function(d){a._logger.log("trace","download file finish:"+c.file);d&&a._logger.log("trace","download file "+c.file+" from s3 error:"+d.message);b&&b(d)}):this._downloadFileFromServer(e,c,function(d){a._logger.log("trace","download file finish:"+c.file);if(d)a._logger.log("trace",
"download file "+c.file+" from server error:"+d.message),b&&b(d);else if("device_db"==c.file&&a._encrypted){d=require("path");var f=c.file.replace(/\//g,d.sep);a._decryptFile(e+d.sep+f,function(g){b&&b(g)})}else b&&b()}):b&&b(Error("file info has no file path"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromServer=function(e,c,b){if(c.ref){var a=require("path"),d=require("fs"),f=c.file.replace(/\//g,a.sep),g=e+a.sep+f;this._logger.log("trace","download file to:"+g);e=g.lastIndexOf(a.sep);e=g.substr(0,e);try{d.mkdirRecursiveSync(e)}catch(n){b&&b(n);return}e=require(m.aio.syncmanager.RemoteDownloader.PROTOCOL);a=this._host?this._host:m.aio.syncmanager.RemoteDownloader.OPTIONS.host;f=this._port?this._port:m.aio.syncmanager.RemoteDownloader.OPTIONS.port;
var h=m.aio.syncmanager.RemoteDownloader.OPTIONS.path+"/creatorneo/remote/downloadFile";c=c.ref.split("/");for(var k=0;k<c.length;k++)c[k]=encodeURIComponent(c[k]);c=m.aio.syncmanager.RemoteDownloader.PROTOCOL+"://"+a+":"+f+h+"/"+c.join("/");a=this._username?encodeURIComponent(this._username):"";f=this._password?encodeURIComponent(this._password):"";c+="?username="+a+"&password="+f;this._logger.log("trace","download file url:"+c);var l=d.createWriteStream(g);e.get(c,function(n){n.pipe(l);l.on("finish",
function(){l.close(b)})}).on("error",function(n){d.unlink(g);b&&b(n)})}else b&&b(Error("file info has no ref"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromS3=function(e,c,b){if(this._s3Client)if(c.ref){var a=require("path"),d=require("fs"),f=c.file.replace(/\//g,a.sep),g=e+a.sep+f;this._logger.log("trace","download file to:"+g);e=g.lastIndexOf(a.sep);e=g.substr(0,e);try{d.mkdirRecursiveSync(e)}catch(h){b&&b(h);return}this._s3Client.getObject({Bucket:"mediola-creator",Key:"resources/"+c.ref},function(h,k){h?b&&b(h):d.writeFile(g,k.Body,function(l){b&&b(l)})})}else b&&b(Error("file info has no ref"));
else b&&b(Error("s3 client not properly initialized"))};m.aio.syncmanager.RemoteDownloader.prototype._mkdir=function(e,c){var b=require("fs");try{b.mkdirSync(e)}catch(a){this._logger.log("warn","creator folder "+e+" error:"+a.message)}c&&c()};m.aio.syncmanager.RemoteDownloader.prototype._deldir=function(e){var c=require("fs"),b=this;c.existsSync(e)&&(c.readdirSync(e).forEach(function(a,d){a=e+"/"+a;c.lstatSync(a).isDirectory()?b._deldir(a):c.unlinkSync(a)}),c.rmdirSync(e))};
m.aio.syncmanager.RemoteDownloader.prototype._decrypt=function(e,c){try{return require("x.crypt.js").AES.decodeString(e,c).trim()}catch(b){return console.log(b),null}};m.aio.syncmanager.RemoteDownloader.prototype._decryptFile=function(e,c){var b=this,a=require("fs"),d=e+".bak";a.rename(e,d,function(f){f?c&&c(f):a.readFile(d,{encoding:"utf8"},function(g,h){g?c&&c(g):(g=b._decrypt(h,b._remotePassword))?a.writeFile(e,g,function(k){k?c&&c(k):a.unlink(d,function(l){c&&c(l)})}):c&&c(Error("decrypt error"))})})};
m.aio.syncmanager.RemoteUploader=function(e,c){var b=require("x.logger.js");this._logger=b?b.getLogger("RemoteUploader"):{log:function(){}};this._username=e.username?e.username:"";this._password=e.password?e.password:"";this._remotePassword=e.remotePassword?e.remotePassword:"";this._listener=c};m.aio.syncmanager.RemoteUploader.PROTOCOL="https";
m.aio.syncmanager.RemoteUploader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteUploader.prototype.upload=function(e,c,b,a){if(e)if(b){this._logger.log("debug","upload remote:"+b.id);var d=this;this._logger.log("trace","send upload remote request.");if(this._listener&&this._listener.onProgress)this._listener.onProgress(0,"start upload");this._doRemoteUploadReq(e,c,b,function(f,g){f?(d._logger.log("trace","send upload remote request error:"+f.stack),a&&a(f)):g.resources?(d._logger.log("trace","upload data one by one."),d._uploadResources(e,c,b,g,function(h,
k){h?a&&a(h):(d._logger.log("trace","send upload remote finish request."),d._finishUploadRemote(e,k,function(l){a&&a(l)}))})):a&&a(Error("server return format error"))})}else a&&a(Error("remote is null"));else a&&a(Error("license is empty"))};
m.aio.syncmanager.RemoteUploader.prototype._doRemoteUploadReq=function(e,c,b,a){var d=this,f=new m.aio.syncmanager.Assembler;if(this._listener&&this._listener.onProgress)this._listener.onProgress(1,"assemble files");f.generateRemoteUploadReq(c,b,function(g,h){if(g)d._logger.log("error","Error on generating remote upload request: "+g.message),a&&a(g);else{if(d._listener&&d._listener.onProgress)d._listener.onProgress(2,"inform server for upcoming upload");d._doPostRequest("/creatorneo/remote/requestUpload?license="+
e,null,JSON.stringify(h),function(k,l){if(k)a&&a(k);else try{var n=JSON.parse(l);a&&a(null,n)}catch(p){a&&a(p)}})}})};
m.aio.syncmanager.RemoteUploader.prototype._uploadResources=function(e,c,b,a,d){if(a&&a.resources){var f=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:a.credential.accessKeyId,secretAccessKey:a.credential.secretAccessKey,sessionToken:a.credential.sessionToken});if(this._listener&&this._listener.onProgress)this._listener.onProgress(3,"start to upload files",{filesCount:a.resources.length});var g=this;require("async").eachLimit(a.resources,5,function(h,k){if(h.exists&&
h.file&&"device_db"!=h.file){if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");k()}else if(h.file)h.file.match(/^resources.*/)?g._uploadFileToS3(f,c,b,h,function(l){h.success=l?!1:!0;if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");k(l)}):g._uploadFileToServer(e,c,b,h,function(l){h.success=l?!1:!0;if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");k(l)});else{h.success=!1;if(g._listener&&
g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");k(Error("resource index has no file parameter"))}},function(h){d&&d(h,a)})}else d&&d(Error("no resource to upload in the req"))};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToServer=function(e,c,b,a,d){this._logger.log("trace","upload remote file:"+a.file);var f=this,g=require("fs"),h=require("path");b=b.getFolderPath();c=c.getFolderPath();switch(a.file){case "device_db":g.readFile(b+h.sep+a.file,function(k,l){if(k)d&&d(k);else{"device_db"==a.file&&f._remotePassword&&(l=f._encrypt(l,f._remotePassword));k="/creatorneo/remote/uploadFile?license="+e;var n={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(k,n,l,function(p,q){p&&f._logger.log("trace","upload remote file "+a.file+" error:"+q);d&&d(p)})}});break;case "macros_db":case "deviceinfo.xml":g.readFile(c+h.sep+a.file,function(k,l){if(k)d&&d(k);else{"device_db"==a.file&&f._remotePassword&&(l=f._encrypt(l,f._remotePassword));k="/creatorneo/remote/uploadFile?license="+e;var n={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(k,n,l,function(p,q){p&&f._logger.log("trace","upload remote file "+a.file+" error:"+q);d&&d(p)})}});break;default:g.readFile(b+h.sep+a.file,function(k,l){if(k)d&&d(k);else{k="/creatorneo/remote/uploadFile?license="+e;var n={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(k,n,
l,function(p,q){p&&f._logger.log("trace","upload remote file "+a.file+" error:"+q);d&&d(p)})}})}};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToS3=function(e,c,b,a,d){this._logger.log("trace","upload remote resource:"+a.file);c=require("fs");var f=require("path");b=b.getFolderPath();var g=d;d=c.createReadStream(b+f.sep+a.file);d.on("error",function(h){g&&(g(h),g=null)});e.putObject({Bucket:"mediola-creator",Key:"resources/"+a.ref,Body:d},function(h){a.success=h?!1:!0;g&&(g(h),g=null)}).on("error",function(h){g&&(g(h),g=null)})};
m.aio.syncmanager.RemoteUploader.prototype._finishUploadRemote=function(e,c,b){if(this._listener&&this._listener.onProgress)this._listener.onProgress(5,"finalize the upload porcess");this._remotePassword&&(c.encrypt=this._encrypt(c.name,this._remotePassword));this._doPostRequest("/creatorneo/remote/finishUpload?license="+e,null,JSON.stringify(c),function(a,d){b&&b(a,d)})};
m.aio.syncmanager.RemoteUploader.prototype._doPostRequest=function(e,c,b,a){var d=a,f=JSON.parse(JSON.stringify(m.aio.syncmanager.RemoteUploader.OPTIONS));f.path+=e;f.method="POST";this._username&&this._password&&(f.auth=this._username+":"+this._password);c&&Object.keys(c).forEach(function(h){f.headers[h]=c[h]});var g="";e=require(m.aio.syncmanager.RemoteUploader.PROTOCOL).request(f,function(h){h.setEncoding("utf8");h.on("data",function(k){g+=k});h.on("end",function(){200==h.statusCode?d&&d(null,
g):d&&d(Error("http error with status code:"+h.statusCode),g);d=null})});e.on("error",function(h){d&&(d(h),d=null)});e.write(b);e.end()};m.aio.syncmanager.RemoteUploader.prototype._encrypt=function(e,c){return require("x.crypt.js").AES.encodeString(e,c).trim()};m.aio.syncmanager.Assembler=function(){};
m.aio.syncmanager.Assembler.prototype={generateRemoteDownloadRsp:function(e,c,b,a,d){var f=this;this._getRemoteDatabaseInfo(c,b,function(g,h){g?a&&a(g):(h&&h.forEach(function(k){k.file&&(k.ref="tenant/"+e.index+"/remote/"+c.index+"/"+k.file)}),f._getRemoteInfo(c,function(k,l){k?a&&a(k):(l.resources&&l.resources.forEach(function(n){n.file&&"device_db"!=n.file&&"macros_db"!=n.file&&"deviceinfo.xml"!=n.file&&(n.ref="tenant/"+e.index+"/remote/"+c.index+"/"+n.file,h.push(n))}),l.resources=h,a&&a(null,
l))},d))})},generateRemoteUploadReq:function(e,c,b){this.generateRemoteDownloadRsp(e,c,"from_upload_req",b)},_getRemoteInfo:function(e,c,b){var a=require("unorm"),d=e.getFolderPath(),f={name:a.nfc(e.id),resources:[]};this._getFilesInfos(d,function(g,h){g?c&&c(g):(h&&(f.resources=h),c&&c(null,f))},b)},_getRemoteDatabaseInfo:function(e,c,b){var a=this,d=e.getFolderPath(),f=require("fs-extra");async.parallel([function(g){var h=e.getDeviceFile();h?fs.exists(h,function(k){k?a._getFileInfos(h,d,function(l,
n){if("from_download"==c)try{f.removeSync(h)}catch(p){}g(l,n)}):g()}):g()},function(g){var h=e.getMacrosFile();h?fs.exists(h,function(k){k?a._getFileInfos(h,d,function(l,n){g(l,n)}):g()}):g()},function(g){var h=e.getDeviceinfoFile();h?fs.exists(h,function(k){k?a._getFileInfos(h,d,function(l,n){g(l,n)}):g()}):g()}],function(g,h){var k=[];h&&h.forEach(function(l){l&&k.push(l)});b&&b(g,k)})},_getTenantDatabaseInfo:function(e,c){var b=this,a=e.getFolderPath();async.parallel([function(d){var f=e.getDeviceFile();
f?fs.exists(f,function(g){g?b._getFileInfos(f,a,function(h,k){d(h,k)}):d()}):d()},function(d){var f=e.getMacrosFile();f?fs.exists(f,function(g){g?b._getFileInfos(f,a,function(h,k){d(h,k)}):d()}):d()},function(d){var f=e.getDeviceinfoFile();f?fs.exists(f,function(g){g?b._getFileInfos(f,a,function(h,k){d(h,k)}):d()}):d()}],function(d,f){var g=[];f&&f.forEach(function(h){h&&g.push(h)});c&&c(d,g)})},_listAllFiles:function(e,c){var b=[],a=this,d=function(f,g){if(g>=f.length)c(null,b);else{var h=path.join(e,
f[g]);fs.stat(h,function(k,l){k?c(k,b):l.isDirectory()?a._listAllFiles(h,function(n,p){n?c(n,b):(Array.isArray(p)&&(b=b.concat(p)),d(f,g+1))}):(b.push(h),d(f,g+1))})}};fs.readdir(e,function(f,g){f?c&&c(f,b):d(g,0)})},_getFilesInfos:function(e,c,b){var a=[],d=require("m.aio.configmanager.js").Page.FILE_EXT,f=this;this._listAllFiles(e,function(g,h){g?c&&c(g):async.eachLimit(h,50,function(k,l){if(0==path.basename(k).indexOf("."))l();else{var n=k.replace(e,""),p=path.extname(n);"controls"==n.substr(1,
8)&&p!==d.PAGE&&p!==d.POPUP?l():"resources_"==n.substr(1,10)?l():f._getFileInfos(k,e,function(q,r){q?l(q):(r&&a.push(r),l())},b)}},function(k){c&&c(k,a)})})},_getFileInfos:function(e,c,b,a){c=path.relative(c,e);c=unorm.nfc(c);e=unorm.nfc(e);"\\"==path.sep&&(c=c.replace(/\\/g,"/"));a=path.basename(e);var d={file:c,name:a},f=this;fs.stat(e,function(g,h){g?b(g):h.isFile()?(d.size=h.size,f._md5AndSha1(e,function(k,l){k?b(k):(d.md5=l.md5,d.sha1=l.sha1,b(null,d))})):b(Error(e+" is not a file"))})},_md5AndSha1:function(e,
c){var b=crypto.createHash("md5"),a=crypto.createHash("sha1"),d=fs.createReadStream(e);d.on("readable",function(){for(var f;null!==(f=d.read());)b.update(f),a.update(f)}).on("end",function(){var f={md5:b.digest("base64"),sha1:a.digest("base64")};c(null,f)})},_md5:function(e,c){var b=crypto.createHash("md5"),a=fs.createReadStream(e);a.on("readable",function(){for(var d;null!==(d=a.read());)b.update(d)}).on("end",function(){c(null,{md5:b.digest("base64")})})},_sha1:function(e,c){var b=crypto.createHash("sha1"),
a=fs.createReadStream(e);a.on("readable",function(){for(var d;null!==(d=a.read());)b.update(d)}).on("end",function(){c(null,{sha1:b.digest("base64")})})}};
m.aio.syncmanager.UserDBUploader=function(){var e=function(c,b){this._logger=require("x.logger.js").getLogger("UserDBUploader");this._username=c.username?c.username:"";this._password=c.password?c.password:"";this._listener=b};e.prototype.upload=function(c,b){if(c){var a=this;this._upload(c,function(d){if(d){if(a._logger.log("trace","upload user database error:"+d.stack),a._listener&&a._listener.onError)a._listener.onError({error:d.message,error_code:d.code})}else if(a._logger.log("trace","upload user database success"),
a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);b&&b(d)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});b&&b(Error("tenant is null"))}};e.prototype._upload=function(c,b){this._logger.log("debug","upload user db:"+c.index);var a=this;this._zipUserDB(c,function(d,f){d?(a._logger.log("trace","zip user database error:"+d.stack),b&&b(d)):(a._logger.log("trace","zip user database ok"),a._requestUpload(function(g,h){g?(a._logger.log("trace",
"send upload request error:"+g.stack),b&&b(g)):(a._logger.log("trace","send upload request ok"),a._uploadZip(f,h,function(k){k?(a._logger.log("trace","upload zip error:"+k.stack),b&&b(k)):(a._logger.log("trace","upload zip ok"),a._finishUpload(h.ref,function(l){l?a._logger.log("trace","finish user database upload error:"+l.stack):a._logger.log("trace","finish user database upload ok");b&&b(l)}))}))}))})};e.prototype._zipUserDB=function(c,b){var a=this;this._reportProgress(0,"zip user database",function(){a._logger.log("trace",
"zip the user database.");var d=require("path"),f=c.getDeviceFile(),g=c.getDeviceFile()+".enc",h=c.getMacrosFile();c.getDeviceinfoFile();var k=c.getFolderPath()+d.sep+"automation",l=require("m.aio.filemanager.js"),n=require("fs"),p=Math.round((new Date).getTime()/1E3),q=0;l=l.getTmpDir();for(var r=d.join(l,p+".zip");a._fileExistsSync(r);){q++;p++;if(10<q){b&&b(Error("can not create temp file"));return}r=d.join(l,p+".zip")}a._logger.log("trace","zip file:"+r);var B=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(B,
function(t){a._logger.log("debug","Checked CPU for features: "+B.join(", ")+". Result: "+t);if(t){var w=require("archiver");t=n.createWriteStream(r);w=w("zip");t.on("error",function(u){a._logger.log("warn","create user database error:"+u.message);b&&(b(u),b=null)});t.on("close",function(){b&&(b(null,r),b=null)});w.pipe(t);a._fileExistsSync(f)&&w.append(n.createReadStream(f),{name:"device_db"});a._fileExistsSync(h)&&w.append(n.createReadStream(h),{name:"macros_db"});a._fileExistsSync(g)&&w.append(n.createReadStream(g),
{name:"device_db.enc"});if(a._fileExistsSync(k))if(t=n.statSync(k),t.isDirectory())w.directory(k,"automation");else{t=Error("Automation folder is not a directory: "+k);a._logger.log("error",t.message);b&&b(t);b=null;return}w.finalize()}else{var x=new (require("jszip")),C=Date.now(),z=c.getFolderPath(),v=function(u){x.folder(u);for(var E=n.readdirSync(d.join(z,u),{withFileTypes:!0}),D=0;D<E.length;D++){var y=E[D];if(y.isFile()){var A=y.name.toLowerCase();".ds_store"!==A&&"thumbs.db"!==A&&(A=d.join(z,
u,y.name),A=n.readFileSync(A),y=y.name,u&&(y=u+"/"+y),x.file(y,A))}else y.isDirectory()&&v(u+"/"+y.name)}};a._fileExistsSync(f)&&x.file("device_db",n.readFileSync(f));a._fileExistsSync(g)&&x.file("device_db.enc",n.readFileSync(g));a._fileExistsSync(h)&&x.file("macros_db",n.readFileSync(h));if(a._fileExistsSync(k))if(t=n.statSync(k),t.isDirectory())v("automation");else{t=Error("Automation folder is not a directory: "+k);a._logger.log("error",t.message);b&&b(t);b=null;return}x.generateNodeStream({compression:"DEFLATE",
compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(n.createWriteStream(r)).on("finish",function(){a._logger.log("debug","ZIP has been created: "+r);a._logger.log("debug","Creating the ZIP took "+(Date.now()-C)+" ms.");b&&(b(null,r),b=null)})}})})};e.prototype._requestUpload=function(c){var b=this;this._reportProgress(1,"send upload request",function(){b._logger.log("trace","send upload user database request.");b._doRequest("POST","/creatorneo/userdb/requestUpload",null,null,function(a,
d){if(d)try{d=JSON.parse(d)}catch(f){a=f,a.code=103}a||(d&&"success"==d.status?d.result&&d.result.ref&&d.result.credential||(a=Error("request upload response foramt error"),a.code=102):(a=Error("request upload response error:"+d.message),a.code=101));a&&!a.code&&(a.code=100);c&&c(a,d&&d.result)})})};e.prototype._uploadZip=function(c,b,a){var d=this;this._reportProgress(2,"upload zip file",function(){d._logger.log("trace","upload zip file with ref:"+b.ref);var f=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",
region:"eu-central-1",accessKeyId:b.credential.accessKeyId,secretAccessKey:b.credential.secretAccessKey,sessionToken:b.credential.sessionToken}),g=require("fs");require("path");var h=a;g=g.createReadStream(c);g.on("error",function(k){h&&(k.code=201,h(k),h=null)});f.putObject({Bucket:"mediola-creator",Key:"user_db/"+b.ref,Body:g},function(k){h&&(k&&(k.code=202),h(k),h=null)}).on("error",function(k){h&&(k.code=203,h(k),h=null)})})};e.prototype._finishUpload=function(c,b){var a=this;this._reportProgress(3,
"finish upload",function(){a._logger.log("trace","finish upload zip file ref:"+c);a._doRequest("POST","/creatorneo/userdb/finishUpload?ref="+c,null,null,function(d,f){if(f)try{f=JSON.parse(f)}catch(g){d=g,d.code=303}d||f&&"success"==f.status||(d=Error("request upload response error:"+f.message),d.code=301);d&&!d.code&&(d.code=300);b&&b(d)})})};e.prototype._reportProgress=function(c,b,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(c,b,null,a);else a&&a()};e.prototype._fileExistsSync=
function(c){var b=require("fs");try{b.statSync(c)}catch(a){if("ENOENT"==a.code)return!1}return!0};e.prototype._doRequest=function(c,b,a,d,f){var g=f;f=require(m.aio.syncmanager.PROTOCOL);var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=b;h.method=c;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(l){h.headers[l]=a[l]});var k="";c=f.request(h,function(l){l.setEncoding("utf8");
l.on("data",function(n){k+=n});l.on("end",function(){200==l.statusCode?g&&g(null,k):g&&g(Error("http error with status code:"+l.statusCode),k);g=null})});c.on("error",function(l){g&&(g(l),g=null)});d&&c.write(d);c.end()};return e}();
m.aio.syncmanager.UserDBDownloader=function(){var e=function(c,b){this._logger=require("x.logger.js").getLogger("UserDBDownloader");this._username=c.username?c.username:"";this._password=c.password?c.password:"";this._listener=b};e.prototype.download=function(c,b){if(c){var a=this;this._download(c,function(d){if(d){if(a._logger.log("trace","download user database error:"+d.stack),a._listener&&a._listener.onError)a._listener.onError({error:d.message,error_code:d.code})}else if(a._logger.log("trace",
"download user database success"),a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);b&&b(d)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});b&&b(Error("tenant is null"))}};e.prototype._download=function(c,b){this._logger.log("debug","download user db:"+c.index);var a=this;this._requestDownload(function(d,f){d?(a._logger.log("trace","send download request error:"+d.stack),b&&b(d)):a._downloadZip(f,function(g,h){g?(a._logger.log("trace",
"download zip file error:"+g.stack),b&&b(g)):a._unzipFile(h,function(k,l){k?(a._logger.log("trace","unzip file error:"+k.stack),b&&b(k)):a._reloadUserDB(l,c,function(n){n&&a._logger.log("trace","reload user database error:"+n.stack);b&&b(n)})})})})};e.prototype._requestDownload=function(c){var b=this;this._reportProgress(0,"send download request",function(){b._logger.log("trace","send download user database request.");b._doRequest("GET","/creatorneo/userdb/requestDownload",null,null,function(a,d){if(d)try{d=
JSON.parse(d)}catch(f){a=f,a.code=103}a||(d&&"success"==d.status?d.result&&d.result.ref&&d.result.credential||(a=Error("request download response foramt error"),a.code=102):(a=Error("request download response error:"+d.message),a.code=101));a&&!a.code&&(a.code=100);c&&c(a,d&&d.result)})})};e.prototype._downloadZip=function(c,b){var a=this;this._reportProgress(1,"download zip file",function(){a._logger.log("trace","download zip file with ref:"+c.ref);var d=require("m.aio.filemanager.js"),f=require("path"),
g=require("fs"),h=Math.round((new Date).getTime()/1E3),k=0;d=d.getTmpDir();for(var l=f.join(d,h+".zip");a._fileExistsSync(l);){k++;h++;if(10<k){b&&b(Error("can not create temp file"));return}l=f.join(d,h+".zip")}a._logger.log("trace","zip file:"+l);(new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:c.credential.accessKeyId,secretAccessKey:c.credential.secretAccessKey,sessionToken:c.credential.sessionToken})).getObject({Bucket:"mediola-creator",Key:"user_db/"+c.ref},
function(n,p){n?(n.code=201,b&&b(n)):g.writeFile(l,p.Body,function(q){q&&(q.code=203);b&&b(q,l)})})})};e.prototype._unzipFile=function(c,b){var a=this;this._reportProgress(2,"unzip file",function(){var d=require("m.aio.filemanager.js"),f=require("path");require("fs");var g=Math.round((new Date).getTime()/1E3),h=0;d=d.getTmpDir();for(var k=f.join(d,g+"");a._fileExistsSync(k);){h++;g++;if(10<h){f=Error("can not create temp folder");f.code=301;b&&b(f);return}k=f.join(d,g++)}a._logger.log("trace","unzip to folder:"+
k);try{require("fs-extra").ensureDirSync(k)}catch(n){n.code=201;b&&b(n);return}var l=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(l,function(n){a._logger.log("debug","Checked CPU for features: "+l.join(", ")+". Result: "+n);if(n){n=new (require("adm-zip"))(c);try{n.extractAllTo(k,!0),b&&b(null,k)}catch(p){p.code=202,b&&b(p)}}else XC.unzip(c,k,a._logger,function(p){p?(p.code=202,b&&b(p)):b&&b(null,k)})})})};e.prototype._reloadUserDB=function(c,b,a){var d=require("fs"),f=require("fs-extra"),g=this;
this._reportProgress(3,"load user database",function(){var h=require("path"),k=b.getDeviceFile(),l=b.getDeviceFile()+".enc",n=b.getMacrosFile(),p=b.getDeviceinfoFile(),q=h.join(b.getFolderPath(),"automation"),r=h.join(c,"device_db"),B=h.join(c,"device_db.enc"),t=h.join(c,"macros_db"),w=h.join(c,"deviceinfo.xml");h=h.join(c,"automation");g._copyFolder(h,q,function(x){x?(x.code=303,a&&a(x)):g._copyFile(w,p,function(C){C?(C.code=301,a&&a(C)):g._copyFile(t,n,function(z){if(z)z.code=302,a&&a(z);else{try{f.removeSync(l)}catch(v){}d.existsSync(B)?
g._copyFile(B,l,function(v){if(v)v.code=302,a&&a(v);else{var u=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(b,function(){u.reloadTenant(b,function(){a&&a()})})}}):g._copyFile(r,k,function(v){if(v)v.code=302,a&&a(v);else{var u=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(b,function(){u.reloadTenant(b,function(){a&&a()})})}})}})})})})};e.prototype._reportProgress=function(c,b,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(c,
b,null,a);else a&&a()};e.prototype._fileExistsSync=function(c){var b=require("fs");try{b.statSync(c)}catch(a){if("ENOENT"==a.code)return!1}return!0};e.prototype._copyFile=function(c,b,a){var d=require("fs");this._fileExistsSync(c)?d.readFile(c,function(f,g){f?a&&a(f):d.writeFile(b,g,function(h){a&&a(h)})}):d.writeFile(b,"",function(f){a&&a(f)})};e.prototype._copyFolder=function(c,b,a){var d=require("fs-extra"),f=this;d.remove(b,function(g){g?a&&a(g):f._fileExistsSync(c)?d.move(c,b,{overwrite:!0},
function(h){a&&a(h)}):a&&a()})};e.prototype._doRequest=function(c,b,a,d,f){var g=f;f=require(m.aio.syncmanager.PROTOCOL);var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=b;h.method=c;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(l){h.headers[l]=a[l]});var k="";c=f.request(h,function(l){l.setEncoding("utf8");l.on("data",function(n){k+=n});l.on("end",function(){200==
l.statusCode?g&&g(null,k):g&&g(Error("http error with status code:"+l.statusCode),k);g=null})});c.on("error",function(l){g&&(g(l),g=null)});d&&c.write(d);c.end()};return e}();m.aio.syncmanager.SyncManager=function(){this._configmanager=null};
m.aio.syncmanager.SyncManager.prototype={init:function(e,c,b,a){this._configmanager=e;c&&(m.aio.syncmanager.RemoteUploader.OPTIONS.host=c,m.aio.syncmanager.RemotesDownloader.OPTIONS.host=c,m.aio.syncmanager.RemoteDownloader.OPTIONS.host=c,m.aio.syncmanager.HOST=c);b&&0<b&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=b,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=b,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=b,m.aio.syncmanager.PORT=b,process&&"local"!=process.env.CLOUD&&80==b&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=
443,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=443,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=443,m.aio.syncmanager.PORT=443),process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=80,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=80,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=80,m.aio.syncmanager.PORT=80));process&&"local"==process.env.CLOUD?(m.aio.syncmanager.RemoteUploader.OPTIONS.path="/webservice",m.aio.syncmanager.RemotesDownloader.OPTIONS.path="/webservice",
m.aio.syncmanager.RemoteDownloader.OPTIONS.path="/webservice",m.aio.syncmanager.PATH="/webservice",m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL="http"):process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL=
"http");a&&a()},uploadRemote:function(e,c,b,a,d){if(b&&b.username&&b.password){var f=this;this._configmanager.trace("config/tenants/"+e,function(g,h){g?d&&d(g):h.license&&h.license.licenseTxt?f._configmanager.trace("config/tenants/"+e+"/remotes/"+c,function(k,l){if(k)d&&d(k);else{var n=require("m.aio.devicemanager.js");n.saveRemote(l,function(p){p?d&&d(p):(new m.aio.syncmanager.RemoteUploader(b,a)).upload(h.license.licenseTxt,h,l,function(q){n.clearRemoteDB(l,function(){d&&d(q)})})})}}):d&&d(Error("no license"))})}else d&&
d(Error("options format invalid"))},downloadRemote:function(e,c,b,a,d,f){a&&a.username&&a.password?this._configmanager.trace("config/tenants/"+e,function(g,h){if(g)f&&f(g);else if(h.license&&h.license.licenseTxt)if(h.isAccessible())if(g=(new m.aio.syncmanager.RemotesDownloader)._findRemote(c,b)){a.credential=b.credential;var k=h.getRemotes().getFolderPath();(new m.aio.syncmanager.RemoteDownloader(a,d)).download(k,g,function(l){l?f&&f(l):setTimeout(function(){h.reloadRemotes(function(n){f&&f(n)})},
100)})}else f&&f(Error("no such remote:"+c));else f&&f(Error("not permitted"));else f&&f(Error("no license"))}):f&&f(Error("options format invalid"))},downloadRemoteList:function(e,c,b){(new m.aio.syncmanager.RemotesDownloader(null,null,e,c)).downloadRemoteList(b)},testRemotePassword:function(e,c,b,a){if(e)if(c)if(b){var d=new m.aio.syncmanager.RemotesDownloader;(b=d._findRemote(e,b))?b.encrypt?(c=d._decrypt(b.encrypt,c),a&&a(null,c==e)):a&&a(null,!0):a&&a(Error("no such remote:"+e))}else a&&a(Error("info is null"));
else a&&a(Error("remote password is null"));else a&&a(Error("remote name is null"))},requestDownload:function(e,c){var b=this;this._configmanager.trace("config/tenants",function(a,d){a?e&&e(a):(a=null,(d=d.getChildren())?(a=d.find(function(f){return f.isDefault()}))&&a.license&&!a.license.isTestLicense()&&a.license.valid?b.requestDownloadTenant(a.index,e,c):a&&a.license&&a.license.isTestLicense()?(d=Error("can not download from test license"),d.code=400,e&&e(d,null)):e&&e(null,{infos:[]}):e&&e(null,
{infos:[]}))})},requestDownloadTenant:function(e,c,b){var a=Date.now();this._configmanager.trace("config/tenants/"+e,function(d,f){if(d)c&&c(d);else if(f.isAccessible()){var g={infos:[]},h=f.getRemotes();h&&0!=h.size()?require("m.aio.devicemanager.js").deleteUnlicensed(e,function(k){if(k)c&&c(k);else{var l=0,n=new m.aio.syncmanager.Assembler;h.getChildren().forEach(function(p){n.generateRemoteDownloadRsp(f,p,"from_download",function(q,r){l+=1;q||g.infos.push(r);l==h.size()&&(console.debug("[m.aio.syncmanager.SyncManager.requestDownloadTenant] Done after "+
(Date.now()-a)+" ms."),c&&c(null,g))},b)})}}):c&&c(null,g)}else c&&c(Error("not permitted"))})},getTenantFile:function(e,c,b){e&&c?this._configmanager.trace("config/tenants/"+e,function(a,d){a?b&&b(a):(a=require("path"),c=c.replace(/\//g,a.sep),(d=d.getFolderPath())?b&&b(null,d+a.sep+c):b&&b(Error("tenant has no folder")))}):b&&b(Error("parameter invalid"))},getRemoteFile:function(e,c,b,a){e&&c&&b?this._configmanager.trace("config/tenants/"+e+"/remotes/"+c,function(d,f){d?a&&a(d):(d=require("path"),
b=b.replace(/\//g,d.sep),(f=f.getFolderPath())?a&&a(null,f+d.sep+b):a&&a(Error("remote has no folder")))}):a&&a(Error("parameter invalid"))},getRemoteDeviceDBData:function(e,c,b,a){e&&c&&b?require("m.aio.devicemanager.js").getDeviceDBForRemote(e,function(d,f){a&&a(d,f)}):a&&a(Error("parameter invalid"))},uploadUserDB:function(e,c,b,a){if(c&&c.username&&c.password)this._configmanager.trace("config/tenants/"+e,function(d,f){if(d){if(b&&b.onError)b.onError({error:d.message,error_code:100});a&&a(d)}else if(f.license&&
f.license.licenseTxt)(new m.aio.syncmanager.UserDBUploader(c,b)).upload(f,function(g){a&&a(g)});else{if(b&&b.onError)b.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(b&&b.onError)b.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},downloadUserDB:function(e,c,b,a){if(c&&c.username&&c.password)this._configmanager.trace("config/tenants/"+e,function(d,f){if(d){if(b&&b.onError)b.onError({error:d.message,error_code:100});
a&&a(d)}else if(f.license&&f.license.licenseTxt)(new m.aio.syncmanager.UserDBDownloader(c,b)).download(f,function(g){a&&a(g)});else{if(b&&b.onError)b.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(b&&b.onError)b.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},_downloadRemotes:function(e,c,b){c&&c.host&&c.port?(new m.aio.syncmanager.RemotesDownloader(c.host,c.port,c.username,c.password)).download(e,function(a){b&&b(a)}):
b&&b(Error("options format invalid"))}};m.aio.syncmanager.Handler=m.aio.syncmanager.SyncManager;m.aio.syncmanager.Handler.prototype.RemotesDownloader=m.aio.syncmanager.RemotesDownloader;m.aio.syncmanager.Handler.prototype.RemoteDownloader=m.aio.syncmanager.RemoteDownloader;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.syncmanager.Handler);
