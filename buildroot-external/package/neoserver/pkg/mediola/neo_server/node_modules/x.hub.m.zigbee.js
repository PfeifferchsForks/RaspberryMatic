var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zigbee=x.hub.m.zigbee||{};
x.hub.m.zigbee.Util=function(){var h=function(){};h.prototype.rgbToHsv=function(c,a,b){c/=255;a/=255;b/=255;var d=Math.max(c,a,b),e=Math.min(c,a,b),f=d-e;if(d==e)var g=0;else{switch(d){case c:g=(a-b)/f+(a<b?6:0);break;case a:g=(b-c)/f+2;break;case b:g=(c-a)/f+4}g/=6}return[g,0==d?0:f/d,d]};h.prototype.hsvToRgb=function(c,a,b){var d=Math.floor(6*c),e=6*c-d;c=b*(1-a);var f=b*(1-e*a);a=b*(1-(1-e)*a);switch(d%6){case 0:var g=b;var k=a;var m=c;break;case 1:g=f;k=b;m=c;break;case 2:g=c;k=b;m=a;break;case 3:g=
c;k=f;m=b;break;case 4:g=a;k=c;m=b;break;case 5:g=b,k=c,m=f}return[255*g,255*k,255*m]};h.prototype.rgbTocie=function(c,a,b){c=.04045<c?Math.pow((c+.055)/1.055,2.4):c/12.92;a=.04045<a?Math.pow((a+.055)/1.055,2.4):a/12.92;b=.04045<b?Math.pow((b+.055)/1.055,2.4):b/12.92;var d=.664511*c+.154324*a+.162028*b,e=.283881*c+.668433*a+.047685*b;a=8.8E-5*c+.07231*a+.986039*b;c=(d/(d+e+a)).toFixed(4);d=(e/(d+e+a)).toFixed(4);isNaN(c)&&(c=0);isNaN(d)&&(d=0);return[c,d]};h.prototype.cieTorgb=function(c,a,b){void 0===
b&&(b=254);var d=1-c-a;b=(b/254).toFixed(2);c*=b/a;var e=b/a*d;a=1.656492*c-.354851*b-.255038*e;d=.707196*-c+1.655397*b+.036152*e;b=.051713*c-.121364*b+1.01153*e;a>b&&a>d&&1<a?(d/=a,b/=a,a=1):d>b&&d>a&&1<d?(a/=d,b/=d,d=1):b>a&&b>d&&1<b&&(a/=b,d/=b,b=1);a=.0031308>=a?12.92*a:1.055*Math.pow(a,1/2.4)-.055;d=.0031308>=d?12.92*d:1.055*Math.pow(d,1/2.4)-.055;b=.0031308>=b?12.92*b:1.055*Math.pow(b,1/2.4)-.055;a=Math.round(255*a);d=Math.round(255*d);b=Math.round(255*b);isNaN(a)&&(a=0);isNaN(d)&&(d=0);isNaN(b)&&
(b=0);return[a,d,b]};h.prototype.RGBToHSV=function(c,a,b){c/=255;a/=255;b/=255;var d=Math.min(c,Math.min(a,b)),e=Math.max(c,Math.max(a,b));return d==e?[0,0,d]:[60*((c==d?3:b==d?1:5)-(c==d?a-b:b==d?c-a:b-c)/(e-d)),(e-d)/e,e]};return new h}();
x.hub.m.zigbee.Device=function(){var h=function(c,a){this._ieeeAdr=c;this._endpointID=a;this._deviceID=this._profileID=null;this._states={}};h.prototype.getIeeeAdr=function(){return this._ieeeAdr};h.prototype.getEndpointID=function(){return this._endpointID};h.prototype.setBufferedState=function(c,a){this._states[c]=a};h.prototype.getBufferedState=function(c){return this._states[c]};h.prototype.getBufferedStates=function(){return this._states};h.prototype.getConvertedStates=function(c){c={};"undefined"!=
typeof this._states.onoff&&null!=this._states.onoff&&(c.onoff=this._states.onoff);"undefined"!=typeof this._states.level&&null!=this._states.level&&(c.level=Math.round(this._states.level/255*100));if("undefined"!=typeof this._states.color&&null!=this._states.color&&(c.color=this._states.color,"undefined"!=typeof this._states.color.hue&&null!=this._states.color.hue&&"undefined"!=typeof this._states.color.sat&&null!=this._states.color.sat)){var a=x.hub.m.zigbee.Util.hsvToRgb(this._states.color.hue/
254,this._states.color.sat/254,1),b=Math.round(a[0]).toString(16);2>b.length&&(b="0"+b);b=b.toUpperCase();var d=Math.round(a[1]).toString(16);2>d.length&&(d="0"+d);d=d.toUpperCase();a=Math.round(a[2]).toString(16);2>a.length&&(a="0"+a);a=a.toUpperCase();c.rgb=b+d+a}"off"==c.onoff&&(c.level=0);"on"==c.onoff&&0==c.level&&(c.level=1);0==c.level&&(c.onoff="off");return c};h.prototype.executeCommand=function(c,a,b){var d=this;if("on"==a||"off"==a){var e=a;c._doCommand(this._ieeeAdr,this._endpointID,e,
null,function(l){l||d.setBufferedState("onoff",e);b&&b(l)})}else if("toggle"==a){var f=this.getBufferedState("onoff");e="on"==f?"off":"on";c._doCommand(this._ieeeAdr,this._endpointID,e,null,function(l){l||d.setBufferedState("onoff",e);b&&b(l)})}else if("white"==a)if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57")){a=x.hub.m.zigbee.Util.rgbTocie(255,255,255);var g=Math.round(65536*a[0]);65279<g&&(g=65279);a=Math.round(65536*a[1]);65279<a&&(a=65279);c._doCommand(this._ieeeAdr,this._endpointID,
"color_xy",[g,a],function(l){b&&b(l)})}else c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[0,0],function(l){l||d.setBufferedState("color",{hue:0,sat:0});b&&b(l)});else if(0==a.indexOf("dimTo"))e="level",f=parseInt(a.substr(5)),isNaN(f)?b&&b(Error("command "+a+" invalid")):(f=Math.round(f/100*255),c._doCommand(this._ieeeAdr,this._endpointID,e,f,function(l){l||d.setBufferedState("level",f);b&&b(l)}),0==f?c._doCommand(this._ieeeAdr,this._endpointID,"off",null,function(l){l||d.setBufferedState("onoff",
"off")}):c._doCommand(this._ieeeAdr,this._endpointID,"on",null,function(l){l||d.setBufferedState("onoff","on")}));else if(0==a.indexOf("setColorMap"))if((f=a.substr(11))&&-1!=f.indexOf(","))if(g=f.split(","),2>g.length)b&&b(Error("command "+a+" invalid"));else{var k=parseInt(g[0]);0>k&&(k=0);255<k&&(k=255);var m=parseInt(g[1]);0>m&&(m=0);255<m&&(m=255);c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[k,m],function(l){l||d.setBufferedState("color",{hue:k,sat:m});b&&b(l)})}else b&&b(Error("command "+
a+" invalid"));else if(0==a.indexOf("setColorXY"))(f=a.substr(10))&&-1!=f.indexOf(",")?(g=f.split(","),2>g.length?b&&b(Error("command "+a+" invalid")):(a=parseInt(g[0]),0>a&&(a=0),65279<a&&(a=65279),g=parseInt(g[1]),0>g&&(g=0),65279<g&&(g=65279),c._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[a,g],function(l){b&&b(l)}))):b&&b(Error("command "+a+" invalid"));else if(0==a.indexOf("setColorTemp"))if(f=a.substr(12)){g=parseFloat(f);15.32>g&&(g=15.32);var n=Math.round(1E6/g);c._doCommand(this._ieeeAdr,
this._endpointID,"color_temp",n,function(l){l||d.setBufferedState("color_temp",n);b&&b(l)})}else b&&b(Error("command "+a+" invalid"));else if(0==a.indexOf("setRGB")){f=a.substr(6);g=parseInt(f.substr(0,2),16);a=parseInt(f.substr(2,2),16);var p=parseInt(f.substr(4,2),16);if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57"))a=x.hub.m.zigbee.Util.rgbTocie(g,a,p),g=Math.round(65536*a[0]),65279<g&&(g=65279),a=Math.round(65536*a[1]),65279<a&&(a=65279),c._doCommand(this._ieeeAdr,this._endpointID,
"color_xy",[g,a],function(l){b&&b(l)});else{g=x.hub.m.zigbee.Util.rgbToHsv(g,a,p);var q=Math.floor(254*g[0]),r=Math.floor(254*g[1]);c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[q,r],function(l){l||d.setBufferedState("color",{hue:q,sat:r});b&&b(l)})}}else b&&b(Error("unknown command"))};h.prototype.toJSON=function(){return{ieeeAdr:this._ieeeAdr,endpointID:this._endpointID,profileID:this._profileID,deviceID:this._deviceID}};h.parseJSON=function(c){if(!c||!c.ieeeAdr||!c.endpointID)return null;
var a=new h(c.ieeeAdr,c.endpointID);a._profileID=c.profileID;a._deviceID=c.deviceID;return a};return h}();
x.hub.m.zigbee.Zigbee2=function(){function h(){evt_string="";evt_string+=arguments[0]+":";for(var d=1;d<arguments.length;d++)evt_string+=":",evt_string+=arguments[d];return evt_string}var c=require("nodejs_zb_gateway/zigbee_library/zb_lib.js"),a=require("nodejs_zb_gateway/zb_gateway/zb-gateway.js"),b=function(d){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee2");this._ip=d;this._zigbeeGateway=new a(this._ip);this._state=0;this._cronJob=null;this._cronPattern="0 0 2 * * *";this._zigbeeGateway.on("zb-gateway:newDev",
function(e,f,g){e&&e.startPollDeviceStates&&e.startPollDeviceStates(-1)}).on("zb-gateway:deviceList",function(e,f,g){console.log("Webserver: Received zb-gateway:deviceList",e,"The unbindedList: ",f,"The BindedList: ",g)}).on("zb-gateway:removeDeviceCard",function(e){console.log("Webserver: Received Remove Device Card")}).on("zb-gateway:network:ready",function(){console.log("Webserver: Received Network Ready Ind")}).on("zb-gateway:network:info",function(e){console.log("Webserver: Received Network Info Ind")}).on("zb-gateway:binding:event",
function(e,f,g){console.log("Webserver: Received zb-gateway:binding:event, unbindedList: ",f,"The BindedList: ",g)}).on("zb-gateway:binding:failed",function(){console.log("Webserver: Received zb-gateway:binding:failed")}).on("zb-gateway:unbinding:failed",function(){console.log("Webserver: Received zb-gateway:unbinding:failed")}).on("zb-gateway:light_device:state",function(e){}).on("zb-gateway:light_device:level",function(e){}).on("zb-gateway:light_device:color",function(e){console.log("Webserver: Got light device color update: ",
e)}).on("zb-gateway:light_device:color_temp",function(e){console.log("Webserver: Got light device color temperature update: ",e)}).on("zb-gateway:light_device:color_xy",function(e){console.log("Webserver: Got light device color xy update: ",e)}).on("zb-gateway:temp_device:temp",function(e){console.log("Webserver: Got temp device state update: ",e)}).on("zb-gateway:doorlock_device:state",function(e){console.log("Webserver: Got doorlock device state update: ",e)}).on("zb-gateway:doorlock_device:set_rsp",
function(e){console.log("Webserver: Got doorlock device set response: ",e)}).on("zb-gateway:thermostat:attribute",function(e){console.log("Webserver: Got thermostat device attribute response: ",e)}).on(h("zb-gateway",c.HA_CLUSTER_ID.LEVEL_CONTROL,c.STATUS.UNSUPPORTED_ATTRIBUTE),function(e){console.log("Webserver: Got level control, on/off transition time, unsupported device attribute response: ",e)})};b.prototype.init=function(){if(0==this._state){this._state=1;this._zigbeeGateway.init();var d=this,
e=require("x.hub.taskman.js").Util._getTimeZone();this._cronJob=new (require("cron").CronJob)(this._cronPattern,function(){d._logger.log("info","do soft system reset");console.log("zigbee do soft system reset:"+(new Date).toString());d._zigbeeGateway.softSystemReset()},null,!0,e)}};b.prototype.terminate=function(){1==this._state&&(this._state=0,this._zigbeeGateway.terminate(),this._cronJob.stop())};b.prototype.getDevices=function(){return this._zigbeeGateway.getDevices()};b.prototype.getDevice=function(d,
e){d=d.substring(0,4)+d.substring(10,16);e=parseInt(e).toString(16);2>e.length&&(e="0"+e);d=(d+e).toLowerCase();return this._zigbeeGateway.getDevice(d)};b.prototype.getDeviceStates=function(d,e){return(d=this.getDevice(d,e))&&d.getStates?d.getStates():null};b.prototype.executeCommand=function(d,e,f){if(d)if(e){var g=d.indexOf(":");if(-1==g)f&&f(Error("address format invalid"));else{var k=d.substr(0,g);d=d.substr(g+1);(k=this.getDevice(k,d))?k.executeCommand(e,function(m){f&&f(m)}):f&&f(Error("no such device"))}}else f&&
f(Error("command invalid"));else f&&f(Error("address is empty"))};return b}();
x.hub.m.zigbee.Zigbee=function(){var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee");this._devices=[];this._learnCBs=[];this._learnTO=null};h.prototype.init=function(c){this._logger.log("info","zigbee init");var a=this;this.listDevices(function(b){b&&a._logger.log("info","init list devices error:"+b.message);c&&c(b)})};h.prototype.getDevices=function(){return this._devices};h.prototype.executeCommand=function(c,a,b){if(c)if(a){var d=c.indexOf(":");if(-1==d)b&&b(Error("address format invalid"));
else{var e=c.substr(0,d);c=c.substr(d+1);(d=this._findDevice(e,c))||(d=new x.hub.m.zigbee.Device(e,c));d.executeCommand(this,a,b)}}else b&&b(Error("command invalid"));else b&&b(Error("address is empty"))};h.prototype.learnDevice=function(c,a){a||(a=function(){});c=parseInt(c);if(!c||isNaN(c)||0>=c)c=60;var b=this._learnCBs.length;-1==this._learnCBs.indexOf(a)&&this._learnCBs.push(a);if(!(0<b)){var d=this;this._learnTO=setTimeout(function(){d._listDevices(function(e,f){var g;d._learnTO=null;var k=
d._learnCBs;d._learnCBs=[];if(e)for(g=k.length;g--;)k[g]&&k[g](e);else{e=[];for(g=f.length;g--;){var m=f[g],n=d._findDevice(m.ieeeAdr,m.endpointID);!n&&(n=x.hub.m.zigbee.Device.parseJSON(m))&&(d._devices.push(n),e.push(m))}for(g=k.length;g--;)k[g]&&k[g](null,e)}})},1E3*c);this._openNetwork(c,function(e){if(e){clearTimeout(d._learnTO);d._learnTO=null;var f=d._learnCBs;d._learnCBs=[];for(var g=f.length;g--;)f[g]&&f[g](e)}})}};h.prototype.listDevices=function(c){var a=this;this._listDevices(function(b,
d){if(b)c&&c(b);else{for(b=d.length;b--;){var e=d[b],f=a._findDevice(e.ieeeAdr,e.endpointID);f||(f=x.hub.m.zigbee.Device.parseJSON(e))&&a._devices.push(f)}c&&c()}})};h.prototype.removeDevice=function(c,a){if(c){var b=c.indexOf(":");var d=-1==b?c:c.substr(0,b);var e=this;this._removeDevice(d,function(f){f?a&&a(f):(e._deleteDevice(d,null),a&&a())})}else a&&a(Error("address is empty"))};h.prototype._findDevice=function(c,a){for(var b=this._devices.length;b--;){var d=this._devices[b];if(d.getIeeeAdr()==
c&&d.getEndpointID()==a)return d}return null};h.prototype._deleteDevice=function(c,a){var b=this._devices;this._devices=[];for(var d=b.length;d--;){var e=b[d],f=!1;e.getIeeeAdr()==c&&(a&&e.getEndpointID()!=a||(f=!0));f||this._devices.push(e)}};h.prototype._listDevices=function(c){this._logger.log("debug","list devices");var a=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];a.push("listdevices");a=a.join(" ");var b=this;this._exec(a,function(d,e,f){if(d)b._logger.log("debug","list devices error:"+
d.message),c&&c(d);else if(f)b._logger.log("debug","list devices error:"+f),c&&c(Error(f));else if(b._logger.log("debug","list devices:\r\n"+e),e=e.trim()){d=[];e=e.split("\n");for(f=0;f<e.length;f++){var g=e[f].trim();g&&(g=g.split(" "),g={ieeeAdr:g[0]?g[0].replace(/:/g,""):null,endpointID:g[1],profileID:g[2]?g[2].substr(2):null,deviceID:g[3]?g[3].substr(2):null},d.push(g))}c&&c(null,d)}else c&&c(null,[])})};h.prototype._openNetwork=function(c,a){this._logger.log("debug","open network for "+c+" seconds");
var b=this;c=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin opennetwork",c].join(" ");this._exec(c,function(d,e,f){d?(b._logger.log("debug","open network error:"+d.message),a&&a(d)):f?(b._logger.log("debug","open network error:"+f),a&&a(Error(f))):a&&a()})};h.prototype._removeDevice=function(c,a){this._logger.log("debug","remove device:"+c);var b=this,d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin remove",c].join(" ");this._exec(d,function(e,f,g){e?(b._logger.log("debug","remove device "+
c+" error:"+e.message),a&&a(e)):g?(b._logger.log("debug","remove device "+c+" error:"+g),a&&a(Error(g))):a&&a()})};h.prototype._doCommand=function(c,a,b,d,e){var f=[c,a,b,d];this._logger.log("debug","do command ["+f.join(",")+"]");f=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];f.push(b);f.push(c);f.push(a);"undefined"!=typeof d&&null!=d&&(Array.isArray(d)?f=f.concat(d):f.push(d));var g=this;c=f.join(" ");this._exec(c,function(k,m,n){if(k)g._logger.log("debug","do command error:"+k.message),
e&&e(k);else if(n)g._logger.log("debug","do command error:"+n),e&&e(Error(n));else try{if(m){var p=JSON.parse(m);e&&e(null,p)}else e&&e()}catch(q){g._logger.log("debug","do command error (not json):"+m),e&&e(Error(m))}})};h.prototype._exec=function(c,a){this._logger.log("trace","execute native:"+c);var b=this,d=require("child_process").exec;c=d(c);var e,f="",g="";c.stderr.on("data",function(k){e=String(k);g+=e});c.stdout.on("data",function(k){e=String(k);f+=e});c.on("error",function(k){b._logger.log("warn",
"execute native error:"+k.message);a&&a(k);a=null});c.on("close",function(k,m){b._logger.log("trace","execute native close:"+k+","+m);b._logger.log("trace","outTxt:"+f);b._logger.log("trace","errTxt:"+g);a&&a(null,f,g);a=null})};return h}();
x.hub.m.zigbee.Handler=function(){var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Handler");this._zigbee2=this._zigbee=null;this._zigbeeStickAvaliable=!1};util.inherits(h,EventEmitter);h.prototype.Zigbee=x.hub.m.zigbee.Zigbee;h.prototype.Zigbee2=x.hub.m.zigbee.Zigbee2;h.prototype.getSystems=function(){return["zigbee"]};h.prototype.init=function(c){var a=this,b=require("x.hub.eventbus.js");b.on("x.hub.peripheralman.ADD_ZIGBEE",function(d){a._logger.log("debug","insert zigbee usb stick");
a._zigbeeStickAvaliable=!0;a._zigbee2.init()});b.on("x.hub.peripheralman.REMOVE_ZIGBEE",function(d){a._logger.log("debug","eject zigbee usb stick");a._zigbeeStickAvaliable=!1;a._zigbee2.terminate()});this._zigbee=new this.Zigbee;this._zigbee.init();global.ZIGBEE_URL&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM?(this._zigbeeStickAvaliable=!0,this._zigbee2=new this.Zigbee2(global.ZIGBEE_URL),this._zigbee2.init()):this._zigbee2=new this.Zigbee2("127.0.0.1");c&&c({})};h.prototype.executeCommand=function(c,
a,b){b&&b()};h.prototype.learnDevice=function(c,a){this._zigbeeStickAvaliable?this._zigbee.learnDevice(c.timeout,function(b,d){a&&a({error:b,data:d})}):a&&a({error:Error("zigbee usb stick not avaliable")})};h.prototype.removeDevice=function(c,a){this._zigbeeStickAvaliable?this._zigbee.removeDevice(c,function(b){a&&a({error:b})}):a&&a({error:Error("zigbee usb stick not avaliable")})};h.prototype.listDevices=function(c,a){if(c=this._zigbee.getDevices()){for(var b=[],d=c.length;d--;){var e=c[d].toJSON();
b.push(e)}a&&a({data:b})}else a&&a({data:[]})};h.prototype.getAllStatesLegacy=function(c){var a=[],b;var d=this._zigbee2.getDevices();for(b=d.length;b--;){var e=d[b];var f=e.getStates();f&&(e={type:"ZIGBEE",adr:e.getGUID().toUpperCase(),state:f},a.push(e))}d=this._zigbee.getDevices();for(b=d.length;b--;)if(e=d[b],!this._zigbee2.getDevice(e.getIeeeAdr(),e.getEndpointID())&&(f=e.getConvertedStates(this)))e={type:"ZIGBEE",adr:e.getIeeeAdr()+":"+e.getEndpointID(),state:f},a.push(e);c&&c({data:a})};h.prototype.executeCommandLegacy=
function(c,a,b){if(this._zigbeeStickAvaliable)if(c)if(a){var d=c.indexOf(":");if(-1==d)b&&b({error:Error("address format invalid")});else{var e=c.substr(0,d);d=c.substr(d+1);this._zigbee2.getDevice(e,d)?this._zigbee2.executeCommand(c,a,function(f){b&&b({error:f})},this):this._zigbee.executeCommand(c,a,function(f){b&&b({error:f})})}}else b&&b({error:Error("command invalid")});else b&&b({error:Error("address invalid")});else b&&b({error:Error("zigbee usb stick not avaliable")})};h.prototype.executeCommandNativeRaw=
function(c,a){if(this._zigbeeStickAvaliable){var b=c.command;(c=c.value)&&(c=JSON.parse(c));var d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];d.push(b);"undefined"!=typeof c&&null!=c&&(Array.isArray(c)?d=d.concat(c):d.push(c));this._zigbee._exec(d.join(" "),function(e,f,g){if(e)a&&a({error:e});else if(g)a&&a({error:Error(g)});else try{if(f){var k=JSON.parse(f);a&&a({data:k})}else a&&a({})}catch(m){a&&a({error:Error(f)})}})}else a&&a({error:Error("zigbee usb stick not avaliable")})};return h}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zigbee.Handler);
