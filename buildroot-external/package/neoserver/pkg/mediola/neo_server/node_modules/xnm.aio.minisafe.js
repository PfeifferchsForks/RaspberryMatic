var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.minisafe=xnm.aio.minisafe||{};var Logger=require("x.logger.js");
xnm.aio.minisafe.Importer=function(a,b){this._ip=a;this._port=12345;b&&(this._port=b);this.setBaseAddress=!0;this._timeout=15E3;this._devicesToImport=[];this._importedDevices=[];this.onNotification=this._importPassword=this._importIP=null;a=require("xnm.aio.gateway.js");b=a.devicemanager.getSystem({sys:"aio",type:"ENOCEAN"}).DM.V6_DEVICES;this._AIODEVICES={};for(var d in a.devicemanager.getSystem({sys:"aio",type:"ENOCEAN"}).DM.V6_DEVICES)this._AIODEVICES[b[d].vendor]=b[d].subtypes;this._logger=require("x.logger.js").getLogger("xnm.aio.minisafe")};
xnm.aio.minisafe.Importer.prototype._getMiniSafeConfiguration=function(a){var b=require("http").request({host:this._ip,port:this._port,path:"/MediolaExport",method:"GET",timeout:this._timeout},function(d){var e="";d.setEncoding("utf8");d.on("data",function(c){e+=c});d.on("end",function(){var c=null;try{c=JSON.parse(e)}catch(f){}a&&(null!=c?a(null,c):a(Error("invalid data")),a=null)})});b.on("error",function(d){a&&(a(d),a=null)});b.setTimeout(this._timeout,function(){b.abort()});b.end()};
xnm.aio.minisafe.Importer.prototype._getBaseAddress=function(a){var b=4294967295,d;for(d in a){var e=a[d],c;for(c in e.transmissionInformation)if(e.transmissionInformation[c].transmissionID&&8==e.transmissionInformation[c].transmissionID.length){var f=parseInt(e.transmissionInformation[c].transmissionID,16);f<b&&(b=f)}}return 4294967295==b?null:b.toString(16).toUpperCase()};
xnm.aio.minisafe.Importer.prototype._getVendor=function(a){var b="general";if("eltako"==a.manufacturer||"Eltako GmbH"==a.manufacturer)b="eltako";return b};
xnm.aio.minisafe.Importer.prototype._compareType=function(a,b,d){var e=a.physicalDevice,c=null,f;for(f in a.deviceInformation)if(a.deviceInformation[f].eep){c=a.deviceInformation[f].eep;break}if(null==c&&a.transmissionInformation)for(var g in a.transmissionInformation)if(a.transmissionInformation[g].eep){c=a.transmissionInformation[g].eep;break}if(!d){if(b.id.toLowerCase()==e.toLowerCase()||c&&b.data.toLowerCase()==c.toLowerCase()||c&&b.eep&&b.eep.toLowerCase()==c.toLowerCase()||0==e.toLowerCase().indexOf(b.id.toLowerCase())||
0==b.id.toLowerCase().indexOf(e.toLowerCase()))return!0}else if(0<e.toLowerCase().indexOf(b.id.toLowerCase())||0<b.id.toLowerCase().indexOf(e.toLowerCase()))return!0;return!1};
xnm.aio.minisafe.Importer.prototype._getData=function(a){var b={type:"ENOCEAN",data:null,vendor:this._getVendor(a)};if(a.deviceInformation)if(1==a.deviceInformation.length)a.deviceInformation[0].deviceid&&(b.adr=a.deviceInformation[0].deviceid);else{var d=[],e;for(e in a.deviceInformation)a.deviceInformation[e].deviceid&&d.push(a.deviceInformation[e].deviceid);b.adr=JSON.stringify(d)}if(a.transmissionInformation)if(1==a.transmissionInformation.length)a.transmissionInformation[0].transmissionID&&(b.senderID=
a.transmissionInformation[0].transmissionID);else{d=[];for(var c in a.transmissionInformation)a.transmissionInformation[c].transmissionID&&d.push(a.transmissionInformation[c].transmissionID);b.senderID=JSON.stringify(d)}if(c=this._AIODEVICES[b.vendor])for(var f in c)if(1==this._compareType(a,c[f],!1)){b.data=c[f].data;break}if(null==b.data&&(c=this._AIODEVICES[b.vendor]))for(f in c)if(1==this._compareType(a,c[f],!0)){b.data=c[f].data;break}if(null==b.data&&(c=this._AIODEVICES.general))for(f in c)if(1==
this._compareType(a,c[f],!1)){b.data=c[f].data;b.vendor="general";break}if(null==b.data&&null==b.data&&(c=this._AIODEVICES.general))for(f in c)if(1==this._compareType(a,c[f],!0)){b.data=c[f].data;b.vendor="general";break}b.data&&"f6-02-03"==b.data&&(b.data="eltako_switch");return null==b.data?null:b};
xnm.aio.minisafe.Importer.prototype._setBaseAddress=function(a,b){a={type:"ENOCEAN",baseAdr:a};var d=new (require("xnm.aio.gateway.js").Gateway)(this._importIP);d.isV5=!0;d.timeout=2E3;d.password=this._importPassword;d.executeRequestV5("setConfig",a,function(e){e.error?b(!1):b(!0)})};
xnm.aio.minisafe.Importer.prototype._setDeviceData=function(a,b){var d=this._getData(a);d?(a=new (require("xnm.aio.gateway.js").Gateway)(this._importIP),a.isV5=!0,a.timeout=2E3,a.password=this._importPassword,a.executeRequestV5("addSensor",d,function(e){setTimeout(function(){b(e)},100)})):(this._logger.log("trace","Failed to import: "+a.manufacturer+" "+a.physicalDevice),setTimeout(function(){b(null)},0))};
xnm.aio.minisafe.Importer.prototype._importNextDevice=function(a){var b=this;if(0<this._devicesToImport.length){var d=this._devicesToImport.pop();this._setDeviceData(d,function(e){if(e&&a)if(e.data){if(Array.isArray(e.data))for(var c in e.data)d.location&&(e.data[c].location=d.location),e.data[c].name=d.friendlyId,0<c&&(e.data[c].name+="-"+c),0<c&&b._importedDevices.push(e.data[c]);else d.location&&(e.data.location=d.location),e.data.name=d.friendlyId,b._importedDevices.push(e.data);a(!0)}else b._logger.log("trace",
"Failed to set: "+d.manufacturer+" "+d.physicalDevice);b._importNextDevice(a)})}else a(!1)};xnm.aio.minisafe.Importer.prototype._importDevices=function(a,b){this._importedDevices=[];var d=this;this._devicesToImport=a;this._importNextDevice(function(e){0==e&&b(null,d._importedDevices)})};
xnm.aio.minisafe.Importer.prototype.importTo=function(a,b,d){this._importIP=a;this._importPassword=b;var e=this;this._getMiniSafeConfiguration(function(c,f){c?(e._logger.log("trace",c),d&&(d("failed to get configuration"),d=null)):f.devices&&(c=e._getBaseAddress(f.devices),e._logger.log("trace","Base address: "+c),null!=c&&1==e.setBaseAddress?e._setBaseAddress(c,function(g){1==g?e._importDevices(f.devices,d):d("failed to set base address")}):e._importDevices(f.devices,d))})};
xnm.aio.minisafe.Handler=function(){var a=function(){};a.prototype.Importer=xnm.aio.minisafe.Importer;return a}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.minisafe.Handler);
