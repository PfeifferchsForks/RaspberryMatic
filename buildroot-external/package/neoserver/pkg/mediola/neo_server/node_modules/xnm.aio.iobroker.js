var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.iobroker=xnm.aio.iobroker||{};
xnm.aio.iobroker.SimpleAPI=function(){var g=function(a,b,c,d,e){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI");this.ip=a;this.port=b;this.port||(this.port=8087);this.username=c;this.password=d;this.https=e;this._getStatesCBs=[]};g.prototype.executeCommand=function(a,b,c){if(a&&a.id)if(b&&b.value)switch(b.value){case "setValue":if(void 0==b.ext||null==b.ext){c&&c(Error("value invalid"));break}this._set(a.id,
{value:b.ext},c);break;case "toggleValue":this._toggle(a.id,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};g.prototype.getStates=function(a,b){var c=this._getStatesCBs.length;this._getStatesCBs.push(b);if(!(0<c)){var d=this;b=null;if(1===a.length)b=a[0];else if(1<a.length){a.sort(function(h,m){return h.length-m.length});c=a[0].split(".");for(var e="",f=0,k=Math.min(c.length,8);f<k;){for(var q=e+c[f],n=!1,l=1;l<a.length;l++)if(0!==
a[l].indexOf(q)){n=!0;break}if(n)break;e=q+".";f++}e&&("."===e[e.length-1]&&(e=e.substr(0,e.length-1)),b=e+"*",XC.debugf("ioBroker states pattern: "+b))}this._states(b,function(h,m){var p=d._getStatesCBs,r,t=null;d._getStatesCBs=[];if(h)XC.debugf(h.message,"error");else if(a&&0!=a.length)for(t={},r=0;r<a.length;r++)m[a[r]]&&(t[a[r]]=m[a[r]].val);else t=m;for(r=0;r<p.length;r++)p[r]&&p[r](h,t)})}};g.prototype.executeCommandCreator=function(a,b,c){b&&b.value?a&&a.id?(b=this._resolveCommand(a,b))?this.executeCommand(a,
b,function(d){c&&c(d)}):c&&c(Error("unknown command")):c&&c(Error("device json invalid")):c&&c(Error("command json invalid"))};g.prototype._resolveCommand=function(a,b){if(!b)return null;if("setGenValue"==b.value){var c=b.ext;if("undefined"==typeof c||null==c)c="";return{value:"setValue",ext:c}}if("toggle"==b.value)return{value:"toggleValue"};if(!a.common||!b.value)return null;switch(a.common.type){case "boolean":switch(b.value){case "on":case "press":case "longPress":case "stop":case "start":case "open":case "unlock":case "play":case "next":case "prev":case "pause":case "forward":case "reverse":case "fastforward":case "fastreverse":return{value:"setValue",
ext:!0};case "off":case "lock":return{value:"setValue",ext:!1}}break;case "number":c=a.common.min;a=a.common.max;switch(b.value){case "setValue":if("undefined"==typeof b.ext||null==b.ext)return null;b=parseFloat(b.ext);if(isNaN(b))return null;"undefined"==typeof c||null==c||isNaN(parseFloat(c))||b<parseFloat(c)&&(b=parseFloat(c));"undefined"==typeof a||null==a||isNaN(parseFloat(a))||b>parseFloat(a)&&(b=parseFloat(a));return{value:"setValue",ext:b};case "setRGB":return"undefined"==typeof b.ext||null==
b.ext?null:{value:"setValue",ext:cparseInt(b.ext,16)}}break;case "string":return"undefined"==typeof b.ext||null==b.ext?null:{value:"setValue",ext:b.ext};default:return null}};g.prototype.getStatesCreator=function(a,b,c){if(b)if(0==b.length)c&&c(null,[]);else{a=[];for(var d=0;d<b.length;d++){var e=b[d];e&&e.device&&e.device.id&&-1==a.indexOf(e.device.id)&&a.push(e.device.id)}var f=this;this.getStates(a,function(k,q){if(k)c&&c(k);else{k=[];for(var n=0;n<b.length;n++){var l=b[n];if(l&&l.id){var h=null;
l.device&&l.device.id&&l.status&&(h=q[l.device.id],h=f._resolveState(l.device,l.status,h));if("undefined"==typeof h||null==h)h="?";k.push({id:l.id,status:h})}}c&&c(null,k)}})}else c&&c(Error("deviceList is null"))};g.prototype._resolveState=function(a,b,c){if("undefined"==typeof c||null==c)return null;if(!b||!b.value||"genValue"==b.value)return c;if(!a||!a.common)return null;switch(a.common.type){case "boolean":switch(a.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":return c?
"on":"off";case "sensor.window":case "sensor.door":return c?"open":"closed";case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":return c?"unlock":"lock";case "media.state":return c?"play":"stop";default:return c}case "number":switch(a.common.role){case "value.window":return a.common.states?a.common.states[c]:{0:"closed",1:"titled",2:"open"}[c];case "value.time":return parseInt(c);case "media.state":return a.common.states?a.common.states[c]:{0:"play",1:"stop",2:"pause"}[c];
default:return a.common.states?a.common.states[c]:parseFloat(c)}case "string":return c;default:return c}};g.prototype.getStateObjectTree=function(a){var b=[],c=this;this._objects("instance",null,function(d,e){if(d)a&&a(d);else{d=0;for(var f in e)d++,c._insertTree(b,{id:f,name:f,type:e[f].type,children:[]});c._logger.log("debug","Found "+d+" instances.");c._objects("device",null,function(k,q){if(k)a&&a(k);else{k=0;for(var n in q)k++,c._insertTree(b,{id:n,name:n,type:q[n].type,children:[]});c._logger.log("debug",
"Found "+k+" devices.");c._objects("channel",null,function(l,h){if(l)a&&a(l);else{l=0;for(var m in h)l++,c._insertTree(b,{id:m,name:m,type:h[m].type,children:[]});c._logger.log("debug","Found "+l+" channels.");c._objects("state",null,function(p,r){if(p)a&&a(p);else{p=0;for(var t in r){p++;var u=r[t];c._insertTree(b,{sys:"iobroker",id:t,name:t,type:u.type,common:u.common})}c._logger.log("debug","Found "+p+" states.");c._logger.log("debug","Final tree has length of: "+b.length);a&&a(null,b)}})}})}})}})};
g.prototype._insertTree=function(a,b){if(a&&b){var c=b.name;"system.adapter."==c.substr(0,15)&&(c=c.substr(15),b.name=c);for(var d=0;d<a.length;d++){var e=a[d];if(e.name&&c.substr(0,e.name.length+1)==e.name+"."){b.name=c.substr(e.name.length+1);this._insertTree(e.children,b);return}}a.push(b)}};g.prototype.getAllAdapters=function(a){this._objects("adapter",null,function(b,c){console.log(b,c)})};g.prototype._objects=function(a,b,c){var d=null;if(a||b)d={};a&&(d.type=a);b&&(d.pattern=b);this._doRequest("GET",
"/objects",d,null,function(e,f){c&&c(e,f)})};g.prototype._getBulk=function(a,b){this._doRequest("GET","/getBulk/"+encodeURIComponent(a.join(",")),null,null,function(c,d){b&&b(c,d)})};g.prototype._get=function(a,b){var c=null;c=isArray(a)?encodeURIComponent(a.join(",")):encodeURIComponent(a);this._doRequest("GET","/get/"+c,null,null,function(d,e){b&&b(d,e)})};g.prototype._set=function(a,b,c){this._doRequest("GET","/set/"+encodeURIComponent(a),b,null,function(d,e){c&&c(d,e)})};g.prototype._toggle=function(a,
b){this._doRequest("GET","/toggle/"+encodeURIComponent(a),null,null,function(c,d){b&&b(c,d)})};g.prototype._states=function(a,b){var c=null;a&&(c={pattern:a});this._doRequest("GET","/states",c,null,function(d,e){b&&b(d,e)})};g.prototype._doRequest=function(a,b,c,d,e){var f=b;f||(f="/");var k={};c&&(k=JSON.parse(JSON.stringify(c)));this._logger.log("trace","do request: "+a+" "+b+"? "+k);this.username&&(k.user=this.username,k.pass=this.password);b="";for(var q in k)k.hasOwnProperty(q)&&(b&&(b+="&"),
b+=q+"="+encodeURIComponent(k[q]));b&&(f+="?"+b);a={host:this.ip,port:this.port,path:f,method:a,headers:{Connection:"close","Content-Type":"application/json; charset=utf-8"}};d&&(a.headers["Content-Length"]=d.length);f=require("http");this.https&&(f=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"));var n=this,l=e,h=f.request(a,function(m){m.setEncoding("utf-8");var p="";m.on("data",function(r){p+=r});m.on("end",function(){n._logger.log("trace",
"receive code:"+m.statusCode+" headers:"+JSON.stringify(m.headers)+" response:"+p);if(200==m.statusCode)try{var r=p?JSON.parse(p):{}}catch(u){var t=u}else t=Error("http reponse:"+m.statusCode);l&&(l(t,r,m.statusCode),l=null)})});if(h.on)h.on("error",function(m){n._logger.log("trace","do request error:"+m.message);l&&(l(m),l=null)});h.setTimeout&&h.setTimeout(1E4,function(){n._logger.log("trace","do request timeout");h.abort();l&&(l(Error("timeout")),l=null)});d&&(this._logger.log("trace","do request send body:"+
d),h.write(d));h.end()};g.prototype.toJSON=function(){return{sys:"iobroker",ip:this.ip,port:this.port,username:this.username,password:this.password,https:this.https}};g.prototype.equalsTo=function(a){return a&&a instanceof g?this.ip==a.ip&&this.username==a.username&&this.password==a.password:!1};g.parseJSON=function(a){return a.ip?new g(a.ip,a.port,a.username,a.password,a.https):null};return g}();
xnm.aio.iobroker.DM=function(){var g=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};g.prototype=Error();g.prototype.name="ioBrokerDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ioBroker",getGatewayType:function(){return[{sys:this.SYS,name:"ioBroker"}]},createGateway:function(a,b,c){b=g.ERROR_CODE;a?a.ip?c(null,a):c(new g(b.INVALID,"ip is invalid")):c(new g(b.INVALID,"info is invalid"))},updateGateway:function(a,
b,c,d){a=g.ERROR_CODE;b?b.ip?d(null,b):d(new g(a.INVALID,"ip is invalid")):d(new g(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var d=g.ERROR_CODE;if(a)if(a.id)if(a.type)if(a.common)if(a.gateway){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var f=b[e];break}f?c&&c(null,a):c(new g(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new g(d.INVALID,"gateway is invalid"));else c(new g(d.INVALID,"common is invalid"));
else c(new g(d.INVALID,"type is invalid"));else c(new g(d.INVALID,"id is invalid"));else c(new g(d.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=g.ERROR_CODE;if(a)if(a.id)if(a.type)if(a.common)if(a.gateway){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var f=b[e];break}f?c(null,a):c(new g(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new g(d.INVALID,"gateway is invalid"));else c(new g(d.INVALID,"common is invalid"));else c(new g(d.INVALID,
"type is invalid"));else c(new g(d.INVALID,"id is invalid"));else c(new g(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,c){var d=function(n,l){if("*"==n)return!0;for(var h=!1,m=0;m<n.length;m++)if(n[m]==l){h=!0;break}return h},e=function(n,l,h){var m=[];"command"==h.catagory?n.command&&n.command.forEach(function(p){d(h.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),m.push(p))}):"status"==h.catagory&&n.status&&n.status.forEach(function(p){d(h.elems,p.type)&&
(p=JSON.parse(JSON.stringify(p)),m.push(p))});return m},f=function(n,l){var h=[],m=xnm.aio.iobroker.DM.getCommandStatusMap(n,c);m&&(n=e(m,n,l),h=h.concat(n));return h};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),q=null;if("command"==b.catagory)q=f(a,b),k.command=q;else if("status"==b.catagory)q=f(a,b),k.status=q;else return null;return q&&0!=q.length?k:null},getCommandStatusMap:function(a,b){if(!a||"state"!=a.type||!a.common)return null;b={command:[],status:[]};var c=a.common.min,d=
a.common.max,e=a.common.unit;if(a.common.write)switch(b.command.push({type:"string",name:"set generic value",ref:{value:"setGenValue",ext:"%s"}}),a.common.type){case "boolean":switch(a.common.role){case "button":b.command.push({type:"enum",name:"press",ref:{value:"press"}});break;case "button.long":b.command.push({type:"enum",name:"long press",ref:{value:"longPress"}});break;case "button.stop":b.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "button.start":b.command.push({type:"enum",
name:"start",ref:{value:"start"}});break;case "button.open.door":case "button.open.window":b.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "switch.lock":case "switch.lock.door":case "switch.lock.window":b.command.push({type:"enum",name:"unlock",ref:{value:"unlock"}});b.command.push({type:"enum",name:"lock",ref:{value:"lock"}});b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;case "media.state ":b.command.push({type:"enum",name:"play",ref:{value:"play"}});
b.command.push({type:"enum",name:"stop",ref:{value:"stop"}});b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;default:b.command.push({type:"enum",name:"on",ref:{value:"on"}}),b.command.push({type:"enum",name:"off",ref:{value:"off"}}),b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}})}break;case "number":switch(a.common.role){case "level.temperature":var f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"5.0-40.0"}};if("undefined"==typeof c||
null==c)c=5;if("undefined"==typeof d||null==d)d=40;f.ref.extMeta=c+"-"+d;e&&(f.ref.unit=e);b.command.push(f);break;case "level.color.red":case "level.color.green":case "level.color.blue":case "level.color.white":f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-255"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof d||null==d)d=255;f.ref.extMeta=c+"-"+d;e&&(f.ref.unit=e);b.command.push(f);break;case "level.color.rgb":f={type:"float",name:"set value",ref:{value:"setValue",
ext:"%f",extMeta:"0-16777215"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof d||null==d)d=16777215;f.ref.extMeta=c+"-"+d;e&&(f.ref.unit=e);b.command.push(f);f={type:"rgb",name:"set RGB",ref:{value:"setRGB",ext:"%s"}};b.command.push(f);break;default:f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-100"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof d||null==d)d=100;f.ref.extMeta=c+"-"+d;e&&(f.ref.unit=e);b.command.push(f)}break;case "string":b.command.push({type:"string",
name:"set value",ref:{value:"setValue",ext:"%s"}})}if(a.common.read||"undefined"==typeof a.common.read)switch(b.status.push({type:"string",name:"generic value",ref:{value:"genValue"}}),a.common.type){case "boolean":switch(a.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":b.status.push({type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}});break;case "sensor.window":case "sensor.door":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}});break;case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["unlock","lock"]}});break;case "media.state":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["play","stop"]}});break;default:b.status.push({type:"enum",name:"state",
ref:{value:"state",options:["true","false"]}})}break;case "number":switch(a.common.role){case "value.window":f={type:"enum",name:"state",ref:{value:"state",options:[]}};for(var k in a.common.states)a.common.states.hasOwnProperty(k)&&(c=a.common.states[k],"undefined"!=typeof c&&null!=c&&f.ref.options.push(c));0==f.ref.options.length&&(f.ref.options=["closed","tilted","open"]);b.status.push(f);break;case "value.time":b.status.push({type:"int",name:"state",ref:{value:"state"}});break;case "media.state":f=
{type:"enum",name:"state",ref:{value:"state",options:[]}};for(k in a.common.states)a.common.states.hasOwnProperty(k)&&(c=a.common.states[k],"undefined"!=typeof c&&null!=c&&f.ref.options.push(c));0==f.ref.options.length&&(f.ref.options=["play","stop","pause"]);b.status.push(f);break;default:if(a.common.states)for(k in f={type:"enum",name:"state",ref:{value:"state",options:[]}},a.common.states)a.common.states.hasOwnProperty(k)&&(c=a.common.states[k],"undefined"!=typeof c&&null!=c&&f.ref.options.push(c));
else{f={type:"float",name:"state",ref:{value:"state"}};if("undefined"!=typeof c&&null!=c&&"undefined"==typeof d||null!=d)f.ref.extMeta=c+"-"+d;e&&(f.ref.unit=e)}b.status.push(f)}break;case "string":b.status.push({type:"string",name:"state",ref:{value:"state"}})}return b}}}();
xnm.aio.iobroker.Handler=function(){var g=function(){};g.prototype.devicemanager=xnm.aio.iobroker.DM;g.prototype.SimpleAPI=xnm.aio.iobroker.SimpleAPI;g.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"iobroker")};g.prototype.resolveGateway=function(a){return a?this.SimpleAPI.parseJSON(a):null};g.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};g.prototype.getDeviceStatus=function(a,b){a=
(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};g.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};g.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(f,k){f?e&&e(f):e&&e(null,k[0])}):e&&e(Error("gateway json format invalid"))};g.prototype.getDeviceList=function(a,b){(a=
this.resolveGateway(a))?a.getStateObjectTree(function(c,d){b&&b(c,d)}):b&&b(Error("gateway json format invalid"))};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.iobroker.Handler);
