var x=x||{};x.mjpeg=x.mjpeg||{};
x.mjpeg.Client=function(){var q=function(f,b){this._mjpegUrl=f;this._options=b;this._mjpegClientID=null};q.prototype.getFile=function(f,b,c){this._getFile(f,b,c)};q.prototype._getFile=function(f,b,c){b.url=f;var a=this;this._mjpegClientID?(b.clientID=this._mjpegClientID,XC.callHost("mjpeg","getMjpegFile",b,function(d){d&&!d.error&&d.file?(d.clientID&&(a._mjpegClientID=d.clientID),c&&c(d.file)):c&&c()})):XC.callHost("mjpeg","buildSocket",b,function(d){!d||d.error?c&&c():d.clientID&&(a._mjpegClientID=
d.clientID,a._getFile(f,b,c))})};var m=function(f,b){this._mjpegUrl=f;this._options=b;this._timeout=this._currentImage=this._stream=null};m.prototype.getFile=function(f,b,c){var a=this;null!=this._timeout&&(clearTimeout(this._timeout),this._timeout=setTimeout(function(){a._timeout=null;a._close()},1E4));this._stream?a._writeImage2File(a._currentImage,c):this._connect(f,b,function(d,k){d?(a._stream=d,a._currentImage=k,null!=a._timeout&&clearTimeout(a._timeout),a._timeout=setTimeout(function(){a._timeout=
null;a._close()},1E4),a._writeImage2File(a._currentImage,c)):c&&c(null)})};m.prototype._writeImage2File=function(f,b){if(null==f)b&&b(null);else{var c=require("fs"),a=require("os").tmpdir();a.charAt(a.length-1)!=require("path").sep&&(a+=require("path").sep);a=a+"xcdl"+require("path").sep;var d=a+Math.random().toString(36).substring(2);try{c.existsSync(a)||c.mkdirSync(a)}catch(k){b&&b(null);return}c.writeFile(d,f,function(k){b&&b(k?null:d)})}};m.prototype._connect=function(f,b,c,a){var d=this,k=require("url").parse(f),
r=80;if(k.port&&(r=parseInt(k.port),0==r&&(r=80),!(0<r&&65536>r))){c&&c(null);return}var t={host:k.hostname,port:r,path:k.path,method:"GET"};b&&b.user&&(t.auth=b.user+":"+b.password);a&&(t.headers=t.headers||{},t.headers.Authorization=a);k=require("http");"https"==f.substring(0,5).toLowerCase()&&(k=require("https"));var e=c,u=k.request(t,function(g){if(200==g.statusCode){e&&(e(u),e=null);var l,n=-1,p=-1,h=new Buffer([]);g.on("end",function(){e&&(e(null),e=null);d._stream=null;d._close()});g.on("data",
function(w){w&&(h=Buffer.concat([h,w]));if(-1==n)for(l=0;l<h.length;l++)if(255==h[l]&&216==h[l+1]){n=l;break}if(0<=n&&-1==p)for(l=h.length-2;l>n;l--)if(255==h[l]&&217==h[l+1]){p=l+1;break}0<=n&&0<p?(d._currentImage=h.slice(n,p),h=p==h.length-1?new Buffer([]):h.slice(p+1),p=n=-1):204800<h.length&&d._close()})}else 302==g.statusCode?g.headers.location?(d._connect(g.headers.location,b,c),g.destroy()):e&&(e(null),e=null):401!=g.statusCode||a?e&&(e(null),e=null):(a=null,g.headers&&g.headers["www-authenticate"]&&
"Digest "==g.headers["www-authenticate"].substr(0,7)?(a=require("x.crypt.js").DigestAuth(g.headers["www-authenticate"],t.path,b.user,b.password))?d._connect(f,b,c,a):e&&(e(null),e=null):e&&(e(null),e=null))});u.setTimeout(3E4,function(){u.abort()});u.on("error",function(g){e?(e(null),e=null):(d._stream=null,d._close())});u.end()};m.prototype._close=function(){this._stream&&this._stream.abort();this._timeout&&clearTimeout(this._timeout);this._timeout=this._currentImage=this._stream=null};var v=function(){};
v.getClient=function(f,b){var c=null;window&&!window.XCHost&&(c="node-webkit");window&&window.XCHost&&window.XCHost.getType&&(c=window.XCHost.getType());if("Android"==c)return new q(f,b);if("node-webkit"==c||process&&"node"==process.title)return new m(f,b);throw Error("iOS should not use mjpeg client");};return v}();x.mjpeg.Handler=function(){var q=function(){};q.prototype.getClient=function(m,v){if(!m)throw Error("mjpeg url invalid");return x.mjpeg.Client.getClient(m,v)};return q}();
"undefined"!=typeof module&&null!=module&&(module.exports=new x.mjpeg.Handler);
