var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zwave=x.hub.m.zwave||{};var ozws=require("openzwave-shared"),os=require("os");
x.hub.m.zwave.OZW=function(){var f=function(b,a){this._logger=require("x.logger.js").getLogger("x.hub.m.zwave.OZW");this._port=b;this._key=a;this._controller=null;this._initSuccess=!1;this._nodes={};this.CommandHandler=null};f.prototype._setPersistantData=function(b){if(localStorage)for(var a in b)localStorage.setItem("xnm.aio.zwave.OZW."+a,b[a])};f.prototype._evalValue=function(b,a,d){var c=1;d.instance&&(c=d.instance);this._nodes[b].states[c]||(this._nodes[b].states[c]={});50==a?"decimal"==d.type&&
(this._nodes[b].states[c].power=d.value,this._nodes[b].states[c].state||(this._nodes[b].states[c].state="0.0"==d.value?"off":"on")):37==a?this._nodes[b].states[c].state=1==d.value?"on":"off":38==a?this._nodes[b].states[c].state=d.value:67==a?this._nodes[b].states[c].setpoint=d.value:66==a?this._nodes[b].states[c].state=d.value:68==a?this._nodes[b].states[c].fanmode=d.value:69==a?this._nodes[b].states[c].fanstate=d.value:49==a&&""!=d.units&&(1==this._initSuccess&&this._controller&&this._nodes[b].states[c].temperature!=
d.value&&this._controller.writeConfig(),this._nodes[b].states[c].temperature=d.value)};f.prototype.init=function(b){this._logger.log("trace","init ozw");var a=this;this._initSuccess=!1;if(!this._controller){var d=new ozws({ConsoleOutput:!1});d.on("driver ready",function(c){a._logger.log("debug","driver ready")});d.on("driver failed",function(){a._logger.log("warn","failed to start driver");d.disconnect();a._initSuccess=!1;b&&b(!1)});d.on("value added",function(c,e,g){a._nodes[c]||(a._nodes[c]={info:{},
states:{},ready:!1});a._nodes[c].info.classes||(a._nodes[c].info.classes=[]);-1==a._nodes[c].info.classes.indexOf(e)&&a._nodes[c].info.classes.push(e);a._evalValue(c,e,g)});d.on("node ready",function(c,e){a._nodes[c]||(a._nodes[c]={info:{},states:{},ready:!1});a._nodes[c].info.classes||(a._nodes[c].info.classes={});a._nodes[c].ready=!0;a._nodes[c].info.type=e.type;a._nodes[c].info.producttype=e.producttype;a._nodes[c].info.manufacturer=e.manufacturer;a._nodes[c].info.manufacturerid=e.manufacturerid;
a._nodes[c].info.product=e.product;a._nodes[c].info.productid=e.productid;for(var g in a._nodes[c].info.classes)switch(e=a._nodes[c].info.classes[g],e){case 37:case 38:case 66:case 67:case 68:case 69:d.enablePoll(c,e)}});d.on("node added",function(c){a._logger.log("trace","added node: "+c);a._nodes[c]||(a._nodes[c]={info:{},states:{},ready:!1})});d.on("node event",function(c,e){a._logger.log("trace","event from node "+c)});d.on("value changed",function(c,e,g){a._logger.log("trace","value changed for node "+
c);a._evalValue(c,e,g);a._logger.log("trace","new state:"+JSON.stringify(a._nodes[c].states))});d.on("notification",function(c,e){});d.on("scan complete",function(){a._logger.log("trace","scan complete");a._initSuccess=!0;b&&b(!0)});this._controller=d}this._controller.connect(this._port)};f.prototype.close=function(){this._logger.log("trace","close ozw");this._controller&&(this._initSuccess=!1,this._controller.disconnect())};f.prototype.getDevices=function(b){b&&b(this._nodes);return this._nodes};
f.prototype.addNode=function(b,a,d){var c=30;d&&(c=d);if(this._controller){var e=this;setTimeout(function(){XC.debugf("addNode timeout?");e._controller.cancelControllerCommand()},1E3*c);this._controller.addNode(b)}else a(null)};f.prototype.removeNode=function(b){this._controller&&(0==this._nodes[b].ready?this._controller.removeFailedNode(b):this._controller.removeNode(b))};f.prototype.executeCommand=function(b,a,d){try{if(this._controller){var c="1";b.instance&&(c=b.instance);"switch"==b.type||"powerswitch"==
b.type?("toggle"==a&&(a="off",this._nodes[b.address].states&&this._nodes[b.address].states[c]&&"off"==this._nodes[b.address].states[c].state&&(a="on")),"on"==a?this._controller.setValue(b.address,37,c,0,!0):"off"==a&&this._controller.setValue(b.address,37,c,0,!1)):"dimmer"==b.type?(0==a.indexOf("dimTo")?(a=a.replace(/dimTo/g,""),a=a.replace(/%/g,"")):0==a.indexOf("toggleTo")&&(a=a.replace(/toggleTo/g,""),a=a.replace(/%/g,""),this._nodes[b.address]&&this._nodes[b.address].states&&this._nodes[b.address].states[c]&&
0<parseInt(this._nodes[b.address].states[c].state)&&(a="0")),100<parseInt(a)&&(a="100"),this._controller.setValue({node_id:b.address,class_id:38,instance:c,index:0},a),this._nodes[b.address].states[c].state=parseInt(a)):"HM6-HP"==b.type&&(0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),5>parseFloat(a)&&(a="5.0"),37<parseFloat(a)&&(a="37.0"),this._controller.setValue({node_id:b.address,class_id:67,instance:c,index:2},a),this._nodes[b.address].states[c].setpoint=a)}}catch(e){console.error(e.stack),
this._logger.log("trace","failed to execute command:"+e.message)}d&&d()};f.prototype.getAllBufferedStates=function(){var b=[],a;for(a in this._nodes)if(this._nodes.hasOwnProperty(a)){var d=this._nodes[a];if(d&&d.states)for(var c in d.states)d.states.hasOwnProperty(c)&&b.push({address:a,instance:c,state:d.states[c]})}return b};f.prototype.getStates=function(b,a,d){b={};for(var c=0;c<a.length;c++){var e=a[c];if(this._nodes[e.address]){var g="1";e.instance&&(g=e.instance);this._nodes[e.address].states[g]&&
(b[e.id]=this._nodes[e.address].states[g])}}d&&d(b);return b};f.prototype.getStateValues=function(b,a){return a};return f}();
x.hub.m.zwave.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("xnm.hub.m.zwave.Handler");this._ozw=null};util.inherits(f,EventEmitter);f.prototype.OZW=x.hub.m.zwave.OZW;f.prototype.getSystems=function(){return["zwave"]};f.prototype.init=function(b){var a=this;process.on("SIGINT",function(){a._logger.log("debug","system exiting, disconnect zwave serial connection...");a._ozw&&a._ozw.close();setTimeout(function(){process.exit()},200)});var d=require("x.hub.eventbus.js");
d.on("x.hub.peripheralman.ADD_ZWAVE",function(c){a._attachSerial(c.port)});d.on("x.hub.peripheralman.REMOVE_ZWAVE",function(c){a._removeSerial(c.port)});global.ZWAVE_PORT&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&this._attachSerial(global.ZWAVE_PORT);b&&b({})};f.prototype.getAllStates=function(){return this._ozw?this._ozw.getAllBufferedStates():[]};f.prototype.executeCommand=function(b,a,d){b&&b.address&&b.type?a&&a.value?this._ozw?this._ozw.executeCommand(b,a.value,function(c){d&&d({error:c})}):
d&&d({error:Error("zwave serial not initialized")}):d&&d({error:Error("command invalid")}):d&&d({error:Error("device invalid")})};f.prototype.getAllStatesLegacy=function(b){var a=[];this.getAllStates().forEach(function(d){if(d&&d.address&&d.state){var c=d.address,e=d.instance;e||(e="1");a.push({module:"zwave",type:"ZWAVE",adr:c+"."+e,state:d.state})}});b&&b({data:a})};f.prototype.executeCommandLegacy=function(b,a,d,c,e){if(b)e&&e({error:Error("not supported yet")});else if(a)if(d)if(c){b=a;var g=
"1",h=a.indexOf(".");-1!=h&&(b=a.substr(0,h),g=a.substr(h+1));this.executeCommand({address:b,instance:g,type:d},{value:c},function(k){e&&e({error:k?k.error:null})})}else e&&e({error:Error("command invalid")});else e&&e({error:Error("type invalid")});else e&&e({error:Error("address invalid")})};f.prototype._attachSerial=function(b){this._logger.log("trace","zwave usb stick attached at port:"+b);this._ozw||(this._ozw=new x.hub.m.zwave.OZW(b));this._ozw._port=b;this._logger.log("trace","init ozw at port:"+
b);this._ozw.init()};f.prototype._removeSerial=function(b){this._logger.log("trace","zwave usb stick removed from port:"+b);this._ozw&&(this._logger.log("trace","close ozw at port:"+b),this._ozw.close())};return f}();x.hub.m.zwave.Handler.prototype.getStateValues=function(f,b){return(new xnm.aio.zwave.OZW).getStateValues(f.type,b)};
x.hub.m.zwave.Handler.prototype.getDeviceCommandList=function(f,b,a){b=[];"switch"==f.type?(b.push({id:"on",cmd:"on"}),b.push({id:"off",cmd:"off"}),b.push({id:"toggle",cmd:"toggle"})):"dimmer"==f.type?b.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"}):"HM6-HP"==f.type&&b.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5.0",max:"37.0"});return b};x.hub.m.zwave.Handler.prototype.__getStates=function(f,b){this._ozw?this._ozw.getStates(null,f,function(a){b&&b({data:a})}):b&&b({error:Error("zwave serial not initialized")})};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zwave.Handler);
