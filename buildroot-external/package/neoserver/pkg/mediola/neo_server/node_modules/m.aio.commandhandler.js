var m=m||{};m.aio=m.aio||{};m.aio.commandhandler=m.aio.commandhandler||{};m.aio.commandhandler.Task=function(a,b){this.type=a;this.callback=b;this.devices=this.command=this.device=null};m.aio.commandhandler.Task.TYPE={DO_COMMAND:0,DO_STATUS:1,DO_SINGLE_DEVICE_STATUS:2};m.aio.commandhandler.Queue=function(){this._queue=[]};m.aio.commandhandler.Queue.prototype.push=function(a){this._queue.push(a)};
m.aio.commandhandler.Queue.prototype.pop=function(){var a=this._queue.splice(0,1);return a.length?a[0]:null};m.aio.commandhandler.Queue.prototype.size=function(){return this._queue.length};m.aio.commandhandler.ExecutionQueue=function(a){this._executor=a;this._state=0;this._queue=new m.aio.commandhandler.Queue};m.aio.commandhandler.ExecutionQueue.prototype.pushTask=function(a){this._executeTask(a)};
m.aio.commandhandler.ExecutionQueue.prototype._executeTask=function(a){this._executor.executeTask(a,function(){}.bind(this))};m.aio.commandhandler.Executor=function(a,b,e){this.sys=a;this._host=b;this._queue=new m.aio.commandhandler.ExecutionQueue(this);this._handler=e};m.aio.commandhandler.Executor.prototype.getHost=function(){return this._host};m.aio.commandhandler.Executor.prototype.execute=function(a){this._queue.pushTask(a)};
m.aio.commandhandler.Executor.prototype.executeTask=function(a,b){switch(a.type){case m.aio.commandhandler.Task.TYPE.DO_COMMAND:if(!this._host||!this._host.executeCommandCreator){a.callback&&a.callback(Error("device accept no command"));break}this._host.executeCommandCreator(a.device,a.command,function(e,c){a.callback&&a.callback(e,c);b&&b()});break;case m.aio.commandhandler.Task.TYPE.DO_STATUS:if(!this._host||!this._host.getStatesCreator){a.callback&&a.callback(Error("device has no states"));break}this._host.getStatesCreator(this._handler,
a.devices,function(e,c,d){a.callback&&a.callback(e,c,d);b&&b()});break;case m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS:if(!this._host||!this._host.getSingleDeviceStatesCreator){a.callback&&a.callback(Error("device has no such function"));break}this._host.getSingleDeviceStatesCreator(this._handler,a.device,a.devices,function(e,c){a.callback&&a.callback(e,c);b&&b()});break;default:b&&b()}};m.aio.commandhandler.ExecutorPool=function(){this._executors=[]};
m.aio.commandhandler.ExecutorPool.prototype.getExecutor=function(a,b){for(var e=null,c=0;c<this._executors.length;c++){var d=this._executors[c];if(d.sys==a&&d._host&&d._host.equalsTo&&"function"==typeof d._host.equalsTo&&d._host.equalsTo(b)){e=d;break}}return e};m.aio.commandhandler.ExecutorPool.prototype.addExecutor=function(a){this._executors.push(a)};m.aio.commandhandler.IntHandler=function(){this._executorPool=new m.aio.commandhandler.ExecutorPool;this._statesListener=this._cloudForwardHost=null};
m.aio.commandhandler.IntHandler.prototype.setStatesListener=function(a){this._statesListener=a};
m.aio.commandhandler.IntHandler.prototype.resolveHost=function(a,b,e,c){if(a){if(!a.sys){c&&c(Error("gateway json format in valid"));return}var d=a.sys}else{if(!b.sys){c&&c(Error("device json format in valid"));return}d=b.sys}var g=require("m.aio.devicemanager").getModule(d);if(g){var f;a&&g.resolveGateway&&"function"==typeof g.resolveGateway?f=g.resolveGateway(a):g.resolveDevice&&"function"==typeof g.resolveDevice&&(f=g.resolveDevice(b,e));f?c&&c(null,f,d):c&&c(Error("resolve device object error"))}else c&&
c(Error("module "+d+" do not exist"))};
m.aio.commandhandler.IntHandler.prototype.executeCommand=function(a,b,e,c,d,g,f){b?(f=this._executorPool.getExecutor(a,b),f||(f=new m.aio.commandhandler.Executor(a,b,this),b._deviceInfo||this._executorPool.addExecutor(f)),b=f.getHost(),this._cloudForwardHost&&this._cloudForwardHost!=b?this._cloudForwardHost.forwardExecuteCommand(g,e,c,d):("aio"!=a&&"neoserver"!=a||!c||"cfOn"!=c.value&&"cfOff"!=c.value&&"cfToggle"!=c.value||("cfOn"==c.value?this._cloudForwardHost=b:"cfOff"==c.value?this._cloudForwardHost=
null:b&&(this._cloudForwardHost="on"==b._cfSetting?null:b)),a=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_COMMAND,d),a.device=e,a.command=c,f.execute(a))):d&&d(Error("invalid host"))};
m.aio.commandhandler.IntHandler.prototype.getStates=function(a,b,e,c,d,g,f){b?(f=this._executorPool.getExecutor(a,b),f||(f=new m.aio.commandhandler.Executor(a,b,this),this._executorPool.addExecutor(f)),a=f.getHost(),this._cloudForwardHost&&this._cloudForwardHost!=a?this._cloudForwardHost.forwardGetStates(d,g,e,c):(c=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_STATUS,c),c.devices=e,f.execute(c))):c&&c(Error("invalid host"))};
m.aio.commandhandler.IntHandler.prototype.getStatesForSingleDevice=function(a,b,e,c,d){if(b){var g=this._executorPool.getExecutor(a,b);g||(g=new m.aio.commandhandler.Executor(a,b,this),this._executorPool.addExecutor(g));a=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS,d);a.device=e;a.devices=c;g.execute(a)}else d&&d(Error("invalid host"))};
m.aio.commandhandler.IntHandler.prototype.reportStates=function(a,b){this._statesListener&&this._statesListener.reportStates&&this._statesListener.reportStates(a,b)};m.aio.commandhandler._SingeltonHandler=new m.aio.commandhandler.IntHandler;m.aio.commandhandler.Handler=function(){};m.aio.commandhandler.Handler.prototype.Handler=m.aio.commandhandler.IntHandler;m.aio.commandhandler.Handler.prototype.CentralHandler=m.aio.commandhandler._SingeltonHandler;
"undefined"!==typeof module&&null!=module&&module.exports&&(module.exports=new m.aio.commandhandler.Handler);
