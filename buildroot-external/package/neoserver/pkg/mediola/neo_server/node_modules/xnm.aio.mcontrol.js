var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,c,f){d instanceof String&&(d=String(d));for(var h=d.length,g=0;g<h;g++){var b=d[g];if(c.call(f,b,g,d))return{i:g,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,c,f){if(d==Array.prototype||d==Object.prototype)return d;d[c]=f.value;return d};$jscomp.getGlobal=function(d){d=["object"==typeof globalThis&&globalThis,d,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<d.length;++c){var f=d[c];if(f&&f.Math==Math)return f}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(d,c){var f=$jscomp.propertyToPolyfillSymbol[c];if(null==f)return d[c];f=d[f];return void 0!==f?f:d[c]};
$jscomp.polyfill=function(d,c,f,h){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(d,c,f,h):$jscomp.polyfillUnisolated(d,c,f,h))};$jscomp.polyfillUnisolated=function(d,c,f,h){f=$jscomp.global;d=d.split(".");for(h=0;h<d.length-1;h++){var g=d[h];if(!(g in f))return;f=f[g]}d=d[d.length-1];h=f[d];c=c(h);c!=h&&null!=c&&$jscomp.defineProperty(f,d,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(d,c,f,h){var g=d.split(".");d=1===g.length;h=g[0];h=!d&&h in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var b=0;b<g.length-1;b++){var a=g[b];if(!(a in h))return;h=h[a]}g=g[g.length-1];f=$jscomp.IS_SYMBOL_NATIVE&&"es6"===f?h[g]:null;c=c(f);null!=c&&(d?$jscomp.defineProperty($jscomp.polyfills,g,{configurable:!0,writable:!0,value:c}):c!==f&&(void 0===$jscomp.propertyToPolyfillSymbol[g]&&(f=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[g]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(g):$jscomp.POLYFILL_PREFIX+f+"$"+g),$jscomp.defineProperty(h,$jscomp.propertyToPolyfillSymbol[g],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(c,f){return $jscomp.findInternal(this,c,f).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mcontrol=xnm.aio.mcontrol||{};
xnm.aio.mcontrol.MControl=function(){var d={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},c=function(b){return b.replace(/[<>&"']/g,function(a){return d[a]})},f=function(b,a,e){this.device=b;this.command=a;this.callback=e;this._socket=null};f.prototype.run=function(b){var a=this;b._connect({onError:function(e){a._finish(e)},onTimeout:function(){a._finish(Error("response timeout"))},onData:function(){a._socket.end();a._finish()},onClose:function(){a._finish()}},function(e,l){e?a._finish(e):
(a._socket=l,e=b._buildCommand(a.device,a.command),l.write(e,"utf8"))})};f.prototype._finish=function(b){this.callback&&this.callback(b);this.callback=null};var h=function(b,a){this.deviceList=b;this.callback=a;this._socket=null;this._block="";this._responseComplete=!1};h.prototype.run=function(b){var a=this;b._connect({onError:function(e){a._finish(e)},onTimeout:function(){a._responseComplete||a._finish(Error("response timeout"))},onData:function(e){a._block+=e;a._handleRsp()},onClose:function(){a._finish()}},
function(e,l){e?a._finish(e):(a._socket=l,e=b._buildStatus(a.deviceList),l.write(e,"utf8"))})};h.prototype._finish=function(b,a){this.callback&&this.callback(b,a);this.callback=null};h.prototype._handleRsp=function(){var b=this._block.indexOf("\n");if(!(0>=b))if("XML"!=this._block.substr(0,b))this._block="";else{var a=this._block.indexOf("\n",b+1);0>a||(b=this._block.substr(b+1,a-b-1),b=parseInt(b),this._block.length<b+4+9||(this._responseComplete=!0,a=this._block.substr(a+1),0==a.charCodeAt(a.length-
1)&&(a=a.substr(0,a.length-1)),this._parseStatus(a),this._socket.end()))}};h.prototype._parseStatus=function(b){var a=[];$($.parseXML(b)).find("return").each(function(){var e=$(this),l=e.attr("name");e=e.attr("value");a.push({id:l,status:e})});this._finish(null,a)};var g=function(b,a){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.mcontrol.MControl"):{log:function(){}};this.ip=b;this.port=a;this.port||(this.port=8082)};g.prototype.REQ='<?xml version="1.0"?>\n<mctrlmessage>\n<request name="@1" module="@2">\n@3</request>\n</mctrlmessage>\n';
g.prototype.PARAM='<param name="@1" value="@2" />\n';g.prototype.executeCommandCreator=function(b,a,e){var l=a.ext;a.value&&"do"!=a.value&&"setInt"!=a.value&&"setFloat"!=a.value&&(l=a.value+(null!=l&&"undefined"!=typeof l?l:""));this.executeCommand(b.address,l,function(n){e&&e(n)})};g.prototype.getStatesCreator=function(b,a,e){if(a)if(0==a.length)e&&e(null,[]);else{b={};for(var l=0;l<a.length;l++)a[l]&&a[l].id&&a[l].device&&a[l].device.address&&(b[a[l].id]=a[l].device.address);this.getStates(b,function(n,
m){if(n)e&&e(n);else{n={};for(var k=0;k<a.length;k++)a[k]&&a[k].id&&a[k].status&&a[k].status.value&&(n[a[k].id]=a[k].status.value);k=[];m||(m=[]);for(var p=0;p<m.length;p++){var q=m[p].status;"intVal"==n[m[p].id]?(q=parseInt(q),isNaN(q)||k.push({id:m[p].id,status:q})):"floatVal"==n[m[p].id]?(q=parseFloat(q),isNaN(q)||k.push({id:m[p].id,status:q})):k.push({id:m[p].id,status:m[p].status})}e&&e(null,k)}})}else e&&e(Error("deviceList is null"))};g.prototype.executeCommand=function(b,a,e){b&&null!=a&&
"undefined"!=typeof a?(new f(b,a,e)).run(this):e&&e(Error("argument invalid"))};g.prototype.getStates=function(b,a){b?(new h(b,a)).run(this):a&&a(Error("deviceList is null"))};g.prototype._buildCommand=function(b,a){var e=g.prototype.PARAM.replace("@1","command");b=b.split(".");e=e.replace("@2",c(b[0]+"."+(b[1]?b[1]+".":"")+a));a=g.prototype.REQ.replace("@1","ExecuteCommand");a=a.replace("@2","hcontrol");a=a.replace("@3",e);e=a.length;for(e=e.toString();8>e.length;)e="0"+e;return"MCM:PLUGIN\nXML\n"+
e+"\n"+a};g.prototype._buildStatus=function(b){var a="",e;for(e in b)if(b.hasOwnProperty(e)){var l=g.prototype.PARAM.replace("@1",c(e));l=l.replace("@2",c(b[e]));a+=l}b=g.prototype.REQ.replace("@1","GetStates");b=b.replace("@2","hcontrol");b=b.replace("@3",a);a=b.length;for(a=a.toString();8>a.length;)a="0"+a;return"MCM:PLUGIN\nXML\n"+a+"\n"+b};g.prototype._connect=function(b,a){var e=this,l={port:this.port,host:this.ip},n=!1,m=a,k=require("net").connect(l);b.__socket=k;k.setTimeout(1E4);k.setEncoding("utf8");
k.on("connect",function(){e._logger.log("trace","connect tcp to:"+e.ip);n=!0;if(m){var p=b.__socket;delete b.__socket;m(null,p)}});k.on("data",function(p){e._logger.log("trace","receive from tcp:"+e.ip+" data:"+p);b.onData(p)});k.on("error",function(p){n?(e._logger.log("trace","tcp:"+e.ip+" error:"+p.message),k.end(),b.onError(p)):(e._logger.log("trace","tcp:"+e.ip+" connection error:"+p.message),m&&(m(p),m=null))});k.on("timeout",function(){n?(e._logger.log("trace","tcp:"+e.ip+" data timeout"),k.end(),
b.onTimeout()):(e._logger.log("trace","tcp:"+e.ip+" connection timeout"),k.end(),m&&(m(Error("connection timeout")),m=null))});k.on("close",function(){e._logger.log("trace","tcp:"+e.ip+" close socket");b.onClose()});k._doConnect&&"function"==typeof k._doConnect&&k._doConnect()};g.prototype.toJSON=function(){return{sys:xnm.aio.mcontrol.DM.SYS,ip:this.ip,port:this.port}};g.prototype.equalsTo=function(b){return b&&b instanceof g?this.ip==b.ip&&this.port==b.port:!1};return g}();
xnm.aio.mcontrol.DMError=function(d,c){this.code=d;this.message=c;this.stack=Error().stack};xnm.aio.mcontrol.DMError.prototype=Error();xnm.aio.mcontrol.DMError.prototype.name="MControlDMError";xnm.aio.mcontrol.DMError.prototype.code=0;xnm.aio.mcontrol.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.mcontrol.DM={SYS:"mcontrol",MAP:{command:[{type:"string",name:"do",ref:{value:"do",ext:"%s"}},{type:"int",name:"set integer value",ref:{value:"setInt",ext:"%d"}},{type:"float",name:"set float value",ref:{value:"setFloat",ext:"%f"}}],status:[{type:"string",name:"value",ref:{value:"state"}},{type:"int",name:"value as integer",ref:{value:"intVal"}},{type:"float",name:"value as float",ref:{value:"floatVal"}}]},getGatewayType:function(){return[{sys:this.SYS,name:"mControl",port:8082}]},createGateway:function(d,
c,f){c=xnm.aio.mcontrol.DMError;var h=xnm.aio.mcontrol.DMError.ERROR_CODE;d?d.ip?f(null,d):f(new c(h.INVALID,"ip is invalid")):f(new c(h.INVALID,"info is invalid"))},updateGateway:function(d,c,f,h){d=xnm.aio.mcontrol.DMError;f=xnm.aio.mcontrol.DMError.ERROR_CODE;c?c.ip?h(null,c):h(new d(f.INVALID,"ip is invalid")):h(new d(f.INVALID,"update is invalid"))},deleteGateway:function(d,c,f){f()},createDevice:function(d,c,f){var h=xnm.aio.mcontrol.DMError,g=xnm.aio.mcontrol.DMError.ERROR_CODE;if(d)if(d.gateway)if(d.address)if(c.data&&
c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var b;for(b=0;b<c.length;b++)if(c[b].index===d.gateway){var a=c[b];break}a?f(null,d):f(new h(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else f(new h(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else f(new h(g.INVALID,"address is invalid"));else f(new h(g.INVALID,"gateway is invalid"));else f(new h(g.INVALID,"info is invalid"))},updateDevice:function(d,c,f){var h=xnm.aio.mcontrol.DMError,g=xnm.aio.mcontrol.DMError.ERROR_CODE;
if(d)if(d.gateway)if(d.address)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var b;for(b=0;b<c.length;b++)if(c[b].index===d.gateway){var a=c[b];break}a?f(null,d):f(new h(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else f(new h(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else f(new h(g.INVALID,"address is invalid"));else f(new h(g.INVALID,"gateway is invalid"));else f(new h(g.INVALID,"info is invalid"))},deleteDevice:function(d,c,f){f()},
applyUIFilter:function(d,c){var f=function(e,l){if("*"==e)return!0;for(var n=!1,m=0;m<e.length;m++)if(e[m]==l){n=!0;break}return n},h=function(e,l,n){var m=[];switch(n.catagory){case "command":e.command&&e.command.forEach(function(k){f(n.elems,k.type)&&(k=JSON.parse(JSON.stringify(k)),m.push(k))});break;case "status":e.status&&e.status.forEach(function(k){f(n.elems,k.type)&&(k=JSON.parse(JSON.stringify(k)),m.push(k))})}return m},g=function(e,l){var n=[],m=JSON.parse(JSON.stringify(xnm.aio.mcontrol.DM.MAP));
m&&(e=h(m,e,l),n=n.concat(e));return n};if(!d)return null;var b=JSON.parse(JSON.stringify(d)),a=null;switch(c.catagory){case "command":a=g(d,c);b.command=a;break;case "status":a=g(d,c);b.status=a;break;default:return null}return a&&0!=a.length?b:null}};
xnm.aio.mcontrol.Handler=function(){var d=function(){};d.prototype.MControl=xnm.aio.mcontrol.MControl;d.prototype.devicemanager=xnm.aio.mcontrol.DM;d.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"mcontrol")};d.prototype.resolveGateway=function(c){return c&&c.ip?new xnm.aio.mcontrol.MControl(c.ip,c.port):null};d.prototype.getDeviceCommands=function(c,f){c=(c=xnm.aio.mcontrol.DM.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];f&&f(null,c)};d.prototype.getDeviceStatus=
function(c,f){c=(c=xnm.aio.mcontrol.DM.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];f&&f(null,c)};d.prototype.doCommand=function(c,f,h,g){(c=this.resolveGateway(c))?c.executeCommandCreator(f,h,function(b){g&&g(b)}):g&&g(Error("gateway json format invalid"))};d.prototype.doStatus=function(c,f,h,g,b){(f=this.resolveGateway(f))?f.getStatesCreator(null,[{id:c,device:h,status:g}],function(a,e){a?b&&b(a):b&&b(null,e[0])}):b&&b(Error("gateway json format invalid"))};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mcontrol.Handler);
