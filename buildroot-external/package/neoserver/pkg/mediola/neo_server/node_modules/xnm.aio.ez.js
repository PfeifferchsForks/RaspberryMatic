var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ez=xnm.aio.ez||{};xnm.aio.ez.Util={clearHttpOptionForLog:function(d){try{var a=JSON.parse(JSON.stringify(d));a.auth&&(a.auth="xxxxxx:xxxxxx");if(a.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var c=headers[b];if(c){var e=c.indexOf(" ");headers[b]=-1==e?"xxxxxx":c.substr(0,e)+" xxxxxx"}}return a}catch(f){return d}}};
xnm.aio.ez.XS1=function(){var d=function(a,b,c){this._logger=require("x.logger.js").getLogger("xnm.aio.ez.XS1");this.ip=a;this.port=80;b&&(b=parseInt(b),0<b&&(this.port=b));this.username="admin";this.password=c?c:null;this._getDevicesCBs=[];this._deviceBuffer=null};d.prototype._doRequest=function(a,b,c){a={host:this.ip,port:this.port,path:"/control?callback=data&cmd="+a,method:"GET",headers:{Connection:"close"}};if(b)for(var e in b)b.hasOwnProperty(e)&&(a.path+="&"+e+"="+encodeURI(b[e]));this.username&&
this.password&&(a.headers.Authorization="Basic "+(new Buffer(this.username+":"+this.password)).toString("base64"));this._logger.log("trace","send http request:"+JSON.stringify(xnm.aio.ez.Util.clearHttpOptionForLog(a)));var f=c,l=this,h=require("http").request(a,function(m){var g="";m.setEncoding("utf-8");m.on("data",function(k){g+=k});m.on("end",function(){l._logger.log("trace","http response code:"+m.statusCode+" body:"+g);if(200==m.statusCode)if(g=g.trim(),6>g.length||"data("!=g.substr(0,5))f&&
f(Error("response fomart error:"+g)),f=null;else{for(var k=g.substr(5),n=k.length-1;0<=n&&")"!=k.charAt(n);)--n;if(0>n)f&&f(Error("response fomart error:"+g)),f=null;else{k=k.substr(0,n);try{k=JSON.parse(k),f&&f(null,k),f=null}catch(p){f&&f(Error("response fomart error:"+g)),f=null}}}else f&&f(Error("http response code:"+m.statusCode+" "+g)),f=null})});h.setTimeout(2E3,function(){l._logger.log("trace","http request timeout");h.abort();f&&f(Error("http request timeout"));f=null});h.on("error",function(m){l._logger.log("trace",
"http request error:"+m.message);f&&f(m);f=null});h.end()};d.prototype.getDevices=function(a){a||(a=function(){});var b=this._getDevicesCBs.length;-1==this._getDevicesCBs.indexOf(a)&&this._getDevicesCBs.push(a);if(0==b){var c=this;this.getActuators(function(e,f){if(e){f=c._getDevicesCBs;c._getDevicesCBs=[];for(var l=0;l<f.length;l++)f[l]&&f[l](e)}else{var h=[];f&&(h=h.concat(f));c.getSensors(function(m,g){var k=c._getDevicesCBs;c._getDevicesCBs=[];if(m)for(g=0;g<k.length;g++)k[g]&&k[g](m);else for(g&&
(h=h.concat(g)),g=0;g<k.length;g++)k[g]&&k[g](null,h)})}})}};d.prototype.getState=function(a){var b=function(e){var f={actuator:{},sensor:{}};if(e)for(var l=0;l<e.length;l++){var h=e[l];h.address&&("actuator"==h.type?f.actuator[h.address]=h.value:"sensor"==h.type&&(f.sensor[h.address]=h.value))}return f};if(this._deviceBuffer){var c=b(this._deviceBuffer);a&&a(null,c);a=null}this.getDevices(function(e,f){e?a&&a(e):(e=b(f),a&&a(null,e),a=null)})};d.prototype.executeCommand=function(a,b,c){a.address?
b?this._doRequest("set_state_actuator",{number:a.address,"function":b},function(e){c&&c(e)}):c&&c(Error("command invalid")):c&&c(Error("address invalid"))};d.prototype.executeCommandCreator=function(a,b,c){b&&b.value&&"func"==b.value&&b.ext?this.executeCommand(a,b.ext,function(e){c&&c(e)}):c&&c(Error("command invalid"))};d.prototype.getStatesCreator=function(a,b,c){this.getState(function(e,f){if(e)c&&c(e);else{e=[];for(var l=0;l<b.length;l++){var h=b[l];if(h&&h.id&&h.device){var m=h.device;if(m.type&&
m.address){var g;"actuator"==m.type?g=f.actuator[m.address]:"sensor"==m.type&&(g=f.sensor[m.address]);"undefined"!=typeof g&&null!=g&&e.push({id:h.id,status:g})}}}c&&c(null,e)}})};d.prototype.getActuators=function(a){this._doRequest("GET_LIST_ACTUATORS",null,function(b,c){if(b)a&&a(b);else{b=[];if(c&&c.actuator)for(var e=0;e<c.actuator.length;e++)"disabled"!=c.actuator[e].type&&b.push({sys:"xs1",type:"actuator",name:c.actuator[e].name,address:c.actuator[e].id,data:c.actuator[e].type,value:c.actuator[e].value,
unit:c.actuator[e].unit,"function":c.actuator[e]["function"]});a&&a(null,b)}})};d.prototype.getSensors=function(a){this._doRequest("GET_LIST_SENSORS",null,function(b,c){if(b)a&&a(b);else{b=[];if(c&&c.sensor)for(var e=0;e<c.sensor.length;e++)"disabled"!=c.sensor[e].type&&b.push({sys:"xs1",type:"sensor",name:c.sensor[e].name,address:c.sensor[e].id,data:c.sensor[e].type,value:c.sensor[e].value,unit:c.sensor[e].unit});a&&a(null,b)}})};d.prototype.toJSON=function(){return{sys:"xs1",ip:this.ip,port:this.port,
password:this.password}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip==a.ip&&this.port==a.port&&this.password==a.password:!1};return d}();xnm.aio.ez.DMError=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};xnm.aio.ez.prototype=Error();xnm.aio.ez.prototype.name="EZDMError";xnm.aio.ez.prototype.code=0;xnm.aio.ez.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.ez.DM={XS1_SYS:"xs1",getGatewayType:function(){return[{sys:this.XS1_SYS,name:"EZcontrol XS1"}]},getGatewayDeviceType:function(d){switch(d.sys){case this.XS1_SYS:return[{type:"actuator",name:"Actuator"},{type:"sensor",name:"Sensor"}];default:return null}},createGateway:function(d,a,b){a=xnm.aio.ez.DM.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;d?d.ip?(d.port||(d.port=80),b(null,d)):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=xnm.aio.ez.DM.DMError;
b=xnm.aio.ez.DM.ERROR_CODE;a?a.ip?(a.port||(a.port=80),c(null,a)):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){a=xnm.aio.ez.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;d?d.type?d.address?b(null,d):b(new a(c.INVALID,"address is invalid")):b(new a(c.INVALID,"type is invalid")):b(new a(c.INVALID,"info is invalid"))},updateDevice:function(d,a,b){a=xnm.aio.ez.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;d?d.type?d.address?
b(null,d):b(new a(c.INVALID,"address is invalid")):b(new a(c.INVALID,"type is invalid")):b(new a(c.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},getCommandStatusMap:function(d){if(!d.sys||!d.type)return null;var a={command:[],status:[{type:"float",name:"status",ref:{value:"state",ext:"%f"}}]};switch(d.sys){case this.XS1_SYS:if(d["function"])for(var b=0;b<d["function"].length;b++){var c=d["function"][b];c&&c.type&&"disabled"!=c.type&&a.command.push({type:"enum",name:c.dsc,ref:{value:"func",
ext:b+1}})}return a;default:return null}},applyUIFilter:function(d,a){var b=function(h,m){if("*"==h)return!0;for(var g=!1,k=0;k<h.length;k++)if(h[k]==m){g=!0;break}return g},c=function(h,m,g){var k=[];switch(g.catagory){case "command":h.command&&h.command.forEach(function(n){b(g.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),k.push(n))});break;case "status":h.status&&h.status.forEach(function(n){b(g.elems,n.type)&&(n=JSON.parse(JSON.stringify(n)),k.push(n))})}return k},e=function(h,m){var g=[],k=
xnm.aio.ez.DM.getCommandStatusMap(h);k&&(h=c(k,h,m),g=g.concat(h));return g};if(!d.sys)return null;var f=JSON.parse(JSON.stringify(d)),l=null;switch(a.catagory){case "command":l=e(d,a);f.command=l;break;case "status":l=e(d,a);f.status=l;break;default:return null}return l&&0!=l.length?f:null}};
xnm.aio.ez.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.ez.DM;d.prototype.XS1=xnm.aio.ez.XS1;d.prototype.registModule=function(a){a.register(this.devicemanager.XS1_SYS,"ez")};d.prototype.resolveGateway=function(a){if(!a||!a.sys||!a.ip)return null;switch(a.sys){case this.devicemanager.XS1_SYS:return new xnm.aio.ez.XS1(a.ip,a.port,a.password);default:return null}};d.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?
a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.doCommand=function(a,b,c,e){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,e):e&&e(Error("gateway json format invalid"))};d.prototype.doStatus=function(a,b,c,e,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:e}],function(l,h){l?f&&f(l):f&&f(null,h[0])}):f&&f(Error("gateway json format invalid"))};
d.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(c,e){b&&b(c,e)}):b&&b(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.ez.Handler);
