var x=x||{};x.hub=x.hub||{};x.hub.recordman=x.hub.recordman||{};
x.hub.recordman.Record=function(){var e=function(){this._lastHitTime=this.status=this.gateway=this.device=this.stateName=this.deviceName=this.roomName=this.id=null};e.prototype.isMatch=function(b){if(!b||!b.device||!b.device.sys)return!1;var a=require("x.hub.moduleman.js").modulemanager.getModule(b.device.sys);if(!a||!a.checkDeviceMatch||!a.checkDeviceMatch({device:this.device,gateway:this.gateway},b))return!1;a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);return a==b.data.key};
e.prototype._saveRecord=function(b){if(b&&b.data&&"undefined"!=typeof b.data.value&&null!=b.data.value&&this.deviceName&&this.stateName){var a=require("x.hub.datastore.js").dataStore;if(a){var c=(new Date).getTime(),d=[this.roomName,this.deviceName,this.stateName,b.data.value,c];a.openDB(function(f,g){f||g.serialize(function(){var h=d.join(" ");g.run("INSERT INTO windowstate(room, name, state, value, time) "+h+";",function(k){g.close()})})})}}};e.prototype.onStatusEvt=function(b){var a=!1;this._logger.log("trace",
"check record for status event");this.isMatch(b)&&(this._logger.log("debug","record hit:"+JSON.stringify(this.toJSON())),a=!0);a&&(a=(new Date).getTime(),this._lastHitTime&&2E3>a-this._lastHitTime||(this._lastHitTime=a,this._saveRecord(b)))};e.prototype.toJSON=function(){return{id:this.id,roomName:this.roomName,deviceName:this.deviceName,stateName:this.stateName,device:this.device,gateway:this.gateway,status:this.status}};e.parse=function(b){if(!(b&&b.id&&b.deviceName&&b.stateName))return null;var a=
new e;a.id=b.id;a.roomName=b.roomName;a.deviceName=b.deviceName;a.stateName=b.stateName;a.device=b.device;a.gateway=b.gateway;a.status=b.status;return a};return e}();
x.hub.recordman.RecordManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.RecordManager");this._rmFile=null;this._records=[]};e.FILE_NAME="rm.json";e.prototype.init=function(b,a){var c=require("fs_extra"),d=require("path");this._rmFile||(this._rmFile=d.resolve(b.getUserRootDataPath(),e.FILE_NAME));var f=this;c.ensureFile(this._rmFile,function(g){g?a&&a(g):f._loadRecords(function(){f._initDB(a)})})};e.prototype.reload=function(b){this._loadRecords(b)};
e.prototype.createRecord=function(b,a){if(b){for(var c=1,d=-1,f=0;f<this._records.length;f++)if(this._records[f].id>c){b.id=c;d=f;break}else c++;-1==d&&(b.id=c,d=this._records.length);this._records.splice(d,0,b);this._writeData(a)}else a&&a(Error("record is null"))};e.prototype.readRecord=function(b,a){if(b){for(var c=null,d=0;d<this._records.length;d++){var f=this._records[d];if(f.id==b){c=f;break}}c?a&&a(null,c):a&&a(Error("no such record with id:"+b))}else a&&a(Error("record id is null"))};e.prototype.readAllRecords=
function(b){b&&b(null,this._records)};e.prototype.updateRecord=function(b,a){for(var c=null,d=-1,f=0;f<this._records.length;f++){var g=this._records[f];if(g.id==b.id){c=g;d=f;break}}c?(this._records.splice(d,1,b),this._writeData(a)):a&&a(Error("no such record with id:"+b.id))};e.prototype.deleteRecord=function(b,a){if(b){for(var c=-1,d=0;d<this._records.length;d++)if(this._records[d].id==b){c=d;break}-1!=c&&this._records.splice(c,1);this._writeData(a)}else a&&a(Error("record id is null"))};e.prototype.onStatusEvt=
function(b){this._logger.log("info","receive status event:"+JSON.stringify(b));for(var a=0;a<this._records.length;a++)this._records[a].onStatusEvt(b)};e.prototype._initDB=function(b){var a=require("x.hub.datastore.js").dataStore;a?a.openDB(function(c,d){c?b&&b(c):d.serialize(function(){d.run("CREATE TABLE IF NOT EXISTS devicestate (id integer primary key autoincrement, room text, name text, state text, value text,time datetime default current_timestamp)",function(f){d.close();b&&b(f)})})}):b&&b(Error("data store not initialized"))};
e.prototype._loadRecords=function(b){var a=this;this._readData(function(c,d){c?b&&b(c):(a._records=d,a._sort(),b&&b())})};e.prototype._readData=function(b){require("fs").readFile(this._rmFile,"utf8",function(a,c){if(a)b&&b(a);else if(c)try{var d=JSON.parse(c),f=[];Array.isArray(d)&&d.forEach(function(g){(g=x.hub.recordman.Record.parse(g))&&f.push(g)});b&&b(null,f?f:[])}catch(g){b&&b(g)}else b&&b(null,[])})};e.prototype._writeData=function(b){var a=[];this._records.forEach(function(c){c&&a.push(c.toJSON())});
require("fs").writeFile(this._rmFile,JSON.stringify(a,null,2),function(c){b&&b(c)})};e.prototype._sort=function(){var b=this._records.length-1;do{var a=!1;for(var c=0;c<b;++c)this._records[c].id>this._records[c+1].id&&(a=this._records[c],this._records[c]=this._records[c+1],this._records[c+1]=a,a=!0)}while(a)};return e}();
x.hub.recordman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.Handler");this.recordManager=new x.hub.recordman.RecordManager};e.prototype.RecordManager=x.hub.recordman.RecordManager;e.prototype.init=function(b,a,c){require("x.hub.eventbus.js").on("status",this.onStatusEvt.bind(this));this._config(b);this.recordManager.init(a,function(d){c&&c({error:d})})};e.prototype.doWebRequest=function(b,a,c){var d=function(f){if(f.error){var g=x.hub.taskman.ERROR_CODE.General_Error;
f.error.code&&(g=f.error.code);c(JSON.stringify({XC_ERR:{code:g,msg:f.error.message}}))}else c(JSON.stringify({XC_SUC:f.data?f.data:""}))};switch(b){case "Read":b=a.query.id;"undefined"==typeof b?this.readAllTasks(d):this.readTask(b,d);break;case "Create":this.createTask(a.query.data,d);break;case "Update":this.updateTask(a.query.data,a.query.pin,d);break;case "Delete":this.deleteTask(a.query.id,a.query.pin,d);break;case "SetTaskActive":this.setTaskActive(a.query.id,a.query.active,a.query.pin,d);
break;case "SetAlarmActive":this.setAlarmActive(a.query.active,a.query.pin,d);break;case "SetAlarmDelay":this.setAlarmDelay(a.query.delay,a.query.pin,d);break;case "GetAlarmInfo":this.getAlarmInfo(d);break;case "SelectAlarmTask":this.selectAlarmTask(a.query.id,a.query.isAlarmTask,a.query.pin,d);break;case "SetAlarmPin":this.setAlarmPin(a.query.newPin,a.query.pin,d)}};e.prototype.readAllRecords=function(b){this.recordManager.readAllRecords(function(a,c){if(a)b&&b({error:a});else{var d=[];c.forEach(function(f){d.push(f.toJSON())});
b&&b({data:d})}})};e.prototype.createRecord=function(b,a){b?(b.id||(b.id=-1),(b=x.hub.recordman.Record.parse(b))?this.recordManager.createRecord(b,function(c){a&&a({error:c})}):a&&a({error:Error("record json invalid")})):a&&a({error:Error("record json is null")})};e.prototype.readRecord=function(b,a){this.recordManager.readRecord(b,function(c,d){a&&a({error:c,data:d?d.toJSON():null})})};e.prototype.updateRecord=function(b,a){b?(b=x.hub.recordman.Record.parse(b))?this.recordManager.updateRecord(b,
function(c){a&&a({error:c})}):a&&a({error:Error("record json invalid")}):a&&a({error:Error("record json is null")})};e.prototype.deleteRecord=function(b,a){this.recordManager.deleteRecord(b,function(c){a&&a({error:c})})};e.prototype.onStatusEvt=function(b){this._logger.log("trace","receive status event:"+JSON.stringify(b));this.recordManager.onStatusEvt(b)};return e}();module.exports=new x.hub.recordman.Handler;
