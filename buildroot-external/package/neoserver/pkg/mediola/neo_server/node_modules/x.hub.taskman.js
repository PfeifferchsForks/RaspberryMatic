var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(l,e,c){if(null==l)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(e instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return l+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(l,e,c){if(l==Array.prototype||l==Object.prototype)return l;l[e]=c.value;return l};
$jscomp.getGlobal=function(l){l=["object"==typeof globalThis&&globalThis,l,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<l.length;++e){var c=l[e];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(l,e){var c=$jscomp.propertyToPolyfillSymbol[e];if(null==c)return l[e];c=l[c];return void 0!==c?c:l[e]};$jscomp.polyfill=function(l,e,c,g){e&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(l,e,c,g):$jscomp.polyfillUnisolated(l,e,c,g))};
$jscomp.polyfillUnisolated=function(l,e,c,g){c=$jscomp.global;l=l.split(".");for(g=0;g<l.length-1;g++){var k=l[g];if(!(k in c))return;c=c[k]}l=l[l.length-1];g=c[l];e=e(g);e!=g&&null!=e&&$jscomp.defineProperty(c,l,{configurable:!0,writable:!0,value:e})};
$jscomp.polyfillIsolated=function(l,e,c,g){var k=l.split(".");l=1===k.length;g=k[0];g=!l&&g in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var p=0;p<k.length-1;p++){var b=k[p];if(!(b in g))return;g=g[b]}k=k[k.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?g[k]:null;e=e(c);null!=e&&(l?$jscomp.defineProperty($jscomp.polyfills,k,{configurable:!0,writable:!0,value:e}):e!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[k]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[k]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(k):$jscomp.POLYFILL_PREFIX+c+"$"+k),$jscomp.defineProperty(g,$jscomp.propertyToPolyfillSymbol[k],{configurable:!0,writable:!0,value:e})))};$jscomp.polyfill("String.prototype.repeat",function(l){return l?l:function(e){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>e||1342177279<e)throw new RangeError("Invalid count value");e|=0;for(var g="";e;)if(e&1&&(g+=c),e>>>=1)c+=c;return g}},"es6","es3");
var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),Logger=require("x.logger.js"),deviceman=require("x.hub.deviceman.js"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{};x.hub.taskman=x.hub.taskman||{};x.hub.taskman.ERROR_CODE={General_Error:"100000",Pin_Error:"100001"};
x.hub.taskman.Cloud=function(){var l=function(){};l.prototype.URL="https://webservice.mediola.com";l.prototype._doRequest=function(e,c,g,k,p,b,f){c=require("url").parse(this.URL+c);e={host:c.hostname,port:c.port,path:c.path,method:e,headers:k};if(p||b)e.auth=(p?p:"")+":"+(b?b:"");p=require("http");"https:"==c.protocol?(p=require("https"),process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),e.port||(e.port=443)):e.port||(e.port=80);var m=f;f=p.request(e,function(n){var r="";n.on("data",
function(w){r+=w});n.on("end",function(){var w=null;200!=n.statusCode&&(w=Error("http response error"));m&&m(w,r,n.statusCode,n.headers)})});f.setTimeout(5E3,function(){m&&m(Error("timeout"));m=null});f.on("error",function(n){m&&m(n);m=null});g&&f.write(g);f.end()};return l}();
x.hub.taskman._Util={TimeZone_MAP:[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},
{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,
dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},
{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],_getTimeZone:function(){if("CA"==global.HARDWARE_VERSION||"A1"==global.HARDWARE_VERSION)return require("x.hub.js").getServer().getTimezoneSync();var l="8C";localStorage.getItem("x.hub.Server.timezone")&&(l=localStorage.getItem("x.hub.Server.timezone"));
l=parseInt(l,16);var e=0!=(l&128),c=(l&31)-11,g=null;this.TimeZone_MAP.forEach(function(k){k.utc==c&&k.dst==e&&(g=k.zone)});g||(g="Europe/Berlin");return g},_getlatlong:function(){if("CA"==global.HARDWARE_VERSION){var l="020D",e="0087";localStorage.getItem("x.hub.Server.geo.lat")&&(l=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(e=localStorage.getItem("x.hub.Server.geo.long"));l=parseInt(l,16);32768<l&&(l=32768-l);l/=10;e=parseInt(e,16);32768<e&&(e=
32768-e);return{lat:l,long:e/10}}l="1392";e="035C";localStorage.getItem("x.hub.Server.geo.lat")&&(l=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(e=localStorage.getItem("x.hub.Server.geo.long"));l=parseInt(l,16);32768<l&&(l=32768-l);l/=100;e=parseInt(e,16);32768<e&&(e=32768-e);return{lat:l,long:e/100}}};
x.hub.taskman._TimerManager=function(){var l=function(c,g){this._logger=require("x.logger.js").getLogger("x.hub.taskman._TimerManager.CronTimer");this.taskID=c;this.timer=g;this._cronJob=null};l.prototype.start=function(){if(this.timer.time){var c=[],g=this.timer.time.indexOf(":"),k=this.timer.time.substr(0,g);g=this.timer.time.substr(g+1);c.push("00");c.push(g);c.push(k);c.push("*");c.push("*");k="0-6";if(this.timer.week&&7==this.timer.week.length){k=[];"1"==this.timer.week.charAt(6)&&k.push(0);
for(g=0;6>g;g++)"1"==this.timer.week.charAt(g)&&k.push(g+1);k=k.join(",")}c.push(k);c=c.join(" ");k=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+c+" tz:"+k);this._cronJob=new (require("cron").CronJob)(c,this.onTick.bind(this),null,!0,k)}};l.prototype.stop=function(){this._logger.log("debug","#"+this.taskID+" stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),
this._cronJob=null)};l.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" timer tick:"+JSON.stringify(this.timer));var c=require("moment-timezone"),g=x.hub.taskman._Util._getTimeZone(),k=(new Date).getTime();k=c.tz(k,g);var p=k.year(),b=!1,f=!1,m=null,n=null;k=k.valueOf();var r=this.timer.start;r&&("00"==r.substr(0,2)&&(b=!0,r=p+r.substr(2)),r=c.tz(r,g),r.set({hour:0,minute:0,second:0,millisecond:0}),m=r.valueOf());var w=this.timer.end;w&&("00"==w.substr(0,2)&&(f=!0,w=p+w.substr(2)),
w=c.tz(w,g),w.set({hour:23,minute:59,second:59,millisecond:999}),n=w.valueOf());if(b&&f&&m>n){if(n<k&&m>k)return}else if(r&&m>k||w&&n<k)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID)};l.prototype.onLocationChange=function(){this.stop();this.start()};l.prototype.onTimeChange=function(){this.stop();this.start()};var e=function(){this._timers=[]};e.prototype.startTimer=function(c,g){c=new l(c,g);this._timers.push(c);c.start()};e.prototype.stopTimer=function(c){var g=[];this._timers.forEach(function(k){k.taskID==
c?k.stop():g.push(k)});this._timers=g};e.prototype.onLocationChange=function(){this._timers.forEach(function(c){c.onLocationChange()})};e.prototype.onTimeChange=function(){this._timers.forEach(function(c){c.onTimeChange()})};e.prototype.clear=function(){var c=this._timers;this._timers=[];c.forEach(function(g){g.stop()})};return new e}();
x.hub.taskman._AstroManager=function(){var l=function(c,g){this._logger=require("x.logger.js").getLogger("x.hub.taskman._AstroManager.AstroTimer");this.taskID=c;this.astro=g;this._job=null};l.prototype.start=function(){this.astro.astro&&(this._logger.log("debug","#"+this.taskID+" start astro:"+JSON.stringify(this.astro)),this._startNextTick())};l.prototype.stop=function(){this._logger.log("debug","stop astro:"+JSON.stringify(this.astro));this._job&&(clearTimeout(this._job),this._job=null)};l.prototype._startNextTick=
function(){var c=this._getNextTickTime();this._logger.log("debug","#"+this.taskID+" next "+this.astro.astro+":"+new Date(c));var g=(new Date).getTime(),k=this;this._job=setTimeout(function(){try{k.onTick()}catch(p){}k._startNextTick()},c-g)};l.prototype._getNextTickTime=function(){var c=x.hub.taskman._Util._getlatlong(),g=require("suncalc"),k=new Date,p=g.getTimes(k,c.lat,c.long);p="sunrise"==this.astro.astro?p.sunrise:p.sunset;p=p.getTime();this.astro.delay&&(p+=6E4*parseInt(this.astro.delay));p<=
k.getTime()&&(k=new Date(k.getTime()+864E5),p=g.getTimes(k,c.lat,c.long),p="sunrise"==this.astro.astro?p.sunrise:p.sunset,p=p.getTime(),this.astro.delay&&(p+=6E4*parseInt(this.astro.delay)));return p};l.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" astro tick:"+JSON.stringify(this.astro));var c=require("moment-timezone"),g=x.hub.taskman._Util._getTimeZone(),k=(new Date).getTime();k=c.tz(k,g);var p=k.year();if(this.astro.offTime){var b=this.astro.offTime.indexOf(":"),f=this.astro.offTime.substr(0,
b);b=this.astro.offTime.substr(b+1);f=parseInt(f);b=parseInt(b);if(k.hour()<f||k.hour()==f&&k.minute()<=b)return}f=k.day();0==f&&(f=7);if(!this.astro.week||7!=this.astro.week.length||"0"!=this.astro.week.charAt(f-1)){b=f=!1;var m=null,n=null;k=k.valueOf();var r=this.astro.start;r&&("00"==r.substr(0,2)&&(f=!0,r=p+r.substr(2)),r=c.tz(r,g),r.set({hour:0,minute:0,second:0,millisecond:0}),m=r.valueOf());var w=this.astro.end;w&&("00"==w.substr(0,2)&&(b=!0,w=p+w.substr(2)),w=c.tz(w,g),w.set({hour:23,minute:59,
second:59,millisecond:999}),n=w.valueOf());if(f&&b&&m>n){if(n<k&&m>k)return}else if(r&&m>k||w&&n<k)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.astro))}};l.prototype.onLocationChange=function(){this.stop();this.start()};l.prototype.onTimeChange=function(){this.stop();this.start()};var e=function(){this._timers=[]};e.prototype.startTimer=function(c,g){c=new l(c,g);this._timers.push(c);c.start()};e.prototype.stopTimer=function(c){var g=[];this._timers.forEach(function(k){k.taskID==
c?k.stop():g.push(k)});this._timers=g};e.prototype.onLocationChange=function(){this._timers.forEach(function(c){c.onLocationChange()})};e.prototype.onTimeChange=function(){this._timers.forEach(function(c){c.onTimeChange()})};e.prototype.clear=function(){var c=this._timers;this._timers=[];c.forEach(function(g){g.stop()})};e.prototype.getSunriseSunset=function(c){var g=require("moment-timezone"),k=x.hub.taskman._Util._getTimeZone();c=g.tz(c,k);c.set({hour:12,minute:0,second:0,millisecond:0});g=x.hub.taskman._Util._getlatlong();
return require("suncalc").getTimes(c.toDate(),g.lat,g.long)};return new e}();
x.hub.taskman._PeriodicTimerManager=function(){var l=function(c,g){this._logger=require("x.logger.js").getLogger("x.hub.taskman._PeriodicTimerManager.CronTimer");this.taskID=c;this.timer=g;this._repeater=this._cronJob=this._starter=null};l.prototype.start=function(){if(this.timer.interval){var c=this.timer.startTime,g=this.timer.endTime;c||(c="00:00");g||(g="23:59");var k=[],p=c.indexOf(":"),b=c.substr(0,p);p=c.substr(p+1);k.push("00");k.push(p);k.push(b);k.push("*");k.push("*");var f="0-6";if(this.timer.week&&
7==this.timer.week.length){f=[];"1"==this.timer.week.charAt(6)&&f.push(0);for(var m=0;6>m;m++)"1"==this.timer.week.charAt(m)&&f.push(m+1);f=f.join(",")}k.push(f);k=k.join(" ");f=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+k+" tz:"+f);this._cronJob=new (require("cron").CronJob)(k,this.onFirstTick.bind(this),null,!0,f);m=require("moment-timezone");var n=(new Date).getTime();k=m.tz(n,
f);b=k.year();var r=!1;p=!1;var w=null,A=null,y=k.valueOf(),B=this.timer.start;B&&("00"==B.substr(0,2)&&(r=!0,B=b+B.substr(2)),B=m.tz(B,f),B.set({hour:0,minute:0,second:0,millisecond:0}),w=B.valueOf());var G=this.timer.end;G&&("00"==G.substr(0,2)&&(p=!0,G=b+G.substr(2)),G=m.tz(G,f),G.set({hour:23,minute:59,second:59,millisecond:999}),A=G.valueOf());if(r&&p&&w>A){if(A<y&&w>y)return}else if(B&&w>y||G&&A<y)return;if(b=this.timer.week)if(r=k.isoWeekday(),"1"!=b.charAt(r-1))return;r=m.tz(n,f);p=c.indexOf(":");
b=c.substr(0,p);p=c.substr(p+1);r.set({hour:parseInt(b),minute:parseInt(p),second:0,millisecond:0});if(!(r.valueOf()>k.valueOf()||(c=m.tz(n,f),p=g.indexOf(":"),b=g.substr(0,p),p=g.substr(p+1),c.set({hour:parseInt(b),minute:parseInt(p),second:0,millisecond:0}),c.valueOf()<k.valueOf()||!(g=this.timer.interval)))){g=1E3*parseInt(g);g=Math.ceil((k.valueOf()-r.valueOf())/g)*g+r.valueOf()-k.valueOf();this._logger.log("trace","first tick in "+g/1E3+" seconds");var D=this;this._starter=setTimeout(function(){D.onFirstTick()},
g)}}};l.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._starter&&(clearTimeout(this._starter),this._starter=null)};l.prototype.onFirstTick=function(){this._logger.log("debug","periodic timer first tick:"+JSON.stringify(this.timer));var c=this.timer.interval;if(c){c=1E3*parseInt(c);var g=this;this._starter&&(clearTimeout(this._starter),
this._starter=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._repeater=setInterval(function(){g.onTick()},c);this.onTick()}};l.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" periodic timer tick:"+JSON.stringify(this.timer));var c=require("moment-timezone"),g=this.timer.interval;g=1E3*parseInt(g);var k=x.hub.taskman._Util._getTimeZone(),p=(new Date).getTime();g=p+g;var b=c.tz(p,k);p=c.tz(p,k);var f=p.year(),m=!1,n=!1,r=null,w=null,A=p.valueOf(),
y=this.timer.start;y&&("00"==y.substr(0,2)&&(m=!0,y=f+y.substr(2)),y=c.tz(y,k),y.set({hour:0,minute:0,second:0,millisecond:0}),r=y.valueOf());var B=this.timer.end;B&&("00"==B.substr(0,2)&&(n=!0,B=f+B.substr(2)),B=c.tz(B,k),B.set({hour:23,minute:59,second:59,millisecond:999}),w=B.valueOf());if(m&&n&&r>w){if(w<A&&r>A)return}else if(y&&r>A||B&&w<A)return;(k=this.timer.endTime)||(k="23:59");f=k.indexOf(":");c=k.substr(0,f);k=k.substr(f+1);b.set({hour:parseInt(c),minute:parseInt(k),second:59,millisecond:999});
b.valueOf()<p.valueOf()?(this._logger.log("trace","repeater exceed end time:"+b.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)):(g>b.valueOf()&&(this._logger.log("trace","repeater next tick will exceed end time:"+b.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)),require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.timer)))};l.prototype.onLocationChange=function(){this.stop();this.start()};l.prototype.onTimeChange=
function(){this.stop();this.start()};var e=function(){this._timers=[]};e.prototype.startTimer=function(c,g){c=new l(c,g);this._timers.push(c);c.start()};e.prototype.stopTimer=function(c){var g=[];this._timers.forEach(function(k){k.taskID==c?k.stop():g.push(k)});this._timers=g};e.prototype.onLocationChange=function(){this._timers.forEach(function(c){c.onLocationChange()})};e.prototype.onTimeChange=function(){this._timers.forEach(function(c){c.onTimeChange()})};e.prototype.clear=function(){var c=this._timers;
this._timers=[];c.forEach(function(g){g.stop()})};return new e}();
x.hub.taskman._Block=function(){var l=function(a){this.type=a;this._parent=null;this._canceling=this._running=!1;this._trace=null};l.prototype.isRunning=function(){return this._running};l.prototype.do=function(a){a&&a()};l.prototype.cancel=function(a){var d=this._running;this._canceling=this._running=!1;a&&a(null,d)};l.prototype.toJSON=function(){return{type:this.type}};l.prototype.fromJSON=function(){};l.prototype.setTrace=function(a){this._trace=a};var e=function(){l.call(this);this.type=e.TYPE;
this.subtype=null;this.flowIf=[];this.flowThen=[];this.flowElse=[]};util.inherits(e,l);e.TYPE="condition";e.prototype.isRunning=function(){var a=!1;this.flowIf&&this.flowIf.forEach(function(d){d&&d.isRunning&&(a|=d.isRunning())});this.flowThen&&this.flowThen.forEach(function(d){d&&d.isRunning&&(a|=d.isRunning())});this.flowElse&&this.flowElse.forEach(function(d){d&&d.isRunning&&(a|=d.isRunning())});return a?!0:!1};e.prototype.do=function(a,d){var h=this;this._trace&&this._trace.log('condition | check "if"');
this._checkIfBlocks(function(q,t){h._trace&&h._trace.log('condition | check "if" - '+(q?"error:"+q.message:t));q?a&&a(q):t?(h._trace&&h._trace.log('condition | do "then"'),h._doThenBlocks(a,d)):(h._trace&&h._trace.log('condition | do "else"'),h._doElseBlocks(a,d))},d)};e.prototype.cancel=function(a){var d=0;this.flowIf&&this.flowIf.forEach(function(h){h&&h.cancel?h.cancel():d++});this.flowThen&&this.flowThen.forEach(function(h){h&&h.cancel?h.cancel():d++});this.flowElse&&this.flowElse.forEach(function(h){h&&
h.cancel?h.cancel():d++})};e.prototype.toJSON=function(){var a={type:this.type,subtype:this.subtype,if:[],then:[],else:[]};this.flowIf&&this.flowIf.forEach(function(d){d&&a.if.push(d.toJSON())});this.flowThen&&this.flowThen.forEach(function(d){d&&a.then.push(d.toJSON())});this.flowElse&&this.flowElse.forEach(function(d){d&&a.else.push(d.toJSON())});return a};e.prototype.fromJSON=function(a){if(a){var d=this;this.subtype=a.subtype;a.if&&0<a.if.length&&a.if.forEach(function(h){h&&(h=l.parse(h))&&(h._parent=
d,d.flowIf.push(h))});a.then&&0<a.then.length&&a.then.forEach(function(h){h&&(h=l.parse(h))&&d.flowThen.push(h)});a.else&&0<a.else.length&&a.else.forEach(function(h){h&&(h=l.parse(h))&&d.flowElse.push(h)})}};e.prototype._checkIfBlocks=function(a,d){var h=[],q=0,t=this;if(this.flowIf&&0!=this.flowIf.length){var v=function(u,z){q++;u?h.push(!1):h.push(z);if(q<t.flowIf.length)t.flowIf[q].do(v,d);else if(0==h.length)a&&a(null,!0);else{u=1;for(z=h[0];u<h.length&&u+1!=h.length;)"AND"==h[u]?z&=h[u+1]:"OR"==
h[u]?z|=h[u+1]:"XOR"==h[u]&&(z=z!=h[u+1]),u+=2;a&&a(null,z)}};this.flowIf[q].do(v,d)}else a&&a(null,!0)};e.prototype._doThenBlocks=function(a,d){var h=0,q=this;if(this.flowThen&&0!=this.flowThen.length){var t=function(){h++;h<q.flowThen.length?q.flowThen[h].do(t,d):a&&a()};this.flowThen[h].do(t,d)}else a&&a()};e.prototype._doElseBlocks=function(a,d){var h=0,q=this;if(this.flowElse&&0!=this.flowElse.length){var t=function(){h++;h<q.flowElse.length?q.flowElse[h].do(t,d):a&&a()};this.flowElse[h].do(t,
d)}else a&&a()};e.prototype.setTrace=function(a){this._trace=a;this.flowIf&&this.flowIf.forEach(function(d){d&&d.setTrace&&d.setTrace(a)});this.flowThen&&this.flowThen.forEach(function(d){d&&d.setTrace&&d.setTrace(a)});this.flowElse&&this.flowElse.forEach(function(d){d&&d.setTrace&&d.setTrace(a)})};l.Condition=e;var c=function(){e.call(this);this.type=l.Root.TYPE;this._lastTiggerTime=this._taskID=null;this.singleton=!1;this.singletonMethod="ignore";this._task=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Root")};
util.inherits(c,e);c.TYPE="root";c.prototype.init=function(a){this._taskID=a;this.flowIf.forEach(function(d){d&&d.init&&d.init(a)})};c.prototype.finalize=function(a){this.flowIf.forEach(function(d){d&&d.finalize&&d.finalize(a)})};c.prototype.getTriggers=function(){return this.flowIf?this.flowIf:[]};c.prototype._onTriggered=function(a,d){var h=(new Date).getTime();if(!(this._lastTiggerTime&&400>h-this._lastTiggerTime)){if(this.singleton&&this._running){if("ignore"==this.singletonMethod){this._logger.log("debug",
"task "+this._taskID+" is running and ignore the new trigger");a&&a();return}this._logger.log("debug","task "+this._taskID+" is running and cancel it");this.cancel()}this._logger.log("info","task "+this._taskID+" triggered");this._logger.log("trace","task "+this._taskID+" is "+(this._running?"running":"not running"));this._lastTiggerTime=h;this._trace&&this._trace.log("root | task:"+this._taskID+" triggered");this._running=!0;var q=this;this._doThenBlocks(function(){q._running=!1;a&&a()},{trigger:d,
task:this._task})}};c.prototype.onStatusEvt=function(a){var d=!1;this._logger.log("trace","check trigger for status event");for(var h=null,q=0;q<this.flowIf.length;q++){var t=this.flowIf[q];if((t.type==r.TYPE||t.type==A.TYPE)&&t.isMatch(a)){this._logger.log("debug","trigger hit:"+JSON.stringify(t.toJSON()));d=!0;h=t;break}}d&&this._onTriggered(null,h)};c.prototype.onDedicatedStatusEvt=function(a){var d=!1;this._logger.log("trace","check trigger for status event");for(var h=null,q=0;q<this.flowIf.length;q++){var t=
this.flowIf[q];if(t.type==r.TYPE){if(t.isMatch(a)){this._logger.log("debug","trigger hit:"+JSON.stringify(t.toJSON()));d=!0;h=t;break}}else if(t.type==A.TYPE&&t.isMatch(a)){this._logger.log("debug","trigger hit:"+JSON.stringify(t.toJSON()));d=!0;h=t;break}}d&&this._onTriggered(null,h)};c.prototype.onIREvt=function(a){this._trace&&this._trace.log("root | receive ir event:"+JSON.stringify(a));var d=!1;this._logger.log("trace","check trigger for ir event");for(var h=0;h<this.flowIf.length;h++){var q=
this.flowIf[h];if(q.type==n.TYPE&&q.isMatch(a)){this._logger.log("debug","trigger hit:"+JSON.stringify(q.toJSON()));d=!0;break}}d&&this._onTriggered()};c.prototype.onTimerTick=function(a){this._trace&&this._trace.log("root | timer tick:"+a);this._onTriggered()};c.prototype.onHttpEvt=function(a,d){this._trace&&this._trace.log("root | receive http event:"+JSON.stringify(a));for(var h=!1,q=0;q<this.flowIf.length;q++){var t=this.flowIf[q];if(t.type==p.TYPE&&t.isMatch(a)){this._logger.log("info","trigger hit:"+
JSON.stringify(t.toJSON()));h=!0;break}}h&&this._onTriggered();d&&d(null,h)};c.prototype.setTrace=function(a){this._trace=a;this.flowIf&&this.flowIf.forEach(function(d){d&&d.setTrace&&d.setTrace(a)});this.flowThen&&this.flowThen.forEach(function(d){d&&d.setTrace&&d.setTrace(a)})};c.prototype.hasCloudTrigger=function(){if(!this.flowIf||0==this.flowIf.length)return!1;for(var a=0;a<this.flowIf.length;a++)if(this.flowIf[a]instanceof w)return!0;return!1};c.prototype.toCloudRuleFormat=function(){if(!this.flowIf||
0==this.flowIf.length)return[];for(var a=[],d=0;d<this.flowIf.length;d++){var h=this.flowIf[d];h instanceof w&&(h=h.toCloudRuleFormat())&&a.push(h)}return a};l.Root=c;var g=function(a){l.call(this);this.type=g.TYPE;a&&(this.op=a.op)};util.inherits(g,l);g.TYPE="logic.operator";g.prototype.do=function(a){a&&a(null,this.op)};g.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.op=this.op;return a};g.prototype.fromJSON=function(a){a&&(this.op=a.op)};l.LogicOP=g;var k=function(){l.call(this);
this.type=k.TYPE;this.children=[]};util.inherits(k,l);k.TYPE="bracket";k.prototype.do=function(a){var d=[],h=0,q=this;if(this.children&&0!==this.children.length){var t=function(v,u){h++;v?d.push(!1):d.push(u);if(h<q.children.length)q.children[h].do(t);else if(0===d.length)a&&a(null,!0);else{v=1;for(u=d[0];v<d.length&&v+1!=d.length;)"AND"==d[v]?u&=d[v+1]:"OR"==d[v]?u|=d[v+1]:"XOR"==d[v]&&(u=u!=d[v+1]),v+=2;a&&a(null,u)}};this.children[h].do(t)}else a&&a(null,!0)};k.prototype.toJSON=function(){var a=
l.prototype.toJSON.call(this);a.children=[];this.children&&this.children.forEach(function(d){d&&a.children.push(d.toJSON())});return a};k.prototype.fromJSON=function(a){if(a){var d=this;a.children&&0<a.children.length&&a.children.forEach(function(h){h&&(h=l.parse(h))&&d.children.push(h)})}};l.Bracket=k;var p=function(){l.call(this);this.type=p.TYPE;this.params=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpTrigger")};util.inherits(p,l);p.TYPE="http.trigger";p.prototype.isMatch=
function(a){if(!a||!this.params)return!1;for(var d in this.params)if(d&&this.params[d]!=a[d]&&this.params[d]!=a[encodeURIComponent(d)])return!1;this._logger.log("trace","trigger hit:"+JSON.stringify(this.toJSON()));return!0};p.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.params=this.params;return a};p.prototype.fromJSON=function(a){a&&(this.params=a.params)};l.HttpTrigger=p;var b=function(){l.call(this);this.type=b.TYPE;this.op=this.end=this.start=this.week=this.time=null;this._logger=
require("x.logger.js").getLogger("x.hub.taskman._Block.Timer")};util.inherits(b,l);b.TYPE="timer";b.prototype.init=function(a){x.hub.taskman._TimerManager.startTimer(a,this)};b.prototype.do=function(a){this._trace&&this._trace.log("check time | "+this._getDescription());var d=require("moment-timezone"),h=x.hub.taskman._Util._getTimeZone(),q=(new Date).getTime();q=d.tz(q,h);var t=q.year(),v=!1,u=!1,z=null,C=null,H=q.valueOf(),E=this.start;E&&("00"==E.substr(0,2)&&(v=!0,E=t+E.substr(2)),E=d.tz(E,h),
E.set({hour:0,minute:0,second:0,millisecond:0}),z=E.valueOf());var F=this.end;F&&("00"==F.substr(0,2)&&(u=!0,F=t+F.substr(2)),F=d.tz(F,h),F.set({hour:23,minute:59,second:59,millisecond:999}),C=F.valueOf());if(v&&u&&z>C){if(C<H&&z>H){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if(E&&z>H||F&&C<H){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(d=this.week)if(h=q.day(),0==h&&(h=7),"1"!=
d.charAt(h-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(this.time&&this.op)if(h=this.time.indexOf(":"),d=this.time.substr(0,h),h=this.time.substr(h+1),d=parseInt(d),h=parseInt(h),t=q.hour(),q=q.minute(),">="==this.op){if(t<d||t==d&&q<h){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if(">"==this.op){if(t<d||t==d&&q<=h){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
a&&a(null,!1);return}}else if("<="==this.op){if(t>d||t==d&&q>h){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if("<"==this.op){if(t>d||t==d&&q>=h){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if("="==this.op||"=="==this.op)if(t!=d||t==d&&q!=h){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}this._logger.log("trace","condition match:"+
JSON.stringify(this.toJSON()));a&&a(null,!0)};b.prototype.finalize=function(a){x.hub.taskman._TimerManager.stopTimer(a)};b.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.time=this.time;a.week=this.week;a.start=this.start;a.end=this.end;a.op=this.op;return a};b.prototype.fromJSON=function(a){a&&(this.time=a.time,this.week=a.week,this.start=a.start,this.end=a.end,this.op=a.op)};b.prototype._getDescription=function(){var a="time:"+this.time;a+=" week:"+this.week;a+=" start:"+this.start;
a+=" end:"+this.end;return a+=" op:"+this.op};l.Timer=b;var f=function(){l.call(this);this.type=f.TYPE;this.op=this.end=this.start=this.week=this.delay=this.offTime=this.astro=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Astro")};util.inherits(f,l);f.TYPE="astro";f.prototype.init=function(a){x.hub.taskman._AstroManager.startTimer(a,this)};f.prototype.do=function(a){this._trace&&this._trace.log("check astro | "+this._getDescription());var d=require("moment-timezone"),h=
x.hub.taskman._Util._getTimeZone(),q=(new Date).getTime();q=d.tz(q,h);var t=q.year(),v=!1,u=!1,z=null,C=null,H=q.valueOf(),E=this.start;E&&("00"==E.substr(0,2)&&(v=!0,E=t+E.substr(2)),E=d.tz(E,h),E.set({hour:0,minute:0,second:0,millisecond:0}),z=E.valueOf());var F=this.end;F&&("00"==F.substr(0,2)&&(u=!0,F=t+F.substr(2)),F=d.tz(F,h),F.set({hour:23,minute:59,second:59,millisecond:999}),C=F.valueOf());if(v&&u&&z>C){if(C<H&&z>H){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
a&&a(null,!1);return}}else if(E&&z>H||F&&C<H){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(d=this.week)if(h=q.day(),0==h&&(h=7),"1"!=d.charAt(h-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}d=!1;this.astro&&this.op&&(h=x.hub.taskman._AstroManager.getSunriseSunset(q.toDate()),h="sunrise"==this.astro?h.sunrise.getTime():h.sunset.getTime(),this.delay&&(h+=6E4*parseInt(this.delay)),">="==
this.op&&q.valueOf()>=h?d=!0:">"==this.op&&q.valueOf()>h?d=!0:"<="==this.op&&q.valueOf()<=h?d=!0:"<"==this.op&&q.valueOf()<h?d=!0:("="==this.op||"=="==this.op)&&q.valueOf()==h&&(d=!0));this._logger.log("trace","condition "+(d?"match":"mismatch")+":"+JSON.stringify(this.toJSON()));a&&a(null,d)};f.prototype.finalize=function(a){x.hub.taskman._AstroManager.stopTimer(a)};f.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.astro=this.astro;a.offTime=this.offTime;a.delay=this.delay;a.week=
this.week;a.start=this.start;a.end=this.end;a.op=this.op;return a};f.prototype.fromJSON=function(a){a&&(this.astro=a.astro,this.offTime=a.offTime,this.delay=a.delay,this.week=a.week,this.start=a.start,this.end=a.end,this.op=a.op)};f.prototype._getDescription=function(){var a="astro:"+this.astro;a+=" offTime:"+this.offTime;a+=" delay:"+this.delay;a+=" week:"+this.week;a+=" start:"+this.start;a+=" end:"+this.end;return a+=" op:"+this.op};l.Astro=f;var m=function(){l.call(this);this.type=m.TYPE;this.end=
this.start=this.week=this.endTime=this.startTime=this.interval=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Periodic")};util.inherits(m,l);m.TYPE="periodic";m.prototype.init=function(a){x.hub.taskman._PeriodicTimerManager.startTimer(a,this)};m.prototype.finalize=function(a){x.hub.taskman._PeriodicTimerManager.stopTimer(a)};m.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.interval=this.interval;a.startTime=this.startTime;a.endTime=this.endTime;a.week=
this.week;a.start=this.start;a.end=this.end;return a};m.prototype.fromJSON=function(a){a&&(this.interval=a.interval,this.startTime=a.startTime,this.endTime=a.endTime,this.week=a.week,this.start=a.start,this.end=a.end)};l.Periodic=m;var n=function(){l.call(this);this.type=n.TYPE;this._lastTiggerTime=this.ir=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IRTrigger")};util.inherits(n,l);n.TYPE="ir";n.prototype.isMatch=function(a){if(!(a&&a.code&&this.ir&&this.ir.code))return!1;
var d=this._getDataCode(this.ir.code);a=this._getDataCode(a.code);if(d==a){d=(new Date).getTime();if(!this._lastTiggerTime)return this._lastTiggerTime=d,!0;if(1E3>d-this._lastTiggerTime)return!1;this._lastTiggerTime=d;return!0}return!1};n.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.ir=this.ir;return a};n.prototype.fromJSON=function(a){a&&(this.ir=a.ir)};n.prototype._getDataCode=function(a){a=new Buffer(a,"hex");var d=a.readInt8(8);return a.slice(4*d+9).toString("hex")};l.IRTrigger=
n;var r=function(){l.call(this);this.type=r.TYPE;this._cancelCB=this._lastStatus=this._lastTiggerTime=this.hysteresis=this.value=this.op=this.status=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DeviceStatus");this._gatewayName=this._deviceName=null};util.inherits(r,l);r.TYPE="device.status";r.prototype.init=function(a){if((this.device||this.gateway)&&this.status){var d=null;this.gateway&&this.gateway.sys&&(d=this.gateway.sys);!d&&this.device&&this.device.sys&&
(d=this.device.sys);if(d&&("hm"!=d||this.gateway?"neoserver"==d&&(d="aio"):d="aio",(d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.addStateDevice)){var h={},q=this._getDevice(),t=this._getGateway();q&&(h=q);delete h.gateway;t&&(h.gateway=t);q=this.status;q.ref&&q.ref.value?q=q.ref.value:q.value&&(q=q.value);d.addStateDevice(h,null,{taskID:a,statusKey:q,src:"taskman",callback:this})}}};r.prototype.finalize=function(a){if(this.device||this.gateway){var d=null;this.gateway&&this.gateway.sys&&
(d=this.gateway.sys);!d&&this.device&&this.device.sys&&(d=this.device.sys);if(d&&("hm"!=d||this.gateway?"neoserver"==d&&(d="aio"):d="aio",(d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.removeStateDevice)){var h={},q=this._getDevice(),t=this._getGateway();q&&(h=q);delete h.gateway;t&&(h.gateway=t);q=this.status;q.ref&&q.ref.value?q=q.ref.value:q.value&&(q=q.value);d.removeStateDevice(h,null,{taskID:a,statusKey:q,src:"taskman",callback:this})}}};r.prototype.do=function(a){if(this.device||
this.gateway)if(this.status&&this.op){var d=this.status;this.status.ref&&(d=this.status.ref);d.value&&(d=d.value);d={value:d};this.status&&this.status.value?d=this.status:this.status&&this.status.ref&&(d=this.status.ref);var h=this,q=this._getDevice(),t=this._getGateway();this._logger.log("trace","get states:"+JSON.stringify(this._toBluredJSON()));this._trace&&this._trace.log("get status | "+this._getDescription());this._running=!0;require("x.hub.commandman.js").commandHandler.getState(q,t,d,function(v){if(h._canceling){h._logger.log("trace",
"get states canceled:"+JSON.stringify(h._toBluredJSON()));h._canceling=!1;v=h._running;h._running=!1;var u=h._cancelCB;h._cancelCB=null;u&&u(null,v)}else if(h._running=!1,!v||v.error?h._trace&&h._trace.log("get status | "+h._getDescription()+" | error:"+(v?v.error.message:"invalid response")):("undefined"==typeof v.data||null==v.data)&&h._trace&&h._trace.log("get status | "+h._getDescription()+" | error:no status"),!v||v.error)a&&a(v?v.error:Error("get state error"));else if("undefined"==typeof v.data||
null==v.data)a&&a(null,!1);else{u=v.data.value;var z=!1;"="==h.op||"=="==h.op?z="true"==h.value?"true"==String(u):"false"==h.value?"false"==String(u):u==h.value:"!="==h.op?z="true"==h.value?"true"!=String(u):"false"==h.value?"false"!=String(u):u!=h.value:">="==h.op?z=parseFloat(u)>=parseFloat(h.value):">"==h.op?z=parseFloat(u)>parseFloat(h.value):"<="==h.op?z=parseFloat(u)<=parseFloat(h.value):"<"==h.op&&(z=parseFloat(u)<parseFloat(h.value));h._logger.log("trace","condition "+(z?"match":"mismatch")+
":"+JSON.stringify(h.toJSON()));h._trace&&h._trace.log("get status | "+h._getDescription()+" | success:"+JSON.stringify(v.data)+" | match="+z);a&&a(null,z)}})}else a&&a(Error("no status point or operator"));else a&&a(Error("no device or gateway"))};r.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};r.prototype.isMatch=function(a){if(!a||!a.device)return!1;var d=a.device.sys;d&&"neoserver"!=d||(d="aio");d=require("x.hub.moduleman.js").modulemanager.getModule(d);
if(!d||!d.checkDeviceMatch)return!1;var h=this._getDevice(),q=this._getGateway();if(!d.checkDeviceMatch({device:h,gateway:q},a))return!1;d=this.status;d.ref&&d.ref.value?d=d.ref.value:d.value&&(d=d.value);return d!=a.data.key?!1:this.isValueMatch(a)};r.prototype.isValueMatch=function(a){if(!a||!a.data)return!1;var d=(new Date).getTime(),h=!1,q=this._lastStatus,t=a.data.value;this._lastStatus=t;"="==this.op||"changeTo"==this.op?(h="true"==this.value?"true"==String(a.data.value):"false"==this.value?
"false"==String(a.data.value):this.value==a.data.value,"changeTo"==this.op&&t==q&&(h=!1)):"!="==this.op?h="true"==this.value?"true"!=String(a.data.value):"false"==this.value?"false"!=String(a.data.value):this.value!=a.data.value:">="==this.op?h=parseFloat(a.data.value)>=parseFloat(this.value):">"==this.op?h=parseFloat(a.data.value)>parseFloat(this.value):"<="==this.op?h=parseFloat(a.data.value)<=parseFloat(this.value):"<"==this.op?h=parseFloat(a.data.value)<parseFloat(this.value):"changed"==this.op?
t!=q&&(h=!0):h=!1;q=this.value;"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&(q=this.hysteresis);t=!1;">"==this.op?t=parseFloat(a.data.value)<=parseFloat(q):">="==this.op?t=parseFloat(a.data.value)<parseFloat(q):"<"==this.op?t=parseFloat(a.data.value)>=parseFloat(q):"<="==this.op?t=parseFloat(a.data.value)>parseFloat(q):"="==this.op||"=="==this.op?t=a.data.value!=q:"!="==this.op&&(t=a.data.value==q);t&&(this._lastTiggerTime=null);this._trace&&(this._trace.log("trigger | "+this._getDescription()),
this._trace.log("receive event | "+JSON.stringify(a.data)+" | hysteresis="+this.hysteresis+" | hit="+h));if(h){if(!this._lastTiggerTime)return this._lastTiggerTime=d,!0;if(1E3>d-this._lastTiggerTime||"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&this._lastTiggerTime||(a=this._getDevice())&&"aio"==a.sys&&"ENOCEAN"==a.type&&("bb-aa-cc"==a.data||"d2-06-10"==a.data)&&this._lastTiggerTime)return!1;this._lastTiggerTime=d;return!0}return!1};r.prototype.onEvent=function(a){try{this.isValueMatch(a)&&
this._parent&&this._parent._onTriggered&&this._parent._onTriggered(null,this)}catch(d){}};r.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.status=this.status;a.op=this.op;a.value=this.value;a.hysteresis=this.hysteresis;return a};r.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.status=a.status,this.op=a.op,this.value=a.value,this.hysteresis=a.hysteresis)};r.prototype._toBluredJSON=function(){try{var a=
JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username="xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&(a.gateway.username&&(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(d){return this.toJSON()}};r.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var d=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);
d&&d.info&&(this._deviceName=d.name,a=JSON.parse(JSON.stringify(d.info)))}catch(h){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};r.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var d=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);d&&d.info&&(this._gatewayName=d.name,a=JSON.parse(JSON.stringify(d.info)))}catch(h){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&
(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};r.prototype._getDescription=function(){var a=null,d=null;if(this._deviceName||this._gatewayName)a=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{d=JSON.parse(JSON.stringify(this.device)),d.username&&(d.username="xxxxxx"),d.password&&(d.password="xxxxxx"),a=JSON.stringify(d)}catch(h){a=JSON.stringify(this.device)}else if(this.gateway)try{d=JSON.parse(JSON.stringify(this.gateway)),d.username&&(d.username="xxxxxx"),
d.password&&(d.password="xxxxxx"),a=JSON.stringify(d)}catch(h){a=JSON.stringify(this.gateway)}d=this.status;this.status.ref&&(d=this.status.ref);d.value&&(d=d.value);return a+" | "+d+" "+this.op+" "+this.value};l.DeviceStatus=r;var w=function(){r.call(this);this.type=w.TYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudDeviceTrigger");this._cloudRuleID=null};util.inherits(w,r);w.TYPE="cloud.trigger.device";w.prototype.init=function(a){};w.prototype.finalize=function(a){};
w.prototype.toCloudTriggerFormat=function(){var a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);a={event:{sys:this.device.module,data:{connection:this.device.connection,id:this.device.id,state:a},comp:{value:this.value,operator:this.op}}};if("undefined"!=typeof this.hysteresis&&null!=this.hysteresis)if("="==this.op||"=="==this.op)a.event.comp.hyst=.1;else if(">="==this.op||">"==this.op)a.event.comp.hyst=parseFloat(this.value)-parseFloat(this.hysteresis);else if("<="==this.op||
"<"==this.op)a.event.comp.hyst=parseFloat(this.hysteresis)-parseFloat(this.value);return a};l.CloudDeviceTrigger=w;var A=function(){l.call(this);this.type=A.TYPE;this.gateway=this.device=null;this.upperThreshold={type:null,op:null,value:null,delay:null,repeat:null};this.lowerThreshold={type:null,op:null,value:null,delay:null,repeat:null};this._upper_threshold_state=0;this._upper_threshold_repeat_to=this._upper_threshold_deley_to=null;this._lower_threshold_state=0;this._lower_threshold_repeat_to=this._lower_threshold_deley_to=
null;this._lastTigger={upperThreshold:!1,lowerThreshold:!1};this._upperMatchCount=0;this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DominoswissWS");this._lastHit=null};util.inherits(A,r);A.TYPE="device.dominoswiss.weatherstation";A.prototype.init=function(a){if(this.device||this.gateway){var d=null;this.gateway&&this.gateway.sys&&(d=this.gateway.sys);!d&&this.device&&this.device.sys&&(d=this.device.sys);if(d&&(d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&
d.addStateDevice){var h={},q=this._getDevice(),t=this._getGateway();q&&(h=q);delete h.gateway;t&&(h.gateway=t);d.addStateDevice(h,null,{taskID:a,statusKey:"*",src:"taskman"})}}};A.prototype.finalize=function(a){if(this.device||this.gateway){var d=null;this.gateway&&this.gateway.sys&&(d=this.gateway.sys);!d&&this.device&&this.device.sys&&(d=this.device.sys);if(d&&(d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.removeStateDevice){var h={},q=this._getDevice(),t=this._getGateway();q&&
(h=q);delete h.gateway;t&&(h.gateway=t);d.removeStateDevice(h,null,{taskID:a,statusKey:"*",src:"taskman"})}}};A.prototype.isMatch=function(a){if(!a||!a.device||!a.device.sys)return!1;var d=require("x.hub.moduleman.js").modulemanager.getModule(a.device.sys);if(!d||!d.checkDeviceMatch)return!1;var h=this._getDevice(),q=this._getGateway();if(!d.checkDeviceMatch({device:h,gateway:q},a))return!1;this._logger.log("trace","receive event for device:"+JSON.stringify(a));h=d=!1;q=this._matchUpperThreshold(a);
a=this._matchLowerThreshold(a);this._logger.log("trace","upperMatch:"+q+" - lowerMatch:"+a);if("upper"==this._lastHit&&!a)return this._logger.log("trace","lastHit:upper - lowerMatch:"+a),!1;if("lower"==this._lastHit&&!q)return this._logger.log("trace","lastHit:lower - upperMatch:"+q),!1;"upper"==this._lastHit&&a&&(this._lastHit=null);"lower"==this._lastHit&&q&&(this._lastHit=null);1==q&&(this._upperMatchCount+=1,65535<this._upperMatchCount&&(this._upperMatchCount=1));switch(this._upper_threshold_state){case 0:1==
q&&("undefined"!=typeof this.upperThreshold.delay&&null!=this.upperThreshold.delay&&0<parseInt(this.upperThreshold.delay)?this._handleUpperThresholdDelay():(d=!0,this.upperThreshold.repeat&&this._handleUpperThresholdRepeat()));break;case 1:0==q&&(this._logger.log("trace","upper threshold not match, clear delay timeout"),this._upper_threshold_deley_to&&(clearTimeout(this._upper_threshold_deley_to),this._upper_threshold_deley_to=null),this._upper_threshold_state=0);break;case 2:0==q&&(this._logger.log("trace",
"upper threshold not match, clear repeat timeout"),this._upper_threshold_repeat_to&&(clearTimeout(this._upper_threshold_repeat_to),this._upper_threshold_repeat_to=null),this._upper_threshold_state=0)}switch(this._lower_threshold_state){case 0:1==a&&0<this._upperMatchCount&&("undefined"!=typeof this.lowerThreshold.delay&&null!=this.lowerThreshold.delay&&0<parseInt(this.lowerThreshold.delay)?this._handleLowerThresholdDelay():(h=!0,this._upperMatchCount=0,this.lowerThreshold.repeat&&this._handleLowerThresholdRepeat()));
break;case 1:0==a&&(this._logger.log("trace","lower threshold not match, clear delay timeout"),this._lower_threshold_deley_to&&(clearTimeout(this._lower_threshold_deley_to),this._lower_threshold_deley_to=null),this._lower_threshold_state=0);break;case 2:0==a&&(this._logger.log("trace","lower threshold not match, clear repeat timeout"),this._lower_threshold_repeat_to&&(clearTimeout(this._lower_threshold_repeat_to),this._lower_threshold_repeat_to=null),this._lower_threshold_state=0)}this._lastTigger=
{upperThreshold:d,lowerThreshold:h};this._logger.log("trace","upperHit:"+d+" - lowerHit:"+h);d?this._lastHit="upper":h&&(this._lastHit="lower");return d|h};A.prototype._matchUpperThreshold=function(a){if(!(this.upperThreshold&&this.upperThreshold.type&&a&&a.data&&a.data.key&&this.upperThreshold.type==a.data.key))return null;var d=this.upperThreshold.op;d||(d=">=");var h=this.upperThreshold.value;if("undefined"==typeof h||null==h)h=0;return this._matchThreshold(d,h,a.data.value)};A.prototype._matchLowerThreshold=
function(a){if(!(this.lowerThreshold&&this.lowerThreshold.type&&a&&a.data&&a.data.key&&this.lowerThreshold.type==a.data.key))return null;var d=this.lowerThreshold.op;d||(d=">=");var h=this.lowerThreshold.value;if("undefined"==typeof h||null==h)h=0;return this._matchThreshold(d,h,a.data.value)};A.prototype._matchThreshold=function(a,d,h){return"="==a||"=="==a?"true"==d?"true"==String(h):"false"==d?"false"==String(h):d==h:">="==a?parseFloat(h)>=parseFloat(d):">"==a?parseFloat(h)>parseFloat(d):"<="==
a?parseFloat(h)<=parseFloat(d):"<"==a?parseFloat(h)<parseFloat(d):!1};A.prototype._handleUpperThresholdDelay=function(){var a=this;this._upper_threshold_state=1;this._logger.log("trace","start upper threshold hit delay timeout:"+parseInt(this.upperThreshold.delay));this._upper_threshold_deley_to=setTimeout(function(){a._logger.log("trace","upper threshold delay timeout expired");a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,
a)}catch(d){}a.upperThreshold.repeat?a._handleUpperThresholdRepeat():a._upper_threshold_state=0},1E3*parseInt(this.upperThreshold.delay))};A.prototype._handleLowerThresholdDelay=function(){var a=this;this._lower_threshold_state=1;this._logger.log("trace","start lower threshold hit delay timeout:"+parseInt(this.lowerThreshold.delay));this._lower_threshold_delay_to=setTimeout(function(){a._lastTigger={upperThreshold:!1,lowerThreshold:!0};a._upperMatchCount=0;a._logger.log("trace","lower threshold delay timeout expired");
if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(d){}a.lowerThreshold.repeat?a._handleLowerThresholdRepeat():a._lower_threshold_state=0},1E3*parseInt(this.lowerThreshold.delay))};A.prototype._handleUpperThresholdRepeat=function(){var a=this;this._upper_threshold_state=2;var d=this.upperThreshold.repeat,h=0;if(d&&"string"==typeof d&&d.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){h=require("moment-timezone");var q=x.hub.taskman._Util._getTimeZone(),
t=(new Date).getTime();t=h.tz(t,q);var v=parseInt(d.substr(0,d.indexOf(":")));d=parseInt(d.substr(d.indexOf(":")+1));var u=(new Date).getTime();u=h.tz(u,q);u.set({hour:v,minute:d,second:0,millisecond:0});h=u.valueOf()-t.valueOf();if(0>h){this._upper_threshold_state=0;return}}else if(0<parseInt(d))h=1E3*parseInt(d);else{this._upper_threshold_state=0;return}this._logger.log("trace","start upper threshold hit repeat timeout:"+Math.round(h/1E3));this._upper_threshold_repeat_to=setTimeout(function(){a._logger.log("trace",
"upper threshold repeat timeout expired");a._upper_threshold_state=0;a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,a)}catch(z){}},h)};A.prototype._handleLowerThresholdRepeat=function(){var a=this;this._lower_threshold_state=2;var d=this.lowerThreshold.repeat,h=0;if(d&&"string"==typeof d&&d.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){h=require("moment-timezone");var q=x.hub.taskman._Util._getTimeZone(),
t=(new Date).getTime();t=h.tz(t,q);var v=parseInt(d.substr(0,d.indexOf(":")));d=parseInt(d.substr(d.indexOf(":")+1));var u=(new Date).getTime();u=h.tz(u,q);u.set({hour:v,minute:d,second:0,millisecond:0});h=u.valueOf()-t.valueOf();if(0>h){this._lower_threshold_state=0;return}}else if(0<parseInt(d))h=1E3*parseInt(d);else{this._lower_threshold_state=0;return}this._logger.log("trace","start lower threshold hit repeat timeout:"+Math.round(h/1E3));this._lower_threshold_repeat_to=setTimeout(function(){a._logger.log("trace",
"lower threshold repeat timeout expired");a._upperMatchCount=0;a._lower_threshold_state=0;a._lastTigger={upperThreshold:!1,lowerThreshold:!0};if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(z){}},h)};A.prototype.toJSON=function(){var a=l.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.upperThreshold=this.upperThreshold;a.lowerThreshold=this.lowerThreshold;return a};A.prototype.fromJSON=function(a){a&&(this.device=a.device,
this.gateway=a.gateway,this.upperThreshold=a.upperThreshold,this.lowerThreshold=a.lowerThreshold)};l.DominoswissWS=A;var y=function(){l.call(this);this.type=y.TYPE};util.inherits(y,l);y.TYPE="action";l.Action=y;var B=function(){y.call(this);this.subtype=B.SUBTYPE;this.body=this.event=this.key=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IFTTTMakerAction")};util.inherits(B,y);B.SUBTYPE="iftttmaker";B.prototype.do=function(a){if(this.key||this.event){var d=a;a={hostname:"maker.ifttt.com",
port:443,path:"/trigger/"+this.event+"/with/key/"+this.key,method:"POST",headers:{"Content-Type":"application/json"}};this._logger.log("trace","send https:"+JSON.stringify(a));this._logger.log("trace","with data:"+JSON.stringify(this.body));var h=this;a=require("https").request(a,function(t){t.setEncoding("utf8");var v="";t.on("data",function(u){v+=u});t.on("end",function(){h._logger.log("trace","action response:"+t.statusCode);h._logger.log("trace","with data:"+v);d&&(d(null,t.statusCode,v),d=null)})});
a.on("error",function(t){h._logger.log("debug","do action err:"+t.stack);d&&(d(t),d=null)});a.setTimeout(5E3,function(){h._logger.log("debug","do action timeout");d&&(d(Error("timeout")),d=null)});if(this.body)try{var q=JSON.stringify(this.body);a.write(q)}catch(t){}a.end()}else a&&a(Error("no key or event"))};B.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.key=this.key;a.event=this.event;a.body=this.body;return a};B.prototype.fromJSON=function(a){a&&(this.key=
a.key,this.event=a.event,this.body=a.body)};l.IFTTTMakerAction=B;var G=function(){y.call(this);this.subtype=G.SUBTYPE;this._cancelCB=this._doCB=this.body=this.headers=this.query=this.pathname=this.port=this.hostname=this.auth=this.protocol=this.method=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpAction")};util.inherits(G,y);G.SUBTYPE="http.action";G.prototype.do=function(a){var d=this.method;d||(d="GET");var h=this.protocol;h||(h="http");var q=this.port;if(!q||0>=parseInt(q))q=
"https"==h?443:80;var t=require("querystring"),v=this.pathname?this.pathname:"/";this.query&&(v+="?"+t.stringify(this.query));q={hostname:this.hostname,port:q,path:v,method:d,headers:this.headers};this.auth&&(q.auth=this.auth);this._logger.log("trace","send "+h+" "+d+":"+JSON.stringify(q));this._logger.log("trace","with data:"+JSON.stringify(this.body));this._trace&&(this._trace.log("execute http | "+h+" "+d+":"+JSON.stringify(q)),this._trace.log("execute http | with data:"+JSON.stringify(this.body)));
this._running=!0;this._doCB=a;var u=this;a=require(h).request(q,function(C){C.setEncoding("utf8");var H="";C.on("data",function(E){H+=E});C.on("end",function(){u._logger.log("trace","action response:"+C.statusCode);u._logger.log("trace","with data:"+H);u._trace&&(u._trace.log("execute http | response code:"+C.statusCode),u._trace.log("execute http | response data:"+H));u._doCB&&(u._running=!1,u._doCB(null,C.statusCode,H),u._doCB=null)})});a.on("error",function(C){u._trace&&u._trace.log("execute http | error:"+
C.message);u._logger.log("debug","do action err:"+C.stack);u._doCB&&(u._running=!1,u._doCB(C),u._doCB=null)});a.setTimeout(5E3,function(){u._trace&&u._trace.log("execute http | error:timeout");u._logger.log("debug","do action timeout");u._doCB&&(u._running=!1,u._doCB(Error("timeout")),u._doCB=null)});if(this.body&&"GET"!=d&&"DELETE"!=d)if("string"==typeof this.body)a.write(this.body);else try{var z=JSON.stringify(this.body);a.write(z)}catch(C){}a.end()};G.prototype.cancel=function(a){this._running?
(this._logger.log("trace","http action canceled"),this._doCB=null,this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};G.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.method=this.method;a.protocol=this.protocol;a.auth=this.auth;a.hostname=this.hostname;a.port=this.port;a.pathname=this.pathname;a.query=this.query;a.headers=this.headers;a.body=this.body;return a};G.prototype.fromJSON=function(a){a&&(this.subtype=a.subtype,this.method=a.method,this.protocol=
a.protocol,this.auth=a.auth,this.hostname=a.hostname,this.port=a.port,this.pathname=a.pathname,this.query=a.query,this.headers=a.headers,this.body=a.body)};l.HttpAction=G;var D=function(){y.call(this);this.subtype=D.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CommandAction");this._gatewayName=this._deviceName=null};util.inherits(D,y);D.SUBTYPE="command";D.prototype.do=function(a,d){if(this.device||this.gateway)if(this.command){d=
this.command;d.ref&&(d=d.ref);var h=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do command:"+JSON.stringify(this._toBluredJSON()));var q=this._getDevice(),t=this._getGateway();if(q&&"sonos"==q.sys&&d&&"playAlarm"==d.value&&(d=this._buildSonosCommand(d.ext),!d))return;this._running=!0;this._trace&&this._trace.log("execute command | "+this._getDescription());var v=this;h.executeCommand(q,t,d,function(u){u&&u.error?v._trace&&v._trace.log("execute command | "+v._getDescription()+
" | error:"+u.error.message):v._trace&&v._trace.log("execute command | "+v._getDescription()+" | success");if(v._canceling){v._logger.log("trace","command action canceled:"+JSON.stringify(v._toBluredJSON()));v._canceling=!1;u=v._running;v._running=!1;var z=v._cancelCB;v._cancelCB=null;z&&z(null,u)}else v._running=!1,a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};D.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};
D.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};D.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};D.prototype._toBluredJSON=function(){try{var a=JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username="xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&(a.gateway.username&&
(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(d){return this.toJSON()}};D.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var d=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);d&&d.info&&(this._deviceName=d.name,a=JSON.parse(JSON.stringify(d.info)))}catch(h){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};D.prototype._getGateway=function(){if(!this.gateway)return null;
var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var d=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);d&&d.info&&(this._gatewayName=d.name,a=JSON.parse(JSON.stringify(d.info)))}catch(h){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};D.prototype._getDescription=function(){var a=null;if(this._deviceName||this._gatewayName)a=this._deviceName?this._deviceName:this._gatewayName;
else if(this.device)try{tmp=JSON.parse(JSON.stringify(this.device)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(h){a=JSON.stringify(this.device)}else if(this.gateway)try{tmp=JSON.parse(JSON.stringify(this.gateway)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(h){a=JSON.stringify(this.gateway)}var d=this.command;d.ref&&(d=d.ref);return a+" | "+JSON.stringify(d)};D.prototype._getLocalIP=
function(){var a=require("os").networkInterfaces(),d;for(d in a)for(var h=a[d],q=0;q<h.length;q++){var t=h[q];if(t&&"IPv4"==t.family&&0==t.internal)return t.address}return null};D.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};D.prototype._buildSonosCommand=function(a){var d=this._getLocalIP(),h=this._getLocalPort();if(!d||!h)return null;switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";
break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+d+":"+h+"/resources/rehau_alarm/"+a}};l.CommandAction=D;var T=function(){y.call(this);this.subtype=T.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagUpperThresholdAction")};util.inherits(T,D);T.SUBTYPE="command.dominoswiss.upperthreshold";T.prototype.do=function(a,d){if(d&&d.trigger&&d.trigger.type==A.TYPE){var h=
d.trigger._lastTigger;h&&h.upperThreshold?D.prototype.do.call(this,a,d):a&&a()}else a&&a()};l.BrelagUpperThresholdAction=T;var U=function(){y.call(this);this.subtype=U.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagLowerThresholdAction")};util.inherits(U,D);U.SUBTYPE="command.dominoswiss.lowerthreshold";U.prototype.do=function(a,d){if(d&&d.trigger&&d.trigger.type==A.TYPE){var h=d.trigger._lastTigger;h&&h.lowerThreshold?
D.prototype.do.call(this,a,d):a&&a()}else a&&a()};l.BrelagUpperThresholdAction=U;var O=function(){y.call(this);this.subtype=O.SUBTYPE;this.actionID=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudAction")};util.inherits(O,y);O.SUBTYPE="cloud_action";O.prototype.do=function(a){if(this.actionID){this._logger.log("trace","do cloud action:"+this.actionID);var d=require("x.hub.js").server;if(d)if(d=d._cloudConnect){var h=JSON.stringify({type:"ACTION",data:this.actionID});
h=new Buffer("EVT:"+h,"utf8");d.sendMessageActive("0103"+h.toString("hex"),function(q){a&&a(q)})}else a&&a(Error("no cloud connect"));else a&&a(Error("no server in hub"))}else a&&a(Error("action id is empty"))};O.prototype.cancel=function(a){a&&a(null,!1)};O.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.actionID=this.actionID;return a};O.prototype.fromJSON=function(a){a&&(this.actionID=a.actionID)};var I=function(){y.call(this);this.subtype=I.SUBTYPE;this.macroName=
this.groupName=null;this._canceling=!1;this._macroExecutorID=this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.MacroAction")};util.inherits(I,y);I.SUBTYPE="macro";I.prototype.do=function(a){if(this.groupName&&this.macroName){var d=require("x.hub.macroman.js");this._logger.log("trace","do macro:"+JSON.stringify(this.toJSON()));var h=this;this._running=!0;this._trace&&this._trace.log("execute macro | "+this._getDescription());d.execute(this.groupName,this.macroName,
function(q){h._trace&&h._trace.log("execute macro | "+h._getDescription()+" | return:"+JSON.stringify(q));h._canceling?(h._logger.log("trace","macro action canceled:"+JSON.stringify(h.toJSON())),h._canceling=!1,h._running=!1,q=h._cancelCB,h._cancelCB=null,q&&q()):(h._running=!1,a&&a(q))},function(q){q&&q.id&&(h._macroExecutorID=q.id)})}else a&&a(Error("no group or macro"))};I.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a,this._macroExecutorID&&require("x.hub.macroman.js").cancel(this._macroExecutorID)):
a&&a(null,this._running)};I.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.groupName=this.groupName;a.macroName=this.macroName;return a};I.prototype.fromJSON=function(a){a&&(this.groupName=a.groupName,this.macroName=a.macroName)};I.prototype._getDescription=function(){return this.groupName+"."+this.macroName};l.MacroAction=I;var M=function(){y.call(this);this._cancelCB=this.token=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.SnsAction")};
util.inherits(M,y);M.prototype.do=function(a){if(this.token){var d=this;this._logger.log("trace","do sns:"+JSON.stringify(this.toJSON()));var h=new x.hub.taskman.Cloud;this._running=!0;this._trace&&this._trace.log("execute sns | "+this._getDescription());h._doRequest("GET","/xhub/sns/dosns?token="+this.token,null,null,null,null,function(q,t){d._trace&&d._trace.log("execute sns | "+d._getDescription()+" | "+(q?"error:"+q.message:"response:"+t));d._canceling?(d._logger.log("trace","sns action canceled:"+
JSON.stringify(d.toJSON())),d._canceling=!1,q=d._running,d._running=!1,t=d._cancelCB,d._cancelCB=null,t&&t(null,q)):(d._running=!1,q&&d._logger.log("warn","do sns error:"+q.stack),a&&a(q))})}else a&&a(Error("token is empty"))};M.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};M.prototype._getDescription=function(){return this.subtype+"."+this.token};var Q=function(){M.call(this);this.subtype=Q.SUBTYPE;this.token=null};util.inherits(Q,M);Q.SUBTYPE=
"EMAIL";Q.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};Q.prototype.fromJSON=function(a){a&&(this.token=a.token)};l.EmailAction=Q;var R=function(){M.call(this);this.subtype=R.SUBTYPE;this.token=null};util.inherits(R,M);R.SUBTYPE="PUSH";R.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};R.prototype.fromJSON=function(a){a&&(this.token=a.token)};l.PushAction=R;var S=
function(){M.call(this);this.subtype=S.SUBTYPE;this.token=null};util.inherits(S,M);S.SUBTYPE="SMS";S.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};S.prototype.fromJSON=function(a){a&&(this.token=a.token)};l.SmsAction=S;var V=function(a,d){this._runCallback=d;this._finishCallback=null;this._action=a;var h=this;this.runCallback=function(q){h._action.removeRunTask(h);h._runCallback&&h._runCallback(q)};this.finishCallback=function(){h._action.removeRunTask(h)}},
J=function(){y.call(this);this.subtype=J.SUBTYPE;this.name=this.id=null;this._scriptRunTasks=[];this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ScriptAction")};util.inherits(J,y);J.SUBTYPE="script";J.prototype.do=function(a){if(this.id){var d=require("x.hub.scriptman.js").scriptManager;this._logger.log("trace","do script:"+JSON.stringify(this.toJSON()));this._running=!0;a=new V(this,a);this._scriptRunTasks.push(a);this._trace&&this._trace.log("execute skript | "+this.id);d.runScript(this.id,
a.runCallback,a.finishCallback)}else a&&a(Error("no script id"))};J.prototype.cancel=function(a){if(this._running){var d=require("x.hub.scriptman.js").scriptManager;this._scriptRunTasks=[];this._running=!1;this._logger.log("trace","script action canceled:"+JSON.stringify(this.toJSON()));d.stopScript(this.id,function(){a&&a(null,!0)})}else a&&a(null,this._running)};J.prototype.removeRunTask=function(a){a=this._scriptRunTasks.indexOf(a);-1!=a&&this._scriptRunTasks.splice(a,1);0==this._scriptRunTasks.length&&
(this._running=!1)};J.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.id=this.id;a.name=this.name;return a};J.prototype.fromJSON=function(a){a&&(this.id=a.id,this.name=a.name)};l.ScriptAction=J;var N=function(){y.call(this);this.subtype=N.SUBTYPE;this._to=this.value=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.WaitAction")};util.inherits(N,y);N.SUBTYPE="wait";N.prototype.do=function(a){if(this.value){this._running=!0;var d=this;
this._trace&&this._trace.log("execute wait | wait "+this.value+" ms");this._to=setTimeout(function(){d._trace&&d._trace.log("execute wait | wait expired");d._running=!1;d._to=null;a&&a()},this.value)}else a&&a()};N.prototype.cancel=function(a){this._running?(this._to&&(this._logger.log("trace","wait action canceled:"+JSON.stringify(this.toJSON())),clearTimeout(this._to),this._to=null),this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};N.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);
a.subtype=this.subtype;a.value=this.value;return a};N.prototype.fromJSON=function(a){a&&(this.value=a.value)};l.WaitAction=N;var K=function(){y.call(this);this.subtype=K.SUBTYPE;this.page=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ChangePageAction");this._cancelCB=null};util.inherits(K,y);K.SUBTYPE="remote.changepage";K.prototype.do=function(a){this._trace&&this._trace.log("execute change page | "+this.remote+"."+this.page);this._running=!0;var d=[],h=require("os").networkInterfaces(),
q;for(q in h)for(var t=h[q],v=0;v<t.length;v++){var u=t[v];"IPv4"==u.family&&0==u.internal&&d.push(u.address)}var z=this,C=0,H=function(){if(z._canceling){z._logger.log("trace","change page action canceled:"+JSON.stringify(z.toJSON()));z._canceling=!1;var E=z._running;z._running=!1;var F=z._cancelCB;z._cancelCB=null;F&&F(null,E)}else C++,C>=d.length?(z._running=!1,a&&a()):z._sendEvent(d[C],H)};this._sendEvent(d[C],H)};K.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=
a):a&&a(null,this._running)};K.prototype._sendEvent=function(a,d){var h=require("dgram"),q=require("unorm"),t={func:"changePage",remote:q.nfc(this.remote),page:q.nfc(this.page),time:Date.now()};t=new Buffer("{XC_EVT}"+JSON.stringify(t),"utf8");var v=h.createSocket({type:"udp4",reuseAddr:!0});v.bind(a,function(){v.setBroadcast(!0);v.send(t,0,t.length,1902,"255.255.255.255");v.send(t,0,t.length,1902,"255.255.255.255",function(u){v.close();d&&d(u)})})};K.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);
a.subtype=this.subtype;a.remote=this.remote;a.page=this.page;return a};K.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.page=a.page)};l.ChangePageAction=K;var L=function(){y.call(this);this.subtype=L.SUBTYPE;this.template=this.settings=this.action=this.popup=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.PopupAction");this._cancelCB=null};util.inherits(L,y);L.SUBTYPE="remote.popup";L.prototype.do=function(a){this._trace&&this._trace.log("execute popup action | "+
this.remote+"."+this.popup+"."+this.action);this._running=!0;var d=[],h=require("os").networkInterfaces(),q;for(q in h)for(var t=h[q],v=0;v<t.length;v++){var u=t[v];"IPv4"==u.family&&0==u.internal&&d.push(u.address)}var z=this,C=0,H=function(){if(z._canceling){z._logger.log("trace","popup action canceled:"+JSON.stringify(z.toJSON()));z._canceling=!1;var E=z._running;z._running=!1;var F=z._cancelCB;z._cancelCB=null;F&&F(null,E)}else C++,C>=d.length?(z._running=!1,a&&a()):z._sendEvent(d[C],H)};this._sendEvent(d[C],
H)};L.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};L.prototype._sendEvent=function(a,d){var h=require("dgram"),q=require("unorm"),t={func:"popup",remote:q.nfc(this.remote),action:q.nfc(this.action),time:Date.now()};if(this.popup&&"open"===this.action&&(t.popup=q.nfc(this.popup),this.settings))try{t.settings=q.nfc(JSON.stringify(this.settings))}catch(u){self._logger.log("error",u.message)}t=new Buffer("{XC_EVT}"+JSON.stringify(t),"utf8");
var v=h.createSocket({type:"udp4",reuseAddr:!0});v.bind(a,function(){v.setBroadcast(!0);v.send(t,0,t.length,1902,"255.255.255.255");v.send(t,0,t.length,1902,"255.255.255.255",function(u){v.close();d&&d(u)})})};L.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.popup=this.popup;a.action=this.action;a.settings=this.settings;a.template=this.template;return a};L.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.popup=a.popup,this.action=
a.action,this.settings=a.settings,this.template=a.template)};l.PopupAction=L;var P=function(){D.call(this);this.subtype=P.SUBTYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.AudioAction")};util.inherits(P,D);P.SUBTYPE="audio";P.prototype.do=function(a){if(this.device||this.gateway)if(this.command){var d=this.command;d.ref&&(d=d.ref);this._logger.log("trace","do audio command:"+JSON.stringify(this._toBluredJSON()));var h=this._getDevice(),q=this._getGateway();this._running=
!0;this._trace&&this._trace.log("execute audio command | "+this._getDescription());var t=this;require("x.hub.commandman.js").commandHandler.executeCommand(h,q,d,function(v){v&&v.error?t._trace&&t._trace.log("execute command | "+t._getDescription()+" | error:"+v.error.message):t._trace&&t._trace.log("execute command | "+t._getDescription()+" | success");t._running=!1;a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};P.prototype.toJSON=function(){var a=y.prototype.toJSON.call(this);
a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};P.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};l.AudioAction=P;l.parse=function(a){if(!a||!a.type)return null;switch(a.type){case c.TYPE:var d=l.Root;break;case e.TYPE:d=e;break;case y.TYPE:switch(a.subtype){case D.SUBTYPE:d=D;break;case T.SUBTYPE:d=T;break;case U.SUBTYPE:d=U;break;case Q.SUBTYPE:d=Q;break;case R.SUBTYPE:d=R;break;case S.SUBTYPE:d=
S;break;case J.SUBTYPE:d=J;break;case N.SUBTYPE:d=N;break;case I.SUBTYPE:d=I;break;case B.SUBTYPE:d=B;break;case G.SUBTYPE:d=G;break;case K.SUBTYPE:d=K;break;case O.SUBTYPE:d=O;break;case P.SUBTYPE:d=P;break;case L.SUBTYPE:d=L;break;default:return null}break;case r.TYPE:d=r;break;case A.TYPE:d=A;break;case b.TYPE:d=b;break;case f.TYPE:d=f;break;case m.TYPE:d=m;break;case g.TYPE:d=g;break;case k.TYPE:d=k;break;case p.TYPE:d=p;break;case n.TYPE:d=n;break;case w.TYPE:d=w;break;default:return null}d=
new d;d.fromJSON(a);return d};return l}();
x.hub.taskman.Task=function(){var l=function(e){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Task");this.root=this.name=this.id=null;this.active=!0;this.singleton=this.rehauAlarmTask=this.isAlarmTask=!1;this.singletonMethod="ignore";this._trace=null;e&&(this.id=e.id,this.name=e.name,this.active=e.active,this.isAlarmTask=e.isAlarmTask,this.rehauAlarmTask=e.rehauAlarmTask,this.singleton=e.singleton,this.singletonMethod=e.singletonMethod);if("undefined"==typeof this.active||null==this.active)this.active=
!0;if("undefined"==typeof this.isAlarmTask||null==this.isAlarmTask)this.isAlarmTask=!1;if("undefined"==typeof this.rehauAlarmTask||null==this.rehauAlarmTask)this.rehauAlarmTask=!1};l.prototype.init=function(){this.root&&this.root.init(this.id)};l.prototype.getTriggers=function(){return this.root?this.root.getTriggers():[]};l.prototype.finalize=function(){try{this.root&&this.root.finalize(this.id)}catch(e){this._logger.log("warn","finalize task "+this.id+" error:"+e.message)}};l.prototype.trigger=
function(e){this.root?(this.root._onTriggered(),e&&e()):e&&e(Error("no content"))};l.prototype.cancel=function(e){this.root?(this.root.cancel(),e&&e()):e&&e(Error("no content"))};l.prototype.isActive=function(){return this.active};l.prototype.setActive=function(e){if("undefined"==typeof e||null==e)e=!0;"string"==typeof e&&(e="false"==e?!1:!0);this.active=e};l.prototype.toggleActive=function(){this.active=!this.active};l.prototype.setRehauAlarmTask=function(e){this.rehauAlarmTask=e};l.prototype.isRehauAlarmTask=
function(){return this.rehauAlarmTask};l.prototype.setAlarmTask=function(e){if("undefined"==typeof e||null==e)e=!1;"string"==typeof e&&(e="false"==e?!1:!0);this.isAlarmTask=e};l.prototype.isRunning=function(){return this.root?this.root.isRunning():!1};l.prototype.onStatusEvt=function(e){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onStatusEvt(e)};
l.prototype.onStatusEvtForTask=function(e){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive dedicated status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onDedicatedStatusEvt(e)};l.prototype.onIREvt=function(e){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive ir event");if(this.active&&this.root&&(!this.isAlarmTask||
require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onIREvt(e)};l.prototype.onTimerTick=function(e){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive timer tick");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onTimerTick(e)};l.prototype.onHttpEvt=function(e,c){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive http event");
if(this.active&&this.root)if(this.isAlarmTask&&!require("x.hub.taskman.js").taskManager._alarmTask._active)c&&c(null,!1);else this.root.onHttpEvt(e,c);else c&&c(null,!1)};l.prototype.toJSON=function(){var e={id:this.id,name:this.name,active:this.active,isAlarmTask:this.isAlarmTask,rehauAlarmTask:this.rehauAlarmTask,singleton:this.singleton,singletonMethod:this.singletonMethod,root:{}};this.root&&(e.root=this.root.toJSON());return e};l.prototype.startTaskTrace=function(e,c){this._trace||(this._trace=
new x.hub.taskman.TaskTrace(this),this.root&&this.root.setTrace(this._trace));this._trace.addListener(e);c&&c()};l.prototype.stopTaskTrace=function(e,c){this._trace&&(this._trace.removeListener(e),0==this._trace.getListeners().length&&(this.root&&this.root.setTrace(null),this._trace=null));c&&c()};l.prototype.toCloudRuleJSON=function(e,c,g,k,p){var b=[],f=this.getTriggers();if(!f||0==f.length)return null;for(var m=0;m<f.length;m++){var n=f[m];n&&"cloud.trigger.device"==n.type&&(n=n.toCloudTriggerFormat())&&
b.push(n)}return 0==b.length?null:{name:this.name,owner:c,app:e,action:[{sys:"mediola",data:{data:{XC_FNC:"DoTask",id:this.id},token:p,ccs:g+(k?":"+k:""),cmd:"cmd"}}],trigger:b}};l.prototype.getCloudDeviceTriggerGateway=function(){if(!this.root)return null;var e=this.root.getTriggers(),c=null;if(!e||0>=e.length)return null;for(var g=0;g<e.length;g++){var k=e[g];if(k&&"cloud.trigger.device"==k.type&&(c=k._getGateway()))break}return c};l.parse=function(e){if(!e||!e.id||!e.name)return null;var c=new l(e);
e.root&&(c.root=x.hub.taskman._Block.parse(e.root),c.root&&(c.root._task=c,c.root.singleton=c.singleton,c.root.singletonMethod=c.singletonMethod));return c};return l}();
x.hub.taskman.AlarmTask=function(){var l=function(){this._active=!1;this._delay=0;this._activateDelayTO=null};l.prototype.init=function(){this._active="true"==localStorage.getItem("x.hub.taskman.TaskManager.alarmActive");this._delay=parseInt(localStorage.getItem("x.hub.taskman.TaskManager.alarmDelay"))};l.prototype.setAlarmActive=function(e,c,g,k){var p=function(f,m,n){if("undefined"==typeof m||null==m)m=!0;"string"==typeof m&&(m="false"==m?!1:!0);f._tasks.forEach(function(r){r.isAlarmTask&&(r.active=
m)});f._writeData(n)};if(this._getAlarmPin()!=c)c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,k&&k(c);else if(this._activateDelayTO&&(clearTimeout(this._activateDelayTO),this._activateDelayTO=null),this._delay&&e){var b=this;this._activateDelayTO=setTimeout(function(){localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",e);b._active=e;b._activateDelayTO=null;p(g,e)},1E3*this._delay);k&&k()}else localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",e),this._active=e,
p(g,e,k)};l.prototype.setAlarmDelay=function(e,c,g){this._getAlarmPin()!=c?(e=Error("pin error"),e.code=x.hub.taskman.ERROR_CODE.Pin_Error,g&&g(e)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmDelay",e),this._delay=e,g&&g())};l.prototype.getAlarmInfo=function(e){e&&e(null,{active:this._active,delay:this._delay?this._delay:0,pendingActive:null!=this._activateDelayTO})};l.prototype.selectAlarmTask=function(e,c,g,k,p){if(e){for(var b=null,f=0;f<k.length;f++){var m=k[f];if(m.id==e){b=m;break}}b?
(e=this._getAlarmPin(),g&&g==e?this._active?p&&p(Error("alarm task active")):(b.setAlarmTask(c),p&&p()):(c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,p&&p(c))):p&&p(Error("no such task:"+e))}else p&&p(Error("task id is null"))};l.prototype._getAlarmPin=function(){return localStorage.getItem("x.hub.taskman.TaskManager.alarmPin")?localStorage.getItem("x.hub.taskman.TaskManager.alarmPin"):l.DEFAULT_PIN};l.prototype.setAlarmPin=function(e,c,g){var k=this._getAlarmPin();e?c!=k?(e=Error("pin error"),
e.code=x.hub.taskman.ERROR_CODE.Pin_Error,g&&g(e)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmPin",e),g&&g()):g&&g(Error("new pin invalid"))};l.DEFAULT_PIN="0000";return l}();
x.hub.taskman.TaskTrace=function(){var l=function(e){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskTrace");this._task=e;this._listeners=[]};l.prototype.addListener=function(e){e&&-1==this._listeners.indexOf(e)&&this._listeners.push(e)};l.prototype.removeListener=function(e){e&&(e=this._listeners.indexOf(e),-1!=e&&this._listeners.splice(e,1))};l.prototype.getListeners=function(e){return this._listeners};l.prototype.log=function(e){this._logger.log("trace","[Task "+this._task.id+
"]:"+e);e="["+this._getTimestamp()+"] "+e;this._listeners.forEach(function(c){c&&c(e)})};l.prototype._getTimestamp=function(){return(new Date).toTimeString()};return l}();x.hub.taskman.rehau={};
x.hub.taskman.rehau.AlarmTaskManager=function(){var l=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmDoor");this._alarmTask=this._activateEvent=this._device=this._id=null};l.prototype.init=function(){if(this._device){var b=require("x.hub.moduleman.js").modulemanager.getModule("aio");b&&b.addStateDevice&&this._activateEvent&&this._activateEvent.status&&b.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};
l.prototype.finalize=function(){if(this._device){var b=require("x.hub.moduleman.js").modulemanager.getModule("aio");b&&b.removeStateDevice&&this._activateEvent&&this._activateEvent.status&&b.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};l.prototype.setAlarmTask=function(b){this._alarmTask=b};l.prototype.getID=function(){return this._id};l.prototype.setID=function(b){this._id=b};l.prototype.setDevice=function(b){this._device=
b};l.prototype.setActivateEvent=function(b){this._activateEvent=b};l.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent}};l.prototype.matchDevice=function(b){return this._device&&b?this._device.type==b.type&&this._device.address==b.address:!1};l.prototype.onStatusEvt=function(b){b&&b.data&&this._activateEvent&&this._activateEvent.status==b.data.key&&this._activateEvent.value==b.data.value&&(this._logger.log("trace","alarm door:"+this._device.address+
" receive event:"+b.data.value+" and trigger door alarm"),this._alarmTask&&this._alarmTask.triggerDoorAlarm())};l.buildDoorfromJSON=function(b){if(!b||!b.device)return null;var f=new l;f.setID(b.id);f.setDevice(b.device);f.setActivateEvent(b.activateEvent);return f};var e=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmKey");this._alarmTask=this._deactivateEvent=this._activateEvent=this._device=this._id=null};e.prototype.init=function(){if(this._device){var b=require("x.hub.moduleman.js").modulemanager.getModule("aio");
b&&b.addStateDevice&&(this._activateEvent&&this._activateEvent.status&&b.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&b.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};e.prototype.finalize=function(){if(this._device){var b=require("x.hub.moduleman.js").modulemanager.getModule("aio");
b&&b.removeStateDevice&&(this._activateEvent&&this._activateEvent.status&&b.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&b.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};e.prototype.setAlarmTask=function(b){this._alarmTask=b};e.prototype.getID=function(){return this._id};
e.prototype.setID=function(b){this._id=b};e.prototype.setDevice=function(b){this._device=b};e.prototype.setActivateEvent=function(b){this._activateEvent=b};e.prototype.setDeactivateEvent=function(b){this._deactivateEvent=b};e.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent,deactivateEvent:this._deactivateEvent}};e.prototype.matchDevice=function(b){return this._device&&b?this._device.type==b.type&&this._device.address==b.address:!1};e.prototype.onStatusEvt=
function(b){if(b&&b.data)if(this._activateEvent&&this._activateEvent.status==b.data.key&&this._activateEvent.value==b.data.value){if(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+b.data.key+" and activate alarm task"),this._alarmTask){b=this._alarmTask.getManager();var f=this._alarmTask.getID();b._setAlarmActive(f,!0,function(m){})}}else this._deactivateEvent&&this._deactivateEvent.status==b.data.key&&this._deactivateEvent.value==b.data.value&&(this._logger.log("trace",
"alarm key:"+this._device.address+" receive event:"+b.data.key+" and deactivate alarm task"),this._alarmTask&&this._alarmTask.deactivate())};e.buildKeyfromJSON=function(b){if(!b||!b.device)return null;var f=new e;f.setID(b.id);f.setDevice(b.device);f.setActivateEvent(b.activateEvent);f.setDeactivateEvent(b.deactivateEvent);return f};var c=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmConfirmation");this._alarmTask=this._preAlarmNotificationInterval=this._deactivateAction=
this._activateAction=this._device=this._id=null};c.prototype.setAlarmTask=function(b){this._alarmTask=b};c.prototype.getID=function(){return this._id};c.prototype.setID=function(b){this._id=b};c.prototype.setDevice=function(b){this._device=b};c.prototype.setActivateAction=function(b){this._activateAction=b};c.prototype.setDeactivateAction=function(b){this._deactivateAction=b};c.prototype.toJSON=function(){return{id:this._id,device:this._device,activateAction:this._activateAction,deactivateAction:this._deactivateAction}};
c.prototype.activationBlockedForAlarmKey=function(){if(this._device&&this._activateAction&&"aio"==this._device.sys&&"HM"==this._device.type&&"ip_siren"==this._device.data){var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var f=this;b.executeCommand(this._device,null,{value:"triggerAlarm12,6,2,0",ext:[{value:"alarmAudio",ext:"FREQUENCY_FALLING"},{value:"alarmVisual",ext:"BLINKING_ALTERNATELY_REPEATING"},{value:"alarmDur",
ext:1},{value:"alarmDurUnit",ext:"S"}]},function(m){m&&m.error&&f._logger.log("trace","do activate confirmation error:"+m.error.message)})}};c.prototype.onActivated=function(){if(this._device&&this._activateAction){var b=this._activateAction;b.ref&&(b=b.ref);if("sonos"==this._device.sys&&(b=this._buildSonosCommand(this._activateAction.ext),!b))return;var f=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var m=this;f.executeCommand(this._device,
null,b,function(n){n&&n.error&&m._logger.log("trace","do activate confirmation error:"+n.error.message)})}};c.prototype.onDeactivated=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null);if(this._device&&this._deactivateAction){var b=this._deactivateAction;b.ref&&(b=b.ref);if("sonos"==this._device.sys&&(b=this._buildSonosCommand(this._deactivateAction.ext),!b))return;var f=require("x.hub.commandman.js").commandHandler;
this._logger.log("trace","do deactivate confirmation:"+JSON.stringify(this.toJSON()));var m=this;f.executeCommand(this._device,null,b,function(n){n&&m._logger.log("trace","do deactivate confirmation error:"+n.message)})}};c.prototype.startPreAlarmNotification=function(){if(!this._preAlarmNotificationInterval){var b=this;this._doPreAlarmNotification();this._preAlarmNotificationInterval=setInterval(function(){b._doPreAlarmNotification()},7E3)}};c.prototype.stopPreAlarmNotification=function(){this._preAlarmNotificationInterval&&
(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null)};c.prototype._doPreAlarmNotification=function(){if(this._device&&this._activateAction){var b=this._activateAction;b.ref&&(b=b.ref);if("sonos"==this._device.sys&&(b=this._buildSonosCommand("pre_alarm"),!b))return;var f=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do pre alarm notification:"+JSON.stringify(this.toJSON()));var m=this;f.executeCommand(this._device,null,b,function(n){n&&
n.error&&m._logger.log("trace","do pre alarm notification error:"+n.error.message)})}};c.prototype._getLocalIP=function(){var b=require("os").networkInterfaces(),f;for(f in b)for(var m=b[f],n=0;n<m.length;n++){var r=m[n];if(r&&"IPv4"==r.family&&0==r.internal)return r.address}return null};c.prototype._getLocalPort=function(){var b=require("x.hub.js");return b.server?b.server._port:null};c.prototype._buildSonosCommand=function(b){var f=this._getLocalIP(),m=this._getLocalPort();if(!f||!m)return null;
switch(b){case "alarm_on":b="alarm_on.mp3";break;case "alarm_off":b="alarm_off.mp3";break;case "pre_alarm":b="pre_alarm.mp3";break;case "alarm":b="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+f+":"+m+"/resources/rehau_alarm/"+b,timeout:15}};c.buildConfirmationfromJSON=function(b){if(!b||!b.device)return null;var f=new c;f.setID(b.id);f.setDevice(b.device);f.setActivateAction(b.activateAction);f.setDeactivateAction(b.deactivateAction);return f};var g=function(b){this._logger=
Logger.getLogger("x.hub.taskman.rehau.AlarmTask");this._id=b;this._pin=null;this._active=!1;this._delay=0;this._doorAlarmDelay=5;this._alarmKeys=[];this._alarmDoors=[];this._manager=this._doorAlarmDelayTimer=this._activateDelayTimer=this._associateTaskId_prealarm=this._associateTaskId_alarm=this._alarmConfirmation=null};g.DEFAULT_PIN="0000";g.prototype.init=function(b){this._logger.log("trace","init rehau alarm task");this._initAllAlarmKeys();this._initAllAlarmDoors();this._initAllAlarmWindowsSensors();
b&&b()};g.prototype._initAllAlarmKeys=function(){for(var b=0;b<this._alarmKeys.length;b++){var f=this._alarmKeys[b];f&&f.init()}};g.prototype._initAllAlarmDoors=function(){for(var b=0;b<this._alarmDoors.length;b++){var f=this._alarmDoors[b];f&&f.init()}};g.prototype._initAllAlarmWindowsSensors=function(){this._active&&require("x.hub.m.enocean.js").setRehauAlarm(this._active)};g.prototype.setManager=function(b){this._manager=b};g.prototype.getManager=function(){return this._manager};g.prototype.getID=
function(){return this._id};g.prototype.getDelay=function(){return this._delay};g.prototype.setDelay=function(b){this._delay=b};g.prototype.getAssociateTaskIdAlarm=function(){return this._associateTaskId_alarm};g.prototype.setAssociateTaskIdAlarm=function(b){this._associateTaskId_alarm=b};g.prototype.getAssociateTaskIdPreAlarm=function(){return this._associateTaskId_prealarm};g.prototype.setAssociateTaskIdPreAlarm=function(b){this._associateTaskId_prealarm=b};g.prototype.getPin=function(){return this._pin?
this._pin:g.DEFAULT_PIN};g.prototype.setPin=function(b){this._pin=b};g.prototype.getDoorAlarmDelay=function(){return this._doorAlarmDelay};g.prototype.setDoorAlarmDelay=function(b){this._doorAlarmDelay=b};g.prototype.isActive=function(){return this._active};g.prototype.isWaitForActive=function(){return this._activateDelayTimer&&!this._active?!0:!1};g.prototype.cancelDelayActive=function(){this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=null;this._doorAlarmDelayTimer&&
clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null};g.prototype.activate=function(){var b=require("x.hub.m.enocean.js");if(b.isRehauWindowOpen()||require("x.hub.m.hm.js").isWindowOpen())return!0;var f=this;if(this._delay)this._logger.log("trace","activate alarm task:"+this._id+" after "+this._delay+" seconds"),this._activateDelayTimer=setTimeout(function(){f._logger.log("trace","activate alarm task:"+this._id);f._active=!0;f._setAssociateTaskActive(!0);f._manager&&f._manager.save();
b.setRehauAlarm(!0);f._activateDelayTimer=null;if(f._alarmConfirmation)f._alarmConfirmation.onActivated()},1E3*this._delay);else if(this._logger.log("trace","activate alarm task:"+this._id),this._active=!0,this._setAssociateTaskActive(!0),this._manager&&this._manager.save(),b.setRehauAlarm(!0),this._alarmConfirmation)this._alarmConfirmation.onActivated();return!1};g.prototype.deactivate=function(){this._active=!1;this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=
null;this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null;this._logger.log("trace","deactivate alarm task:"+this._id);this._setAssociateTaskActive(!1);this._manager&&this._manager.save();require("x.hub.m.enocean.js").setRehauAlarm(!1);if(this._alarmConfirmation)this._alarmConfirmation.onDeactivated()};g.prototype._setAssociateTaskActive=function(b,f){if(this._manager){var m=0;this._associateTaskId_alarm&&(m+=1);this._associateTaskId_prealarm&&(m+=1);var n=
function(){m--;0==m&&f&&f()};this._associateTaskId_alarm&&this._manager.setAssociateTaskActive(this._associateTaskId_alarm,b,n);this._associateTaskId_prealarm&&this._manager.setAssociateTaskActive(this._associateTaskId_prealarm,b,n)}else f&&f(Error("manager is null"))};g.prototype.activationBlockedForAlarmKey=function(){this._alarmConfirmation&&this._alarmConfirmation.activationBlockedForAlarmKey()};g.prototype.addAlarmKey=function(b,f){if(b)if(b=e.buildKeyfromJSON(b))if(b.getID())f&&f(Error("id for new alarm key is not null "));
else{b.setID(this._generateAlarmKeyID());this._addAlarmKeySync(b);var m=this;this._manager.save(function(n){f&&f(n,m.toJSON())})}else f&&f(Error("alarm key json invalid"));else f&&f(Error("alarm key json is null"))};g.prototype.updateAlarmKey=function(b,f){if(b)if(b=e.buildKeyfromJSON(b)){var m=b.getID();if(m){var n=this._getAlarmKeySync(m);if(n){this._deleteAlarmKeySync(n);this._addAlarmKeySync(b);var r=this;this._manager.save(function(w){f&&f(w,r.toJSON())})}else f&&f(Error("no such alarm key with id:"+
m))}else f&&f(Error("id for alarm key is null"))}else f&&f(Error("alarm key json invalid"));else f&&f(Error("alarm key json is null"))};g.prototype.deleteAlarmKey=function(b,f){if(b){var m=this._getAlarmKeySync(b.id);if(m){this._deleteAlarmKeySync(m);var n=this;this._manager.save(function(r){f&&f(r,n.toJSON())})}else f&&f(Error("no such alarm key with id:"+b.id))}else f&&f(Error("alarm key is null"))};g.prototype.addAlarmDoor=function(b,f){if(b)if(b=l.buildDoorfromJSON(b))if(b.getID())f&&f(Error("id for new alarm door is not null "));
else{b.setID(this._generateAlarmDoorID());this._addAlarmDoorSync(b);var m=this;this._manager.save(function(n){f&&f(n,m.toJSON())})}else f&&f(Error("alarm door json invalid"));else f&&f(Error("alarm door json is null"))};g.prototype.updateAlarmDoor=function(b,f){if(b)if(b=l.buildDoorfromJSON(b)){var m=b.getID();if(m){var n=this._getAlarmDoorSync(m);if(n){this._deleteAlarmDoorSync(n);this._addAlarmDoorSync(b);var r=this;this._manager.save(function(w){f&&f(w,r.toJSON())})}else f&&f(Error("no such alarm door with id:"+
m))}else f&&f(Error("id for alarm door is null"))}else f&&f(Error("alarm door json invalid"));else f&&f(Error("alarm door json is null"))};g.prototype.deleteAlarmDoor=function(b,f){if(b){var m=this._getAlarmDoorSync(b.id);if(m){this._deleteAlarmDoorSync(m);var n=this;this._manager.save(function(r){f&&f(r,n.toJSON())})}else f&&f(Error("no such alarm door with id:"+b.id))}else f&&f(Error("alarm door is null"))};g.prototype.setAlarmConfirmation=function(b,f){if(b)if(b=c.buildConfirmationfromJSON(b)){b.setAlarmTask(this);
var m=this;this._alarmConfirmation=b;this._manager.save(function(n){f&&f(n,m.toJSON())})}else f&&f(Error("alarm confirmation json invalid"));else f&&f(Error("alarm confirmation json is null"))};g.prototype.getAlarmTaskSync=function(b){return this._taskmanager.readTaskSync(b)};g.prototype.triggerDoorAlarm=function(){if(this._active)if(!this._doorAlarmDelay)this._logger.log("trace","no door alarm delay, execute associated task:"+this._associateTaskId_alarm),this._associateTaskId_alarm&&this._manager&&
this._manager.executeAssociateTask(this._associateTaskId_alarm);else if(!this._doorAlarmDelayTimer){this._alarmConfirmation&&(this._logger.log("trace","door alarm start pre-alarm notification"),this._alarmConfirmation.startPreAlarmNotification());this._logger.log("trace","door alarm execute associated task:"+this._associateTaskId_alarm+" after "+this._doorAlarmDelay+" seconds");var b=this;this._doorAlarmDelayTimer=setTimeout(function(){b._doorAlarmDelayTimer=null;b._alarmConfirmation&&(b._logger.log("trace",
"door alarm stop pre-alarm notification"),b._alarmConfirmation.stopPreAlarmNotification());b._associateTaskId_alarm&&(b._logger.log("trace","door alarm execute associated task:"+b._associateTaskId_alarm),b._manager&&b._manager.executeAssociateTask(b._associateTaskId_alarm))},1E3*this._doorAlarmDelay)}};g.prototype.triggerWindowSensorAlarm=function(b){this._active&&(b&&this._associateTaskId_prealarm?this._manager&&this._manager.executeAssociateTask(this._associateTaskId_prealarm):!b&&this._associateTaskId_alarm&&
this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm))};g.prototype.onStatusEvt=function(b){if(b){for(var f=0;f<this._alarmKeys.length;f++){var m=this._alarmKeys[f];if(m&&m.matchDevice(b.device))m.onStatusEvt(b)}for(f=0;f<this._alarmDoors.length;f++)if((m=this._alarmDoors[f])&&m.matchDevice(b.device))m.onStatusEvt(b)}};g.prototype._getAlarmKeySync=function(b){if(!b)return null;var f=this._alarmKeys.length;if(!f)return null;for(;f--;){var m=this._alarmKeys[f];if(m&&m.getID()==
b)return m}return null};g.prototype._addAlarmKeySync=function(b){b.setAlarmTask(this);this._alarmKeys.push(b);b.init()};g.prototype._deleteAlarmKeySync=function(b){b.finalize();b=this._alarmKeys.indexOf(b);-1!=b&&this._alarmKeys.splice(b,1)};g.prototype._getAlarmDoorSync=function(b){if(!b)return null;var f=this._alarmDoors.length;if(!f)return null;for(;f--;){var m=this._alarmDoors[f];if(m&&m.getID()==b)return m}return null};g.prototype._addAlarmDoorSync=function(b){b.setAlarmTask(this);this._alarmDoors.push(b);
b.init()};g.prototype._deleteAlarmDoorSync=function(b){b.finalize();b=this._alarmDoors.indexOf(b);-1!=b&&this._alarmDoors.splice(b,1)};g.prototype._generateAlarmKeyID=function(){var b=[],f=this._alarmKeys.length;if(0==f)return 1;for(;f--;){var m=this._alarmKeys[f];m&&(b[m.getID()]=!0)}for(f=1;b[f];)f++;return f};g.prototype._generateAlarmDoorID=function(){var b=[],f=this._alarmDoors.length;if(0==f)return 1;for(;f--;){var m=this._alarmDoors[f];m&&(b[m.getID()]=!0)}for(f=1;b[f];)f++;return f};g.prototype._getActivationDelayTimer=
function(b){return this._activateDelayTimer[b]};g.prototype._clearActivationDelayTimer=function(b){var f=this._activateDelayTimer[b];f&&clearTimeout(f);delete this._activateDelayTimer[b]};g.prototype.toJSON=function(){for(var b={id:this._id,active:this._active,delay:this._delay,doorAlarmDelay:this._doorAlarmDelay,alarmKeys:[],alarmDoors:[],alarmConfirmation:null,associateTaskId_alarm:this._associateTaskId_alarm,associateTaskId_prealarm:this._associateTaskId_prealarm},f=0;f<this._alarmKeys.length;f++){var m=
this._alarmKeys[f];m&&(m=m.toJSON())&&b.alarmKeys.push(m)}for(f=0;f<this._alarmDoors.length;f++)(m=this._alarmDoors[f])&&(m=m.toJSON())&&b.alarmDoors.push(m);this._alarmConfirmation&&(b.alarmConfirmation=this._alarmConfirmation.toJSON());return b};g.buldTaskFromJSON=function(b){if(!b||!b.id)return null;var f=new g(b.id);f._pin=b.pin;f._active=b.active;f._delay=b.delay;f._doorAlarmDelay=b.doorAlarmDelay;f._associateTaskId_alarm=b.associateTaskId_alarm;f._associateTaskId_prealarm=b.associateTaskId_prealarm;
if(b.alarmKeys)for(var m=0;m<b.alarmKeys.length;m++){var n=b.alarmKeys[m];n&&(n=e.buildKeyfromJSON(n))&&(n.setAlarmTask(f),f._alarmKeys.push(n))}if(b.alarmDoors)for(m=0;m<b.alarmDoors.length;m++)if(n=b.alarmDoors[m])if(n=l.buildDoorfromJSON(n))n.setAlarmTask(f),f._alarmDoors.push(n);b.alarmConfirmation&&(b=c.buildConfirmationfromJSON(b.alarmConfirmation))&&(b.setAlarmTask(f),f._alarmConfirmation=b);return f};var k=function(b){this._alarmTaskTokenPoll=[];this._manager=b};k.prototype.generateToken=
function(b){var f=this._manager._getAlarmTask(b);if(null==f||100<this._alarmTaskTokenPoll.length)return null;for(var m=this._generateNonce();this._nonceExist(m);)m=this._generateNonce();f=f.getPin();f=this._hashPin(m,f);var n=this,r={nonce:m,hash:f,taskID:b,timeout:null,failedCount:0};this._alarmTaskTokenPoll.push(r);r.timeout=setTimeout(function(){n._tokenExpired(r)},3E4);return m};k.prototype.authenticate=function(b,f){if(null==this._manager._getAlarmTask(b)||20>=f.length)return!1;var m=f.substr(0,
20);f=f.substr(20);for(var n=null,r=0;r<this._alarmTaskTokenPoll.length;r++){var w=this._alarmTaskTokenPoll[r];if(w&&w.nonce==m&&w.hash==f&&w.taskID==b)return this._tokenExpired(w),!0;w&&w.nonce==m&&(n=w)}n&&(n.failedCount+=1,3<=n.failedCount&&this._tokenExpired(n));return!1};k.prototype.expireAllToken=function(b){var f=[],m,n;for(m=0;m<this._alarmTaskTokenPoll.length;m++)(n=this._alarmTaskTokenPoll[m])&&n.taskID==b&&f.push(n);if(f&&0<f.length)for(m=0;m<this._alarmTaskTokenPoll.length;m++)n=this._alarmTaskTokenPoll[m],
this._tokenExpired(n);return!1};k.prototype._tokenExpired=function(b){b.timeout&&(clearTimeout(b.timeout),b.timeout=null);b=this._alarmTaskTokenPoll.indexOf(b);-1!=b&&this._alarmTaskTokenPoll.splice(b,1)};k.prototype._nonceExist=function(b){for(var f=0;f<this._alarmTaskTokenPoll.length;f++){var m=this._alarmTaskTokenPoll[f];if(m&&m.nonce==b)return!0}return!1};k.prototype._generateNonce=function(){return require("crypto").randomBytes(10).toString("hex")};k.prototype._hashPin=function(b,f){b=b.substr(5,
4);var m=require("crypto").createHash("sha1");m.update(b+f);return m.digest("hex")};var p=function(b){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTaskManager");this._taskmanager=b;this._alarmTasks=[];this._auth=new k(this)};p.FILE_NAME="alarm_rehau.json";p.prototype.init=function(b){this._logger.log("trace","init rehau alarm task manager");var f=this;this._loadSettings(function(m){m&&f._logger.log("warn","init rehau alarm task manager error:"+m.message);f._setupDefaultAlarmTask();f._initAllAlarmTasks();
b&&b()})};p.prototype.save=function(b){this._saveSettings(b)};p.prototype.challenge=function(b,f){this._getAlarmTask(b)?(b=this._auth.generateToken(b),f&&f(b?null:Error("generate token failed"),{token:b})):f&&f(Error("no such alarm task with id:"+b))};p.prototype.getAlarmInfo=function(b){var f=this._toSettingsJSON();b&&b(null,f)};p.prototype.setAlarmDelay=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?(r.setDelay(f),this._saveSettings(function(w){n&&
n(w,r.toJSON())})):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.selectAssociateTaskAlarm=function(b,f,m,n){var r=this._getAlarmTask(b);if(r){var w=null;if(f&&(w=this._taskmanager.readTaskSync(f),!w)){n&&n(Error("no such task with id:"+f));return}if(r.isActive())n&&n(Error("alarm task is active"));else if(this._auth.authenticate(b,m)){b=r.getAssociateTaskIdPreAlarm();(m=r.getAssociateTaskIdAlarm())&&m!=f&&m!=b&&(b=
this._taskmanager.readTaskSync(m))&&b.setRehauAlarmTask(!1);r.setAssociateTaskIdAlarm(f);w&&(w.setRehauAlarmTask(!0),w.setActive(!1));var A=this;this._saveSettings(function(y){y?n&&n(y):A._taskmanager.save(function(B){n&&n(B,r.toJSON())})})}else f=Error("pin error"),f.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(f)}else n&&n(Error("no such alarm task with id:"+b))};p.prototype.selectAssociateTaskPreAlarm=function(b,f,m,n){var r=this._getAlarmTask(b);if(r){var w=null;if(f&&(w=this._taskmanager.readTaskSync(f),
!w)){n&&n(Error("no such task with id:"+f));return}if(r.isActive())n&&n(Error("alarm task is active"));else if(this._auth.authenticate(b,m)){b=r.getAssociateTaskIdAlarm();(m=r.getAssociateTaskIdPreAlarm())&&m!=f&&m!=b&&(b=this._taskmanager.readTaskSync(m))&&b.setRehauAlarmTask(!1);r.setAssociateTaskIdPreAlarm(f);w&&(w.setRehauAlarmTask(!0),w.setActive(!1));var A=this;this._saveSettings(function(y){y?n&&n(y):A._taskmanager.save(function(B){n&&n(B,r.toJSON())})})}else f=Error("pin error"),f.code=x.hub.taskman.ERROR_CODE.Pin_Error,
n&&n(f)}else n&&n(Error("no such alarm task with id:"+b))};p.prototype.setAlarmActive=function(b,f,m,n){f||this._auth.authenticate(b,m)?this._setAlarmActive(b,f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b))};p.prototype._setAlarmActive=function(b,f,m){for(var n=null,r=0;r<this._alarmTasks.length;r++)if(this._alarmTasks[r])if(this._alarmTasks[r].getID()==b)n=this._alarmTasks[r];else{if(this._alarmTasks[r].isActive()){m&&m(Error("another alarm task with id:"+this._alarmTasks[r].getID()+
" is active"));return}this._alarmTasks[r].isWaitForActive()&&this._alarmTasks[r].cancelDelayActive()}n?f&&n.isActive()?m&&m(null,n.toJSON()):f&&!n.isActive()?n.activate()?(b=Error("rehau window is open"),b.code="200002",m&&m(b)):m&&m(null,n.toJSON()):(n.deactivate(),m&&m(null,n.toJSON())):m&&m(Error("no such alarm task with id:"+b))};p.prototype.setNewPin=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.getPin()==f?n&&
n():(r.setPin(f),this._auth.expireAllToken(b),this._saveSettings(function(w){n&&n(w)})):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.setDoorAlarmDelay=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?(r.setDoorAlarmDelay(f),this._saveSettings(function(w){n&&n(w,r.toJSON())})):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,
n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.addAlarmKey=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.addAlarmKey(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.updateAlarmKey=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.updateAlarmKey(f,
n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.deleteAlarmKey=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.deleteAlarmKey(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.addAlarmDoor=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?
n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.addAlarmDoor(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.updateAlarmDoor=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.updateAlarmDoor(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.deleteAlarmDoor=
function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.deleteAlarmDoor(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.setAlarmConfirmation=function(b,f,m,n){var r=this._getAlarmTask(b);r?r.isActive()?n&&n(Error("alarm task is active")):this._auth.authenticate(b,m)?r.setAlarmConfirmation(f,n):(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,
n&&n(b)):n&&n(Error("no such alarm task with id:"+b))};p.prototype.setAssociateTaskActive=function(b,f,m){var n=this._taskmanager.readTaskSync(b);n?(n.setActive(f),this._taskmanager.save(m)):m&&m(Error("no such task with id:"+b))};p.prototype.executeAssociateTask=function(b,f){var m=this._taskmanager.readTaskSync(b);m?m.trigger(f):f&&f(Error("no such task with id:"+b))};p.prototype.onStatusEvtForTask=function(b,f){this._logger.log("debug","for task:"+f+" receive status event:"+JSON.stringify(b));
if(f=this._getAlarmTask(f))f.onStatusEvt(b)};p.prototype.onWindowSensorAlarmTriggered=function(b){for(var f=0;f<this._alarmTasks.length;f++){var m=this._alarmTasks[f];m&&m.isActive()&&m.triggerWindowSensorAlarm(b)}};p.prototype._getAlarmTask=function(b){for(var f=0;f<this._alarmTasks.length;f++){var m=this._alarmTasks[f];if(m&&m.getID()==b)return m}return null};p.prototype._isAlarmTaskActive=function(b){};p.prototype._setupDefaultAlarmTask=function(){if(0==this._alarmTasks.length){var b=new g(1);
b.setManager(this);this._alarmTasks.push(b)}1==this._alarmTasks.length&&(b=this._alarmTasks[0],b=1==b.getID()?2:1,b=new g(b),b.setManager(this),this._alarmTasks.push(b))};p.prototype._initAllAlarmTasks=function(){for(var b=0;b<this._alarmTasks.length;b++){var f=this._alarmTasks[b];f&&f.init()}};p.prototype._loadSettings=function(b){var f=this,m=this._getFile();fs_extra.ensureFile(m,function(n){n?b&&b(n):f._loadFile(m,function(r,w){r?b&&b(r):(f._fromSettingsJSON(w),b&&b())})})};p.prototype._saveSettings=
function(b){var f=this._getFile(),m=this._toSettingsJSON();this._saveFile(f,m,function(n){b&&b(n)})};p.prototype._fromSettingsJSON=function(b){if(b&&Array.isArray(b))for(var f=0;f<b.length;f++){var m=g.buldTaskFromJSON(b[f]);m&&(m.setManager(this),this._alarmTasks.push(m))}};p.prototype._toSettingsJSON=function(){for(var b=[],f=0;f<this._alarmTasks.length;f++){var m=this._alarmTasks[f];m&&b.push(m.toJSON())}return b};p.prototype._loadFile=function(b,f){fs.readFile(b,"utf8",function(m,n){if(m)f&&f(m);
else if(n)try{var r=JSON.parse(n);f&&f(null,r)}catch(w){f&&f(w)}else f&&f(null,null)})};p.prototype._saveFile=function(b,f,m){fs.writeFile(b,JSON.stringify(f,null,2),function(n){m&&m(n)})};p.prototype._getFile=function(){var b=fileman.fileManager.getUserRootDataPath();return path.resolve(b,p.FILE_NAME)};return p}();
x.hub.taskman.TaskManager=function(){var l=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskManager");this.version=l.TMP_VERSION;this._tasks=[];this._alarmTask=new x.hub.taskman.AlarmTask;this._mode=31;this._lock=!1};l.TMP_VERSION="1.0.0";l.NS_VERSION="2.3.2";l.FILE_NAME="tm.json";l.prototype.init=function(e){this._alarmTask.init();this._load(e)};l.prototype.clear=function(){for(var e=0;e<this._tasks.length;e++)try{this._tasks[e].finalize()}catch(c){}x.hub.taskman._TimerManager.clear();
x.hub.taskman._AstroManager.clear();x.hub.taskman._PeriodicTimerManager.clear();this._tasks=[]};l.prototype.save=function(e){this._writeData(e)};l.prototype.reload=function(e){this.clear();this._load(e)};l.prototype.import=function(e,c){var g=this;this._writeFile(e,function(k){k?c&&c(k):g.reload(c)})};l.prototype._load=function(e){var c=this,g=require("fs-extra"),k=this._getFile();g.ensureFile(k,function(p){p?e&&e(p):c._loadData(function(b,f){b?e&&e(b):(c._tasks=f,c._sort(),c._lock||f.forEach(function(m){try{m.init()}catch(n){console.error(n)}}),
e&&e())})})};l.prototype.lock=function(){this._lock=!0};l.prototype.unlock=function(){this._lock=!1};l.prototype.createTask=function(e,c){if(e){for(var g=1,k=-1,p=0;p<this._tasks.length;p++)if(this._tasks[p].id>g){e.id=g;k=p;break}else g++;-1==k&&(e.id=g,k=this._tasks.length);this._tasks.splice(k,0,e);this._lock||e.init();this._writeData(function(b){b?c&&c(b):c&&c(null,e.toJSON())})}else c&&c(Error("task is null"))};l.prototype.readTask=function(e,c){if(e){for(var g=null,k=0;k<this._tasks.length;k++){var p=
this._tasks[k];if(p.id==e){g=p;break}}g?c&&c(null,g):c&&c(Error("no such task with id:"+e))}else c&&c(Error("task id is null"))};l.prototype.readAllTasks=function(e){e&&e(null,this._tasks)};l.prototype.updateTask=function(e,c,g){for(var k=null,p=-1,b=0;b<this._tasks.length;b++){var f=this._tasks[b];if(f.id==e.id){k=f;p=b;break}}if(k){if(k.isAlarmTask){if(this._alarmTask._active){g&&g(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){e=Error("pin error");e.code=x.hub.taskman.ERROR_CODE.Pin_Error;
g&&g(e);return}}k.isRehauAlarmTask()&&k.isActive()?g&&g(Error("rehau alarm task active")):(k.finalize(),this._tasks.splice(p,1,e),this._lock||e.init(),this._writeData(g))}else g&&g(Error("no such task with id:"+e.id))};l.prototype.deleteTask=function(e,c,g){if(e){for(var k=-1,p=null,b=0;b<this._tasks.length;b++){var f=this._tasks[b];if(f.id==e){k=b;p=f;break}}if(p.isAlarmTask){if(this._alarmTask._active){g&&g(Error("alarm task active"));return}e=this._alarmTask._getAlarmPin();if(!c||c!=e){c=Error("pin error");
c.code=x.hub.taskman.ERROR_CODE.Pin_Error;g&&g(c);return}}p.isRehauAlarmTask()&&p.isActive()?g&&g(Error("rehau alarm task active")):(p.finalize(),-1!=k&&this._tasks.splice(k,1),this._writeData(g))}else g&&g(Error("task id is null"))};l.prototype.setTaskActive=function(e,c,g,k){if(e){for(var p=null,b=0;b<this._tasks.length;b++){var f=this._tasks[b];if(f.id==e){p=f;break}}if(p){if(p.isAlarmTask){if(this._alarmTask._active){k&&k(Error("alarm task active"));return}e=this._alarmTask._getAlarmPin();if(!g||
g!=e){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;k&&k(c);return}}p.isRehauAlarmTask()?k&&k(Error("do not allow to set active state for rehau alarm task")):(p.setActive(c),this._writeData(k))}else k&&k(Error("no such task:"+e))}else k&&k(Error("task id is null"))};l.prototype.doTask=function(e,c,g){if(e){for(var k=null,p=0;p<this._tasks.length;p++){var b=this._tasks[p];if(b.id==e){k=b;break}}if(k.isAlarmTask){if(this._alarmTask._active){g&&g(Error("alarm task active"));return}e=
this._alarmTask._getAlarmPin();if(!c||c!=e){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;g&&g(c);return}}k.trigger(g)}else g&&g(Error("task id is null"))};l.prototype.cancelTask=function(e,c,g){if(e){for(var k=null,p=0;p<this._tasks.length;p++){var b=this._tasks[p];if(b.id==e){k=b;break}}if(k){if(k.isAlarmTask){if(this._alarmTask._active){g&&g(Error("alarm task active"));return}e=this._alarmTask._getAlarmPin();if(!c||c!=e){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;
g&&g(c);return}}k.cancel(g)}else g&&g(Error("no such task"))}else g&&g(Error("task id is null"))};l.prototype.toggleTaskActive=function(e,c,g){if(e){for(var k=null,p=0;p<this._tasks.length;p++){var b=this._tasks[p];if(b.id==e){k=b;break}}if(k){if(k.isAlarmTask&&(e=this._alarmTask._getAlarmPin(),!c||c!=e)){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;g&&g(c);return}k.toggleActive();this._writeData(g)}else g&&g(Error("no such task:"+e))}else g&&g(Error("task id is null"))};l.prototype.isTaskRunning=
function(e,c){if(e){for(var g=null,k=0;k<this._tasks.length;k++){var p=this._tasks[k];if(p.id==e){g=p;break}}g?c&&c(null,g.isRunning()):c&&c(Error("no such task"))}else c&&c(Error("task id is null"))};l.prototype.getCloudDeviceTriggerGateway=function(e){for(var c=null,g=0;g<this._tasks.length;g++){var k=this._tasks[g];if(k&&(c=k.getCloudDeviceTriggerGateway()))break}e&&e(null,c)};l.prototype.readTaskSync=function(e){if(!e)return null;for(var c=null,g=0;g<this._tasks.length;g++){var k=this._tasks[g];
if(k.id==e){c=k;break}}return c};l.prototype.startTaskTrace=function(e,c,g){this.readTask(e,function(k,p){k?g&&g(k):p.startTaskTrace(c,function(b){g&&g(b)})})};l.prototype.stopTaskTrace=function(e,c,g){this.readTask(e,function(k,p){k?g&&g(k):p.stopTaskTrace(c,function(b){g&&g(b)})})};l.prototype.setAlarmActive=function(e,c,g){this._alarmTask.setAlarmActive(e,c,this,g)};l.prototype.setAlarmDelay=function(e,c,g){this._alarmTask.setAlarmDelay(e,c,g)};l.prototype.getAlarmInfo=function(e){this._alarmTask.getAlarmInfo(e)};
l.prototype.selectAlarmTask=function(e,c,g,k){var p=this;this._alarmTask.selectAlarmTask(e,c,g,this._tasks,function(b){b?k&&k(b):p._writeData(k)})};l.prototype._getAlarmPin=function(){return this._alarmTask._getAlarmPin()};l.prototype.setAlarmPin=function(e,c,g){this._alarmTask.setAlarmPin(e,c,g)};l.prototype.onStatusEvt=function(e){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","receive status event:"+JSON.stringify(e));for(var c=0;c<this._tasks.length&&
!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onStatusEvt(e)}};l.prototype.onStatusEvtForTask=function(e,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","for task:"+c+" receive status event:"+JSON.stringify(e));for(var g=0;g<this._tasks.length&&!(2<=g&&0!=this._mode%31);g++){var k=this._tasks[g];if(k.id==c)k.onStatusEvtForTask(e)}}};l.prototype.onIREvt=function(e){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive ir event:"+JSON.stringify(e));for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onIREvt(e)}};l.prototype.onLocationChange=function(e){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onLocationChange(e),x.hub.taskman._AstroManager.onLocationChange(e),x.hub.taskman._PeriodicTimerManager.onLocationChange(e))};l.prototype.onTimeChange=function(e){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onTimeChange(e),
x.hub.taskman._AstroManager.onTimeChange(e),x.hub.taskman._PeriodicTimerManager.onTimeChange(e))};l.prototype.onTimerTick=function(e,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive time tick for task:"+e);for(var g=0;g<this._tasks.length&&!(2<=g&&0!=this._mode%31);g++){var k=this._tasks[g];if(k.id==e)k.onTimerTick(c)}}};l.prototype.onHttpEvt=function(e,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive http event"+JSON.stringify(e));var g=!1,k=0;k=this._tasks.length;0!=this._mode%31&&2<k&&(k=2);for(var p=0;p<this._tasks.length&&!(2<=p&&0!=this._mode%31);p++)this._tasks[p].onHttpEvt(e,function(b,f){f&&(g=!0);k--;0==k&&c&&c(null,g)})}};l.prototype.onActivation=function(e){this.version=e?l.NS_VERSION:l.TMP_VERSION};l.prototype._writeData=function(e){var c=[];this._tasks.forEach(function(g){g&&c.push(g.toJSON())});this._writeFile(c,e)};l.prototype._loadData=function(e){var c=require("fs"),
g=this._getFile();c.readFile(g,"utf8",function(k,p){if(k)e&&e(k);else if(p)try{var b=JSON.parse(p),f=[];Array.isArray(b)&&b.forEach(function(m){(m=x.hub.taskman.Task.parse(m))&&f.push(m)});e&&e(null,f?f:[])}catch(m){e&&e(m)}else e&&e(null,[])})};l.prototype._writeFile=function(e,c){var g=require("fs"),k=this._getFile();g.writeFile(k,JSON.stringify(e,null,2),function(p){c&&c(p)})};l.prototype._getFile=function(){var e=require("x.hub.fileman.js").fileManager,c=require("path");require("fs");e=e.getUserRootDataPath();
return c.resolve(e,l.FILE_NAME)};l.prototype._sort=function(){var e=this._tasks.length-1;do{var c=!1;for(var g=0;g<e;++g)this._tasks[g].id>this._tasks[g+1].id&&(c=this._tasks[g],this._tasks[g]=this._tasks[g+1],this._tasks[g+1]=c,c=!0)}while(c)};return l}();
x.hub.taskman.Handler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Handler");this.taskManager=new x.hub.taskman.TaskManager;this._rehauAlarmTaskManager=new x.hub.taskman.rehau.AlarmTaskManager(this.taskManager);var e=require("x.hub.eventbus.js");e.on("status",this.onStatusEvt.bind(this));e.on("irevt",this.onIREvt.bind(this));e.on("locationchange",this.onLocationChange.bind(this));e.on("timechange",this.onTimeChange.bind(this));e.on("neoserver_activation",
this.onActivation.bind(this))};l.prototype.TaskManager=x.hub.taskman.TaskManager;l.prototype.Task=x.hub.taskman.Task;l.prototype.Cloud=x.hub.taskman.Cloud;l.prototype.Util=x.hub.taskman._Util;l.prototype.init=function(e){this._logger.log("info","init task manager");if(localStorage){"true"==localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(this.taskManager.version=x.hub.taskman.TaskManager.NS_VERSION);var c=localStorage.getItem("x.hub.taskman.CLOUD_SERVER");c&&(x.hub.taskman.Cloud.prototype.URL=c)}var g=
this;this.taskManager.init(function(){g._rehauAlarmTaskManager.init(e)})};l.prototype.getRehauAlarmTaskManager=function(){return this._rehauAlarmTaskManager};l.prototype.lock=function(){this.taskManager.lock()};l.prototype.unlock=function(){this.taskManager.unlock()};l.prototype.doWebRequest=function(e,c,g){var k=function(p){if(p.error){var b=x.hub.taskman.ERROR_CODE.General_Error;p.error.code&&(b=p.error.code);g(JSON.stringify({XC_ERR:{code:b,msg:p.error.message}}))}else g(JSON.stringify({XC_SUC:"undefined"!=
typeof p.data&&null!=p.data?p.data:""}))};switch(e){case "Read":e=c.query.id;"undefined"==typeof e?this.readAllTasks(k):this.readTask(e,k);break;case "Create":this.createTask(c.query.data,k);break;case "Update":this.updateTask(c.query.data,c.query.pin,k);break;case "Delete":this.deleteTask(c.query.id,c.query.pin,k);break;case "Do":this.doTask(c.query.id,c.query.pin,k);break;case "Cancel":this.cancelTask(c.query.id,c.query.pin,k);break;case "isRunning":this.isTaskRunning(c.query.id,k);break;case "SetTaskActive":this.setTaskActive(c.query.id,
c.query.active,c.query.pin,k);break;case "ToggleTaskActive":this.toggleTaskActive(c.query.id,c.query.pin,k);break;case "SetAlarmActive":this.setAlarmActive(c.query.active,c.query.pin,k);break;case "SetAlarmDelay":this.setAlarmDelay(c.query.delay,c.query.pin,k);break;case "GetAlarmInfo":this.getAlarmInfo(k);break;case "SelectAlarmTask":this.selectAlarmTask(c.query.id,c.query.isAlarmTask,c.query.pin,k);break;case "SetAlarmPin":this.setAlarmPin(c.query.newPin,c.query.pin,k);break;case "GetCloudServer":k({data:x.hub.taskman.Cloud.prototype.URL});
break;case "SetCloudServer":if(!c.query.url){k({error:Error("url invalid")});break}"http"!=c.query.url.substr(0,4)&&(c.query.url="https://"+c.query.url);localStorage.setItem("x.hub.taskman.CLOUD_SERVER",c.query.url);x.hub.taskman.Cloud.prototype.URL=c.query.url;k({data:"success"});break;case "GetCloudDeviceTriggerGateway":this.getCloudDeviceTriggerGateway(k);break;default:e&&0==e.indexOf("Rehau")&&this.doRehauWebRequest(e,c,g)}};l.prototype.doRehauWebRequest=function(e,c,g){var k=function(p){if(p.error){var b=
x.hub.taskman.ERROR_CODE.General_Error;p.error.code&&(b=p.error.code);g(JSON.stringify({XC_ERR:{code:b,msg:p.error.message}}))}else g(JSON.stringify({XC_SUC:"undefined"!=typeof p.data&&null!=p.data?p.data:""}))};switch(e){case "RehauPinChallenge":this._rehauAlarmTaskManager.challenge(c.query.id,function(p,b){k({error:p,data:b})});break;case "RehauGetAlarmInfo":this._rehauAlarmTaskManager.getAlarmInfo(function(p,b){k({error:p,data:b})});break;case "RehauSetAlarmDelay":this._rehauAlarmTaskManager.setAlarmDelay(c.query.id,
c.query.delay,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSetDoorAlarmDelay":this._rehauAlarmTaskManager.setDoorAlarmDelay(c.query.id,c.query.delay,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSetAlarmActive":this._rehauAlarmTaskManager.setAlarmActive(c.query.id,c.query.active,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSelectAssociateTaskAlarm":this._rehauAlarmTaskManager.selectAssociateTaskAlarm(c.query.id,c.query.associateTaskId,
c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSelectAssociateTaskPreAlarm":this._rehauAlarmTaskManager.selectAssociateTaskPreAlarm(c.query.id,c.query.associateTaskId,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSetNewPin":this._rehauAlarmTaskManager.setNewPin(c.query.id,c.query.pin,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauAddAlarmKey":this._rehauAlarmTaskManager.addAlarmKey(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,
data:b})});break;case "RehauUpdateAlarmKey":this._rehauAlarmTaskManager.updateAlarmKey(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauDeleteAlarmKey":this._rehauAlarmTaskManager.deleteAlarmKey(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauAddAlarmDoor":this._rehauAlarmTaskManager.addAlarmDoor(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauUpdateAlarmDoor":this._rehauAlarmTaskManager.updateAlarmDoor(c.query.id,
c.query.data,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauDeleteAlarmDoor":this._rehauAlarmTaskManager.deleteAlarmDoor(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,data:b})});break;case "RehauSetAlarmConfirmation":this._rehauAlarmTaskManager.setAlarmConfirmation(c.query.id,c.query.data,c.query.token,function(p,b){k({error:p,data:b})})}};l.prototype.readAllTasks=function(e){this.taskManager.readAllTasks(function(c,g){if(c)e&&e({error:c});else{var k=[];g.forEach(function(p){k.push(p.toJSON())});
e&&e({data:k})}})};l.prototype.createTask=function(e,c){e?(e.id||(e.id=-1),(e=x.hub.taskman.Task.parse(e))?this.taskManager.createTask(e,function(g,k){c&&c({error:g,data:k})}):c&&c({error:Error("task json invalid")})):c&&c({error:Error("task json is null")})};l.prototype.readTask=function(e,c){this.taskManager.readTask(e,function(g,k){c&&c({error:g,data:k?k.toJSON():null})})};l.prototype.updateTask=function(e,c,g){e?(e=x.hub.taskman.Task.parse(e))?this.taskManager.updateTask(e,c,function(k){g&&g({error:k})}):
g&&g({error:Error("task json invalid")}):g&&g({error:Error("task json is null")})};l.prototype.deleteTask=function(e,c,g){this.taskManager.deleteTask(e,c,function(k){g&&g({error:k})})};l.prototype.setTaskActive=function(e,c,g,k){this.taskManager.setTaskActive(e,c,g,function(p){k&&k({error:p})})};l.prototype.doTask=function(e,c,g){this.taskManager.doTask(e,c,function(k){g&&g({error:k})})};l.prototype.cancelTask=function(e,c,g){this.taskManager.cancelTask(e,c,function(k){g&&g({error:k})})};l.prototype.toggleTaskActive=
function(e,c,g){this.taskManager.toggleTaskActive(e,c,function(k){g&&g({error:k})})};l.prototype.isTaskRunning=function(e,c){this.taskManager.isTaskRunning(e,function(g,k){c&&c({error:g,data:k})})};l.prototype.getCloudDeviceTriggerGateway=function(e){this.taskManager.getCloudDeviceTriggerGateway(function(c,g){c?e&&e({error:c}):(g||(g={}),e&&e({data:g}))})};l.prototype.importTasks=function(e,c){this.taskManager.import(e,function(g){c&&c({error:g})})};l.prototype.startTaskTrace=function(e,c,g){this.taskManager.startTaskTrace(e,
c,function(k){g&&g({error:k})})};l.prototype.stopTaskTrace=function(e,c,g){this.taskManager.stopTaskTrace(e,c,function(k){g&&g({error:k})})};l.prototype.setAlarmActive=function(e,c,g){this.taskManager.setAlarmActive(e,c,function(k){g&&g({error:k})})};l.prototype.setAlarmDelay=function(e,c,g){this.taskManager.setAlarmDelay(e,c,function(k){g&&g({error:k})})};l.prototype.getAlarmInfo=function(e){this.taskManager.getAlarmInfo(function(c,g){e&&e({error:c,data:g})})};l.prototype.selectAlarmTask=function(e,
c,g,k){this.taskManager.selectAlarmTask(e,c,g,function(p){k&&k({error:p})})};l.prototype.setAlarmPin=function(e,c,g){this.taskManager.setAlarmPin(e,c,function(k){g&&g({error:k})})};l.prototype._getAlarmPin=function(){return this.taskManager._getAlarmPin()};l.prototype.onStatusEvt=function(e,c){c&&"taskman"==c.src&&c.taskID?(this._logger.log("trace","receive for task: "+c.taskID+" status event:"+JSON.stringify(e)),this.taskManager.onStatusEvtForTask(e,c.taskID)):c&&"rehau:alarmTask"==c.src&&c.alarmTaskID?
(this._logger.log("trace","receive for rehau alarm task: "+c.alarmTaskID+" status event:"+JSON.stringify(e)),this._rehauAlarmTaskManager.onStatusEvtForTask(e,c.alarmTaskID)):(this._logger.log("trace","receive status event:"+JSON.stringify(e)),this.taskManager.onStatusEvt(e))};l.prototype.onIREvt=function(e){this._logger.log("trace","receive ir event:"+JSON.stringify(e));this.taskManager.onIREvt(e)};l.prototype.onLocationChange=function(e){this._logger.log("trace","receive location change event:"+
JSON.stringify(e));this.taskManager.onLocationChange(e)};l.prototype.onTimeChange=function(e){this._logger.log("trace","receive time change event:"+JSON.stringify(e));this.taskManager.onTimeChange(e)};l.prototype.onActivation=function(e){this._logger.log("trace","receive activation change event:"+e);var c=!1;"true"==e&&(c=!0);this.taskManager.onActivation(c)};return l}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.taskman.Handler);
