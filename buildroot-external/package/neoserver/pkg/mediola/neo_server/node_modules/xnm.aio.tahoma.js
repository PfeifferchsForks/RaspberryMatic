var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tahoma=xnm.aio.tahoma||{};
xnm.aio.tahoma.Box=function(){var f={_cache:{},getCookie:function(c,a){return c||a?this._cache[(c?c:"")+":"+(a?a:"")]:null},setCookie:function(c,a,b){if(!c&&!a)return null;this._cache[(c?c:"")+":"+(a?a:"")]=b}},d=function(c,a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.tahoma.Box");this.username=String(c).toLowerCase();this.password=a};d.prototype.executeCommandCreator=function(c,a,b){this.executeCommand(c,a,function(e){b&&b(e)})};d.prototype.getStatesCreator=function(c,a,b){if(a)if(0==
a.length)b&&b(null,[]);else{for(var e=[],h=0;h<a.length;h++)if(a[h]&&a[h].device&&a[h].device.address&&a[h].status&&a[h].status.value){for(var k=a[h].device.address,l=!1,g=0;g<e.length;g++)if(e[g].address==k){l=!0;var n=e[g].states;-1==n.indexOf(a[h].status.value)&&n.push(a[h].status.value)}l||e.push({address:k,states:[a[h].status.value]})}this.getStates(c,e,function(m,p){var q=[];if(!m&&p)for(m=0;m<a.length;m++)if(a[m]&&a[m].id){var r="?";if(a[m].device&&a[m].device.address&&a[m].status&&a[m].status.value)for(var t=
0;t<p.length;t++)p[t].address==a[m].device.address&&(r=p[t].states[a[m].status.value]);r||(r="?");q.push({id:a[m].id,status:r})}b&&b(null,q)})}else b&&b(Error("deviceList is null"))};d.prototype.executeCommand=function(c,a,b){if(c&&c.address)if(a&&a.value){var e={actions:[]},h={deviceURL:c.address,commands:[]};e.actions.push(h);switch(a.value){case "on":case "off":case "close":case "down":case "my":case "open":case "reset":case "stop":case "up":h.commands.push({name:a.value});break;case "setOnOff":if(!a.ext||
"on"!=a.ext&&"off"!=a.ext){b&&b(Error("command ext invalid"));return}h.commands.push({name:a.value,parameters:[a.ext]});break;case "onWithTimer":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));return}var k=parseInt(a.ext);5>k&&(k=5);14400<k&&(k=14400);h.commands.push({name:a.value,parameters:[k]});break;case "setIntensity":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));return}k=parseInt(a.ext);0>k&&(k=0);100<k&&(k=100);h.commands.push({name:a.value,
parameters:[k]});break;default:b&&b(Error("command unknown"));return}var l=this;this.getExecutionID(c.address,function(g,n){g?b&&b(g):n?"stop"==a.value||"my"==a.value?l._cancelExecution(n,b):b&&b(Error("device running")):l._apply(e,b)})}else b&&b(Error("command invaild"));else b&&b(Error("device invaild"))};d.prototype.getStates=function(c,a,b){if(a&&0!=a.length){c=[];for(var e=0;e<a.length;e++)if(a[e]&&a[e].address&&a[e].states&&0<a[e].states.length){for(var h={deviceURL:a[e].address,states:[]},
k=0;k<a[e].states.length;k++)h.states.push({name:a[e].states[k]});c.push(h)}this._getStates(c,function(l,g){if(l)b&&b(l);else if(g&&g.devices){l=[];for(var n=0;n<g.devices.length;n++){var m=g.devices[n];if(m&&m.deviceURL&&m.states&&0<m.states.length){for(var p={address:m.deviceURL,states:{}},q=0;q<m.states.length;q++)p.states[m.states[q].name]=m.states[q].value;l.push(p)}}b&&b(null,l)}else b&&b(Error("get states return invalid response"))})}else b&&b(null,[])};d.prototype.listDevices=function(c){this._getSetup(function(a,
b){if(a)c&&c(a);else if(b&&b.setup){a={places:{},devices:[]};a.places=b.setup.rootPlace;b=b.setup.devices;for(var e=0;e<b.length;e++){var h=b[e];a.devices.push({sys:"tahoma",name:h.label,address:h.deviceURL,placeOID:h.placeOID,type:h.uiClass,definition:h.definition})}c&&c(null,a)}else c&&c(Error("get setup return format invalid"))})};d.prototype.getExecutionID=function(c,a){this._getCurrentExecutions(function(b,e){if(b)a&&a(b);else if(e&&e.executions){b=!1;for(var h=null,k=0;k<e.executions.length;k++){var l=
e.executions[k];if(l&&l.actionGroup&&l.actionGroup.actions){for(var g=l.actionGroup.actions,n=0;n<g.length;n++){var m=g[n];if(m&&m.deviceURL==c){b=!0;break}}if(b){h=l.id;break}}}a&&a(null,h)}else a&&a(null,null)})};d.prototype._cancelExecution=function(c,a){this._doExecRequest("DELETE","/current/setup/"+c,null,function(b){a&&a(b)})};d.prototype._getCurrentExecutions=function(c){this._doJsonRequest("/getCurrentExecutions",null,function(a,b){c&&c(a,b)})};d.prototype._apply=function(c,a){this._doJsonRequest("/apply",
JSON.stringify(c),function(b,e){a&&a(b,e)})};d.prototype._getStates=function(c,a){this._doJsonRequest("/getStates",JSON.stringify(c),function(b,e){a&&a(b,e)})};d.prototype._getSetup=function(c){this._doJsonRequest("/getSetup",null,function(a,b){c&&c(a,b)})};d.prototype._login=function(c){var a="userId="+encodeURIComponent(this.username)+"&userPassword="+encodeURIComponent(this.password),b=this;this._logger.log("debug","do login request with data:"+a);this._doRequest("POST","/externalAPI/json/login",
{"Content-Type":"application/x-www-form-urlencoded"},a,function(e,h,k){if(e)b._logger.log("warn","login failed with error:"+e.message),c&&c(e);else if(k&&200==k.statusCode)try{var l=JSON.parse(h);if(l.success){if(k.headers&&k.headers["set-cookie"]){var g=k.headers["set-cookie"];g.constructor===Array&&(g=g.join(";"));b._logger.log("debug","login success with cookie:"+g);f.setCookie(b.username,b.password,g)}c&&c(null,l)}else b._logger.log("warn","login failed with success not true:"+h),c&&c(Error("login fail"),
l)}catch(n){b._logger.log("warn","login error with invalid json response:"+h),c&&c(Error("login error with invalid json response"))}else b._logger.log("warn","login error with status code:"+(k?k.statusCode:-1)+" data:"+h),c&&c(Error("login error with status code:"+(k?k.statusCode:-1)))})};d.prototype._doJsonRequest=function(c,a,b){var e=this;this._logger.log("debug","do json request "+c+" data:"+JSON.stringify(a));this._doRequest("POST","/externalAPI/json"+c,{"Content-Type":"application/json"},a,
function(h,k,l){if(h)b&&b(h);else if(l&&401==l.statusCode)e._logger.log("warn","do json request return 401, try to login again"),e._login(function(n){n?b&&b(n):e._doJsonRequest(c,a,b)});else if(e._logger.log("debug","do json request return status code "+(l?l.statusCode:-1)),h=!l||200!=l.statusCode&&204!=l.statusCode?Error("http error with status code "+(l?l.statusCode:-1)):null)e._logger.log("warn","do json request return "+l.statusCode+" data:"+k),b&&b(h,k);else try{var g=JSON.parse(k);b&&b(null,
g)}catch(n){e._logger.log("warn","do json request return invalid json: "+k),b&&b(n)}})};d.prototype._doExecRequest=function(c,a,b,e){var h=this;this._logger.log("debug","do exec request "+a+" data:"+JSON.stringify(b));this._doRequest(c,"/enduserAPI/exec"+a,null,b,function(k,l,g){k?e&&e(k):g&&401==g.statusCode?(h._logger.log("warn","do exec request return 401, try to login again"),h._login(function(n){n?e&&e(n):h._doExecRequest(c,a,b,e)})):(h._logger.log("debug","do exec request return status code "+
(g?g.statusCode:-1)),(k=!g||200!=g.statusCode&&204!=g.statusCode?Error("http error with status code "+(g?g.statusCode:-1)):null)?(h._logger.log("warn","do exec request return "+g.statusCode+" data:"+l),e&&e(k,l)):e&&e(null,l))})};d.prototype._doRequest=function(c,a,b,e,h){c={host:"www.tahomalink.com",port:443,path:"/enduser-mobile-web"+a,method:c,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(b)for(var k in b)b.hasOwnProperty(k)&&(c.headers[k]=b[k]);e&&(c.headers["Content-Length"]=
e.length);(b=f.getCookie(this.username,this.password))&&(c.headers.Cookie=b);b=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");-1!=c.path.indexOf("/externalAPI/json/login")?this._logger.log("trace","do request: /externalAPI/json/login with username & password"):this._logger.log("trace","do request:"+JSON.stringify(c));var l=this,g=h,n=b.request(c,function(m){m.setEncoding("utf-8");var p="";m.on("data",function(q){p+=q});m.on("end",
function(){l._logger.log("trace","receive code:"+m.statusCode+" headers:"+JSON.stringify(m.headers)+" response:"+p);g&&(g(null,p,m),g=null)})});if(n.on)n.on("error",function(m){l._logger.log("trace","do request error:"+m.message);g&&(g(m),g=null)});n.setTimeout&&n.setTimeout(2E3,function(){l._logger.log("trace","do request timeout");n.abort();g&&(g(Error("timeout")),g=null)});n.setAllowRedirect&&n.setAllowRedirect(!1);e&&(this._logger.log("trace","do request send body:"+e),n.write(e));n.end()};d.prototype.toJSON=
function(){return{sys:"tahoma",username:this.username,password:this.password}};d.prototype.equalsTo=function(c){return c&&c instanceof d?this.username==c.username&&this.password==c.password:!1};return d}();
xnm.aio.tahoma.DM=function(){var f=function(d,c){this.code=d;this.message=c;this.stack=Error().stack};f.prototype=Error();f.prototype.name="TahomaDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"tahoma",getGatewayType:function(){return[{sys:this.SYS,name:"TaHoma Box"}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"Light",name:"Light"},{sys:this.SYS,type:"OnOff",name:"Switch"},{sys:this.SYS,type:"RollerShutter",
name:"Blind"}]},createGateway:function(d,c,a){c=f.ERROR_CODE;d?d.username?d.password?a(null,d):a(new f(c.INVALID,"password is invalid")):a(new f(c.INVALID,"username is invalid")):a(new f(c.INVALID,"info is invalid"))},updateGateway:function(d,c,a,b){d=f.ERROR_CODE;c?c.username?c.password?b(null,c):b(new f(d.INVALID,"password is invalid")):b(new f(d.INVALID,"username is invalid")):b(new f(d.INVALID,"update is invalid"))},deleteGateway:function(d,c,a){a()},createDevice:function(d,c,a){var b=f.ERROR_CODE;
if(d)if(d.gateway)if(d.address)if(d.type)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var e;for(e=0;e<c.length;e++)if(c[e].index===d.gateway){var h=c[e];break}h?a(null,d):a(new f(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else a(new f(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else a(new f(b.INVALID,"type is invalid"));else a(new f(b.INVALID,"address is invalid"));else a(new f(b.INVALID,"gateway is invalid"));else a(new f(b.INVALID,"info is invalid"))},
updateDevice:function(d,c,a){var b=f.ERROR_CODE;if(d)if(d.gateway)if(d.address)if(d.type)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var e;for(e=0;e<c.length;e++)if(c[e].index===d.gateway){var h=c[e];break}h?a(null,d):a(new f(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else a(new f(b.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else a(new f(b.INVALID,"type is invalid"));else a(new f(b.INVALID,"address is invalid"));else a(new f(b.INVALID,
"gateway is invalid"));else a(new f(b.INVALID,"info is invalid"))},deleteDevice:function(d,c,a){a()},applyUIFilter:function(d,c){var a=this,b=function(g,n){if("*"==g)return!0;for(var m=!1,p=0;p<g.length;p++)if(g[p]==n){m=!0;break}return m},e=function(g,n,m){var p=[];switch(m.catagory){case "command":g.command&&g.command.forEach(function(q){b(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});break;case "status":g.status&&g.status.forEach(function(q){b(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),
p.push(q))})}return p},h=function(g,n){var m=[],p=a.getCommandStatusMap(g);p&&(g=e(p,g,n),m=m.concat(g));return m};if(!d||null==d.type||"undefined"==typeof d.type)return null;var k=JSON.parse(JSON.stringify(d)),l=null;switch(c.catagory){case "command":l=h(d,c);k.command=l;break;case "status":l=h(d,c);k.status=l;break;default:return null}return l&&0!=l.length?k:null},getCommandStatusMap:function(d){if(!d||!d.definition)return null;var c={command:[],status:[]},a=d.definition.commands;a&&a.forEach(function(b){if(b)switch(b.commandName){case "on":c.command.push({type:"enum",
name:"on",ref:{value:"on"}});break;case "off":c.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setOnOff":c.command.push({type:"enum",name:"set on/off",ref:{value:"setOnOff",ext:"%e",extMeta:["on","off"]}});break;case "onWithTimer":c.command.push({type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",extMeta:"5-14400"}});break;case "close":c.command.push({type:"enum",name:"close",ref:{value:"close"}});break;case "down":c.command.push({type:"enum",name:"down",ref:{value:"down"}});
break;case "my":c.command.push({type:"enum",name:"my",ref:{value:"my"}});break;case "open":c.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "reset":c.command.push({type:"enum",name:"reset",ref:{value:"reset"}});break;case "stop":c.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "up":c.command.push({type:"enum",name:"up",ref:{value:"up"}});break;case "setIntensity":c.command.push({type:"int",name:"dim to",ref:{value:"setIntensity",value_t:"dimTo",ext:"%d"}})}});
(d=d.definition.states)&&d.forEach(function(b){if(b)switch(b.qualifiedName){case "core:OnOffState":c.status.push({type:"enum",name:"on/off state",ref:{value:"core:OnOffState",options:["on","off"]}});break;case "core:LightIntensityState":c.status.push({type:"int",name:"dimmer level",ref:{value:"core:LightIntensityState",ext:"%d"}})}});return c}}}();xnm.aio.tahoma.Handler=function(){this.detectedHomebases={}};xnm.aio.tahoma.Handler.prototype.Box=xnm.aio.tahoma.Box;
xnm.aio.tahoma.Handler.prototype.devicemanager=xnm.aio.tahoma.DM;xnm.aio.tahoma.Handler.prototype.registModule=function(f){f.register(this.devicemanager.SYS,"tahoma")};xnm.aio.tahoma.Handler.prototype.resolveGateway=function(f){return f&&f.username?new this.Box(f.username,f.password):null};xnm.aio.tahoma.Handler.prototype.getDeviceCommands=function(f,d){f=(f=this.devicemanager.applyUIFilter(f,{catagory:"command",elems:"*"}))?f.command:[];d&&d(null,f)};
xnm.aio.tahoma.Handler.prototype.getDeviceStatus=function(f,d){f=(f=this.devicemanager.applyUIFilter(f,{catagory:"status",elems:"*"}))?f.status:[];d&&d(null,f)};xnm.aio.tahoma.Handler.prototype.doCommand=function(f,d,c,a){(f=this.resolveGateway(f))?f.executeCommandCreator(d,c,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};
xnm.aio.tahoma.Handler.prototype.doStatus=function(f,d,c,a,b){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:f,device:c,status:a}],function(e,h){e?b&&b(e):b&&b(null,h[0])}):b&&b(Error("gateway json format invalid"))};xnm.aio.tahoma.Handler.prototype.getDeviceList=function(f,d){(f=this.resolveGateway(f))?f.listDevices(function(c,a){d&&d(c,a)}):d&&d(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tahoma.Handler);
