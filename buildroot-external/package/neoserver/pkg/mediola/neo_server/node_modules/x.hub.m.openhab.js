var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,e){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,e):$jscomp.polyfillUnisolated(a,b,c,e))};$jscomp.polyfillUnisolated=function(a,b,c,e){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];if(!(d in c))return;c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,e){var d=a.split(".");a=1===d.length;e=d[0];e=!a&&e in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<d.length-1;f++){var g=d[f];if(!(g in e))return;e=e[g]}d=d[d.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?e[d]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(d):$jscomp.POLYFILL_PREFIX+c+"$"+d),$jscomp.defineProperty(e,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:b})))};
$jscomp.getConstructImplementation=function(){function a(){function c(){}new c;Reflect.construct(c,[],function(){});return new c instanceof c}if($jscomp.TRUST_ES6_POLYFILLS&&"undefined"!=typeof Reflect&&Reflect.construct){if(a())return Reflect.construct;var b=Reflect.construct;return function(c,e,d){c=b(c,e);d&&Reflect.setPrototypeOf(c,d.prototype);return c}}return function(c,e,d){void 0===d&&(d=c);d=$jscomp.objectCreate(d.prototype||Object.prototype);return Function.prototype.apply.call(c,d,e)||
d}};$jscomp.construct={valueOf:$jscomp.getConstructImplementation}.valueOf();$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var e=Object.getOwnPropertyDescriptor(b,c);e&&Object.defineProperty(a,c,e)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.polyfill("Reflect",function(a){return a?a:{}},"es6","es3");$jscomp.polyfill("Reflect.construct",function(a){return $jscomp.construct},"es6","es3");
$jscomp.polyfill("Reflect.setPrototypeOf",function(a){if(a)return a;if($jscomp.setPrototypeOf){var b=$jscomp.setPrototypeOf;return function(c,e){try{return b(c,e),!0}catch(d){return!1}}}return null},"es6","es5");var EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.openhab=x.hub.m.openhab||{};x.hub.m.openhab.MODULE=require("xnm.aio.openhab.js");
var __$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.openhab.Monitor");this._running=!1;this._server=a;this._devices={};this._reconnectTO=null;this._reconnectTimeout=5E3};__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._server.ip);this._running||(this._running=!0,this._listenToEventSource());a&&a()};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype.addStateDevice=function(a,b){a&&a.address&&a.item&&a.item.name&&(this._devices[a.item.name]=a);b&&b()};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype._listenToEventSource=function(){this._logger.log("debug","connect to openhab server "+this._server.ip+":"+this._server.port);var a=this;this._startHttpConnection(function(b){a._logger.log("debug","disconnectd from openhab server "+a._server.ip+":"+a._server.port+(b?" with error:"+b.message:""));a._logger.log("debug","reconnect after "+a._reconnectTimeout+" seconds");a._reconnectTO=setTimeout(function(){a._listenToEventSource()},
a._reconnectTimeout)})};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype._startHttpConnection=function(a){var b=this,c=!1,e=require("http").request({host:this._server.ip,port:this._server.port,path:"/rest/events",method:"get"},function(d){d.setEncoding("utf-8");c=!0;b._logger.log("trace","server response with status code:"+d.statusCode);if(200!=d.statusCode)d=Error("http error:"+d.statusCode),a&&(a(d),a=null);else{var f="";d.on("data",function(g){f+=g;if(0<=f.indexOf("\n\n")){g=f.split("\n\n");f="";for(var h=
0;h<g.length;h++){var k=g[h].trim().split("\n");k[1]&&"data:"==k[1].substr(0,5)&&b._onMessage(k[1].substr(6).trim())}}else 2E4<f.length&&(b._logger.log("warn","incoming message string has become too long ("+f.length+"). discarding message."),f="")});d.on("end",function(){b._logger.log("trace","http connection closed")});d.on("close",function(){b._logger.log("trace","http connection closed");a&&(a(),a=null)})}});e.setTimeout(2E3,function(){c||(e.abort(),a&&(a(Error("connection timeout")),a=null))});
e.on("error",function(d){a&&(a(d),a=null)});e.end()};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype._onMessage=function(a){try{this._logger.log("trace","receive message: "+a);var b=JSON.parse(a);if(b&&b.type&&b.topic&&b.payload&&"ItemStateChangedEvent"==b.type){var c=b.topic.split("/")[2];if(c&&this._devices[c]){var e=JSON.parse(b.payload);if(e){var d=this._devices[c],f={state:e.oldValue},g={state:e.value},h;for(h in g)this._produceEvent(d,h,f[h],g[h])}}}}catch(k){this._logger.log("error",k)}};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0.prototype._produceEvent=function(a,b,c,e){c!=e&&(this._logger.log("trace","receive new status:"+JSON.stringify({address:a.address,key:b,value:e})),require("x.hub.eventbus.js").emit("status",{module:"openhab",device:a,gateway:a.gateway,data:{key:b,value:e,oldvalue:c,changed:!0}}))};x.hub.m.openhab.Monitor=__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var0;
var __$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1=function(){var a=EventEmitter.call(this)||this;a._monitors={};return a};$jscomp.inherits(__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1,EventEmitter);__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.init=function(a){a&&a()};__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.getSystems=function(){return["openhab"]};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,e){c?b&&b({error:c}):e.addStateDevice(a,function(d){b&&b({error:d})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.getState=function(a,b,c){a?a.gateway?x.hub.m.openhab.MODULE.doStatus("xhub",a.gateway,a,{value:b},function(e,d){e?c&&c({error:e}):d?c&&c({data:{value:d.status}}):c&&c({error:Error("do status failed")})}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.executeCommand=function(a,b,c){x.hub.m.openhab.MODULE.doCommand(a.gateway,a,b,c)};__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.address==a.device.address:!1};
__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;this._monitors[c]?b&&b(null,this._monitors[c]):(a=x.hub.m.openhab.MODULE.resolveGateway(a))?(a=new x.hub.m.openhab.Monitor(a),this._monitors[c]=a,a.start(),b&&b(null,a)):b&&b(Error("gateway format invalid"))}else b&&b(Error("gateway, format invalid"))};x.hub.m.openhab.Handler=__$__$xhub$lib$node_modules$x_hub_m_openhab$classdecl$var1;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.openhab.Handler);
