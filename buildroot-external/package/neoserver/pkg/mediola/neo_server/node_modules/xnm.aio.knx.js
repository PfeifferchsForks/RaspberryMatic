var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.knx=xnm.aio.knx||{};
xnm.aio.knx.KNXGateway=function(){var m=function(a){a=a.split(".");return(parseInt(a[0])<<24)+(parseInt(a[1])<<16)+(parseInt(a[2])<<8)+parseInt(a[3])&4294967295},r=function(a){return(a>>24&255)+"."+(a>>16&255)+"."+(a>>8&255)+"."+(a&255)},x=function(){var a=function(c){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer");this._stateBuffer={};this._stateReqTime={};this._knx=c};a.prototype.setState=function(c,b){"undefined"!=typeof c&&null!=c&&(this._stateBuffer[c]||
(this._stateBuffer[c]={}),this._stateBuffer[c].value=b,this._stateBuffer[c].timestamp=new Date)};a.prototype.getState=function(c){return"undefined"!=typeof c&&null!=c?(c=this._stateBuffer[c])?c.value:null:null};a.prototype.setStateReqTime=function(c,b){this._stateReqTime[c]=b};a.prototype.getStateReqTime=function(c){return this._stateReqTime[c]};return a}(),l=function(a,c,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+a+")");this.ip=a;this.localIp=c;this.uuid=b;this._stateBuffer=new x;
this._stateMachine={state:l._FSM.IDLE};this._eventEmitter=new EventEmitter;this._dataLink=null;this._dataLinkRetryCount=0;this._dataLinkTimer=null};l.STATES_REQ_EXPIRED=18E4;l.MAX_DL_RETRY_COUNT=3;l._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4};l._ipv4ToLong=m;l._longToIpv4=r;l._adr2long=function(a){a=a.split("/");var c=0;switch(a.length){case 3:c+=parseInt(a[0])<<11;c+=parseInt(a[1])<<8;c+=parseInt(a[2]);break;case 2:c+=parseInt(a[0])<<11;c+=parseInt(a[1]);break;case 1:c+=parseInt(a[0])}return c};
l.prototype={getStateBuffer:function(){return this._stateBuffer},on:function(a,c){this._eventEmitter.on(a,c)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(a,c){this._eventEmitter.removeListener(a,c)},startMonitor:function(a){if(a)this.on("open",a);this._fsmStartMonitor()},stopMonitor:function(a){if(a)this.on("close",a);this._fsmStopMonitor()},_fsmStartMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._stateMachine.state=l._FSM.START_MONITOR;
this._startDataLink();break;case l._FSM.MONITORING:this._eventEmitter.emit("open");break;case l._FSM.STOP_MONITOR:this._logger.log("warn","can not start the monitor again while stopping it")}},_fsmStopMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._onClose();break;case l._FSM.START_MONITOR:case l._FSM.MONITORING:this._stateMachine.state=l._FSM.STOP_MONITOR,this._stopDataLink()}},_fsmDatalinkOpen:function(){switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._stateMachine.state=
l._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0}},_fsmDatalinkClosed:function(a,c){a?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped");switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink(c)):(this._stateMachine.state=
l._FSM.IDLE,c&&c.forEach(function(b){b&&b.callback&&b.callback(Error("monitor closed due to error"))}),this._onClose(!0));break;case l._FSM.MONITORING:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink(c)):(this._onError(Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=l._FSM.IDLE,c&&c.forEach(function(b){b&&
b.callback&&b.callback(Error("monitor closed due to error"))}),this._onClose(!0));break;case l._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,this._stateMachine.state=l._FSM.IDLE,c&&c.forEach(function(b){b&&b.callback&&b.callback(Error("monitor closed due to error"))}),this._onClose(!1)}},_fsmDataLinkMessage:function(a,c){switch(this._stateMachine.state){case l._FSM.MONITORING:c.getAPCI(),this._stateBuffer.setState(a,c.getData()),this._eventEmitter.emit("message",this.uuid,
a,c)}},_fsmDatalinkError:function(a){this._onError(a)},_onOpen:function(){0==this._dataLinkRetryCount&&this._eventEmitter.emit("open")},_onError:function(a){this._eventEmitter.emit("error",a)},_onClose:function(a){this._eventEmitter.emit("close",a)},_sendCommand:function(a,c,b){this._dataLink?this._sendCommandWithDL(this._dataLink,a,c,b):b&&b(Error("knx gateway not connected"))},_getState:function(a,c){this._dataLink?this._getStateWithDL(this._dataLink,a,c):c&&c(Error("knx gateway not connected"))},
_sendCommandWithDL:function(a,c,b,e){var f=l._adr2long(c),d=new l.APDU(null,2,b),g=this;a.send(f,d,function(k){k||g._stateBuffer.setState(f,d.getData());e&&"function"===typeof e&&e(k)})},_getStateWithDL:function(a,c,b){c=l._adr2long(c);var e=new l.APDU(null,0,new Buffer([0]));a.send(c,e,b)},_startDataLink:function(a){var c=this;this._dataLink=new l._DataLink(this.ip,this.localIp);this._dataLink.on("connect",function(){c._fsmDatalinkOpen()});this._dataLink.on("close",function(b,e){c._fsmDatalinkClosed(b,
e)});this._dataLink.on("error",function(b){c._logger.log("warn","monitor tunnel error:"+b.message);c._fsmDatalinkError(b)});this._dataLink.on("message",function(b,e){c._fsmDataLinkMessage(b,e)});this._dataLink.connect(a)},_stopDataLink:function(){this._dataLink&&this._dataLink.close()}};var w=function(){var a=function(c,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+c+")");var e=this;this._tunnel=new z(c,null,b,null);this._tunnel.on("connect",function(){e._onTunnelConnect()});
this._tunnel.on("end",function(){e._onTunnelEnd()});this._tunnel.on("close",function(f,d){e._onTunnelClose(f,d)});this._tunnel.on("message",function(f){e._onTunnelMessage(f)});this._tunnel.on("error",function(f){e._onTunnelError(f)});this._eventEmitter=new EventEmitter};a.prototype={on:function(c,b){this._eventEmitter.on(c,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(c,b){this._eventEmitter.removeListener(c,b)},connect:function(c){this._tunnel.connect(c)},
close:function(){this._tunnel.close()},send:function(c,b,e){this._logger.log("debug","send l_data.req "+b.toBuffer().toString("hex")+"@"+c);c=new v.L_Data_Req(c,b);this._tunnel.send(c,function(f){e&&e(f)})},_onTunnelConnect:function(){this._eventEmitter.emit("connect")},_onTunnelClose:function(c,b){this._eventEmitter.emit("close",c,b)},_onTunnelEnd:function(){this._eventEmitter.emit("end")},_onTunnelMessage:function(c){var b="unknown";c&&c instanceof v.L_Data_Con?b="l_data.con":c&&c instanceof v.L_Data_Ind&&
(b="l_data.ind");var e=c.getDstAddr();c=c.getAPDU();this._logger.log("debug","recive "+b+" "+c.toBuffer().toString("hex")+"@"+e);this._eventEmitter.emit("message",e,c)},_onTunnelError:function(c){this._eventEmitter.emit("error",c)}};return a}(),z=function(){var a=function(c,b,e,f){this._eventEmitter=new EventEmitter;this._ip=c;this._port=b;if(!this._port||0>=this._port)this._port=a.DEFAULT_REMOTE_PORT;this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+
")");this._localIp=e;this._localPort=f;0>=this._localPort&&(this._localPort=null);this._socket=null;this._requestBuffer=[];this._stateMachine={state:a._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null};this._connectStateNackCount=0};a.TUNNEL_ACK_TIMEOUT=1E3;a.CONNECT_REQUEST_TIMEOUT=1E4;a.CONNECTIONSTATE_REQUEST_INTERVAL=6E4;a.CONNECTIONSTATE_REQUEST_TIMEOUT=1E4;a.MAX_CONNECTIONSTATE_NACK_COUNT=
3;a.DEFAULT_REMOTE_PORT=3671;a._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5};a.prototype={on:function(c,b){this._eventEmitter.on(c,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},connect:function(c){c&&(this._requestBuffer=c);this._fsmConnect()},close:function(){this._fsmClose(!1)},send:function(c,b){if(c){var e=this._requestBuffer.length;this._requestBuffer.push({cEMI:c,callback:b,retry:!1,timer:null,seqNo:-1});0==e&&this._stateMachine.state==
a._STATE.TUNNELLING&&this._sendNextReq()}else b&&b(Error("cEMI is null"))},_sendNextReq:function(){if(0!=this._requestBuffer.length){var c=this._requestBuffer[0],b=this._stateMachine.connection.seqNo;-1!=c.seqNo?b=c.seqNo:c.seqNo=b;var e=this;this._send(b,c.cEMI,function(f){f?(c.callback&&c.callback(f),e._requestBuffer.splice(0,1),e._sendNextReq()):c.timer=setTimeout(function(){c.retry?(e._logger.log("warn","TUNNELLING_ACK ("+c.seqNo+") timeout after "+a.TUNNEL_ACK_TIMEOUT+" seconds"),e._fsmClose(!0)):
(e._logger.log("warn","TUNNELLING_ACK ("+c.seqNo+") timeout after "+a.TUNNEL_ACK_TIMEOUT+" seconds, retry"),c.retry=!0,e._sendNextReq())},a.TUNNEL_ACK_TIMEOUT)})}},_send:function(c,b,e){var f=this;switch(this._stateMachine.state){case a._STATE.TUNNELLING:this._logger.log("debug","send cEMI "+b.toBuffer().toString("hex"));var d=(new y.TunnellingRequest(this._stateMachine.connection.id,c,b)).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex"));this._socket.send(d,
0,d.length,this._port,this._ip,function(g){g?f._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex")+" error:"+g.message):f._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex")+" finish");e&&e(null)});break;default:e&&e(Error("Tunnel is not connected"))}},_fsmConnect:function(){this._logger.log("debug","connect to knx");switch(this._stateMachine.state){case a._STATE.IDLE:this._stateMachine.state=a._STATE.BINDUDP,this._startListenerSocket()}},_fsmClose:function(c){this._stateMachine.close_with_error=
c;switch(this._stateMachine.state){case a._STATE.IDLE:this._fsmClosed();break;case a._STATE.BINDUDP:this._stateMachine.state=a._STATE.CLOSEUDP;this._stopListenerSocket();break;case a._STATE.CONNECT:this._clearStateMachineGuard();this._stateMachine.state=a._STATE.CLOSEUDP;this._stopListenerSocket();break;case a._STATE.TUNNELLING:c=(new y.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer(),this._logger.log("debug","send DISCONNECT_REQUEST "+c.toString("hex")),
this._socket.send(c,0,c.length,this._port,this._ip),this._stateMachine.state=a._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1E3,a._STATE.CLOSEUDP)}},_fsmError:function(c){this._eventEmitter.emit("error",c);this._fsmClose(!0)},_fsmUdpListening:function(){this._logger.log("debug","udp socket established");switch(this._stateMachine.state){case a._STATE.BINDUDP:this._stateMachine.state=a._STATE.CONNECT;this._clearStateMachineGuard();var c=this._socket.address();c={ip:c.address,
port:c.port};c=(new y.ConnectionRequest(c,c)).toBuffer();this._logger.log("debug","send CONNECTION_REQUEST "+c.toString("hex"));this._socket.send(c,0,c.length,this._port,this._ip);this._setStateMachineGuard(a.CONNECT_REQUEST_TIMEOUT,a._STATE.TUNNELLING)}},_fsmUdpMessage:function(c){var b=this,e=this._socket.address(),f=y.parseFrame(c);if(f)switch(this._stateMachine.state){case a._STATE.CONNECT:518===f.getType()&&(f.isConnectionStatusOK()?(this._clearStateMachineGuard(),c=f.getConnectionID(),this._logger.log("debug",
"receive CONNECTION_RESPONSE with connection id "+c),this._stateMachine.connection={},this._stateMachine.connection.id=c,e={ip:e.address,port:e.port},this._stateMachine.connection.hpai=e,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=a._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._sendNextReq(),this._onConnected()):(e=f.getConnectionStatus(),c=Error("tunnel connection fail with error:"+e.toString(16)),c.code=e,this._fsmError(c)));
break;case a._STATE.TUNNELLING:switch(f.getType()){case 1056:c=f.getConnectionID();if(c===this._stateMachine.connection.id){var d=f.getcEMI(),g=f.getSeqNo(),k=!1;g==this._stateMachine.connection.recvSeqNo&&(k=!0);if(g==this._stateMachine.connection.recvSeqNo||g==this._stateMachine.connection.recvSeqNo-1)f=new y.TunnellingACK(c,g),e=f.toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+g+") "+e.toString("hex")),this._socket.send(e,0,e.length,this._port,this._ip,function(n){try{k&&(d&&d instanceof
v.L_Data_Con?(b._logger.log("debug","receive TUNNELLING_REQUEST ("+g+") l_data.con "+d.toBuffer().toString("hex")),b._onMessage(d)):d&&d instanceof v.L_Data_Ind&&(b._logger.log("debug","receive TUNNELLING_REQUEST ("+g+") l_data.ind "+d.toBuffer().toString("hex")),b._onMessage(d)))}catch(h){}});g!=this._stateMachine.connection.recvSeqNo&&g!=this._stateMachine.connection.recvSeqNo-1||g!=this._stateMachine.connection.recvSeqNo||(this._stateMachine.connection.recvSeqNo++,255<this._stateMachine.connection.recvSeqNo&&
(this._stateMachine.connection.recvSeqNo=0))}break;case 1057:c=f.getConnectionID();c===this._stateMachine.connection.id&&this._onTunnelAck(f);break;case 521:c=f.getConnectionID();e=f.getCtrlEndpointHPAI();c===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),f=new y.DisconnectResponse(c),e=f.toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+e.toString("hex")),this._socket.send(e,0,e.length,this._port,this._ip,function(){b._fsmEnd()}));break;case 520:c=
f.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+c),this._connectStateNackCount=0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){b._stateMachine.connectionStateTimer=null;b._sendConnectionStateRequest()},a.CONNECTIONSTATE_REQUEST_INTERVAL)))}break;
case a._STATE.DISCONNECT:522===f.getType()&&(c=f.getConnectionID(),c===this._stateMachine.connection.id&&(e=f.isDisconnectOK(),this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(e?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=a._STATE.CLOSEUDP,b._stopListenerSocket()))}},_fsmEnd:function(){this._stateMachine.state=a._STATE.CLOSEUDP;this._eventEmitter.emit("end");this._stateMachine.close_with_error=!1;this._stopListenerSocket()},_fsmClosed:function(){this._stateMachine.state=
a._STATE.IDLE;var c=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners();var b=this._socket=null;if(c){b=this._requestBuffer;for(var e=0;e<b.length;e++){var f=b[e];f&&(f.timer&&clearTimeout(f.timer),f.seqNo=-1)}this._requestBuffer=[]}else this._clearRequestBuffer();this._resetStateMachine();this._eventEmitter.emit("close",c,b)},_onConnected:function(){this._eventEmitter.emit("connect")},_onMessage:function(c){this._eventEmitter.emit("message",c)},_onTunnelAck:function(c){var b=
c.getSeqNo();c=c.isOK();this._logger.log("debug","receive TUNNELLING_ACK ("+b+") with status "+(c?"OK":"NOK"));b==this._stateMachine.connection.seqNo&&(b=this._requestBuffer[0],b.timer&&clearTimeout(b.timer),b.callback&&b.callback(c?null:Error("NACK")),this._stateMachine.connection.seqNo+=1,255<this._stateMachine.connection.seqNo&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq())},_clearRequestBuffer:function(){for(var c=0;c<this._requestBuffer.length;c++){var b=
this._requestBuffer[c];b&&(b.timer&&clearTimeout(b.timer),b.callback&&b.callback(Error("NACK due to tunnel closed")))}this._requestBuffer=[]},_setStateMachineGuard:function(c,b){var e=this;this._stateMachine.stateTimer=setTimeout(function(){var f=e._stateMachine.state;f===a._STATE.DISCONNECT&&b===a._STATE.CLOSEUDP?(e._stateMachine.state=a._STATE.CLOSEUDP,e._stopListenerSocket()):f!==b&&(f=3==b?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+f,e._logger.log("warn",f),e._fsmError(Error(f)))},
c)},_clearStateMachineGuard:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer)},_sendConnectionStateRequest:function(){var c=this,b=(new y.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer();this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+b.toString("hex")+" with connection id "+this._stateMachine.connection.id);this._socket.send(b,0,b.length,this._port,this._ip);this._stateMachine.connectionStateAckTimer&&
(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null);this._stateMachine.connectionStateAckTimer=setTimeout(function(){c._connectStateNackCount++;c._connectStateNackCount<a.MAX_CONNECTIONSTATE_NACK_COUNT&&c._stateMachine.state===a._STATE.TUNNELLING?(c._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),c._sendConnectionStateRequest()):(c._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),c._fsmError(Error("tunnel break")))},
a.CONNECTIONSTATE_REQUEST_TIMEOUT)},_resetStateMachine:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer);this._stateMachine.connectionStateAckTimer&&clearTimeout(this._stateMachine.connectionStateAckTimer);this._stateMachine={state:a._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},
close_with_error:null}},_startListenerSocket:function(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var c=this;this._socket=dgram.createSocket("udp4");this._socket.on("listening",function(){try{c._socket.addMembership("224.0.23.12");var b=c._socket.address();c._logger.log("trace","{UDP Socket} knx listening "+b.address+":"+b.port);c._fsmUdpListening()}catch(e){c._logger.log("trace","{UDP Socket} knx listening bind multicast failed:"+e.message),c._socket.close(),
c._fsmClosed()}});this._socket.on("close",function(){c._logger.log("trace","{UDP Socket} control socket closed");c._fsmClosed()});this._socket.on("error",function(b){c._logger.log("trace","{UDP Socket} control socket error: "+b.stack);c._fsmError(b)});this._socket.on("message",function(b,e){var f=c._socket.address();c._logger.log("trace","{UDP Socket} receive data "+b.toString("hex")+" from "+e.address+":"+e.port+" @local "+f.address+":"+f.port);c._fsmUdpMessage(b)});this._socket.bind(null,this._localIp)},
_stopListenerSocket:function(){this._logger.log("trace","{UDP Socket} stop knx upd listener");this._socket.close()}};return a}(),y=function(){var a=function(t,u){t&&u&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+u.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(t,2),this._buffer.writeUInt16BE(6+u.length,4),u.copy(this._buffer,6))};a._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame");a.parseFrame=function(t){var u=null;if(6>t.length)return a._logger.log("debug",
"data is too short"),null;var p=t.readUInt16BE(0);if(1552!==p)return a._logger.log("debug","data header&version is invalid:"+p),null;p=t.readUInt16BE(4);if(p>t.length)return a._logger.log("debug","data length in header is larger than actual size:"+p),null;var B=t.readUInt16BE(2);switch(B){case 514:14<=p&&(u=new b);break;case 518:8<=p&&(u=new f);break;case 520:8<=p&&(u=new g);break;case 1057:10<=p&&(u=new n);break;case 1056:6<=p&&(u=new k);break;case 521:16<=p&&(u=new h);break;case 522:8<=p&&(u=new q);
break;default:a._logger.log("debug","data type is unknow:"+B)}u&&(u._buffer=t);return u};a.prototype.getType=function(){return this._buffer.readUInt16BE(2)};a.prototype.getSize=function(){return this._buffer.readUInt16BE(4)};a.prototype.toBuffer=function(){return this._buffer};var c=function(t){var u=new Buffer(8);u.writeUInt16BE(2049,0);u.writeInt32BE(m(t.ip),2);u.writeUInt16BE(t.port,6);a.call(this,513,u)};c.prototype=new a;c.prototype.constructor=c;var b=function(){a.call(this)};b.prototype=new a;
b.prototype.constructor=b;b.prototype.getCtrlEndpointHPAI=function(){var t=this._buffer.readUInt32BE(8);t=r(t);var u=this._buffer.readUInt16BE(12),p={};p.ip=t;p.port=u;return p};b.prototype.getSerialNumber=function(){var t=(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24),u=(this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<8)+this._buffer.readUInt8(27);return t+""+u};b.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+
"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31)};b.prototype.getMAC=function(){return this._buffer.toString("hex",32,38)};b.prototype.getName=function(){return this._buffer.toString("utf8",38,68)};b.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),
project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()}};var e=function(t,u){var p=new Buffer(20);p.writeUInt16BE(2049,0);p.writeInt32BE(m(t.ip),2);p.writeUInt16BE(t.port,6);p.writeUInt16BE(2049,8);p.writeInt32BE(m(u.ip),10);p.writeUInt16BE(u.port,14);p.writeUInt8(4,16);p.writeUInt8(4,17);p.writeUInt8(2,18);p.writeUInt8(0,19);a.call(this,517,p)};e.prototype=new a;e.prototype.constructor=
e;var f=function(){a.call(this)};f.prototype=new a;f.prototype.constructor=f;f.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};f.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};f.prototype.getCtrlEndpointHPAI=function(){var t=this._buffer.readUInt32BE(10);t=r(t);var u=this._buffer.readUInt16BE(14),p={};p.ip=t;p.port=u;return p};f.prototype.getCRD=function(){return this._buffer.readUInt32BE(16)};f.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7)};
var d=function(t,u){var p=new Buffer(10);p.writeUInt8(t,0);p.writeUInt8(0,1);p.writeUInt16BE(2049,2);p.writeInt32BE(m(u.ip),4);p.writeUInt16BE(u.port,8);a.call(this,519,p)};d.prototype=new a;d.prototype.constructor=d;var g=function(){a.call(this)};g.prototype=new a;g.prototype.constructor=g;g.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};g.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};var k=function(t,u,p){if(null!==t&&void 0!==t&&null!==
u&&void 0!==u&&p){var B=new Buffer(4+p.getLength());B.writeUInt8(4,0);B.writeUInt8(t,1);B.writeUInt8(u,2);B.writeUInt8(0,3);p.toBuffer().copy(B,4);a.call(this,1056,B)}else a.call(this)};k.prototype=new a;k.prototype.constructor=k;k.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};k.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};k.prototype.getcEMI=function(){var t=this._buffer.readUInt16BE(4);t=new Buffer(t-6-4);this._buffer.copy(t,0,10);return v.parseFrame(t)};
var n=function(t,u){if(t){var p=new Buffer(4);p.writeUInt8(4,0);p.writeUInt8(t,1);p.writeUInt8(u,2);p.writeUInt8(0,3);a.call(this,1057,p)}else a.call(this)};n.prototype=new a;n.prototype.constructor=n;n.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};n.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};n.prototype.isOK=function(){return 0===this._buffer.readUInt8(9)};var h=function(t,u){if(t&&null!==u){var p=new Buffer(10);p.writeUInt8(t,0);p.writeUInt8(0,1);p.writeUInt8(8,
2);p.writeUInt8(1,3);p.writeInt32BE(m(u.ip),4);p.writeUInt16BE(u.port,8);a.call(this,521,p)}else a.call(this)};h.prototype=new a;h.prototype.constructor=h;h.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};h.prototype.getCtrlEndpointHPAI=function(){var t=this._buffer.readUInt32BE(10);t=r(t);var u=this._buffer.readUInt16BE(14),p={};p.ip=t;p.port=u;return p};var q=function(t){if(t){var u=new Buffer(2);u.writeUInt8(t,0);u.writeUInt8(0,1);a.call(this,1057,u)}else a.call(this)};q.prototype=
new a;q.prototype.constructor=q;q.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};q.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7)};a.SearchRequest=c;a.SearchResponse=b;a.ConnectionRequest=e;a.ConnectionResponse=f;a.ConnectionStateRequest=d;a.ConnectionStateResponse=g;a.TunnellingRequest=k;a.TunnellingACK=n;a.DisconnectRequest=h;a.DisconnectResponse=q;return a}(),v=function(){var a=function(f){this._buffer=f};a.parseFrame=function(f){var d=null;switch(f.readUInt8(0)){case b.MSG_CODE:d=
new b;break;case e.MSG_CODE:d=new e}d&&(d._buffer=f);return d};a.prototype={getLength:function(){return this._buffer.length},getSrcAddr:function(){return this._buffer.readUInt16BE(4)},getDstAddr:function(){return this._buffer.readUInt16BE(6)},getDataLength:function(){return this._buffer.readUInt8(8)},getAPDU:function(){var f=this.getDataLength()+1;f=new Buffer(f);this._buffer.copy(f,0,9,9+f.length);return A.parse(f)},toBuffer:function(){return this._buffer}};var c=function(f,d){var g=new Buffer(9+
d.getLength());g.writeUInt8(17,0);g.writeUInt8(0,1);g.writeUInt8(188,2);g.writeUInt8(224,3);g.writeUInt8(0,4);g.writeUInt8(0,5);g.writeUInt8(f>>8&255,6);g.writeUInt8(f&255,7);g.writeUInt8(d.getLength()-1,8);d.toBuffer().copy(g,9);this._buffer=g};c.MSG_CODE=17;c.prototype=new a;c.prototype.constructor=c;var b=function(){this._buffer=void 0};b.MSG_CODE=46;b.prototype=new a;b.prototype.constructor=b;var e=function(){this._buffer=void 0};e.MSG_CODE=41;e.prototype=new a;e.prototype.constructor=e;a.L_Data_Req=
c;a.L_Data_Con=b;a.L_Data_Ind=e;return a}(),A=function(){var a=function(c,b,e){b||(b=0);c||(c=0);var f=1;e&&1<e.length&&(f=e.length);this._buffer=new Buffer(1+f);this._buffer.writeUInt8(c|b>>2,0);c=e&&0<e.length?e.readUInt8(0):0;b=b<<6|c;this._buffer.writeUInt8(b,1);e&&1<e.length&&e.copy(this._buffer,2,1)};a.parse=function(c){var b=new a;b._buffer=c;return b};a.prototype={getLength:function(){return this._buffer.length},getAPCI:function(){var c=this._buffer.readUInt8(0),b=this._buffer.readUInt8(1);
return(c&3)<<2|(b&192)>>6&3},getData:function(){var c=this._buffer.length-1,b=this._buffer.readUInt8(1),e=new Buffer(c);e.writeUInt8(b&63,0);1<c&&this._buffer.copy(e,1,2);return e},toBuffer:function(){return this._buffer}};return a}();l._DataLink=w;l._Tunnel=z;l.IPFrame=y;l.cEMI=v;l.APDU=A;return l}();
xnm.aio.knx.KNXGateway._DPT=function(){var m=function(a){this.type=a};m.resolve=function(a){if(!a||3>=a.length)return null;var c=a.indexOf("-");if(0>=c)return null;var b=a.substring(0,c);if("DPT"==b){if(5>a.length)return null;b=a}else if("DPST"==b){c=a.indexOf("-",c+1);if(0>c)return null;b=a.substring(0,c)}else return null;switch(b){case "DPT-1":case "DPST-1":return new r(a);case "DPT-2":case "DPST-2":return new x(a);case "DPT-3":case "DPST-3":return new l(a);case "DPT-5":case "DPST-5":return new w(a);
case "DPT-6":case "DPST-6":return new z(a);case "DPT-9":case "DPST-9":return new y(a);case "DPT-14":case "DPST-14":return new v(a);case "DPT-20":case "DPST-20":return new A(a)}return null};m.prototype.doCommand=function(a,c,b,e){e&&e()};m.prototype.setValue=function(a,c,b,e){a&&a instanceof Buffer?c._sendCommand(b,a,function(f){e&&e(f)}.bind(this)):e&&e(Error("invalid value"))};m.prototype.getValue=function(a,c,b){a._getState(c,function(e,f){e?b&&b(e):b&&b(null,this._resolveData(f))}.bind(this))};
m.prototype._resolveDataRaw=function(a){return a.toString("hex")};m.prototype._resolveData=function(a){return a.toString("hex")};var r=function(a){this.type=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.doCommand=function(a,c,b,e){if(a){if(0==a.indexOf("setValue")){if(a=parseInt(a.substr(8)),!a||isNaN(a))a=0}else switch(a){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":a=1;break;
case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":a=0;break;default:e&&e(Error("unknown command:"+a));return}this.setValue(a,c,b,e)}else e&&e(Error("unknown command:"+a))};r.prototype.setValue=function(a,c,b,e){var f=null;f=0==a||1==a?new Buffer([a]):a;m.prototype.setValue.call(this,f,c,b,function(d){e&&e(d)}.bind(this))};r.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};
r.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};r.prototype._resolveValue=function(a){switch(this.type){case "DPT-1":case "DPST-1-1":return a?"on":"off";case "DPST-1-2":return a?"true":"false";case "DPST-1-3":return a?"enable":"disable";case "DPST-1-4":return a?"ramp":"no_ramp";case "DPST-1-5":return a?"alarm":"no alarm";case "DPST-1-6":return a?"high":"low";case "DPST-1-7":return a?"increase":"decrease";case "DPST-1-8":return a?"down":"up";case "DPST-1-9":return a?
"close":"open";case "DPST-1-10":return a?"start":"stop";case "DPST-1-11":return a?"active":"inactive";case "DPST-1-12":return a?"inverted":"not_inverted";case "DPST-1-13":return a?"cyclically":"start/stop";case "DPST-1-14":return a?"calculated":"fixed";case "DPST-1-15":return a?"reset command":"no action";case "DPST-1-16":return a?"acknowledge command":"no action";case "DPST-1-18":return a?"occupied":"not occupied";case "DPST-1-19":return a?"open":"closed";case "DPST-1-21":return a?"logical function AND":
"logical function OR";case "DPST-1-22":return a?"scene B":"scene A";case "DPST-1-23":return a?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null}};var x=function(a){this.type=a};x.prototype=new m;x.prototype.constructor=x;x.prototype.doCommand=function(a,c,b,e){if(a)if(0==a.indexOf("setValue")){a.substr(0,8);var f=parseInt(a.substr(8));if(!f||isNaN(f))f=0;this.setValue(f,c,b,e)}else{var d=a.split(".");if(2>d.length)e&&e(Error("unknown command:"+a));else{f=
"prio"==d[0]?1:0;switch(d[1]){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":f=f<<1|1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":f=f<<1|0;break;default:e&&e(Error("unknown command:"+a));return}this.setValue(f,c,b,e)}}else e&&e(Error("unknown command:"+a))};x.prototype.setValue=
function(a,c,b,e){var f=null;f=0==a||1==a||2==a||3==a?new Buffer([a]):a;m.prototype.setValue.call(this,f,c,b,function(d){e&&e(d)}.bind(this))};x.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};x.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};x.prototype._resolveValue=function(a){var c=1==a>>1?"prio.":"no_prio.";switch(this.type){case "DPT-2":c=a;break;case "DPST-2-1":c+=a&1?"on":"off";break;case "DPST-2-2":c+=a&1?"true":"false";break;case "DPST-2-3":c+=
a&1?"enable":"disable";break;case "DPST-2-4":c+=a&1?"ramp":"no_ramp";break;case "DPST-2-5":c+=a&1?"alarm":"no alarm";break;case "DPST-2-6":c+=a&1?"high":"low";break;case "DPST-2-7":c+=a&1?"increase":"decrease";break;case "DPST-2-8":c+=a&1?"down":"up";break;case "DPST-2-9":c+=a&1?"close":"open";break;case "DPST-2-10":c+=a&1?"start":"stop";break;case "DPST-2-11":c+=a&1?"active":"inactive";break;case "DPST-2-12":c+=a&1?"inverted":"not_inverted";break;default:return null}return c};var l=function(a){this.type=
a};l.prototype=new m;l.prototype.constructor=l;l.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;if(0==a.indexOf("setValue")){a.substr(0,8);d=parseInt(a.substr(8));if(!d||isNaN(d))d=0;this.setValue(d,c,b,e)}else{if("stepUpStop"==a||"stepDownStop"==a)f=a,d=0;else if(0==a.indexOf("stepUp")){if(f=a.substr(0,6),d=parseInt(a.substr(6)),!d||isNaN(d))d=1}else 0==a.indexOf("stepDown")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=1);a=this._getStepcode(d);if(-1==a)e&&e(Error("invalid step precent:"+
d));else{switch(f){case "stepUp":f=1;if(0>=a){e&&e(Error("stepUp command value invalid"));return}break;case "stepDown":f=0;if(0>=a){e&&e(Error("stepDown command value invalid"));return}break;case "stepUpStop":f=1;break;case "stepDownStop":f=0;break;default:e&&e(Error("unknown command:"+f));return}this.setValue(f<<3|a,c,b,e)}}}else e&&e(Error("unknown command:"+a))};l.prototype.setValue=function(a,c,b,e){0>a&&(a=0);15<a&&(a=15);a=new Buffer([a]);m.prototype.setValue.call(this,a,c,b,function(f){e&&
e(f)}.bind(this))};l.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};l.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};l.prototype._resolveValue=function(a){var c=a&7,b=0;0==c?b=0:1==c?b=100:2==c?b=50:3==c?b=25:4==c?b=12:5==c?b=6:6==c?b=3:7==c&&(b=1);return{direction:a&8?"up":"down",precent:b,stepcode:c}};l.prototype._getStepcode=function(a){switch(a){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;
case 100:return 1;default:return-1}};var w=function(a){this.type=a};w.prototype=new m;w.prototype.constructor=w;w.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;case "up":case "down":a=null;a="up"==f?this._getBuffer(255):this._getBuffer(0);if(!a){e&&e(Error("invalid value"));return}m.prototype.setValue.call(this,a,c,b,function(g){e&&e(g)}.bind(this));return;default:e&&e(Error("unknown command:"+
f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};w.prototype.setValue=function(a,c,b,e){switch(this.type){case "DPST-5-1":0>a&&(a=0);100<a&&(a=100);a=Math.round(a/100*255);break;case "DPST-5-3":0>a&&(a=0);360<a&&(a=360);a=Math.round(a/360*255);break;case "DPST-5-6":0>a&&(a=0);254<a&&(a=254);a=Math.round(a/360*255);break;default:0>a&&(a=0),255<a&&(a=255)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(f){e&&e(f)}.bind(this)):e&&e(Error("invalid value"))};
w.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};w.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};w.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};w.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};w.prototype._resolveValue=function(a){switch(this.type){case "DPST-5-1":return Math.round(a/255*100);case "DPST-5-3":return Math.round(a/
255*360);default:return a}};w.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var z=function(a){this.type=a};z.prototype=new m;z.prototype.constructor=z;z.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};z.prototype.setValue=
function(a,c,b,e){-128>a&&(a=-128);127<a&&(a=127);0>a&&(a+=256);(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(f){e&&e(f)}.bind(this)):e&&e(Error("invalid value"))};z.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};z.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};z.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};z.prototype._resolveData=function(a){if(!a||2>a.length)return null;
a=a.readUInt8(1);return this._resolveValue(a)};z.prototype._resolveValue=function(a){127<a&&(a-=256);return a};z.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var y=function(a){this.type=a};y.prototype=new m;y.prototype.constructor=y;y.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseFloat(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+
f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};y.prototype.setValue=function(a,c,b,e){switch(this.type){case "DPT-9":-671088.64>a&&(a=-671088.64);670760.96<a&&(a=670760.96);a=this._float2short(a);break;case "DPST-9-1":-273>a&&(a=-273);670760<a&&(a=670760);a=this._float2short(a);break;case "DPST-9-4":0>a?a=0:670433.28<a&&(a=670433.28);a=this._float2short(a);break;default:a=this._float2short(a)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(f){e&&e(f)}.bind(this)):
e&&e(Error("invalid value"))};y.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};y.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};y.prototype._resolveDataRaw=function(a){return!a||3>a.length?0:a.readUInt16BE(1)};y.prototype._resolveData=function(a){if(!a||3>a.length)return 0;a=a.readUInt16BE(1);return this._resolveValue(a)};y.prototype._resolveValue=function(a){switch(this.type){case "DPT-9":case "DPST-9-1":case "DPST-9-4":return parseFloat(this._short2float(a).toFixed(2));
default:return parseFloat(this._short2float(a).toFixed(2))}};y.prototype._getBuffer=function(a){var c=new Buffer(3);c.writeUInt8(0,0);c.writeUInt16BE(a,1);return c};y.prototype._float2short=function(a){for(var c=100*a,b=0;-2048>c;c/=2)b++;for(;2047<c;c/=2)b++;c=Math.round(c)&2047;b=b<<3|c>>8;0>a&&(b|=128);return b<<8|c};y.prototype._short2float=function(a){var c=a>>15&1,b=a&2047|c<<11;1==c&&(b-=4096);return.01*b*Math.pow(2,a>>11&15)};var v=function(a){this.type=a};v.prototype=new m;v.prototype.constructor=
v;v.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseFloat(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};v.prototype.setValue=function(a,c,b,e){-3.40282347E38>a&&(a=-3.40282347E38);3.40282347E38<a&&(a=3.40282347E38);a=this._float2bytes(a);(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(f){e&&
e(f)}.bind(this)):e&&e(Error("invalid value"))};v.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};v.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};v.prototype._resolveDataRaw=function(a){return!a||5>a.length?0:a.readUInt32BE(1)};v.prototype._resolveData=function(a){if(!a||5>a.length)return 0;a=a.readUInt32BE(1);return this._resolveValue(a)};v.prototype._resolveValue=function(a){return parseFloat(this._long2float(a).toFixed(2))};
v.prototype._getBuffer=function(a){if(!a||4>a.length)return null;var c=new Buffer(5);c.writeUInt8(0,0);for(var b=0;4>b;b++)c.writeUInt8(a[b],b+1);return c};v.prototype._float2bytes=function(a){return this._toIEEE754Single(a)};v.prototype._long2float=function(a){var c=new Buffer(4);c.writeUInt32BE(a);a=Array.prototype.slice.call(c);return this._fromIEEE754Single(a)};v.prototype._toIEEE754=function(a,c,b){var e=(1<<c-1)-1;if(isNaN(a)){var f=(1<<e)-1;e=1;var d=0}else if(Infinity===a||-Infinity===a)f=
(1<<e)-1,e=0,d=0>a?1:0;else if(0===a)e=f=0,d=-Infinity===1/a?1:0;else if(d=0>a,a=Math.abs(a),a>=Math.pow(2,1-e)){var g=Math.min(Math.floor(Math.log(a)/Math.LN2),e);f=g+e;e=a*Math.pow(2,b-g)-Math.pow(2,b)}else f=0,e=a/Math.pow(2,1-e-b);for(a=[];b;--b)a.push(e%2?1:0),e=Math.floor(e/2);for(b=c;b;--b)a.push(f%2?1:0),f=Math.floor(f/2);a.push(d?1:0);a.reverse();c=a.join("");for(d=[];c.length;)d.push(parseInt(c.substring(0,8),2)),c=c.substring(8);return d};v.prototype._fromIEEE754=function(a,c,b){for(var e=
[],f=a.length;f;--f)for(var d=a[f-1],g=8;g;--g)e.push(d%2?1:0),d>>=1;e.reverse();d=e.join("");a=(1<<c-1)-1;e=parseInt(d.substring(0,1),2)?-1:1;f=parseInt(d.substring(1,1+c),2);d=parseInt(d.substring(1+c),2);return f===(1<<c)-1?0!==d?NaN:Infinity*e:0<f?e*Math.pow(2,f-a)*(1+d/Math.pow(2,b)):0!==d?d/Math.pow(2,b)*Math.pow(2,-(a-1))*e:0*e};v.prototype._fromIEEE754Single=function(a){return this._fromIEEE754(a,8,23)};v.prototype._toIEEE754Single=function(a){return this._toIEEE754(a,8,23)};var A=function(a){this.type=
a};A.prototype=new m;A.prototype.constructor=A;A.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "auto":d=0;break;case "comfort":d=1;break;case "standby":d=2;break;case "economy":d=3;break;case "protection":d=4;break;case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};A.prototype.setValue=function(a,c,b,e){(a=
this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(f){e&&e(f)}.bind(this)):e&&e(Error("invalid value"))};A.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);c=c.value+a;this.setValue(c,b,e,f)};A.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);c=c.value-a;this.setValue(c,b,e,f)};A.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};A.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};
A.prototype._resolveValue=function(a){switch(this.type){case "DPT-20":break;case "DPST-20-1":switch(a){case 0:a="autonomous";break;case 1:a="slave";break;case 2:a="master";break;default:a="unknow"}break;case "DPST-20-102":switch(a){case 0:a="auto";break;case 1:a="comfort";break;case 2:a="standby";break;case 3:a="economy";break;case 4:a="protection";break;default:a="unknow"}break;default:return null}return a};A.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);
return c};m.DPT1=r;m.DPT2=x;m.DPT3=l;m.DPT5=w;m.DPT6=z;m.DPT9=y;m.DPT14=v;m.DPT20=A;return m}();
xnm.aio.knx.KNXGateway._Device=function(){var m=function(a){this._device=a};m.resolve=function(a){if(!a)return null;var c=null;switch(a.data){case "outlet":c=new x(a);break;case "lighting":c=new l(a);break;case "blind":c=new w(a);break;case "shutter":c=new z(a);break;case "heater":c=new y(a);break;case "1bit":c=new v(a);break;case "1byte":c=new A(a);break;case "general":c=new r(a)}return c};m.prototype={getDefaultChannel:function(){return null},executeCommand:function(a,c,b){this._parseCommand(a,
function(e,f,d,g){e?b&&b(e):(e=g.ga,(f=xnm.aio.knx.KNXGateway._DPT.resolve(g.type))?f.doCommand(d,c,e,function(k){b&&b(k)}.bind(this)):b&&b(Error("unknown actuator type:"+g.type)))})},_parseCommand:function(a,c){if(this._device)if(a){var b=a.indexOf("@");if(-1==b)c&&c(Error("command format invalid"));else{var e=a.substr(0,b);a=a.substr(b+1);e||(e=this.getDefaultChannel());this._device.channels&&this._device.channels[e]?(b=this._device.channels[e],b.actuator&&b.actuator.ga&&b.actuator.type?xnm.aio.knx.KNXGateway._DPT.resolve(b.actuator.type)?
c&&c(null,e,a,b.actuator):c&&c(Error("unknown actuator type:"+b.actuator.type)):c&&c(Error("device has no actuator for channel:"+e))):c&&c(Error("device has no channel with id:"+e))}}else c&&c(Error("command is null"));else c&&c(Error("device is null"))},getStates:function(a){if(!this._device||!this._device.channels)return null;var c=null,b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var e=this.getState(b,a);e&&!e.error&&(c||(c={}),null==e.resolvedValue?c[b]={state:e.resolvedValue,
raw:e.resolvedRawValue}:"object"==typeof e.resolvedValue?(c[b]=JSON.parse(JSON.stringify(e.resolvedValue)),c[b].raw=e.resolvedRawValue):c[b]={state:e.resolvedValue,raw:e.resolvedRawValue})}return c},getState:function(a,c){return this._getBufferedState(a,c)},_getBufferedState:function(a,c){var b={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return b.error=Error("device is null"),b;a||(a=this.getDefaultChannel());if(!this._device.channels||!this._device.channels[a])return b.error=
Error("device has no channel with id:"+a),b;a=this._device.channels[a];var e,f=null,d=null,g=null,k=c.getStateBuffer();a.event&&a.event.ga&&(f=k.getState(xnm.aio.knx.KNXGateway._adr2long(a.event.ga)))&&(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.event.type))&&(g=e._resolveDataRaw(f),d=e._resolveData(f));("undefined"==typeof f||null==f)&&a.status&&a.status.ga&&(f=k.getState(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)))&&(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&(g=e._resolveDataRaw(f),
d=e._resolveData(f));if(("undefined"==typeof f||null==f)&&a.status&&a.status.ga){e=k.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga));var n=new Date;if(!e||n.getTime()-e.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)k.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga),n),(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&e.getValue(c,a.status.ga)}b.bufferedValue=f;b.resolvedRawValue=g;b.resolvedValue=d;return b},refreshStates:function(a){if(!this._device||!this._device.channels)return null;
var c=a.getStateBuffer(),b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var e=this._device.channels[b];if(e.status&&e.status.ga&&e.status.type){var f=xnm.aio.knx.KNXGateway._DPT.resolve(e.status.type);if(f){var d=new Date;c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(e.status.ga),d);f.getValue(a,e.status.ga)}}}return null}};var r=function(a){this._device=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.executeCommand=function(a,c,b){if("refreshStates"==
a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else if(f=k.ga,k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type),k instanceof xnm.aio.knx.KNXGateway._DPT.DPT1)switch(g){case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.bufferedValue.readUInt8(0);k.setValue(d?0:1,c,f,function(q){b&&b(q)}.bind(this));break;default:k.doCommand(g,c,f,b)}else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)k.doCommand(g,
c,f,b);else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)k.doCommand(g,c,f,b);else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT5){var n=g;if(0==g.indexOf("inc")){n=g.substr(0,3);var h=parseInt(g.substr(3));if(!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(n){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;
k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;default:k.doCommand(g,c,f,b)}}else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT6){n=g;if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(n=g.substr(0,
3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(n){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&
b(q)}.bind(this));break;default:k.doCommand(g,c,f,b)}}else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT9){n=g;if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(n=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))&&(h=1);switch(n){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&
b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;default:k.doCommand(g,c,f,b)}}else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT14){n=g;if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(n=g.substr(0,3),h=parseFloat(g.substr(3)),
!h||isNaN(h))&&(h=1);switch(n){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;
default:k.doCommand(g,c,f,b)}}else if(k instanceof xnm.aio.knx.KNXGateway._DPT.DPT20){n=g;if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(n){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));
break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;default:k.doCommand(g,c,f,b)}}else b&&b(Error("unknown data point type"))})}};var x=function(a){this._device=a};x.prototype=new m;x.prototype.constructor=x;x.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=
this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else switch(f=k.ga,k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type),d){case "switch":switch(g){case "on":case "off":k.doCommand(g,c,f,b);break;case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.bufferedValue.readUInt8(0);k.setValue(d?0:1,c,f,function(n){b&&b(n)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;default:r.prototype.executeCommand.call(e,a,c,b)}})}};
x.prototype.getDefaultChannel=function(){return"switch"};var l=function(a){this._device=a};l.prototype=new m;l.prototype.constructor=l;l.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else{f=k.ga;k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type);var n=g,h=null;switch(d){case "switch":switch(g){case "on":case "off":k.doCommand(g,c,f,b);break;case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&
b(Error("device (buffered) Status unknow"));return}d=d.bufferedValue.readUInt8(0);k.setValue(d?0:1,c,f,function(q){b&&b(q)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;case "step":0==g.indexOf("stepUp")||0==g.indexOf("stepDown")?k.doCommand(g,c,f,b):b&&b(Error("invalid device command"));break;case "value":if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=
1}else 0==g.indexOf("dimTo")&&(n="dimTo",h=parseInt(g.substr(5)),!h||isNaN(h))&&(h=0);switch(n){case "dimUp":k.doCommand("up",c,f,b);break;case "dimDown":k.doCommand("down",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||
null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dimTo":k.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:r.prototype.executeCommand.call(e,a,c,b)}}})}};l.prototype.getDefaultChannel=function(){return"value"};var w=function(a){this._device=a};w.prototype=new m;w.prototype.constructor=w;w.prototype.executeCommand=function(a,c,b){if("refreshStates"==
a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else{f=k.ga;k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type);var n=g,h=null;switch(d){case "blind_step":switch(g){case "blindStepUp":k.doCommand("up",c,f,b);break;case "blindStepDown":k.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_move":switch(g){case "blindMoveUp":k.doCommand("up",c,f,b);break;case "blindMoveDown":k.doCommand("down",c,f,b);break;default:b&&
b(Error("invalid device command"))}break;case "blind_stop":switch(g){case "blindStop":k.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_position":if(0==g.indexOf("inc")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(n="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(n){case "moveUp":k.doCommand("down",c,f,b);
break;case "moveDown":k.doCommand("up",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&
b(q)}.bind(this));break;case "moveTo":k.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "lamella_position":if(0==g.indexOf("incL")){if(n=g.substr(0,4),h=parseInt(g.substr(4)),!h||isNaN(h))h=1}else if(0==g.indexOf("decL")){if(n=g.substr(0,4),h=parseInt(g.substr(4)),!h||isNaN(h))h=1}else 0==g.indexOf("lamellaTo")&&(n="lamellaTo",h=parseInt(g.substr(9)),!h||isNaN(h))&&(h=0);switch(n){case "lamellaUp":k.doCommand("down",c,f,b);break;case "lamellaDown":k.doCommand("up",
c,f,b);break;case "incL":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "decL":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "lamellaTo":k.doCommand("setValue"+
h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:r.prototype.executeCommand.call(e,a,c,b)}}})}};w.prototype.getDefaultChannel=function(){return"blind_position"};var z=function(a){this._device=a};z.prototype=new m;z.prototype.constructor=z;z.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else{f=k.ga;k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type);var n=g,h=null;switch(d){case "shutter_step":switch(g){case "shutterStepUp":k.doCommand("up",
c,f,b);break;case "shutterStepDown":k.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_move":switch(g){case "shutterMoveUp":k.doCommand("up",c,f,b);break;case "shutterMoveDown":k.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_stop":switch(g){case "shutterStop":k.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_position":if(0==g.indexOf("inc")){if(n=g.substr(0,
3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(n=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(n="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(n){case "moveUp":k.doCommand("down",c,f,b);break;case "moveDown":k.doCommand("up",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;
k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "moveTo":k.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:r.prototype.executeCommand.call(e,a,c,b)}}})}};z.prototype.getDefaultChannel=function(){return"shutter_position"};
var y=function(a){this._device=a};y.prototype=new m;y.prototype.constructor=y;y.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,k){if(f)b&&b(f);else{f=k.ga;k=xnm.aio.knx.KNXGateway._DPT.resolve(k.type);var n=g,h=null;switch(d){case "setpoint_basic":if(0==g.indexOf("tempUp")){if(n=g.substr(0,6),h=parseFloat(g.substr(6)),!h||isNaN(h))h=.5}else if(0==g.indexOf("tempDown")){if(n=g.substr(0,8),h=parseFloat(g.substr(8)),
!h||isNaN(h))h=.5}else 0==g.indexOf("tempTo")&&(n="tempTo",h=parseFloat(g.substr(6)),!h||isNaN(h))&&(h=0);switch(n){case "tempUp":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "tempDown":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "tempTo":k.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "setpoint_shift":if(0==g.indexOf("tempShiftUp")){if(n=g.substr(0,11),h=parseInt(g.substr(11)),!h||isNaN(h))h=1}else if(0==g.indexOf("tempShiftDown")){if(n=g.substr(0,13),h=parseInt(g.substr(13)),!h||isNaN(h))h=1}else 0==g.indexOf("tempShiftTo")&&(n="tempShiftTo",h=parseInt(g.substr(11)),!h||isNaN(h))&&(h=
0);switch(n){case "tempShiftUp":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.incValue(h,d,c,f,function(q){b&&b(q)}.bind(this));break;case "tempShiftDown":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;k.decValue(h,d,c,f,function(q){b&&b(q)}.bind(this));
break;case "tempShiftTo":k.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "mode":k.doCommand(g,c,f,b);break;default:r.prototype.executeCommand.call(e,a,c,b)}}})}};y.prototype.getDefaultChannel=function(){return"set_temperature"};var v=function(a){this._device=a};v.prototype=new m;v.prototype.constructor=v;v.prototype.doCommand=function(a,c,b){var e={};var f=a.command;var d=a.channel;d||(d=this.getDefaultChannel());if(this._device[d])if(a=this._getWriteableGa(this._device[d]))if(a instanceof
Error)b&&b(a);else switch(f){case "on":var g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.setValue(1,c,a,function(k,n){k||(e.channel=d,e.state=n);b&&b(k,k?null:e)}.bind(this));break;case "off":g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.setValue(0,c,a,function(k,n){k||(e.channel=d,e.state=n);b&&b(k,k?null:e)}.bind(this));break;case "toggle":f=this._getReadableGa(this._device[d]);if(!f){b&&b(Error("invalid device has no readable address"));break}if(f instanceof
Error){b&&b(a);break}g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.invValue(c,a,f,function(k,n){k||(e.channel=d,e.state=n);b&&b(k,k?null:e)}.bind(this));break;default:b&&b(Error("invalid device command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};v.prototype.evalGroupCommand=function(a,c,b){var e={};var f=a.command;var d=a.channel;d||(d=this.getDefaultChannel());if(this._device[d])if(a=this._getWriteableGa(this._device[d]))if(a instanceof
Error)b&&b(a);else switch(f){case "on":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);f.evalValue(1,c,a,function(g,k){g||(e.channel=d,e.state=k);b&&b(g,g?null:e)}.bind(this));break;case "off":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);f.evalValue(0,c,a,function(g,k){g||(e.channel=d,e.state=k);b&&b(g,g?null:e)}.bind(this));break;default:b&&b(Error("invalid device group command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};
v.prototype.getState=function(a,c,b){if(a&&a.channel)var e=a.channel;e||(e=this.getDefaultChannel());this._getState(e,c,b)};v.prototype.getDefaultChannel=function(){return"channel"};var A=function(a){this._device=a};A.prototype=new m;A.prototype.constructor=A;A.prototype.doCommand=function(a,c,b){var e,f={},d=a.command,g=a.channel;g||(g=this.getDefaultChannel());if(this._device[g]){var k=this._getWriteableGa(this._device[g]);if(k)if(k instanceof Error)b&&b(k);else if(3<=d.length&&("inc"===d.substr(0,
3).toLowerCase()||"dec"===d.substr(0,3).toLowerCase())){var n=d.substr(0,3);d=d.substr(3);""==d&&(d="10");d.match(/^\d+$/)?(d=parseInt(d),(e=this._getReadableGa(this._device[g]))?e instanceof Error?b&&b(e):(a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[g].actuator.type),a["inc"==n?"incValue":"decValue"](d,c,k,e,function(h,q){h||null==q||(f.channel=g,f.state=q);b&&b(h,h?null:f)})):b&&b(Error("invalid device has no readable address"))):b&&b(Error("invalid device command"))}else 6<d.length&&"moveto"===
d.substr(0,6).toLowerCase()&&(d=d.substr(6)),d.match(/^\d+$/)?(d=parseInt(d),a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[g].actuator.type),a.setValue(d,c,k,function(h,q){h||null==q||(f.channel=g,f.state=q);b&&b(h,h?null:f)})):b&&b(Error("invalid device command"));else b&&b(Error("invalid device has no writeable address"))}else b&&b(Error("invalid device"))};A.prototype.evalGroupCommand=function(a,c,b){var e={},f=a.command,d=a.channel;d||(d=this.getDefaultChannel());this._device[d]?(a=this._getWriteableGa(this._device[d]))?
a instanceof Error?b&&b(a):3<=f.length&&("inc"===f.substr(0,3).toLowerCase()||"dec"===f.substr(0,3).toLowerCase())?b&&b(Error("invalid device group command")):(6<f.length&&"moveto"===f.substr(0,6).toLowerCase()&&(f=f.substr(6)),f.match(/^\d+$/)?(f=parseInt(f),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type).evalValue(f,c,a,function(g,k){g||null==k||(e.channel=d,e.state=k);b&&b(g,g?null:e)})):b&&b(Error("invalid device command"))):b&&b(Error("invalid device has no writeable address")):
b&&b(Error("invalid device"))};A.prototype.getState=function(a,c,b){if(a&&a.channel)var e=a.channel;e||(e=this.getDefaultChannel());this._getState(e,c,b)};A.prototype.getDefaultChannel=function(){return"channel"};m.General=r;m.Outlet=x;m.Lighting=l;m.Blind=w;m.Shutter=z;m.Heater=y;m.BIT_1=v;m.Byte_1=A;return m}();
xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter,_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function(m,r){this._eventEmitter.on(m,r)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},startSearchKNX:function(){if(os&&os.networkInterfaces){var m=os.networkInterfaces(),r;for(r in m)for(var x=m[r],l=0;l<x.length;l++){var w=x[l];!1===w.internal&&"IPv4"===w.family&&this._createSocket(w.address)}}else this._createSocket(null);this._closedSockets=
[]},stopSearchKNX:function(){for(var m=0;m<this._listenerSockets.length;m++)this._listenerSockets[m].close()},_createSocket:function(m){var r=this,x=dgram.createSocket("udp4");x.on("listening",function(){x.addMembership("224.0.23.12");x.setBroadcast(!0);var l=x.address();r._logger.log("debug","knx discovery socket listening "+l.address+":"+l.port);r._listenerSockets.push(x);var w=(new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest({ip:l.address,port:l.port})).toBuffer();r._logger.log("debug","send knx search request: "+
w.toString("hex")+" from "+l.address+":"+l.port);x.send(w,0,w.length,3671,"224.0.23.12")});x.on("message",function(l,w){var z=x.address();r._logger.log("trace","receive data "+l.toString("hex")+" from "+w.address+":"+w.port+" @local "+z.address+":"+z.port);l=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(l);l instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse&&(w=l.getCtrlEndpointHPAI(),r._logger.log("debug","find knx "+w.ip+":"+w.port),r._eventEmitter.emit("found",l,z),r._eventEmitter.emit("device",
l.toJSON(),z))});x.on("error",function(l){r._logger.log("debug","discovery socket error: "+l.stack);r._eventEmitter.emit("error",l)});x.on("close",function(){r._logger.log("debug","discovery socket closed");r._closedSockets.push(x);r._listenerSockets.length===r._closedSockets.length&&(r._listenerSockets=[],r._closedSockets=[],r._eventEmitter.emit("close"))});x.bind(null,m)}};
xnm.aio.knx.Handler=function(){var m=function(){this._listenerSockets=[]};m.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler);
