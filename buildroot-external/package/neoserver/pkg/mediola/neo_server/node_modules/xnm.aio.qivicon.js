var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.qivicon=xnm.aio.qivicon||{};xnm.aio.qivicon.SessionCache={_cache:{},getSessionID:function(e){return e?this._cache[e]?this._cache[e].sessionID:null:null},getToken:function(e){return e?this._cache[e]?this._cache[e].token:null:null},setSessionID:function(e,c){if(e&&c){var b=this._cache[e];b||(this._cache[e]={},b=this._cache[e]);b.sessionID=c}},setToken:function(e,c){if(e&&c){var b=this._cache[e];b||(this._cache[e]={},b=this._cache[e]);b.token=c}}};
xnm.aio.qivicon.HomeBase=function(){var e=function(c,b,a,d,f){this._logger=require("x.logger.js").getLogger("xnm.aio.qivicon.HomeBase");this.ip=c;this.port=b;b||(this.port=443);this.user=a;this.password=d;this.uuid=f;this.CommandHandler=null};e.prototype._setSessionID=function(c){return xnm.aio.qivicon.SessionCache.setSessionID(this.ip,c)};e.prototype._getSessionID=function(){return xnm.aio.qivicon.SessionCache.getSessionID(this.ip)};e.prototype._setCachedToken=function(c){return xnm.aio.qivicon.SessionCache.setToken(this.ip,
c)};e.prototype._getCachedToken=function(){return xnm.aio.qivicon.SessionCache.getToken(this.ip)};e.prototype._doRequest=function(c,b,a,d){c={host:this.ip,port:this.port,path:b,method:c,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};a&&(c.headers["Content-Length"]=a.length);this._getSessionID()&&(c.headers.Cookie="JSESSIONID="+this._getSessionID()+"End");this._getCachedToken()&&(c.headers.Authorization="Bearer "+this._getCachedToken());var f=require("https");"undefined"!=
typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(c));var g=this,h=d,l=f.request(c,function(k){k.setEncoding("utf-8");var n="";k.on("data",function(p){n+=p});k.on("end",function(){g._logger.log("trace","receive code:"+k.statusCode+" headers:"+JSON.stringify(k.headers)+" response:"+n);h&&(h(null,n,k),h=null)})});if(l.on)l.on("error",function(k){h&&(h(k),h=null)});l.setTimeout&&l.setTimeout(2E3,function(){g._logger.log("trace",
"do request timeout");l.abort();h&&(h(Error("timeout")),h=null)});l.setAllowRedirect&&l.setAllowRedirect(!1);a&&("/system/http/login"==b?this._logger.log("trace","do request send body:u=xxxxxx&p=xxxxxx"):this._logger.log("trace","do request send body:"+a),l.write(a));l.end()};e.prototype._sendRequest=function(c,b,a,d){var f=this;this._doRequest(c,b,a,function(g,h,l){g?d&&d(g):l&&401==l.statusCode?f._login(function(k){k?d&&d(k):f._sendRequest(c,b,a,d)}):(g=l&&200==l.statusCode?null:Error("http error"),
d&&d(g,h))})};e.prototype._doJSONRPC=function(c,b){c=JSON.stringify(c);this._sendRequest("POST","/remote/json-rpc",c,function(a,d){if(a||!d)a||d||(a=Error("response text invalid")),b&&b(a);else{var f=null;try{f=JSON.parse(d)}catch(g){a=g}b&&b(a,f)}})};e.prototype._getToken=function(c){var b=this;this._doRequest("GET","/dashboard/system.app.basicclient/index.html",null,function(a,d){var f;if(d){var g=d.indexOf(' data-access-token="');0<g&&(d=d.substring(g+20),g=d.indexOf('" '),0<g&&(f=d.substring(0,
g)))}f?b._setCachedToken(f):a=Error("get token response error");c&&c(a,f)})};e.prototype._login=function(c){var b="u="+encodeURIComponent(this.user)+"&p="+encodeURIComponent(this.password),a=this;this._doRequest("POST","/system/http/login",b,function(d,f,g){if(d)c&&c(d);else{if(g&&302==g.statusCode&&(d=null,g.headers&&g.headers["set-cookie"]&&(g=g.headers["set-cookie"],g.constructor===Array&&(g=g[0]),f=g.indexOf("End;"),0==g.indexOf("JSESSIONID=")&&0<f&&(d=g.substring(11,f))),d)){a._setSessionID(d);
a._getToken(function(h){c&&c(h)});return}c&&c(Error("login error"))}})};e.prototype._executeCommand=function(c,b,a,d,f){c=[{jsonrpc:"2.0",method:"BasicClientJsonRpc/processDevice",params:[c,b,a,JSON.parse(d)]}];this._doJSONRPC(c,function(g){f&&f(g)})};e.prototype.getDevices=function(c){this._doJSONRPC([{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllRooms",id:"mk98-4",params:[]},{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllDevices",id:"mk98-6",params:[]}],function(b,a){if(b)c&&c(b);else{b={};if(a&&
0<a.length)for(var d=0;d<a.length;d++){var f=a[d];if(f.result){if(f.result.devices)for(var g=0;g<f.result.devices.length;g++){var h=f.result.devices[g];if(h.roomId){b[h.roomId]||(b[h.roomId]={});b[h.roomId].devices||(b[h.roomId].devices={});var l={channels:{}};l.name=h.name;l.state=h.status;h.compoundType&&h.compoundType.id&&(l.address=h.compoundType.id);h.compoundType&&h.compoundType.deviceTypeName&&(l.type=h.compoundType.deviceTypeName);if(h.compoundType&&h.compoundType.types)for(var k=h.compoundType.types,
n=0;n<k.length;n++)if(k[n].states){for(var p=k[n].id,m=k[n].deviceClassName,q={},r=0;r<k[n].states.length;r++){var t=k[n].states[r];t.name&&null!=t.value&&(q[t.name]=t.value)}if(p&&m){if(l.channels[m])for(r=1,t=m;l.channels[m];)r++,m=t+"@"+r;l.channels[m]={address:p,state:q,type:k[n].deviceTypeName}}}b[h.roomId].devices[h.id]=l}}if(f.result.rooms)for(g=0;g<f.result.rooms.length;g++)h=f.result.rooms[g],b[h.id]||(b[h.id]={}),b[h.id].name=h.name,b[h.id].devices={}}}c&&c(null,b)}})};e.prototype.executeCommand=
function(c,b,a){var d=c.address,f=null,g=null,h="[]";"on"==b?(g="turnOn",f="binarySwitch"):"off"==b?(g="turnOff",f="binarySwitch"):"toggle"==b?(g=b,f="binarySwitch"):"dimUp"==b?(g="stepUp",f="multiLevelSwitch"):"dimDown"==b?(g="stepDown",f="multiLevelSwitch"):"stopMovement"==b?(g=b,f="blinds"):0==b.indexOf("dimTo")?(b=parseInt(b.replace(/dimTo/g,"")),g="setLevel",f="multiLevelSwitch",h='["'+b+'"]'):0==b.indexOf("moveTo")?(b=parseInt(b.replace(/moveTo/g,"")),g="setLevel",f="blinds",h='["'+b+'"]'):
0==b.indexOf("setTo")&&(b=b.replace(/setTo/g,""),"0"!=b&&"100"!=b&&(b=(parseFloat(b)/2).toFixed(1)),g="setTemperature",f="temperatureActuator",h='["'+b+'"]');f&&g?(c.channels&&c.channels[f]&&c.channels[f].address&&(d=c.channels[f].address),this._executeCommand(d,f,g,h,a)):a&&a()};e.prototype.getStates=function(c,b,a){this.CommandHandler=c;this.getDevices(function(d,f){d={};for(var g in f)for(var h in f[g].devices)for(var l=0;l<b.length;l++){var k=b[l];if(k.address==h){k.id||(k.id=h);d[k.id]={};for(var n in f[g].devices[h].channels){d[k.id][n]=
{};for(var p in f[g].devices[h].channels[n].state)d[k.id][n][p]=f[g].devices[h].channels[n].state[p]}d[k.id].reachable="2"==f[g].devices[h].state?!0:!1;break}}a&&a(d)})};e.prototype.getStateValues=function(c,b){return b};e.prototype.executeCommandCreator=function(c,b,a){if(c&&c.address&&c.channels)if(b&&b.value){var d=b.value;if("dimTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command dimTo ext format invalid"));return}d=b.value+b.ext}else if("setTo"==b.value){if("undefined"==
typeof b.ext||null==b.ext){a&&a(Error("command setTo ext format invalid"));return}d=parseFloat(b.ext);d=b.value+2*d}else if("moveTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command moveTo ext format invalid"));return}d=b.value+b.ext}this.executeCommand(c,d,function(f){a&&a(f)})}else a&&a(Error("command json format invalid"));else a&&a(Error("device json format invalid"))};e.prototype.getStatesCreator=function(c,b,a){if(b)if(0==b.length)a&&a(null,[]);else{for(var d=this,f=
[],g=0;g<b.length;g++)if(b[g]&&b[g].device&&b[g].device.address){for(var h=b[g].device.address,l=!1,k=0;k<f.length;k++)if(f[k].address==h){l=!0;break}l||f.push(b[g].device)}this.getStates(c,f,function(n){var p=[];if(n)for(var m=0;m<b.length;m++)if(b[m]&&b[m].id){var q="?";b[m].device&&b[m].device.address&&b[m].status&&b[m].status.value&&n[b[m].device.address]&&(q=d._resolveState(n[b[m].device.address],b[m].status,b[m].device));q||(q="?");p.push({id:b[m].id,status:q})}a&&a(null,p)})}else a&&a(Error("deviceList is null"))};
e.prototype._resolveState=function(c,b,a){if(!c||!b||!b.value)return null;var d,f=c;switch(b.value){case "switchState":c=f.binarySwitch;a=c.state;"0"==a?a="off":"1"==a&&(a="on");break;case "dimState":c=f.multiLevelSwitch;(a=c.level)&&(a=parseInt(a));break;case "tempSet":c=f.temperatureActuator;(a=c.temperature)&&(a=parseFloat(a).toFixed(1));break;case "currentTemp":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"TemperatureSensor"==a.channels[d].type){c=
d;break}c=f[c];(a=c.value)&&(a=parseFloat(a).toFixed(1));break;case "currentHum":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"HumiditySensor"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));break;case "currentBri":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"MotionDetector"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));break;case "waterState":c=
"multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"WaterSensor"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));1==a?a="dry":2==a?a="wet":3==a&&(a="water");break;case "blindState":c=f.blinds;(a=c.level)&&(a=parseInt(a));break;case "meterTotalPower":c=f.meter;(a=c.total)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "meterCurrentPower":c=f.meter;(a=c.current)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "contactState":c=f.binarySensor;
a=c.state;a="true"==a?"open":"closed";break;case "motionState":c=f.binarySensor;a=c.state;a="true"==a?"on":"off";break;case "binaryState":c=f.binarySensor;a=c.state;break;case "reachable":a=c.reachable;break;default:return null}return a};e.prototype.toJSON=function(){return{sys:xnm.aio.qivicon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,uuid:this.uuid}};e.prototype.equalsTo=function(c){return c&&c instanceof e?this.ip==c.ip&&this.port==c.port&&this.user==c.user&&this.password==
c.password:!1};return e}();
xnm.aio.qivicon.DM=function(){var e=function(c,b){this.code=c;this.message=b;this.stack=Error().stack};e.prototype=Error();e.prototype.name="QiviconDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"qivicon",MAP:{binarySwitch:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},multiLevelSwitch:{command:[{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"dim level",ref:{value:"dimState",extMeta:"0-100"}}]},temperatureActuator:{command:[{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-30.0",scale:"0.5"}}],status:[{type:"float",name:"set temperature",ref:{value:"tempSet",extMeta:"5.0-30.0",
scale:"0.5"}}]},multiLevelSensor:{},binarySensor:{},blinds:{command:[{type:"enum",name:"blind stop",ref:{value:"stopMovement"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"blind position",ref:{value:"blindState",extMeta:"0-100"}}]},meter:{status:[{type:"float",name:"total power",ref:{value:"meterTotalPower"}},{type:"float",name:"current power",ref:{value:"meterCurrentPower"}}]},general:{status:[{type:"enum",name:"reachable",ref:{value:"reachable",
options:["true","false"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"QIVICON / Magenta SmartHome",port:443}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"OnOffSocket",name:"Switch"},{sys:this.SYS,type:"Thermostat",name:"Thermostat"},{sys:this.SYS,type:"ColorLight",name:"Color Light"},{sys:this.SYS,type:"BlindsUnit",name:"Blind"},{sys:this.SYS,type:"OnOffMeter",name:"Power Meter Swicth"}]},createGateway:function(c,b,a){b=e.ERROR_CODE;c?c.ip?c.username?c.password?a(null,
c):a(new e(b.INVALID,"password is invalid")):a(new e(b.INVALID,"username is invalid")):a(new e(b.INVALID,"ip is invalid")):a(new e(b.INVALID,"info is invalid"))},updateGateway:function(c,b,a,d){c=e.ERROR_CODE;b?b.ip?b.username?b.password?d(null,b):d(new e(c.INVALID,"password is invalid")):d(new e(c.INVALID,"username is invalid")):d(new e(c.INVALID,"ip is invalid")):d(new e(c.INVALID,"update is invalid"))},deleteGateway:function(c,b,a){a()},createDevice:function(c,b,a){var d=e.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(c.channels)if(b.data&&
b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===c.gateway){var g=b[f];break}g?a(null,c):a(new e(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else a(new e(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else a(new e(d.INVALID,"channels is invalid"));else a(new e(d.INVALID,"type is invalid"));else a(new e(d.INVALID,"address is invalid"));else a(new e(d.INVALID,"gateway is invalid"));else a(new e(d.INVALID,"info is invalid"))},
updateDevice:function(c,b,a){var d=e.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(c.channels)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===c.gateway){var g=b[f];break}g?a(null,c):a(new e(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else a(new e(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else a(new e(d.INVALID,"channels is invalid"));else a(new e(d.INVALID,"type is invalid"));else a(new e(d.INVALID,
"address is invalid"));else a(new e(d.INVALID,"gateway is invalid"));else a(new e(d.INVALID,"info is invalid"))},deleteDevice:function(c,b,a){a()},applyUIFilter:function(c,b){var a=this,d=function(k,n){if("*"==k)return!0;for(var p=!1,m=0;m<k.length;m++)if(k[m]==n){p=!0;break}return p},f=function(k,n,p){var m=[];switch(p.catagory){case "command":k.command&&k.command.forEach(function(q){d(p.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),m.push(q))});break;case "status":k.status&&k.status.forEach(function(q){d(p.elems,
q.type)&&(q=JSON.parse(JSON.stringify(q)),m.push(q))})}return m},g=function(k,n){var p=[],m=a.getCommandStatusMap(k);m&&(k=f(m,k,n),p=p.concat(k));return p};if(!c||null==c.type||"undefined"==typeof c.type)return null;var h=JSON.parse(JSON.stringify(c)),l=null;switch(b.catagory){case "command":l=g(c,b);h.command=l;break;case "status":l=g(c,b);h.status=l;break;default:return null}return l&&0!=l.length?h:null},getCommandStatusMap:function(c){if(!c||!c.channels)return null;var b={command:[],status:[]},
a;for(a in c.channels)if(a&&c.channels.hasOwnProperty(a)){var d=c.channels[a],f=a.indexOf("@");-1!=f&&(a=a.substr(0,f));if(f=this.MAP[a]){var g=c.type;d.type&&(g=d.type);"multiLevelSensor"==a?"Thermostat"==g||"TemperatureSensor"==g?b.status=b.status.concat([{type:"float",name:"current temperature",ref:{value:"currentTemp"}}]):"HumiditySensor"==g?b.status=b.status.concat([{type:"int",name:"current humidity",ref:{value:"currentHum"}}]):"MotionDetector"==g?b.status=b.status.concat([{type:"int",name:"current brightness",
ref:{value:"currentBri"}}]):"WaterSensor"==g&&(b.status=b.status.concat([{type:"enum",name:"water state",ref:{value:"waterState",options:["dry","wet","water"]}}])):"binarySensor"==a?b.status="ContactDetector"==g?b.status.concat([{type:"enum",name:"state",ref:{value:"contactState",options:["open","closed"]}}]):"MotionDetector"==g?b.status.concat([{type:"enum",name:"motion state",ref:{value:"motionState",options:["on","off"]}}]):b.status.concat([{type:"enum",name:"sensor state",ref:{value:"binaryState",
options:["true","false"]}}]):(f&&f.command&&(b.command=b.command.concat(f.command)),f&&f.status&&(b.status=b.status.concat(f.status)))}}b.status=b.status.concat(this.MAP.general.status);return b}}}();xnm.aio.qivicon.Handler=function(){this.detectedHomebases={}};xnm.aio.qivicon.Handler.prototype.HomeBase=xnm.aio.qivicon.HomeBase;xnm.aio.qivicon.Handler.prototype.devicemanager=xnm.aio.qivicon.DM;xnm.aio.qivicon.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"qivicon")};
xnm.aio.qivicon.Handler.prototype.resolveGateway=function(e){return e&&e.ip?new xnm.aio.qivicon.HomeBase(e.ip,e.port,e.username,e.password,e.uuid):null};xnm.aio.qivicon.Handler.prototype.getDeviceCommands=function(e,c){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}))?e.command:[];c&&c(null,e)};xnm.aio.qivicon.Handler.prototype.getDeviceStatus=function(e,c){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];c&&c(null,e)};
xnm.aio.qivicon.Handler.prototype.doCommand=function(e,c,b,a){(e=this.resolveGateway(e))?e.executeCommandCreator(c,b,function(d){a&&a(d)}):a&&a(Error("gateway json format invalid"))};xnm.aio.qivicon.Handler.prototype.doStatus=function(e,c,b,a,d){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:e,device:b,status:a}],function(f,g){f?d&&d(f):d&&d(null,g[0])}):d&&d(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.discoverWithTimeout=function(e,c){var b={};this.discoverHomeBases(function(a){a&&a.uuid&&!b[a.uuid]&&(b[a.uuid]=a)});setTimeout(function(){var a=[],d;for(d in b)b.hasOwnProperty(d)&&a.push(b[d]);c&&c(null,a)},e)};
xnm.aio.qivicon.Handler.prototype.discoverHomeBases=function(e){var c=require("x.upnp.js");if(c){var b=this;c.discoverDevices(function(a){if(0==a.name.toLowerCase().indexOf("qivicon")){var d=new xnm.aio.qivicon.HomeBase(a.ip,443,null,null,a.uuid);b.detectedHomebases["uuid:"+a.uuid]||(b.detectedHomebases["uuid:"+a.uuid]=d);e(d)}})}};xnm.aio.qivicon.Handler.prototype.getDeviceList=function(e,c){(e=this.resolveGateway(e))?e.getDevices(function(b,a){c&&c(b,a)}):c&&c(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.getStateValues=function(e,c){return(new xnm.aio.qivicon.HomeBase).getStateValues(e.type,c)};
xnm.aio.qivicon.Handler.prototype.getDeviceCommandList=function(e,c,b){var a=[];if(c)a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"});else if(b&&e.channels)for(var d in e.channels)"binarySwitch"==d?(a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"})):"multiLevelSwitch"==d?(a.push({id:"dimUp",cmd:"dimUp"}),a.push({id:"dimDown",cmd:"dimDown"}),a.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"temperatureActuator"==
d?a.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5",max:"30",fact:"2"}):"blinds"==d&&(a.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"}),a.push({id:"stop",cmd:"stopMovement"}));return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.qivicon.Handler);
