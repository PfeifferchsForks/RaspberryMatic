var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloud=xnm.aio.cloud||{};xnm.aio.cloud.Server=function(){this._url="http://webservice.aio-control.com/config?"};xnm.aio.cloud.Server.prototype._doRequest=function(d,b){$.ajax({url:this._url+d,timeout:4E3,cache:!1,success:function(a){var c=null;a&&8<=a.length&&"{XC_SUC}"==a.substr(0,8)?c=8<a.length?{data:$.parseJSON(a.substr(8))}:{data:{}}:a&&8<a.length&&"{XC_ERR}"==a.substr(0,8)&&(c={error:a.substr(8)});b&&b(c)},error:function(){b&&b(null)}})};
xnm.aio.cloud.Server.prototype.doRequest=function(d,b,a){d="XC_FNC="+d;if(b)for(var c in b)d+="&"+c+"="+b[c];this._doRequest(d,a)};xnm.aio.cloud.Server.prototype.getNewSID=function(d){this._doRequest("XC_FNC=getSID",d)};xnm.aio.cloud.Server.prototype.getEleroKey=function(d,b){this._doRequest("XC_FNC=getEleroKey&SID="+d,b)};
xnm.aio.cloud.Server.prototype.setMessage=function(d,b,a,c,e,f,m){a=JSON.stringify({email:a,message:c,username:m});d=this._url+"XC_FNC=setMessage&SID="+d+"&AID="+b;f&&(d+="&sns="+f);$.ajax({type:"POST",url:d,data:{data:a},timeout:4E3,cache:!1,complete:function(k){k&&(k=k.responseText);k&&8<=k.length&&"{XC_SUC}"==k.substr(0,8)?e(!0):e(!1)}})};xnm.aio.cloud.Server.prototype.getMessage=function(d,b,a){this._doRequest("XC_FNC=getMessage&SID="+d+"&AID="+b,a)};
xnm.aio.cloud.Server.prototype.assignBeckerSeiral=function(d,b){var a=b;$.ajax({url:this._url+"/beckerserial/assign?sid="+d.toUpperCase(),timeout:4E3,dataType:"text",cache:!0,success:function(c){try{var e=JSON.parse(c);if("no more available"==e.serial){var f=Error(e.serial);f.errCode=-1;a&&a(f)}else a&&a(null,e.serial)}catch(m){a&&a(m)}a=null},error:function(c,e){c="http request error:"+(c?c.status:"0")+"-"+e;a&&a(Error(c))}})};
xnm.aio.cloud.RemotesServer=function(){this.ip="https://remotes.mediola.com";this.port=443;this.password=this.user="";this.secure=!0;this.folder="";this._finishedDownloadCallback=this._error=this._remotes=null};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFile=function(d){var b=this.secure?"https://":"http://";b+=this.ip+":"+this.port+"/creatorneo/remote/requestDownload";if(this.secure)this._getUpdateFileHttps(d);else{var a=d;$.ajax({type:"GET",url:b,timeout:8E3,cache:!1,dataType:"json",headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(c){a&&(a(null,c,200),a=null)},error:function(c,e,f){e="HTTP request error: "+(c?c.status:"0")+"-"+e;a&&(a(Error(e),
c?c.responseText:null,c?c.status:null),a=null)}})}};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFileHttps=function(d){"object"===typeof process&&null!==process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var b=d;$.ajax({type:"GET",url:"https://"+this.ip+":"+this.port+"/creatorneo/remote/requestDownload",timeout:8E3,cache:!1,dataType:"json",headers:{"Content-Type":"application/json; charset=utf-8",Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(a){b&&(b(null,a,200),b=null)},
error:function(a,c,e){c="HTTPS request error: "+(a?a.status:"0")+"-"+c;b&&(b(Error(c),a?a.responseText:null,a?a.status:null),b=null)}})};xnm.aio.cloud.RemotesServer.prototype._moveFromTmp=function(d,b,a){var c=require("fs"),e=c.createReadStream(d);b=c.createWriteStream(b);e.pipe(b);e.on("error",function(f){XC.debugf("[xnm.aio.cloud.RemotesServer._moveFromTmp] "+f.message,"error");a&&a(f)});e.on("end",function(){c.unlinkSync(d);a&&a()})};
xnm.aio.cloud.RemotesServer.prototype._downloadFile=function(d,b,a,c){var e=require("http"),f=require("fs"),m={fileData:a,url:{username:this.user,password:this.password}},k=this,q=null;q="object"===typeof nw?function(g,l){g?f.stat(g,function(h,C){if(h)c(h);else{if("win32"===process.platform&&(h=b.substring(b.lastIndexOf("/")+1),/[<>:"|?*]/.test(h))){h=Error('Invalid characters (<>:"|?*) in filename, which cannot be used on Windows: '+h);XC.debugf("[xnm.aio.cloud.RemotesServer._downloadFile] "+h.message,
"error");c(h);return}h=b.substring(0,b.lastIndexOf("/"));f.mkdirRecursiveSync(h);k._moveFromTmp(g,b,function(u){u?c(u):f.writeFile(b+".md5",a.md5,function(n){c(n)})})}}):c(l?l:Error("file from mediola server error"))}:function(g,l){g&&f.existsSync(g)?(l=b.substring(0,b.lastIndexOf("/")),f.mkdirRecursiveSync(l),f.renameSync(g,b),c()):c(l?l:Error("file from mediola server error"))};var r=window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()||"Android"==window.XCHost.getType());if(this._aws3Client&&
a&&a.file.match(/^resources.*/))d={Bucket:"mediola-creator",Key:"resources/"+a.ref},e=null,r||(e=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep+Math.random().toString(36).substring(2)),this._aws3Client.getObject2File(d,e,function(g,l){g?(XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] failed to download file from S3: "+a.file),XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] "+g.message),q(null,Error("S3:"+g.message))):q(l)});else{var v=e.getFileAIOCloud;r&&(m={},
d+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password),v=e.getFileUriEncoded);v(d,m,q)}};
xnm.aio.cloud.RemotesServer.prototype._encryptFile=function(d,b){if("undefined"==typeof nw)b();else{var a=require("fs");a.readFile(d,"utf8",function(c,e){!c&&e?(c=require("m.aio.devicemanager.js"),e=require("x.crypt.js").AES.encodeString(e,c.ml_v1_info()),a.writeFile(d+".enc",e,function(f){f?(XC.debugf("[xnm.aio.cloud.RemotesServer._encryptFile] "+f.message,"error"),b&&b("crypt write file")):(a.unlinkSync(d),b&&b())})):b&&b("crypt read file")})}};
xnm.aio.cloud.RemotesServer.prototype._checkFile=function(d,b,a,c,e){for(var f=this._remotesPath+"_new/"+d+"/"+c.file,m=this.secure?"https://":"http://",k=c.ref.split("/"),q="",r=0;r<k.length;r++)q+=encodeURIComponent(k[r]),r<k.length-1&&(q+="/");m+=this.ip+":"+this.port+"/creatorneo/remote/downloadFile/"+q;var v=!1,g=require("fs"),l=this._remotesPath+"/"+d+"/"+c.file,h=this;d=c.file.indexOf(".DS_Store");-1<d&&d+9==c.file.length?e():g.readFile(l+".md5","utf8",function(C,u){if(!C&&u&&u==c.md5&&"device_db"!==
c.file)try{g.copyFileSync(l,f),g.copyFileSync(l+".md5",f+".md5"),v=!0}catch(n){XC.debugf("[xnm.aio.cloud.RemotesServer._checkFile] "+n.message,"warn")}v?e():h._downloadFile(m,f,c,function(n){var p=!0;if("device_db"==c.file&&b)p=!1,g.readFile(f,"utf8",function(t,w){!t&&w?(t=require("x.crypt.js").AES.decodeString(w,b),g.writeFile(f,t,function(y){h._encryptFile(f,e)})):e("crypt")});else if("device_db"==c.file&&a&&(p=!1,g.readFile(f,"utf8",function(t,w){if(!t&&w){var y=!1;require("xnm.aio.hm.js").discoverCCUs(function(z){if(!y){y=
!0;var x=JSON.parse(w);if(x&&x.gateways)for(var B=0;B<x.gateways.length;B++){var A=x.gateways[B];A.info&&"hm"==A.info.sys&&(A.info.uuid=z.uuid,A.info.ip=z.ip)}z=JSON.stringify(x);g.writeFile(f,z,function(D){g.existsSync(f+".md5")&&g.unlinkSync(f+".md5");h._encryptFile(f,e)})}});setTimeout(function(){y||e("noCCU")},1E3)}else e("file")})),"device_db"===c.file&&(p=!1,h._encryptFile(f,e)),p)if(n){p="[File] ";if(n instanceof Error)p+=n.message;else if("string"===typeof n)p+=n;else if("object"===typeof n)try{p+=
JSON.stringify(n)}catch(t){p+="Error object cannot be converted to string."}e(Error(p))}else e()})})};
xnm.aio.cloud.RemotesServer.prototype._downloadNextFile=function(d,b){"undefined"===typeof d&&(d=0);"undefined"===typeof b&&(b=0);0===d&&0===b&&(this._remoteNames=[]);0===this._remotes.length&&(this._remoteNames=null);if(d>=this._remotes.length)XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Downloaded all remotes."),setTimeout(function(){this._renameRemoteDir(this._remoteNames)}.bind(this),100);else{this._$progressDiv&&this._$progressDiv.text(Math.floor(this._filesDownloaded/this._filesToDownload*
100)+"%");var a=this._remotes[d];0===b&&(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Download next remote: "+a.name),this._remoteNames.push(a.name));"function"===typeof this.cbProgress&&this.cbProgress(d,a.name,Math.floor(100*b/(a.resources.length+b)),Math.floor(this._filesDownloaded/this._filesToDownload*100));0<a.resources.length?(this._filesDownloaded++,this._checkFile(a.name,a.pwd,a.replaceCCU,a.resources[0],function(c){c?(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Check file error: "+
c,"error"),this._error=c,this._remotes=[]):this._remotes[d].resources.splice(0,1);this._downloadNextFile(d,b+1)}.bind(this))):this._downloadNextFile(d+1,0)}};
xnm.aio.cloud.RemotesServer.prototype._renameRemoteDir=function(d){XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Renaming directory ...");if(d){var b=require("fs"),a=this._remotesPath+"_"+(new Date).getTime();b.existsSync(this._remotesPath)&&b.renameSync(this._remotesPath,a);try{b.renameSync(this._remotesPath+"_new",this._remotesPath)}catch(c){XC.debugf(c.message),b.renameSync(a,this._remotesPath)}b.existsSync(a)&&b.rmdirRecursiveSync(a);d.sort(function(c,e){return c.localeCompare(e)})}XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] ... renamed directory.");
this._finishedDownloadCallback&&(XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Calling callback for finished download."),this._finishedDownloadCallback(d,this._error))};
xnm.aio.cloud.RemotesServer.prototype._checkPasswords=function(){for(var d=this,b=0;b<this._remotes.length;b++){var a=this._remotes[b];if(a.encrypt&&!a.pwd){this._passwordCallback(a.name,function(c){var e=!1;null!=c?require("x.crypt.js").AES.decodeString(a.encrypt,c)==a.name?a.pwd=c:(d._remotes.splice(b,1),e=!0):(d._remotes.splice(b,1),e=!0);e&&(a.pwdFailed=!0);d._checkPasswords()});return}}for(b=this._filesToDownload=this._filesDownloaded=0;b<this._remotes.length;b++)this._filesToDownload+=this._remotes[b].resources.length;
this._downloadNextFile(0,0)};
xnm.aio.cloud.RemotesServer.prototype.updateRemotes=function(d,b,a){this._error=null;this._passwordCallback=a;this._$progressDiv=d;d=require("fs");this._remotesPath="object"===typeof nw?require("path").join(nw.App.dataPath,"..","remotes"):d.dataPath()+"/remotes";try{d.mkdirRecursiveSync(this._remotesPath)}catch(c){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+this._remotesPath+'". Error: '+c.message,"error")}try{d.mkdirRecursiveSync(this._remotesPath+"_new")}catch(c){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+
this._remotesPath+'_new". Error: '+c.message)}this._getUpdateFile(function(c,e,f){this._aws3Client=null;c?b&&b(null,Error("[File List] "+c.message),f):e&&"error"==e.classid?b&&b(null,e.code,f):e&&e.infos?(e.credential&&(c=require("x.aws"))&&(this._aws3Client=c.getS3Client(e.credential)),this._remotes=e.infos,this._finishedDownloadCallback=function(m,k){this._aws3Client&&this._aws3Client.release();b&&b(m,k)}.bind(this),this._checkPasswords()):b&&b(null,null,f)}.bind(this))};xnm.aio.cloud.Handler=function(){XC.debugf("xnm.aio.cloud.Handler created")};
xnm.aio.cloud.Handler.prototype.Server=xnm.aio.cloud.Server;xnm.aio.cloud.Handler.prototype.RemotesServer=xnm.aio.cloud.RemotesServer;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloud.Handler);
