var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(k,f,e){if(null==k)throw new TypeError("The 'this' value for String.prototype."+e+" must not be null or undefined");if(f instanceof RegExp)throw new TypeError("First argument to String.prototype."+e+" must not be a regular expression");return k+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,f,e){if(k==Array.prototype||k==Object.prototype)return k;k[f]=e.value;return k};
$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var f=0;f<k.length;++f){var e=k[f];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,f){var e=$jscomp.propertyToPolyfillSymbol[f];if(null==e)return k[f];e=k[e];return void 0!==e?e:k[f]};$jscomp.polyfill=function(k,f,e,c){f&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,f,e,c):$jscomp.polyfillUnisolated(k,f,e,c))};
$jscomp.polyfillUnisolated=function(k,f,e,c){e=$jscomp.global;k=k.split(".");for(c=0;c<k.length-1;c++){var b=k[c];if(!(b in e))return;e=e[b]}k=k[k.length-1];c=e[k];f=f(c);f!=c&&null!=f&&$jscomp.defineProperty(e,k,{configurable:!0,writable:!0,value:f})};
$jscomp.polyfillIsolated=function(k,f,e,c){var b=k.split(".");k=1===b.length;c=b[0];c=!k&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var a=0;a<b.length-1;a++){var d=b[a];if(!(d in c))return;c=c[d]}b=b[b.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?c[b]:null;f=f(e);null!=f&&(k?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:f}):f!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[b]&&(e=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(b):$jscomp.POLYFILL_PREFIX+e+"$"+b),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[b],{configurable:!0,writable:!0,value:f})))};$jscomp.polyfill("String.prototype.repeat",function(k){return k?k:function(f){var e=$jscomp.checkStringArgs(this,null,"repeat");if(0>f||1342177279<f)throw new RangeError("Invalid count value");f|=0;for(var c="";f;)if(f&1&&(c+=e),f>>>=1)e+=e;return c}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.heos=xnm.aio.heos||{};
xnm.aio.heos.HEOS=function(){var k=function(f){this._ip=f.ip;this._port=f.port;this._username=f.username;this._password=f.password;this._uuid=f.uuid;this._port||(this._port=1255);this._controller=require("xnm.aio.heos.js").getController()};k.prototype.executeCommandCreator=function(f,e,c){if(f&&f.type)if(e&&e.value){var b=null;if("player"==f.type){if(!f.pid){c&&c(Error("invalid player pid"));return}b=f.pid}else if("group"==f.type){if(!f.gid){c&&c(Error("invalid group gid"));return}b=f.gid}else c&&
c(Error("unknown device type"));var a=function(d){!d||-5!=d.code&&-6!=d.code||(d.source="heos");c&&c(d)};switch(e.value){case "play":this.play(b,a);break;case "pause":this.pause(b,a);break;case "stop":this.stop(b,a);break;case "previous":this.previous(b,a);break;case "next":this.next(b,a);break;case "toggleMute":"player"==f.type?this.togglePlayerMute(b,a):this.toggleGroupMute(b,a);break;case "mute":"player"==f.type?this.playerMute(b,!0,a):this.groupMute(b,!0,a);break;case "unmute":"player"==f.type?
this.playerMute(b,!1,a):this.groupMute(b,!1,a);break;case "volume":if("undefined"==typeof e.ext||null==e.ext){c&&c(Error("invalid volume value"));break}e=parseInt(e.ext);if(isNaN(e)){c&&c(Error("invalid volume value"));break}"player"==f.type?this.setPlayerVolume(b,e,a):this.setGroupVolume(b,e,a);break;case "volumeUp":"player"==f.type?this.playerVolumeUp(b,a):this.groupVolumeUp(b,a);break;case "volumeDown":"player"==f.type?this.playerVolumeDown(b,a):this.groupVolumeDown(b,a);break;case "shuffleOn":this.shuffle(b,
"on",a);break;case "shuffleOff":this.shuffle(b,"off",a);break;case "shuffleToggle":this.toggleShuffle(b,a);break;case "repeatOff":this.repeat(b,"off",a);break;case "repeatAll":this.repeat(b,"on_all",a);break;case "repeatOne":this.repeat(b,"on_one",a);break;case "repeatSwitch":this.switchRepeat(b,a);break;case "playUrl":if("undefined"==typeof e.ext||null==e.ext){c&&c(Error("invalid url value"));break}this.playUrl(b,e.ext,a);break;case "clearQueue":this.clearQueue(b,a);break;default:c&&c(Error("unknonw command"))}}else c&&
c(Error("device json invalid"));else c&&c(Error("device json invalid"))};k.prototype.getStatesCreator=function(f,e,c){var b=this,a=function(n,m,r,t){switch(r){case "mute":"player"==n?b.isPlayerMute(m,function(q,u){t(q,u,n,m,r)}):b.isGroupMute(m,function(q,u){t(q,u,n,m,r)});break;case "level":"player"==n?b.getPlayerVolume(m,function(q,u){t(q,u,n,m,r)}):b.getGroupVolume(m,function(q,u){t(q,u,n,m,r)});break;case "shuffle":b.getShuffle(m,function(q,u){t(q,u,n,m,r)});break;case "repeat":b.getRepeat(m,
function(q,u){t(q,u,n,m,r)});break;case "play_state":b.getPlayState(m,function(q,u){t(q,u,n,m,r)});break;case "playing_media":b.getPlayingMedia(m,function(q,u){t(q,u,n,m,r)});break;case "duration":b.getPlayingProgress(m,function(q,u,p){t(q,p,n,m,r)});break;case "cur_pos":b.getPlayingProgress(m,function(q,u,p){t(q,u,n,m,r)})}},d=[],g=function(n,m){for(var r=[],t=0;t<n.length;t++){var q=n[t];if(q&&q.id)if(q.device&&q.device.type&&q.status&&q.status.value){var u=q.device.type,p="player"==u?q.device.pid:
q.device.gid,v=null;switch(q.status.value){case "muted":v="mute";break;case "volume":v="level";break;case "shuffle":v="shuffle";break;case "repeat":v="repeat";break;case "playState":v="play_state";break;case "artist":case "title":case "album":v="playing_media";break;case "duration":case "durationS":v="duration";break;case "position":case "positionS":v="cur_pos"}q=!1;for(var x=0;x<r.length;x++){var w=r[x];w.type==u&&w.id==p&&w.key==v&&(q=!0)}q||r.push({type:u,id:p,key:v})}else m.push({id:q.id,status:"?"})}return r}(e,
d);if(0!=g.length){var h=0,l=function(n,m,r,t,q){if(!n){n=[];for(var u=0;u<e.length;u++){var p=e[u];if(p&&p.id&&p.device&&p.status&&p.status.value){var v="player"==r?p.device.pid:p.device.gid;if(r==p.device.type&&t==v)switch(q){case "mute":"muted"==p.status.value&&(d.push({id:p.id,status:m}),n.push({id:p.id,status:m}));break;case "level":"volume"==p.status.value&&(d.push({id:p.id,status:m}),n.push({id:p.id,status:m}));break;case "shuffle":"shuffle"==p.status.value&&(d.push({id:p.id,status:m?m:"?"}),
n.push({id:p.id,status:m?m:"?"}));break;case "repeat":"repeat"==p.status.value&&(d.push({id:p.id,status:m?m:"?"}),n.push({id:p.id,status:m?m:"?"}));break;case "play_state":"playState"==p.status.value&&(d.push({id:p.id,status:m?m:"?"}),n.push({id:p.id,status:m?m:"?"}));break;case "playing_media":"artist"==p.status.value?(d.push({id:p.id,status:m?m.artist:"?"}),n.push({id:p.id,status:m?m.artist:"?"})):"title"==p.status.value?(d.push({id:p.id,status:m?m.title:"?"}),n.push({id:p.id,status:m?m.title:"?"})):
"album"==p.status.value&&(d.push({id:p.id,status:m?m.album:"?"}),n.push({id:p.id,status:m?m.album:"?"}));break;case "duration":if("durationS"==p.status.value)d.push({id:p.id,status:isNaN(m)?0:Math.round(m/1E3)}),n.push({id:p.id,status:isNaN(m)?0:Math.round(m/1E3)});else if("duration"==p.status.value)if(null==m)d.push({id:p.id,status:"?"}),n.push({id:p.id,status:"?"});else{v=Math.floor(m/6E4);var x=Math.round(m%6E4/1E3),w=x+"";2!=w.length&&(w="0"+x);d.push({id:p.id,status:v+":"+w});n.push({id:p.id,
status:v+":"+w})}break;case "cur_pos":"positionS"==p.status.value?(d.push({id:p.id,status:isNaN(m)?0:Math.round(m/1E3)}),n.push({id:p.id,status:isNaN(m)?0:Math.round(m/1E3)})):"position"==p.status.value&&(null==m?(d.push({id:p.id,status:"?"}),n.push({id:p.id,status:"?"})):(v=Math.floor(m/6E4),x=Math.round(m%6E4/1E3),w=x+"",2!=w.length&&(w="0"+x),d.push({id:p.id,status:v+":"+w}),n.push({id:p.id,status:v+":"+w})))}}}0<n.length&&"undefined"!=typeof f&&null!=f&&"undefined"!=typeof f.reportStates&&null!=
f.reportStates&&f.reportStates(null,n)}h++;h<g.length?a(g[h].type,g[h].id,g[h].key,l):c&&c(null,d)};a(g[h].type,g[h].id,g[h].key,l)}};k.prototype.play=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(f,"play",e)};k.prototype.pause=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(f,"pause",e)};k.prototype.stop=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());
this._controller.setPlayerState(f,"stop",e)};k.prototype.previous=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayPrevious(f,e)};k.prototype.next=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayNext(f,e)};k.prototype.playerMute=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMute(f,e?"on":"off",c)};k.prototype.togglePlayerMute=
function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.togglePlayerMute(f,e)};k.prototype.groupMute=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setGroupMute(f,e?"on":"off",c)};k.prototype.toggleGroupMute=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.toggleGroupMute(f,e)};k.prototype.setPlayerVolume=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());
100<e&&(e=100);0>e&&(e=0);this._controller.setPlayerVolume(f,e,c)};k.prototype.setGroupVolume=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());100<e&&(e=100);0>e&&(e=0);this._controller.setGroupVolume(f,e,c)};k.prototype.playerVolumeUp=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeUp(f,null,e)};k.prototype.playerVolumeDown=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeDown(f,
null,e)};k.prototype.clearQueue=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerClearQueue(f,e)};k.prototype.groupVolumeUp=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeUp(f,null,e)};k.prototype.groupVolumeDown=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeDown(f,null,e)};k.prototype.shuffle=function(f,e,c){this._controller.isIdle()&&
this._controller.open(this.toJSON());this._controller.setPlayerMode(f,null,e,c)};k.prototype.toggleShuffle=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());var c=this;this._controller.getPlayerMode(f,function(b,a,d){b?e&&e(b):(b="off","off"==d&&(b="on"),c._controller.setPlayerMode(f,null,b,e))})};k.prototype.repeat=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMode(f,e,null,c)};k.prototype.switchRepeat=function(f,
e){this._controller.isIdle()&&this._controller.open(this.toJSON());var c=this;this._controller.getPlayerMode(f,function(b,a,d){b?e&&e(b):(b="off","off"==a?b="on_all":"on_all"==a&&(b="on_one"),c._controller.setPlayerMode(f,b,null,e))})};k.prototype.getShuffle=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(f,function(c,b,a){e&&e(c,a)})};k.prototype.getRepeat=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(f,
function(c,b,a){c?e&&e(c):(a=null,"on_all"==b?a="all":"on_one"==b?a="one":"off"==b&&(a="off"),e&&e(c,a))})};k.prototype.getPlayState=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerState(f,function(c,b){e&&e(c,b)})};k.prototype.getPlayingMedia=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingMedia(f,function(c,b){c?e&&e(c):(c=null,b&&(c=JSON.parse(JSON.stringify(b)),c.title=b.song),
e&&e(null,c))})};k.prototype.getPlayingProgress=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingProgress(f,function(c,b,a){e&&e(c,b,a)})};k.prototype.getPlayers=function(f){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayers(f)};k.prototype.isPlayerMute=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMute(f,function(c,b){c?e&&e(c):(c=null,
"on"==b?c=!0:"off"==b&&(c=!1),e&&e(null,c))})};k.prototype.getPlayerVolume=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerVolume(f,function(c,b){e&&e(c,b)})};k.prototype.getGroups=function(f){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroups(f)};k.prototype.isGroupMute=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupMute(f,function(c,b){c?e&&e(c):
e&&e(null,"on"==b?!0:!1)})};k.prototype.getGroupVolume=function(f,e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupVolume(f,function(c,b){e&&e(c,b)})};k.prototype.playUrl=function(f,e,c){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayURL(f,e,c)};k.prototype.toJSON=function(){return{sys:"heos",ip:this._ip,port:this._port,username:this._username,password:this._password,uuid:this._uuid}};k.prototype.equalsTo=function(f){return f&&
f instanceof k?this.ip==f.ip&&this.port==f.port:!1};k.parseJSON=function(f){return f&&f.ip?new k(f):null};return k}();
xnm.aio.heos._Controller=function(){var k=function(){this._stateExpiredTime=300;this._errorStateExpiredTime=10;this._playerBuffer={};this._groupBuffer={}};k.prototype.reset=function(){this._playerBuffer={};this._groupBuffer={}};k.prototype.removePlayerState=function(c,b){var a=this._playerBuffer[c];a||(this._playerBuffer[c]={},a=this._playerBuffer[c]);a[b]=null};k.prototype.putPlayerState=function(c,b,a){var d=this._playerBuffer[c];d||(this._playerBuffer[c]={},d=this._playerBuffer[c]);c=d[b];c||(d[b]=
{},c=d[b]);c.update=Math.round((new Date).getTime()/1E3);c.value=a};k.prototype.getPlayerState=function(c,b){var a=this._playerBuffer[c];a||(this._playerBuffer[c]={},a=this._playerBuffer[c]);c=a[b];c||(a[b]={},c=a[b]);if("cur_pos"==b||"duration"==b)return c.value?c.value:null;b=Math.round((new Date).getTime()/1E3);if(!c.update||null==c.value&&b-c.update>this._errorStateExpiredTime||b-c.update>this._stateExpiredTime)c.update=b,c.value=null;else return c.value};k.prototype.getPlayerStateRaw=function(c,
b){var a=this._playerBuffer[c];a||(this._playerBuffer[c]={},a=this._playerBuffer[c]);c=a[b];c||(a[b]={},c=a[b]);return c.value};k.prototype.removeGroupState=function(c,b){var a=this._groupBuffer[c];a||(this._groupBuffer[c]={},a=this._groupBuffer[c]);a[b]=null};k.prototype.putGroupState=function(c,b,a){var d=this._groupBuffer[c];d||(this._groupBuffer[c]={},d=this._groupBuffer[c]);c=d[b];c||(d[b]={},c=d[b]);c.update=Math.round((new Date).getTime()/1E3);c.value=a};k.prototype.getGroupState=function(c,
b){var a=this._groupBuffer[c];a||(this._groupBuffer[c]={},a=this._groupBuffer[c]);c=a[b];c||(a[b]={},c=a[b]);b=Math.round((new Date).getTime()/1E3);if(!c.update||null==c.value&&b-c.update>this._errorStateExpiredTime||b-c.update>this._stateExpiredTime)c.update=b,c.value=null;else return c.value};k.prototype.getGroupStateRaw=function(c,b){var a=this._groupBuffer[c];a||(this._groupBuffer[c]={},a=this._groupBuffer[c]);c=a[b];c||(a[b]={},c=a[b]);return c.value};var f=function(){var c=function(b){this._controller=
b};c.prototype.getPlayers=function(b){this._doRequest({path:"player/get_players"},null,function(a,d,g){b&&b(a,g)})};c.prototype.getPlayerState=function(b,a){this._doRequest({path:"player/get_play_state",attributes:{pid:b}},null,function(d,g){d?a&&a(d):g&&"undefined"!=typeof g.state&&null!=g.state?a&&a(null,g.state):a&&a(Error("invalid get player state reponse"))})};c.prototype.setPlayerState=function(b,a,d){this._doRequest({path:"player/set_play_state",attributes:{pid:b,state:a}},null,function(g,
h){g?d&&d(g):h&&"undefined"!=typeof h.state&&null!=h.state?d&&d(null,h.state):d&&d(Error("invalid get player state reponse"))})};c.prototype.getPlayerNowPlayingMedia=function(b,a){this._doRequest({path:"player/get_now_playing_media",attributes:{pid:b}},null,function(d,g,h){d?a&&a(d):h?a&&a(null,h):a&&a(Error("invalid now playing media reponse"))})};c.prototype.getPlayerVolume=function(b,a){this._doRequest({path:"player/get_volume",attributes:{pid:b}},null,function(d,g){d?a&&a(d):g&&"undefined"!=typeof g.level&&
null!=g.level?(d=parseInt(g.level),isNaN(d)?a&&a(Error("invalid get player volume reponse")):a&&a(null,d)):a&&a(Error("invalid get player volume reponse"))})};c.prototype.setPlayerVolume=function(b,a,d){this._doRequest({path:"player/set_volume",attributes:{pid:b,level:a}},null,function(g,h){g?d&&d(g):h&&"undefined"!=typeof h.level&&null!=h.level?(g=parseInt(h.level),isNaN(g)?d&&d(Error("invalid set player volume reponse")):d&&d(null,g)):d&&d(Error("invalid set player volume reponse"))})};c.prototype.playerVolumeUp=
function(b,a,d){b={path:"player/volume_up",attributes:{pid:b}};a&&(b.attributes.step=a);this._doRequest(b,null,function(g,h){g?d&&d(g):h&&"undefined"!=typeof h.step&&null!=h.step?(g=parseInt(h.step),isNaN(g)?d&&d(Error("invalid player volume up reponse")):d&&d(null,g)):d&&d(Error("invalid player volume up reponse"))})};c.prototype.playerVolumeDown=function(b,a,d){b={path:"player/volume_down",attributes:{pid:b}};a&&(b.attributes.step=a);this._doRequest(b,null,function(g,h){g?d&&d(g):h&&"undefined"!=
typeof h.step&&null!=h.step?(g=parseInt(h.step),isNaN(g)?d&&d(Error("invalid player volume down reponse")):d&&d(null,g)):d&&d(Error("invalid player volume down reponse"))})};c.prototype.getPlayerMute=function(b,a){this._doRequest({path:"player/get_mute",attributes:{pid:b}},null,function(d,g){d?a&&a(d):g&&g.state?a&&a(null,g.state):a&&a(Error("invalid get player mute reponse"))})};c.prototype.setPlayerMute=function(b,a,d){this._doRequest({path:"player/set_mute",attributes:{pid:b,state:a}},null,function(g,
h){g?d&&d(g):h&&h.state?d&&d(null,h.state):d&&d(Error("invalid set player mute reponse"))})};c.prototype.togglePlayerMute=function(b,a){this._doRequest({path:"player/toggle_mute",attributes:{pid:b}},null,function(d,g){d?a&&a(d):a&&a(null)})};c.prototype.getPlayerMode=function(b,a){this._doRequest({path:"player/get_play_mode",attributes:{pid:b}},null,function(d,g){d?a&&a(d):g&&g.repeat&&g.shuffle?a&&a(null,g.repeat,g.shuffle):a&&a(Error("invalid get player mute reponse"))})};c.prototype.setPlayerMode=
function(b,a,d,g){b={path:"player/set_play_mode",attributes:{pid:b}};a&&(b.attributes.repeat=a);d&&(b.attributes.shuffle=d);this._doRequest(b,null,function(h,l){h?g&&g(h):l&&(l.repeat||l.shuffle)?g&&g(null,l.repeat,l.shuffle):g&&g(Error("invalid set player mode reponse"))})};c.prototype.playerClearQueue=function(b,a){this._doRequest({path:"player/clear_queue",attributes:{pid:b}},null,function(d){a&&a(d)})};c.prototype.playerPlayNext=function(b,a){this._doRequest({path:"player/play_next",attributes:{pid:b}},
null,function(d){a&&a(d)})};c.prototype.playerPlayPrevious=function(b,a){this._doRequest({path:"player/play_previous",attributes:{pid:b}},null,function(d){a&&a(d)})};c.prototype.getGroups=function(b){this._doRequest({path:"player/get_groups"},null,function(a,d,g){b&&b(a,g)})};c.prototype.getGroupVolume=function(b,a){this._doRequest({path:"group/get_volume",attributes:{gid:b}},null,function(d,g){d?a&&a(d):g&&"undefined"!=typeof g.level&&null!=g.level?(d=parseInt(g.level),isNaN(d)?a&&a(Error("invalid get group volume reponse")):
a&&a(null,d)):a&&a(Error("invalid get group volume reponse"))})};c.prototype.setGroupVolume=function(b,a,d){this._doRequest({path:"group/set_volume",attributes:{gid:b,level:a}},null,function(g,h){g?d&&d(g):h&&"undefined"!=typeof h.level&&null!=h.level?(g=parseInt(h.level),isNaN(g)?d&&d(Error("invalid set group volume reponse")):d&&d(null,g)):d&&d(Error("invalid set group volume reponse"))})};c.prototype.groupVolumeUp=function(b,a,d){b={path:"group/volume_up",attributes:{gid:b}};a&&(b.attributes.step=
a);this._doRequest(b,null,function(g,h){g?d&&d(g):h&&"undefined"!=typeof h.step&&null!=h.step?(g=parseInt(h.step),isNaN(g)?d&&d(Error("invalid group volume up reponse")):d&&d(null,g)):d&&d(Error("invalid group volume up reponse"))})};c.prototype.groupVolumeDown=function(b,a,d){b={path:"group/volume_down",attributes:{gid:b}};a&&(b.attributes.step=a);this._doRequest(b,null,function(g,h){g?d&&d(g):h&&"undefined"!=typeof h.step&&null!=h.step?(g=parseInt(h.step),isNaN(g)?d&&d(Error("invalid group volume down reponse")):
d&&d(null,g)):d&&d(Error("invalid group volume down reponse"))})};c.prototype.getGroupMute=function(b,a){this._doRequest({path:"group/get_mute",attributes:{gid:b}},null,function(d,g){d?a&&a(d):g&&g.state?a&&a(null,g.state):a&&a(Error("invalid get group mute reponse"))})};c.prototype.setGroupMute=function(b,a,d){this._doRequest({path:"group/set_mute",attributes:{gid:b,state:a}},null,function(g,h){g?d&&d(g):h&&h.state?d&&d(null,h.state):d&&d(Error("invalid set group mute reponse"))})};c.prototype.toggleGroupMute=
function(b,a){this._doRequest({path:"group/toggle_mute",attributes:{gid:b}},null,function(d,g){d?a&&a(d):a&&a(null)})};c.prototype.getMusicSources=function(b){this._doRequest({path:"browse/get_music_sources"},null,function(a,d,g){a?b&&b(a):b&&b(null,g)})};c.prototype.browserSource=function(b,a,d,g,h){b={path:"browse/browse",attributes:{sid:b}};a&&(b.attributes.id=a);d&&(b.attributes.scid=d);g&&(b.attributes.range=g);this._doRequest(b,null,function(l,n,m,r){l?h&&h(l):h&&h(null,n,m,r)})};c.prototype.playerPlayURL=
function(b,a,d){this._doRequest({path:"browse/play_stream",attributes:{pid:b,url:a}},null,function(g,h){g?d&&d(g):d&&d(null,h)})};c.prototype._doRequest=function(b,a,d){this._controller._sendCommand(b,a,function(g,h){g?d(g):d(null,h.message,h.payload,h.options)})};return c}(),e=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Controller");var c=this;this._api=new f(this);this._session=new xnm.aio.heos._Session;this._session.on("open",function(){c._state="OPEN";c._logger.log("trace",
"session opened");c._emitEvent("open")});this._session.on("close",function(){c._state="IDLE";c._reset();c._logger.log("trace","session closed");c._emitEvent("close")});this._session.on("error",function(b){c._state="CONNECT";c._logger.log("trace","session error:"+b.message);c._reset()});this._session.on("event",function(b){c._logger.log("trace","receive session event:"+JSON.stringify(b));c._processHeosEvent(b)});this._state="IDLE";this._stateBuffer=new k;this._listeners={}};e.prototype.on=function(c,
b){c&&b&&(this._listeners[c]||(this._listeners[c]=[]),-1==this._listeners[c].indexOf(b)&&this._listeners[c].push(b))};e.prototype.off=function(c,b){c&&b&&this._listeners[c]&&(b=this._listeners[c].indexOf(b),-1!=b&&this._listeners[c].splice(b,1))};e.prototype.open=function(c){"IDLE"==this._state&&(this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(c))};e.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state="CLOSED",this._session.close())};
e.prototype.isOpen=function(){return"OPEN"==this._state};e.prototype.isIdle=function(){return"IDLE"==this._state};e.prototype.getPlayers=function(c){this._api.getPlayers(c)};e.prototype.getPlayerState=function(c,b){var a=this._getBufferedState("player",c,"play_state");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;this._api.getPlayerState(c,function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("player",c,"play_state",g?null:h):d._removeBufferedState("player",c,"play_state");b&&b(g,h)})}};
e.prototype.setPlayerState=function(c,b,a){var d=this;this._api.setPlayerState(c,b,function(g,h){g||d._putBufferedState("player",c,"play_state",h);a&&a(g,h)})};e.prototype.getPlayerNowPlayingMedia=function(c,b){var a=this._getBufferedState("player",c,"playing_media");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;this._api.getPlayerNowPlayingMedia(c,function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("player",c,"playing_media",g?null:h):d._removeBufferedState("player",c,"playing_media");
b&&b(g,h)})}};e.prototype.getPlayerVolume=function(c,b){var a=this._getBufferedState("player",c,"level");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;this._api.getPlayerVolume(c,function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("player",c,"level",g?null:h):d._removeBufferedState("player",c,"level");b&&b(g,h)})}};e.prototype.setPlayerVolume=function(c,b,a){var d=this;this._api.setPlayerVolume(c,b,function(g,h){g||d._putBufferedState("player",c,"level",h);a&&a(g,h)})};e.prototype.playerVolumeUp=
function(c,b,a){var d=this;this._api.playerVolumeUp(c,b,function(g,h){if(!g){var l=d._stateBuffer.getPlayerStateRaw(c,"level");"undefined"!=typeof l&&null!=l&&(l+=h,100<l&&(l=100),d._putBufferedState("player",c,"level",l))}a&&a(g,h)})};e.prototype.playerVolumeDown=function(c,b,a){var d=this;this._api.playerVolumeDown(c,b,function(g,h){if(!g){var l=d._stateBuffer.getPlayerStateRaw(c,"level");"undefined"!=typeof l&&null!=l&&(l-=h,0>l&&(l=0),d._putBufferedState("player",c,"level",l))}a&&a(g,h)})};e.prototype.getPlayerMute=
function(c,b){var a=this._getBufferedState("player",c,"mute");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;this._api.getPlayerMute(c,function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("player",c,"mute",g?null:h):d._removeBufferedState("player",c,"mute");b&&b(g,h)})}};e.prototype.setPlayerMute=function(c,b,a){var d=this;this._api.setPlayerMute(c,b,function(g,h){g||d._putBufferedState("player",c,"mute",h);a&&a(g,h)})};e.prototype.togglePlayerMute=function(c,b){var a=this;this._api.togglePlayerMute(c,
function(d){if(!d){var g=a._stateBuffer.getPlayerStateRaw(c,"mute");"undefined"!=typeof g&&null!=g&&a._putBufferedState("player",c,"mute","on"==g?"off":"on")}b&&b(d)})};e.prototype.getPlayerMode=function(c,b){var a=this._getBufferedState("player",c,"repeat"),d=this._getBufferedState("player",c,"shuffle");if("undefined"!=typeof a&&"undefined"!=typeof d)b&&b(null,a,d);else{var g=this;this._api.getPlayerMode(c,function(h,l,n){!h||-5!=h.code&&-6!=h.code?(g._putBufferedState("player",c,"repeat",h?null:
l),g._putBufferedState("player",c,"shuffle",h?null:n)):(g._removeBufferedState("player",c,"repeat"),g._removeBufferedState("player",c,"shuffle"));b&&b(h,l,n)})}};e.prototype.getPlayerNowPlayingProgress=function(c,b){var a=this._getBufferedState("player",c,"cur_pos");c=this._getBufferedState("player",c,"duration");b&&b(null,a,c)};e.prototype.getGroups=function(c){this._api.getGroups(c)};e.prototype.setPlayerMode=function(c,b,a,d){var g=this;this._api.setPlayerMode(c,b,a,function(h,l,n){h||g._putBufferedState("player",
c,"repeat",l);h||g._putBufferedState("player",c,"shuffle",n);d&&d(h,l,n)})};e.prototype.playerClearQueue=function(c,b){this._api.playerClearQueue(c,function(a){b&&b(a)})};e.prototype.playerPlayNext=function(c,b){this._api.playerPlayNext(c,function(a){b&&b(a)})};e.prototype.playerPlayPrevious=function(c,b){this._api.playerPlayPrevious(c,function(a){b&&b(a)})};e.prototype.getGroupVolume=function(c,b){var a=this._getBufferedState("group",c,"level");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;
this._api.getGroupVolume(c,function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("group",c,"level",g?null:h):d._removeBufferedState("group",c,"level");b&&b(g,h)})}};e.prototype.setGroupVolume=function(c,b,a){var d=this;this._api.setGroupVolume(c,b,function(g,h){g||d._putBufferedState("group",c,"level",h);a&&a(g,h)})};e.prototype.groupVolumeUp=function(c,b,a){var d=this;this._api.groupVolumeUp(c,b,function(g,h){if(!g){var l=d._stateBuffer.getGroupStateRaw(c,"level");"undefined"!=typeof l&&null!=
l&&(l+=h,100<l&&(l=100),d._putBufferedState("group",c,"level",l))}a&&a(g,h)})};e.prototype.groupVolumeDown=function(c,b,a){var d=this;this._api.groupVolumeDown(c,b,function(g,h){if(!g){var l=d._stateBuffer.getGroupStateRaw(c,"level");"undefined"!=typeof l&&null!=l&&(l-=h,0>l&&(l=0),d._putBufferedState("group",c,"level",l))}a&&a(g,h)})};e.prototype.getGroupMute=function(c,b){var a=this._getBufferedState("group",c,"mute");if("undefined"!=typeof a)b&&b(null,a);else{var d=this;this._api.getGroupMute(c,
function(g,h){!g||-5!=g.code&&-6!=g.code?d._putBufferedState("group",c,"mute",g?null:h):d._removeBufferedState("group",c,"mute");b&&b(g,h)})}};e.prototype.setGroupMute=function(c,b,a){var d=this;this._api.setGroupMute(c,b,function(g,h){g||d._putBufferedState("group",c,"mute",h);a&&a(g,h)})};e.prototype.toggleGroupMute=function(c,b){var a=this;this._api.toggleGroupMute(c,function(d){if(!d){var g=a._stateBuffer.getGroupStateRaw(c,"mute");"undefined"!=typeof g&&null!=g&&a._putBufferedState("group",c,
"mute","on"==g?"off":"on")}b&&b(d)})};e.prototype.getMusicSources=function(c){this._api.getMusicSources(function(b,a){c&&c(b,a)})};e.prototype.browserSource=function(c,b,a,d,g){this._api.browserSource(c,b,a,d,function(h,l,n,m){g&&g(h,l,n,m)})};e.prototype.playerPlayURL=function(c,b,a){this._api.playerPlayURL(c,b,function(d,g){d?a&&a(d):a&&a(null,g)})};e.prototype._putBufferedState=function(c,b,a,d){"player"==c?this._stateBuffer.putPlayerState(b,a,d):"group"==c&&this._stateBuffer.putGroupState(b,a,
d)};e.prototype._getBufferedState=function(c,b,a){if("player"==c)return this._stateBuffer.getPlayerState(b,a);if("group"==c)return this._stateBuffer.getGroupState(b,a)};e.prototype._removeBufferedState=function(c,b,a){"player"==c?this._stateBuffer.removePlayerState(b,a):"group"==c&&this._stateBuffer.removeGroupState(b,a)};e.prototype._sendCommand=function(c,b,a){this._session.sendCommand(c,b,a)};e.prototype._emitEvent=function(c,b){if(c){var a=this._listeners[c];if(a&&0<a.length)for(var d=0;d<a.length;d++){var g=
a[d];try{g(b)}catch(h){this._logger.log("trace","call "+c+" listener failed, error:"+h.message)}}}};e.prototype._processHeosEvent=function(c){if(c&&c.heos&&c.heos.command){var b=c.heos.message;switch(c.heos.command){case "event/player_state_changed":b&&b.pid&&b.state&&this._stateBuffer.putPlayerState(b.pid,"play_state",b.state);break;case "event/player_now_playing_changed":b&&b.pid&&(this._stateBuffer.removePlayerState(b.pid,"playing_media"),this._stateBuffer.removePlayerState(b.pid,"cur_pos"),this._stateBuffer.removePlayerState(b.pid,
"duration"));break;case "event/player_now_playing_progress":b&&b.pid&&b.cur_pos&&b.duration&&(this._stateBuffer.putPlayerState(b.pid,"cur_pos",parseInt(b.cur_pos)),this._stateBuffer.putPlayerState(b.pid,"duration",parseInt(b.duration)));break;case "event/player_volume_changed":b&&b.pid&&b.level&&b.mute&&(this._stateBuffer.putPlayerState(b.pid,"level",parseInt(b.level)),this._stateBuffer.putPlayerState(b.pid,"mute",b.mute));break;case "event/repeat_mode_changed":b&&b.pid&&b.repeat&&this._stateBuffer.putPlayerState(b.pid,
"repeat",b.repeat);break;case "event/shuffle_mode_changed":b&&b.pid&&b.shuffle&&this._stateBuffer.putPlayerState(b.pid,"shuffle",b.shuffle);break;case "event/group_volume_changed":b&&b.gid&&b.level&&b.mute&&(this._stateBuffer.putGroupState(b.gid,"level",parseInt(b.level)),this._stateBuffer.putGroupState(b.gid,"mute",b.mute))}}};e.prototype._reset=function(){this._stateBuffer.reset()};return e}();
xnm.aio.heos._Session=function(){var k=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session._Monitor");this._monitorCallback=this._socket=null;this._commandTimeoutCount=0;this._heartBeatTo=null;this._heatBeatMissCount=0;var a=this;this._socketErrorCallback=function(d){a._finishRun(d)};this._socketCloseCallback=function(){a._finishRun(Error("socket closed"))}};k.prototype.run=function(a,d){this._socket=a;this._monitorCallback=d;this._setListener();this.scheduleNextHeartBeat()};
k.prototype.reset=function(){this._monitorCallback=null;this._heatBeatMissCount=0;this._heartBeatTo&&(clearTimeout(this._heartBeatTo),this._heartBeatTo=null);if(this._socket){var a=this._socket;this._clearListener();this._socket=null;a.close()}};k.prototype.executeCommandTimeout=function(a){a?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),3<this._commandTimeoutCount&&this._finishRun(Error("execute command is always timeout"))):this._commandTimeoutCount=
0};k.prototype.scheduleNextHeartBeat=function(a){this._scheduleNextHeartBeat(a?a:15E3)};k.prototype._scheduleNextHeartBeat=function(a){var d=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo);this._heartBeatTo=setTimeout(function(){d._checkHeartBeat()},a)};k.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var a=this;this._socket.sendCommand({path:"system/heart_beat"},2E3,function(d){d?(a._heatBeatMissCount++,a._logger.log("warn","check heart beat failed #"+
a._heatBeatMissCount+", error:"+d.message),a._scheduleNextHeartBeat(2E3)):(a._heatBeatMissCount=0,a._scheduleNextHeartBeat(15E3));3<a._heatBeatMissCount&&a._finishRun(Error("heart beat failed"))})}};k.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};k.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};
k.prototype._finishRun=function(a){var d=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&d&&d.close();this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null);this._heatBeatMissCount=this._commandTimeoutCount=0;this._monitorCallback&&(d=this._monitorCallback,this._monitorCallback=null,d(a))};var f=function(){this._warmupCallback=this._password=this._username=this._socket=null;var a=this;this._socketErrorCallback=function(d){a._finishWarmup(d)};
this._socketCloseCallback=function(){a._finishWarmup(Error("socket closed"))}};f.prototype.warmup=function(a,d,g,h){this._socket=a;this._username=d;this._password=g;this._warmupCallback=h;this._setListener();var l=this;this._registerEvents("off",function(n){n?l._finishWarmup(n):l._signIn(function(m){m?l._finishWarmup(m):l._getPlayers(function(r){r?l._finishWarmup(r):l._registerEvents("on",function(t){l._finishWarmup(t)})})})})};f.prototype.reset=function(){this._warmupCallback=null;if(this._socket){var a=
this._socket;this._clearListener();this._socket=null;a.close()}};f.prototype._registerEvents=function(a,d){this._socket.sendCommand({path:"system/register_for_change_events",attributes:{enable:a}},5E3,function(g,h){d(g,h)})};f.prototype._signIn=function(a){this._username&&this._password?this._socket.sendCommand({path:"system/sign_in",attributes:{un:this._username,pw:this._password}},5E3,function(d,g){a(d,g)}):a()};f.prototype._getPlayers=function(a){this._socket.sendCommand({path:"player/get_players"},
5E3,function(d,g){d?a(d):g&&g.heos&&g.payload&&"success"==g.heos.result?a(null,g.payload):a(Error("get players response error"))})};f.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};f.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};f.prototype._finishWarmup=function(a){var d=this._socket;
this._socket&&(this._clearListener(),this._socket=null);a&&d&&d.close();this._warmupCallback&&(this._warmupCallback(a),this._warmupCallback=null)};var e=function(){this._connectCallback=this._socket=null;var a=this;this._socketOpenCallback=function(){a._finishConnect()};this._socketErrorCallback=function(d){a._finishConnect(d)};this._socketCloseCallback=function(){a._finishConnect(Error("socket closed"))}};e.prototype.connect=function(a,d){this._connectCallback=d;this._socket=new xnm.aio.heos._Socket(a);
this._setListener();this._socket.open()};e.prototype.reset=function(){this._connectCallback=null;if(this._socket){var a=this._socket;this._clearListener();this._socket=null;a.close()}};e.prototype._setListener=function(){this._socket&&(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};e.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",
this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};e.prototype._finishConnect=function(a){var d=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&d&&d.close();if(this._connectCallback){var g=this._connectCallback;this._connectCallback=null;g(a,d)}};var c=function(){this._state="idle";this._heos=[];this._searchTo=this._fetchCallback=this._lastFetch=null};c.prototype.reset=function(){this._state="idle";this._heos=[];this._fetchCallback=this._lastFetch=
null;this._searchTo&&clearTimeout(this._searchTo);this._searchTo=null};c.prototype.fetchHEOS=function(a){var d=Math.round((new Date).getTime()/1E3);this._lastFetch&&600<d-this._lastFetch&&(this._heos=[]);var g=this._getUnfetchedHEOSFromBuffer();if(g)this._lastFetch=d,a(null,g);else if(this._fetchCallback=a,"run"!=this._state){var h=this;this._state="run";this._searchTo=setTimeout(function(){h._state="idle";h._heos=[];if(h._fetchCallback){var l=h._fetchCallback;h._fetchCallback=null;l(null,null)}},
12E3);require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",1E4,function(l){if(l&&l.ip&&"run"==h._state){l={fetched:!1,data:{ip:l.ip,port:1255,uuid:l.uuid}};var n=h._heos.length;h._heos.push(l);0==n&&(l.fetched=!0,h._lastFetch=d,h._fetchCallback&&(n=h._fetchCallback,h._fetchCallback=null,n(null,l.data)))}})}};c.prototype._getUnfetchedHEOSFromBuffer=function(){for(var a=null,d=0;d<this._heos.length;d++){var g=this._heos[d];if(0==g.fetched){g.fetched=!0;a=g.data;
break}}return a};var b=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session");this._discover=new c;this._connect=new e;this._runner=new f;this._monitor=new k;var a=this;this._socketEventCallback=function(d){d&&d.heos&&d.heos.message&&(d.heos.message=a._parseMessage(d.heos.message));a._monitor.scheduleNextHeartBeat();a._emitEvent("event",d)};this._socket=null;this._state="IDLE";this._uuid=this._password=this._username=this._port=this._ip=null;this._eventListeners={}};b.prototype.on=
function(a,d){a&&d&&(this._eventListeners[a]||(this._eventListeners[a]=[]),-1==this._eventListeners[a].indexOf(d)&&this._eventListeners[a].push(d))};b.prototype.off=function(a,d){a&&d&&this._eventListeners[a]&&(d=this._eventListeners[a].indexOf(d),-1!=d&&this._eventListeners[a].splice(d,1))};b.prototype.open=function(a){"IDLE"==this._state&&(this._ip=a?a.ip:null,this._port=a?a.port:null,this._username=a?a.username:null,this._password=a?a.password:null,this._uuid=a?a.uuid:null,this._logger.log("debug",
"start controller"+(this._ip?" with ip:"+this._ip:" without ip")),this._doFSM(this._ip?"init_with_ip":"init_without_ip"))};b.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"))};b.prototype.sendCommand=function(a,d,g){if("IDLE"==this._state)a=Error("session not initialized"),a.sys="heos",a.code=-5,g&&g(a);else if("RUN"!=this._state)a=Error("session is initialling"),a.sys="heos",a.code=-6,g&&g(a);else{var h=this;this._socket.sendCommand(a,
d,function(l,n){l?-3==l.code?(h._monitor.scheduleNextHeartBeat(),h._monitor.executeCommandTimeout(!0)):h._monitor.executeCommandTimeout(!1):(h._monitor.scheduleNextHeartBeat(),h._monitor.executeCommandTimeout(!1));if(l)g&&g(l);else if(n&&n.heos&&n.heos.result){var m={command:n.heos.comamnd,result:n.heos.result};n.heos.message&&(m.message=h._parseMessage(n.heos.message));n.payload&&(m.payload=n.payload);n.options&&(m.options=n.options);"fail"==n.heos.result&&(m.message?(l=Error(m.message.text),l.code=
parseInt(m.message.eid)):(l=Error("response fail"),l.code=0));g&&g(l,m)}else l=Error("invalid response"),l.code=-4,g&&g(l)})}};b.prototype._emitEvent=function(a,d){if(a){var g=this._eventListeners[a];if(g&&0<g.length)for(var h=0;h<g.length;h++){var l=g[h];try{l(d)}catch(n){this._logger.log("trace","call "+a+" listener failed, error:"+n.message)}}}};b.prototype._searchHEOS=function(){this._logger.log("trace","search heos device");var a=this;this._discover.fetchHEOS(function(d,g){g?(a._logger.log("trace",
"found heos device:"+g.ip),a._ip=g.ip,a._uuid=g.uuid,a._doFSM("find_heos")):(a._logger.log("trace","do not found heos device"),a._doFSM("no_heos"))})};b.prototype._stopSearchHEOS=function(){this._logger.log("trace","stop search heos device");this._discover.reset();this._reset()};b.prototype._connectHEOS=function(){this._logger.log("trace","connect heos device:"+this._ip);var a=this;this._connect.connect({ip:this._ip,port:this._port,username:this._username,passsword:this._password,uuid:this._uuid},
function(d,g){d?(a._logger.log("trace","connect to heos device:"+a._ip+" failed, error:"+d.message),a._doFSM("conn_fail")):(a._logger.log("trace","connect to heos device:"+a._ip+" success"),a._socket=g,a._doFSM("conn_ok"))})};b.prototype._stopConnectHEOS=function(){this._logger.log("trace","stop connect heos device:"+this._ip);this._connect.reset();this._reset()};b.prototype._warmupHEOS=function(){this._logger.log("trace","warmup heos device:"+this._ip);var a=this;this._runner.warmup(this._socket,
this._username,this._password,function(d){d?(a._logger.log("trace","warmup heos device:"+a._ip+" failed, error:"+d.message),a._socket=null,a._doFSM("not_ready")):(a._logger.log("trace","warmup heos device:"+a._ip+" success"),a._doFSM("ready"))})};b.prototype._stopWarmupHEOS=function(){this._logger.log("trace","stop warmup heos device:"+this._ip);this._runner.reset();this._reset()};b.prototype._runHEOS=function(){this._logger.log("trace","monitor heos device:"+this._ip);var a=this;this._monitor.run(this._socket,
function(d){d&&(a._logger.log("trace","monitor heos device:"+a._ip+" failed, error:"+d.message),a._socket=null,a._doFSM("run_error"),a._emitEvent("error",d))});this._setListener();this._emitEvent("open")};b.prototype._stopRunHEOS=function(){this._logger.log("trace","stop monitor heos device:"+this._ip);this._monitor.reset();this._clearListener();this._emitEvent("close");this._reset()};b.prototype._parseMessage=function(a){if(!a)return null;var d={};a=a.split("&");for(var g=0;g<a.length;g++){var h=
a[g],l=h.indexOf("=");if(-1!=l){var n=h.substr(0,l);h=h.substr(l+1);d[n]=h}}return d};b.prototype._setListener=function(){if(this._socket)this._socket.on("event",this._socketEventCallback)};b.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback)};b.prototype._reset=function(){this._uuid=this._password=this._username=this._port=this._ip=this._socket=null};b.prototype._doFSM=function(a){this._logger.log("trace","FSM current state:"+this._state+" input:"+
a);switch(this._state){case "IDLE":switch(a){case "init_with_ip":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;case "init_without_ip":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS()}break;case "SEARCH":switch(a){case "no_heos":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "find_heos":this._state="CONNECT";this._logger.log("trace","FSM new state:"+
this._state);this._connectHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopSearchHEOS()}break;case "CONNECT":switch(a){case "conn_fail":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "conn_ok":this._state="WARMUP";this._logger.log("trace","FSM new state:"+this._state);this._warmupHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectHEOS()}break;
case "WARMUP":switch(a){case "not_ready":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "ready":this._state="RUN";this._logger.log("trace","FSM new state:"+this._state);this._runHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopWarmupHEOS()}break;case "RUN":switch(a){case "run_error":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;
case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopRunHEOS()}}};return b}();
xnm.aio.heos._Socket=function(){var k=function(f){if(!f)throw Error("options is null");if(!f.ip)throw Error("no ip");this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Socket");this._responseTimeout=1E3;this._ip=f.ip;this._port=f.port;this._port||(this._port=1255);this._username=f.username;this._password=f.password;this._uuid=f.uuid;this._timeout=2E3;this._listeners={};this._socket=null;this._buf="";this._state="IDLE";this._commands=[]};k.prototype.on=function(f,e){f&&e&&(this._listeners[f]||
(this._listeners[f]=[]),-1==this._listeners[f].indexOf(e)&&this._listeners[f].push(e))};k.prototype.off=function(f,e){f&&e&&this._listeners[f]&&(e=this._listeners[f].indexOf(e),-1!=e&&this._listeners[f].splice(e,1))};k.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var f=this;this._state="CONNECT";this._buf="";var e=require("net").connect({port:this._port,host:this._ip});e.setTimeout(this._timeout);e.setEncoding("utf8");this._logger.log("trace","start connect to "+this._ip+":"+this._port);
e.on("connect",function(){f._logger.log("trace","success to connect "+f._ip+":"+f._port);f._state="CONNECTED";f._emitEvent("open");f._executeNextCommand()});e.on("data",function(c){f._logger.log("trace","receive data: "+c.toString());f._buf+=c.toString();f._processBuffer()});e.on("error",function(c){f._logger.log("trace","socket error: "+c.message);f._emitEvent("error",c)});e.on("timeout",function(){"CONNECT"==f._state&&(f._logger.log("trace","connect timeout"),f._emitEvent("error",Error("connect timeout")),
f.close())});e.on("close",function(){f._logger.log("trace","socket closed");f._onClose()});e._doConnect&&"function"==typeof e._doConnect&&e._doConnect();this._socket=e}};k.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};k.prototype.sendCommand=function(f,e,c){if("CLOSED"==this._state)f=Error("socket closed"),f.code=-1,c&&c(f);else if(f&&f.path){e||(e=this._responseTimeout);var b=this._commands.length;this._commands.push({command:f,callback:c,
timeout:null,state:"IDLE",responseTimeout:e});0==b&&this._executeNextCommand()}else f=Error("invalid command"),f.code=-2,c&&c(f)};k.prototype._executeNextCommand=function(){var f=this._commands[0];if(f&&"IDLE"==f.state&&"CONNECTED"==this._state){var e=this._buildPacket(f.command);f.state="SENT";this._setupReponseTimeout(f);this._logger.log("debug","send command:"+e);f=new Buffer(e);this._socket.write(f)}};k.prototype._setupReponseTimeout=function(f){var e=this;f.timeout=setTimeout(function(){e._commands.splice(0,
1);f.state="TIMEOUT";if(f.callback){e._logger.log("debug","response timeout");var c=Error("response timeout");c.code=-3;f.callback(c)}e._executeNextCommand()},f.responseTimeout)};k.prototype._buildPacket=function(f){var e="heos://"+f.path;if(f.attributes){e+="?";var c=[],b;for(b in f.attributes){var a=this._escape(b)+"="+this._escape(f.attributes[b]);c.push(a)}e+=c.join("&")}return e+"\r\n"};k.prototype._escape=function(f){if(!f||"string"!=typeof f)return f;f=f.replace(/%/g,"%25");f=f.replace(/&/g,
"%26");return f=f.replace(/=/g,"%3D")};k.prototype._emitEvent=function(f,e){if(f){var c=this._listeners[f];if(c&&0<c.length)for(var b=0;b<c.length;b++){var a=c[b];try{a(e)}catch(d){this._logger.log("trace","call "+f+" listener failed, error:"+d.message)}}}};k.prototype._processBuffer=function(){for(var f=this._buf.indexOf("\r\n");-1!=f;){if(0!=f){var e=this._buf.substr(0,f);this._processResponse(e)}this._buf=this._buf.substr(f+2);f=this._buf.indexOf("\r\n")}};k.prototype._processResponse=function(f){this._logger.log("debug",
"receive response: "+f);try{var e=JSON.parse(f);if(!e||!e.heos||!e.heos.command)throw Error("invalid response");var c=this._commands[0];c&&"SENT"==c.state&&c.command&&c.command.path==e.heos.command?-1!=e.heos.message.indexOf("command under process")?(clearTimeout(c.timeout),this._setupReponseTimeout(c)):(this._commands.splice(0,1),clearTimeout(c.timeout),c.callback&&c.callback(null,e),this._executeNextCommand()):"event"==e.heos.command.substr(0,5)&&this._emitEvent("event",e)}catch(b){this._logger.log("debug",
"process response error: "+b.message)}};k.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};var f=Error("socket closed");f.code=-1;for(var e=0;e<this._commands.length;e++){var c=this._commands[e];c.timeout&&clearTimeout(c.timeout);c.callback&&c.callback(f)}this._commands=[];this._buf=""};return k}();
xnm.aio.heos.DM=function(){var k=function(e,c){this.code=e;this.message=c;this.stack=Error().stack};k.prototype=Error();k.prototype.name="HEOSDMError";k.prototype.code=0;k.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var f={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},
{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on",
"off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"string",name:"play state",ref:{value:"playState",options:["play","pause","stop"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",
name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]};return{SYS:"heos",getGatewayType:function(){return[{sys:this.SYS,name:"HEOS Controller",port:1255}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"player",name:"Player"},{sys:this.SYS,type:"group",name:"Group"}]},createGateway:function(e,c,b){c=k.ERROR_CODE;e?e.ip?b(null,e):b(new k(c.INVALID,"ip is invalid")):b(new k(c.INVALID,"info is invalid"))},updateGateway:function(e,c,b,a){e=k.ERROR_CODE;c?c.ip?
a(null,c):a(new k(e.INVALID,"ip is invalid")):a(new k(e.INVALID,"update is invalid"))},deleteGateway:function(e,c,b){b()},createDevice:function(e,c,b){var a=k.ERROR_CODE;if(e)if(e.gateway)if(null==e.type||"undefined"==typeof e.type)b(new k(a.INVALID,"type is invalid"));else if("player"!=e.type||null!=e.pid&&"undefined"!=typeof e.pid)if("group"!=e.type||null!=e.gid&&"undefined"!=typeof e.gid){c=c.data.gateways;var d;for(d=0;d<c.length;d++)if(c[d].index===e.gateway){var g=c[d];break}g?b(null,e):b(new k(a.NOT_FOUND,
"gateway with index "+e.gateway+" not exists"))}else b(new k(a.INVALID,"gid is invalid"));else b(new k(a.INVALID,"pid is invalid"));else b(new k(a.INVALID,"gateway is invalid"));else b(new k(a.INVALID,"info is invalid"))},updateDevice:function(e,c,b){var a=k.ERROR_CODE;if(e)if(e.gateway)if(null==e.type||"undefined"==typeof e.type)b(new k(a.INVALID,"type is invalid"));else if("player"!=e.type||null!=e.pid&&"undefined"!=typeof e.pid)if("group"!=e.type||null!=e.gid&&"undefined"!=typeof e.gid){c=c.data.gateways;
var d;for(d=0;d<c.length;d++)if(c[d].index===e.gateway){var g=c[d];break}g?b(null,e):b(new k(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"))}else b(new k(a.INVALID,"gid is invalid"));else b(new k(a.INVALID,"pid is invalid"));else b(new k(a.INVALID,"gateway is invalid"));else b(new k(a.INVALID,"info is invalid"))},deleteDevice:function(e,c,b){b()},applyUIFilter:function(e,c){var b=this,a=function(l,n,m){var r=[];l.forEach(function(t){if("root"==t.type){t=JSON.parse(JSON.stringify(t));var q=
a(t.children,n,m);q&&0<q.length&&(t.children=q,r.push(t))}else{q=m.elems;if("*"==q)q=!0;else{for(var u=!1,p=0;p<q.length;p++)if(q[p]==t.type){u=!0;break}q=u}q&&(t=JSON.parse(JSON.stringify(t)),r.push(t))}});return r},d=function(l,n){var m=[],r=b.getCommandStatusMap(l);if(r){var t=[];switch(n.catagory){case "command":r.command&&(t=a(r.command,l,n));break;case "status":r.status&&(t=a(r.status,l,n))}m=m.concat(t)}return m};if(!e.sys)return null;var g=JSON.parse(JSON.stringify(e)),h=null;switch(c.catagory){case "command":h=
d(e,c);g.command=h;break;case "status":h=d(e,c);g.status=h;break;default:return null}return h&&0!=h.length?g:null},getCommandStatusMap:function(e){return e&&"undefined"!=typeof e.type&&null!=e.type?f:null},applySmartWidgetFilter:function(e,c,b,a,d){return e._injectToSmartWidgetTemplate(a,["media"],d,{"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%shuffleToggle%":{value:"shuffleToggle"},"%stop%":{value:"stop"},"%toggleMute%":{value:"toggleMute"},
"%volume%":{value:"volume",ext:"%d",extMeta:"0-100"}},{"%durationState%":{value:"durationS"},"%durationStringState%":{value:"duration"},"%mutedState%":{value:"muted",options:["true","false"]},"%playState%":{value:"playState",options:["play","pause","stop"]},"%positionState%":{value:"positionS"},"%shuffleState%":{value:"shuffle",options:["on","off"]},"%volumeState%":{value:"volume",extMeta:"0-100"}},null)}}}();
xnm.aio.heos.Handler=function(){var k=function(){this._getDeviceListTo=this._controller=null};k.prototype.Socket=xnm.aio.heos._Socket;k.prototype.Session=xnm.aio.heos._Session;k.prototype.Controller=xnm.aio.heos._Controller;k.prototype.HEOS=xnm.aio.heos.HEOS;k.prototype.devicemanager=xnm.aio.heos.DM;k.prototype.registModule=function(f){f.register(this.devicemanager.SYS,"heos")};k.prototype.resolveGateway=function(f){return f?this.HEOS.parseJSON(f):null};k.prototype.getDeviceCommands=function(f,e){f=
(f=this.devicemanager.applyUIFilter(f,{catagory:"command",elems:"*"}))?f.command:[];e&&e(null,f)};k.prototype.getDeviceStatus=function(f,e){f=(f=this.devicemanager.applyUIFilter(f,{catagory:"status",elems:"*"}))?f.status:[];e&&e(null,f)};k.prototype.doCommand=function(f,e,c,b){(f=this.resolveGateway(f))?f.executeCommandCreator(e,c,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};k.prototype.doStatus=function(f,e,c,b,a){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:f,device:c,
status:b}],function(d,g){d?a&&a(d):a&&a(null,g[0])}):a&&a(Error("device json format invalid"))};k.prototype.getController=function(){this._controller||(this._controller=new this.Controller);return this._controller};k.prototype.discoverDevices=function(f){var e={};require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",5E3,function(c){c&&c.ip&&c.uuid&&(e[c.uuid]={sys:"heos",ip:c.ip,uuid:c.uuid})});setTimeout(function(){var c=null,b;for(b in e){var a=e[b];if(a){c=a;
break}}f&&f(null,c)},5E3)};k.prototype.getDeviceList=function(f,e){_getDeviceList=function(g,h){var l=[];g.getPlayers(function(n,m){n?h&&h(n):(m&&m.map(function(r){r.sys="heos";r.type="player";return r}),g.getGroups(function(r,t){r?h&&h(r):(t&&t.map(function(q){q.sys="heos";q.type="group";delete q.players;return q}),m&&(l=l.concat(m)),t&&(l=l.concat(t)),h&&h(null,l))}))})};var c=this.resolveGateway(f);if(c)if(this._getDeviceListTo)e&&e(Error("another get device list process running"));else{var b=
this.getController();if(b.isOpen())_getDeviceList(c,e);else{var a=this,d=function(){b.off("run",d);a._getDeviceListTo&&(clearTimeout(a._getDeviceListTo),a._getDeviceListTo=null);_getDeviceList(c,e)};b.on("open",d);this._getDeviceListTo=setTimeout(function(){b.off("run",d);a._getDeviceListTo=null;e&&e(Error("start heo controller timeout"))},5E3);b.open(c.toJSON())}}else e&&e(Error("gateway json format invalid"))};k.prototype.finalize=function(f){this._controller&&this._controller.close();setTimeout(function(){f&&
f()},1E3)};k.prototype.pause=function(f){this.finalize(f)};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.heos.Handler);
