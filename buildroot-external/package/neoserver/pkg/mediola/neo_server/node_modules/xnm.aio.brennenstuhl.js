var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.brennenstuhl=xnm.aio.brennenstuhl||{};xnm.aio.brennenstuhl.WebLine=function(a,b,c,e){this.ip=a;this.port=80;b&&(this.port=b);this.user="admin";c&&(this.user=c);this.password="admin";e&&(this.password=e);this.CommandHandler=null};
xnm.aio.brennenstuhl.WebLine.prototype._doRequest=function(a,b,c){var e={host:this.ip,port:this.port,path:a,method:"GET",headers:{Connection:"close"}};c&&(e.headers.Authorization=c);var g=this,h=require("http").request(e,function(f){if(200==f.statusCode){f.setEncoding("utf-8");var k="";f.on("data",function(p){k+=p});f.on("end",function(){b&&b(k)})}else if(401!=f.statusCode||c)b&&b(null);else if(c=null,f.headers["www-authenticate"]&&"Digest "==f.headers["www-authenticate"].substr(0,7)){var l={};f=
f.headers["www-authenticate"].substr(7).replace(/'/g,"").replace(/"/g,"").split(",");for(var m=0;m<f.length;m++){var n=f[m].split("=");2==n.length&&(l[n[0]]=n[1])}l.nonce&&(c="Digest ",c+='username="'+g.user+'", ',c+='realm="'+l.realm+'", ',c+='nonce="'+l.nonce+'", ',c+='uri="'+a+'", ',f=require("x.crypt.js"),m=f.MD5(g.user+":"+l.realm+":"+g.password),n=f.MD5("GET:"+a),c+='response="'+f.MD5(m+":"+l.nonce+":1::auth:"+n)+'", ',c+='opaque="'+l.opaque+'", ',c+="qop="+l.qop+", ",c+="nc=1, ",c+='cnonce=""');
c?g._doRequest(a,b,c):b&&b(null)}});h.setTimeout(5E3,function(){h.abort()});h.on("error",function(f){b&&b(null)});h.end()};
xnm.aio.brennenstuhl.WebLine.prototype.executeCommand=function(a,b,c){if("toggle"==b)this._doRequest("/cgi-bin/toggleRel"+a.address+"?id=0",c);else if("on"==b||"off"==b){var e=this;this._doRequest("/power?id=1",function(g){g=e.getStateValues(null,g);"on"==b&&"M"==a.address&&"off"==g.master||"on"==b&&"S"==a.address&&"off"==g.slave||"off"==b&&"M"==a.address&&"on"==g.master||"off"==b&&"S"==a.address&&"on"==g.slave?e._doRequest("/cgi-bin/toggleRel"+a.address+"?id=0",c):c&&c()})}else c&&c()};
xnm.aio.brennenstuhl.WebLine.prototype.getStates=function(a,b,c){var e=this;this.CommandHandler=a;this._doRequest("/power?id=1",function(g){if(g&&e.CommandHandler)if(e.CommandHandler.setState){var h=e.getStateValues(null,g),f;for(f in h)"state"==f?e.CommandHandler.setState(d.id,h[f]):e.CommandHandler.setState(d.id+":"+f,h[f])}else e.CommandHandler.receivedState&&e.CommandHandler.receivedState("webline",e.ip,g);c&&c(e.getStateValues(null,g))})};
xnm.aio.brennenstuhl.WebLine.prototype.getStateValues=function(a,b){a={state:"?",master:"?",slave:"?"};b&&(b=b.split("|"),5==b.length&&(a.state="off","1"==b[3]?(a.master="on",a.state="on"):a.master="off","1"==b[4]?(a.slave="on",a.state="on"):a.slave="off"));return a};
xnm.aio.brennenstuhl.WebLine.Discovery=function(a){this.Devices={};this.callback=a;this._sockets=[];var b=require("os");a=require("dgram");if(b&&b.networkInterfaces){var c=this,e=a.createSocket("udp4");e.on("listening",function(){e.setBroadcast(!0);var g=b.networkInterfaces(),h;for(h in g)for(var f=g[h],k=0;k<f.length;k++)"IPv4"==f[k].family&&0==f[k].internal&&c._addDiscoverSocket(e.address().port,f[k].address);c.discoverDevices()});e.on("message",function(g,h){c._receivedData(h.address,g)});e.bind(null)}else this._addDiscoverSocket(null),
this.discoverDevices()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._getMAC=function(a){for(var b="",c=0;5>c;c++)b+=XC.getHexVal(a[c],2).toUpperCase()+"-";return b+=XC.getHexVal(a[c],2).toUpperCase()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");94==b.length&&(this.Devices[a]=new xnm.aio.brennenstuhl.WebLine(a),this.Devices[a].uuid=this._getMAC(b.slice(19,25)),this.callback&&this.callback(this.Devices[a]))};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype._addDiscoverSocket=function(a,b){var c=this,e=require("dgram").createSocket("udp4");e.on("listening",function(){e.setBroadcast(!0)});e.on("message",function(g,h){c._receivedData(h.address,g)});e.bind(a,b);this._sockets.push(e)};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._sendDiscoveryMessages=function(a,b,c,e){a=new Buffer([255,4,2,251]);for(b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,23,"255.255.255.255")};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};xnm.aio.brennenstuhl.Handler=function(){this._WebLineDiscovery=new xnm.aio.brennenstuhl.WebLine.Discovery;this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.discoverDevices=function(a){a&&(this._WebLineDiscovery.callback=a);this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.brennenstuhl.WebLine).getStateValues(b)};
xnm.aio.brennenstuhl.Handler.prototype.getDeviceCommandList=function(a,b){a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};xnm.aio.brennenstuhl.Handler.prototype.getDevice=function(a){for(var b in this._WebLineDiscovery.Devices)if(a.address&&this._WebLineDiscovery.Devices[b].uuid==a.address)return this._WebLineDiscovery.Devices[b];return null};xnm.aio.brennenstuhl.Handler.prototype.WebLine=xnm.aio.brennenstuhl.WebLine;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.brennenstuhl.Handler);
