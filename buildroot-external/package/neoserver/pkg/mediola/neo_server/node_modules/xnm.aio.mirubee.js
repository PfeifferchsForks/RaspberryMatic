var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mirubee=xnm.aio.mirubee||{};
xnm.aio.mirubee.Mirubee=function(){var g={},b=function(a,d,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mirubee.Mirubee");this._protocol="https";this._ip="v5dev.mediola.com";this._port=443;this.username=a;this.password=d;this.id=c;this._statesBuffer=g;this._getDeviceStatesCBs={}};b.prototype._putStatesBuffer=function(a,d){this._statesBuffer[a]={data:d,timestamp:(new Date).getTime()}};b.prototype._getStatesBuffer=function(a){var d=
this._statesBuffer[a];if(!d)return null;var c=(new Date).getTime();return!d.timestamp||6E4<c-d.timestamp?(delete this._statesBuffer[a],null):d.data};b.prototype.connect=function(a,d,c){this._doJsonRequest("GET","/eapi/v1/mirubee/connect",{account:a,password:d},null,function(e,f){c&&c(e,f)})};b.prototype.disconenct=function(a){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/disconnect",{id:this.id},null,function(d,c){a&&a(d,c)}):a&&a(Error("account not connected"))};b.prototype.getInfo=function(a){this._doJsonRequest("GET",
"/eapi/v1/mirubee/info",null,null,function(d,c){a&&a(d,c)})};b.prototype.getDevices=function(a){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/devices/"+this.id,null,null,function(d,c){if(d)a&&a(d);else{var e=[];if(c)for(var f in c){var h=c[f];h.sys="mirubee";e.push(h)}a&&a(d,e)}}):a&&a(Error("account not connected"))};b.prototype.executeCommandCreator=function(a,d,c){c&&c()};b.prototype.getStatesCreator=function(a,d,c){if(this.id)if(d)if(0==d.length)c&&c(null,[]);else{a=[];for(var e=0;e<d.length;e++){var f=
d[e];f&&f.device&&f.device.id&&-1==a.indexOf(f.device.id)&&a.push(f.device.id)}this.getStates(a,function(h,k){if(h)c&&c(h);else{h=[];for(var m=0;m<d.length;m++){var l=d[m];if(l&&l.id){var n=null;l.device&&l.device.id&&l.status&&l.status.value&&(n=k[l.device.id])&&(n=n[l.status.value]);if("undefined"==typeof n||null==n)n="?";h.push({id:l.id,status:n})}}c&&c(null,h)}})}else c&&c(Error("deviceList is null"));else c&&c(Error("account not connected"))};b.prototype.getStates=function(a,d){if(a&&0!=a.length)for(var c=
{},e=a.length,f=0;f<a.length;f++)this.getDeviceStates(a[f],function(h,k,m){!h&&k&&(c[m]=k);e--;0==e&&d&&d(null,c)});else d&&d(null,{})};b.prototype.getDeviceStates=function(a,d){var c=this._getStatesBuffer(a);if(c)d&&d(null,c,a);else{c=this._getDeviceStatesCBs[a];c||(this._getDeviceStatesCBs[a]=[],c=this._getDeviceStatesCBs[a]);var e=c.length;c.push(d);if(!(0<e)){var f=this;this._getDeviceStates(a,function(h,k){var m=f._getDeviceStatesCBs[a];f._getDeviceStatesCBs[a]=[];!h&&k&&(k=f._resolveStates(k),
f._putStatesBuffer(a,k));for(var l=0;l<m.length;l++)m[l]&&m[l](h,k,a)})}}};b.prototype._resolveStates=function(a){a&&a.measured&&(a.measuredStr=(new Date(a.measured)).toLocaleString());return a};b.prototype._getDeviceStates=function(a,d){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/states/"+this.id+"/"+a,null,null,function(c,e){d&&d(c,e)}):d&&d(Error("account not connected"))};b.prototype._doJsonRequest=function(a,d,c,e,f){this._doRequest(a,d,c,e,function(h,k){h?f&&f(h):k?k.XC_ERR?(h=Error("error response:"+
k.XC_ERR.msg),h.code=k.XC_ERR.code,f&&f(h)):k.XC_SUC?f&&f(null,k.XC_SUC):f&&f(Error("unknown response")):f&&f(Error("invalid response"))})};b.prototype._doRequest=function(a,d,c,e,f){d||(d="/");var h={};c&&(h=JSON.parse(JSON.stringify(c)));c="";for(var k in h)h.hasOwnProperty(k)&&(c&&(c+="&"),c+=k+"="+encodeURIComponent(h[k]));c&&(d+="?"+c);a={host:this._ip,port:this._port,path:d,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};this._logger.log("trace","do request:"+
JSON.stringify(a));if(this.username||this.password)a.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),a.headers.Authorization="Basic "+(new Buffer((this.username?this.username:"")+":"+(this.password?this.password:""))).toString("base64");e&&(a.headers["Content-Length"]=e.length);k=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var m=this,l=f,n=k.request(a,function(p){p.setEncoding("utf-8");
var q="";p.on("data",function(r){q+=r});p.on("end",function(){m._logger.log("trace","receive code:"+p.statusCode+" headers:"+JSON.stringify(p.headers)+" response:"+q);if(200==p.statusCode)try{var r=q?JSON.parse(q):null}catch(u){var t=u}else t=Error("http reponse:"+p.statusCode);l&&(l(t,r,p.statusCode),l=null)})});if(n.on)n.on("error",function(p){m._logger.log("trace","do request error:"+p.message);l&&(l(p),l=null)});n.setTimeout&&n.setTimeout(2E4,function(){m._logger.log("trace","do request timeout");
n.abort();l&&(l(Error("timeout")),l=null)});e&&(this._logger.log("trace","do request send body:"+e),n.write(e));n.end()};b.prototype.toJSON=function(){return{sys:"mirubee",username:this.username,password:this.password,id:this.id}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.id==a.id&&this.username==a.username&&this.password==a.password:!1};b.parseJSON=function(a){return a.username?new b(a.username,a.password,a.id):null};return b}();
xnm.aio.mirubee.DM=function(){var g=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="mirubeeDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mirubee",MAP:{meter:{channel:{status:[{type:"float",name:"power",ref:{value:"power",unit:"W"}},{type:"float",name:"voltage",ref:{value:"voltage",unit:"V"}},{type:"float",name:"current",ref:{value:"current",unit:"A"}},{type:"int",
name:"last measured time",ref:{value:"measured"}},{type:"string",name:"last measured time (text)",ref:{value:"measuredStr"}},{type:"statistic",name:"energy statistic",ref:{value:"energy"}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"mirubee (alfanar)"}]},createGateway:function(b,a,d){a=g.ERROR_CODE;b?b.username?b.password?b.id?d(null,b):d(new g(a.INVALID,"id is invalid")):d(new g(a.INVALID,"password is invalid")):d(new g(a.INVALID,"username is invalid")):d(new g(a.INVALID,"info is invalid"))},
updateGateway:function(b,a,d,c){b=g.ERROR_CODE;a?a.username?a.password?a.id?c(null,a):c(new g(b.INVALID,"id is invalid")):c(new g(b.INVALID,"password is invalid")):c(new g(b.INVALID,"username is invalid")):c(new g(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,d){d()},createDevice:function(b,a,d){var c=g.ERROR_CODE;if(b)if(b.id)if(b.gateway){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===b.gateway){var f=a[e];break}f?d&&d(null,b):d(new g(c.NOT_FOUND,"gateway with index "+
b.gateway+" not exists"))}else d(new g(c.INVALID,"gateway is invalid"));else d(new g(c.INVALID,"id is invalid"));else d(new g(c.INVALID,"info is invalid"))},updateDevice:function(b,a,d){var c=g.ERROR_CODE;if(b)if(b.id)if(b.gateway){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===b.gateway){var f=a[e];break}f?d(null,b):d(new g(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else d(new g(c.INVALID,"gateway is invalid"));else d(new g(c.INVALID,"id is invalid"));else d(new g(c.INVALID,
"info is invalid"))},deleteDevice:function(b,a,d){d()},applyUIFilter:function(b,a,d){var c=function(m,l){if("*"==m)return!0;for(var n=!1,p=0;p<m.length;p++)if(m[p]==l){n=!0;break}return n},e=function(m,l,n){var p=[];"command"==n.catagory?m.command&&m.command.forEach(function(q){c(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))}):"status"==n.catagory&&m.status&&m.status.forEach(function(q){c(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});return p},f=function(m,l){var n=
[],p=xnm.aio.mirubee.DM.getCommandStatusMap(m,d);p&&(m=e(p,m,l),n=n.concat(m));return n};if(!b.sys)return null;var h=JSON.parse(JSON.stringify(b)),k=null;if("command"==a.catagory)k=f(b,a),h.command=k;else if("status"==a.catagory)k=f(b,a),h.status=k;else return null;return k&&0!=k.length?h:null},getCommandStatusMap:function(b,a){if(!b||!b.id||3>b.id.split(":").length)return null;b={status:[]};b.status=this.MAP.meter.channel.status;return b}}}();
xnm.aio.mirubee.Handler=function(){var g=function(){};g.prototype.devicemanager=xnm.aio.mirubee.DM;g.prototype.Mirubee=xnm.aio.mirubee.Mirubee;g.prototype.registModule=function(b){b.register("mirubee","mirubee")};g.prototype.resolveGateway=function(b){return b?this.Mirubee.parseJSON(b):null};g.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};g.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};g.prototype.doCommand=function(b,a,d,c){(b=this.resolveGateway(b))?b.executeCommandCreator(a,d,function(e){c&&c(e)}):c&&c(Error("gateway json format invalid"))};g.prototype.doStatus=function(b,a,d,c,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:d,status:c}],function(f,h){f?e&&e(f):e&&e(null,h[0])}):e&&e(Error("gateway json format invalid"))};g.prototype.getDeviceList=function(b,a){(b=this.resolveGateway(b))?b.getDevices(function(d,
c){a&&a(d,c)}):a&&a(Error("gateway json format invalid"))};g.prototype.connect=function(b,a,d,c){(b=this.resolveGateway(b))?b.connect(a,d,function(e,f){c&&c(e,f)}):c&&c(Error("gateway json format invalid"))};g.prototype.disconnect=function(b,a){(b=this.resolveGateway(b))?b.disconenct(function(d,c){a&&a(d,c)}):a&&a(Error("gateway json format invalid"))};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mirubee.Handler);
