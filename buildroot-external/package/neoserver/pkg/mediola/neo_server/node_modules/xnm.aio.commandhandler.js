var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,l,f){if(e==Array.prototype||e==Object.prototype)return e;e[l]=f.value;return e};
$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var l=0;l<e.length;++l){var f=e[l];if(f&&f.Math==Math)return f}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,l){var f=$jscomp.propertyToPolyfillSymbol[l];if(null==f)return e[l];f=e[f];return void 0!==f?f:e[l]};$jscomp.polyfill=function(e,l,f,q){l&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,l,f,q):$jscomp.polyfillUnisolated(e,l,f,q))};
$jscomp.polyfillUnisolated=function(e,l,f,q){f=$jscomp.global;e=e.split(".");for(q=0;q<e.length-1;q++){var r=e[q];if(!(r in f))return;f=f[r]}e=e[e.length-1];q=f[e];l=l(q);l!=q&&null!=l&&$jscomp.defineProperty(f,e,{configurable:!0,writable:!0,value:l})};
$jscomp.polyfillIsolated=function(e,l,f,q){var r=e.split(".");e=1===r.length;q=r[0];q=!e&&q in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var a=0;a<r.length-1;a++){var b=r[a];if(!(b in q))return;q=q[b]}r=r[r.length-1];f=$jscomp.IS_SYMBOL_NATIVE&&"es6"===f?q[r]:null;l=l(f);null!=l&&(e?$jscomp.defineProperty($jscomp.polyfills,r,{configurable:!0,writable:!0,value:l}):l!==f&&(void 0===$jscomp.propertyToPolyfillSymbol[r]&&(f=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[r]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(r):$jscomp.POLYFILL_PREFIX+f+"$"+r),$jscomp.defineProperty(q,$jscomp.propertyToPolyfillSymbol[r],{configurable:!0,writable:!0,value:l})))};$jscomp.polyfill("Object.is",function(e){return e?e:function(l,f){return l===f?0!==l||1/l===1/f:l!==l&&f!==f}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(e){return e?e:function(l,f){var q=this;q instanceof String&&(q=String(q));var r=q.length;f=f||0;for(0>f&&(f=Math.max(f+r,0));f<r;f++){var a=q[f];if(a===l||Object.is(a,l))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(e,l,f){if(null==e)throw new TypeError("The 'this' value for String.prototype."+f+" must not be null or undefined");if(l instanceof RegExp)throw new TypeError("First argument to String.prototype."+f+" must not be a regular expression");return e+""};$jscomp.polyfill("String.prototype.includes",function(e){return e?e:function(l,f){return-1!==$jscomp.checkStringArgs(this,l,"includes").indexOf(l,f||0)}},"es6","es3");
$jscomp.owns=function(e,l){return Object.prototype.hasOwnProperty.call(e,l)};$jscomp.assign=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.assign?Object.assign:function(e,l){for(var f=1;f<arguments.length;f++){var q=arguments[f];if(q)for(var r in q)$jscomp.owns(q,r)&&(e[r]=q[r])}return e};$jscomp.polyfill("Object.assign",function(e){return e||$jscomp.assign},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.commandhandler=xnm.aio.commandhandler||{};
xnm.aio.commandhandler.CommandHandler=function(e,l,f,q,r){this.SystemData=e;this.RulesManager=l;this.RemoteHandler=q;this.CloudHandler=r;this.gwModule=require("xnm.aio.gateway.js");this.CFG=f;this._gealanFans=null;this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"];this._persistentAioData={};this._states={};this.RemoteController=null;this._updateReceivers=[];this.getStatesCallback=null;this.setGealanFanFactory=function(a){this._gealanFans=a};this.getCurrentState=function(a){return void 0!==
this._states[a]?this._states[a]:"?"};this.setState=function(a,b){if(this._states[a]!=b){this._states[a]=b;for(var k=0;k<this._updateReceivers.length;k++){var g=this._updateReceivers[k];g.filter(a)&&g.callback(a.substr(a.indexOf(":")+1),b)}}};this.deleteDeviceStates=function(a){for(var b in this._states)this._states.hasOwnProperty(b)&&parseInt(b.split(":")[0])===a&&delete this._states[b]};this.subscribe=function(a,b,k){var g={filter:a,callback:b,refresh:k};this._updateReceivers.push(g);return{unsubscribe:function(m){return function(){var c=
m.indexOf(g);-1!==c&&m.splice(c,1)}}(this._updateReceivers)}};this.subscribeForDevice=function(a,b,k){var g=a.index;return this.subscribe(function(m){return+m.split(":")[0]===g},b,k)};this.clearSubscribers=function(){this._updateReceivers=[]};this.subscribeForStateOnDevices=function(a,b,k){return this.subscribe(function(g){var m=g.split(":")[0];return b.some(function(c){return c.index===+m})},function(g,m){a.some(function(c){return g===c})&&k(m)})};this.refreshSubscribers=function(){this._updateReceivers.forEach(function(a){void 0!==
a.refresh&&a&&a.refresh()}.bind(this))};this.receivedState=function(a,b,k,g){XC.debugf(a);XC.debugf(b);XC.debugf(k);var m=this;"hue"===a?this.SystemData.getGateways(function(c){return c.info.sys===a}).forEach(function(c){this.SystemData.getDevices(function(p){return p.info.gateway===c.index}).forEach(function(p){var h={},d="",n=p.info.data;p.info.subtype&&(n=p.info.subtype);p.info.address==b&&(d=p.room+"."+p.index,"hue"===a&&(h=require("xnm.aio.hue.js").getStateValues({type:n},k),h.rgb=k.rgb,h.effect=
k.effect));for(var t in h)"state"==t?this.setState(d,h[t]):this.setState(d+":"+t,h[t])}.bind(this))}.bind(this)):("sonos"==a||"wemo"==a||"orvibo"==a||"edimax"==a||"kt"==a||"siegenia"==a||"lightify"==a)&&m.SystemData.getDevices(function(c){return c.info.address===b}).forEach(function(c){XC.debugf(c);XC.debugf(k);var p=c.room+"."+c.index,h=c.data;c.subtype&&(h=c.subtype);"lightify"===a&&(a="osram");c=require("xnm.aio."+a+".js").getStateValues({type:h},k);"osram"===a&&(c.rgb=""+XC.getHexVal(k.red,2)+
XC.getHexVal(k.green,2)+XC.getHexVal(k.blue,2),c.ct=k.colorTemp);for(var d in c)"state"==d?m.setState(p,c[d]):m.setState(p+":"+d,c[d])})};this.execute=function(a,b,k,g){var m=this.SystemData.getDevices(function(c){return c.index==a})[0];m&&this.executeCommand(b,m.info,k,g)};this.executeCommand=function(a,b,k,g){var m=this,c=this,p=b.gateway,h=b.sys,d=this.SystemData.getGateways(function(v){return v.index===p},!0)[0];if(d&&("aio"===h||"hm"===h)){var n=this.gwModule.resolveGateway(d.info);n.CommandHandler=
this;this._restoreAioData(n);d.info.server&&n.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/");d.info.password&&(n._at=this.hash(d.info.password));var t=this.RemoteHandler.isRemote();n.setCloudAccess(t);t&&(k=!0);n.executeCommandCreator(null,{value:t?"raOn":"raOff"});n.executeCommandCreator(b,a,function(v){m._saveAioData(n);XC.debugf("Executed Gateway Command: "+b.sys+" "+a+(t?" (remote)":" (local)"));k&&setTimeout(function(){return n.getStates(c)},1E3);g&&g(v)})}else if(!this.RemoteHandler.isRemote())if(d&&
"fritzbox"===h){var x=new (require("xnm.aio.fritz.js").Box)(d.info.ip,d.info.password);x.executeCommand(b,a,function(){XC.debugf("executed fritz command");g&&g.call();b.id=b.location+"."+b.id;k&&x.getStates(c,[b])})}else if(d&&"alpha2"===h){var y=new (require("xnm.aio.moehlenhoff.js").Alpha2)(d.info.ip);y.executeCommandCreator(b,a,function(){XC.debugf("executed moehlenhoff command");g&&g.call();b.id=b.location+"."+b.id;k&&y.getStates(c,[b])})}else if(d)XC.debugf("executeCommand for unknown gatewaytype");
else if("edimax kt orvibo siegenia sonos wemo".split(" ").includes(h)){d={address:b.address,data:b.data};if("wemo"===h){d.port=49154;var u=b.address.split(":");2==u.length&&(d.address=u[0],d.port=u[1])}else"sonos"===h?(d.port=1400,d.address=b.ip):"siegenia"===h&&(d.pwd=b.pwd);u=require("xnm.aio."+h+".js");var w=u.getDevice(d);w?w.executeCommandCreator(d,a,function(v,z){XC.debugf("executed "+h+" command");"siegenia"===h?g&&g.call(null,v,z):g&&g.call();k&&w.getStates(c)}):g&&g.call()}else"gealan"===
h?(u=require("xnm.aio.gealan.js"),(new u.Fan(b.ip,b.port,b.username,b.password)).executeCommandCreator(b,a,function(v,z){XC.debugf("executed "+h+" command");g&&g.call()})):"aiogateway"===h&&(n=new this.gwModule.Gateway(b.address),n.executeGatewayCommand(a,function(){g&&g.call()}))};this._restoreAioData=function(a){if(this._persistentAioData[a._mac])for(var b in this._persistentAioData[a._mac])a[b]=this._persistentAioData[a._mac][b];else this._persistentAioData[a._mac]={}};this._saveAioData=function(a){var b=
this;this._persistentAioKeys.forEach(function(k){k in a&&(b._persistentAioData[a._mac][k]=a[k])})};this.hash=function(a){a=String(a);return require("x.crypt.js").MD5(unescape(encodeURI(a+"_SALT!")))};this.getStatesForDevice=function(a,b){var k=this;a.info&&"cloudservice"===a.info.sys&&(new this.CloudHandler).getModuleStates(a.info.module,function(h,d){k.deleteDeviceStates(a.index);if(d&&(h=d[a.info.connection])&&(h=h[a.info.id])&&h.states)for(var n in h.states)k.setState(a.index+":"+n,h.states[n])});
if(a.info&&a.info.mod){this.deleteDeviceStates(a.index);var g=this.gwModule.devicemanager.getSystem(a.info);if(g){var m=this.SystemData.getGateways(function(h){return h.index===a.info.gateway})[0];if(m){var c=m.info.mac;this._aioCache?(this._aioCache[c]||(this._aioCache[c]=this.gwModule.resolveGateway(m.info)),c=this._aioCache[c]):c=this.gwModule.resolveGateway(m.info);this.RemoteHandler.isRemote()&&(c.setRemoteAccessMode(m.info.sid),c.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),
c._at=this.hash(m.info.password));c.executeCommandCreator(null,{value:this.RemoteHandler.isRemote()?"raOn":"raOff"});g.getStatesCreator(c,a.info,function(h,d){if(!h&&d){for(var n in d)k.setState(a.index+":"+n,d[n]);b&&b(d)}})}}}else if(!this.RemoteHandler.isRemote()&&(g=a.sys,-1!==["gealan"].indexOf(g)&&"gealan"==g)){g=this._gealanFans.getFan({ip:a.ip,port:a.port,mac:a.mac});var p=[];require("xnm.aio.gealan.js").getDeviceStatus(a,function(h,d){for(h=0;h<d.length;h++){var n=d[h];n.ref&&n.ref.value&&
p.push({id:n.ref.value,device:a,status:{value:n.ref.value}})}});g.getStatesCreator(null,p,function(h,d){if(!h&&d){for(var n=0;n<d.length;n++){var t=d[n];k.setState(a.id+":"+t.id,t.status)}b&&b(h,d)}})}};this.getStatesForDevices=function(a,b){var k={},g=[];this._orderByGateway(a,k,g);this.getStatesPerGateway(k,g,b)};this.getStatesForLocations=function(a,b){var k=this,g={},m=[];a.forEach(function(c){var p=k.SystemData.getDevices(function(h){return h.room===c.index});k._orderByGateway(p,g,m,b)});this.getStatesPerGateway(g,
m)};this._orderByGateway=function(a,b,k,g){a.forEach(function(m){if("cloudservice"===m.info.sys){if(!g)return;var c=m}else m.info.mod?c=m:(c=Object.assign({},m.info),c.id=m.index,c.subtype=m.info.subtype?m.info.subtype:m.info.data);var p=m.info.gateway;p&&!m.info.mod?(b[p]||(b[p]=[]),b[p].push(c)):k.push(c)})};this.getStatesPerGateway=function(a,b,k){var g=this,m;for(m in a){var c=this.SystemData.getGateways(function(d){return d.index==m},!0)[0];if(!c)return;var p=c.info.sys,h=a[m];"aio"===p?(p=this.gwModule.resolveGateway(c.info),
this.RemoteHandler.isRemote()&&(p.setRemoteAccessMode(c.info.sid),p.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),p._at=this.hash(c.info.password),p.setCloudAccess(!0),p.executeCommandCreator(null,{value:"raOn"})),p.getStates(this,h,function(d,n){null==d&&k&&k(Error("Error getting states "+n))})):"hm"===p?(XC.debugf("GET HM STATES"),(new (require("xnm.aio.hm.js").CCU)(c.info.ip)).getStates(this,h,function(d,n){if(!d&&n)for(d=0;d<n.length;d++)this.setState(n[d].id,n[d].status)}.bind(this))):
"fritzbox"===p?(new (require("xnm.aio.fritz.js").Box)(c.info.ip,c.info.password)).getStates(this,h):"alpha2"===p&&(new (require("xnm.aio.moehlenhoff.js").Alpha2)(c.info.ip)).getStates(this,h)}setTimeout(function(){g._aioCache=[];for(var d=0;d<b.length;d++)g.getStatesForDevice(b[d]);g._aioCache=[]},1E3)}};xnm.aio.commandhandler.Handler=function(){};xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler);
