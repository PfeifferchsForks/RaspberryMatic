var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];if(!(g in d))return;d=d[g]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(c=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+c+"$"+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};
$jscomp.initSymbol=function(){};$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(f,g){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",d=0,e=function(f){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new b(c+(f||"")+"_"+d++,f)};return e},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=$jscomp.global[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&$jscomp.defineProperty(d.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloudTaskmanager=xnm.aio.cloudTaskmanager||{};xnm.aio.cloudTaskmanager.CloudTaskmanager=function(){};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudService=function(a){this._cloudService=a;return this};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudAccessUrl=function(a){this._cloudAccessUrl=a;return this};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxCloudData=function(a,b){a.cloudTaskIds=[];a.root.if=a.root.if.filter(function(c){return!c.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(c){return!c.cloud});this._cloudService.getRules(function(c,d){XC.debugf(d);if(c)return b(c,d);var e=[],f=[];xnm.aio.cloudTaskmanager.extractRules(d).forEach(function(g){xnm.aio.cloudTaskmanager.belongsToVxTask(g,a)&&(a.cloudTaskIds.push(g.ruleId),e=e.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(g)),
f=f.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(g)))});a.root.if=a.root.if.concat(e);a.root.then[0].then=a.root.then[0].then.concat(f);return b(c,a)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxProCloudData=function(a,b){a.cloudTaskIds=[];a.root.if=a.root.if.filter(function(c){return!c.cloud&&(!c.gateway||"cloudservice"!==c.gateway.sys)});a.root.then[0].then=a.root.then[0].then.filter(function(c){return!c.cloud});this._cloudService.getRules(function(c,d){XC.debugf(d);if(c)return b(c,d);var e=[],f=[];xnm.aio.cloudTaskmanager.extractRules(d).forEach(function(g){var h=!1;g.action&&(h=g.action.some(function(l){return l.data&&l.data.data&&
l.data.data.id==a.id&&l.data.token===a.aio._token}));h&&(a.cloudTaskIds.push(g.ruleId),e=e.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(g)),f=f.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(g)))});a.root.if=a.root.if.concat(e);a.root.then[0].then=a.root.then[0].then.concat(f);return b(c,a)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxCloudData=function(a,b,c,d){var e=this;b=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(b);c=xnm.aio.cloudTaskmanager.mapProActionsToCloud(c);(b[void 0]||c[void 0])&&a.cloudTaskIds.push(void 0);this._runSaving(a,function(f){f=e._getRule(a,b[f],c[f]);var g=f.action.some(function(k){return"mediola"!==k.sys}),h=f.trigger.some(function(k){return k.event&&"mediola"===k.event.sys}),l=f.trigger.some(function(k){return!k.event||"mediola"!==k.event.sys}),
m=f.action.some(function(k){return"mediola"===k.sys});g&&!h&&f.trigger.push(e._getAioTrigger(a));l&&!m&&f.action.push(e._getAioAction(a,"doGroup"));return f},d)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxProCloudData=function(a,b,c){var d=this;b=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(b);b[void 0]&&a.cloudTaskIds.push(void 0);this._runSaving(a,function(e){e=d._getRule(a,b[e]);var f=e.trigger.some(function(h){return!h.event||"mediola"!==h.event.sys}),g=e.action.some(function(h){return"mediola"===h.sys});f&&!g&&e.action.push(d._getAioAction(a,"DoTask"));return e},c)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runSaving=function(a,b,c){var d=this;a=a.cloudTaskIds.map(function(e){var f=b(e);return d._getUpdateCall(e,f)});(new xnm.aio.cloudTaskmanager.FunctionStack(a)).start(c)};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getUpdateCall=function(a,b){var c=this;return function(d){return a?b.trigger.length||b.action.length?c._cloudService.updateRule(a,b,d):c._cloudService.deleteRule(a,d):c._cloudService.addRule(b,d)}};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getRule=function(a,b,c){return{name:"cloud "+a.id,app:"iqontrolneo",owner:a.aio._sid,trigger:b||[],action:c||[]}};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioTrigger=function(a){return{event:{sys:"mediola",data:{data:a._localCloudId,type:"ACTION",sid:a.aio._sid}}}};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioAction=function(a,b){return{sys:"mediola",data:{ccs:this._cloudAccessUrl+":443",cmd:"cmd",data:{id:a.id.toString(),XC_FNC:b},token:a.aio._token}}};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxCloudData=function(a,b){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToVxTask,b)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxProCloudData=function(a,b){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToProTask,b)};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runDeletion=function(a,b,c){var d=this;this._cloudService.getRules(function(e,f){if(e)return c(e,f);e=xnm.aio.cloudTaskmanager.extractRules(f).filter(function(g){return b(g,a)}).map(function(g){return function(h){return d._cloudService.deleteRule(g.ruleId,h)}});(new xnm.aio.cloudTaskmanager.FunctionStack(e)).start(c)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.clearCloudData=function(a){this._cloudService.deleteRules({},a)};
xnm.aio.cloudTaskmanager.belongsToVxTask=function(a,b){var c=a.action&&a.action.find(function(d){return"mediola"===d.sys&&d.data&&d.data.data});if(c&&c.data.data.id==b.id&&c.data.token===b.aio._token)return!0;c=b.root.then[0].then.find(function(d){return"CLOUD"===d.type});return c?(a=a.trigger&&a.trigger.find(function(d){return d.event&&"mediola"===d.event.sys&&d.event.data}))&&a.event.data.data==c.id&&a.event.data.sid===b.aio._sid:!1};
xnm.aio.cloudTaskmanager.belongsToProTask=function(a,b){return(a=a.action&&a.action.find(function(c){return"mediola"===c.sys&&c.data&&c.data.data}))&&a.data.data.id==b.id&&a.data.token===b.aio._token};
xnm.aio.cloudTaskmanager.mapCloudTriggersToPro=function(a){return a.trigger.map(function(b){if(b.event&&"mediola"===b.event.sys)return b.internal=!0,null;b=b.event;return{cloud:!0,sys:b.sys,ruleId:a.ruleId,op:b.comp.operator,value:b.comp.value,type:"device.status",status:b.data.state,device:{id:b.data.id,connection:b.data.connection}}}).filter(function(b){return null!==b})};
xnm.aio.cloudTaskmanager.mapCloudActionsToPro=function(a){return a.action.map(function(b){return"mediola"===b.sys?(b.internal=!0,null):{cloud:!0,sys:b.sys,ruleId:a.ruleId,type:"action",subtype:"command",command:{ref:{value:b.data.command,ext:b.data.value}},device:{id:b.data.device,connection:b.data.connection}}}).filter(function(b){return null!==b})};
xnm.aio.cloudTaskmanager.mapProTriggersToCloud=function(a){return a.map(function(b){return{ruleId:b.ruleId||void 0,event:{sys:b.device.module,data:{id:b.device.id,state:b.status,connection:b.device.connection},comp:{operator:b.op,value:b.value}}}}).reduce(this.aggregateByRule,{})};
xnm.aio.cloudTaskmanager.mapProActionsToCloud=function(a){return a.map(function(b){return{ruleId:b.ruleId||void 0,sys:b.sys,data:{device:b.device.id,command:b.command.ref.value,value:b.command.ref.ext}}}).reduce(this.aggregateByRule,{})};xnm.aio.cloudTaskmanager.aggregateByRule=function(a,b){a[b.ruleId]||(a[b.ruleId]=[]);a[b.ruleId].push(b);delete b.ruleId;return a};xnm.aio.cloudTaskmanager.extractRules=function(a){return Object.keys(a).map(function(b){var c=a[b];c.ruleId=b;return c})};
xnm.aio.cloudTaskmanager.FunctionStack=function(a){this._stack=a;this._onNext=function(b,c){if(b)this._callback(b);else{var d=this._stack.shift();d?d(this._onNext.bind(this)):this._callback(b,c)}};this.start=function(b){this._callback=b;this._onNext()}};xnm.aio.cloudTaskmanager.Handler=xnm.aio.cloudTaskmanager.CloudTaskmanager;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudTaskmanager.Handler);
